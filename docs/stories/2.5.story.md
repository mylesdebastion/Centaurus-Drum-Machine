# Story: Sound Options for Isometric Sequencer

## Story ID: EPIC-2-SOUND-001
**Status:** Draft
**Epic:** Epic 2 - 3D Boomwhacker Music Learning Application
**Priority:** Medium
**Related:** EPIC-2-VIS-001, EPIC-2-VIS-002

## Story
As a user of the 3D Isometric Sequencer, I want multiple sound options available next to the Melody button (similar button style, possibly a dropdown), so that I can experiment with different instrument timbres including classic 808 drum machine sounds and other Tone.js synthesizers, making the sequencer more versatile and musically expressive.

## Acceptance Criteria
- [ ] Sound selector control positioned next to the Melody button with matching visual style
- [ ] Dropdown or button group UI pattern for selecting sound options
- [ ] At least 4-5 distinct sound options available:
  - [ ] Current sine wave synth (default)
  - [ ] Classic 808-style drum machine sounds
  - [ ] Pluck/mallet sound (percussive attack)
  - [ ] Pad/ambient sound (softer, sustained)
  - [ ] FM synth (bright, metallic)
- [ ] Sound option persists during playback and note editing
- [ ] Smooth transition when switching sounds (no audio glitches)
- [ ] Visual feedback showing currently selected sound
- [ ] Sounds work with all scale/root note configurations
- [ ] Performance maintained with new synthesis options

## Dev Notes
**Current Implementation:**
- Uses basic Web Audio API oscillators (sine wave)
- `playNote()` function at IsometricSequencer.tsx:363-380
- Simple envelope: attack 0, decay 0.3s with exponential ramp
- Volume: 0.5 initial gain, ramps to 0.01

**Tone.js Available:**
- Project already uses Tone.js extensively (see audioEngine.ts)
- MembraneSynth for 808-style kick/tom sounds
- MetalSynth for 808-style hi-hats/cymbals
- PolySynth, Synth, FMSynth, PluckSynth available
- NoiseSynth for textured sounds

**808 Drum Machine Influence:**
- Roland TR-808 iconic electronic drum sounds
- Characterized by punchy, synthetic timbres
- Use Tone.MembraneSynth for bass-heavy 808 kick characteristics
- Adjust pitchDecay, octaves for classic 808 feel

## Tasks
- [ ] Implement sound engine abstraction
  - [ ] Create `SoundEngineType` enum/type
  - [ ] Implement factory function for sound generators
  - [ ] Support both Web Audio API and Tone.js synthesis
  - [ ] Handle cleanup/disposal of synth instances
- [ ] Define sound presets
  - [ ] **Sine Wave** (current default): Clean, pure tone
  - [ ] **808 Drums**: MembraneSynth with TR-808 characteristics
    - pitchDecay: 0.05, octaves: 10 (bass-heavy kick sound)
    - Note mapping: lower notes = deeper kick, higher = tom-like
  - [ ] **Pluck**: PluckSynth or PolySynth with fast attack/decay
    - attackNoise: 1, dampening: 4000, resonance: 0.7
    - Short, percussive mallet/marimba character
  - [ ] **Pad**: Synth with slow attack, longer release
    - oscillator: triangle or sine, envelope: attack 0.1s, release 1s
    - Soft, atmospheric, choral quality
  - [ ] **FM Bell**: FMSynth for bright, metallic timbre
    - modulationIndex: 10-20, harmonicity: 3.5
    - Bell-like, crystalline tone
- [ ] Create UI component for sound selection
  - [ ] Match existing button style (gradient background, rounded-lg, hover effects)
  - [ ] Use Lucide React icon: `Volume2` or `Music2` for sound selector
  - [ ] Implement dropdown menu using existing component patterns
  - [ ] Position next to Melody button in controls section
  - [ ] Add visual indicator for active sound (icon color or badge)
- [ ] Integrate sound selection with playback
  - [ ] Add state management for selected sound option
  - [ ] Update `playNote()` to use selected sound engine
  - [ ] Ensure sound changes don't interrupt playback
  - [ ] Implement proper disposal when changing sounds
  - [ ] Test with all scale modes and Circle of Fifths
- [ ] Audio optimizations
  - [ ] Implement synth instance pooling to prevent recreation overhead
  - [ ] Add audio context initialization check
  - [ ] Ensure no memory leaks when switching sounds
  - [ ] Maintain consistent volume levels across sound types
  - [ ] Test performance with complex patterns

## Technical Implementation Details

### Sound Engine Interface
```typescript
interface SoundEngine {
  playNote(frequency: number, velocity: number, duration: number): void;
  dispose(): void;
}
```

### Example Sound Preset (808 Style)
```typescript
const create808Synth = () => {
  return new Tone.MembraneSynth({
    pitchDecay: 0.05,
    octaves: 10,
    oscillator: { type: 'sine' },
    envelope: {
      attack: 0.001,
      decay: 0.4,
      sustain: 0.01,
      release: 1.4
    }
  }).toDestination();
};
```

### UI Component Pattern
```tsx
<button
  onClick={toggleSoundMenu}
  className="flex items-center gap-2 px-4 py-3 bg-gradient-to-r from-cyan-600 to-cyan-500 hover:from-cyan-700 hover:to-cyan-600 rounded-lg transition-all transform hover:scale-105 font-semibold"
>
  <Volume2 className="w-5 h-5" />
  Sound: {soundName}
</button>
```

## Testing
- Audio output quality testing for each sound preset
- Performance benchmarks with different sound engines
- Volume normalization verification across presets
- Memory leak testing when switching sounds
- Cross-browser audio compatibility testing
- Mobile device audio testing (iOS/Android)
- Accessibility: keyboard navigation for sound selector
- User experience: transition smoothness when changing sounds

## File List
- `src/components/IsometricSequencer/IsometricSequencer.tsx` (primary changes)
  - State management for sound selection
  - UI controls for sound selector
  - Integration with playNote() function
- `src/utils/soundEngines.ts` (new file - recommended)
  - Sound engine factory functions
  - Tone.js preset configurations
  - Sound engine abstraction interface

## Dependencies
- Tone.js (already installed and used in project)
- Lucide React icons (already installed for UI icons)

## Change Log
- Initial story creation for sound options feature
- Focus on Tone.js integration and 808 drum machine sounds
- UI design to match existing Melody button style

## Dev Agent Record
**Agent Model Used:** Claude Sonnet 4.5
**Debug Log References:** N/A
**Completion Notes:**
- Story created based on analysis of existing IsometricSequencer implementation
- Leverages Tone.js library already in use by audioEngine.ts
- 808 drum machine influence provides classic electronic sound aesthetic
- Sound options enhance musical expressiveness and educational value
- Maintains consistency with existing UI patterns and performance standards
