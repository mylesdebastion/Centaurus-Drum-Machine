# Story 18.11: Settings Migration UI & Notifications

**Epic:** Epic 18 - Intelligent WLED Visualization Routing
**Status:** üìù PLANNING
**Priority:** üü¢ LOW
**Complexity:** Low
**Time Estimate:** 2-3 hours
**Prerequisites:** Story 18.0 (User Authentication), Story 7.10 (User Settings Persistence)

---

## User Story

As a **user upgrading from anonymous to authenticated**,
I want **clear feedback when my settings are migrated to the cloud**,
So that **I understand my workspace is now synced across devices**.

---

## Story Context

### Why This Story

**User Journey (Before Migration UI):**
1. User uses app anonymously for weeks
2. Configures 10+ WLED devices, custom tempo, preferred key
3. Creates account (signs up)
4. **No feedback** about what happened to settings
5. User confused: "Did my settings transfer? Are they gone?"

**User Journey (After Migration UI):**
1. User uses app anonymously
2. Creates account
3. **Sees notification:** "Your settings are now synced across devices"
4. **Sees checkmark icon:** "6 WLED devices migrated ‚úì"
5. User confident settings are safe and synced

### Current State

- ‚úÖ Settings migration logic exists (Story 7.10 - `migrateSettings()`)
- ‚úÖ Settings auto-load on startup (Story 7.10)
- ‚ùå No UI feedback when migration happens
- ‚ùå No manual "Sync Settings" button
- ‚ùå No "Reset to Defaults" option

### Desired State

- ‚úÖ Migration notification shown after sign up
- ‚úÖ Migration summary (e.g., "6 devices, 3 audio settings synced")
- ‚úÖ Manual "Sync Now" button in Settings panel
- ‚úÖ "Reset to Defaults" button in Settings panel
- ‚úÖ Sync status indicator (syncing/synced/offline)

---

## Acceptance Criteria

### Functional Requirements

1. **Migration Notification (Post-Signup)**
   - When user creates account:
     1. Check if localStorage has settings
     2. If yes ‚Üí show migration modal
     3. Run migration: `useSettings().migrateSettings()`
     4. Show success notification
   - **Notification UI:**
     ```tsx
     <MigrationSuccessModal>
       <Icon: CheckCircle (green) />
       <Title: "Your settings are now synced" />
       <Body:
         "Your workspace has been saved to the cloud and will
          follow you across all devices."
       />
       <Summary:
         - ‚úì 6 WLED devices
         - ‚úì Audio preferences (tempo, key)
         - ‚úì Jam session username
       />
       <Button: "Got it" />
     </MigrationSuccessModal>
     ```
   - Duration: User dismisses (not auto-hide)

2. **Settings Panel UI**
   - Create new Settings panel (accessible from header)
   - Sections:
     - **Sync Status:**
       - Icon indicator: Syncing (spinner) | Synced (checkmark) | Offline (cloud-off)
       - Text: "Last synced 5 minutes ago"
       - Button: "Sync Now" (manual refresh)
     - **WLED Devices:**
       - List of saved WLED devices
       - Count: "6 devices synced"
     - **Audio Preferences:**
       - Tempo, key, scale
       - "Synced across devices"
     - **Actions:**
       - Button: "Reset to Defaults" (danger button)
       - Confirmation modal before reset

3. **Sync Status Indicator** (in Header)
   - Small icon in app header (top-right, near Settings button)
   - States:
     - **Syncing:** Spinner icon (animated)
     - **Synced:** CheckCircle icon (green)
     - **Offline:** CloudOff icon (gray)
   - Tooltip: "Settings synced" / "Syncing..." / "Offline mode"
   - Click ‚Üí open Settings panel

4. **Manual Sync Button**
   - In Settings panel: "Sync Now" button
   - On click:
     1. Show loading spinner
     2. Call `LicenseService.checkLicense()` (Story 10.7)
     3. Call `useSettings().refreshSettings()`
     4. Show toast notification: "Settings synced"
   - Disabled if already syncing

5. **Reset to Defaults Functionality**
   - In Settings panel: "Reset to Defaults" button (danger style)
   - On click ‚Üí show confirmation modal:
     ```tsx
     <ConfirmResetModal>
       <Icon: AlertTriangle (red) />
       <Title: "Reset all settings to defaults?" />
       <Body:
         "This will delete all your saved settings including:
          - WLED devices
          - Audio preferences
          - Hardware controller mappings

          This action cannot be undone."
       />
       <Buttons:
         <Cancel: "Cancel" />
         <Confirm: "Reset to Defaults" (danger) />
       />
     </ConfirmResetModal>
     ```
   - On confirm:
     1. Call `GlobalMusicContext.resetSettings()`
     2. Show notification: "Settings reset to defaults"
     3. Reload app

6. **Migration Summary Details**
   - Count migrated items:
     ```typescript
     function getMigrationSummary(localSettings: AllUserSettings): string[] {
       const summary: string[] = [];

       if (localSettings.wled?.devices) {
         summary.push(`${localSettings.wled.devices.length} WLED devices`);
       }

       if (localSettings.audio) {
         summary.push('Audio preferences');
       }

       if (localSettings.jam?.defaultUsername) {
         summary.push('Jam session username');
       }

       return summary;
     }
     ```
   - Display in migration modal

### Integration Requirements

7. **AuthModal Integration**
   - After successful sign up:
     1. Check localStorage for settings
     2. If settings exist ‚Üí trigger migration
     3. Show `MigrationSuccessModal`
     4. Clear localStorage after successful migration

8. **GlobalMusicContext Integration**
   - Add methods:
     ```typescript
     interface GlobalMusicContextValue {
       // ... existing
       settingsSyncStatus: 'syncing' | 'synced' | 'offline';
       lastSyncedAt: string | null;
       refreshSettings: () => Promise<void>;
       resetSettings: () => Promise<void>;
     }
     ```

9. **Settings Panel Route**
   - Add route: `/settings`
   - Accessible from:
     - Header Settings button
     - Sync status indicator (click)
   - Mobile-responsive (full-screen on mobile, panel on desktop)

### Quality Requirements

10. **UX Design**
    - Follow existing modal patterns (UsernameModal, AuthModal)
    - Use existing button classes (.btn-primary, .btn-danger)
    - Lucide React icons (CheckCircle, AlertTriangle, CloudOff, Loader2)
    - Consistent spacing and colors (Tailwind)

11. **Performance**
    - Migration happens in background (non-blocking)
    - Manual sync completes <2 seconds
    - Reset to defaults instant (page reload)

12. **Error Handling**
    - Migration fails ‚Üí show error, preserve localStorage
    - Sync fails ‚Üí fallback to cached settings
    - Reset fails ‚Üí show error, don't reload

---

## Technical Approach

### Phase 1: Migration Modal (1 hour)

**Create Component:**
```typescript
// src/components/Settings/MigrationSuccessModal.tsx

import { CheckCircle } from 'lucide-react';

interface MigrationSummary {
  wledDevices: number;
  audioPreferences: boolean;
  jamUsername: boolean;
}

export const MigrationSuccessModal: React.FC<{
  isOpen: boolean;
  onClose: () => void;
  summary: MigrationSummary;
}> = ({ isOpen, onClose, summary }) => {
  if (!isOpen) return null;

  return (
    <>
      {/* Backdrop */}
      <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-40" />

      {/* Modal */}
      <div className="fixed inset-0 flex items-center justify-center z-50 p-4">
        <div className="bg-gray-800 rounded-lg border border-gray-700 shadow-2xl max-w-md w-full p-6">

          {/* Icon + Header */}
          <div className="flex items-center gap-3 mb-4">
            <div className="w-10 h-10 rounded-full bg-green-600/20 flex items-center justify-center">
              <CheckCircle className="w-5 h-5 text-green-400" />
            </div>
            <div>
              <h2 className="text-xl font-semibold text-white">
                Your settings are now synced
              </h2>
              <p className="text-sm text-gray-400">
                Your workspace follows you everywhere
              </p>
            </div>
          </div>

          {/* Summary */}
          <div className="bg-gray-900 rounded-lg p-4 mb-4">
            <p className="text-sm font-medium text-gray-300 mb-2">
              Migrated to cloud:
            </p>
            <ul className="space-y-1">
              {summary.wledDevices > 0 && (
                <li className="text-sm text-gray-400 flex items-center gap-2">
                  <CheckCircle className="w-4 h-4 text-green-400" />
                  {summary.wledDevices} WLED devices
                </li>
              )}
              {summary.audioPreferences && (
                <li className="text-sm text-gray-400 flex items-center gap-2">
                  <CheckCircle className="w-4 h-4 text-green-400" />
                  Audio preferences (tempo, key)
                </li>
              )}
              {summary.jamUsername && (
                <li className="text-sm text-gray-400 flex items-center gap-2">
                  <CheckCircle className="w-4 h-4 text-green-400" />
                  Jam session username
                </li>
              )}
            </ul>
          </div>

          {/* Button */}
          <button onClick={onClose} className="w-full btn-primary">
            Got it
          </button>
        </div>
      </div>
    </>
  );
};
```

**Trigger Migration on Signup:**
```typescript
// src/components/Auth/AuthModal.tsx

const handleSignUp = async () => {
  setLoading(true);
  setError('');

  // Create account
  const { error } = await signUp(email, password, finalUsername);

  if (error) {
    setError(error.message);
    setLoading(false);
    return;
  }

  // Check for local settings
  const localSettings = SettingsService.loadFromLocalStorage();
  const hasSetting = Object.keys(localSettings).length > 0;

  if (hasSetting) {
    // Migrate settings
    await migrateSettings();

    // Show success modal
    const summary = {
      wledDevices: localSettings.wled?.devices?.length || 0,
      audioPreferences: !!localSettings.audio,
      jamUsername: !!localSettings.jam?.defaultUsername,
    };

    setMigrationSummary(summary);
    setShowMigrationModal(true);
  }

  setLoading(false);
  onClose();
};
```

### Phase 2: Settings Panel (1 hour)

**Create Component:**
```typescript
// src/components/Settings/SettingsPanel.tsx

import { CheckCircle, Loader2, CloudOff, AlertTriangle } from 'lucide-react';
import { useGlobalMusic } from '@/hooks/useGlobalMusic';

export const SettingsPanel: React.FC<{
  onBack: () => void;
}> = ({ onBack }) => {
  const {
    settings,
    settingsSyncStatus,
    lastSyncedAt,
    refreshSettings,
    resetSettings,
  } = useGlobalMusic();

  const [showResetConfirm, setShowResetConfirm] = useState(false);

  const handleSync = async () => {
    await refreshSettings();
    // Show toast notification
  };

  const handleReset = async () => {
    await resetSettings();
    setShowResetConfirm(false);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 p-4">
      <div className="max-w-4xl mx-auto">

        {/* Header */}
        <div className="flex items-center gap-3 mb-6">
          <button onClick={onBack} className="p-2 hover:bg-gray-700 rounded-lg">
            <ArrowLeft className="w-5 h-5" />
          </button>
          <h1 className="text-2xl font-bold text-white">Settings</h1>
        </div>

        {/* Sync Status */}
        <div className="bg-gray-800 rounded-lg border border-gray-700 p-6 mb-6">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-3">
              {settingsSyncStatus === 'syncing' && (
                <Loader2 className="w-5 h-5 text-primary-400 animate-spin" />
              )}
              {settingsSyncStatus === 'synced' && (
                <CheckCircle className="w-5 h-5 text-green-400" />
              )}
              {settingsSyncStatus === 'offline' && (
                <CloudOff className="w-5 h-5 text-gray-400" />
              )}
              <div>
                <h3 className="text-lg font-semibold text-white">Sync Status</h3>
                <p className="text-sm text-gray-400">
                  {lastSyncedAt ? `Last synced ${formatRelativeTime(lastSyncedAt)}` : 'Not synced'}
                </p>
              </div>
            </div>
            <button
              onClick={handleSync}
              disabled={settingsSyncStatus === 'syncing'}
              className="btn-primary disabled:opacity-50"
            >
              Sync Now
            </button>
          </div>
        </div>

        {/* WLED Devices */}
        {settings.wled?.devices && (
          <div className="bg-gray-800 rounded-lg border border-gray-700 p-6 mb-6">
            <h3 className="text-lg font-semibold text-white mb-2">WLED Devices</h3>
            <p className="text-sm text-gray-400 mb-4">
              {settings.wled.devices.length} devices synced across devices
            </p>
            <ul className="space-y-2">
              {settings.wled.devices.slice(0, 3).map(device => (
                <li key={device.id} className="text-sm text-gray-300">
                  {device.name} ({device.ipAddress})
                </li>
              ))}
            </ul>
          </div>
        )}

        {/* Audio Preferences */}
        {settings.audio && (
          <div className="bg-gray-800 rounded-lg border border-gray-700 p-6 mb-6">
            <h3 className="text-lg font-semibold text-white mb-2">Audio Preferences</h3>
            <div className="grid grid-cols-3 gap-4">
              <div>
                <p className="text-sm text-gray-400">Tempo</p>
                <p className="text-white font-medium">{settings.audio.tempo} BPM</p>
              </div>
              <div>
                <p className="text-sm text-gray-400">Key</p>
                <p className="text-white font-medium">{settings.audio.key}</p>
              </div>
              <div>
                <p className="text-sm text-gray-400">Scale</p>
                <p className="text-white font-medium">{settings.audio.scale}</p>
              </div>
            </div>
          </div>
        )}

        {/* Danger Zone */}
        <div className="bg-gray-800 rounded-lg border border-red-700/50 p-6">
          <h3 className="text-lg font-semibold text-white mb-2">Danger Zone</h3>
          <p className="text-sm text-gray-400 mb-4">
            Reset all settings to factory defaults. This action cannot be undone.
          </p>
          <button
            onClick={() => setShowResetConfirm(true)}
            className="btn-danger"
          >
            Reset to Defaults
          </button>
        </div>

        {/* Reset Confirmation Modal */}
        {showResetConfirm && (
          <ConfirmResetModal
            onConfirm={handleReset}
            onCancel={() => setShowResetConfirm(false)}
          />
        )}
      </div>
    </div>
  );
};
```

### Phase 3: Sync Status Indicator (30 min)

**Add to Header:**
```typescript
// src/components/Layout/Header.tsx

export const Header: React.FC = () => {
  const { settingsSyncStatus } = useGlobalMusic();

  return (
    <header className="sticky top-0 z-30 bg-gray-900/95 backdrop-blur-sm border-b border-gray-800">
      <div className="flex items-center justify-between px-4 py-3">

        {/* Left: Logo / Back Button */}
        {/* ... */}

        {/* Right: Sync Status + Settings */}
        <div className="flex items-center gap-2">
          {/* Sync Status Indicator */}
          <button
            onClick={() => navigate('/settings')}
            className="p-2 hover:bg-gray-700 rounded-lg transition-colors"
            title={
              settingsSyncStatus === 'syncing' ? 'Syncing...' :
              settingsSyncStatus === 'synced' ? 'Settings synced' :
              'Offline mode'
            }
          >
            {settingsSyncStatus === 'syncing' && (
              <Loader2 className="w-5 h-5 text-primary-400 animate-spin" />
            )}
            {settingsSyncStatus === 'synced' && (
              <CheckCircle className="w-5 h-5 text-green-400" />
            )}
            {settingsSyncStatus === 'offline' && (
              <CloudOff className="w-5 h-5 text-gray-400" />
            )}
          </button>

          {/* Settings Button */}
          <button
            onClick={() => navigate('/settings')}
            className="p-2 hover:bg-gray-700 rounded-lg transition-colors"
          >
            <Settings className="w-5 h-5" />
          </button>
        </div>
      </div>
    </header>
  );
};
```

---

## Integration Verification

### Manual Testing Steps

**Test 1: Migration Modal (After Signup)**
1. Use app anonymously
2. Set tempo to 130 BPM
3. Add 2 WLED devices
4. Sign up for account
5. **Expected:** MigrationSuccessModal appears showing "2 WLED devices" and "Audio preferences"
6. Click "Got it"
7. Check Supabase database: settings migrated

**Test 2: Settings Panel**
1. Sign in
2. Navigate to `/settings`
3. Verify sections displayed:
   - Sync status (synced)
   - WLED devices list
   - Audio preferences
   - Reset button
4. **Expected:** All settings visible

**Test 3: Manual Sync**
1. In Settings panel, click "Sync Now"
2. **Expected:** Spinner appears, then checkmark
3. Toast notification: "Settings synced"

**Test 4: Reset to Defaults**
1. In Settings panel, click "Reset to Defaults"
2. **Expected:** Confirmation modal appears
3. Click "Cancel" ‚Üí modal closes
4. Click "Reset to Defaults" again ‚Üí Click "Confirm"
5. **Expected:** App reloads with factory defaults

**Test 5: Sync Status Indicator**
1. Sign in (authenticated)
2. Check header: Green checkmark visible
3. Disconnect network
4. **Expected:** Icon changes to gray CloudOff
5. Reconnect network
6. **Expected:** Icon changes back to green checkmark

---

## Dependencies

### Prerequisites
- ‚úÖ **Story 18.0 Complete:** User Authentication
- ‚úÖ **Story 7.10 Complete:** User Settings Persistence (migration logic)

---

## Deliverables

1. **Components**
   - `src/components/Settings/MigrationSuccessModal.tsx` (~120 lines)
   - `src/components/Settings/SettingsPanel.tsx` (~250 lines)
   - `src/components/Settings/ConfirmResetModal.tsx` (~80 lines)

2. **Context Updates**
   - Modified `src/contexts/GlobalMusicContext.tsx` (+50 lines for sync status)

3. **Header Updates**
   - Modified `src/components/Layout/Header.tsx` (+30 lines for sync indicator)

4. **Routes**
   - Updated `src/App.tsx` (+5 lines for `/settings` route)

---

## Definition of Done

- [ ] MigrationSuccessModal component created
- [ ] Migration modal triggers after signup (if localStorage has settings)
- [ ] Migration summary accurate (counts devices, audio, jam settings)
- [ ] SettingsPanel component created with all sections
- [ ] Manual "Sync Now" button working
- [ ] "Reset to Defaults" button with confirmation
- [ ] Sync status indicator in header (syncing/synced/offline)
- [ ] `/settings` route accessible
- [ ] All manual tests passing (Tests 1-5)
- [ ] Mobile-responsive design
- [ ] Follows existing UI patterns (UsernameModal, AuthModal)
- [ ] No TypeScript errors (strict mode)

---

## Future Enhancements

- Settings export/import (download JSON file)
- Settings history (rollback to previous version)
- Conflict resolution (if settings changed on multiple devices simultaneously)

---

## References

- **Epic 18:** Intelligent WLED Routing (`docs/epics/epic-18-intelligent-wled-routing.md`)
- **Story 18.0:** User Authentication (`docs/stories/18.0-user-accounts-mvp.md`)
- **Story 7.10:** User Settings Persistence (`docs/stories/7.10-user-settings-persistence.md`)
- **Architecture Doc:** Admin Settings Startup (`docs/architecture/admin-settings-startup.md`)

---

**Story Created:** 2025-10-20
**Story Owner:** Dev Agent
**Estimated Completion:** 2-3 hours after start
**Depends On:** Story 7.10
