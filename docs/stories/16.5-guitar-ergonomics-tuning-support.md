# Story 16.5: Guitar-Specific Ergonomics and Tuning Support

## Status
Draft

## Story
**As a** guitar player using the fretboard module with various tunings,
**I want** the harmonic guidance system to respect guitar-specific physical constraints and alternate tunings,
**so that** suggested melodic paths are physically playable and ergonomically comfortable.

## Acceptance Criteria
1. String jumps map correctly to pitch distance (0-2 semitones = same/adjacent strings, 3-5 = 1-2 jumps, 6+ = large jumps)
2. Position boundaries visible (4-fret max span guidance, optional visual markers)
3. Open strings highlighted as anchor points (no finger stretch required)
4. CAGED root shapes optionally highlighted (educational feature, default OFF)
5. Tuning changes recalculate brightness correctly (fretboard matrix updates)
6. All tuning presets work (standard, drop D, DADGAD, open G/D/C, etc.)
7. Brightness respects physical ergonomics (favors lower fret positions for beginners)

## Tasks / Subtasks

- [ ] Implement string jump mapping logic (AC: 1)
  - [ ] Calculate expected string jump from pitch distance
  - [ ] 0-2 semitones → 0-1 string jump (same or adjacent string)
  - [ ] 3-5 semitones → 1-2 string jumps
  - [ ] 6-9 semitones → 2-3 string jumps
  - [ ] 10+ semitones → 3+ string jumps (octave leap)
  - [ ] Prefer closer string when same pitch available on multiple strings

- [ ] Add position boundary detection (AC: 2)
  - [ ] Calculate fretting hand span (max fret - min fret within highlighted notes)
  - [ ] If span > 4 frets, show visual warning or dim brightness
  - [ ] Add optional position shift markers (e.g., dotted vertical lines at fret 5, 9, 12)
  - [ ] Setting toggle: "Show Position Boundaries" (default OFF)

- [ ] Highlight open strings as anchors (AC: 3)
  - [ ] Add brightness boost (+0.15) for fret 0 (open strings)
  - [ ] Apply boost only when harmonic guidance enabled
  - [ ] Visual indicator: Brighter border for open string frets
  - [ ] Educational tooltip: "Open string (no stretch required)"

- [ ] Add CAGED root shape highlighting (AC: 4)
  - [ ] Detect root note positions within current key
  - [ ] Map to CAGED shapes (C shape at fret X, A shape at fret Y, etc.)
  - [ ] Add optional visual overlay (faint shape outline)
  - [ ] Setting toggle: "Show CAGED Shapes" (default OFF)
  - [ ] Only show when in standard tuning (CAGED breaks down in alternate tunings)

- [ ] Handle tuning changes (AC: 5, 6)
  - [ ] Listen to `selectedTuning` state changes
  - [ ] Recalculate fretboard matrix: `createFretboardMatrix(currentTuningMIDI)`
  - [ ] Update brightness calculations with new MIDI notes
  - [ ] Verify open string highlights update correctly
  - [ ] Test all tuning presets from `tunings.ts` file

- [ ] Add beginner-friendly ergonomics (AC: 7)
  - [ ] Apply fret position penalty: Brightness × (1 - (fret / 48))
  - [ ] Fret 0 (open): No penalty (1.0)
  - [ ] Fret 5: Small penalty (0.90)
  - [ ] Fret 12: Medium penalty (0.75)
  - [ ] Fret 24: Large penalty (0.50)
  - [ ] Setting toggle: "Favor Lower Positions" (default ON)

## Dev Notes

### Relevant Source Tree
- **GuitarFretboard**: `src/components/GuitarFretboard/GuitarFretboard.tsx`
- **Tunings**: `src/components/GuitarFretboard/tunings.ts` (GUITAR_TUNINGS, getTuningMIDINotes)
- **Constants**: `src/components/GuitarFretboard/constants.ts` (createFretboardMatrix, getMIDINoteFromFret)
- **FretboardCanvas**: `src/components/GuitarFretboard/FretboardCanvas.tsx`

### String Jump Mapping Logic

**Piano Roll (Reference)**:
- Temporal offset purely based on pitch distance
- No physical constraints (any note can be played immediately after any other note)

**Guitar Fretboard (Physical Reality)**:
- String topology limits playable sequences
- Fretting hand has 4-fret max comfortable span
- Same pitch available on multiple strings → choose closer string

**String Jump Algorithm**:
```typescript
function calculateExpectedString(
  currentString: number,
  currentPitch: number,
  lastString: number,
  lastPitch: number
): number {
  const pitchDifference = currentPitch - lastPitch;

  // Calculate natural string jump for pitch distance
  let stringJump = 0;
  const pitchDistance = Math.abs(pitchDifference);

  if (pitchDistance <= 2) {
    stringJump = pitchDifference >= 0 ? 0 : 1; // Same or adjacent string
  } else if (pitchDistance <= 5) {
    stringJump = Math.floor(pitchDistance / 3); // 1-2 string jump
  } else {
    stringJump = Math.floor(pitchDistance / 4); // 2+ string jump
  }

  // Apply direction
  const expectedString = pitchDifference >= 0
    ? lastString + stringJump // Ascending (towards higher strings)
    : lastString - stringJump; // Descending (towards lower strings)

  // Clamp to valid range (0-5 for 6 strings)
  return Math.max(0, Math.min(5, expectedString));
}

// Check if current cell is within expected string range (±1 string tolerance)
function isWithinStringRange(
  currentString: number,
  expectedString: number
): boolean {
  return Math.abs(currentString - expectedString) <= 1;
}
```

### Position Boundary Detection

**4-Fret Rule**: The average guitarist can comfortably stretch 4 frets within a single position (e.g., frets 5-8, or frets 10-13).

**Visual Indicators**:
- **Position shift markers**: Vertical dotted lines at common position boundaries (frets 5, 9, 12, 15)
- **Brightness penalty**: If highlighted notes span > 4 frets, reduce brightness by 20%
- **Warning indicator**: Optional red outline for notes requiring position shift

```typescript
function calculatePositionSpan(highlightedFrets: Set<number>): number {
  if (highlightedFrets.size === 0) return 0;

  const fretArray = Array.from(highlightedFrets).sort((a, b) => a - b);
  const minFret = fretArray[0];
  const maxFret = fretArray[fretArray.length - 1];

  return maxFret - minFret;
}

function applyPositionPenalty(brightness: number, positionSpan: number): number {
  if (positionSpan <= 4) return brightness; // Comfortable span, no penalty

  // Penalize notes requiring position shift
  const penalty = Math.min(0.2, (positionSpan - 4) * 0.05);
  return brightness * (1 - penalty);
}
```

### Open String Anchor Highlighting

**Why Open Strings Matter**:
- No finger stretch required (always playable)
- Natural anchor points for chord shapes
- Beginner-friendly (no fretting technique needed)

**Implementation**:
```typescript
function calculateBrightnessWithOpenBoost(
  string: number,
  fret: number,
  baseBrightness: number
): number {
  if (fret === 0) {
    // Open string: Add +0.15 brightness boost
    return Math.min(1.0, baseBrightness + 0.15);
  }

  return baseBrightness;
}
```

### CAGED System Integration

**CAGED Concept**: Five fundamental chord shapes (C, A, G, E, D) that can be moved up the fretboard to play any chord.

**Root Position Mapping** (Standard Tuning):
```typescript
// CAGED shape root positions (relative to fret position)
const CAGED_SHAPES = {
  C: { string: 4, fret: 'root' }, // Root on 5th string (A string)
  A: { string: 4, fret: 'root' }, // Root on 5th string
  G: { string: 5, fret: 'root' }, // Root on 6th string (E string)
  E: { string: 5, fret: 'root' }, // Root on 6th string
  D: { string: 3, fret: 'root' }, // Root on 4th string (D string)
};

function highlightCAGEDShapes(
  rootNote: number, // e.g., C = 0
  key: string,
  fretboardMatrix: number[][]
): Map<string, number> {
  // Find root note positions on fretboard
  const rootPositions: Array<{ string: number; fret: number }> = [];

  for (let string = 0; string < 6; string++) {
    for (let fret = 0; fret <= 24; fret++) {
      const noteClass = fretboardMatrix[string][fret];
      if (noteClass % 12 === rootNote) {
        rootPositions.push({ string, fret });
      }
    }
  }

  // For each root position, determine which CAGED shape applies
  // (Simplified: just highlight root positions)
  return new Map(rootPositions.map((pos, idx) => [
    `${pos.string}-${pos.fret}`,
    1.0 // Full brightness for roots
  ]));
}
```

**Note**: Full CAGED implementation is complex. For MVP, just highlight root note positions as "CAGED anchors".

### Tuning Change Handling

**Current Tunings Supported** (from `tunings.ts`):
- Standard (E-A-D-G-B-E)
- Drop D (D-A-D-G-B-E)
- DADGAD (D-A-D-G-A-D)
- Open G (D-G-D-G-B-D)
- Open D (D-A-D-F#-A-D)
- Open C (C-G-C-G-C-E)
- Drop C (C-G-C-F-A-D)

**Tuning Change Effect**:
- Fretboard matrix changes (new MIDI note assignments)
- Open string positions change
- Brightness calculations must use updated MIDI notes

```typescript
// Listen to tuning changes
useEffect(() => {
  // Recalculate fretboard matrix
  const currentTuningMIDI = getTuningMIDINotes(selectedTuning);
  const updatedMatrix = createFretboardMatrix(currentTuningMIDI);

  // Force re-render of brightness calculations
  // (handled automatically by React state updates)
  console.log(`Tuning changed to: ${selectedTuning.name}`);
}, [selectedTuning]);
```

### Beginner-Friendly Ergonomic Penalties

**Goal**: Guide beginners towards lower fret positions (open position, frets 0-5) which are:
- Easier to reach
- More comfortable to hold
- Have wider fret spacing (easier to finger)

**Formula**:
```typescript
function applyFretPositionPenalty(
  brightness: number,
  fret: number,
  favorLowerPositions: boolean
): number {
  if (!favorLowerPositions) return brightness;

  // Linear penalty: 0% at fret 0, 50% at fret 24
  const penalty = fret / 48; // 0.0 to 0.5
  return brightness * (1 - penalty);
}
```

**Effect**:
| Fret | Penalty | Brightness (0.90 chord tone) |
|------|---------|------------------------------|
| 0 (open) | 0% | 0.90 (no change) |
| 5 | 10% | 0.81 |
| 12 | 25% | 0.68 |
| 24 | 50% | 0.45 |

### Testing
**Manual Verification Steps**:

1. **String Jump Mapping (Standard Tuning)**:
   - Hover over String 3, Fret 5 (C note)
   - Verify nearby pitches (D, E) highlight on same or adjacent strings
   - Verify far pitches (G, A) highlight with 2-3 string jumps

2. **Position Boundaries**:
   - Enable "Show Position Boundaries" setting
   - Hover over fret to create highlights spanning > 4 frets
   - Verify position shift markers visible (dotted lines at frets 5, 9, 12)
   - Verify brightness penalty applied to notes outside 4-fret span

3. **Open String Anchors**:
   - Verify fret 0 (open strings) are noticeably brighter
   - Hover over open string → Verify highlighted pathways include other open strings

4. **CAGED Shapes** (if implemented):
   - Enable "Show CAGED Shapes" setting
   - Select key (e.g., C major)
   - Verify root note positions highlighted (C on frets 3, 8, 15, etc.)

5. **Tuning Changes**:
   - Change tuning to Drop D
   - Verify brightness recalculates (fret 0 on String 6 is now D, not E)
   - Change to DADGAD
   - Verify open string highlights update correctly
   - Test all tuning presets

6. **Ergonomic Penalties**:
   - Enable "Favor Lower Positions" setting
   - Verify frets 0-5 are brighter than frets 12-24
   - Disable setting → Verify brightness equalizes

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-15 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*To be filled by QA agent*
