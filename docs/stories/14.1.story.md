# Story 14.1: Brownfield Module System Architecture Design

## Status
IN PROGRESS

## Story
**As a** system architect,
**I want** comprehensive architecture documentation for the module system refactoring,
**so that** developers can implement the module adapter pattern with clear guidance on global/local control separation, context detection, and integration with Epic 4 infrastructure.

## Acceptance Criteria
1. Complete brownfield architecture document using `brownfield-architecture-tmpl.yaml` template
2. Module inventory & control analysis covering all 5 modules (PianoRoll, GuitarFretboard, IsometricSequencer, DrumMachine, LiveAudioVisualizer)
3. Control classification with rationale (global vs. local vs. TBD)
4. Module adapter pattern design with TypeScript interfaces
5. Integration strategy phasing (Phase 1-3 with module priorities)
6. Migration plan preserving standalone view functionality (no breaking changes)
7. Coordination with Epic 13 documentation consolidation (reconciliation audit integration)

## Integration Verification
- **IV1**: Architecture document passes Winston (Architect) review using elicitation methods
- **IV2**: All 12 sections complete (Introduction through Next Steps)
- **IV3**: Module adapter pattern validated against existing Epic 4 patterns (GlobalMusicContext, always-mount)
- **IV4**: TBD questions (LED routing, hardware sharing, chord sync) clearly marked for Product Owner research

## Tasks / Subtasks

- [x] **Task 1: Deep Module Analysis** (AC: 2, 3)
  - [x] Analyze PianoRoll functionality and controls
  - [x] Analyze GuitarFretboard functionality and controls
  - [x] Analyze IsometricSequencer functionality and controls
  - [x] Analyze DrumMachine functionality and controls
  - [x] Analyze LiveAudioVisualizer functionality and controls
  - [x] Create module inventory table with user stories
  - [x] Classify controls (global candidates, local candidates, both support)
  - [x] Identify duplicate controls (key/scale in 3 modules, tempo in 2 modules, color mode in 2 modules)

- [x] **Task 2: Section 1 - Introduction** (AC: 1, 2, 3, 7)
  - [x] Document current project state and tech stack
  - [x] List available documentation (Epic 4, Epic 13, reconciliation audit)
  - [x] Identify constraints (no breaking changes, Epic 4 foundation, always-mount pattern)
  - [x] Create module inventory & control analysis table
  - [x] Classify controls (global, local, TBD)
  - [x] Define 4 confirmed design principles (transport control, standalone preservation, always-mount, doc alignment)
  - [x] Mark TBD questions requiring user research
  - [x] User elicitation: Selected "1. Proceed to next section"

- [x] **Task 3: Section 2 - Enhancement Scope & Integration Strategy** (AC: 4, 5, 6)
  - [x] Define enhancement overview (type, scope, impact)
  - [x] Code integration strategy (module adapter pattern with useModuleContext hook)
  - [x] Database integration (N/A - localStorage only, no persistence for transport state)
  - [x] API integration (N/A - client-side only)
  - [x] UI integration (progressive enhancement, ViewTemplate compliance, control hiding)
  - [x] Compatibility requirements (backward compatibility, no breaking changes)
  - [x] Performance impact assessment (low - existing Epic 4 optimizations)
  - [x] Boundary definition (what this DOES and DOES NOT do)
  - [x] User elicitation: Selected "1. Proceed to next section"

- [x] **Task 4: Section 3 - Tech Stack** (AC: 1)
  - [x] Document existing technology stack (React, TypeScript, Vite, Tailwind, Tone.js)
  - [x] Verify no new technology additions required
  - [x] Document version compatibility
  - [ ] User elicitation (1-9 options)

- [x] **Task 5: Section 4 - Data Models & Schema Changes** (AC: 4)
  - [x] Define ModuleContext enum ('standalone' | 'studio' | 'jam')
  - [x] Define ModuleAdapterProps interface
  - [x] Define GlobalMusicState extension (isPlaying, updateTransportState)
  - [x] Define localStorage schema (transport state NOT persisted)
  - [x] Define AudioEngine extension (transport control methods)
  - [x] Document migration path (optional → required field)
  - [ ] User elicitation (1-9 options)

- [x] **Task 6: Section 5 - Component Architecture** (AC: 4, 5)
  - [x] Document useModuleContext hook design
  - [x] Document GlobalMusicContext extension (transport state)
  - [x] Document AudioEngine extension (transport control methods)
  - [x] Document module refactoring patterns (PianoRoll before/after example)
  - [x] Document GlobalMusicHeader extension (TransportControls component)
  - [x] Create component interaction diagram (Mermaid - data flow)
  - [x] Document component hierarchy
  - [x] Create developer refactoring checklist (manual verification steps)
  - [ ] User elicitation (1-9 options)

- [ ] **Task 7: Section 6 - API Design** (AC: 1)
  - [ ] Mark N/A (no backend API)
  - [ ] Document Web API dependencies (Web MIDI, Web Audio, WLED HTTP/UDP)
  - [ ] User elicitation (1-9 options)

- [ ] **Task 8: Section 7 - Source Tree** (AC: 1)
  - [ ] Document new files (useModuleContext.ts, moduleAdapter.ts)
  - [ ] Document modified files (5 modules, GlobalMusicContext, GlobalMusicHeader)
  - [ ] Show integration with existing structure
  - [ ] User elicitation (1-9 options)

- [ ] **Task 9: Section 8 - Infrastructure & Deployment** (AC: 1)
  - [ ] Mark no changes (client-side only)
  - [ ] Verify existing Vite build unchanged
  - [ ] User elicitation (1-9 options)

- [ ] **Task 10: Section 9 - Coding Standards** (AC: 6)
  - [ ] Document module context detection patterns
  - [ ] Document graceful degradation patterns
  - [ ] Document conditional control rendering patterns
  - [ ] Ensure TypeScript strict mode compliance
  - [ ] User elicitation (1-9 options)

- [ ] **Task 11: Section 10 - Testing Strategy** (AC: 6)
  - [ ] Define unit tests (useModuleContext hook)
  - [ ] Define integration tests (module global state consumption)
  - [ ] Define regression tests (standalone views preservation)
  - [ ] Define performance tests (transport state updates <50ms)
  - [ ] User elicitation (1-9 options)

- [ ] **Task 12: Section 11 - Security Integration** (AC: 1)
  - [ ] Mark no changes (no new attack surface)
  - [ ] Verify existing security patterns maintained
  - [ ] User elicitation (1-9 options)

- [ ] **Task 13: Section 12 - Next Steps** (AC: 1)
  - [ ] Create Story Manager handoff prompt
  - [ ] Create Developer handoff prompt
  - [ ] Document phased implementation plan (Stories 14.2-14.6)
  - [ ] List TBD questions for Product Owner research
  - [ ] User elicitation (1-9 options)

- [ ] **Task 14: Create Checkpoint Document** (AC: 7)
  - [ ] Document session context for resumability
  - [ ] List completed sections
  - [ ] List remaining sections
  - [ ] Document open questions
  - [ ] Create agent handoff notes

- [ ] **Task 15: Final Review & Validation** (IV: 1, 2, 3, 4)
  - [ ] Verify all 12 sections complete
  - [ ] Verify module adapter pattern aligns with Epic 4
  - [ ] Verify TBD questions clearly marked
  - [ ] Run through Winston architect checklist
  - [ ] Mark story COMPLETE

## Dev Notes

### Relevant Architecture Context

**Epic 4 Foundation (Complete):**
- GlobalMusicContext: `src/contexts/GlobalMusicContext.tsx` (Story 4.1)
- GlobalMusicHeader: `src/components/GlobalMusicHeader/GlobalMusicHeader.tsx` (Story 4.2)
- Module loading system: `src/components/Studio/` (Story 4.7)
- Always-mount pattern: Proven in JamSession (CSS visibility, no unmount/remount)

**Epic 13 Coordination (In Progress):**
- Documentation consolidation: Epics 1-4 moving from `docs/prd/` to `docs/epics/`
- Architecture updates: 12 components need source-tree.md documentation
- This epic will add module adapter patterns to component-architecture.md

**Module Analysis Findings:**
- 3 modules need full refactoring (PianoRoll, GuitarFretboard, IsometricSequencer)
- 1 module partially integrated (DrumMachine - uses global tempo/colorMode)
- 1 module optional (LiveAudioVisualizer - global volume integration)
- Duplicate controls: Key/Scale (3x), Tempo (2x), Color Mode (2x)

### Brownfield Architecture Template

**Template:** `.bmad-core/templates/brownfield-architecture-tmpl.yaml`

**Required Sections:**
1. ✅ Introduction (Existing Project Analysis, Constraints, Module Inventory)
2. ✅ Enhancement Scope & Integration Strategy (Code/UI/DB/API integration, Compatibility)
3. ✅ Tech Stack (Existing + New - zero new dependencies)
4. ✅ Data Models & Schema Changes (TypeScript interfaces, transport state, migration path)
5. ✅ Component Architecture (useModuleContext hook, GlobalMusicContext extension, module patterns, Mermaid diagram, developer checklist)
6. ⏳ API Design (N/A or Web APIs)
7. ⏳ Source Tree (New files, modified files)
8. ⏳ Infrastructure & Deployment (No changes expected)
9. ⏳ Coding Standards (Patterns for context detection)
10. ⏳ Manual Verification Strategy (Browser-based testing workflows)
11. ⏳ Security Integration (No changes expected)
12. ⏳ Next Steps (Story Manager + Developer handoff)

### Session Progress Tracking

**Sections Complete:** 5 of 12 (42%)
**Next Section:** API Design
**Elicitation Mode:** Interactive (1-9 options after each section)
**User Preference:** "proceed" command (efficient workflow)

**Checkpoint Frequency:** After every 2-3 sections to preserve context for session resumability
**Checkpoint Status:** ⚠️ RECOMMENDED NOW (Section 5 complete - create checkpoint before continuing)

### Design Decisions Log

**Global Transport Control (Design Principle #1):**
- Pattern: DAW/MTC-style master transport
- Global play/pause affects all sequencer/instrument modules
- Visualizers continue running (always-on for live audio)
- Modules retain individual play/pause for performance flexibility
- Rationale: Industry standard (Ableton, Logic, FL Studio), DAWLESS hardware MIDI MTC

**Standalone View Preservation (Design Principle #2):**
- Pattern: Context detection with graceful degradation
- Modules function standalone with local state fallback
- When embedded: Consume GlobalMusicContext, hide redundant controls
- No breaking changes to existing routes
- Rationale: Users share direct links (e.g., `/piano` for education demos)

**Always-Mount Pattern (Design Principle #3):**
- Pattern: CSS visibility control (JamSession proven approach)
- All modules rendered, CSS controls visibility
- Audio contexts persist, no pops/clicks from re-initialization
- Rationale: Professional DAW behavior, maintains visualizations

**Documentation Alignment (Design Principle #4):**
- Architecture tracks Epic 13 consolidation
- Epic/story numbers may shift during reconciliation
- Architecture supports greenfield documentation structure
- Rationale: Prevents architecture/documentation drift

**Module Adapter Pattern (Code Integration):**
- Pattern: `useModuleContext()` hook via React Router `useLocation`
- No prop drilling, context detection internal to modules
- Graceful degradation: `const key = context === 'standalone' ? localKey : globalMusic.key`
- Rationale: Simplicity, TypeScript support, no HOC complexity

**Transport State Storage:**
- Pattern: In-memory only (GlobalMusicContext), NOT persisted to localStorage
- Prevents confusing "auto-play on reload" behavior
- Rationale: User expectations (DAWs don't auto-play on open)

**TBD Deferred to Product Owner:**
- LED routing strategy (per-module vs. global routing table)
- Hardware sharing (MIDI/WLED device arbitration)
- Chord progression system (global mode vs. module content)
- Transport edge cases (visualizer stop behavior, module-level override)
- Rationale: Complex user research questions, avoid premature optimization

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-13 | 1.0 | Initial story creation - Brownfield Module System Architecture Design | Winston (Architect) |

---

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929 (Sonnet 4.5)

### Debug Log References
None - Architecture design phase (no code implementation yet)

### Session Context

**Architecture Work Location:**
- Primary document: `docs/architecture/brownfield-module-refactoring.md` (WIP - Sections 1-4 complete)
- Checkpoint document: `docs/architecture-refactoring-checkpoint.md` (to be created after Section 5)
- Epic file: `docs/epics/epic-14-module-adapter-system.md` (created)
- Story file: `docs/stories/14.1.story.md` (this file)

**Session Progress:**
- Started: 2025-01-13
- Status: IN PROGRESS (Sections 1-4 complete, Section 5 pending)
- Elicitation method: Interactive BMAD workflow with 1-9 options
- User workflow preference: "proceed" command (efficient, trusting architect)

**Key Milestones:**
1. ✅ Deep module analysis complete (5 modules, control classification)
2. ✅ Section 1 (Introduction) complete - Module inventory, design principles
3. ✅ Section 2 (Enhancement Scope) complete - Module adapter pattern
4. ✅ Epic 14 + Story 14.1 created per documentation standards
5. ✅ Section 3 (Tech Stack) complete - Verified zero new dependencies
6. ✅ Section 4 (Data Models) complete - TypeScript interfaces, transport state, migration path
7. ⏳ Section 5 (Component Architecture) - NEXT (checkpoint due after completion)

**Resumability Instructions:**
1. Read `docs/architecture-refactoring-checkpoint.md` first (session context - to be created after Section 5)
2. Read `docs/epics/epic-14-module-adapter-system.md` (epic overview)
3. Read `docs/stories/14.1.story.md` (this file - task checklist)
4. Load `docs/architecture/brownfield-module-refactoring.md` (WIP document - Sections 1-4 complete)
5. Continue from Task 6 (Section 5: Component Architecture)

**Context for New Session:**
- User confirmed global play/pause design principle
- User noted Epic 13 reconciliation affecting epic/story numbering
- User requested checkpoint for context window refresh
- User enforced documentation standards (Epic 14 + Story 14.1 required)
- Architecture work follows BMAD brownfield-architecture-tmpl.yaml template

### Completion Notes List
_To be populated when story marked COMPLETE_

**Fill this out when architecture document finished (Sections 5-12 complete):**
- Section 3: Tech Stack - ✅ COMPLETE - Zero new dependencies, verified existing stack
- Section 4: Data Models - ✅ COMPLETE - ModuleContext enum, GlobalMusicState extension with transport state, localStorage schema (transport NOT persisted), AudioEngine extension, migration path documented
- Section 5: Component Architecture - Module adapter pattern details, Mermaid diagrams
- Section 6: API Design - Mark N/A or document Web APIs
- Section 7: Source Tree - New files (hooks, types), modified files (modules)
- Section 8: Infrastructure - Mark no changes (client-side only)
- Section 9: Coding Standards - Context detection patterns, graceful degradation
- Section 10: Testing Strategy - Unit, integration, regression test plans
- Section 11: Security - Mark no changes (no new attack surface)
- Section 12: Next Steps - Story Manager + Developer handoff prompts
- Checkpoint document created for resumability
- All 12 sections validated via Winston architect checklist

### File List

**Created:**
- `docs/epics/epic-14-module-adapter-system.md` (epic overview with placeholders)
- `docs/stories/14.1.story.md` (this file)
- `docs/architecture-refactoring-checkpoint.md` (to be created - checkpoint for session resumability)

**Modified:**
- `docs/architecture/brownfield-module-refactoring.md` (WIP - Sections 1-4 complete, Sections 5-12 pending)

**To Be Created (when architecture complete):**
- `docs/architecture-refactoring-checkpoint.md` (checkpoint document)
- Any additional diagrams or supporting documents as needed

**To Be Modified (based on architecture completion):**
- `docs/architecture/component-architecture.md` (add module adapter pattern section)
- `docs/architecture/source-tree.md` (add new hooks/types to file structure)

---

## QA Results
_To be populated by QA agent when story complete_

**Validation Checklist (when ready for QA):**
- [ ] All 12 architecture sections complete and reviewed
- [ ] Module adapter pattern validated against Epic 4 infrastructure
- [ ] TBD questions clearly marked for Product Owner research
- [ ] No breaking changes to existing standalone views
- [ ] Checkpoint document created for session resumability
- [ ] Epic 14 file has accurate story summaries
- [ ] Integration Verification criteria met (IV1-IV4)
