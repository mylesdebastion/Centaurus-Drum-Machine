# Story 7.10: Note/Chord/Pattern Broadcasting & Multi-Instrument Sync

**Epic:** Epic 7 - Jam Session Backend Infrastructure (Hybrid: Supabase + WebRTC P2P)
**Status:** 📝 READY FOR DEVELOPMENT
**Priority:** 🟡 MEDIUM
**Complexity:** Medium-High
**Time Estimate:** 6-10 hours
**Prerequisites:** Story 7.2, Story 7.3

---

## User Story

As a **participant in a jam session**,
I want **notes and chords I play on my instrument to appear on other users' modules in real-time**,
So that **everyone can see and hear the same musical ideas across different instruments**.

---

## Story Context

**Existing System Integration:**
- Integrates with: SupabaseSessionService (Broadcast), PianoRoll, GuitarFretboard, IsometricSequencer
- Technology: Supabase Broadcast, MIDI note representation, TypeScript
- Follows pattern: Event-driven note broadcasting, instrument-agnostic data format
- Touch points: All interactive music modules, GlobalMusicContext

**Why This Story:**
Cross-module note synchronization enables true collaborative composition. When User A plays notes on a piano roll, User B should see those notes appear on their guitar fretboard or piano module in real-time. This creates a shared musical canvas where participants can play different instruments while staying synchronized.

**Key Difference from Audio Sync (Story 7.5):**
- Story 7.5 (WebRTC Audio): Transmits raw audio streams for low-latency playback
- Story 7.10 (Note Broadcast): Transmits MIDI note events for visual/interactive synchronization
- Both work together: Audio for listening, Note broadcast for seeing/playing along

---

## Acceptance Criteria

### Functional Requirements

1. **Instrument-Agnostic Note Format**
   - Define universal note event structure:
     ```typescript
     interface BroadcastNoteEvent {
       type: 'note-on' | 'note-off';
       note: string;           // e.g., "C4", "D#5" (universal musical notation)
       midiNote: number;       // 0-127 (MIDI standard)
       velocity: number;       // 0-1 (normalized volume)
       timestamp: number;      // Performance.now() for timing
       sourceModule: 'piano-roll' | 'guitar' | 'piano' | 'isometric' | 'external-midi';
       userId: string;         // Who triggered this note
       duration?: number;      // Optional: note length in ms (for note-on events)
     }
     ```

2. **Broadcast Note Events via Supabase**
   - Extend SupabaseSessionService:
     ```typescript
     class SupabaseSessionService {
       // ... existing methods

       broadcastNote(event: BroadcastNoteEvent): void {
         this.channel.send({
           type: 'broadcast',
           event: 'note-event',
           payload: event
         });
       }

       onNoteEvent(callback: (event: BroadcastNoteEvent) => void): void {
         this.channel.on('broadcast', { event: 'note-event' }, ({ payload }) => {
           callback(payload);
         });
       }
     }
     ```

3. **Piano Roll → Broadcast Integration**
   - File: `src/components/PianoRoll/PianoRoll.tsx`
   - Broadcast notes when user plays/clicks:
     ```typescript
     const handleNoteClick = (noteIndex: number, stepIndex: number) => {
       const note = notes[noteIndex];
       const midiNote = 60 + noteIndex; // Example: C4 = 60

       // Local state update
       toggleNote(noteIndex, stepIndex);

       // Broadcast to other users (if in session)
       if (sessionService.isInSession()) {
         sessionService.broadcastNote({
           type: 'note-on',
           note: note.name,
           midiNote,
           velocity: 0.8,
           timestamp: performance.now(),
           sourceModule: 'piano-roll',
           userId: sessionService.getMyPeerId(),
           duration: 500 // 500ms note length
         });
       }
     };
     ```

4. **Guitar Fretboard → Broadcast Integration**
   - File: `src/components/GuitarFretboard/GuitarFretboard.tsx`
   - Broadcast notes when fret is pressed:
     ```typescript
     const handleFretPress = (string: number, fret: number) => {
       const note = calculateNote(string, fret); // e.g., "E4"
       const midiNote = noteToMIDI(note);

       // Local audio/visual feedback
       playNote(note);

       // Broadcast to other users
       if (sessionService.isInSession()) {
         sessionService.broadcastNote({
           type: 'note-on',
           note,
           midiNote,
           velocity: 0.8,
           timestamp: performance.now(),
           sourceModule: 'guitar',
           userId: sessionService.getMyPeerId()
         });
       }
     };
     ```

5. **Receive and Display Remote Notes**
   - Piano Roll receives notes:
     ```typescript
     useEffect(() => {
       if (!sessionService.isInSession()) return;

       const unsubscribe = sessionService.onNoteEvent((event) => {
         // Ignore own notes (already displayed locally)
         if (event.userId === sessionService.getMyPeerId()) return;

         // Convert MIDI note to piano roll index
         const noteIndex = event.midiNote - 60; // Adjust for piano roll range

         // Visual feedback: highlight note temporarily
         highlightRemoteNote(noteIndex, event.userId);

         // Optional: Play audio for remote notes
         if (audioPlaybackEnabled) {
           playNote(event.note, event.velocity);
         }
       });

       return unsubscribe;
     }, [sessionService]);
     ```

   - Guitar Fretboard receives notes:
     ```typescript
     useEffect(() => {
       if (!sessionService.isInSession()) return;

       const unsubscribe = sessionService.onNoteEvent((event) => {
         if (event.userId === sessionService.getMyPeerId()) return;

         // Convert MIDI note to guitar fret position
         const fretPosition = midiToFretPosition(event.midiNote);

         // Highlight fret with user's color
         highlightRemoteFret(fretPosition, event.userId);

         // Play audio
         if (audioPlaybackEnabled) {
           playNote(event.note, event.velocity);
         }
       });

       return unsubscribe;
     }, [sessionService]);
     ```

6. **Per-User Visual Differentiation**
   - Assign colors to each participant (from Presence data):
     ```typescript
     const USER_COLORS = [
       '#FF6B6B', // Red
       '#4ECDC4', // Teal
       '#45B7D1', // Blue
       '#FFA07A', // Orange
       '#98D8C8', // Mint
       '#F7DC6F', // Yellow
     ];

     function getUserColor(userId: string, participants: Participant[]): string {
       const index = participants.findIndex(p => p.id === userId);
       return USER_COLORS[index % USER_COLORS.length];
     }
     ```

   - Highlight remote notes with user colors:
     ```typescript
     // In Piano Roll
     <div
       className="remote-note-highlight"
       style={{
         backgroundColor: getUserColor(event.userId, participants),
         opacity: 0.6,
         animation: 'fade-out 1s ease-out'
       }}
     />
     ```

7. **Note Event Throttling**
   - Prevent message spam during rapid note entry:
     ```typescript
     const debouncedBroadcast = useMemo(
       () => throttle((event: BroadcastNoteEvent) => {
         sessionService.broadcastNote(event);
       }, 50), // Max 20 notes/second
       []
     );
     ```

8. **Optional: Pattern Broadcasting**
   - Broadcast entire sequences/patterns:
     ```typescript
     interface BroadcastPatternEvent {
       type: 'pattern-share';
       pattern: NoteEvent[]; // Array of notes with timing
       sourceModule: string;
       userId: string;
       patternName?: string;
     }

     // User clicks "Share Pattern" button
     const sharePattern = () => {
       sessionService.channel.send({
         type: 'broadcast',
         event: 'pattern-share',
         payload: {
           type: 'pattern-share',
           pattern: currentPattern,
           sourceModule: 'piano-roll',
           userId: sessionService.getMyPeerId(),
           patternName: 'Cool Riff'
         }
       });
     };
     ```

### Integration Requirements

9. **GlobalMusicContext Integration**
   - Use `key` and `scale` from GlobalMusicContext for note validation:
     ```typescript
     const isNoteInScale = (note: string, key: string, scale: string): boolean => {
       // Validate if note belongs to current key/scale
       // Highlight off-scale notes differently
     };
     ```

10. **MIDI Input Integration (External Devices)**
    - Broadcast notes from external MIDI controllers:
      ```typescript
      // In MIDI handler
      midiAccess.inputs.forEach(input => {
        input.onmidimessage = (event) => {
          const [status, note, velocity] = event.data;

          if (status === 144 && velocity > 0) { // Note On
            sessionService.broadcastNote({
              type: 'note-on',
              note: midiToNoteName(note),
              midiNote: note,
              velocity: velocity / 127,
              timestamp: performance.now(),
              sourceModule: 'external-midi',
              userId: sessionService.getMyPeerId()
            });
          }
        };
      });
      ```

11. **Performance Optimization**
    - Throttle broadcast messages (max 20 notes/second)
    - Debounce note-off events (coalesce rapid on/off into single event)
    - Batch multiple notes if possible (chord events)

### Quality Requirements

12. **Latency Requirements**
    - **Target:** Note events appear on remote modules within 200ms
    - **Acceptable:** Note events appear within 500ms
    - **Measure:** Timestamp comparison between broadcast and receive

13. **Visual Feedback**
    - Remote notes highlighted with user-specific colors
    - Smooth fade-out animation (1 second)
    - Clear distinction between local and remote notes
    - Optional: Show username label on remote notes

14. **User Experience**
    - Toggle to enable/disable remote note display
    - Toggle to enable/disable remote note audio playback
    - Clear visual indicator when receiving remote notes
    - No lag or jank in local module interaction

---

## Technical Notes

**Integration Approach:**
- Supabase Broadcast for note event transmission (acceptable latency for visual sync)
- MIDI note numbers as universal format (compatible with all modules)
- Instrument-specific rendering logic (each module interprets MIDI its own way)

**Existing Pattern Reference:**
- Broadcast pattern similar to Story 7.7 (state sync)
- Per-user color coding similar to Story 7.3 (participant list)
- Module integration similar to Epic 4 GlobalMusicContext

**Key Constraints:**
- Supabase Broadcast latency: 50-150ms (acceptable for visual sync, not audio)
- Message size limit: Keep note events <1KB each
- Message rate: 100 messages/second per channel (throttle to 20 notes/second)
- Audio playback uses WebRTC (Story 7.5), not Broadcast

**MIDI Note Standard:**
- Middle C (C4) = MIDI note 60
- Range: 0-127 (covers 10+ octaves)
- Guitar range: E2 (40) to E6 (88)
- Piano range: A0 (21) to C8 (108)

---

## Definition of Done

- [ ] BroadcastNoteEvent interface defined and documented
- [ ] SupabaseSessionService extended with note broadcast methods
- [ ] Piano Roll integrated (broadcast on note click)
- [ ] Guitar Fretboard integrated (broadcast on fret press)
- [ ] Piano module integrated (broadcast on key press)
- [ ] Isometric Sequencer integrated (broadcast on pad trigger)
- [ ] Remote note reception and display working on all modules
- [ ] Per-user color coding implemented
- [ ] Note event throttling prevents message spam
- [ ] External MIDI input broadcasting working (optional)
- [ ] Toggle controls for remote note display/audio
- [ ] Latency <200ms verified (manual testing)
- [ ] Manual testing completed (see Testing Strategy)

---

## Testing Strategy

### Manual Testing (Per CLAUDE.md Guidelines)

**Test 1: Piano Roll → Guitar Fretboard Sync**
1. Two users in same session (Alice, Bob)
2. Alice has Piano Roll open, Bob has Guitar Fretboard open
3. Alice clicks notes on Piano Roll (C4, E4, G4)
4. Verify on Bob's Guitar Fretboard:
   - ✅ Notes appear highlighted on correct frets within 200ms
   - ✅ Notes use Alice's user color
   - ✅ Highlights fade out after 1 second
   - ✅ Optional: Audio plays for received notes

**Test 2: Guitar → Piano Sync**
1. Reverse Test 1
2. Bob presses frets on Guitar Fretboard
3. Verify on Alice's Piano Roll:
   - ✅ Notes appear as highlighted cells
   - ✅ Notes use Bob's user color
   - ✅ Correct MIDI notes displayed

**Test 3: Three-User Multi-Instrument Jam**
1. Three users: Alice (Piano Roll), Bob (Guitar), Charlie (Piano)
2. All three play notes simultaneously
3. Verify on each user's device:
   - ✅ Each user sees notes from the other two
   - ✅ Color coding distinguishes between users
   - ✅ Own notes appear instantly (local)
   - ✅ Remote notes appear within 200ms
   - ✅ No visual glitches or overlapping highlights

**Test 4: Rapid Note Entry (Throttling)**
1. Alice rapidly clicks 50 notes on Piano Roll (over 2 seconds)
2. Monitor network tab in DevTools
3. Verify:
   - ✅ <40 broadcast messages sent (throttling works)
   - ✅ Bob still receives all notes (no data loss)
   - ✅ No message spam

**Test 5: External MIDI Input**
1. Alice connects MIDI keyboard
2. Plays notes on physical keyboard
3. Verify on Bob's device:
   - ✅ Notes appear on Bob's active module
   - ✅ MIDI velocity preserved (visual intensity)
   - ✅ Latency <200ms

**Test 6: Toggle Remote Note Display**
1. Bob toggles "Show Remote Notes" off
2. Alice plays notes
3. Verify on Bob's device:
   - ✅ Remote notes do NOT appear
   - ✅ Alice still hears Bob's audio (WebRTC)
4. Bob toggles back on:
   - ✅ Remote notes appear again

**Test 7: Pattern Sharing (Optional)**
1. Alice creates 8-note pattern on Piano Roll
2. Clicks "Share Pattern" button
3. Verify on Bob's device:
   - ✅ Notification: "Alice shared a pattern"
   - ✅ Pattern loads on Bob's Piano Roll
   - ✅ All notes and timing preserved

### Verification Checklist

- ✅ Notes broadcast from Piano Roll to Guitar Fretboard
- ✅ Notes broadcast from Guitar to Piano Roll
- ✅ Notes broadcast from all interactive modules
- ✅ Remote notes appear within 200ms
- ✅ Per-user color coding works
- ✅ Throttling prevents message spam
- ✅ Toggle controls work correctly
- ✅ External MIDI input broadcasts correctly
- ✅ No visual glitches or performance issues
- ✅ Works with 2-4 users simultaneously

---

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** Broadcast latency makes notes feel delayed
**Mitigation:**
- Supabase Broadcast latency (50-150ms) acceptable for visual sync
- Audio already handled by WebRTC (Story 7.5) with <50ms latency
- Show smooth fade-in animation to mask latency
- Display latency indicator if >200ms detected

**Secondary Risk:** Message spam from rapid note entry
**Mitigation:**
- Throttle broadcast to max 20 notes/second
- Batch chord events (multiple notes at same timestamp)
- Monitor Supabase dashboard for message rate

**Tertiary Risk:** Module-specific note rendering complexity
**Mitigation:**
- Use MIDI note numbers as universal format
- Each module has own rendering logic (Guitar knows fret positions, Piano knows key positions)
- Fallback: If module can't render note, log warning but don't crash

### Compatibility Verification

- [x] **No breaking changes** - Additive feature (new broadcast events)
- [x] **Database changes** - None
- [x] **UI changes** - Additive (remote note highlights, toggle controls)
- [x] **Performance impact** - Low (visual highlights only, no audio processing)

---

## Scope Validation

- [x] Story can be completed in **6-10 hours** (one focused session)
- [x] Integration approach is straightforward (extend Broadcast service)
- [x] Follows existing patterns (Broadcast events, module hooks)
- [x] Clear acceptance criteria for each module

---

## Deliverables

1. **BroadcastNoteEvent Interface**
   - `src/types/broadcastNoteEvent.ts` (~40 lines)
   - Universal note event format

2. **Updated SupabaseSessionService**
   - `src/services/supabaseSession.ts` (modified, ~60 lines added)
   - Note broadcast methods and callbacks

3. **Updated Piano Roll Component**
   - `src/components/PianoRoll/PianoRoll.tsx` (modified, ~80 lines added)
   - Broadcast on note click, receive and display remote notes

4. **Updated Guitar Fretboard Component**
   - `src/components/GuitarFretboard/GuitarFretboard.tsx` (modified, ~80 lines added)
   - Broadcast on fret press, receive and display remote notes

5. **Updated Piano Component**
   - `src/components/Piano/Piano.tsx` (modified, ~60 lines added)
   - Broadcast on key press, receive and display remote notes

6. **Updated Isometric Sequencer Component**
   - `src/components/IsometricSequencer/IsometricSequencer.tsx` (modified, ~60 lines added)
   - Broadcast on pad trigger, receive and display remote notes

7. **Remote Note Highlight Component**
   - `src/components/JamSession/RemoteNoteHighlight.tsx` (~50 lines)
   - Reusable component for highlighting remote notes

8. **Note Sync Settings Panel**
   - `src/components/JamSession/NoteSyncSettings.tsx` (~80 lines)
   - Toggle controls for remote note display/audio

9. **MIDI-to-Note Utility**
   - `src/utils/midiToNote.ts` (~100 lines)
   - Convert between MIDI numbers and note names

---

## Next Steps After Story 7.10

Once this story is complete:
- **Epic 7 Phase 1 is COMPLETE! 🎉**
- Users can jam with real-time audio, LED sync, and shared note/chord visibility
- Proceed to user testing and feedback
- Plan Epic 7 Phase 2 (advanced features):
  - Recording/playback of jam sessions
  - Pattern library sharing
  - Multi-room session support
  - Mobile app (native iOS/Android)

---

## References

- **Epic 7:** `docs/epics/epic-7-jam-session-backend.md`
- **Story 7.2:** `docs/stories/7.2-supabase-realtime-service.md`
- **Story 7.3:** `docs/stories/7.3-jam-session-ui-integration.md`
- **Story 7.5:** `docs/stories/7.5-webrtc-p2p-audio.md` (audio handled separately)
- **MIDI Standard:** https://www.midi.org/specifications
- **Supabase Broadcast:** https://supabase.com/docs/guides/realtime/broadcast

---

**Story Created:** 2025-10-13
**Story Owner:** Product Manager (John)
**Estimated Completion:** 6-10 hours after start
