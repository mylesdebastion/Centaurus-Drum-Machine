# Story 9.2: Piano Roll Visualizer with LED Strip Output

**Epic:** Multi-Instrument MIDI Visualization (Epic 9)
**Status:** üìù **PLANNING** - Blocked by Story 9.1
**Priority:** High
**Complexity:** Medium
**Prerequisites:**
- ‚úÖ Story 9.1 (Web MIDI Input Engine) - Must be complete

---

## Story

**As a** pianist with a MIDI keyboard,
**I want** to see an interactive 88-key piano visualization that highlights the notes I play,
**so that** I can visualize my performance with color-coded notes and control a physical LED strip mounted on my piano.

---

## Background / Context

### Python Reference Implementation
`research/wled-piano-roll-pygame.py` demonstrates:
- 88-key piano keyboard (A0-C8, MIDI 21-108)
- 4 octaves visible on screen
- MIDI device selection (press 'M' to cycle devices)
- Real-time MIDI note highlighting
- Chromatic and Harmonic color modes
- Click-to-play keys (for testing without MIDI)
- WLED UDP output to 144-LED strip

### Current State
- ‚úÖ **MIDI input working** (Story 9.1) - midiInputManager ready
- ‚úÖ **Color mappings ready** - colorMapping.ts has chromatic/harmonic modes
- ‚úÖ **WLED integration ready** - WLEDDeviceManager supports strips
- ‚úÖ **Audio playback ready** - Tone.js PolySynth available
- ‚ùå **No piano keyboard UI** - Need canvas-based piano component

---

## Acceptance Criteria

### AC 1: 88-Key Piano Keyboard Canvas ‚úÖ
- [ ] Render 88 piano keys (A0-C8, MIDI notes 21-108)
- [ ] White keys: C, D, E, F, G, A, B (52 total)
- [ ] Black keys: C#, D#, F#, G#, A# (36 total)
- [ ] Responsive canvas sizing (scales to parent container)
- [ ] Key labels show note names (C4, A4, etc.)
- [ ] 4 octaves visible by default (C3-B6)
- [ ] Scrollable to show all 88 keys (mobile swipe, desktop scroll)
- [ ] 60fps canvas rendering

### AC 2: MIDI Input Highlighting ‚úÖ
- [ ] Connect to MIDI device via midiInputManager (Story 9.1)
- [ ] Highlight keys when MIDI Note On received
- [ ] Dim keys when MIDI Note Off received
- [ ] Active keys show full brightness color
- [ ] Inactive keys show dimmed color (10% brightness)
- [ ] Multiple simultaneous notes supported (polyphony)
- [ ] Visual feedback latency <20ms (MIDI ‚Üí highlight)

### AC 3: Color Modes (Chromatic & Harmonic) ‚úÖ
- [ ] Chromatic mode: 12-color spectrum (C=red, C#=orange, etc.)
- [ ] Harmonic mode: Circle of fifths color mapping
- [ ] Toggle button to switch color modes (keyboard shortcut 'C')
- [ ] Colors match colorMapping.ts implementation
- [ ] Colors consistent with Python reference
- [ ] Color mode persists across sessions (localStorage)

### AC 4: Click-to-Play Keys ‚úÖ
- [ ] Click white key ‚Üí play note via Tone.js PolySynth
- [ ] Click black key ‚Üí play note via Tone.js PolySynth
- [ ] Touch support for mobile (44px minimum touch targets)
- [ ] Visual feedback: key highlights for 500ms
- [ ] Audio feedback: piano-like sound
- [ ] Works when no MIDI device connected (testing mode)

### AC 5: WLED LED Strip Output ‚úÖ
- [ ] Integrate WLEDDeviceManager for strip configuration
- [ ] Support 144-LED strip (88 keys + spacing)
- [ ] LED mapping: `LED[i] = MIDI note - 21` (A0 = LED 0)
- [ ] Real-time LED updates when notes played
- [ ] Color modes apply to both canvas and LEDs
- [ ] Multiple LED strips supported (different pianos)
- [ ] WLED device settings in collapsible panel

### AC 6: MIDIDeviceSelector Integration ‚úÖ
- [ ] Embed MIDIDeviceSelector component (Story 9.1)
- [ ] Show in collapsible settings panel
- [ ] Device selection updates piano highlighting
- [ ] Keyboard fallback mode works with piano
- [ ] Last MIDI message displayed for debugging

### AC 7: Responsive Mobile UX ‚úÖ
- [ ] Desktop: Full piano keyboard + settings sidebar
- [ ] Mobile: Full-width piano with collapsible settings
- [ ] Landscape mode recommended (show hint)
- [ ] Touch gestures: Swipe to scroll octaves
- [ ] Pinch-to-zoom (optional enhancement)
- [ ] 44px minimum touch targets on keys
- [ ] Follows Story 5.1 responsive patterns

### AC 8: Welcome Screen Integration ‚úÖ
- [ ] Add "Piano Roll" card to Welcome screen Experiments
- [ ] Route: `/piano`
- [ ] Icon: Piano icon from Lucide React
- [ ] Badge: "Beta" (amber colors)
- [ ] Description mentions MIDI input and LED strip
- [ ] Placement: After DJ Visualizer, before Guitar Fretboard

---

## Technical Specifications

### Piano Keyboard Constants

```typescript
// src/components/PianoRoll/constants.ts

export const PIANO_CONSTANTS = {
  TOTAL_KEYS: 88,
  FIRST_MIDI_NOTE: 21,  // A0
  LAST_MIDI_NOTE: 108,  // C8
  WHITE_KEYS_PER_OCTAVE: 7,
  BLACK_KEYS_PER_OCTAVE: 5,
  OCTAVES: 7.25,  // 88 keys / 12 ‚âà 7.25 octaves
  DEFAULT_VISIBLE_OCTAVES: 4,  // Show C3-B6 by default
  DEFAULT_START_OCTAVE: 3  // Start at C3
};

export const WHITE_KEY_PATTERN = [0, 2, 4, 5, 7, 9, 11];  // C D E F G A B
export const BLACK_KEY_PATTERN = [1, 3, 6, 8, 10];        // C# D# F# G# A#

export const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

/**
 * Get note name from MIDI note number
 */
export function getMIDINoteName(midiNote: number): string {
  const noteClass = (midiNote - 12) % 12;  // Adjust for A0 = MIDI 21
  const octave = Math.floor((midiNote - 12) / 12);
  return `${NOTE_NAMES[noteClass]}${octave}`;
}

/**
 * Check if MIDI note is a white key
 */
export function isWhiteKey(midiNote: number): boolean {
  const noteClass = (midiNote - 12) % 12;
  return WHITE_KEY_PATTERN.includes(noteClass);
}

/**
 * Get all white key MIDI notes
 */
export function getWhiteKeys(): number[] {
  const whiteKeys: number[] = [];
  for (let note = PIANO_CONSTANTS.FIRST_MIDI_NOTE; note <= PIANO_CONSTANTS.LAST_MIDI_NOTE; note++) {
    if (isWhiteKey(note)) {
      whiteKeys.push(note);
    }
  }
  return whiteKeys;
}

/**
 * Get all black key MIDI notes
 */
export function getBlackKeys(): number[] {
  const blackKeys: number[] = [];
  for (let note = PIANO_CONSTANTS.FIRST_MIDI_NOTE; note <= PIANO_CONSTANTS.LAST_MIDI_NOTE; note++) {
    if (!isWhiteKey(note)) {
      blackKeys.push(note);
    }
  }
  return blackKeys;
}
```

---

### Piano Canvas Rendering

```typescript
// src/components/PianoRoll/PianoCanvas.tsx

import React, { useRef, useEffect, useState } from 'react';
import { getNoteColor, ColorMode } from '../../utils/colorMapping';
import { PIANO_CONSTANTS, getWhiteKeys, getBlackKeys, isWhiteKey, getMIDINoteName } from './constants';

interface PianoCanvasProps {
  activeNotes: Set<number>;  // Active MIDI notes
  colorMode: ColorMode;
  onKeyClick: (midiNote: number) => void;
  visibleStartNote?: number;  // First visible MIDI note
  visibleEndNote?: number;    // Last visible MIDI note
}

export const PianoCanvas: React.FC<PianoCanvasProps> = ({
  activeNotes,
  colorMode,
  onKeyClick,
  visibleStartNote = 48,  // C3
  visibleEndNote = 95     // B6 (4 octaves)
}) => {
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const [canvasSize, setCanvasSize] = useState({ width: 1200, height: 400 });

  // Responsive canvas sizing
  useEffect(() => {
    const updateSize = () => {
      const canvas = canvasRef.current;
      if (!canvas || !canvas.parentElement) return;

      const width = canvas.parentElement.clientWidth;
      const height = Math.min(400, window.innerHeight * 0.5);
      setCanvasSize({ width, height });
    };

    updateSize();
    window.addEventListener('resize', updateSize);
    return () => window.removeEventListener('resize', updateSize);
  }, []);

  // Render piano keyboard
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    const { width, height } = canvasSize;
    canvas.width = width;
    canvas.height = height;

    // Clear canvas
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, width, height);

    // Get visible keys
    const visibleWhiteKeys = getWhiteKeys().filter(
      note => note >= visibleStartNote && note <= visibleEndNote
    );
    const visibleBlackKeys = getBlackKeys().filter(
      note => note >= visibleStartNote && note <= visibleEndNote
    );

    const whiteKeyWidth = width / visibleWhiteKeys.length;
    const whiteKeyHeight = height * 0.8;
    const blackKeyWidth = whiteKeyWidth * 0.6;
    const blackKeyHeight = whiteKeyHeight * 0.6;

    // Draw white keys
    visibleWhiteKeys.forEach((midiNote, index) => {
      const x = index * whiteKeyWidth;
      const noteClass = (midiNote - 12) % 12;
      const isActive = activeNotes.has(midiNote);

      // Get color from colorMapping
      const color = getNoteColor(noteClass, colorMode);
      const brightness = isActive ? 1.0 : 0.1;

      ctx.fillStyle = `rgb(${color.r * brightness}, ${color.g * brightness}, ${color.b * brightness})`;
      ctx.fillRect(x, height - whiteKeyHeight, whiteKeyWidth, whiteKeyHeight);

      // Border
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 2;
      ctx.strokeRect(x, height - whiteKeyHeight, whiteKeyWidth, whiteKeyHeight);

      // Note label (show only C notes for clarity)
      if (noteClass === 0) {  // C note
        ctx.fillStyle = isActive ? '#fff' : '#888';
        ctx.font = '12px Inter';
        ctx.textAlign = 'center';
        ctx.fillText(getMIDINoteName(midiNote), x + whiteKeyWidth / 2, height - 20);
      }
    });

    // Draw black keys (on top of white keys)
    let whiteKeyIndex = 0;
    visibleWhiteKeys.forEach((whiteNote) => {
      const nextWhiteNote = whiteNote + 2;
      if (visibleBlackKeys.includes(whiteNote + 1)) {
        const blackNote = whiteNote + 1;
        const noteClass = (blackNote - 12) % 12;
        const isActive = activeNotes.has(blackNote);

        const x = (whiteKeyIndex + 0.7) * whiteKeyWidth;
        const color = getNoteColor(noteClass, colorMode);
        const brightness = isActive ? 1.5 : 0.3;

        ctx.fillStyle = `rgb(${Math.min(color.r * brightness, 255)}, ${Math.min(color.g * brightness, 255)}, ${Math.min(color.b * brightness, 255)})`;
        ctx.fillRect(x, height - whiteKeyHeight, blackKeyWidth, blackKeyHeight);

        // Border
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.strokeRect(x, height - whiteKeyHeight, blackKeyWidth, blackKeyHeight);
      }
      whiteKeyIndex++;
    });

  }, [activeNotes, colorMode, canvasSize, visibleStartNote, visibleEndNote]);

  // Handle key clicks
  const handleCanvasClick = (e: React.MouseEvent<HTMLCanvasElement>) => {
    const canvas = canvasRef.current;
    if (!canvas) return;

    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    const { width, height } = canvasSize;
    const visibleWhiteKeys = getWhiteKeys().filter(
      note => note >= visibleStartNote && note <= visibleEndNote
    );

    const whiteKeyWidth = width / visibleWhiteKeys.length;
    const whiteKeyHeight = height * 0.8;
    const blackKeyWidth = whiteKeyWidth * 0.6;
    const blackKeyHeight = whiteKeyHeight * 0.6;

    // Check black keys first (they're on top)
    const visibleBlackKeys = getBlackKeys().filter(
      note => note >= visibleStartNote && note <= visibleEndNote
    );

    let whiteKeyIndex = 0;
    for (const whiteNote of visibleWhiteKeys) {
      if (visibleBlackKeys.includes(whiteNote + 1)) {
        const blackX = (whiteKeyIndex + 0.7) * whiteKeyWidth;
        if (
          x >= blackX &&
          x <= blackX + blackKeyWidth &&
          y >= height - whiteKeyHeight &&
          y <= height - whiteKeyHeight + blackKeyHeight
        ) {
          onKeyClick(whiteNote + 1);
          return;
        }
      }
      whiteKeyIndex++;
    }

    // Check white keys
    const clickedKeyIndex = Math.floor(x / whiteKeyWidth);
    if (
      clickedKeyIndex >= 0 &&
      clickedKeyIndex < visibleWhiteKeys.length &&
      y >= height - whiteKeyHeight
    ) {
      onKeyClick(visibleWhiteKeys[clickedKeyIndex]);
    }
  };

  return (
    <canvas
      ref={canvasRef}
      width={canvasSize.width}
      height={canvasSize.height}
      onClick={handleCanvasClick}
      className="w-full cursor-pointer touch-none"
      style={{ touchAction: 'none' }}
    />
  );
};
```

---

### Piano Roll Main Component

```typescript
// src/components/PianoRoll/PianoRoll.tsx

import React, { useState, useEffect, useCallback } from 'react';
import * as Tone from 'tone';
import { Piano, Settings } from 'lucide-react';
import { PianoCanvas } from './PianoCanvas';
import { MIDIDeviceSelector } from '../MIDI/MIDIDeviceSelector';
import { WLEDDeviceManager } from '../WLED/WLEDDeviceManager';
import { CollapsiblePanel } from '../Layout/CollapsiblePanel';
import { useResponsive } from '../../hooks/useResponsive';
import { midiInputManager, MIDINoteMessage } from '../../utils/midiInputManager';
import { ColorMode, getNoteColor } from '../../utils/colorMapping';
import { PIANO_CONSTANTS } from './constants';

export const PianoRoll: React.FC = () => {
  const { isMobile } = useResponsive();
  const [activeNotes, setActiveNotes] = useState<Set<number>>(new Set());
  const [colorMode, setColorMode] = useState<ColorMode>('chromatic');
  const [pianoSynth, setPianoSynth] = useState<Tone.PolySynth | null>(null);
  const [visibleStartNote, setVisibleStartNote] = useState(48);  // C3
  const [visibleEndNote, setVisibleEndNote] = useState(95);      // B6

  // Initialize Tone.js piano synth
  useEffect(() => {
    const synth = new Tone.PolySynth(Tone.Synth, {
      oscillator: { type: 'triangle' },
      envelope: {
        attack: 0.005,
        decay: 0.3,
        sustain: 0.2,
        release: 1.0
      },
      volume: -6
    }).toDestination();

    setPianoSynth(synth);

    return () => {
      synth.dispose();
    };
  }, []);

  // Listen for MIDI input
  useEffect(() => {
    const handleMIDI = (message: MIDINoteMessage) => {
      setActiveNotes(prev => {
        const next = new Set(prev);
        if (message.type === 'noteOn') {
          next.add(message.note);

          // Play note via Tone.js
          if (pianoSynth) {
            const freq = Tone.Frequency(message.note, 'midi').toFrequency();
            pianoSynth.triggerAttack(freq, undefined, message.velocity / 127);
          }
        } else {
          next.delete(message.note);

          // Release note
          if (pianoSynth) {
            const freq = Tone.Frequency(message.note, 'midi').toFrequency();
            pianoSynth.triggerRelease(freq);
          }
        }
        return next;
      });
    };

    midiInputManager.addListener(handleMIDI);
    return () => midiInputManager.removeListener(handleMIDI);
  }, [pianoSynth]);

  // Handle click-to-play
  const handleKeyClick = useCallback((midiNote: number) => {
    if (!pianoSynth) return;

    const freq = Tone.Frequency(midiNote, 'midi').toFrequency();
    pianoSynth.triggerAttackRelease(freq, '500ms');

    // Visual feedback
    setActiveNotes(prev => new Set(prev).add(midiNote));
    setTimeout(() => {
      setActiveNotes(prev => {
        const next = new Set(prev);
        next.delete(midiNote);
        return next;
      });
    }, 500);
  }, [pianoSynth]);

  // Toggle color mode (keyboard shortcut)
  useEffect(() => {
    const handleKeyPress = (e: KeyboardEvent) => {
      if (e.key === 'c' || e.key === 'C') {
        setColorMode(prev => prev === 'chromatic' ? 'harmonic' : 'chromatic');
      }
    };

    window.addEventListener('keydown', handleKeyPress);
    return () => window.removeEventListener('keydown', handleKeyPress);
  }, []);

  // Generate LED strip data
  const generateLEDData = useCallback(() => {
    const ledData: { r: number; g: number; b: number }[] = [];

    for (let i = 0; i < 144; i++) {
      const midiNote = i + 21;  // A0 = LED 0
      if (midiNote <= 108) {
        const noteClass = (midiNote - 12) % 12;
        const isActive = activeNotes.has(midiNote);
        const color = getNoteColor(noteClass, colorMode);
        const brightness = isActive ? 1.0 : 0.1;

        ledData.push({
          r: Math.round(color.r * brightness),
          g: Math.round(color.g * brightness),
          b: Math.round(color.b * brightness)
        });
      } else {
        ledData.push({ r: 0, g: 0, b: 0 });
      }
    }

    return ledData;
  }, [activeNotes, colorMode]);

  return (
    <div className="min-h-screen bg-gray-900 text-white">
      {/* Header */}
      <div className="bg-gray-800 border-b border-gray-700 p-4">
        <div className="max-w-7xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-3">
            <Piano className="w-6 h-6 text-primary-500" />
            <h1 className="text-xl font-bold">Piano Roll</h1>
            <span className="px-2 py-1 bg-amber-500/20 text-amber-400 text-xs font-medium rounded">
              Beta
            </span>
          </div>
          <button
            onClick={() => setColorMode(prev => prev === 'chromatic' ? 'harmonic' : 'chromatic')}
            className="btn-secondary flex items-center gap-2 min-h-[44px]"
          >
            <Settings className="w-4 h-4" />
            {colorMode === 'chromatic' ? 'Chromatic' : 'Harmonic'}
          </button>
        </div>
      </div>

      {/* Main Content */}
      <div className="max-w-7xl mx-auto p-4">
        <div className={`grid gap-4 ${isMobile ? 'grid-cols-1' : 'grid-cols-3'}`}>
          {/* Piano Canvas */}
          <div className={isMobile ? 'col-span-1' : 'col-span-2'}>
            <div className="bg-gray-800 rounded-lg border border-gray-700 p-4">
              <PianoCanvas
                activeNotes={activeNotes}
                colorMode={colorMode}
                onKeyClick={handleKeyClick}
                visibleStartNote={visibleStartNote}
                visibleEndNote={visibleEndNote}
              />
              <p className="text-sm text-gray-400 mt-2 text-center">
                Click keys to play notes | Press 'C' to toggle color mode
              </p>
            </div>
          </div>

          {/* Settings Panel */}
          <div className="space-y-4">
            {/* MIDI Device Selector */}
            <CollapsiblePanel title="MIDI Input" defaultOpen={true}>
              <MIDIDeviceSelector />
            </CollapsiblePanel>

            {/* WLED LED Strip */}
            <CollapsiblePanel title="WLED LED Strip" defaultOpen={false}>
              <WLEDDeviceManager
                ledData={generateLEDData()}
                layout={isMobile ? 'mobile' : 'desktop'}
                storageKey="wled-piano"
                deviceType="strip"
              />
            </CollapsiblePanel>

            {/* Info */}
            <div className="p-4 bg-gray-800 rounded-lg border border-gray-700">
              <h3 className="text-sm font-medium text-gray-300 mb-2">Info</h3>
              <div className="text-xs text-gray-400 space-y-1">
                <div>Active Notes: {activeNotes.size}</div>
                <div>Color Mode: {colorMode}</div>
                <div>Visible Range: {visibleStartNote}-{visibleEndNote}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};
```

---

### WLED LED Strip Mapping

```typescript
// LED strip mapping for piano (144 LEDs)
// Physical layout: Linear strip along piano keyboard

export function generatePianoLEDData(
  activeNotes: Set<number>,
  colorMode: ColorMode
): { r: number; g: number; b: number }[] {
  const ledData: { r: number; g: number; b: number }[] = [];

  for (let ledIndex = 0; ledIndex < 144; ledIndex++) {
    const midiNote = ledIndex + 21;  // A0 (MIDI 21) = LED 0

    if (midiNote <= 108) {  // Up to C8 (MIDI 108)
      const noteClass = (midiNote - 12) % 12;
      const isActive = activeNotes.has(midiNote);
      const color = getNoteColor(noteClass, colorMode);
      const brightness = isActive ? 1.0 : 0.1;

      ledData.push({
        r: Math.round(color.r * brightness),
        g: Math.round(color.g * brightness),
        b: Math.round(color.b * brightness)
      });
    } else {
      // LEDs beyond piano range: off
      ledData.push({ r: 0, g: 0, b: 0 });
    }
  }

  return ledData;
}
```

---

## File Structure

```
src/components/PianoRoll/
‚îú‚îÄ‚îÄ PianoRoll.tsx              // Main component (~250 lines)
‚îú‚îÄ‚îÄ PianoCanvas.tsx            // Canvas rendering (~200 lines)
‚îú‚îÄ‚îÄ constants.ts               // Piano constants and helpers (~100 lines)
‚îî‚îÄ‚îÄ index.ts                   // Barrel export

Total NEW code: ~550 lines
REUSED: MIDIDeviceSelector, WLEDDeviceManager, colorMapping.ts, Tone.js
```

---

## Tasks / Subtasks

### Phase 1: Core Piano Components (AC 1, 2, 3)

- [ ] **Task 1.1: Create piano constants**
  - [ ] Create `constants.ts` with PIANO_CONSTANTS
  - [ ] Implement helper functions (getMIDINoteName, isWhiteKey, etc.)
  - [ ] Add TypeScript interfaces

- [ ] **Task 1.2: Create PianoCanvas component**
  - [ ] Setup canvas with useRef and responsive sizing
  - [ ] Implement white key rendering
  - [ ] Implement black key rendering
  - [ ] Add note labels (C notes)
  - [ ] Implement color modes (reuse colorMapping.ts)
  - [ ] Add click handlers for key interaction

- [ ] **Task 1.3: Create PianoRoll main component**
  - [ ] Setup state (activeNotes, colorMode, etc.)
  - [ ] Initialize Tone.js PolySynth
  - [ ] Integrate MIDIInputManager listener
  - [ ] Implement click-to-play functionality
  - [ ] Add keyboard shortcut ('C' for color toggle)

---

### Phase 2: WLED & MIDI Integration (AC 4, 5, 6)

- [ ] **Task 2.1: Implement LED strip data generation**
  - [ ] Create `generatePianoLEDData()` function
  - [ ] Map MIDI notes to LED indices
  - [ ] Apply color modes to LED data
  - [ ] Test with WLED virtual preview

- [ ] **Task 2.2: Integrate WLEDDeviceManager**
  - [ ] Add WLEDDeviceManager to settings panel
  - [ ] Configure for strip (linear, 144 LEDs)
  - [ ] Pass LED data on every activeNotes change
  - [ ] Test with physical WLED strip

- [ ] **Task 2.3: Integrate MIDIDeviceSelector**
  - [ ] Add MIDIDeviceSelector to settings panel
  - [ ] Wrap in CollapsiblePanel
  - [ ] Verify MIDI input works with piano

---

### Phase 3: Responsive UI & Welcome Integration (AC 7, 8)

- [ ] **Task 3.1: Implement responsive layout**
  - [ ] Desktop: Piano canvas + settings sidebar
  - [ ] Mobile: Full-width canvas + collapsible settings
  - [ ] Add landscape mode hint for mobile
  - [ ] Test on iOS Safari and Android Chrome

- [ ] **Task 3.2: Add to Welcome screen**
  - [ ] Create `/piano` route in App.tsx
  - [ ] Add Piano Roll card to WelcomeScreen
  - [ ] Use Piano icon from Lucide React
  - [ ] Add Beta badge
  - [ ] Position after DJ Visualizer

---

### Phase 4: Testing & Polish

- [ ] **Task 4.1: Test with real MIDI keyboard**
  - [ ] Test note on/off responsiveness
  - [ ] Test polyphony (multiple notes)
  - [ ] Test all 88 keys (A0-C8)
  - [ ] Test color mode toggle

- [ ] **Task 4.2: Test LED strip output**
  - [ ] Test with physical 144-LED strip
  - [ ] Verify LED mapping (A0 = LED 0)
  - [ ] Test color modes on LEDs
  - [ ] Test brightness (active vs inactive)

- [ ] **Task 4.3: Performance testing**
  - [ ] Canvas renders at 60fps
  - [ ] MIDI latency <20ms
  - [ ] LED updates smooth at 30fps
  - [ ] No memory leaks during long sessions

---

## Success Metrics

- [ ] All 88 keys playable via MIDI and click
- [ ] MIDI ‚Üí visual latency <20ms
- [ ] 60fps canvas rendering (desktop)
- [ ] 30fps canvas rendering acceptable (mobile)
- [ ] LED strip updates at 30 FPS
- [ ] Color modes match Python reference
- [ ] Works on iOS Safari and Android Chrome
- [ ] Zero code duplication (reuses MIDI, WLED, color components)

---

## Component Reuse Summary

**‚úÖ REUSING:**
- MIDIInputManager (Story 9.1) - MIDI device management
- MIDIDeviceSelector (Story 9.1) - MIDI UI component
- WLEDDeviceManager - LED strip output
- colorMapping.ts - Chromatic/Harmonic colors
- Tone.js - Audio playback
- CollapsiblePanel - Settings panel UI
- useResponsive - Mobile/desktop breakpoints

**üìù NEW:**
- PianoRoll.tsx - Main piano component
- PianoCanvas.tsx - Canvas rendering
- constants.ts - Piano-specific helpers

---

## Design System Compliance

- [ ] Uses Tailwind CSS classes
- [ ] Uses Lucide React icons (Piano, Settings)
- [ ] Follows color tokens (primary-500, gray-700, etc.)
- [ ] Border radius: `rounded-lg`
- [ ] Touch targets: `min-h-[44px]`
- [ ] Responsive: Mobile-first
- [ ] Accessibility: ARIA labels, keyboard nav

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-10 | 1.0 | Initial story creation - Piano Roll Visualizer | Claude Code |

---

## Next Steps

1. Complete Story 9.1 (Web MIDI Input Engine)
2. Begin Phase 1: Core Piano Components
3. Test with real MIDI keyboard
4. Proceed to Story 9.3: Guitar Fretboard Visualizer
