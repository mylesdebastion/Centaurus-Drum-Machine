# Story 4.5: Visualization Color Mapping System

## Status
Draft

## Story
**As a** music educator,
**I want** consistent color mapping across all visualizers (chromatic/harmonic modes),
**so that** students see consistent visual associations.

## Acceptance Criteria
1. Update `src/utils/colorMapping.ts` with two modes:
   - **Chromatic mode**: C=Red, C#=Orange, D=Yellow, etc. (boomwhacker standard)
   - **Harmonic mode**: Tonic=Blue, Subdominant=Green, Dominant=Purple, etc.
2. Create `getColorForNote(note, mode, currentKey)` utility function
3. Integrate with existing visualizers:
   - `PianoRoll` - update note coloring logic
   - `GuitarFretboard` - update fret coloring logic
   - `IsometricSequencer` - update 3D note coloring
4. Add color mode toggle in global header
5. Update color mode in GlobalMusicContext
6. Add smooth color transitions when switching modes (200ms fade)

## Integration Verification
- **IV1**: Switching color mode updates all active visualizers instantly
- **IV2**: Color mode persists across page refresh
- **IV3**: Existing visualizers maintain backward compatibility

## Tasks / Subtasks

- [ ] **Task 1: Define Color Mapping System** (AC: 1)
  - [ ] Update `src/utils/colorMapping.ts`
  - [ ] Define chromatic color palette (boomwhacker standard)
    - [ ] C: #ff4444 (Red)
    - [ ] C#/Db: #ff8844 (Orange-Red)
    - [ ] D: #ffaa44 (Orange)
    - [ ] D#/Eb: #ffdd44 (Yellow-Orange)
    - [ ] E: #ffff44 (Yellow)
    - [ ] F: #aaff44 (Yellow-Green)
    - [ ] F#/Gb: #44ff44 (Green)
    - [ ] G: #44ffaa (Green-Cyan)
    - [ ] G#/Ab: #44ffff (Cyan)
    - [ ] A: #44aaff (Blue-Cyan)
    - [ ] A#/Bb: #4444ff (Blue)
    - [ ] B: #aa44ff (Purple)
  - [ ] Define harmonic color palette (scale degree-based)
    - [ ] Tonic (1): #4444ff (Blue)
    - [ ] Supertonic (2): #44aaff (Light Blue)
    - [ ] Mediant (3): #44ffaa (Cyan-Green)
    - [ ] Subdominant (4): #44ff44 (Green)
    - [ ] Dominant (5): #aa44ff (Purple)
    - [ ] Submediant (6): #ffaa44 (Orange)
    - [ ] Leading Tone (7): #ff4444 (Red)
    - [ ] Non-scale notes: #888888 (Gray)
  - [ ] Create TypeScript types for ColorMode

- [ ] **Task 2: Implement getColorForNote Utility** (AC: 2)
  - [ ] Create `getColorForNote(note, mode, currentKey, currentScale)` function
  - [ ] For chromatic mode:
    - [ ] Convert MIDI note to pitch class (0-11)
    - [ ] Return chromatic color for pitch class
  - [ ] For harmonic mode:
    - [ ] Calculate scale degree from note, key, and scale
    - [ ] Return harmonic color for scale degree
    - [ ] Return gray for non-scale notes
  - [ ] Add brightness parameter for dimmed/highlighted notes
  - [ ] Add alpha/opacity parameter for transparency
  - [ ] Add HSL conversion utilities for brightness adjustments
  - [ ] Export function and types

- [ ] **Task 3: Integrate with PianoRoll** (AC: 3)
  - [ ] Update `src/components/PianoRoll/PianoCanvas.tsx`
  - [ ] Import `getColorForNote` utility
  - [ ] Replace hardcoded note colors with color mapping function
  - [ ] Use GlobalMusicContext to get current colorMode, key, scale
  - [ ] Update note rendering logic:
    - [ ] Active notes: full brightness (1.0)
    - [ ] In-scale notes: bright (0.65)
    - [ ] Out-of-scale notes: dim (0.2)
  - [ ] Add smooth color transition on mode change (CSS transition or lerp)
  - [ ] Test color changes in real-time

- [ ] **Task 4: Integrate with GuitarFretboard** (AC: 3)
  - [ ] Update `src/components/GuitarFretboard/FretboardCanvas.tsx`
  - [ ] Import `getColorForNote` utility
  - [ ] Replace hardcoded fret colors with color mapping function
  - [ ] Use GlobalMusicContext to get current colorMode, key, scale
  - [ ] Update fret marker rendering:
    - [ ] Triggered notes: full brightness (1.0)
    - [ ] In-scale notes: bright (0.65)
    - [ ] Out-of-scale notes: dim (0.2)
  - [ ] Add smooth color transition on mode change
  - [ ] Test with chord progressions

- [ ] **Task 5: Integrate with IsometricSequencer** (AC: 3)
  - [ ] Update `src/components/IsometricSequencer/IsometricSequencer.tsx`
  - [ ] Import `getColorForNote` utility
  - [ ] Replace hardcoded 3D note colors with color mapping function
  - [ ] Use GlobalMusicContext to get current colorMode, key, scale
  - [ ] Update 3D note rendering:
    - [ ] Active notes: full brightness + glow
    - [ ] In-scale notes: bright
    - [ ] Out-of-scale notes: dim
  - [ ] Add smooth color interpolation for 3D materials
  - [ ] Test during playback

- [ ] **Task 6: Add Color Mode Toggle to Header** (AC: 4)
  - [ ] Update `GlobalMusicHeader.tsx`
  - [ ] Add color mode toggle button
  - [ ] Chromatic mode icon: Palette or Rainbow (Lucide)
  - [ ] Harmonic mode icon: Music or CircleDot (Lucide)
  - [ ] Add tooltip explaining modes
  - [ ] Connect onClick to updateColorMode in GlobalMusicContext
  - [ ] Show active mode with visual indicator (highlighted button)
  - [ ] Responsive positioning in header

- [ ] **Task 7: Update GlobalMusicContext** (AC: 5)
  - [ ] Add `colorMode: 'chromatic' | 'harmonic'` to GlobalMusicState
  - [ ] Add `updateColorMode(mode)` action
  - [ ] Default to 'chromatic' mode
  - [ ] Persist colorMode to localStorage
  - [ ] Load colorMode on app mount
  - [ ] Emit event when colorMode changes (for visualizer updates)

- [ ] **Task 8: Implement Smooth Color Transitions** (AC: 6)
  - [ ] Add CSS transition for canvas-based visualizers
  - [ ] For PianoRoll: Add transition class to note elements
  - [ ] For GuitarFretboard: Lerp between colors over 200ms
  - [ ] For IsometricSequencer: Three.js material color lerp
  - [ ] Use requestAnimationFrame for smooth interpolation
  - [ ] Target 60fps during transition
  - [ ] Avoid jarring color changes during playback

- [ ] **Task 9: Testing** (IV: 1, 2, 3)
  - [ ] Test color mode toggle in header
  - [ ] Test color updates in all visualizers simultaneously
  - [ ] Test color persistence across page refresh
  - [ ] Test smooth transitions (no flickering)
  - [ ] Test with different keys and scales
  - [ ] Test performance with many notes rendering
  - [ ] Test backward compatibility (views without global context)
  - [ ] Visual regression tests (screenshot comparisons)

## Dev Notes

### Relevant Architecture Context

**Existing Color System**:
- `src/utils/colorMapping.ts` - Current color utilities
- Used by various visualizers for note coloring
- Already has chromatic mapping (needs refinement)
- No harmonic mode yet

**Existing Visualizers**:
- `src/components/PianoRoll/PianoCanvas.tsx` - 2D piano roll with notes
- `src/components/GuitarFretboard/FretboardCanvas.tsx` - Guitar fretboard with fret markers
- `src/components/IsometricSequencer/IsometricSequencer.tsx` - 3D note sequencer

**Musical Scale System**:
- `src/hooks/useMusicalScale.ts` - Provides scale calculation utilities
- `getCurrentScale()` - Returns array of scale notes (0-11)
- `isNoteInScale(noteClass)` - Checks if note in current scale

### Color Mapping Function Interface

```typescript
type ColorMode = 'chromatic' | 'harmonic';

interface ColorMappingOptions {
  mode: ColorMode;
  key: RootNote;           // C, C#, D, etc.
  scale: ScaleName;        // major, minor, etc.
  brightness?: number;     // 0-1, default 1
  alpha?: number;          // 0-1, default 1
}

function getColorForNote(
  note: number,            // MIDI note (0-127)
  options: ColorMappingOptions
): string {
  // Returns hex color string (e.g., "#ff4444")
}

// Example usage
const color = getColorForNote(60, {
  mode: 'chromatic',
  key: 'C',
  scale: 'major',
  brightness: 0.65
});
// Returns: "#ff4444" (C note in chromatic mode, slightly dimmed)
```

### Chromatic Mode Algorithm

```typescript
function getChromaticColor(noteClass: number): string {
  const CHROMATIC_COLORS = [
    '#ff4444', // C
    '#ff8844', // C#
    '#ffaa44', // D
    '#ffdd44', // D#
    '#ffff44', // E
    '#aaff44', // F
    '#44ff44', // F#
    '#44ffaa', // G
    '#44ffff', // G#
    '#44aaff', // A
    '#4444ff', // A#
    '#aa44ff'  // B
  ];

  return CHROMATIC_COLORS[noteClass % 12];
}
```

### Harmonic Mode Algorithm

```typescript
function getHarmonicColor(
  note: number,
  key: RootNote,
  scale: ScaleName
): string {
  const HARMONIC_COLORS = {
    1: '#4444ff', // Tonic
    2: '#44aaff', // Supertonic
    3: '#44ffaa', // Mediant
    4: '#44ff44', // Subdominant
    5: '#aa44ff', // Dominant
    6: '#ffaa44', // Submediant
    7: '#ff4444'  // Leading Tone
  };

  const noteClass = note % 12;
  const rootPos = ROOT_POSITIONS[key];
  const scaleNotes = getCurrentScale(key, scale);

  // Find scale degree
  const relativeNote = (noteClass - rootPos + 12) % 12;
  const scaleDegree = scaleNotes.indexOf(relativeNote) + 1;

  if (scaleDegree === 0) {
    // Non-scale note
    return '#888888';
  }

  return HARMONIC_COLORS[scaleDegree];
}
```

### Brightness Adjustment

```typescript
function adjustBrightness(hexColor: string, brightness: number): string {
  // Convert hex to HSL
  const hsl = hexToHSL(hexColor);

  // Adjust lightness
  hsl.l *= brightness;

  // Convert back to hex
  return hslToHex(hsl);
}
```

### Smooth Color Transition

**Canvas-based (PianoRoll, GuitarFretboard)**:

```typescript
// Store previous colors
const prevColors = new Map<number, string>();

function drawNoteWithTransition(note: number, targetColor: string) {
  const prevColor = prevColors.get(note) || targetColor;
  const currentColor = lerpColor(prevColor, targetColor, transitionProgress);

  // Draw note with interpolated color
  ctx.fillStyle = currentColor;
  ctx.fillRect(x, y, width, height);

  // Update stored color
  prevColors.set(note, targetColor);
}

// Lerp between two hex colors
function lerpColor(color1: string, color2: string, t: number): string {
  const rgb1 = hexToRGB(color1);
  const rgb2 = hexToRGB(color2);

  const r = Math.round(rgb1.r + (rgb2.r - rgb1.r) * t);
  const g = Math.round(rgb1.g + (rgb2.g - rgb1.g) * t);
  const b = Math.round(rgb1.b + (rgb2.b - rgb1.b) * t);

  return rgbToHex(r, g, b);
}
```

**Three.js-based (IsometricSequencer)**:

```typescript
// Lerp Three.js material colors
const targetColor = new THREE.Color(hexColor);
material.color.lerp(targetColor, 0.1); // Smooth transition
```

### Performance Considerations

- **Color Calculation**: Cache color calculations per note/mode/key combination
- **Transition Performance**: Use requestAnimationFrame for smooth 60fps transitions
- **Canvas Rendering**: Batch color updates to minimize redraws
- **Three.js**: Use material.needsUpdate = true only when necessary

### Testing

**Unit Tests** (`colorMapping.test.ts`):
- getColorForNote returns correct chromatic colors
- getColorForNote returns correct harmonic colors
- Brightness adjustment works correctly
- Non-scale notes return gray in harmonic mode
- Color transitions interpolate smoothly

**Visual Tests**:
- Screenshot comparisons in chromatic mode
- Screenshot comparisons in harmonic mode
- Verify color consistency across visualizers
- Test all 12 notes in both modes
- Test with various keys and scales

**Integration Tests**:
- Color mode toggle updates all visualizers
- Colors persist across page refresh
- Smooth transitions during mode switch
- Performance tests (many notes rendering)

**Testing Standards**:
- Use Vitest for unit tests
- Use Playwright for visual regression tests
- Screenshot testing for color accuracy
- Minimum 85% code coverage

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-11 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
