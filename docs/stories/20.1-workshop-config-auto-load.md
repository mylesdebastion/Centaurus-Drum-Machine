# Story 20.1: Workshop Config Auto-Load

**Epic:** Epic 20 - Workshop-Ready Education Mode
**Status:** üìù **PLANNING**
**Priority:** üî¥ **CRITICAL** (Workshop in 2 days)
**Time Estimate:** 2-3 hours
**Prerequisites:** None
**Owner:** Dev Team

---

## Story Statement

**As a** music workshop instructor,
**I want** the Centaurus app to automatically load WLED device IPs and workshop settings from a config file,
**So that** I can boot my laptop and start the workshop immediately without any manual configuration.

---

## Context and Background

### Workshop Scenario (Wednesday, Oct 22)
- **Setup:** Laptop + 6 WLED tubes + mobile router (WiFi)
- **Constraint:** Limited tech support, zero setup time on-site
- **Student Experience:** Laptop screen showing `/isometric` + 6 WLED tubes lighting up synchronized
- **Success Metric:** Instructor runs `workshop-start.bat` ‚Üí app ready in <30 seconds with zero clicks

### Technical Context
- WLED device IPs will be discovered today (Oct 20) using `education/discover-wled-devices.bat`
- Workshop config will be generated as `education/workshop-config.json`
- Mobile router subnet is unknown (not guaranteed to be 192.168.8.x)
- App must work **completely offline** (no internet, no Supabase)

### Existing System Integration
- **Story 2.3 (Complete):** Standalone WLED manager with manual device configuration
- **`/isometric` Route:** 6-lane sequencer already functional
- **GlobalMusicContext:** Existing context for tempo, patterns, WLED devices
- **localStorage:** Current settings persistence mechanism

---

## Acceptance Criteria

### AC1: Config File Detection and Loading
**Given** the app starts up,
**When** the file `education/workshop-config.json` exists,
**Then:**
1. App detects the file and reads its contents
2. If `workshopMode: true` is present, activate workshop mode
3. Parse and validate JSON structure (handle errors gracefully)
4. Log workshop mode activation to console: `"Workshop Mode: Activated"`

**Validation:**
- ‚úÖ Config file with `workshopMode: true` triggers auto-load
- ‚úÖ Missing config file ‚Üí app continues normally (no workshop mode)
- ‚úÖ Invalid JSON ‚Üí show error message, fall back to normal mode
- ‚úÖ `workshopMode: false` ‚Üí app ignores config, continues normally

---

### AC2: WLED Device Auto-Configuration
**Given** workshop mode is activated,
**When** `discoveredDevices` array exists in config,
**Then:**
1. For each device in the array, configure:
   - IP address
   - Device name (e.g., "Kick (Red)")
   - LED count (90 LEDs per strip)
   - Lane index (0-5 for 6-lane setup)
   - Color (hex color code, e.g., #FF0000 for red)
   - Enable state (true)
2. Store devices in GlobalMusicContext
3. Persist to localStorage as fallback
4. Initialize WebSocket connection to WLED bridge (port 8080)

**Example Config Structure:**
```json
{
  "workshopMode": true,
  "description": "6-tube WLED setup for deaf student rhythm workshop",
  "lastUpdated": "2025-10-20",
  "discoveredDevices": [
    {
      "id": "tube1",
      "name": "Kick (Red)",
      "ipAddress": "192.168.X.151",
      "laneIndex": 0,
      "color": "#FF0000",
      "boomwhackerNote": "C",
      "ledCount": 90,
      "enabled": true,
      "reverseDirection": true,
      "studentPosition": 1,
      "physicalLabel": "Position 1 - 192.168.X.151"
    }
    // ... 5 more devices
  ],
  "patterns": { /* ... */ },
  "setupNotes": { /* ... */ }
}
```

**Validation:**
- ‚úÖ All 6 devices configured from config file
- ‚úÖ Device names, IPs, colors applied correctly
- ‚úÖ WLED WebSocket bridge receives device list
- ‚úÖ Console logs: "Workshop Mode: Configured 6 WLED devices"

---

### AC3: Default Tempo and Pattern Configuration
**Given** workshop mode is activated,
**When** `patterns.simple` exists in config,
**Then:**
1. Apply default tempo (e.g., 60 BPM for beginner level)
2. Set active lanes based on pattern config (e.g., lane 0 only for "simple" pattern)
3. Store tempo in GlobalMusicContext
4. Persist to localStorage

**Example Pattern Config:**
```json
"patterns": {
  "simple": {
    "name": "Workshop Pattern 1 - Simple",
    "tempo": 60,
    "activeLanes": [0],
    "description": "Kick only, quarter notes, beginner level"
  },
  "callResponse": {
    "name": "Workshop Pattern 2 - Call Response",
    "tempo": 80,
    "activeLanes": [0, 1],
    "description": "Kick + Snare alternating, intermediate level"
  },
  "fullBeat": {
    "name": "Workshop Pattern 3 - Full Beat",
    "tempo": 100,
    "activeLanes": [0, 1, 2, 3, 4, 5],
    "description": "All 6 lanes, rock beat, advanced level"
  }
}
```

**Validation:**
- ‚úÖ Default tempo set to 60 BPM (or config value)
- ‚úÖ Active lanes configured based on selected pattern
- ‚úÖ Pattern description available for UI display
- ‚úÖ Instructor can switch patterns during workshop (not locked)

---

### AC4: Automatic Navigation to `/isometric`
**Given** workshop mode is activated,
**When** all config settings are applied,
**Then:**
1. Automatically navigate to `/isometric` route (no manual URL entry)
2. Display workshop mode indicator (optional visual badge)
3. Ensure all WLED devices show as "Connected" in UI
4. Sequencer ready to play immediately

**Validation:**
- ‚úÖ `/isometric` loads automatically on startup
- ‚úÖ No manual navigation required (zero clicks to ready state)
- ‚úÖ WLED device status indicators show "Connected"
- ‚úÖ Play button is functional immediately

---

### AC5: Offline-First Behavior
**Given** workshop mode is activated,
**When** the laptop has no internet connection,
**Then:**
1. Config loads from local file (no network request)
2. No Supabase API calls attempted
3. No authentication prompts shown
4. WLED devices connect via local WebSocket (port 8080, no internet needed)
5. All settings persist via localStorage only

**Validation:**
- ‚úÖ App functional with WiFi disabled (airplane mode test)
- ‚úÖ No console errors for failed network calls
- ‚úÖ WLED devices connect via local network (mobile router)
- ‚úÖ Settings persist after app restart (localStorage working)

---

### AC6: Graceful Fallback to Manual Configuration
**Given** workshop config auto-load fails (file missing, invalid, network error),
**When** the user needs to configure WLED devices manually,
**Then:**
1. Display error message: "Workshop config not found. Please configure WLED devices manually."
2. Show link/button to Story 2.3 standalone WLED manager
3. Existing manual configuration workflow remains functional
4. No blocking errors or crashes

**Validation:**
- ‚úÖ Missing config file ‚Üí graceful error, app continues
- ‚úÖ Invalid JSON ‚Üí error message shown, app continues
- ‚úÖ Manual WLED manager accessible as fallback
- ‚úÖ Emergency manual commands documented in `EMERGENCY-MANUAL-COMMANDS.md`

---

## Technical Approach

### Architecture Overview

```
App Startup
    ‚Üì
WorkshopConfigService.loadConfig()
    ‚Üì
Check: education/workshop-config.json exists?
    ‚îú‚îÄ YES ‚Üí Parse JSON ‚Üí Validate ‚Üí Apply to GlobalMusicContext
    ‚îÇ           ‚Üì
    ‚îÇ      workshopMode: true?
    ‚îÇ           ‚îú‚îÄ YES ‚Üí Apply WLED devices, tempo, patterns
    ‚îÇ           ‚îÇ           ‚Üì
    ‚îÇ           ‚îÇ      Navigate to /isometric
    ‚îÇ           ‚îÇ           ‚Üì
    ‚îÇ           ‚îÇ      Workshop Ready! üéâ
    ‚îÇ           ‚îÇ
    ‚îÇ           ‚îî‚îÄ NO ‚Üí Continue normal startup
    ‚îÇ
    ‚îî‚îÄ NO ‚Üí Continue normal startup
```

### File Structure

**New File: `src/services/WorkshopConfigService.ts`** (~150 lines)
```typescript
export interface WorkshopDevice {
  id: string;
  name: string;
  ipAddress: string;
  laneIndex: number;
  color: string;
  boomwhackerNote: string;
  ledCount: number;
  enabled: boolean;
  reverseDirection: boolean;
  studentPosition: number;
  physicalLabel: string;
}

export interface WorkshopPattern {
  name: string;
  tempo: number;
  activeLanes: number[];
  description: string;
}

export interface WorkshopConfig {
  workshopMode: boolean;
  description: string;
  lastUpdated: string;
  discoveredDevices: WorkshopDevice[];
  patterns: {
    simple: WorkshopPattern;
    callResponse: WorkshopPattern;
    fullBeat: WorkshopPattern;
  };
  setupNotes: {
    laptopIP: string;
    networkSubnet: string;
    bridgePort: number;
    serverPort: number;
    discoveryDate: string;
  };
}

export class WorkshopConfigService {
  /**
   * Load workshop config from education/workshop-config.json
   * Returns null if file doesn't exist or invalid
   */
  static async loadConfig(): Promise<WorkshopConfig | null> {
    try {
      const response = await fetch('/education/workshop-config.json');
      if (!response.ok) return null;

      const config: WorkshopConfig = await response.json();

      // Validate required fields
      if (!config.workshopMode) return null;
      if (!config.discoveredDevices || config.discoveredDevices.length === 0) {
        console.warn('Workshop config missing devices');
        return null;
      }

      console.log('Workshop Mode: Activated');
      console.log(`Workshop Mode: Configured ${config.discoveredDevices.length} WLED devices`);

      return config;
    } catch (error) {
      console.error('Workshop config load failed:', error);
      return null;
    }
  }

  /**
   * Apply workshop config to GlobalMusicContext
   */
  static applyToContext(
    config: WorkshopConfig,
    setTempo: (tempo: number) => void,
    setWLEDDevices: (devices: WLEDDevice[]) => void,
    setActiveLanes: (lanes: number[]) => void
  ): void {
    // Apply WLED devices
    const wledDevices = config.discoveredDevices.map(device => ({
      id: device.id,
      name: device.name,
      ipAddress: device.ipAddress,
      ledCount: device.ledCount,
      enabled: device.enabled,
      laneIndex: device.laneIndex,
      color: device.color
    }));
    setWLEDDevices(wledDevices);

    // Apply default tempo (from simple pattern)
    setTempo(config.patterns.simple.tempo);

    // Apply active lanes (from simple pattern)
    setActiveLanes(config.patterns.simple.activeLanes);

    // Persist to localStorage as fallback
    localStorage.setItem('workshop-mode', 'true');
    localStorage.setItem('workshop-config', JSON.stringify(config));

    console.log('Workshop Mode: Settings applied to GlobalMusicContext');
  }
}
```

**Modified: `src/App.tsx`**
```typescript
// Add workshop config detection on app startup
useEffect(() => {
  async function initWorkshopMode() {
    const config = await WorkshopConfigService.loadConfig();
    if (config) {
      WorkshopConfigService.applyToContext(
        config,
        setTempo,
        setWLEDDevices,
        setActiveLanes
      );

      // Auto-navigate to /isometric
      navigate('/isometric');
    }
  }

  initWorkshopMode();
}, []);
```

**Modified: `src/contexts/GlobalMusicContext.tsx`**
```typescript
// Add workshop mode state
const [workshopMode, setWorkshopMode] = useState<boolean>(false);

// Check localStorage on init
useEffect(() => {
  const isWorkshopMode = localStorage.getItem('workshop-mode') === 'true';
  setWorkshopMode(isWorkshopMode);
}, []);

// Export workshopMode in context
return (
  <GlobalMusicContext.Provider value={{
    // ... existing context values
    workshopMode,
    setWorkshopMode
  }}>
    {children}
  </GlobalMusicContext.Provider>
);
```

---

### Integration Points

#### Integration with Existing WLED Manager (Story 2.3)
- Workshop config **supplements** existing WLED manager, doesn't replace it
- If workshop config fails, user can still manually configure via Story 2.3 UI
- Workshop config devices saved to same localStorage keys as manual config
- WLED WebSocket bridge (`wled-websocket-bridge.cjs`) remains unchanged

#### Integration with `/isometric` Route
- `/isometric` already supports 6-lane visualization
- Workshop config auto-navigates to `/isometric` on startup
- Existing play/pause controls, tempo slider remain functional
- Instructor can override workshop defaults during session

#### Integration with Workshop Startup Script
**Sequence:**
1. Instructor runs `education/workshop-start.bat`
2. Script starts WLED WebSocket bridge (port 8080)
3. Script starts Vite dev server (port 5173)
4. Script opens browser to `http://localhost:5173`
5. App.tsx detects workshop config ‚Üí auto-loads settings
6. App.tsx navigates to `/isometric`
7. Workshop ready!

**Timing:**
- Total startup time: <30 seconds (target: 20 seconds)
- Config load: <1 second (local file read)
- WLED connection: <5 seconds (6 devices)

---

## Integration Verification (IV)

### IV1: Existing `/isometric` Functionality Unchanged
**Verification Steps:**
1. Test `/isometric` with workshop config file **present** ‚Üí auto-load works
2. Remove `education/workshop-config.json` file
3. Navigate to `/isometric` manually
4. Verify all existing features work (play/pause, tempo, pattern editing)
5. Verify no console errors or warnings

**Success Criteria:**
- ‚úÖ Non-workshop users unaffected (config file optional)
- ‚úÖ Manual navigation to `/isometric` still works
- ‚úÖ Manual WLED configuration still functional

---

### IV2: Workshop Config Overrides localStorage Defaults
**Verification Steps:**
1. Manually configure 3 WLED devices via Story 2.3 UI (saved to localStorage)
2. Create workshop config with 6 different devices
3. Restart app ‚Üí workshop config loads
4. Verify 6 workshop devices active (overriding localStorage)
5. Remove workshop config file
6. Restart app ‚Üí verify 3 manual devices restored

**Success Criteria:**
- ‚úÖ Workshop config takes precedence over localStorage
- ‚úÖ Removing workshop config restores localStorage devices
- ‚úÖ No data loss for manual configurations

---

### IV3: No Internet Dependency
**Verification Steps:**
1. Connect laptop to mobile router WiFi (local network only)
2. Disable laptop internet access (airplane mode or firewall block)
3. Run `education/workshop-start.bat`
4. Verify workshop config loads from local file
5. Verify `/isometric` renders correctly
6. Verify WLED devices connect via local WebSocket (no internet needed)
7. Check browser console for network errors (should be none)

**Success Criteria:**
- ‚úÖ Workshop config loads without internet
- ‚úÖ WLED devices connect via local network (mobile router subnet)
- ‚úÖ No Supabase API calls attempted
- ‚úÖ No console errors for failed network requests

---

## Manual Verification Steps

### Test 1: Workshop Mode Activation (Happy Path)
**Prerequisites:** Workshop config file exists with `workshopMode: true`

**Steps:**
1. Run `npm run dev` (dev server on port 5173)
2. Run `node scripts/wled-websocket-bridge.cjs` (WebSocket bridge on port 8080)
3. Open browser to `http://localhost:5173`
4. Observe browser console for log: "Workshop Mode: Activated"
5. Verify app auto-navigates to `/isometric`
6. Verify 6 WLED devices listed in UI (device names, IPs visible)
7. Verify default tempo is 60 BPM (or config value)
8. Click "Play" button ‚Üí verify sequencer plays

**Expected Result:**
- ‚úÖ Workshop mode activates automatically
- ‚úÖ `/isometric` loads without manual navigation
- ‚úÖ 6 WLED devices configured and ready

---

### Test 2: Missing Workshop Config (Fallback)
**Prerequisites:** Workshop config file **does not exist**

**Steps:**
1. Rename or delete `education/workshop-config.json`
2. Run dev server and WebSocket bridge
3. Open browser to `http://localhost:5173`
4. Verify app loads normally (home page or last route)
5. Manually navigate to `/isometric`
6. Verify existing functionality works (manual WLED config, tempo slider, etc.)

**Expected Result:**
- ‚úÖ App continues normally without workshop config
- ‚úÖ No console errors or warnings
- ‚úÖ Manual configuration workflow functional

---

### Test 3: Invalid Workshop Config (Error Handling)
**Prerequisites:** Workshop config file with invalid JSON or missing required fields

**Steps:**
1. Create `education/workshop-config.json` with invalid JSON:
   ```json
   { "workshopMode": true, "discoveredDevices": [ INVALID JSON
   ```
2. Run dev server and WebSocket bridge
3. Open browser to `http://localhost:5173`
4. Observe browser console for error: "Workshop config load failed"
5. Verify app continues normally (no crash)
6. Verify error message shown to user (if applicable)

**Expected Result:**
- ‚úÖ Invalid config handled gracefully
- ‚úÖ App doesn't crash or block
- ‚úÖ User can proceed with manual configuration

---

### Test 4: Offline Mode Verification
**Prerequisites:** Workshop config exists, laptop has no internet access

**Steps:**
1. Connect laptop to mobile router (local WiFi only, no internet)
2. Verify internet disabled (open browser, try google.com ‚Üí should fail)
3. Run `education/workshop-start.bat`
4. Verify workshop mode activates
5. Verify WLED devices connect via local network
6. Play a pattern ‚Üí verify WLED tubes light up synchronized
7. Check browser console for network errors (should be none for critical features)

**Expected Result:**
- ‚úÖ Workshop mode works completely offline
- ‚úÖ WLED devices connect via local WebSocket
- ‚úÖ No blocking errors related to internet access

---

### Test 5: Workshop Startup Script Integration
**Prerequisites:** Workshop config exists, WLED tubes powered on

**Steps:**
1. Close all browser windows and dev servers
2. Double-click `education/workshop-start.bat`
3. Observe console windows:
   - WLED Bridge window appears (port 8080)
   - Dev server starts (port 5173)
4. Browser opens automatically in fullscreen to `/isometric`
5. Verify 6 WLED devices show "Connected"
6. Click "Play" ‚Üí verify WLED tubes light up synchronized

**Expected Result:**
- ‚úÖ One-click startup (zero manual steps)
- ‚úÖ Browser auto-opens to `/isometric`
- ‚úÖ WLED devices connected within 30 seconds
- ‚úÖ Workshop ready to use immediately

---

## Definition of Done (DoD)

### Code Complete
- [ ] `src/services/WorkshopConfigService.ts` created and tested
- [ ] `src/App.tsx` modified to detect and apply workshop config
- [ ] `src/contexts/GlobalMusicContext.tsx` modified to support workshop mode
- [ ] TypeScript types exported for workshop config structure
- [ ] No TypeScript errors or warnings

### Integration Complete
- [ ] Workshop config loads from `education/workshop-config.json`
- [ ] WLED devices auto-configured from config file
- [ ] Default tempo and patterns applied
- [ ] Auto-navigation to `/isometric` functional
- [ ] Story 2.3 WLED manager remains functional as fallback

### Testing Complete
- [ ] Test 1 (Happy Path) passes
- [ ] Test 2 (Missing Config) passes
- [ ] Test 3 (Invalid Config) passes
- [ ] Test 4 (Offline Mode) passes
- [ ] Test 5 (Startup Script) passes
- [ ] All Integration Verification (IV1-IV3) tests pass

### Documentation Complete
- [ ] Code comments for WorkshopConfigService methods
- [ ] JSDoc comments for public API functions
- [ ] Console logs for workshop mode activation (debugging)
- [ ] Error messages user-friendly and actionable

### Ready for Story 20.3 (Offline Verification)
- [ ] Workshop config service functional and tested
- [ ] No internet dependency verified
- [ ] localStorage persistence working
- [ ] Emergency fallback to manual config tested

---

## Dependencies

### Upstream (Required Before Starting)
- ‚úÖ **Workshop Config File:** `education/workshop-config.json` (generated via `discover-wled-devices.bat`)
- ‚úÖ **Workshop Startup Script:** `education/workshop-start.bat` (already created)
- ‚úÖ **WLED WebSocket Bridge:** `scripts/wled-websocket-bridge.cjs` (existing)
- ‚úÖ **Story 2.3:** Standalone WLED manager (complete - fallback)

### Downstream (Enables These Stories)
- **Story 20.3:** Offline-First Mode Verification (depends on Story 20.1 config loading)
- **Story 20.4:** Workshop Startup Integration Testing (depends on Story 20.1 auto-load)

### No Dependency (Can Be Parallel)
- **Story 20.2:** APC40 LED Button Mapping (optional, not blocking)

---

## Risk Mitigation

### Risk 1: Workshop Config File Not Found
**Likelihood:** MEDIUM
**Impact:** HIGH (workshop can't auto-start)
**Mitigation:**
- Graceful fallback to manual configuration (Story 2.3)
- Clear error message with instructions
- Emergency manual commands documented (`EMERGENCY-MANUAL-COMMANDS.md`)
- Test config discovery today (Oct 20) to ensure file exists

---

### Risk 2: Invalid JSON or Malformed Config
**Likelihood:** LOW
**Impact:** MEDIUM (workshop can't auto-start, but app doesn't crash)
**Mitigation:**
- JSON validation in WorkshopConfigService
- Error handling with try/catch blocks
- User-friendly error message shown
- App continues normally without workshop mode

---

### Risk 3: WLED Devices Don't Connect After Auto-Load
**Likelihood:** MEDIUM
**Impact:** CRITICAL (WLED tubes don't light up)
**Mitigation:**
- WebSocket connection retry logic (existing in WLED bridge)
- Device status indicators in UI (show "Connecting..." ‚Üí "Connected" / "Failed")
- Emergency manual commands for WLED troubleshooting
- Pre-test all WLED IPs today (Oct 20) to verify connectivity

---

### Risk 4: Offline Mode Breaks Existing Features
**Likelihood:** LOW
**Impact:** MEDIUM (non-workshop users affected)
**Mitigation:**
- Feature flag: `workshopMode` only active if config file present
- Integration verification tests (IV1-IV3) ensure backward compatibility
- Rollback plan: Remove workshop config file ‚Üí app continues normally

---

## Success Metrics

### Functional Success
- ‚úÖ Workshop config loads in <1 second (local file read)
- ‚úÖ WLED devices connect in <5 seconds (6 devices via WebSocket)
- ‚úÖ Total startup time <30 seconds (boot to ready)
- ‚úÖ Zero manual configuration steps required

### Integration Success
- ‚úÖ All IV tests pass (IV1: backward compatibility, IV2: override precedence, IV3: offline mode)
- ‚úÖ No regression in existing `/isometric` functionality
- ‚úÖ Story 2.3 WLED manager remains functional

### Workshop Readiness
- ‚úÖ Instructor can run `workshop-start.bat` ‚Üí workshop ready
- ‚úÖ Students see laptop screen `/isometric` + WLED tubes synchronized
- ‚úÖ Emergency manual commands tested and documented

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-20 | 1.0 | Initial story specification for workshop config auto-load | Dev Team |

---

**Story Owner:** Dev Team
**Related Epic:** Epic 20 - Workshop-Ready Education Mode
**Workshop Date:** Wednesday, October 22, 2025
**Status:** üìù PLANNING ‚Üí Ready for Implementation
