# Story: Multi-Note LED Strip Visualization Sync Troubleshooting

## Story ID: EPIC-2-LED-004
**Status:** In Progress
**Epic:** Epic 2 - 3D Boomwhacker Music Learning Application
**Priority:** High
**Type:** Bug/Troubleshooting

## Problem Statement
As a developer working on the LED strip system, I need to troubleshoot why the virtual multi-note LED strip visualization in the web UI is not displaying the same information as the correct physical WLED strips, so that the virtual LED preview accurately represents what students see on their physical LED hardware.

## Observed Behavior
- Physical WLED strips (IRL LEDs) display correct multi-note visualization
- Virtual LED strip component in web UI shows different/incorrect pattern
- Sync issue specifically affects multi-note mode (multiple assigned lanes)
- Single lane LED strips may be working correctly

## Expected Behavior
- Virtual LED strip visualization should exactly match physical WLED strip output
- Both systems should show identical:
  - Note placement and timing
  - Color assignments for each lane
  - Multi-note color blending when notes overlap
  - Timeline/strike bar position

## Troubleshooting Tasks

### Data Flow Analysis
- [ ] Trace pattern data from IsometricSequencer to VirtualLEDStrip component
- [ ] Compare pattern data sent to physical WLED vs virtual LED component
- [ ] Verify fullPattern prop contains correct 2D boolean array structure
- [ ] Check if assignedLanes array matches between physical and virtual systems
- [ ] Validate currentStep synchronization between 3D viz and LED systems

### Virtual LED Component Investigation
- [ ] Examine VirtualLEDStrip.tsx multi-note rendering logic (lines 104-169)
- [ ] Verify fullPattern[stepIndex][laneIndex] access pattern is correct
- [ ] Check if activeLanesAtStep calculation matches physical LED logic
- [ ] Validate color assignment using boomwhackerColors array
- [ ] Test timeline position calculation for multi-note strips

### Physical LED System Comparison
- [ ] Review SingleLaneVisualizer.ts multi-note logic
- [ ] Compare LED array generation between virtual and physical systems
- [ ] Verify WLED message format and color data structure
- [ ] Check if rate limiting affects pattern synchronization
- [ ] Validate beat progress calculation consistency

### Pattern Data Structure
- [ ] Confirm fullPattern prop structure: boolean[][] (steps x lanes)
- [ ] Verify pattern prop vs fullPattern prop usage in multi-note mode
- [ ] Check if step indexing is consistent (0-based vs 1-based)
- [ ] Validate lane indexing matches chromatic scale positions
- [ ] Test edge cases: empty steps, all lanes active, single note

### Synchronization Issues
- [ ] Compare timing between VirtualLEDStrip useEffect and physical LED updates
- [ ] Verify currentStep prop matches physical LED strip currentStep
- [ ] Check if beatProgress calculation differs between systems
- [ ] Test timeline bar positioning accuracy
- [ ] Validate color cycling timing (if applicable)

### Testing & Validation
- [ ] Create test pattern with known multi-note combinations
- [ ] Compare pixel-by-pixel output between virtual and physical LEDs
- [ ] Test with different assignedLanes configurations
- [ ] Verify behavior with WLEDTUBE8 (multi-lane configuration)
- [ ] Test timeline synchronization during playback

## Suspected Root Causes

### Pattern Data Mismatch
- fullPattern prop may not be correctly populated with multi-lane data
- Virtual component might be using single-lane pattern instead of fullPattern
- Lane indexing could be offset between virtual and physical systems

### Color Assignment Issues
- boomwhackerColors array indexing might differ between systems
- Multi-note color blending algorithm could be inconsistent
- Timeline bar override logic may not match between systems

### Timing Synchronization
- useEffect dependencies in VirtualLEDStrip might be missing key props
- Beat progress calculation could differ from physical LED timing
- Update frequency mismatch between virtual and physical systems

## Investigation Files

### Primary Investigation Targets
- `src/components/LEDStripManager/VirtualLEDStrip.tsx` (virtual LED rendering)
- `src/utils/SingleLaneVisualizer.ts` (physical LED logic)
- `src/components/IsometricSequencer/IsometricSequencer.tsx` (pattern source)

### Supporting Files
- `src/types/led.ts` (data structure definitions)
- `src/components/LEDStripManager/LEDStripManager.tsx` (configuration)

## Debug Strategy

### Step 1: Data Verification
1. Add console logging to VirtualLEDStrip to output fullPattern data
2. Add logging to SingleLaneVisualizer to output physical LED pattern data
3. Compare logged data structures for discrepancies
4. Verify assignedLanes arrays match between systems

### Step 2: Visual Comparison
1. Create side-by-side test with known pattern
2. Screenshot virtual LED output
3. Photograph physical LED strips
4. Compare frame-by-frame during playback

### Step 3: Isolation Testing
1. Test with single multi-note strip (WLEDTUBE8)
2. Test with simple 2-note pattern
3. Test with all-lanes-active pattern
4. Test timeline positioning without notes

### Step 4: Code Path Tracing
1. Set breakpoints in multi-note rendering logic
2. Step through fullPattern access code
3. Verify color calculation and LED positioning
4. Compare with physical LED generation logic

## Success Criteria
- [ ] Virtual LED visualization matches physical WLED output exactly
- [ ] Multi-note color blending works identically in both systems
- [ ] Timeline/strike bar position synchronized perfectly
- [ ] Pattern changes reflect immediately in both virtual and physical LEDs
- [ ] All assigned lanes display correct colors and timing

## Dev Notes
- Focus on multi-note mode specifically (single lane mode may be working)
- Recent changes to fullPattern prop implementation may be related
- VirtualLEDStrip.tsx recently updated for multi-note color display
- Physical WLED strips are known to work correctly (reference implementation)

## File Modification History
- VirtualLEDStrip.tsx: Recent updates to multi-note rendering logic
- LEDStripManager.tsx: Recent addition of fullPattern prop passing
- IsometricSequencer.tsx: Recent audio-visual sync fixes

## Dev Agent Record
**Agent Model Used:** Claude
**Debug Log References:** TBD
**Completion Notes:** Story created to systematically troubleshoot virtual vs physical LED sync issue