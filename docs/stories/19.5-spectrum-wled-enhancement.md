# Story 19.5: Spectrum Mode WLED Visualization (1D LED Strips)

**Epic:** Education Mode DJ Visualizer Integration (Epic 19)
**Status:** ⚠️ **POTENTIALLY SKIP/RESOLVED** - Simple config change may suffice
**Priority:** Medium → Low
**Complexity:** Medium → Trivial
**Prerequisites:** Story 19.1, 19.2 complete
**Successor:** Story 19.6 (2D LED matrix support)

---

## ⚠️ IMPLEMENTATION NOTE - POTENTIALLY SKIP THIS STORY

**Date:** 2025-10-19
**Discovery:** The entire spectrum visualization for 1D LED strips may already work correctly by simply **configuring the LED matrix as 90×1 (width=90, height=1) instead of 1×90 (width=1, height=90)** in the WLED manager.

### Why This Simple Solution Works

The existing `SpectrumVisualization.ts` implementation **already renders spectrum bars horizontally across the canvas width**:
- Canvas rendering: 128 bars spread across canvas width
- LED matrix output: Canvas is sampled and mapped to LED grid
- **Key insight:** If width=90, each frequency bin maps to one "column" of the grid
- Since height=1, each "column" is just a single LED
- **Result:** All 90 frequency bins are laid out horizontally across the 90 LEDs

### What Already Works (Verified 2025-10-19)
- ✅ Horizontal frequency layout (bass LED 0 → treble LED 89)
- ✅ Spectrum visualization visible across all LEDs
- ✅ Canvas rendering maps correctly to 90-LED strip
- ✅ Color mapping from virtual spectrum canvas

### What May Still Need Verification
- ⚠️ **Fade-out smoothing** - Does current implementation prevent LED flicker?
- ⚠️ **Amplitude → brightness mapping** - Is perceptual scaling optimal?
- ⚠️ **Performance** - Is WLED output maintaining 30+ fps?
- ⚠️ **Color saturation** - Are LED colors vivid enough (not washed out)?

### Recommendation: Verify Before Skipping

**Before officially skipping this story:**
1. Test with Education Mode lesson 2 (drum sounds)
2. Verify kick drum shows bass LEDs (red/magenta, left side)
3. Verify hi-hat shows treble LEDs (cyan/blue, right side)
4. Check for LED flicker during percussive sounds
5. Measure WLED frame rate (should be 30+ fps)
6. Test color saturation at various volumes

**If all above tests pass:** Mark story as **SKIP - Already Resolved**
**If issues found:** Implement only the specific improvements needed (not full story)

---

## Story

**As a** DJ or educator using Education Mode lesson 2 with a 1D LED strip,
**I want** spectrum visualization optimized for horizontal frequency layout on WLED 1D LED strips (1×N configuration),
**so that** I can see frequency peaks laid out spatially from bass (LED 0) to treble (LED N) with brightness representing amplitude.

---

## Background / Context

### Current State
- ✅ **Spectrum visualization exists** - `SpectrumVisualization.ts` renders frequency bars to canvas
- ✅ **WLED output working** - `LEDMatrixManager.tsx` sends LED data via WebSocket bridge
- ✅ **Education Mode integration** - Lesson 2 uses LiveAudioVisualizer in embedded mode (Story 19.2)
- ✅ **Standalone DJ visualizer** - `/dj-visualizer` route with WLED support
- ❌ **Incorrect WLED spectrum layout** - Current implementation copies canvas pixel data, not optimized for 1D LED strip
- ❌ **No frequency-to-LED mapping** - Frequencies should be laid out horizontally across LEDs 0-N
- ❌ **Bar height not mapped to brightness** - Amplitude should control LED brightness, not vertical stacking
- ❌ **No fade-out smoothing** - LEDs flicker instead of smoothly fading out like bar chart drop-off

### Existing Implementation Locations
- **Spectrum visualization:** `src/components/LiveAudioVisualizer/visualizations/SpectrumVisualization.ts`
- **WLED manager:** `src/components/LiveAudioVisualizer/LEDMatrixManager.tsx`
- **Color mapping:** `src/utils/colorMapping.ts`
- **Visualization engine:** `src/components/LiveAudioVisualizer/VisualizationEngine.ts`

### Why Enhancement is Needed
Education Mode lesson 2 (Color & Pitch) teaches students about frequency and pitch using drum sounds. WLED LED matrix output enhances this learning by providing a physical, tangible visualization. However, current spectrum visualization needs **fundamental restructuring** for 1D LED strips:

1. **Horizontal frequency layout** - Frequencies 0-N should map to LEDs 0-N (not vertical bars on 2D grid)
2. **Amplitude → Brightness mapping** - Bar chart height should control LED brightness (0-255), not vertical pixel stacking
3. **Color mapping from virtual viz** - LED colors should mirror the spectrum mode canvas visualization
4. **Fade-out smoothing** - LEDs should fade gradually (like bar chart drop-off), not flicker on/off

**Current Problem:** The existing implementation copies canvas pixel data to WLED, which produces a 2D grid representation. This doesn't work well for 1D LED strips (default: 1×90) where each LED should represent a **single frequency bin** with **brightness representing amplitude**.

**Scope of This Story:**
- **Story 19.5:** 1D LED strips (1×N configuration) - horizontal frequency layout
- **Story 19.6:** 2D LED matrices (M×N configuration) - bar chart rendering with orientation/flip support

[Source: Epic 19, User requirements for WLED spectrum mode]

---

## Acceptance Criteria

### AC 1: Horizontal Frequency Layout (LED 0-N Mapping) - 1D Strips Only
- [ ] **Applies to 1D LED strips (height = 1, width = N)** - default: 1×90
- [ ] Frequencies are laid out horizontally across LEDs 0 to N
- [ ] LED index 0 = lowest frequency (bass, ~50 Hz)
- [ ] LED index N = highest frequency (treble, ~8 kHz)
- [ ] Logarithmic frequency spacing matches virtual spectrum visualization
- [ ] 2D LED matrices (M×N where M > 1) are **out of scope** for this story (see Story 19.6)

### AC 2: Amplitude → Brightness Mapping
- [ ] Bar chart height (amplitude) controls LED brightness (0-255)
- [ ] Quiet sounds (low amplitude) produce dim LEDs
- [ ] Loud sounds (high amplitude) produce full-brightness LEDs
- [ ] Brightness mapping is perceptual (logarithmic or square-root scaling)
- [ ] No vertical stacking - single LED per frequency bin

### AC 3: Color Mapping from Virtual Visualization
- [ ] LED colors mirror spectrum mode canvas visualization exactly
- [ ] Low frequencies (bass) display red/magenta hues
- [ ] Mid frequencies display green/yellow hues
- [ ] High frequencies display cyan/blue hues
- [ ] Color transitions are smooth across frequency bands
- [ ] Colors remain saturated at all brightness levels (no washed-out whites)

### AC 4: Fade-Out Smoothing (Anti-Flicker)
- [ ] LED intensity fades gradually when amplitude decreases
- [ ] Fade-out speed matches virtual bar chart drop-off
- [ ] No sudden on/off flickering
- [ ] Smooth transitions for percussive sounds (kick, snare, hi-hat)
- [ ] Peak hold fade-out is visible and smooth

### AC 5: Education Mode Lesson 2 Integration
- [ ] Improved spectrum visualization works in Education Mode lesson 2 (embedded mode)
- [ ] Drum sounds trigger vivid frequency peaks on WLED matrix
- [ ] Kick drum shows low-frequency LED activation (red/magenta)
- [ ] Snare drum shows mid-frequency LED activation (green/yellow)
- [ ] Hi-hat shows high-frequency LED activation (cyan/blue)
- [ ] Color mode switching (spectrum/chromatic/harmonic) works with WLED output
- [ ] WLED visualization enhances learning experience without performance degradation

### AC 6: Standalone /dj-visualizer Compatibility
- [ ] Improvements work in standalone /dj-visualizer route
- [ ] No regression in existing visualization modes (waveform, ripple)
- [ ] WLED settings panel remains functional
- [ ] Performance maintains 60fps canvas rendering
- [ ] Virtual preview accurately represents WLED output

### AC 7: Performance and Responsiveness
- [ ] WLED output updates at minimum 30fps (target: 60fps)
- [ ] No lag between audio input and LED visualization
- [ ] WebSocket bridge communication optimized for low latency
- [ ] Virtual preview matches actual WLED output
- [ ] No dropped frames during drum sound playback

---

## Tasks / Subtasks

### Task 1: Implement 1D LED Strip Spectrum Renderer (AC: 1, 2, 3)
- [ ] Create new method `renderSpectrumToLED()` in `SpectrumVisualization.ts`
- [ ] Map frequency bins 0-N to LED indices 0-N (horizontal layout)
- [ ] For each LED index i:
  - [ ] Calculate corresponding frequency bin from spectrum data
  - [ ] Get amplitude (bar height) for that frequency bin
  - [ ] Map amplitude to LED brightness (0-255) using perceptual scaling
  - [ ] Get color from virtual spectrum visualization for that frequency
  - [ ] Combine color + brightness → RGB values for LED i
- [ ] Output 1D array of RGB values (length = LED strip length)

### Task 2: Implement Amplitude → Brightness Scaling (AC: 2)
- [ ] Add perceptual brightness mapping (square-root or logarithmic)
- [ ] Quiet sounds (low amplitude) → dim LEDs (brightness ~20-50)
- [ ] Loud sounds (high amplitude) → full-brightness LEDs (brightness ~200-255)
- [ ] Test with drum sounds (kick, snare, hi-hat, tom) at various volumes
- [ ] Ensure no clipping or oversaturation at maximum amplitude

### Task 3: Implement Fade-Out Smoothing (AC: 4)
- [ ] Add LED intensity memory array (stores previous LED brightness values)
- [ ] On each frame:
  - [ ] If new amplitude > previous: use new amplitude (instant attack)
  - [ ] If new amplitude < previous: fade previous down gradually (decay)
- [ ] Decay rate should match virtual bar chart drop-off speed
- [ ] Test with percussive sounds (should see smooth fade-out, no flicker)
- [ ] Tune decay constant for optimal visual smoothness

### Task 4: Color Mapping from Virtual Visualization (AC: 3)
- [ ] Extract color calculation logic from canvas rendering code
- [ ] Ensure LED colors exactly match virtual spectrum canvas colors
- [ ] Low frequencies → red/magenta hues
- [ ] Mid frequencies → green/yellow hues
- [ ] High frequencies → cyan/blue hues
- [ ] Apply color saturation boost for LED visibility (avoid washed-out whites)
- [ ] Test color mode switching (spectrum/chromatic/harmonic)

### Task 5: Integrate with LEDMatrixManager and VisualizationEngine (AC: 1-4)
- [ ] Call `renderSpectrumToLED()` from `VisualizationEngine.ts`
- [ ] Pass 1D LED array to `LEDMatrixManager.sendToWLED()`
- [ ] **1D LED strips only (height = 1):** Use LED array directly as single row
- [ ] **2D LED matrices (height > 1):** Defer to Story 19.6 (out of scope)
- [ ] Test with default 1×90 LED strip configuration
- [ ] Verify WebSocket bridge sends correct LED data

### Task 6: Test in Education Mode Lesson 2 (AC: 5)
- [ ] Navigate to Education Mode lesson 2 (Color & Pitch)
- [ ] Enable WLED output via settings
- [ ] Play kick drum → verify low-frequency LEDs activate (red/magenta, left side)
- [ ] Play snare drum → verify mid-frequency LEDs activate (green/yellow, middle)
- [ ] Play hi-hat → verify high-frequency LEDs activate (cyan/blue, right side)
- [ ] Play tom drum → verify mid-low frequency LEDs activate (orange/yellow)
- [ ] Test color mode switching (spectrum/chromatic/harmonic)
- [ ] Confirm smooth fade-out after each drum hit (no flicker)
- [ ] Confirm no performance degradation (60fps canvas, 30+ fps WLED)
- [ ] Document visual improvements in Dev Agent Record

### Task 7: Regression Testing - Standalone DJ Visualizer (AC: 6)
- [ ] Navigate to `/dj-visualizer` route
- [ ] Enable WLED output
- [ ] Test spectrum mode with live audio input (verify 1D LED layout)
- [ ] Test waveform mode (verify no regression)
- [ ] Test ripple mode (verify no regression)
- [ ] Verify WLED settings panel (IP address, matrix size, orientation)
- [ ] Confirm virtual preview accurately represents WLED output

### Task 8: Performance Profiling (AC: 7)
- [ ] Open DevTools → Performance tab
- [ ] Profile WLED output frame rate (target: 30fps minimum, 60fps ideal)
- [ ] Measure WebSocket bridge latency (audio → LED delay)
- [ ] Profile during drum playback (Education Mode lesson 2)
- [ ] Profile during live audio input (DJ visualizer)
- [ ] Optimize any performance bottlenecks identified
- [ ] Document final performance metrics in Dev Agent Record

### Task 9: Manual Testing Checklist (AC: 1-7)
- [ ] **Horizontal layout:** Frequencies laid out across LEDs 0-N (bass on left, treble on right)
- [ ] **Amplitude → Brightness:** Bar height controls LED brightness, not vertical stacking
- [ ] **Color mapping:** LED colors match virtual spectrum canvas (red/green/yellow/cyan/blue)
- [ ] **Fade-out smoothing:** LEDs fade gradually, no flicker on percussive sounds
- [ ] **Education Mode:** Lesson 2 drum sounds produce clear frequency peaks (kick=bass, hi-hat=treble)
- [ ] **DJ Visualizer:** No regression in standalone route or other modes
- [ ] **Performance:** 30+ fps WLED output, no lag or dropped frames
- [ ] **Cross-browser:** Test on Chrome, Firefox, Edge (WebSocket compatibility)
- [ ] **Mobile:** Test on mobile device accessing dev server on network

---

## Dev Notes

### Component Architecture

**NEW Spectrum Visualization Pipeline for WLED:**
```
Audio Input → FrequencySourceManager → SpectrumVisualization
  ↓
  ├─→ render() → Canvas (2D visualization for UI)
  └─→ renderSpectrumToLED() → 1D LED Array (horizontal frequency layout)
       ↓
LEDMatrixManager.sendToWLED()
       ↓
WebSocket Bridge → WLED Device (1D LED strip: 1×90 default)
```

**Key Architectural Change:**
- **OLD:** Copy canvas pixel data to WLED (produces 2D grid representation)
- **NEW:** Separate rendering path for 1D LED strips (horizontal frequency layout, amplitude → brightness)

**File Locations:**
- **Spectrum rendering:** `src/components/LiveAudioVisualizer/visualizations/SpectrumVisualization.ts` ← ADD `renderSpectrumToLED()`
- **WLED output:** `src/components/LiveAudioVisualizer/LEDMatrixManager.tsx`
- **Color mapping:** `src/utils/colorMapping.ts`
- **Frequency source:** `src/utils/frequencySourceManager.ts`
- **Visualization engine:** `src/components/LiveAudioVisualizer/VisualizationEngine.ts` ← Call `renderSpectrumToLED()`

[Source: docs/architecture/source-tree.md#existing-project-structure, User requirements]

### Current Spectrum Configuration

**Default Config (SpectrumVisualization.ts:24-32):**
```typescript
export const DEFAULT_SPECTRUM_CONFIG: SpectrumConfig = {
  numBars: 128,          // ❌ MISMATCH - LED matrix width is 90
  peakHold: true,
  peakFallSpeed: 0.05,
  minOpacity: 0.3,       // ❌ Canvas opacity, not LED brightness
  minBrightness: 0.5,
  scaleType: 'log',
  colorMode: 'spectrum',
};
```

**Enhancement Targets:**
1. **numBars:** Match LED matrix width (90 by default)
2. **Brightness mapping:** Add LED-specific perceptual scaling
3. **Color saturation:** Boost for LED visibility (prevent washed-out whites)

[Source: src/components/LiveAudioVisualizer/visualizations/SpectrumVisualization.ts:24-32]

### Color Mapping Enhancement Pattern

**Current Implementation (SpectrumVisualization.ts:128-145):**
```typescript
const color = getFrequencyColor(normalizedFrequency, this.config.colorMode, this.config.scaleType);

// Apply amplitude to opacity AND brightness
const opacity = Math.max(minOpacity, normalizedAmplitude);
const brightness = Math.max(minBrightness, normalizedAmplitude);

ctx.fillStyle = `rgba(${Math.floor(color.r * brightness)}, ${Math.floor(color.g * brightness)}, ${Math.floor(color.b * brightness)}, ${opacity})`;
```

**Enhanced Pattern (ADD THIS):**
```typescript
// LED-specific color mapping with saturation boost
const baseColor = getFrequencyColor(normalizedFrequency, this.config.colorMode, this.config.scaleType);

// Perceptual brightness mapping (logarithmic) for LED visibility
const ledBrightness = Math.pow(normalizedAmplitude, 0.5); // Square root for perceptual scaling

// Saturation boost (prevent washed-out whites at high amplitude)
const saturationBoost = 1.2;
const ledColor = {
  r: Math.min(255, baseColor.r * saturationBoost),
  g: Math.min(255, baseColor.g * saturationBoost),
  b: Math.min(255, baseColor.b * saturationBoost),
};

// Apply perceptual brightness
ctx.fillStyle = `rgba(${Math.floor(ledColor.r * ledBrightness)}, ${Math.floor(ledColor.g * ledBrightness)}, ${Math.floor(ledColor.b * ledBrightness)}, 1.0)`;
```

[Source: Component optimization patterns, docs/architecture/coding-standards.md#performance]

### WLED Output Integration

**LEDMatrixManager.sendToWLED() (LEDMatrixManager.tsx:231-252):**
- Converts canvas 2D grid → 1D linear array
- Handles serpentine wiring pattern
- Sends via WebSocket bridge to WLED device

**Grid-to-Linear Conversion (LEDMatrixManager.tsx:188-226):**
- Preserves color/brightness from canvas
- Applies reverse option for bottom-to-top wiring
- Supports horizontal/vertical orientation

**No changes needed** to LEDMatrixManager - enhancements stay in SpectrumVisualization.render()

[Source: src/components/LiveAudioVisualizer/LEDMatrixManager.tsx:188-252]

### Education Mode Integration

**Lesson 2 Integration (Story 19.2):**
- LiveAudioVisualizer embedded in `EducationMode.tsx`
- Drum playback via `audioEngine.playDrum()` → FrequencySourceManager → Spectrum visualization
- WLED output enabled via LEDMatrixManager

**Color Modes (lesson 2 teaches Color & Pitch):**
- **Spectrum:** Red (bass) → Cyan (treble) - default for drum frequency peaks
- **Chromatic:** 12-tone color wheel (C=red, C#=orange, etc.)
- **Harmonic:** Harmonic series colors (natural overtones)

[Source: Epic 19, docs/epics/epic-19-education-dj-visualizer-integration.md#pedagogically-matched-visualization-strategy]

### Performance Targets

**Frame Rate:**
- **Canvas rendering:** 60fps (existing target)
- **WLED output:** 30fps minimum, 60fps target (WebSocket bandwidth limited)

**Latency:**
- **Audio → Canvas:** <16ms (60fps)
- **Canvas → WLED:** <50ms (WebSocket + UDP to WLED device)
- **Total latency:** <100ms (imperceptible for music visualization)

**Optimization Strategy:**
- Throttle WLED updates if WebSocket buffer fills
- Prioritize canvas rendering over WLED output (user sees canvas first)
- Use `requestAnimationFrame()` for smooth canvas updates

[Source: docs/architecture/coding-standards.md#performance]

### Technology Stack
- **React:** 18.2.0 (functional components with hooks)
- **TypeScript:** 5.2.2 (strict mode)
- **Canvas API:** 2D rendering context
- **WebSocket:** WLED bridge communication
- **Tailwind CSS:** Existing utility classes
- **Tone.js:** 15.1.22 (audio synthesis in Education Mode)

[Source: docs/architecture/tech-stack.md]

---

## Testing

### Manual Testing Strategy
**This project uses manual testing with browser DevTools, NOT automated test suites.**

[Source: CLAUDE.md#project-scale--testing-philosophy]

### Verification Checklist (Browser Testing)

**Color Mapping Verification:**
1. Navigate to `/dj-visualizer`
2. Enable WLED output (LED Matrix Output panel)
3. Start live audio input (microphone or system audio)
4. Play bass-heavy music (verify red/magenta hues in low frequencies)
5. Play high-frequency sounds (verify cyan/blue hues in high frequencies)
6. Verify smooth color transitions across frequency range
7. Check virtual preview matches expected colors

**Brightness Mapping Verification:**
1. Play quiet audio (low amplitude)
2. Verify LEDs are visible but not overly bright
3. Play loud audio (high amplitude)
4. Verify LEDs reach full brightness without clipping to white
5. Verify peak hold indicators are clearly visible
6. Test with drum sounds (kick, snare, hi-hat, tom) at various volumes

**Education Mode Lesson 2 Verification:**
1. Navigate to Education Mode → Lesson 2 (Color & Pitch)
2. Enable WLED output
3. Play kick drum (verify low-frequency red/magenta peak)
4. Play snare drum (verify mid-frequency green/yellow peak)
5. Play hi-hat (verify high-frequency cyan/blue peak)
6. Play tom drum (verify mid-low frequency orange/yellow peak)
7. Switch color modes (spectrum/chromatic/harmonic)
8. Verify WLED output updates correctly for each mode
9. Confirm no console errors or warnings

**Performance Profiling:**
1. Open DevTools → Performance tab
2. Start recording
3. Enable WLED output and play audio/drums
4. Record for 10 seconds
5. Stop recording and analyze:
   - Canvas FPS (target: 60fps)
   - WLED update frequency (target: 30+ fps)
   - WebSocket message rate
   - No dropped frames or lag spikes
6. Test on mobile device (network WebSocket connection)

**Regression Testing:**
1. Navigate to `/dj-visualizer`
2. Test waveform mode (verify no visual regression)
3. Test ripple mode (verify no visual regression)
4. Test WLED settings panel (IP address, matrix size, orientation)
5. Verify standalone mode works exactly as before (with enhancements)
6. Navigate to Education Mode lesson 1 (verify no impact on step sequencer)
7. Navigate to Education Mode lesson 3 (verify no impact on step sequencer)

[Source: CLAUDE.md#quality-assurance, docs/architecture/testing-strategy.md]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Initial story creation | Sarah (Product Owner) |

---

## Dev Agent Record

_This section will be populated during implementation._

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes
_To be filled by dev agent_

### File List
_Files created/modified:_
-

---

## QA Results

_This section will be populated after QA review._
