# Story 17.1: Delta-Based Drum State Sync

## Status
PLANNING

## Story
**As a** remote jam session participant (iPad @ jam.audiolux.app),
**I want** my drum pattern edits to sync to local devices with WLED in real-time,
**so that** I can see my beats trigger LED strips on the local network without needing direct WLED access.

## Epic Context
Epic 17: Remote WLED Control via Jam Sessions
- **Architecture:** [remote-wled-state-sync.md](../architecture/remote-wled-state-sync.md)
- **Epic Document:** [epic-17-remote-wled-state-sync.md](../epics/epic-17-remote-wled-state-sync.md)

## Acceptance Criteria
1. `broadcastDrumStep()` method added to `supabaseSessionService` with signature: `{ track: number, step: number, enabled: boolean, velocity: number }`
2. `onDrumStep()` subscription handler added to `supabaseSessionService`
3. DrumMachine component broadcasts step changes only (not full pattern) on every step toggle
4. 50ms debouncing implemented for rapid edits to prevent message flooding
5. Remote step toggle appears on local device within 500ms (Supabase Broadcast latency: 50-150ms typical)
6. Zero network traffic during playback loops (pattern loops locally, no broadcasts)
7. Bandwidth <5 KB/min per active editor (measured via DevTools Network â†’ WS tab)
8. Pattern state synchronized across all session participants (2+ devices tested)

## Technical Approach

### Extend supabaseSessionService
**File:** `src/services/supabaseSession.ts`

Add new broadcast/subscribe methods following existing pattern:

```typescript
// NEW: Delta-based drum state sync
broadcastDrumStep(data: {
  track: number;    // Track index (0-7)
  step: number;     // Step index (0-15)
  enabled: boolean; // Step on/off
  velocity: number; // 0-100 (uint8 future)
}): Promise<void> {
  if (!this.channel) return;

  await this.channel.send({
    type: 'broadcast',
    event: 'drum-step',
    payload: data
  });
}

onDrumStep(callback: (data: DrumStepEvent) => void): () => void {
  if (!this.channel) return () => {};

  const handler = (payload: any) => {
    if (payload.type === 'broadcast' && payload.event === 'drum-step') {
      callback(payload.payload);
    }
  };

  this.channel.on('broadcast', handler);

  return () => {
    this.channel?.off('broadcast', handler);
  };
}
```

### DrumMachine Component Integration
**File:** `src/components/DrumMachine/DrumMachine.tsx`

Broadcast step changes:

```typescript
// Broadcast step toggle to session
const handleStepToggle = (trackId: string, stepIndex: number) => {
  setTracks(prev =>
    prev.map((track) =>
      track.id === trackId
        ? { ...track, steps: track.steps.map((s, i) => (i === stepIndex ? !s : s)) }
        : track
    )
  );

  // NEW: Broadcast to session (debounced)
  if (supabaseSessionService.isInSession()) {
    const trackIndex = tracks.findIndex(t => t.id === trackId);
    const enabled = !tracks[trackIndex].steps[stepIndex];
    const velocity = tracks[trackIndex].velocities[stepIndex];

    debouncedBroadcastStep({ track: trackIndex, step: stepIndex, enabled, velocity });
  }
};

// Subscribe to remote step changes
useEffect(() => {
  const unsubscribe = supabaseSessionService.onDrumStep(({ track, step, enabled, velocity }) => {
    setTracks(prev =>
      prev.map((t, i) =>
        i === track
          ? {
              ...t,
              steps: t.steps.map((s, idx) => (idx === step ? enabled : s)),
              velocities: t.velocities.map((v, idx) => (idx === step ? velocity / 100 : v))
            }
          : t
      )
    );
  });

  return unsubscribe;
}, []);
```

### Debouncing Implementation

```typescript
import { debounce } from 'lodash';

const debouncedBroadcastStep = useMemo(
  () =>
    debounce((data: DrumStepEvent) => {
      supabaseSessionService.broadcastDrumStep(data);
    }, 50), // 50ms window
  []
);
```

## Dependencies
- **Epic 7 Complete:** `supabaseSessionService` exists with broadcast/subscribe patterns
- **DrumMachine Component:** Already integrated with GlobalMusicContext

## Integration Points
- `src/services/supabaseSession.ts` - Extend with new methods
- `src/components/DrumMachine/DrumMachine.tsx` - Add broadcasting
- `src/components/JamSession/JamSession.tsx` - Already manages drum state
- Existing pattern: `broadcastTempo()`, `onTempoChange()` (Epic 7)

## Testing Strategy

### Manual Verification Steps
1. **Setup:** Two devices in same jam session
   - Device A: iPad @ jam.audiolux.app (remote)
   - Device B: Desktop with WLED configured (local)

2. **Step Toggle Sync:**
   - Device A: Toggle drum step (kick, step 0)
   - Device B: Verify step appears within 500ms
   - Both devices: Pattern should match

3. **Rapid Edit Debouncing:**
   - Device A: Rapidly toggle 10 steps in 1 second
   - DevTools: Verify <10 messages sent (debouncing working)
   - Device B: Verify all steps appear (no data loss)

4. **Playback Loop (Zero Traffic):**
   - Start playback on both devices
   - DevTools â†’ Network â†’ WS tab
   - Verify zero messages during 1-minute loop
   - Only messages on step toggle during playback

5. **Bandwidth Monitoring:**
   - Device A: Edit pattern for 1 minute (60 edits)
   - DevTools â†’ Network â†’ WS tab
   - Measure total bytes sent
   - Verify <5 KB (Target: ~70 bytes per edit Ã— 60 = ~4.2 KB JSON)

### Performance Metrics
- State sync latency: <500ms (Supabase Broadcast: 50-150ms typical)
- Bandwidth per edit: ~70 bytes JSON (~7 bytes future binary)
- Message rate: <20 messages/min per active editor (with 50ms debouncing)

## Dev Notes

### Relevant Source Tree
- **Supabase Service:** `src/services/supabaseSession.ts`
- **DrumMachine Component:** `src/components/DrumMachine/DrumMachine.tsx`
- **JamSession Component:** `src/components/JamSession/JamSession.tsx`
- **Type Definitions:** `src/types/index.ts` (DrumTrack interface)

### Message Format (JSON MVP)
```typescript
// Drum step toggle event
{
  type: 'broadcast',
  event: 'drum-step',
  payload: {
    track: 0,        // uint8 (0-7)
    step: 7,         // uint8 (0-15)
    enabled: true,   // boolean
    velocity: 80     // uint8 (0-100)
  }
}
// Size: ~70 bytes JSON (target: 7 bytes binary in Epic 18+)
```

### Bandwidth Calculation
- Per step toggle: ~70 bytes (JSON)
- Active editing: 60 edits/min â†’ 4.2 KB/min
- 4 users editing: ~17 KB/min
- 1 hour session: ~1 MB (well under 500 KB target if not all users editing constantly)

## Future Enhancements (Epic 18+)
- Binary message format (Uint8Array): 70 bytes â†’ 7 bytes (90% reduction)
- Track indices instead of IDs (eliminate string overhead)
- Message compression for complex patterns

## Story Manager Notes
- Follow existing broadcast/subscribe pattern from Epic 7
- No breaking changes to `supabaseSessionService` API
- DrumMachine component enhanced (not replaced)
- Natural integration with JamSession (already manages DrumMachine state)

---

**Story Created:** 2025-10-18
**Product Owner:** Sarah ðŸ“
**Estimate:** 4-5 hours
**Priority:** ðŸ”´ HIGH
