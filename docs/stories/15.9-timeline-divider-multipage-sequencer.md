# Story 15.9: Timeline Divider & Multi-Page Melody Sequencer

**Epic**: Epic 15 - Chord Progression & Melody Arranger Module
**Story Type**: Brownfield Enhancement (Small)
**Estimated Effort**: Single session (~2-3 hours)
**Dependencies**: Story 15.3 (MelodySequencer implementation)

---

## User Story

**As a** composer creating melodic patterns in the ChordMelodyArranger module
**I want** adjustable timeline divider settings and multi-page sequencer support (up to 64 steps)
**So that** I can control loop pacing independently from step count and create longer, more complex melodic phrases

---

## Context

The current MelodySequencer implementation has a fixed 16-step grid that loops based on the `barCount` setting (4, 8, or 16 bars). This creates very slow playback when set to 8 bars (2 beats per step at 120 BPM = 1 second per step).

**Current Limitations**:
- `barCount` controls both loop length AND step duration
- Only 16 programmable steps limits melodic complexity
- No way to create longer phrases without extremely slow playback

**Proposed Enhancement**:
- Rename `barCount` → `timelineDivider` (semantic clarity)
- Decouple loop speed from step count (divider = 1/2, 1, 2, 4 bars)
- Extend sequencer to 4 pages × 16 steps = 64 programmable steps
- Add intuitive page navigation UI

---

## Acceptance Criteria

### 1. Timeline Divider Settings
- [ ] Rename `barCount` state variable to `timelineDivider` in ChordMelodyArranger.tsx
- [ ] Update settings panel UI to show "Timeline Divider" instead of "Timeline Length"
- [ ] Support divider options: `0.5` (1/2 bar), `1` (1 bar), `2` (2 bars), `4` (4 bars)
- [ ] Display options as: "1/2 bar", "1 bar", "2 bars", "4 bars"
- [ ] Default to `1` bar (16th note resolution at 120 BPM)

### 2. Multi-Page Sequencer Data Model
- [ ] Extend `MelodyNote` interface to support `step: 0-63` (currently 0-15)
- [ ] Update `placedNotes` state to handle 64 steps
- [ ] Preserve existing 16-step functionality when only page 1 is used

### 3. Page Navigation UI (MelodySequencer)
- [ ] Add page selector above sequencer grid: buttons labeled "1", "2", "3", "4"
- [ ] Highlight active page (user-selected view)
- [ ] Show which pages contain programmed notes (visual indicator)
- [ ] Smooth transition when switching pages (instant grid update)

### 4. Visual Playback Indicator
- [ ] Show current playback page during transport (visual cue when playback reaches page 2/3/4)
- [ ] Automatically switch visible page to match playback position (optional UX enhancement)
- [ ] Maintain white border on current step across all pages

### 5. Playback Logic Updates
- [ ] Calculate total loop duration: `timelineDivider × (60 / tempo) × 4` seconds
- [ ] Map playback position (0-1) to step index (0-63)
- [ ] Trigger notes from all pages during loop, not just visible page
- [ ] Respect page boundaries for visual feedback

---

## Technical Implementation Notes

### Files to Modify

#### 1. `src/components/Studio/modules/ChordMelodyArranger/ChordMelodyArranger.tsx`

**Changes**:
- Rename `barCount` → `timelineDivider` (state variable, prop passing)
- Update settings panel UI:
  ```tsx
  <label className="block text-xs text-gray-400 mb-1">Timeline Divider</label>
  <div className="flex gap-2">
    {[0.5, 1, 2, 4].map((divider) => (
      <button
        key={divider}
        onClick={() => setTimelineDivider(divider)}
        className={/* active state styling */}
      >
        {divider === 0.5 ? '1/2 bar' : `${divider} bar${divider > 1 ? 's' : ''}`}
      </button>
    ))}
  </div>
  ```

- Update playback loop calculation:
  ```tsx
  const secondsPerBar = 4 / (tempo / 60);
  const totalDuration = timelineDivider * secondsPerBar;
  ```

- Pass `timelineDivider` to MelodySequencer:
  ```tsx
  <MelodySequencer
    timelineDivider={timelineDivider}
    // ... other props
  />
  ```

#### 2. `src/components/Studio/modules/ChordMelodyArranger/MelodySequencer.tsx`

**Changes**:

**Add page navigation state**:
```tsx
const [currentPage, setCurrentPage] = useState<number>(0); // 0-3 (pages 1-4)
const STEPS_PER_PAGE = 16;
const TOTAL_PAGES = 4;
```

**Update visible steps calculation**:
```tsx
const visibleSteps = useMemo(() => {
  const startStep = currentPage * STEPS_PER_PAGE;
  return Array.from({ length: STEPS_PER_PAGE }, (_, i) => startStep + i);
}, [currentPage]);
```

**Add page indicator UI** (above sequencer grid):
```tsx
<div className="flex items-center gap-2 mb-3">
  <span className="text-xs text-gray-400">Page:</span>
  {Array.from({ length: TOTAL_PAGES }, (_, i) => {
    const hasNotes = placedNotes.some(note =>
      note.step >= i * STEPS_PER_PAGE && note.step < (i + 1) * STEPS_PER_PAGE
    );
    const isPlayingPage = Math.floor((playbackPosition * 64) % 64 / STEPS_PER_PAGE) === i;

    return (
      <button
        key={i}
        onClick={() => setCurrentPage(i)}
        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
          currentPage === i
            ? 'bg-primary-600 text-white'
            : hasNotes
            ? 'bg-gray-700 text-white hover:bg-gray-600'
            : 'bg-gray-800 text-gray-400 hover:bg-gray-700'
        } ${isPlayingPage ? 'ring-2 ring-green-500' : ''}`}
      >
        {i + 1}
      </button>
    );
  })}
</div>
```

**Update playback logic**:
```tsx
useEffect(() => {
  if (!isPlaying) return;

  const beatsPerSecond = tempo / 60;
  const secondsPerBar = 4 / beatsPerSecond;
  const totalDuration = timelineDivider * secondsPerBar;
  const totalSteps = 64; // 4 pages × 16 steps

  let startTime = performance.now();
  let animationFrame: number;

  const updatePosition = () => {
    const elapsed = (performance.now() - startTime) / 1000;
    const loopPosition = (elapsed % totalDuration) / totalDuration; // 0-1
    const currentStep = Math.floor(loopPosition * totalSteps); // 0-63

    // Find notes at current step
    const notesToPlay = placedNotes.filter(note => note.step === currentStep);
    notesToPlay.forEach(note => {
      onNoteEvent(note); // Trigger MIDI/routing
    });

    // Update visual playback position (for page indicator)
    setPlaybackPosition(loopPosition);

    animationFrame = requestAnimationFrame(updatePosition);
  };

  updatePosition();

  return () => {
    if (animationFrame) cancelAnimationFrame(animationFrame);
  };
}, [isPlaying, tempo, timelineDivider, placedNotes, onNoteEvent]);
```

**Update cell click handler** (add page offset):
```tsx
const handleCellClick = (step: number, pitch: number) => {
  const absoluteStep = currentPage * STEPS_PER_PAGE + step;
  const existingNoteIndex = placedNotes.findIndex(
    note => note.step === absoluteStep && note.pitch === pitch
  );

  if (existingNoteIndex >= 0) {
    // Remove note
    setPlacedNotes(prev => prev.filter((_, i) => i !== existingNoteIndex));
  } else {
    // Add note
    setPlacedNotes(prev => [...prev, {
      step: absoluteStep,
      pitch,
      velocity: 100,
      duration: 0.25, // 16th note duration
    }]);
  }
};
```

---

## Manual Verification Steps

### 1. Timeline Divider Settings
- [ ] Open ChordMelodyArranger module
- [ ] Click settings cog, verify "Timeline Divider" label
- [ ] Select "1/2 bar" → sequencer loops quickly (8th note steps at 120 BPM)
- [ ] Select "1 bar" → sequencer loops at 16th note speed (current behavior)
- [ ] Select "2 bars" → sequencer loops slower (32nd note steps)
- [ ] Select "4 bars" → sequencer loops very slow (64th note steps)

### 2. Multi-Page Navigation
- [ ] Place notes on page 1 → button shows "active" state (colored background)
- [ ] Click page 2 button → grid updates to show empty page
- [ ] Place notes on page 2 → page 2 button shows "active" state
- [ ] Switch between pages → notes persist correctly
- [ ] Delete all notes on page 2 → button returns to "empty" state

### 3. Playback Across Pages
- [ ] Place notes on pages 1, 2, and 3
- [ ] Start playback → verify notes trigger from all pages
- [ ] Watch page indicators → current playback page shows green ring
- [ ] Verify loop wraps correctly from page 4 back to page 1

### 4. Integration with Output Routing
- [ ] Route MelodySequencer to Piano Roll module
- [ ] Place notes on all 4 pages
- [ ] Start playback → verify Piano Roll lights up for all 64 steps

### 5. Timeline Divider + Multi-Page Interaction
- [ ] Create 64-step melody (notes on all 4 pages)
- [ ] Set divider to "1/2 bar" → verify fast loop (2 seconds at 120 BPM)
- [ ] Set divider to "4 bars" → verify slow loop (16 seconds at 120 BPM)
- [ ] Verify tempo changes affect playback speed correctly

---

## Non-Goals (Future Enhancements)

- **Variable step count per page** - All pages remain 16 steps
- **Copy/paste between pages** - Manual note entry only
- **Swing/groove quantization** - Straight 16th note timing only
- **Per-page settings** - Global settings apply to all pages

---

## Documentation Updates

### File: `docs/epics/epic-15-chord-melody-arranger.md`

**Add to Story 15.9 section**:
```markdown
## Story 15.9: Timeline Divider & Multi-Page Melody Sequencer

**Objective**: Decouple loop speed from step count and extend sequencer to 64 programmable steps.

**Key Features**:
- Timeline divider settings (1/2, 1, 2, 4 bars) control loop speed
- Multi-page sequencer (4 pages × 16 steps = 64 steps)
- Visual page navigation with playback indicators
- Notes persist across pages during playback

**Files Modified**:
- `ChordMelodyArranger.tsx` - Timeline divider settings
- `MelodySequencer.tsx` - Page navigation + 64-step support
```

---

## Dependencies & Integration Points

### Upstream Dependencies
- **Story 15.3**: MelodySequencer component exists with 16-step grid
- **Story 15.5**: GlobalMusicContext provides tempo for playback calculations
- **Story 15.7**: Harmonic guidance system works with current chord context

### Downstream Impact
- **Story 15.4**: Module routing system remains unchanged (note events still fire)
- **Future melody presets**: Will need to support 64-step patterns

---

## Risk Assessment

**Low Risk** - This is a straightforward enhancement with clear scope boundaries.

**Potential Issues**:
1. **Performance**: 64 notes + harmonic guidance calculations may be expensive
   - Mitigation: Use `useMemo` for brightness calculations, only compute visible page

2. **UX Confusion**: Users may forget notes exist on other pages
   - Mitigation: Visual indicators on page buttons (show which pages have notes)

3. **Playback Timing**: Edge cases in loop wrapping logic
   - Mitigation: Thorough manual testing with different divider settings

---

## Success Metrics

- [ ] Timeline divider settings function correctly at all tempo values
- [ ] All 4 pages support independent note programming
- [ ] Playback triggers notes from all 64 steps in sequence
- [ ] Page navigation is intuitive (< 5 seconds to understand)
- [ ] No performance degradation with 64 notes placed

---

**Story Status**: READY FOR IMPLEMENTATION
**Created**: 2025-10-14
**Last Updated**: 2025-10-14
