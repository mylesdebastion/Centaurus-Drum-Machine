# Story 17.3: Full Pattern Sync & LED Integration

## Status
BLOCKED - Epic 18 Dependency

## Story
**As a** jam session participant,
**I want** full drum patterns to sync when loading presets or joining sessions,
**so that** all participants start with the same pattern and remote devices can trigger local WLED hardware.

## Epic Context
Epic 17: Remote WLED Control via Jam Sessions
- **Architecture:** [remote-wled-state-sync.md](../architecture/remote-wled-state-sync.md)
- **Epic Document:** [epic-17-remote-wled-state-sync.md](../epics/epic-17-remote-wled-state-sync.md)

## ⚠️ CRITICAL DEPENDENCY

**Status:** BLOCKED until Epic 18 Stories 18.1-18.6 complete

**Reason:** Story 17.3 requires intelligent WLED routing system for proper remote LED control. The current approach (simple `WLEDDeviceManager`) is insufficient for the goals of this story.

**What's Blocking:**
1. **Device Registry** - Need Supabase-backed persistent storage (Story 18.1)
2. **Routing System** - Need intelligent module-to-device matching (Story 18.3)
3. **Unified Manager** - Need WLED Manager UI for device configuration (Story 18.5)
4. **LEDCompositor Integration** - Need routing-aware compositor (Story 18.6)

**Why Epic 18 First:**
- Acceptance Criterion #7: "Remote device (iPad) successfully controls local WLED hardware"
  - **Requires:** Shared device registry (Supabase) so iPad and Desktop see same devices
  - **Requires:** Intelligent routing so DrumMachine automatically uses appropriate LEDs
- Acceptance Criterion #9: "Natural bridge behavior: devices with WLED output automatically"
  - **Requires:** Routing matrix to detect capabilities and route accordingly
  - **Requires:** Zero manual configuration (Epic 18 core goal)

**Unblock Criteria:**
- ✅ Epic 18 Story 18.1 complete (Device Registry)
- ✅ Epic 18 Story 18.3 complete (Routing Matrix)
- ✅ Epic 18 Story 18.5 complete (WLED Manager UI)
- ✅ Epic 18 Story 18.6 complete (LEDCompositor Integration)

**See:** [Epic 18: Intelligent WLED Visualization Routing](../epics/epic-18-intelligent-wled-routing.md)

## Acceptance Criteria
1. `broadcastDrumPattern()` method added to `supabaseSessionService` for full pattern reset
2. `onDrumPatternReset()` subscription handler added to `supabaseSessionService`
3. Full pattern broadcast sent only on initial session join and "Load Default Pattern" button
4. Full pattern broadcast <2 KB (8 tracks × 16 steps + metadata)
5. Full pattern sent <5 times per jam session (initial load, preset changes only)
6. Loading default pattern syncs to all devices (verified with 2+ devices)
7. Remote device (iPad @ jam.audiolux.app) successfully controls local WLED hardware
8. Bandwidth <500 KB per 1-hour jam session (measured via DevTools)
9. Natural "bridge" behavior: devices with WLED output automatically, no special mode needed

## Technical Approach

### Extend supabaseSessionService
**File:** `src/services/supabaseSession.ts`

Add full pattern sync for rare full-state updates:

```typescript
// NEW: Full pattern reset (sent rarely)
broadcastDrumPattern(tracks: DrumTrack[]): Promise<void> {
  if (!this.channel) return;

  // Serialize full pattern state
  const payload = tracks.map(track => ({
    id: track.id,
    steps: track.steps,           // 16 booleans
    velocities: track.velocities, // 16 floats (0-1)
    muted: track.muted,
    solo: track.solo,
    volume: track.volume
  }));

  await this.channel.send({
    type: 'broadcast',
    event: 'drum-pattern-reset',
    payload: { tracks: payload }
  });
}

onDrumPatternReset(callback: (tracks: DrumTrack[]) => void): () => void {
  if (!this.channel) return () => {};

  const handler = (payload: any) => {
    if (payload.type === 'broadcast' && payload.event === 'drum-pattern-reset') {
      callback(payload.payload.tracks);
    }
  };

  this.channel.on('broadcast', handler);

  return () => {
    this.channel?.off('broadcast', handler);
  };
}
```

### DrumMachine Component Integration
**File:** `src/components/DrumMachine/DrumMachine.tsx`

Broadcast on pattern load:

```typescript
const handleLoadDefaultPattern = () => {
  const defaultPattern = createDefaultPattern();
  setTracks(defaultPattern);

  // NEW: Broadcast full pattern to session
  if (supabaseSessionService.isInSession()) {
    supabaseSessionService.broadcastDrumPattern(defaultPattern);
  }
};

// Subscribe to remote pattern resets
useEffect(() => {
  const unsubscribe = supabaseSessionService.onDrumPatternReset((remoteTracks) => {
    setTracks(remoteTracks); // Apply full pattern from remote
  });

  return unsubscribe;
}, []);
```

### Initial Session Join
**File:** `src/components/JamSession/JamSession.tsx`

Broadcast current pattern when first participant joins:

```typescript
useEffect(() => {
  if (participants.length === 1 && tracks.length > 0) {
    // First participant joined, broadcast initial pattern
    supabaseSessionService.broadcastDrumPattern(tracks);
  }
}, [participants.length]);
```

### LED Integration (Natural Bridge)
**File:** `src/components/DrumMachine/DrumMachine.tsx`

LED frames already generated on all devices, compositor sends to WLED if available:

```typescript
// EXISTING: LED frame generation (no changes needed)
const generateLEDFrame = (stepIndex: number, track: DrumTrack) => {
  if (!track.steps[stepIndex]) return; // Step not active

  const note = track.midiNote;
  const color = getNoteColor(note, music.colorMode, music.key, music.scale);

  const frame: LEDFrame = {
    moduleId: 'drum-machine',
    deviceId: music.hardware.wled.activeDeviceId,
    pixelData: new Uint8ClampedArray([color.r, color.g, color.b])
  };

  // Submit to compositor (EXISTING)
  ledCompositor.submitFrame(frame);

  // Compositor automatically sends to WLED if device configured
  // Remote devices: Generate frames but no WLED output (no devices configured)
  // Local device: Generate frames AND output to WLED (devices configured)
};
```

## Dependencies

### Prerequisite Stories
- ✅ **Story 17.1 Complete:** Delta-based drum state sync working
- ✅ **Story 17.2 Complete:** Client-side color derivation working
- ✅ **Epic 14 Complete:** LEDCompositor service exists

### Epic 18 Dependencies (BLOCKING)
- ⏳ **Story 18.1:** WLED Device Registry (Supabase Backend) - REQUIRED
- ⏳ **Story 18.2:** Module Capability Declaration System - REQUIRED
- ⏳ **Story 18.3:** Visualization Routing Matrix - REQUIRED
- ⏳ **Story 18.5:** WLED Manager UI (Unified Component) - REQUIRED
- ⏳ **Story 18.6:** LEDCompositor Integration & Module Migration - REQUIRED

**Sequencing:** Implement Epic 18 Stories 18.1-18.6 **before** Story 17.3

## Integration Points
- `src/services/supabaseSession.ts` - Add full pattern sync
- `src/components/DrumMachine/DrumMachine.tsx` - Broadcast on pattern load
- `src/components/JamSession/JamSession.tsx` - Initial pattern broadcast
- `src/services/LEDCompositor.ts` - EXISTING, no changes needed
- `src/contexts/GlobalMusicContext.tsx` - WLED devices already managed

## Testing Strategy

### Manual Verification Steps

**Test 1: Full Pattern Sync**
1. Setup: Two devices in same jam session
   - Device A: iPad @ jam.audiolux.app (remote)
   - Device B: Desktop (local, no WLED yet)
2. Device A: Click "Load Default Pattern" button
3. Device B: Verify pattern appears within 500ms
4. Both devices: Patterns should match exactly

**Test 2: Initial Session Join**
1. Device A: Create jam session with custom pattern
2. Device B: Join session with code
3. Device B: Verify receives initial pattern on join
4. Both devices: Patterns match

**Test 3: Remote WLED Control (Epic Goal)**
1. Setup: Two devices in same jam session
   - Device A: iPad @ jam.audiolux.app (remote, no WLED)
   - Device B: Desktop with WLED configured (local)
2. Device A: Toggle drum steps (kick, snare, hi-hat)
3. Device B: Verify pattern syncs (from Story 17.1)
4. Device B: Start playback
5. **WLED Hardware:** Verify LED strips light up on drum hits
6. Device A: Change colorMode to 'harmonic'
7. **WLED Hardware:** Verify LED colors update

**Test 4: Bandwidth Monitoring (1-Hour Session)**
1. Setup: 4 devices in jam session
2. Simulate active editing:
   - Each user: 20 step toggles over 1 hour
   - Pattern load: 2 times per user
   - ColorMode changes: 3 times total
3. DevTools → Network → WS tab:
   - Measure total bytes sent/received
   - Target: <500 KB per device
   - Expected: ~330 KB (79x better than naive 26 MB)

**Test 5: Natural Bridge Behavior**
1. Device A: iPad (no WLED devices configured)
   - Verify: LED frames generated (local state)
   - Verify: No WLED output (no devices configured)
   - DevTools: No WebSocket errors
2. Device B: Desktop (WLED device configured)
   - Verify: LED frames generated (local state)
   - Verify: WLED output working (devices configured)
   - WLED Hardware: Lights respond to pattern
3. No special "bridge mode" UI or settings needed

### Performance Metrics
- Full pattern sync latency: <500ms
- Full pattern message size: <2 KB (8 tracks × ~250 bytes)
- Bandwidth per 1-hour jam: <500 KB target
- LED generation latency: <1ms (local processing)

## Dev Notes

### Relevant Source Tree
- **Supabase Service:** `src/services/supabaseSession.ts`
- **DrumMachine Component:** `src/components/DrumMachine/DrumMachine.tsx`
- **JamSession Component:** `src/components/JamSession/JamSession.tsx`
- **LED Compositor:** `src/services/LEDCompositor.ts` (EXISTING)
- **GlobalMusicContext:** `src/contexts/GlobalMusicContext.tsx` (EXISTING)
- **Color Mapping:** `src/utils/colorMapping.ts` (EXISTING)

### Message Format (JSON MVP)

```typescript
// Full pattern reset event
{
  type: 'broadcast',
  event: 'drum-pattern-reset',
  payload: {
    tracks: [
      {
        id: 'kick',
        steps: [true, false, true, false, ...], // 16 booleans
        velocities: [0.8, 0.0, 0.8, 0.0, ...],  // 16 floats
        muted: false,
        solo: false,
        volume: 0.8
      },
      // ... 7 more tracks
    ]
  }
}
// Size: ~1.5-2 KB JSON (8 tracks × ~214 bytes)
```

### Bandwidth Analysis (1-Hour Session, 4 Users)

| Event Type | Per Message | Frequency | Total |
|------------|-------------|-----------|-------|
| Step toggles | 70 bytes | 80 total (20/user × 4) | 5.6 KB |
| Full pattern | 2 KB | 8 (2/user × 4) | 16 KB |
| ColorMode | 30 bytes | 3 total | 90 bytes |
| Tempo/Key/Scale | 50 bytes | ~10 total | 500 bytes |
| **Total** | - | - | **~22 KB** |

**Result:** Well under 500 KB target (~98% under budget)

### Natural Bridge Detection Logic

```typescript
// EXISTING: GlobalMusicContext
const hasWLEDDevices = music.hardware.wled.devices.length > 0;

// LED frame generation happens on ALL devices
generateLEDFrame(stepIndex, track);
ledCompositor.submitFrame(frame);

// Compositor automatically outputs if WLED configured
// src/services/LEDCompositor.ts (EXISTING CODE):
if (hasWLEDDevices && music.hardware.wled.activeDeviceId) {
  sendToWLED(compositedFrame); // Only local device does this
}
```

**No special "bridge mode" needed** - natural behavior via existing configuration.

## Future Enhancements (Epic 18+)
- Multi-module pattern sync (Piano Roll, IsometricSequencer)
- Pattern presets library (save/load custom patterns)
- Session recording/playback (save full jam session state)
- Binary message format (2 KB → ~200 bytes for pattern)

## Story Manager Notes
- Completes Epic 17 MVP (Stories 17.1-17.3)
- Validates full remote WLED control architecture
- Natural integration - no new "bridge" infrastructure
- LED output works via existing LEDCompositor (Epic 14)
- WLED device management via existing GlobalMusicContext
- Ready for Epic 18+ (multi-module, binary optimization)

---

**Story Created:** 2025-10-18
**Product Owner:** Sarah 📝
**Estimate:** 3-4 hours
**Priority:** 🟡 MEDIUM
