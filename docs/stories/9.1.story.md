# Story 9.1: Web MIDI Input Engine

**Epic:** Multi-Instrument MIDI Visualization (Epic 9)
**Status:** COMPLETE
**Priority:** üî• **HIGH** (Foundation Story)
**Complexity:** Medium
**Prerequisites:** None (this is the foundation)

---

## Story

**As a** musician with a MIDI keyboard or guitar MIDI pickup,
**I want** the web app to recognize my MIDI device and capture live note input,
**so that** I can play instruments (piano, guitar) with visual feedback and WLED output.

---

## Background / Context

### Current State
- ‚ùå **No MIDI input support** - App cannot receive MIDI messages
- ‚ùå **No device enumeration** - Cannot list or select MIDI devices
- ‚úÖ **Audio playback works** - Tone.js engine ready (audioEngine.ts)
- ‚úÖ **Frequency visualization ready** - FrequencySourceManager can consume MIDI notes

### Python Proof-of-Concept
Both `research/wled-piano-roll-pygame.py` and `research/wled-guitar-fretboard-pygame.0.4.py` use **mido** library for MIDI:
- MIDI device enumeration
- Device selection cycling (press 'M' to switch)
- Real-time MIDI message parsing
- Note on/off handling
- Thread-based MIDI listener

**Challenge:** Port this functionality to **Web MIDI API** for browser environment.

### Web MIDI API Overview
**Browser Support:**
- ‚úÖ Chrome/Edge (full support)
- ‚úÖ Firefox (requires `dom.webmidi.enabled` flag)
- ‚ùå Safari (no support yet)

**API Features:**
- `navigator.requestMIDIAccess()` - Request permission
- `MIDIAccess.inputs` - List available MIDI devices
- `MIDIInput.onmidimessage` - Receive MIDI messages
- `onstatechange` - Device hot-plug detection

---

## Acceptance Criteria

### AC 1: MIDI Device Detection & Selection ‚úÖ
- [ ] Enumerate all connected MIDI devices on page load
- [ ] Display device list in dropdown/selector UI
- [ ] Show device metadata: name, manufacturer, connection state
- [ ] User can select active MIDI input device
- [ ] Hot-plug detection: New devices appear automatically
- [ ] Hot-unplug detection: Disconnected devices removed from list
- [ ] Handle "no devices connected" state gracefully

### AC 2: MIDI Message Parsing ‚úÖ
- [ ] Parse **Note On** messages (0x90 + note + velocity)
- [ ] Parse **Note Off** messages (0x80 or 0x90 with velocity=0)
- [ ] Extract note number (0-127) and velocity (0-127)
- [ ] Ignore irrelevant MIDI messages (CC, pitch bend, etc. for now)
- [ ] Log MIDI messages to console (for debugging)
- [ ] Display last received MIDI message in UI

### AC 3: Event System (Publish/Subscribe) ‚úÖ
- [ ] Implement listener registration: `addListener(callback)`
- [ ] Implement listener removal: `removeListener(callback)`
- [ ] Notify all listeners when note on/off received
- [ ] Event payload includes: `{ type: 'noteOn' | 'noteOff', note: number, velocity: number }`
- [ ] Multiple components can subscribe simultaneously (e.g., Piano + Visualizer)

### AC 4: Integration with FrequencySourceManager ‚úÖ
- [ ] Automatically send MIDI notes to FrequencySourceManager (Story 4.1)
- [ ] Call `frequencySourceManager.addMidiNote(note, velocity)` on Note On
- [ ] MIDI notes appear in DJ Visualizer frequency display
- [ ] Works seamlessly with existing drum machine integration

### AC 5: Keyboard Fallback Mode ‚úÖ
- [ ] Implement QWERTY keyboard ‚Üí MIDI note mapping (for testing without hardware)
- [ ] Map keys: `A=C4, W=C#4, S=D4, E=D#4, D=E4, F=F4, T=F#4, G=G4, Y=G#4, H=A4, U=A#4, J=B4, K=C5`
- [ ] Toggle keyboard fallback mode via checkbox
- [ ] Keyboard events trigger same listeners as real MIDI
- [ ] Show keyboard map hint when fallback enabled

### AC 6: Tone.js Audio Integration ‚úÖ
- [ ] Trigger Tone.js instruments when MIDI notes received
- [ ] Use `Tone.PolySynth` for testing (piano-like sound)
- [ ] Respect velocity (MIDI velocity ‚Üí volume)
- [ ] Proper note off handling (release notes)
- [ ] Audio latency <50ms (MIDI ‚Üí sound)

### AC 7: UI Component (MIDIDeviceSelector) ‚úÖ
- [ ] Dropdown shows available MIDI devices
- [ ] Selected device highlighted
- [ ] Connection status indicator (üü¢ connected, üî¥ disconnected)
- [ ] "Refresh devices" button
- [ ] Keyboard fallback toggle
- [ ] Last MIDI message display (for debugging)
- [ ] Responsive: Works on mobile and desktop
- [ ] Follows UX_STANDARDS.md (Tailwind, 44px touch targets)

---

## Technical Specifications

### Core MIDI Manager (Singleton)

```typescript
// src/utils/midiInputManager.ts

export interface MIDIDevice {
  id: string;
  name: string;
  manufacturer: string;
  state: 'connected' | 'disconnected';
}

export interface MIDINoteMessage {
  type: 'noteOn' | 'noteOff';
  note: number;      // 0-127 (MIDI note number)
  velocity: number;  // 0-127 (0 = note off)
  timestamp: number; // DOMHighResTimeStamp
}

export type MIDINoteListener = (message: MIDINoteMessage) => void;

export class MIDIInputManager {
  private static instance: MIDIInputManager;
  private midiAccess: MIDIAccess | null = null;
  private activeInput: MIDIInput | null = null;
  private listeners: Set<MIDINoteListener> = new Set();
  private keyboardFallbackEnabled: boolean = false;
  private activeKeyboardNotes: Set<number> = new Set();

  private constructor() {}

  public static getInstance(): MIDIInputManager {
    if (!MIDIInputManager.instance) {
      MIDIInputManager.instance = new MIDIInputManager();
    }
    return MIDIInputManager.instance;
  }

  /**
   * Initialize Web MIDI API
   * Must be called with user gesture (button click)
   */
  public async initialize(): Promise<void> {
    if (this.midiAccess) {
      console.log('[MIDI] Already initialized');
      return;
    }

    try {
      // Request MIDI access (requires user gesture)
      this.midiAccess = await navigator.requestMIDIAccess();
      console.log('[MIDI] ‚úÖ Access granted');

      // Listen for device state changes
      this.midiAccess.onstatechange = this.handleStateChange;

      // Log available devices
      const devices = this.getDevices();
      console.log(`[MIDI] Found ${devices.length} device(s):`, devices);

    } catch (error) {
      console.error('[MIDI] ‚ùå Failed to initialize:', error);
      throw new Error('Web MIDI API not supported or permission denied');
    }
  }

  /**
   * Get list of available MIDI input devices
   */
  public getDevices(): MIDIDevice[] {
    if (!this.midiAccess) return [];

    return Array.from(this.midiAccess.inputs.values()).map(input => ({
      id: input.id!,
      name: input.name!,
      manufacturer: input.manufacturer || 'Unknown',
      state: input.state as 'connected' | 'disconnected'
    }));
  }

  /**
   * Select active MIDI input device
   */
  public selectDevice(deviceId: string): void {
    if (!this.midiAccess) {
      console.error('[MIDI] Cannot select device - not initialized');
      return;
    }

    const input = this.midiAccess.inputs.get(deviceId);
    if (!input) {
      console.error('[MIDI] Device not found:', deviceId);
      return;
    }

    // Disconnect previous device
    if (this.activeInput) {
      this.activeInput.onmidimessage = null;
      console.log('[MIDI] Disconnected from:', this.activeInput.name);
    }

    // Connect to new device
    this.activeInput = input;
    this.activeInput.onmidimessage = this.handleMIDIMessage;
    console.log('[MIDI] ‚úÖ Connected to:', input.name);
  }

  /**
   * Handle incoming MIDI messages
   */
  private handleMIDIMessage = (event: MIDIMessageEvent): void => {
    const [status, note, velocity] = event.data;
    const messageType = status & 0xF0; // Mask channel bits

    // Note On (0x90) with velocity > 0
    if (messageType === 0x90 && velocity > 0) {
      this.notifyListeners({
        type: 'noteOn',
        note,
        velocity,
        timestamp: event.timeStamp
      });
    }
    // Note Off (0x80) or Note On with velocity 0
    else if (messageType === 0x80 || (messageType === 0x90 && velocity === 0)) {
      this.notifyListeners({
        type: 'noteOff',
        note,
        velocity: 0,
        timestamp: event.timeStamp
      });
    }

    console.log('[MIDI]', messageType === 0x90 ? 'Note ON' : 'Note OFF', `note=${note}, velocity=${velocity}`);
  };

  /**
   * Handle MIDI device state changes (plug/unplug)
   */
  private handleStateChange = (event: MIDIConnectionEvent): void => {
    const port = event.port;
    console.log(`[MIDI] Device ${port.state}:`, port.name);

    // If active device disconnected, clear it
    if (port === this.activeInput && port.state === 'disconnected') {
      this.activeInput = null;
      console.warn('[MIDI] Active device disconnected');
    }
  };

  /**
   * Add listener for MIDI note events
   */
  public addListener(listener: MIDINoteListener): void {
    this.listeners.add(listener);
  }

  /**
   * Remove listener
   */
  public removeListener(listener: MIDINoteListener): void {
    this.listeners.delete(listener);
  }

  /**
   * Notify all listeners of MIDI event
   */
  private notifyListeners(message: MIDINoteMessage): void {
    // Notify registered listeners
    this.listeners.forEach(listener => {
      try {
        listener(message);
      } catch (error) {
        console.error('[MIDI] Listener error:', error);
      }
    });

    // Integrate with FrequencySourceManager (Story 4.1)
    if ((window as any).frequencySourceManager) {
      if (message.type === 'noteOn') {
        (window as any).frequencySourceManager.addMidiNote(
          message.note,
          message.velocity / 127
        );
      }
    }
  }

  /**
   * Enable QWERTY keyboard fallback mode
   */
  public enableKeyboardFallback(): void {
    if (this.keyboardFallbackEnabled) return;

    this.keyboardFallbackEnabled = true;
    window.addEventListener('keydown', this.handleKeyDown);
    window.addEventListener('keyup', this.handleKeyUp);
    console.log('[MIDI] ‚úÖ Keyboard fallback enabled');
  }

  /**
   * Disable keyboard fallback mode
   */
  public disableKeyboardFallback(): void {
    if (!this.keyboardFallbackEnabled) return;

    this.keyboardFallbackEnabled = false;
    window.removeEventListener('keydown', this.handleKeyDown);
    window.removeEventListener('keyup', this.handleKeyUp);
    this.activeKeyboardNotes.clear();
    console.log('[MIDI] ‚ùå Keyboard fallback disabled');
  }

  private handleKeyDown = (event: KeyboardEvent): void => {
    if (event.repeat) return; // Ignore key repeat

    const note = this.keyToMIDINote(event.key);
    if (note !== null && !this.activeKeyboardNotes.has(note)) {
      this.activeKeyboardNotes.add(note);
      this.notifyListeners({
        type: 'noteOn',
        note,
        velocity: 100,
        timestamp: performance.now()
      });
    }
  };

  private handleKeyUp = (event: KeyboardEvent): void => {
    const note = this.keyToMIDINote(event.key);
    if (note !== null && this.activeKeyboardNotes.has(note)) {
      this.activeKeyboardNotes.delete(note);
      this.notifyListeners({
        type: 'noteOff',
        note,
        velocity: 0,
        timestamp: performance.now()
      });
    }
  };

  /**
   * Map QWERTY keyboard keys to MIDI notes
   * Layout: A W S E D F T G Y H U J K
   *         C C# D D# E F F# G G# A A# B C
   */
  private keyToMIDINote(key: string): number | null {
    const keyMap: { [key: string]: number } = {
      'a': 60, // C4 (middle C)
      'w': 61, // C#4
      's': 62, // D4
      'e': 63, // D#4
      'd': 64, // E4
      'f': 65, // F4
      't': 66, // F#4
      'g': 67, // G4
      'y': 68, // G#4
      'h': 69, // A4
      'u': 70, // A#4
      'j': 71, // B4
      'k': 72, // C5
      // Lower octave
      'z': 48, // C3
      'x': 50, // D3
      'c': 52, // E3
      'v': 53, // F3
      'b': 55, // G3
      'n': 57, // A3
      'm': 59, // B3
    };
    return keyMap[key.toLowerCase()] ?? null;
  }

  /**
   * Get MIDI note name (e.g., "C4", "A#5")
   */
  public static getNoteNameFromMIDI(midiNote: number): string {
    const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const noteName = noteNames[midiNote % 12];
    const octave = Math.floor(midiNote / 12) - 1;
    return `${noteName}${octave}`;
  }

  /**
   * Cleanup
   */
  public dispose(): void {
    if (this.activeInput) {
      this.activeInput.onmidimessage = null;
      this.activeInput = null;
    }
    this.listeners.clear();
    this.disableKeyboardFallback();
    this.midiAccess = null;
    console.log('[MIDI] Disposed');
  }
}

// Export singleton instance
export const midiInputManager = MIDIInputManager.getInstance();
```

---

### React Hook (useMIDIInput)

```typescript
// src/hooks/useMIDIInput.ts

import { useState, useEffect } from 'react';
import { midiInputManager, MIDIDevice, MIDINoteMessage } from '../utils/midiInputManager';

export const useMIDIInput = () => {
  const [devices, setDevices] = useState<MIDIDevice[]>([]);
  const [selectedDevice, setSelectedDevice] = useState<string | null>(null);
  const [lastMessage, setLastMessage] = useState<MIDINoteMessage | null>(null);
  const [isInitialized, setIsInitialized] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // Initialize MIDI on mount
  useEffect(() => {
    const init = async () => {
      try {
        await midiInputManager.initialize();
        setDevices(midiInputManager.getDevices());
        setIsInitialized(true);
      } catch (err) {
        setError(err instanceof Error ? err.message : 'MIDI initialization failed');
        setIsInitialized(false);
      }
    };

    init();

    return () => {
      midiInputManager.dispose();
    };
  }, []);

  // Listen for MIDI messages
  useEffect(() => {
    const handleMIDIMessage = (message: MIDINoteMessage) => {
      setLastMessage(message);
    };

    midiInputManager.addListener(handleMIDIMessage);

    return () => {
      midiInputManager.removeListener(handleMIDIMessage);
    };
  }, []);

  const selectDevice = (deviceId: string) => {
    midiInputManager.selectDevice(deviceId);
    setSelectedDevice(deviceId);
  };

  const refreshDevices = () => {
    setDevices(midiInputManager.getDevices());
  };

  return {
    devices,
    selectedDevice,
    selectDevice,
    refreshDevices,
    lastMessage,
    isInitialized,
    error
  };
};
```

---

### UI Component (MIDIDeviceSelector)

```tsx
// src/components/MIDI/MIDIDeviceSelector.tsx

import React, { useState } from 'react';
import { RefreshCw } from 'lucide-react';
import { useMIDIInput } from '../../hooks/useMIDIInput';
import { midiInputManager } from '../../utils/midiInputManager';

export const MIDIDeviceSelector: React.FC = () => {
  const {
    devices,
    selectedDevice,
    selectDevice,
    refreshDevices,
    lastMessage,
    isInitialized,
    error
  } = useMIDIInput();

  const [keyboardFallback, setKeyboardFallback] = useState(false);

  const handleDeviceChange = (deviceId: string) => {
    selectDevice(deviceId);
  };

  const handleKeyboardToggle = () => {
    if (!keyboardFallback) {
      midiInputManager.enableKeyboardFallback();
    } else {
      midiInputManager.disableKeyboardFallback();
    }
    setKeyboardFallback(!keyboardFallback);
  };

  if (error) {
    return (
      <div className="p-4 bg-red-900/20 border border-red-600 rounded-lg">
        <p className="text-sm text-red-400">
          ‚ùå {error}
        </p>
        <p className="text-xs text-red-500 mt-2">
          Web MIDI API may not be supported in your browser. Try Chrome or Edge.
        </p>
      </div>
    );
  }

  if (!isInitialized) {
    return (
      <div className="p-4 bg-gray-800 rounded-lg">
        <p className="text-sm text-gray-400">Initializing MIDI...</p>
      </div>
    );
  }

  return (
    <div className="space-y-4 p-4 bg-gray-800 rounded-lg border border-gray-700">
      <div>
        <div className="flex items-center justify-between mb-2">
          <label className="block text-sm font-medium text-gray-300">
            MIDI Input Device
          </label>
          <button
            onClick={refreshDevices}
            className="p-2 hover:bg-gray-700 rounded-lg transition-colors"
            aria-label="Refresh devices"
          >
            <RefreshCw className="w-4 h-4 text-gray-400" />
          </button>
        </div>

        {devices.length > 0 ? (
          <select
            value={selectedDevice ?? ''}
            onChange={(e) => handleDeviceChange(e.target.value)}
            className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary-500 min-h-[44px]"
          >
            <option value="">Select a device...</option>
            {devices.map(device => (
              <option key={device.id} value={device.id}>
                {device.state === 'connected' ? 'üü¢' : 'üî¥'} {device.name} ({device.manufacturer})
              </option>
            ))}
          </select>
        ) : (
          <div className="p-3 bg-gray-900 rounded-lg border border-gray-700">
            <p className="text-sm text-gray-400">
              No MIDI devices detected.
            </p>
            <p className="text-xs text-gray-500 mt-1">
              Connect a MIDI keyboard or controller and click refresh.
            </p>
          </div>
        )}
      </div>

      {/* Keyboard Fallback Toggle */}
      <div className="flex items-start gap-3">
        <input
          type="checkbox"
          id="keyboard-fallback"
          checked={keyboardFallback}
          onChange={handleKeyboardToggle}
          className="mt-0.5 w-4 h-4 text-primary-600 bg-gray-700 border-gray-600 rounded focus:ring-2 focus:ring-primary-500"
        />
        <label htmlFor="keyboard-fallback" className="text-sm text-gray-300 flex-1">
          <div>Use QWERTY keyboard as fallback</div>
          <div className="text-xs text-gray-500 mt-1">
            For testing without MIDI hardware
          </div>
        </label>
      </div>

      {/* Keyboard Map (shown when enabled) */}
      {keyboardFallback && (
        <div className="p-3 bg-gray-900 rounded-lg border border-gray-700">
          <p className="text-xs font-medium text-gray-400 mb-2">Keyboard Mapping:</p>
          <div className="text-xs text-gray-500 space-y-1 font-mono">
            <div>A W S E D F T G Y H U J K</div>
            <div>C C# D D# E F F# G G# A A# B C</div>
            <div className="text-gray-600 mt-2">Z X C V B N M (lower octave)</div>
          </div>
        </div>
      )}

      {/* Last MIDI Message (debug info) */}
      {lastMessage && (
        <div className="p-3 bg-gray-900 rounded-lg border border-gray-700">
          <p className="text-xs font-medium text-gray-400 mb-1">Last MIDI Message:</p>
          <p className="text-xs text-green-400 font-mono">
            {lastMessage.type === 'noteOn' ? '‚ñ∂' : '‚èπ'}{' '}
            Note: {midiInputManager.getNoteNameFromMIDI(lastMessage.note)} (MIDI {lastMessage.note}) |
            Velocity: {lastMessage.velocity}
          </p>
        </div>
      )}
    </div>
  );
};
```

---

## File Structure

```
src/
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ midiInputManager.ts          // Core MIDI engine (~300 lines)
‚îÇ
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îî‚îÄ‚îÄ useMIDIInput.ts              // React hook (~80 lines)
‚îÇ
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îî‚îÄ‚îÄ MIDI/
‚îÇ       ‚îú‚îÄ‚îÄ MIDIDeviceSelector.tsx   // UI component (~150 lines)
‚îÇ       ‚îî‚îÄ‚îÄ index.ts                 // Barrel export
‚îÇ
‚îî‚îÄ‚îÄ types/
    ‚îî‚îÄ‚îÄ index.ts                     // Add MIDI types

Total NEW code: ~530 lines
```

---

## Tasks / Subtasks

### Phase 1: Core MIDI Manager (AC 1, 2, 3)

- [ ] **Task 1.1: Create MIDIInputManager class**
  - [ ] Implement singleton pattern
  - [ ] Add `initialize()` method (request MIDI access)
  - [ ] Add `getDevices()` method (enumerate inputs)
  - [ ] Add `selectDevice()` method (connect to device)
  - [ ] Add TypeScript interfaces (MIDIDevice, MIDINoteMessage)

- [ ] **Task 1.2: Implement MIDI message parsing**
  - [ ] Parse Note On (0x90 + note + velocity)
  - [ ] Parse Note Off (0x80 or velocity=0)
  - [ ] Extract note number and velocity
  - [ ] Log messages to console for debugging

- [ ] **Task 1.3: Implement listener system**
  - [ ] Add `addListener()` method
  - [ ] Add `removeListener()` method
  - [ ] Implement `notifyListeners()` private method
  - [ ] Handle listener errors gracefully

- [ ] **Task 1.4: Add hot-plug detection**
  - [ ] Listen for `onstatechange` events
  - [ ] Update device list when devices connect/disconnect
  - [ ] Clear active device if it disconnects

---

### Phase 2: Keyboard Fallback & Integrations (AC 4, 5, 6)

- [ ] **Task 2.1: Implement keyboard fallback mode**
  - [ ] Add `enableKeyboardFallback()` method
  - [ ] Add `disableKeyboardFallback()` method
  - [ ] Map QWERTY keys to MIDI notes (A=C4, W=C#4, etc.)
  - [ ] Handle keydown/keyup events
  - [ ] Prevent key repeat (check `event.repeat`)

- [ ] **Task 2.2: Integrate with FrequencySourceManager**
  - [ ] Call `frequencySourceManager.addMidiNote()` on Note On
  - [ ] Test MIDI notes appear in DJ Visualizer
  - [ ] Verify no errors if FrequencySourceManager not initialized

- [ ] **Task 2.3: Integrate with Tone.js**
  - [ ] Create test `PolySynth` instrument
  - [ ] Trigger notes on MIDI input
  - [ ] Map MIDI velocity to Tone.js volume
  - [ ] Handle note off (release notes)

---

### Phase 3: React Hook & UI Component (AC 7)

- [ ] **Task 3.1: Create useMIDIInput hook**
  - [ ] Initialize MIDI on mount
  - [ ] Manage devices state
  - [ ] Manage selectedDevice state
  - [ ] Manage lastMessage state
  - [ ] Expose selectDevice, refreshDevices functions
  - [ ] Cleanup on unmount

- [ ] **Task 3.2: Create MIDIDeviceSelector component**
  - [ ] Dropdown for device selection
  - [ ] Refresh button (RefreshCw icon from Lucide)
  - [ ] Connection status indicators (üü¢/üî¥)
  - [ ] Keyboard fallback toggle (checkbox)
  - [ ] Keyboard map display (when fallback enabled)
  - [ ] Last MIDI message display
  - [ ] Error state UI
  - [ ] Loading state UI

- [ ] **Task 3.3: Add to Welcome screen (testing)**
  - [ ] Create `/midi-test` route
  - [ ] Add card to Welcome screen Experiments section
  - [ ] Basic test page with MIDIDeviceSelector
  - [ ] Play Tone.js notes when MIDI received
  - [ ] Verify in multiple browsers (Chrome, Firefox, Edge)

---

### Phase 4: Testing & Documentation

- [ ] **Task 4.1: Test with real MIDI devices**
  - [ ] Test with USB MIDI keyboard
  - [ ] Test with MIDI guitar pickup (if available)
  - [ ] Test hot-plug (connect device while app running)
  - [ ] Test hot-unplug (disconnect device while app running)
  - [ ] Test multiple simultaneous MIDI devices

- [ ] **Task 4.2: Test keyboard fallback mode**
  - [ ] Verify all keys mapped correctly (A-K, Z-M)
  - [ ] Test key repeat prevention
  - [ ] Test toggling fallback on/off
  - [ ] Verify fallback disables when real device selected

- [ ] **Task 4.3: Browser compatibility testing**
  - [ ] Chrome (should work perfectly)
  - [ ] Edge (should work perfectly)
  - [ ] Firefox (requires flag, document this)
  - [ ] Safari (won't work, show helpful error message)

- [ ] **Task 4.4: Performance testing**
  - [ ] Test at 120 BPM (2 notes/second)
  - [ ] Test rapid note sequences (arpeggios)
  - [ ] Verify no dropped MIDI messages
  - [ ] Verify latency <50ms (MIDI ‚Üí audio)

---

## Success Metrics

- [ ] Successfully connects to 3+ different MIDI devices
- [ ] Zero dropped MIDI messages during 5-minute test session
- [ ] MIDI ‚Üí audio latency <50ms (measured with oscilloscope or audio software)
- [ ] Hot-plug detection <1 second
- [ ] Keyboard fallback mode works for all mapped keys
- [ ] Works in Chrome and Edge without errors
- [ ] FrequencySourceManager receives MIDI notes correctly
- [ ] Tone.js plays notes with correct pitch and velocity

---

## Integration with Future Stories

### Story 9.2 (Piano Roll Visualizer)
```tsx
import { midiInputManager } from '../utils/midiInputManager';

useEffect(() => {
  const handleMIDI = (message: MIDINoteMessage) => {
    if (message.type === 'noteOn') {
      highlightPianoKey(message.note);
      updateLEDStrip(message.note);
    }
  };

  midiInputManager.addListener(handleMIDI);
  return () => midiInputManager.removeListener(handleMIDI);
}, []);
```

### Story 9.3 (Guitar Fretboard Visualizer)
```tsx
import { midiInputManager } from '../utils/midiInputManager';

useEffect(() => {
  const handleMIDI = (message: MIDINoteMessage) => {
    if (message.type === 'noteOn') {
      const { string, fret } = midiNoteToFretboard(message.note);
      highlightFret(string, fret);
      updateLEDMatrix(string, fret);
    }
  };

  midiInputManager.addListener(handleMIDI);
  return () => midiInputManager.removeListener(handleMIDI);
}, []);
```

---

## Design System Compliance

### UX Standards (from CLAUDE.md)
- [ ] Uses Tailwind CSS classes exclusively
- [ ] Uses Lucide React icons (RefreshCw)
- [ ] Follows color tokens (primary-600, gray-700, etc.)
- [ ] Border radius: `rounded-lg` for all interactive elements
- [ ] Touch targets: `min-h-[44px]` on dropdown and buttons
- [ ] Responsive: Works on mobile and desktop
- [ ] Accessibility: Proper ARIA labels, keyboard navigation

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-10 | 1.0 | Initial story creation - Web MIDI Input Engine | Claude Code |

---

## Next Steps

1. Review story and confirm approach
2. Begin Phase 1: Core MIDI Manager
3. Test with real MIDI hardware
4. Move to Story 9.2: Piano Roll Visualizer
