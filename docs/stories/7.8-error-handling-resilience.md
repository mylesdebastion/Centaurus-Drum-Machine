# Story 7.8: Error Handling & Connection Resilience

**Epic:** Epic 7 - Jam Session Backend Infrastructure (Hybrid: Supabase + WebRTC P2P)
**Status:** 📝 READY FOR DEVELOPMENT
**Priority:** 🟢 LOW
**Complexity:** Medium
**Time Estimate:** 3-4 hours
**Prerequisites:** Story 7.6

---

## User Story

As a **user in a jam session**,
I want **clear error messages and automatic recovery when connections fail**,
So that **I understand what's happening and the session continues gracefully**.

---

## Story Context

**Existing System Integration:**
- Integrates with: SupabaseSessionService, WebRTCAudioService, JamSession UI
- Technology: Error boundaries, connection state monitoring, TypeScript
- Follows pattern: Graceful degradation, user-friendly error messages
- Touch points: All session services, connection status indicators

**Why This Story:**
Comprehensive error handling ensures a professional user experience when inevitable network issues occur. Users should never see cryptic errors or broken states. This story adds resilience to both Supabase (session management) and WebRTC (audio) connections.

---

## Acceptance Criteria

### Functional Requirements

1. **Supabase Channel Error Handling**
   - Handle subscription failures:
     ```typescript
     channel.subscribe((status) => {
       if (status === 'CHANNEL_ERROR') {
         showError('Could not connect to session. Please try again.');
       }
       if (status === 'TIMED_OUT') {
         showError('Connection lost, reconnecting...');
       }
     });
     ```
   - Handle invalid room codes:
     - Show error: "Session not found. Please check the room code."
     - Redirect to WelcomeScreen after 3 seconds

2. **WebRTC Error Handling**
   - Handle ICE connection failures:
     ```typescript
     peerConnection.oniceconnectionstatechange = () => {
       const state = peerConnection.iceConnectionState;
       if (state === 'failed' || state === 'disconnected') {
         showWarning('Direct audio connection failed, retrying...');
         restartIceConnection();
       }
     };
     ```
   - Handle TURN server unavailability:
     - Show warning: "Limited connectivity, audio may be delayed"
     - Continue session without audio (fall back to Supabase only)
   - Handle microphone permission denied:
     - Show error: "Microphone access required for jamming"
     - Allow session to continue without audio
   - Handle audio device not found:
     - Show error: "No audio input detected, check microphone"
     - Provide instructions to select audio device

3. **Connection Quality Monitoring**
   - Track WebRTC statistics:
     ```typescript
     setInterval(async () => {
       const stats = await peerConnection.getStats();
       const audioStats = findAudioStats(stats);

       if (audioStats.packetsLost > 100) {
         showWarning('Poor connection quality, audio may glitch');
       }
       if (audioStats.jitter > 30) {
         showWarning('High latency detected (>100ms)');
       }
     }, 5000); // Check every 5 seconds
     ```

4. **Graceful Degradation**
   - If WebRTC fails → Continue with Supabase (no audio):
     - Show warning: "Audio unavailable, session continues without audio"
     - Participants can still see each other and sync state
   - If WLED fails → Continue with audio-only jamming:
     - Show warning: "LED visualization unavailable"
     - Audio and session management continue
   - If Supabase unavailable → Show offline message:
     - "Cannot connect to session. Please check your internet connection."
     - Allow local-only mode (future enhancement)

5. **User-Friendly Error Messages**
   - File: `src/utils/errorMessages.ts`
   - Map technical errors to user-friendly text:
     ```typescript
     export const ERROR_MESSAGES = {
       // Supabase errors
       'CHANNEL_ERROR': 'Could not connect to session',
       'SUBSCRIPTION_FAILED': 'Failed to join session',
       'INVALID_ROOM_CODE': 'Session not found',

       // WebRTC errors
       'ICE_FAILED': 'Direct audio connection failed',
       'NO_TURN_SERVER': 'Limited connectivity',
       'MIC_PERMISSION_DENIED': 'Microphone access required',
       'NO_AUDIO_DEVICE': 'No audio input detected',

       // Network errors
       'NETWORK_ERROR': 'Network connection lost',
       'TIMEOUT': 'Connection timed out',
     };
     ```

6. **Connection Status Indicator (Enhanced)**
   - Show both Supabase and WebRTC status:
     ```tsx
     <ConnectionStatus
       supabaseStatus="connected" // or 'connecting', 'disconnected'
       webrtcStatus="connected"   // or 'connecting', 'failed'
       audioEnabled={true}
     />
     ```
   - Color coding:
     - 🟢 Green: All connections healthy
     - 🟡 Yellow: Reconnecting or degraded
     - 🔴 Red: Connection failed

### Integration Requirements

7. **Error Boundary Component**
   - File: `src/components/ErrorBoundary.tsx`
   - Catch React errors in session components
   - Show friendly error page with "Rejoin Session" button
   - Log errors for debugging

8. **Error Handling in Services**
   - SupabaseSessionService:
     - Throw typed errors (not generic Error)
     - Include error codes for mapping
   - WebRTCAudioService:
     - Emit connection state events
     - Include error details in events

9. **Network Interruption Testing**
   - Test with DevTools network throttling:
     - Offline mode
     - Slow 3G
     - Intermittent connection
   - Verify automatic recovery

### Quality Requirements

10. **User Experience**
    - Error messages are clear and actionable
    - Automatic reconnection happens silently (no modal)
    - Users know what's happening (status indicator)
    - No crashes or unhandled errors

11. **Error Logging**
    - Log errors to console with context
    - Include timestamp, user ID, room code
    - Future: Send to error tracking service (Sentry, etc.)

12. **Code Quality**
    - All async operations have error handling
    - No unhandled promise rejections
    - TypeScript error types defined

---

## Technical Notes

**Integration Approach:**
- Error messages mapped via errorMessages.ts utility
- Connection status indicator shows both Supabase and WebRTC
- Graceful degradation allows partial functionality

**Existing Pattern Reference:**
- Error handling similar to existing audio engine patterns
- Status indicator similar to existing connection status (Story 7.3)
- Error boundary follows React best practices

**Key Constraints:**
- Supabase has built-in reconnection logic (can't customize)
- WebRTC requires manual ICE restart on failure
- Microphone permission prompts are browser-controlled

---

## Definition of Done

- [ ] Supabase channel errors handled gracefully
- [ ] WebRTC connection errors handled with retry
- [ ] Microphone permission errors show clear messages
- [ ] Connection quality monitoring implemented
- [ ] Graceful degradation for WebRTC and WLED failures
- [ ] User-friendly error messages defined
- [ ] Enhanced connection status indicator created
- [ ] Error boundary component created (optional)
- [ ] Network interruption recovery tested
- [ ] Manual testing completed (see Testing Strategy)

---

## Testing Strategy

### Manual Testing (Per CLAUDE.md Guidelines)

**Test 1: Supabase Channel Failure**
1. Enter invalid room code (e.g., "XXXXXX")
2. Verify:
   - ✅ Error message: "Session not found"
   - ✅ Redirects to WelcomeScreen after 3 seconds
   - ✅ No console errors

**Test 2: WebRTC Connection Failure**
1. Block WebRTC ports or use restrictive firewall
2. Attempt to join session
3. Verify:
   - ✅ Warning: "Direct audio connection failed, retrying..."
   - ✅ Session continues without audio
   - ✅ Status indicator shows WebRTC failed

**Test 3: Microphone Permission Denied**
1. Deny microphone permission in browser
2. Attempt to join session
3. Verify:
   - ✅ Error: "Microphone access required for jamming"
   - ✅ Session continues without audio
   - ✅ Instructions to enable microphone shown

**Test 4: Network Interruption Recovery**
1. Join session successfully
2. DevTools → Network → Throttle to "Offline"
3. Wait 5 seconds
4. DevTools → Network → Set to "Online"
5. Verify:
   - ✅ Supabase reconnects automatically
   - ✅ Status indicator: Disconnected → Connecting → Connected
   - ✅ Participant list re-syncs
   - ✅ No data loss

**Test 5: Poor Connection Quality**
1. DevTools → Network → Throttle to "Slow 3G"
2. Join session
3. Verify:
   - ✅ Warning: "High latency detected"
   - ✅ Session continues (degraded performance)
   - ✅ Audio quality reduced but functional

**Test 6: Error Boundary**
1. Simulate React error (throw in component)
2. Verify:
   - ✅ Error boundary catches error
   - ✅ Friendly error page shown
   - ✅ "Rejoin Session" button works

### Verification Checklist

- ✅ Connection errors show user-friendly messages
- ✅ Network interruption triggers reconnection automatically
- ✅ Status indicator updates correctly
- ✅ No crashes or unhandled errors in console
- ✅ WebRTC connection errors show clear messages
- ✅ Failed WebRTC falls back to Supabase gracefully
- ✅ Microphone permission errors show instructions
- ✅ Connection quality warnings appear when latency >100ms

---

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** Users confused by error messages
**Mitigation:**
- User-friendly error text (not technical jargon)
- Clear action steps ("Check your internet connection")
- Status indicator provides visual feedback

**Secondary Risk:** Automatic reconnection loops
**Mitigation:**
- Limit reconnection attempts (max 3 tries)
- Exponential backoff between retries
- Give up after 30 seconds, show manual retry button

### Compatibility Verification

- [x] **No breaking changes** - Additive error handling
- [x] **Database changes** - None
- [x] **UI changes** - Additive (enhanced status indicator)
- [x] **Performance impact** - Negligible

---

## Scope Validation

- [x] Story can be completed in **3-4 hours** (one session)
- [x] Integration approach is straightforward (add error handling)
- [x] Follows existing patterns (error messages, status indicators)
- [x] No design work required (reuse existing UI patterns)

---

## Deliverables

1. **Error Messages Utility**
   - `src/utils/errorMessages.ts` (~80 lines)
   - User-friendly error mapping

2. **Updated SupabaseSessionService**
   - `src/services/supabaseSession.ts` (modified, ~50 lines added)
   - Error handling and typed errors

3. **Updated WebRTCAudioService**
   - `src/services/webrtcAudio.ts` (modified, ~80 lines added)
   - Connection monitoring and recovery

4. **Enhanced Connection Status Indicator**
   - `src/components/JamSession/ConnectionStatus.tsx` (modified, ~40 lines added)
   - Show both Supabase and WebRTC states

5. **Error Boundary Component (Optional)**
   - `src/components/ErrorBoundary.tsx` (~60 lines)
   - Catch React errors

---

## Next Steps After Story 7.8

Once this story is complete, proceed to:
- **Story 7.9:** Session Persistence (Optional) (2-3 hours)
  - Save sessions to database for history

---

## References

- **Epic 7:** `docs/epics/epic-7-jam-session-backend.md`
- **Story 7.2:** `docs/stories/7.2-supabase-realtime-service.md`
- **Story 7.5:** `docs/stories/7.5-webrtc-p2p-audio.md`
- **React Error Boundaries:** https://react.dev/reference/react/Component#catching-rendering-errors-with-an-error-boundary

---

**Story Created:** 2025-10-13
**Story Owner:** Product Manager (John)
**Estimated Completion:** 3-4 hours after start
