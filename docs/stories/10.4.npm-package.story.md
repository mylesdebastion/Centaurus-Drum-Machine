# Story 10.5: Separate npm Package Architecture (@centaurus/controller-lib)

## Status
Draft

## Story
**As a** technical architect,
**I want** hardware controller profiles separated into standalone npm package,
**so that** community can contribute controller profiles without access to core app and legal liability is further isolated.

## Acceptance Criteria
1. Create new GitHub repo: `centaurus-controller-lib` with Apache 2.0 license
2. Extract controller profile schemas and base classes into library package
3. Design npm package structure: `@centaurus/controller-lib` with tree-shakeable exports
4. Create contribution guidelines for community controller profiles
5. Implement profile validation/linting tools in library repo
6. Build automated CI/CD for testing and publishing controller profiles
7. Maintain core app's ability to load profiles from both npm package and internal registry

## Integration Verification
- **IV1**: Core app can import profiles from both `@centaurus/controller-lib` and internal src/hardware/
- **IV2**: npm package has zero dependencies on core application code
- **IV3**: Community contributors can test profiles locally without building entire Centaurus app

## Tasks / Subtasks

- [ ] **Task 1: Create GitHub Repository & Project Setup** (AC: 1)
  - [ ] Create new GitHub repo: `centaurus-controller-lib`
  - [ ] Initialize with Apache 2.0 license (permissive, compatible with commercial use)
  - [ ] Set up monorepo structure (optional: for future expansion)
  - [ ] Create `.github/` workflows for CI/CD
  - [ ] Add CODE_OF_CONDUCT.md, CONTRIBUTING.md, SECURITY.md
  - [ ] Configure branch protection rules (require PR reviews)
  - [ ] Set up GitHub Discussions for community support

- [ ] **Task 2: Extract Controller Schemas & Base Classes** (AC: 2)
  - [ ] Create `packages/core/` directory
  - [ ] Extract `ControllerProfile` interface to library
  - [ ] Extract `BaseController` abstract class
  - [ ] Extract `MIDIMapping` types and utilities
  - [ ] Extract `LEDController` base class for LED-capable controllers
  - [ ] Move shared utilities (velocity curves, color mapping, MIDI builders)
  - [ ] Remove all dependencies on core app code (ensure clean separation)
  - [ ] Create compatibility shims for legacy code in main app

- [ ] **Task 3: Design npm Package Structure** (AC: 3)
  - [ ] Set up TypeScript project with tsconfig.json
  - [ ] Configure rollup/esbuild for tree-shakeable ESM + CJS builds
  - [ ] Design package.json exports map:
    ```json
    {
      "exports": {
        ".": "./dist/index.js",
        "./controllers/*": "./dist/controllers/*.js",
        "./utils": "./dist/utils/index.js",
        "./types": "./dist/types/index.js"
      }
    }
    ```
  - [ ] Implement barrel exports (index.ts files) for clean imports
  - [ ] Configure source maps for debugging
  - [ ] Add package.json metadata (keywords, repository, license)
  - [ ] Test tree-shaking with bundle analyzer

- [ ] **Task 4: Migrate Existing Controller Profiles** (AC: 2)
  - [ ] Move APC40 profile to library (maintain backward compatibility)
  - [ ] Move Launchpad Mini MK3 profile
  - [ ] Move MPK Mini MK3 profile
  - [ ] Move BeatStep profile
  - [ ] Update imports in main app to use `@centaurus/controller-lib`
  - [ ] Verify all controllers still work after migration
  - [ ] Test with both npm-linked local package and published package

- [ ] **Task 5: Create Contribution Guidelines** (AC: 4)
  - [ ] Write comprehensive CONTRIBUTING.md
  - [ ] Document controller profile submission process:
    1. Fork repo
    2. Create profile following template
    3. Add tests (minimum 70% coverage)
    4. Submit PR with demo video
    5. Community review + maintainer approval
  - [ ] Create profile template: `templates/controller-profile-template/`
  - [ ] Document testing requirements
  - [ ] Add PR template with checklist
  - [ ] Create issue templates for controller requests and bug reports

- [ ] **Task 6: Implement Profile Validation & Linting** (AC: 5)
  - [ ] Create JSON schema for controller profiles (validation)
  - [ ] Implement `validateProfile(profile: ControllerProfile): ValidationResult`
  - [ ] Build CLI tool: `npx @centaurus/controller-lib validate <profile.json>`
  - [ ] Add ESLint rules for controller code quality
  - [ ] Create pre-commit hooks (lint, test, validate)
  - [ ] Implement profile linter checking for:
    - [ ] Required fields present
    - [ ] MIDI messages well-formed
    - [ ] LED configurations valid
    - [ ] No proprietary assets (logos, fonts)
    - [ ] Trademark-compliant naming

- [ ] **Task 7: Build Automated CI/CD Pipeline** (AC: 6)
  - [ ] Set up GitHub Actions workflow: `test.yml`
    - [ ] Run tests on PR
    - [ ] Validate all controller profiles
    - [ ] Check code coverage (>70% required)
    - [ ] Lint code and profiles
  - [ ] Set up release workflow: `publish.yml`
    - [ ] Semantic versioning (semver)
    - [ ] Automated changelog generation
    - [ ] Publish to npm on release tags
    - [ ] Create GitHub releases with notes
  - [ ] Add dependabot for dependency updates
  - [ ] Configure automated security scanning (Snyk/Dependabot)

- [ ] **Task 8: Implement Dual Import Support in Main App** (AC: 7, IV: 1)
  - [ ] Update ControllerRegistry to support multiple sources
  - [ ] Implement profile loader: `loadFromNPM()` and `loadFromInternal()`
  - [ ] Create profile resolution strategy (npm package takes precedence)
  - [ ] Add version compatibility checking (library version vs app version)
  - [ ] Implement fallback to internal profiles if npm package unavailable
  - [ ] Test with npm package installed and uninstalled

- [ ] **Task 9: Ensure Zero Core App Dependencies** (IV: 2)
  - [ ] Audit library imports (no imports from `@centaurus/app` or similar)
  - [ ] Remove any React/React-specific dependencies (library should be framework-agnostic)
  - [ ] Remove Tone.js dependency (audio should be handled by app, not library)
  - [ ] Verify library can be used standalone (no peer dependencies on app code)
  - [ ] Test library import in blank TypeScript project

- [ ] **Task 10: Create Standalone Testing Environment** (IV: 3)
  - [ ] Build demo app in library repo: `examples/controller-tester/`
  - [ ] Create MIDI device simulator for testing
  - [ ] Implement profile playground (load profile, simulate MIDI messages)
  - [ ] Add LED feedback visualizer for testing LED controllers
  - [ ] Document how community contributors can test locally
  - [ ] Provide Docker environment for consistent testing

## Dev Notes

### Relevant Architecture Context

**Package Separation Strategy**:
- **Core Library**: Profile schemas, base classes, utilities (framework-agnostic)
- **Main App**: UI, audio engine, sequencer logic, license management (Centaurus-specific)
- **Clean Boundary**: Library has zero knowledge of app internals

**Legal Liability Isolation**:
- Apache 2.0 license allows commercial use with liability disclaimer
- Community contributions are legally separate from main app
- Trademark issues in library don't affect main app
- Individual contributors retain copyright (not transferred to Centaurus)

**Community Contribution Model**:
- Open-source library fosters community engagement
- Contributors get attribution (GitHub contributions, changelog)
- Quality bar ensures reliability (tests, review process)
- Main app curates "Official" profiles from library

**Versioning Strategy**:
- **Semantic Versioning**: Major.Minor.Patch
- **Breaking Changes**: Require major version bump
- **Profile Additions**: Minor version bump
- **Bug Fixes**: Patch version bump
- **Main app**: Can pin to specific library version for stability

### Source Tree Context

**Library Repository Structure**:
```
centaurus-controller-lib/
├── .github/
│   ├── workflows/
│   │   ├── test.yml
│   │   ├── publish.yml
│   │   └── validate-pr.yml
│   ├── ISSUE_TEMPLATE/
│   └── PULL_REQUEST_TEMPLATE.md
├── packages/
│   ├── core/                         # Main library code
│   │   ├── src/
│   │   │   ├── types/
│   │   │   │   ├── ControllerProfile.ts
│   │   │   │   ├── MIDIMapping.ts
│   │   │   │   └── LEDConfig.ts
│   │   │   ├── base/
│   │   │   │   ├── BaseController.ts
│   │   │   │   ├── LEDController.ts
│   │   │   │   └── PadController.ts
│   │   │   ├── controllers/
│   │   │   │   ├── apc40/
│   │   │   │   ├── launchpad-mini-mk3/
│   │   │   │   ├── mpk-mini-mk3/
│   │   │   │   └── beatstep/
│   │   │   ├── utils/
│   │   │   │   ├── velocity-curve.ts
│   │   │   │   ├── color-mapping.ts
│   │   │   │   └── midi-builder.ts
│   │   │   ├── validation/
│   │   │   │   ├── profile-validator.ts
│   │   │   │   └── schemas/
│   │   │   │       └── controller-profile.schema.json
│   │   │   └── index.ts
│   │   ├── tests/
│   │   ├── package.json
│   │   └── tsconfig.json
│   └── cli/                          # CLI tools (optional)
│       └── src/
│           └── validate-profile.ts
├── examples/
│   └── controller-tester/            # Standalone demo app
├── templates/
│   └── controller-profile-template/
├── docs/
│   ├── api-reference.md
│   ├── creating-profiles.md
│   └── testing-guide.md
├── CONTRIBUTING.md
├── CODE_OF_CONDUCT.md
├── LICENSE (Apache 2.0)
└── README.md
```

**Main App Integration**:
```typescript
// Core app imports library
import { APC40Controller, LaunchpadController } from '@centaurus/controller-lib';
import { ControllerRegistry } from '@/hardware/registry/ControllerRegistry';

// Register profiles from library
const registry = ControllerRegistry.getInstance();
registry.registerController(new APC40Controller());
registry.registerController(new LaunchpadController());
```

### Key Design Decisions

**Apache 2.0 License**: Permissive license allows commercial use of library in Centaurus Pro tier. Patent grant protects contributors and users.

**Monorepo Structure**: Optional for now. Allows future expansion (e.g., `@centaurus/controller-ui` for React components).

**Tree-Shakeable Exports**: Users can import only what they need. Reduces bundle size for apps using limited controllers.

**Framework-Agnostic**: Library doesn't depend on React, Tone.js, or Centaurus-specific code. Increases reusability (e.g., command-line MIDI tools could use library).

**Semantic Versioning**: Clear versioning signals compatibility. Main app can pin to specific version for stability.

**Community Review Process**: Maintainers review PRs, but community can comment/test. Balances quality with open contribution.

### npm Package Metadata

**package.json Example**:
```json
{
  "name": "@centaurus/controller-lib",
  "version": "1.0.0",
  "description": "Hardware MIDI controller profiles for music production software",
  "keywords": [
    "midi", "controller", "music", "hardware", "apc40", "launchpad",
    "production", "sequencer", "daw"
  ],
  "license": "Apache-2.0",
  "author": "Centaurus Contributors",
  "repository": {
    "type": "git",
    "url": "https://github.com/centaurus/controller-lib.git"
  },
  "bugs": {
    "url": "https://github.com/centaurus/controller-lib/issues"
  },
  "homepage": "https://github.com/centaurus/controller-lib#readme",
  "main": "./dist/index.cjs",
  "module": "./dist/index.mjs",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "import": "./dist/index.mjs",
      "require": "./dist/index.cjs",
      "types": "./dist/index.d.ts"
    },
    "./controllers/*": {
      "import": "./dist/controllers/*.mjs",
      "require": "./dist/controllers/*.cjs",
      "types": "./dist/controllers/*.d.ts"
    }
  },
  "files": [
    "dist",
    "README.md",
    "LICENSE"
  ],
  "sideEffects": false
}
```

### Testing

**Unit Tests** (`packages/core/tests/*.test.ts`):
- Profile validation logic
- Base controller class functionality
- MIDI message builders
- Utility functions (velocity curves, color mapping)

**Integration Tests** (`packages/core/tests/integration/*.test.ts`):
- Full controller profile loading
- MIDI message round-trip testing
- LED feedback simulation

**E2E Tests** (in examples/controller-tester/):
- Load profile from library
- Simulate MIDI device connection
- Verify LED feedback rendering

**Publishing Tests** (CI/CD):
- Dry-run npm publish before release
- Verify package contents (no unintended files)
- Test installation in blank project

**Testing Standards**:
- Vitest for unit/integration tests
- Minimum 70% code coverage (enforced in CI)
- All PRs require passing tests
- Automated regression testing on main branch

### Community Engagement Strategy

**Documentation**:
- Clear, beginner-friendly guides
- Video tutorials for controller creation
- API reference with examples

**Support Channels**:
- GitHub Discussions for Q&A
- Discord server (optional) for real-time help
- Issue tracker for bugs/feature requests

**Recognition**:
- Contributors listed in CONTRIBUTORS.md
- GitHub badge: "Centaurus Controller Contributor"
- Highlighted profiles in main app ("Contributed by @username")

**Quality Incentives**:
- "Profile of the Month" showcase
- Fast-track review for high-quality submissions
- Maintainer promotion for consistent contributors

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-10 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
