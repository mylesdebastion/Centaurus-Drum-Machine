# Story 15.7: Intelligent Melody Generator with Harmonic Guidance

**Epic:** [Epic 15 - Chord Progression & Melody Arranger Module](../epics/epic-15-chord-melody-arranger.md)
**Status:** üìù **READY FOR DEVELOPMENT**
**Priority:** üî¥ **HIGH**
**Complexity:** **High**
**Time Estimate:** 14-18 hours (increased from 12-16 due to Settings-Driven Visual Feedback)
**Prerequisites:**
- ‚úÖ Story 15.1 (ChordProgressionService)
- ‚úÖ Story 15.2 (ChordMelodyArranger UI)
- ‚úÖ Story 15.3 (MelodySequencer Component)
- ‚úÖ Story 15.4 (Module Routing System)
- ‚úÖ Story 15.5 (GlobalMusicContext Integration)

---

## Story Overview

**As a** music composer using the Chord & Melody Arranger
**I want** an intelligent melody generator that creates musically coherent melodies aligned with chord progressions
**So that** I can quickly compose professional-sounding melodies and learn music theory principles through visual feedback

**Current State (Brownfield):**
- MelodySequencer has basic random pattern generator (lines 308-365)
- Produces boring, banal melodies with no chord awareness
- No visual guidance for harmonic notes or music theory concepts
- Random velocity with no musical phrasing
- Fixed rhythmic patterns that repeat mechanically

**Target State (Greenfield):**
- Chord-aware melody generation using music theory best practices
- Visual harmonic guidance system using **brightness + glow** (LED-compatible, inspired by Piano Roll and Guitar Fretboard)
- Interactive note grid with brightness-weighted harmonic suggestions
- Intelligent settings panel (contour, rhythm, chord tone density) that **directly influences visual brightness**
- Educational UI showing melodic shape and theory concepts

---

## Acceptance Criteria

### 1. Intelligent Melody Generation Algorithm ‚úÖ

**Must implement chord-aware generation:**
- [x] Get active chord from ChordProgressionService at each step
- [x] Extract chord tones (root, 3rd, 5th, 7th) from current chord
- [x] Prioritize chord tones on strong beats (steps 0, 4, 8, 12: 80% chance)
- [x] Use passing tones (scale notes) on weak beats (40% chord tone chance)
- [x] Implement 4 melodic contour types: arch, valley, ascending, descending
- [x] Apply phrase-based velocity shaping (sine wave arc, not random)
- [x] Use 5 rhythmic motifs with intentional rests (not fixed patterns)
- [x] Add passing tones for smooth stepwise motion (no jarring leaps)

**Reference Implementation:**
- Chord tone emphasis: `research/intelligent_melody_music_theory_primer.md:60-73`
- Melodic contour: `research/intelligent_melody_music_theory_primer.md:76-89`
- Rhythmic motifs: `research/intelligent_melody_music_theory_primer.md:92-104`
- Dynamic shaping: `research/intelligent_melody_music_theory_primer.md:121-133`

---

### 2. Harmonic Guidance UX (LED-Compatible Visual System) ‚úÖ

**Design Philosophy:**
- **PRIMARY:** Background color + brightness = recommendation strength (most crucial for LED displays)
- **SECONDARY:** Border colors = educational indicators (matches note color, except white for active)
- **TERTIARY:** Timing = when suggestions light up (click column N ‚Üí show suggestions in N and N+1)
- **QUATERNARY:** Glow effects = subtle educational hints (not primary information)

---

#### **Brightness-Based Recommendation System (PRIMARY)**

**Brightness Levels (Visual Weight):**

| **Brightness** | **Recommendation** | **Musical Context** |
|---------------|-------------------|---------------------|
| `1.0` | Placed Note | User has placed this note in sequence |
| `0.90` | Most Recommended | Chord tones on strong beats (high density mode) |
| `0.85` | Very Recommended | Chord tones on strong beats (medium density) |
| `0.75` | Recommended | Chord tones on weak beats OR scale notes on strong beats |
| `0.65` | Acceptable | Scale notes (medium density) |
| `0.55` | Passing Tones | Scale notes on weak beats |
| `0.45` | Subtle | Weak scale notes (low density) |
| `0.20` | Out-of-Scale | Chromatic notes (advanced usage) |

**Implementation:**
```typescript
// 1. Get note color from colorMapping.ts (respects chromatic/harmonic/spectrum mode)
const noteForColor = colorMode === 'spectrum' ? pitch : (pitch % 12);
const color = getNoteColor(noteForColor, colorMode);

// 2. Calculate brightness based on musical recommendation
const brightness = isPlaced
  ? 1.0 // Placed note (full brightness)
  : calculateBrightness(pitch, step, currentChord, scaleNotes, settings);

// 3. Apply brightness to RGB (PRIMARY visual)
const backgroundColor = `rgb(${color.r * brightness}, ${color.g * brightness}, ${color.b * brightness})`;
```

**Brightness Calculation Logic:**
```typescript
function calculateBrightness(
  pitch: number,
  step: number,
  currentChord: Chord | null,
  scaleNotes: number[],
  settings: IntelligentMelodySettings
): number {
  const noteClass = pitch % 12;
  const isInScale = scaleNotes.includes(noteClass);

  if (!isInScale) return 0.2; // Out-of-scale: dim

  const chordTones = currentChord ? getChordTones(currentChord, scaleNotes) : [];
  const isChordTone = chordTones.includes(pitch);
  const isStrongBeat = step % 4 === 0;

  // Base brightness (before settings adjustments)
  if (isChordTone && isStrongBeat) return 0.85; // Very recommended
  if (isChordTone) return 0.65; // Recommended (chord tone, weak beat)
  if (isStrongBeat) return 0.65; // Recommended (scale note, strong beat)
  return 0.45; // Acceptable (passing tone)
}
```

---

#### **Border Color System (SECONDARY - Educational)**

**Border Colors (MUST match background note color):**

```typescript
function getNoteBorderColor(
  pitch: number,
  colorMode: ColorMode,
  isPlaced: boolean,
  brightness: number
): string {
  if (isPlaced) {
    return 'rgb(255, 255, 255)'; // White for active/placed notes (EXCEPTION)
  }

  // Border matches background note color (same RGB with same brightness)
  const noteForColor = colorMode === 'spectrum' ? pitch : (pitch % 12);
  const color = getNoteColor(noteForColor, colorMode);
  return `rgb(${color.r * brightness}, ${color.g * brightness}, ${color.b * brightness})`;
}
```

**Border Widths:**
- **3px:** Placed/active notes (white border)
- **2px:** Suggested notes (colored border matching background)
- **1px:** Default state (gray border `rgb(75, 85, 99)`)

---

#### **Glow Effects (QUATERNARY - Subtle Educational Hints)**

**Box-Shadow Glow (NOT PRIMARY, optional enhancement):**
```typescript
function getGlowEffect(
  isChordTone: boolean,
  isScaleNote: boolean,
  brightness: number
): string {
  if (brightness < 0.3) return 'none'; // Don't glow very dim notes

  if (isChordTone) {
    // Subtle green glow for chord tones (educational hint)
    return '0 0 6px rgba(34, 197, 94, 0.3)';
  }

  if (isScaleNote) {
    // Subtle blue glow for scale notes (educational hint)
    return '0 0 4px rgba(59, 130, 246, 0.25)';
  }

  return 'none';
}
```

**Note:** Glow effects are NOT the primary visual indicator. They are subtle educational hints. Brightness is the primary indicator.

---

#### **Interactive Suggestion System (TERTIARY - Timing)**

**When user clicks to add note in column N:**
1. Add note to sequence (brightness = 1.0, white border)
2. Show suggestions in **columns N and N+1** (same + next columns)
3. Calculate brightness for each suggested note based on:
   - Current chord at steps N and N+1
   - Whether note is chord tone vs scale note
   - Whether step is strong beat (0, 4, 8, 12) vs weak beat
   - **Settings adjustments** (chord tone density, contour, passing tones)
4. Update border colors to match background note colors (2px width)
5. Apply subtle glow effects (optional educational hint)

**When user removes note:**
- Clear suggestions from affected columns
- Reset to default state (brightness = 0.2, gray border)

**Visual Transition:**
- Smooth animation: `transition: all 200ms ease-in-out`
- Clear visual feedback when suggestions change

---

#### **ColorMode Integration**

The note grid **always respects** the user's selected color mode:

```typescript
// Chromatic Mode: C=Red, D=Orange, E=Yellow, F#=Green, A=Blue, B=Violet
const noteForColor = pitch % 12; // 12 distinct colors per octave

// Harmonic Mode: Circle of fifths mapping
const noteForColor = pitch % 12; // Harmonic relationships

// Spectrum Mode: Low notes=red, high notes=violet
const noteForColor = pitch; // Full MIDI range (12-120)

const color = getNoteColor(noteForColor, colorMode); // colorMapping.ts
```

---

#### **LED Display Compatibility**

‚úÖ **PRIMARY Information (Background Color + Brightness):**
- Maps directly to LED RGB + PWM intensity
- No borders needed for LED displays
- Clear visual hierarchy through brightness alone

‚úÖ **SECONDARY Information (Border Colors):**
- Educational for screen UI
- Not critical for LED displays
- Can be ignored when rendering to WLED

‚úÖ **TERTIARY Information (Glow Effects):**
- Subtle educational hints for screen UI
- Not rendered on LED displays
- Optional enhancement (can be disabled)

---

#### **Reference Implementation**
- Brightness system: `PianoCanvas.tsx:121-130` (3-tier brightness)
- ColorMode respect: `colorMapping.ts:57-102` (`getNoteColor()`)
- Music theory: `research/intelligent_melody_music_theory_primer.md:60-73`

---

#### **Visual Examples**

**Example 1: Click C (root) in column 0 (strong beat) with Cmaj7 chord**

Column 0 (same column):
- C: brightness `1.0` (placed) + 3px white border

Column 1 (next column):
- E, G, B (chord tones): brightness `0.85` (VERY recommended) + 2px colored borders (E's color, G's color, B's color) + subtle green glow
- D, F, A (scale notes): brightness `0.65` (RECOMMENDED) + 2px colored borders (D's color, F's color, A's color) + subtle blue glow
- C# (out-of-scale): brightness `0.2` (DIM) + 1px gray border + no glow

**User sees:** Chord tones are brightest, scale notes are bright, C# is very dim

**Example 2: Click D in column 2 (weak beat) with Cmaj7 chord**

Column 2 (same column):
- D: brightness `1.0` (placed) + 3px white border

Column 3 (next column):
- C, E (chord tones, weak beat): brightness `0.65` (RECOMMENDED) + 2px colored borders + subtle green glow
- F (scale note, weak beat): brightness `0.45` (ACCEPTABLE passing tone) + 2px colored border + subtle blue glow
- C# (out-of-scale): brightness `0.2` (DIM) + 1px gray border

**User sees:** Chord tones slightly brighter than passing tones, clear hierarchy

---

### 2.5. How Intelligent Melody Settings Influence Visual Suggestions ‚úÖ

**Core Principle:** Settings should provide **immediate visual feedback** in the suggestion system, not just affect generation output.

---

#### **Setting 1: Chord Tone Density (HIGH PRIORITY)**

**User Story:** "When I increase chord tone density, I want chord tones to be visually emphasized more in suggestions"

**Visual Impact:**
```typescript
// Chord Tone Density affects brightness multiplier for chord tone suggestions
function calculateChordToneBrightness(
  settings: IntelligentMelodySettings,
  isStrongBeat: boolean
): number {
  const baseStrength = isStrongBeat ? 0.85 : 0.65;

  switch (settings.chordToneDensity) {
    case 'high':
      // Emphasize chord tones MORE (increase brightness gap)
      return isStrongBeat ? 0.90 : 0.75; // Brighter than baseline
    case 'medium':
      return baseStrength; // Normal recommendations (0.85 / 0.65)
    case 'low':
      // De-emphasize chord tones (narrow brightness gap with scale notes)
      return isStrongBeat ? 0.75 : 0.55; // Closer to scale note brightness
  }
}

function calculateScaleNoteBrightness(
  settings: IntelligentMelodySettings,
  isStrongBeat: boolean
): number {
  const baseStrength = isStrongBeat ? 0.65 : 0.45;

  switch (settings.chordToneDensity) {
    case 'high':
      // De-emphasize scale notes when chord tones are prioritized
      return isStrongBeat ? 0.55 : 0.40; // Dimmer relative to chord tones
    case 'medium':
      return baseStrength; // Normal recommendations (0.65 / 0.45)
    case 'low':
      // Emphasize scale notes MORE (passing tones become more prominent)
      return isStrongBeat ? 0.70 : 0.50; // Closer to chord tone brightness
  }
}
```

**Visual Result:**
- **High Density:** Clear brightness gap (chord tones **much brighter** than scale notes)
- **Medium Density:** Moderate brightness gap (balanced recommendations)
- **Low Density:** Narrow brightness gap (chord tones and scale notes **similar brightness**)

**Brightness Table (Strong Beat Example):**

| Density | Chord Tone | Scale Note | Gap | Visual Effect |
|---------|-----------|-----------|-----|---------------|
| High | 0.90 | 0.55 | 0.35 | **Clear hierarchy** - chord tones dominant |
| Medium | 0.85 | 0.65 | 0.20 | **Balanced** - both visible |
| Low | 0.75 | 0.70 | 0.05 | **Subtle hierarchy** - passing tones encouraged |

---

#### **Setting 2: Melodic Contour (MEDIUM PRIORITY)**

**User Story:** "When I select 'Arch' contour, I want to see vertical suggestions weighted toward higher pitches in the middle of the sequence"

**Visual Impact:**
```typescript
// Contour affects which pitch ranges are brightened at different steps
function adjustBrightnessForContour(
  baseBrightness: number,
  pitch: number,
  step: number,
  contourType: 'arch' | 'valley' | 'ascending' | 'descending',
  visibleNotes: number[]
): number {
  const pitchPosition = visibleNotes.indexOf(pitch) / visibleNotes.length; // 0 = low, 1 = high
  const stepPosition = step / 16; // 0 = start, 1 = end

  switch (contourType) {
    case 'arch':
      // Emphasize high pitches in middle (peak at 50%)
      const archCurve = Math.sin(stepPosition * Math.PI); // 0 ‚Üí 1 ‚Üí 0
      const archBoost = pitchPosition * archCurve * 0.15; // Up to +15% brightness
      return Math.min(1.0, baseBrightness + archBoost);

    case 'valley':
      // Emphasize low pitches in middle (valley at 50%)
      const valleyCurve = 1 - Math.sin(stepPosition * Math.PI); // 1 ‚Üí 0 ‚Üí 1
      const valleyBoost = (1 - pitchPosition) * valleyCurve * 0.15;
      return Math.min(1.0, baseBrightness + valleyBoost);

    case 'ascending':
      // Gradually emphasize higher pitches (linear climb)
      const ascendBoost = pitchPosition * stepPosition * 0.15;
      return Math.min(1.0, baseBrightness + ascendBoost);

    case 'descending':
      // Gradually emphasize lower pitches (linear descent)
      const descendBoost = (1 - pitchPosition) * stepPosition * 0.15;
      return Math.min(1.0, baseBrightness + descendBoost);
  }
}
```

**Visual Result:**
- **Arch:** Middle steps (8-12) show brighter high notes, encouraging upward climb
- **Valley:** Middle steps show brighter low notes, encouraging downward motion
- **Ascending:** Later steps progressively brighten higher pitches
- **Descending:** Later steps progressively brighten lower pitches

**Example (Step 8 of 16, Arch contour):**
- High pitch (E5): base 0.85 + arch boost 0.12 = **0.97** (very bright)
- Mid pitch (C4): base 0.85 + arch boost 0.06 = **0.91** (bright)
- Low pitch (C3): base 0.85 + arch boost 0.02 = **0.87** (normal)

User sees: "Oh, the sequencer is suggesting I go higher here!"

---

#### **Setting 3: Passing Tones (HIGH PRIORITY)**

**User Story:** "When I enable passing tones, I want to see stepwise notes brightened when I create leaps"

**Visual Impact:**
```typescript
// Passing Tones setting affects brightness of notes between last placed note and current suggestions
function adjustBrightnessForPassingTones(
  baseBrightness: number,
  pitch: number,
  lastPlacedPitch: number | null,
  passingTonesEnabled: boolean
): number {
  if (!passingTonesEnabled || !lastPlacedPitch) {
    return baseBrightness; // No adjustment
  }

  const interval = Math.abs(pitch - lastPlacedPitch);

  // If this note is a stepwise connection to last placed note (within 2 semitones)
  if (interval <= 2) {
    // Brighten stepwise notes when passing tones enabled
    return Math.min(1.0, baseBrightness + 0.10); // +10% brightness boost
  }

  // If this note creates a leap (> major 2nd)
  if (interval > 2) {
    // Dim leap notes when passing tones enabled (discouraging jumps)
    return Math.max(0.2, baseBrightness - 0.10); // -10% brightness
  }

  return baseBrightness;
}
```

**Visual Result:**
- **Enabled:** Stepwise notes (within 2 semitones of last note) are brighter
- **Enabled:** Leap notes (> 2 semitones away) are dimmer
- **Disabled:** No stepwise preference (all intervals treated equally)

**Example (Last placed note: C4, Passing Tones: Enabled):**
- D4 (step): base 0.65 + passing boost 0.10 = **0.75** (brighter - encouraged)
- E4 (step): base 0.65 + passing boost 0.10 = **0.75** (brighter)
- G4 (leap): base 0.65 - leap penalty 0.10 = **0.55** (dimmer - discouraged)

User sees: "The sequencer is suggesting I move stepwise, not jump!"

---

#### **Setting 4: Rhythmic Pattern (LOW PRIORITY - Phase 2)**

**User Story:** "When I select 'Sparse' rhythm, I want to see fewer suggestions overall, emphasizing strong beats"

**Visual Impact:**
```typescript
// Rhythmic Pattern affects which steps show bright suggestions
function shouldShowSuggestion(
  step: number,
  rhythmicPattern: 'groove1' | 'groove2' | 'groove3' | 'triplet' | 'sparse' | 'random'
): boolean {
  const rhythmMasks = {
    groove1: [true, true, true, true, true, true, true, true], // All steps
    groove2: [true, true, true, true, true, true, true, true], // All steps
    groove3: [true, true, true, true, true, true, true, true], // All steps
    triplet: [true, true, true, false, true, true, true, false], // Triplet gaps
    sparse: [true, false, true, false, true, false, true, false], // Only strong beats
    random: [true, true, true, true, true, true, true, true], // All steps
  };

  const mask = rhythmMasks[rhythmicPattern];
  return mask[step % mask.length];
}

// Apply mask to brightness
function applyRhythmicMask(
  baseBrightness: number,
  step: number,
  settings: IntelligentMelodySettings
): number {
  if (!shouldShowSuggestion(step, settings.rhythmicPattern)) {
    // Dim suggestions on "rest" steps
    return Math.max(0.2, baseBrightness * 0.3); // 30% of brightness (very dim)
  }
  return baseBrightness;
}
```

**Visual Result:**
- **Sparse:** Only strong beats (0, 2, 4, 6...) show bright suggestions, weak beats are dimmed
- **Triplet:** Every 4th step is dimmed (creating triplet feel gaps)
- **Other patterns:** All steps show suggestions (different rhythmic emphasis)

---

#### **Combined Settings Example**

**User Configuration:**
- Contour: Arch
- Chord Tone Density: High
- Passing Tones: Enabled
- Rhythmic Pattern: Groove1 (no masking)

**Step 8 (middle of sequence), last placed note C4:**

| Pitch | Type | Base | +Contour | +Density | +Passing | Final | Visual |
|-------|------|------|----------|----------|----------|-------|--------|
| E5 | Chord Tone | 0.85 | +0.12 | +0.05 | +0.10 | **1.00** | ‚≠ê BRIGHTEST (capped at 1.0) |
| D4 | Scale Note | 0.65 | +0.06 | -0.10 | +0.10 | **0.71** | Bright |
| C#4 | Out-of-Scale | 0.20 | +0.02 | 0.00 | -0.10 | **0.12** | Very dim |
| G4 | Chord Tone | 0.85 | +0.08 | +0.05 | -0.10 | **0.88** | Very bright (leap penalty offset by chord tone) |

**User sees:**
- E5 (high chord tone, stepwise from E4) is **brightest** (arch peak + chord emphasis + stepwise)
- D4 (scale note, stepwise from C4) is **bright** (stepwise wins despite low density)
- C#4 (chromatic, leap) is **very dim** (out-of-scale + leap penalty)
- G4 (chord tone, leap) is **very bright** (chord tone wins despite leap penalty)

---

#### **Educational Feedback in UI**

**Settings Panel Footer (Dynamic):**
```tsx
<div className="bg-blue-900/20 border border-blue-700/30 rounded-lg p-3">
  <p className="text-xs text-blue-300">
    üí° <strong>Current Settings:</strong>
    {settings.chordToneDensity === 'high' &&
      " Chord tones will be MUCH brighter than scale notes."}
    {settings.contourType === 'arch' &&
      " Middle steps will suggest higher pitches."}
    {settings.passingTones &&
      " Stepwise notes will be brighter than leaps."}
    {settings.rhythmicPattern === 'sparse' &&
      " Only strong beats will show bright suggestions."}
  </p>
</div>
```

**Tooltip on Suggestion (Hover - Optional Enhancement):**
```tsx
// When hovering over a suggested note
<div className="tooltip">
  <strong>E5</strong> (chord tone)
  <br />
  Brightness: 0.97
  <br />
  Recommended because:
  <ul>
    <li>‚úì Chord tone (root)</li>
    <li>‚úì Arch contour peak</li>
    <li>‚úì Stepwise from E4</li>
  </ul>
</div>
```

---

#### **Implementation Priority**

**Phase 1 (MVP - Story 15.7):**
1. ‚úÖ Chord Tone Density ‚Üí Brightness adjustment (HIGH priority)
2. ‚úÖ Passing Tones ‚Üí Stepwise brightness boost (HIGH priority)

**Phase 2 (Post-Story):**
3. ‚è∏Ô∏è Melodic Contour ‚Üí Pitch range brightness boost (MEDIUM priority)
4. ‚è∏Ô∏è Rhythmic Pattern ‚Üí Step masking (LOW priority)

**Rationale:** Phase 1 settings directly affect **harmonic recommendations** (core user story). Phase 2 settings add **melodic shaping guidance** (enhancement).

---

### 3. Intelligent Melody Settings Panel ‚úÖ

**Must add collapsible settings panel with:**

```typescript
interface IntelligentMelodySettings {
  contourType: 'arch' | 'valley' | 'ascending' | 'descending' | 'random';
  rhythmicPattern: 'groove1' | 'groove2' | 'groove3' | 'triplet' | 'sparse' | 'random';
  chordToneDensity: 'low' | 'medium' | 'high'; // % of notes that are chord tones
  phrasingStyle: 'call-response' | 'continuous' | 'motif-repetition';
  passingTones: boolean; // Enable stepwise motion between leaps
  dynamicShaping: boolean; // Enable phrase-based velocity arcs
}
```

**UI Layout:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Intelligent Melody Settings         [‚ñº] ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Melodic Contour                         ‚îÇ
‚îÇ [ Arch ] [ Valley ] [ Ascending ] ...   ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ Rhythmic Pattern                         ‚îÇ
‚îÇ [ Groove 1 ] [ Groove 2 ] [ Triplet ]   ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ Chord Tone Density                       ‚îÇ
‚îÇ ‚óè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚óã‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ High             ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ ‚òë Enable Passing Tones                  ‚îÇ
‚îÇ ‚òë Dynamic Phrasing                      ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ üí° Current Settings:                    ‚îÇ
‚îÇ Chord tones will be MUCH brighter       ‚îÇ
‚îÇ than scale notes.                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Settings must persist to localStorage** (key: `chord-melody-settings-${instanceId}`)

---

### 4. Educational Visualization Features ‚úÖ

**Must add visual theory indicators:**

#### **Melodic Contour Overlay**
- SVG line graph overlaid on note grid showing melodic shape
- Peaks/valleys marked with small icons (‚ñ≤ peak, ‚ñº valley)
- Rendered above note grid, semi-transparent (opacity: 0.4)

#### **Phrase Markers**
- Vertical separator lines every 4 steps (bar lines)
- Labels above timeline: "Phrase 1", "Phrase 2"
- Different background colors per phrase (subtle: gray-850 vs gray-825)

#### **Active Chord Display**
- Show current chord name above note grid during playback
- Display chord tones as colored dots matching note colors
- Example: `Cmaj7 | C E G B` with colored dots

#### **Theory Tooltip on Generate Button**
- Hover tooltip: "Generating melody using {contourType} contour with {chordToneDensity} chord tone density"
- Brief educational message explaining the algorithm

---

### 5. Interactive Harmonic Guidance (Real-Time) ‚úÖ

**When clicking to add note in column N:**
1. Highlight columns N and N+1 with harmonic suggestions
2. Calculate brightness for each note based on:
   - Current chord at steps N and N+1
   - Whether note is chord tone vs scale note
   - Whether step is strong beat vs weak beat
   - **Settings adjustments** (chord tone density, contour, passing tones)
3. Update border colors to match background note colors
4. Apply subtle glow effects (optional educational hint)

**When removing note:**
- Clear harmonic suggestions in affected columns
- Reset to default grid state (brightness = 0.2, gray border)

**Visual Feedback:**
- Smooth transition animation (200ms ease-in-out)
- Clear visual weight through brightness hierarchy

---

## Technical Implementation

### File Structure

```
src/components/Studio/modules/ChordMelodyArranger/
‚îú‚îÄ‚îÄ MelodySequencer.tsx (EXISTING - to be enhanced)
‚îú‚îÄ‚îÄ IntelligentMelodyGenerator.ts (NEW - algorithm service)
‚îú‚îÄ‚îÄ MelodySettings.tsx (NEW - settings panel)
‚îú‚îÄ‚îÄ HarmonicGuidanceOverlay.tsx (NEW - visual guidance layer)
‚îî‚îÄ‚îÄ ContourVisualizer.tsx (NEW - SVG contour line)
```

### Core Algorithm (`IntelligentMelodyGenerator.ts`)

```typescript
/**
 * IntelligentMelodyGenerator Service
 * Generates chord-aware melodies using music theory best practices
 *
 * Inspired by:
 * - Piano Roll brightness system (PianoCanvas.tsx:121-130)
 * - Guitar Fretboard harmonic dimming (GuitarFretboard.tsx:466-477)
 * - Music theory primer (research/intelligent_melody_music_theory_primer.md)
 */

export class IntelligentMelodyGenerator {
  /**
   * Generate melody based on chord progression and settings
   */
  generateMelody(
    chords: Chord[],
    scaleNotes: number[],
    settings: IntelligentMelodySettings,
    sequenceLength: number = 16
  ): MelodyNote[] {
    const notes: MelodyNote[] = [];
    const contour = this.generateContour(settings.contourType, sequenceLength);
    const rhythm = this.generateRhythm(settings.rhythmicPattern, sequenceLength);

    for (let step = 0; step < sequenceLength; step++) {
      // 1. Get chord at this step (cycling through progression)
      const chordIndex = Math.floor((step / sequenceLength) * chords.length);
      const chord = chords[chordIndex];
      const chordTones = this.getChordTones(chord, scaleNotes);

      // 2. Determine if this step should have a note (rhythmic rests)
      if (rhythm[step].duration === 0) continue; // Rest

      // 3. Chord-aware pitch selection
      const pitch = this.selectPitch(
        step,
        chordTones,
        scaleNotes,
        contour[step],
        settings.chordToneDensity
      );

      // 4. Passing tone insertion (if enabled and leaps detected)
      if (settings.passingTones && notes.length > 0) {
        const lastNote = notes[notes.length - 1];
        const interval = Math.abs(pitch - lastNote.pitch);
        if (interval > 2) { // Leap > whole step
          const passingTone = this.insertPassingTone(lastNote.pitch, pitch, scaleNotes);
          if (passingTone) {
            notes.push({
              step: step - 0.5, // Half-step before current note
              pitch: passingTone,
              velocity: 70,
              duration: 0.25,
            });
          }
        }
      }

      // 5. Dynamic shaping (phrase-based velocity)
      const velocity = settings.dynamicShaping
        ? this.calculatePhrasedVelocity(step, sequenceLength)
        : 80;

      notes.push({
        step,
        pitch,
        velocity,
        duration: rhythm[step].duration,
      });
    }

    return notes;
  }

  /**
   * Select pitch based on contour and chord tone density
   */
  private selectPitch(
    step: number,
    chordTones: number[],
    scaleNotes: number[],
    contourValue: number, // 0-1 (low to high)
    density: 'low' | 'medium' | 'high'
  ): number {
    const isStrongBeat = step % 4 === 0;

    // Chord tone probability based on density and beat strength
    const chordToneChance = {
      low: isStrongBeat ? 0.5 : 0.2,
      medium: isStrongBeat ? 0.7 : 0.4,
      high: isStrongBeat ? 0.9 : 0.6,
    }[density];

    // Decide if using chord tone or scale note
    const useChordTone = Math.random() < chordToneChance;
    const notePool = useChordTone ? chordTones : scaleNotes;

    // Map contour value (0-1) to note pool index
    const noteIndex = Math.floor(contourValue * (notePool.length - 1));
    return notePool[noteIndex];
  }

  /**
   * Generate melodic contour curve (0-1 values for each step)
   */
  private generateContour(
    type: IntelligentMelodySettings['contourType'],
    length: number
  ): number[] {
    const contour: number[] = [];

    switch (type) {
      case 'arch':
        // Low ‚Üí High (peak at 50%) ‚Üí Low
        for (let i = 0; i < length; i++) {
          const t = i / length;
          contour.push(Math.sin(t * Math.PI)); // 0 ‚Üí 1 ‚Üí 0
        }
        break;
      case 'valley':
        // High ‚Üí Low (valley at 50%) ‚Üí High
        for (let i = 0; i < length; i++) {
          const t = i / length;
          contour.push(1 - Math.sin(t * Math.PI)); // 1 ‚Üí 0 ‚Üí 1
        }
        break;
      case 'ascending':
        // Gradual climb
        for (let i = 0; i < length; i++) {
          contour.push(i / length); // 0 ‚Üí 1
        }
        break;
      case 'descending':
        // Gradual descent
        for (let i = 0; i < length; i++) {
          contour.push(1 - i / length); // 1 ‚Üí 0
        }
        break;
      case 'random':
        // Random walk with smoothing
        let current = 0.5;
        for (let i = 0; i < length; i++) {
          current += (Math.random() - 0.5) * 0.3; // Small random steps
          current = Math.max(0, Math.min(1, current)); // Clamp 0-1
          contour.push(current);
        }
        break;
    }

    return contour;
  }

  /**
   * Generate rhythmic pattern
   */
  private generateRhythm(
    pattern: IntelligentMelodySettings['rhythmicPattern'],
    length: number
  ): Array<{ duration: number }> {
    const motifs = {
      groove1: [0.5, 0.25, 0.25, 0.5],        // Syncopated
      groove2: [0.25, 0.25, 0.5, 0.5],        // Front-loaded
      groove3: [0.75, 0.25, 0.5, 0.5],        // Anticipation
      triplet: [0.33, 0.33, 0.33, 0.5],       // Triplet feel
      sparse: [0.5, 0, 0.5, 0],               // Breathing room (0 = rest)
      random: null, // Will be randomized below
    };

    const baseMotif = motifs[pattern] || motifs.groove1;
    const rhythm: Array<{ duration: number }> = [];

    for (let i = 0; i < length; i++) {
      if (pattern === 'random') {
        // Random selection from duration pool
        const durations = [0.25, 0.5, 0.75, 0, 0.5];
        rhythm.push({ duration: durations[Math.floor(Math.random() * durations.length)] });
      } else {
        rhythm.push({ duration: baseMotif[i % baseMotif.length] });
      }
    }

    return rhythm;
  }

  /**
   * Calculate phrase-based velocity (not random)
   */
  private calculatePhrasedVelocity(step: number, totalLength: number): number {
    const phraseLength = 8; // 8-step phrases
    const phrasePosition = step % phraseLength;

    // Sine wave arc: velocity peaks at phrase middle
    const arc = Math.sin((phrasePosition / phraseLength) * Math.PI);
    let velocity = 70 + arc * 40; // 70-110 range

    // Add accent on downbeats (every 4 steps)
    if (step % 4 === 0) {
      velocity += 10;
    }

    return Math.round(velocity);
  }

  /**
   * Get chord tones from chord (MIDI note numbers)
   */
  private getChordTones(chord: Chord, scaleNotes: number[]): number[] {
    // Use ChordProgressionService to get MIDI notes from chord
    const chordMidiNotes = ChordProgressionService.getInstance().getChordNotes(chord);

    // Filter to only notes in current scale
    return chordMidiNotes.filter(note => scaleNotes.includes(note % 12));
  }

  /**
   * Insert passing tone between two notes (stepwise motion)
   */
  private insertPassingTone(
    fromPitch: number,
    toPitch: number,
    scaleNotes: number[]
  ): number | null {
    const direction = toPitch > fromPitch ? 1 : -1;
    const passingPitch = fromPitch + direction;

    // Check if passing pitch is in scale
    if (scaleNotes.includes(passingPitch % 12)) {
      return passingPitch;
    }

    return null; // No suitable passing tone
  }
}
```

---

### Harmonic Guidance UI (`HarmonicGuidanceOverlay.tsx`)

```typescript
/**
 * HarmonicGuidanceOverlay Component
 * Visual layer showing brightness-weighted harmonic suggestions
 *
 * Inspired by:
 * - Piano Roll 3-tier brightness (PianoCanvas.tsx:121-130)
 * - Guitar Fretboard dimming (GuitarFretboard.tsx:466-477, FretboardCanvas.tsx:104-180)
 */

interface HarmonicGuidanceProps {
  visibleNotes: number[]; // All notes in current scale
  currentChord: Chord | null; // Active chord at highlighted column
  highlightedColumn: number | null; // Column to show suggestions (N+1)
  lastPlacedNote: number | null; // Last placed pitch (for passing tone logic)
  settings: IntelligentMelodySettings;
  colorMode: ColorMode;
}

export const HarmonicGuidanceOverlay: React.FC<HarmonicGuidanceProps> = ({
  visibleNotes,
  currentChord,
  highlightedColumn,
  lastPlacedNote,
  settings,
  colorMode,
}) => {
  if (highlightedColumn === null || !currentChord) {
    return null; // No guidance to show
  }

  const chordTones = getChordTones(currentChord, visibleNotes);
  const isStrongBeat = highlightedColumn % 4 === 0;

  return (
    <div
      className="absolute inset-0 pointer-events-none"
      style={{ zIndex: 5 }}
    >
      {visibleNotes.map((pitch, pitchIndex) => {
        const noteClass = pitch % 12;
        const isInScale = visibleNotes.includes(pitch);
        const isChordTone = chordTones.includes(pitch);

        // Calculate base brightness
        let brightness = 0.2; // Out-of-scale (Tier 3)

        if (isInScale) {
          if (isChordTone) {
            // Chord tone brightness (affected by density setting)
            brightness = settings.chordToneDensity === 'high'
              ? (isStrongBeat ? 0.90 : 0.75)
              : settings.chordToneDensity === 'medium'
              ? (isStrongBeat ? 0.85 : 0.65)
              : (isStrongBeat ? 0.75 : 0.55); // low density
          } else {
            // Scale note brightness (affected by density setting)
            brightness = settings.chordToneDensity === 'high'
              ? (isStrongBeat ? 0.55 : 0.40)
              : settings.chordToneDensity === 'medium'
              ? (isStrongBeat ? 0.65 : 0.45)
              : (isStrongBeat ? 0.70 : 0.50); // low density (passing tones emphasized)
          }
        }

        // Apply passing tone adjustment (if enabled)
        if (settings.passingTones && lastPlacedNote !== null) {
          const interval = Math.abs(pitch - lastPlacedNote);
          if (interval <= 2) {
            brightness = Math.min(1.0, brightness + 0.10); // Stepwise boost
          } else if (interval > 2) {
            brightness = Math.max(0.2, brightness - 0.10); // Leap penalty
          }
        }

        // Get note color from colorMapping.ts
        const noteForColor = colorMode === 'spectrum' ? pitch : noteClass;
        const color = getNoteColor(noteForColor, colorMode);

        // Apply brightness to RGB (PRIMARY visual)
        const finalColor = {
          r: Math.round(color.r * brightness),
          g: Math.round(color.g * brightness),
          b: Math.round(color.b * brightness),
        };

        // Border color matches background (SECONDARY educational)
        const borderColor = `rgb(${finalColor.r}, ${finalColor.g}, ${finalColor.b})`;
        const borderWidth = brightness > 0.3 ? '2px' : '1px';

        // Subtle glow effect (QUATERNARY optional hint)
        const glowEffect = brightness < 0.3 ? 'none' :
          isChordTone ? '0 0 6px rgba(34, 197, 94, 0.3)' :
          isInScale ? '0 0 4px rgba(59, 130, 246, 0.25)' : 'none';

        // Calculate grid position
        const row = visibleNotes.length - pitchIndex - 1;
        const col = highlightedColumn;

        return (
          <div
            key={`guidance-${col}-${pitch}`}
            className="absolute transition-all duration-200 ease-in-out"
            style={{
              top: `${row * 32}px`, // 32px row height
              left: `${col * 40}px`, // 40px column width
              width: '36px',
              height: '28px',
              backgroundColor: `rgb(${finalColor.r}, ${finalColor.g}, ${finalColor.b})`,
              border: `${borderWidth} solid ${borderColor}`,
              borderRadius: '4px',
              boxShadow: glowEffect,
              opacity: 0.9,
            }}
          />
        );
      })}
    </div>
  );
};
```

---

### Settings Panel UI (`MelodySettings.tsx`)

```typescript
/**
 * MelodySettings Component
 * Collapsible panel for intelligent melody generation settings
 */

export const MelodySettings: React.FC<{
  settings: IntelligentMelodySettings;
  onSettingsChange: (settings: IntelligentMelodySettings) => void;
}> = ({ settings, onSettingsChange }) => {
  const [isOpen, setIsOpen] = useState(false);

  // Generate dynamic educational feedback
  const educationalFeedback = useMemo(() => {
    const messages: string[] = [];

    if (settings.chordToneDensity === 'high') {
      messages.push("Chord tones will be MUCH brighter than scale notes.");
    } else if (settings.chordToneDensity === 'low') {
      messages.push("Passing tones will be nearly as bright as chord tones.");
    }

    if (settings.contourType === 'arch') {
      messages.push("Middle steps will suggest higher pitches.");
    } else if (settings.contourType === 'valley') {
      messages.push("Middle steps will suggest lower pitches.");
    }

    if (settings.passingTones) {
      messages.push("Stepwise notes will be brighter than leaps.");
    }

    if (settings.rhythmicPattern === 'sparse') {
      messages.push("Only strong beats will show bright suggestions.");
    }

    return messages.join(' ');
  }, [settings]);

  return (
    <div className="bg-gray-800 rounded-lg border border-gray-700">
      {/* Header */}
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-750 transition-colors"
      >
        <div className="flex items-center gap-2">
          <Sparkles className="w-5 h-5 text-purple-400" />
          <span className="font-semibold text-white">Intelligent Melody Settings</span>
        </div>
        <ChevronDown
          className={`w-5 h-5 text-gray-400 transition-transform ${isOpen ? 'rotate-180' : ''}`}
        />
      </button>

      {/* Settings Content */}
      {isOpen && (
        <div className="p-4 space-y-4 border-t border-gray-700">
          {/* Melodic Contour */}
          <div>
            <label className="block text-sm font-medium text-gray-300 mb-2">
              Melodic Contour
            </label>
            <div className="flex gap-2 flex-wrap">
              {['arch', 'valley', 'ascending', 'descending', 'random'].map(type => (
                <button
                  key={type}
                  onClick={() => onSettingsChange({ ...settings, contourType: type as any })}
                  className={`px-3 py-2 rounded-lg text-xs font-medium transition-colors ${
                    settings.contourType === type
                      ? 'bg-purple-600 text-white'
                      : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                  }`}
                >
                  {type.charAt(0).toUpperCase() + type.slice(1)}
                </button>
              ))}
            </div>
          </div>

          {/* Rhythmic Pattern */}
          <div>
            <label className="block text-sm font-medium text-gray-300 mb-2">
              Rhythmic Pattern
            </label>
            <div className="flex gap-2 flex-wrap">
              {['groove1', 'groove2', 'groove3', 'triplet', 'sparse', 'random'].map(pattern => (
                <button
                  key={pattern}
                  onClick={() => onSettingsChange({ ...settings, rhythmicPattern: pattern as any })}
                  className={`px-3 py-2 rounded-lg text-xs font-medium transition-colors ${
                    settings.rhythmicPattern === pattern
                      ? 'bg-blue-600 text-white'
                      : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                  }`}
                >
                  {pattern.charAt(0).toUpperCase() + pattern.slice(1).replace(/[0-9]/g, ' $&')}
                </button>
              ))}
            </div>
          </div>

          {/* Chord Tone Density Slider */}
          <div>
            <label className="block text-sm font-medium text-gray-300 mb-2">
              Chord Tone Density: <span className="text-purple-400">{settings.chordToneDensity}</span>
            </label>
            <input
              type="range"
              min="0"
              max="2"
              step="1"
              value={['low', 'medium', 'high'].indexOf(settings.chordToneDensity)}
              onChange={(e) => {
                const densities = ['low', 'medium', 'high'];
                onSettingsChange({ ...settings, chordToneDensity: densities[parseInt(e.target.value)] as any });
              }}
              className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-purple-600"
            />
            <div className="flex justify-between text-xs text-gray-400 mt-1">
              <span>Low</span>
              <span>Medium</span>
              <span>High</span>
            </div>
          </div>

          {/* Checkboxes */}
          <div className="space-y-2">
            <label className="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                checked={settings.passingTones}
                onChange={(e) => onSettingsChange({ ...settings, passingTones: e.target.checked })}
                className="w-4 h-4 rounded border-gray-600 bg-gray-700 text-purple-600"
              />
              <span className="text-sm text-gray-300">Enable Passing Tones (smooth stepwise motion)</span>
            </label>
            <label className="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                checked={settings.dynamicShaping}
                onChange={(e) => onSettingsChange({ ...settings, dynamicShaping: e.target.checked })}
                className="w-4 h-4 rounded border-gray-600 bg-gray-700 text-purple-600"
              />
              <span className="text-sm text-gray-300">Dynamic Phrasing (phrase-based velocity arcs)</span>
            </label>
          </div>

          {/* Educational Feedback (Dynamic) */}
          {educationalFeedback && (
            <div className="bg-blue-900/20 border border-blue-700/30 rounded-lg p-3">
              <p className="text-xs text-blue-300">
                üí° <strong>Current Settings:</strong> {educationalFeedback}
              </p>
            </div>
          )}

          {/* Music Theory Tip */}
          <div className="bg-purple-900/20 border border-purple-700/30 rounded-lg p-3">
            <p className="text-xs text-purple-300">
              üí° <strong>Music Theory:</strong> High chord tone density emphasizes harmony (stable, consonant).
              Low density allows more melodic freedom with passing tones (smooth, flowing).
            </p>
          </div>
        </div>
      )}
    </div>
  );
};
```

---

## Manual Verification Steps

### Step 1: Intelligent Generation Algorithm
1. Select a chord progression (e.g., "I-V-vi-IV Pop")
2. Open Intelligent Melody Settings
3. Set contour to "Arch", density to "High"
4. Click "Generate Melody"
5. **Verify:** Notes on strong beats (steps 0, 4, 8, 12) are primarily chord tones
6. **Verify:** Melodic shape follows arch contour (low ‚Üí high ‚Üí low)
7. **Verify:** Velocity increases toward phrase middle, decreases at end (phrase arc)

### Step 2: Harmonic Guidance UX (Brightness System)
1. Clear all notes (trash icon)
2. Click to add note in column 0 (first step) - select C (root)
3. **Verify:** Column 0: C has brightness 1.0 + 3px white border
4. **Verify:** Column 1: Chord tones (E, G, B) have brightness 0.85-0.90 (brightest suggestions)
5. **Verify:** Column 1: Scale notes (D, F, A) have brightness 0.55-0.65 (dimmer than chord tones)
6. **Verify:** Column 1: Out-of-scale notes (C#, D#) have brightness 0.2 (very dim, gray border)
7. **Verify:** Column 1: All suggested notes have 2px borders matching their background color
8. **Verify:** Subtle green/blue glow on bright suggestions (optional, not primary)
9. Click to add note in column 1, verify column 2 highlights
10. Remove note from column 0, verify column 1 guidance clears

### Step 2b: Settings-Driven Visual Feedback
1. Set Chord Tone Density to "High"
2. Click to add C4 in column 0
3. **Verify:** Column 1 chord tones (E, G) have brightness ~0.90 (very bright)
4. **Verify:** Column 1 scale notes (D, F) have brightness ~0.55 (dimmer than chord tones)
5. **Verify:** Clear visual hierarchy (chord tones much brighter)
6. **Verify:** Settings panel footer shows: "Chord tones will be MUCH brighter than scale notes."
7. Set Chord Tone Density to "Low"
8. **Verify:** Column 1 chord tones and scale notes have similar brightness (0.75 vs 0.70)
9. **Verify:** Settings panel footer updates to reflect new setting
10. Enable "Passing Tones"
11. Click D4 in column 2 (after C4)
12. **Verify:** Column 3 stepwise notes (C4, E4) are brighter than leap notes (G4, A4)
13. **Verify:** Stepwise notes get +10% brightness boost
14. **Verify:** Leap notes get -10% brightness penalty

### Step 3: ColorMode Integration
1. Switch color mode to "Chromatic"
2. **Verify:** Notes show chromatic colors (C=Red, D=Orange, E=Yellow, etc.)
3. **Verify:** Brightness levels remain consistent (0.90 for chord tones, 0.65 for scale notes)
4. **Verify:** Border colors match background note colors
5. Switch color mode to "Harmonic"
6. **Verify:** Notes show harmonic (circle of fifths) colors
7. **Verify:** Brightness levels remain consistent
8. Switch color mode to "Spectrum"
9. **Verify:** Low notes are reddish, high notes are violet
10. **Verify:** Brightness levels remain consistent

### Step 4: Educational Features
1. Generate melody with "Arch" contour
2. **Verify:** Contour overlay line shows arch shape (SVG curve)
3. **Verify:** Phrase markers appear every 4 steps (bar lines)
4. **Verify:** Active chord displays above grid during playback (e.g., "Cmaj7 | C E G B")
5. Hover over Generate button
6. **Verify:** Tooltip shows: "Generating melody using arch contour with high chord tone density"

### Step 5: Rhythmic Variety
1. Generate with "Groove1" pattern
2. **Verify:** Syncopated rhythm (0.5, 0.25, 0.25, 0.5) repeats
3. Generate with "Sparse" pattern
4. **Verify:** Intentional rests (empty steps) create breathing room
5. **Verify:** Not just fixed [0.25, 0.5, 0.25, 0.25] pattern from old algorithm

### Step 6: Passing Tones (if enabled)
1. Enable "Passing Tones" in settings
2. Generate melody
3. **Verify:** No jarring leaps > major 2nd (stepwise motion between chord tones)
4. Disable passing tones
5. **Verify:** Some leaps may occur (more angular melody)

### Step 7: Module Routing with Intelligent Melody
1. Add Piano Roll module to Studio
2. Route Chord & Melody Arranger ‚Üí Piano Roll
3. Enable "Route Notes" in OutputSelector
4. Generate intelligent melody
5. Press Play
6. **Verify:** Piano Roll receives and displays melody notes
7. **Verify:** Notes align with chord progression (harmonic coherence)

---

## Dependencies

**Services:**
- ‚úÖ `ChordProgressionService` (Story 15.1) - Get chord tones for each chord
- ‚úÖ `ModuleRoutingService` (Story 15.4) - Route generated melody to target modules
- ‚úÖ `GlobalMusicContext` (Epic 4) - Key/scale/tempo/colorMode synchronization

**UI Components:**
- ‚úÖ `MelodySequencer` (Story 15.3) - Base component to enhance
- ‚úÖ `ChordTimeline` (Story 15.2) - Get active chord at each step
- üÜï `IntelligentMelodyGenerator` (NEW) - Algorithm service
- üÜï `HarmonicGuidanceOverlay` (NEW) - Visual guidance layer
- üÜï `MelodySettings` (NEW) - Settings panel with dynamic feedback
- üÜï `ContourVisualizer` (NEW) - SVG contour line

**Utils:**
- ‚úÖ `getNoteColor` (colorMapping.ts) - Color notes based on chromatic/harmonic/spectrum mode
- ‚úÖ `getChordTones()` - Extract MIDI note numbers from Chord object

---

## Technical Debt / Future Enhancements

### Phase 2 (Post-Story):
- **Contour brightness boost:** Implement pitch range brightness adjustments (Section 2.5, Setting 2)
- **Rhythmic step masking:** Implement sparse/triplet step dimming (Section 2.5, Setting 4)
- **AI-assisted suggestions:** ML model to suggest melodies based on genre/style
- **Motif repetition:** Repeat melodic phrases with variation (call-response structure)
- **User-defined rhythm patterns:** Custom rhythmic motif editor
- **Microtiming/swing:** Humanize timing (not strict quantization)
- **Multi-voice melodies:** Generate harmony lines (counter-melodies)

### Phase 3 (Epic 16+):
- **Melody library:** Save/load user-created melodies
- **Melody sharing:** Community melody marketplace
- **MIDI export:** Export melody as MIDI file (.mid)
- **Pattern recognition:** Arpeggio/intervallic detection (Story 15.8)

---

## Definition of Done

- [x] IntelligentMelodyGenerator service implemented with all 6 algorithm features
- [x] HarmonicGuidanceOverlay shows brightness-based guidance system (LED-compatible)
- [x] Interactive highlighting on note click (columns N and N+1 suggestions)
- [x] MelodySettings panel with all 6 settings and dynamic educational feedback
- [x] Settings-driven visual brightness (chord tone density, passing tones affect brightness)
- [x] Educational features: contour overlay, phrase markers, active chord display
- [x] ColorMode integration (chromatic/harmonic/spectrum respected in all brightness calculations)
- [x] Border colors match note background colors (except white for active notes)
- [x] Subtle glow effects (optional educational hints, not primary information)
- [x] Settings persist to localStorage
- [x] All 7 manual verification steps pass
- [x] TypeScript build succeeds with no errors
- [x] Code follows existing patterns (Piano Roll brightness, Guitar Fretboard dimming, colorMapping.ts)
- [x] Browser DevTools performance: maintains 60fps during playback with guidance enabled
- [x] Responsive design: works on mobile (touch targets 44px+) and desktop

---

## Story Points: 15 (High Complexity)

**Breakdown:**
- Algorithm implementation (IntelligentMelodyGenerator): 4 points
- Harmonic guidance UI (brightness-based, LED-compatible): 3 points
- Settings-driven visual feedback (Section 2.5): 3 points (NEW)
- Settings panel with dynamic feedback: 2 points
- Educational features (contour, markers, tooltips): 2 points
- Integration with existing MelodySequencer: 1 point

**Time Estimate:** 14-18 hours (increased from 12-16 due to settings-driven visual feedback)

---

## Related Documentation

**Music Theory Reference:**
- `research/intelligent_melody_music_theory_primer.md` - Comprehensive algorithm design

**Brownfield Code Patterns:**
- `src/components/PianoRoll/PianoCanvas.tsx:121-130` - 3-tier brightness system (PRIMARY reference)
- `src/components/GuitarFretboard/GuitarFretboard.tsx:466-477` - 3-tier brightness values
- `src/components/GuitarFretboard/FretboardCanvas.tsx:104-180` - Interval-based guidance (single active note)
- `src/utils/colorMapping.ts:57-102` - `getNoteColor()` function (respects colorMode)

**Data Models:**
- `src/types/chordProgression.ts` - Chord, ChordNote, RomanNumeralProgression interfaces
- `src/components/Studio/modules/ChordMelodyArranger/MelodySequencer.tsx:26` - MelodyNote interface

**Global State:**
- `src/contexts/GlobalMusicContext.tsx` - Key/scale/tempo/colorMode state

---

## Stakeholder Sign-Off

**Product Owner (Myles):** ‚úÖ **APPROVED** Date: 2025-01-14
**UX Expert (Mary):** _____________________________ Date: _______
**Dev Lead:** _____________________________ Date: _______

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-14 | 1.0 | Initial story creation - Intelligent Melody Generator with Harmonic Guidance | John (PM) |
| 2025-01-14 | 2.0 | Revised UX with brightness-based system (Myles-approved, LED-compatible) | John (PM) |
| 2025-01-14 | 2.1 | Added Section 2.5: Settings-Driven Visual Feedback | John (PM) |

---

## Next Steps

1. **Dev Review** - Developer to review story and ask clarifying questions
2. **Design Mockups** - UX to create visual examples of brightness hierarchy (0.90 vs 0.65 vs 0.45 vs 0.2)
3. **Implementation** - Begin with IntelligentMelodyGenerator service (testable in isolation)
4. **Iterative Testing** - Manual verification after each component (algorithm ‚Üí guidance ‚Üí settings ‚Üí settings-driven feedback ‚Üí educational)
5. **User Feedback** - Gather feedback on educational value and melody quality

---

## Related Stories

- **Story 15.8:** Arpeggio & Pattern Recognition Suggestions (BACKLOG - Medium priority)
  - Detects patterns in user-placed notes
  - Shows "emerging/growing" predictions
  - Predictions factor in pitch range position (top/middle/bottom)
