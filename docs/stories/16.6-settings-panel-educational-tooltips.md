# Story 16.6: Settings Panel and Educational Tooltips

## Status
Draft

## Story
**As a** guitar player learning music theory through the fretboard module,
**I want** user-facing controls for harmonic guidance with educational tooltips,
**so that** I understand how settings affect visual feedback and can adjust guidance to match my skill level.

## Acceptance Criteria
1. Settings panel has "Harmonic Guidance" card with controls
2. Chord tone density control updates brightness calculations (high/medium/low slider)
3. Passing tones toggle affects interval-based brightness adjustments
4. Brightness preview shows example frets at different brightness levels
5. Tooltips explain musical concepts (chord tones, passing tones, scale degrees, etc.)
6. 'H' keyboard shortcut toggles harmonic guidance on/off
7. Settings persist in localStorage (survive page refresh)

## Tasks / Subtasks

- [ ] Add "Harmonic Guidance" settings card UI (AC: 1)
  - [ ] Create new collapsible card in settings panel
  - [ ] Add card header with icon and title: "🎼 Harmonic Guidance"
  - [ ] Add master toggle: "Show Harmonic Guidance" (on/off switch)
  - [ ] Card expands to show additional controls when toggle is ON

- [ ] Add chord tone density control (AC: 2)
  - [ ] Add slider or radio buttons: High / Medium / Low
  - [ ] Default: Medium
  - [ ] Update `intelligentMelodySettings.chordToneDensity` state
  - [ ] Add tooltip: "High: Strong emphasis on chord tones (bright). Low: More freedom with scale notes (balanced)."
  - [ ] Visual indicator: Show brightness difference (0.90 vs 0.55 for high, 0.75 vs 0.70 for low)

- [ ] Add passing tones toggle (AC: 3)
  - [ ] Add checkbox or switch: "Favor Stepwise Motion"
  - [ ] Default: ON (true)
  - [ ] Update `intelligentMelodySettings.passingTones` state
  - [ ] Add tooltip: "When enabled, notes close in pitch (stepwise motion) are brighter than large leaps. Encourages smooth voice leading."

- [ ] Add brightness preview section (AC: 4)
  - [ ] Show 5 example fret cells with different brightness levels:
    - Placed Note (1.0) - Full brightness
    - Chord Tone, Strong Beat (0.90) - Very bright
    - Chord Tone, Weak Beat (0.75) - Bright
    - Scale Note (0.55) - Medium
    - Out-of-Scale (0.20) - Very dim
  - [ ] Update preview when settings change (chord tone density, passing tones)
  - [ ] Each cell shows brightness value as label

- [ ] Add educational tooltips (AC: 5)
  - [ ] **Chord Tones**: "Notes that belong to the current chord (root, 3rd, 5th, 7th). Create harmonic stability."
  - [ ] **Scale Notes**: "Notes in the current scale but not in the chord. Add melodic color."
  - [ ] **Strong Beats**: "Steps 0, 4, 8, 12 (downbeats in 4/4 time). Best for chord tones and phrase endings."
  - [ ] **Passing Tones**: "Notes that connect chord tones smoothly (stepwise motion). Create melodic flow."
  - [ ] **Chromatic Notes**: "Notes outside the current scale. Advanced technique for tension and color."
  - [ ] Use question mark icon (?) next to each term that shows tooltip on hover

- [ ] Add 'H' keyboard shortcut (AC: 6)
  - [ ] Listen for 'H' key press (case-insensitive)
  - [ ] Toggle `showHarmonicGuidance` state
  - [ ] Show brief notification: "Harmonic Guidance: ON" or "OFF"
  - [ ] Add keyboard shortcut hint in settings panel: "Press 'H' to toggle"

- [ ] Implement localStorage persistence (AC: 7)
  - [ ] Save settings to localStorage when changed:
    - `showHarmonicGuidance`
    - `intelligentMelodySettings` (chord tone density, passing tones)
  - [ ] Load settings from localStorage on component mount
  - [ ] Use key: `guitar-fretboard-harmonic-settings`
  - [ ] Handle JSON parse errors gracefully (fallback to defaults)

## Dev Notes

### Relevant Source Tree
- **GuitarFretboard**: `src/components/GuitarFretboard/GuitarFretboard.tsx` (state management, keyboard shortcuts)
- **Settings Panel**: Currently implemented as collapsible cards in standalone mode (lines 984-1051)
- **IntelligentMelodyService**: `src/services/intelligentMelodyService.ts` (settings structure, getDefaultSettings())
- **localStorage Utils**: Use existing patterns from project (localStorage.getItem/setItem)

### Settings UI Design

**Layout Structure**:
```
┌─────────────────────────────────────────────┐
│ 🎼 Harmonic Guidance                    [X] │ ← Card header with collapse toggle
├─────────────────────────────────────────────┤
│ ☑ Show Harmonic Guidance                   │ ← Master toggle
│                                             │
│ Chord Tone Density                          │
│ ○ High   ● Medium   ○ Low                   │ ← Radio buttons
│ ⓘ High: Strong chord tone emphasis         │ ← Tooltip
│                                             │
│ ☑ Favor Stepwise Motion (Passing Tones)    │ ← Checkbox
│ ⓘ Smooth voice leading vs large leaps      │
│                                             │
│ Brightness Preview:                         │
│ [█████] Placed (1.0)                        │
│ [████░] Chord Tone, Strong (0.90)           │
│ [███░░] Chord Tone, Weak (0.75)             │
│ [██░░░] Scale Note (0.55)                   │
│ [▒░░░░] Out-of-Scale (0.20)                 │
│                                             │
│ Keyboard shortcut: Press 'H' to toggle     │
└─────────────────────────────────────────────┘
```

**Component Structure**:
```tsx
<div className="bg-gray-800 rounded-lg border border-gray-700 p-4">
  <h3 className="text-sm font-medium text-gray-300 mb-3 flex items-center gap-2">
    <span>🎼</span>
    <span>Harmonic Guidance</span>
  </h3>

  {/* Master Toggle */}
  <label className="flex items-center gap-2 mb-4">
    <input
      type="checkbox"
      checked={showHarmonicGuidance}
      onChange={(e) => setShowHarmonicGuidance(e.target.checked)}
      className="w-4 h-4"
    />
    <span className="text-sm text-white">Show Harmonic Guidance</span>
  </label>

  {showHarmonicGuidance && (
    <>
      {/* Chord Tone Density Control */}
      <div className="mb-4">
        <label className="text-sm text-gray-300 mb-2 flex items-center gap-2">
          <span>Chord Tone Density</span>
          <TooltipIcon text="High: Strong emphasis on chord tones (bright). Low: More freedom with scale notes (balanced)." />
        </label>
        <div className="flex gap-4">
          {['high', 'medium', 'low'].map(density => (
            <label key={density} className="flex items-center gap-1">
              <input
                type="radio"
                name="chordToneDensity"
                value={density}
                checked={intelligentMelodySettings.chordToneDensity === density}
                onChange={(e) => setIntelligentMelodySettings(prev => ({
                  ...prev,
                  chordToneDensity: e.target.value as 'high' | 'medium' | 'low'
                }))}
              />
              <span className="text-xs text-white capitalize">{density}</span>
            </label>
          ))}
        </div>
      </div>

      {/* Passing Tones Toggle */}
      <label className="flex items-center gap-2 mb-4">
        <input
          type="checkbox"
          checked={intelligentMelodySettings.passingTones}
          onChange={(e) => setIntelligentMelodySettings(prev => ({
            ...prev,
            passingTones: e.target.checked
          }))}
          className="w-4 h-4"
        />
        <span className="text-sm text-white">Favor Stepwise Motion</span>
        <TooltipIcon text="When enabled, notes close in pitch (stepwise motion) are brighter than large leaps. Encourages smooth voice leading." />
      </label>

      {/* Brightness Preview */}
      <BrightnessPreview settings={intelligentMelodySettings} />

      {/* Keyboard Shortcut Hint */}
      <p className="text-xs text-gray-500 mt-4">
        Keyboard shortcut: Press <kbd className="px-1 py-0.5 bg-gray-700 rounded">H</kbd> to toggle
      </p>
    </>
  )}
</div>
```

### Brightness Preview Component

```typescript
interface BrightnessPreviewProps {
  settings: IntelligentMelodySettings;
}

function BrightnessPreview({ settings }: BrightnessPreviewProps) {
  const exampleBrightnesses = [
    { label: 'Placed Note', brightness: 1.0, color: 'primary-500' },
    { label: 'Chord Tone, Strong', brightness: 0.90, color: 'primary-500' },
    { label: 'Chord Tone, Weak', brightness: 0.75, color: 'primary-500' },
    { label: 'Scale Note', brightness: 0.55, color: 'primary-500' },
    { label: 'Out-of-Scale', brightness: 0.20, color: 'primary-500' },
  ];

  return (
    <div className="space-y-2 mb-4">
      <p className="text-xs text-gray-400 mb-2">Brightness Preview:</p>
      {exampleBrightnesses.map(example => {
        // Apply visual amplification (same as real rendering)
        const amplified = example.brightness === 1.0
          ? 1.0
          : 0.1 + (example.brightness - 0.3) * (0.9 / 0.7);
        const finalBrightness = Math.max(0.1, Math.min(1.0, amplified));

        return (
          <div key={example.label} className="flex items-center gap-2">
            <div
              className="w-16 h-4 border border-gray-600 rounded"
              style={{
                backgroundColor: `rgba(99, 102, 241, ${finalBrightness})`,
              }}
            />
            <span className="text-xs text-gray-300">
              {example.label} ({example.brightness.toFixed(2)})
            </span>
          </div>
        );
      })}
    </div>
  );
}
```

### Educational Tooltip Component

```typescript
interface TooltipIconProps {
  text: string;
}

function TooltipIcon({ text }: TooltipIconProps) {
  const [showTooltip, setShowTooltip] = useState(false);

  return (
    <div className="relative inline-block">
      <button
        className="text-gray-400 hover:text-white transition-colors"
        onMouseEnter={() => setShowTooltip(true)}
        onMouseLeave={() => setShowTooltip(false)}
      >
        <span className="text-xs">ⓘ</span>
      </button>
      {showTooltip && (
        <div className="absolute left-0 top-full mt-1 w-64 p-2 bg-gray-900 border border-gray-700 rounded text-xs text-gray-300 z-50">
          {text}
        </div>
      )}
    </div>
  );
}
```

### Keyboard Shortcut Implementation

```typescript
// Add to existing keyboard shortcuts in GuitarFretboard.tsx
useEffect(() => {
  const handleKeyPress = (e: KeyboardEvent) => {
    // ... existing shortcuts (c, n, space) ...

    if (e.key === 'h' || e.key === 'H') {
      e.preventDefault();
      setShowHarmonicGuidance(prev => !prev);

      // Show brief notification (optional)
      console.log(`Harmonic Guidance: ${!showHarmonicGuidance ? 'ON' : 'OFF'}`);
    }
  };

  window.addEventListener('keydown', handleKeyPress);
  return () => window.removeEventListener('keydown', handleKeyPress);
}, [showHarmonicGuidance]); // Include dependency for accurate toggle
```

### localStorage Persistence

```typescript
// Save settings when changed
useEffect(() => {
  const settingsToSave = {
    showHarmonicGuidance,
    intelligentMelodySettings,
  };
  localStorage.setItem(
    'guitar-fretboard-harmonic-settings',
    JSON.stringify(settingsToSave)
  );
}, [showHarmonicGuidance, intelligentMelodySettings]);

// Load settings on mount
useEffect(() => {
  try {
    const saved = localStorage.getItem('guitar-fretboard-harmonic-settings');
    if (saved) {
      const parsed = JSON.parse(saved);
      if (parsed.showHarmonicGuidance !== undefined) {
        setShowHarmonicGuidance(parsed.showHarmonicGuidance);
      }
      if (parsed.intelligentMelodySettings) {
        setIntelligentMelodySettings(parsed.intelligentMelodySettings);
      }
    }
  } catch (error) {
    console.error('Failed to load harmonic guidance settings:', error);
    // Fallback to defaults (already set in initial state)
  }
}, []); // Run once on mount
```

### Educational Content Guidelines

**Tone**: Friendly, encouraging, non-condescending
**Language**: Simple terms, avoid jargon when possible
**Examples**: Use concrete musical examples (e.g., "Root, 3rd, 5th" not just "chord tones")

**Tooltip Text Examples**:

**Chord Tones**:
> "Notes that belong to the current chord (e.g., C-E-G for a C major chord). These notes create harmonic stability and sound consonant when played over the chord."

**Scale Notes**:
> "Notes in the current scale but not in the active chord. These add melodic color and variety. For example, in C major, the note D is a scale note but not in a C major chord."

**Strong Beats**:
> "Downbeats (steps 0, 4, 8, 12 in 4/4 time). These are the strongest rhythmic positions, ideal for chord tones and phrase endings. Like the '1' in '1-2-3-4'."

**Passing Tones**:
> "Notes that connect chord tones smoothly by stepwise motion (moving up or down by 1-2 frets). Creates melodic flow and natural voice leading."

**Chromatic Notes**:
> "Notes outside the current scale. Advanced technique used for tension, color, and jazz/blues inflections. Use sparingly for expressive effect."

### Testing
**Manual Verification Steps**:

1. **Settings Panel UI**:
   - Open Guitar Fretboard module
   - Click Settings button
   - Verify "Harmonic Guidance" card appears
   - Verify master toggle works (on/off)
   - Verify card expands/collapses

2. **Chord Tone Density Control**:
   - Set to High → Verify chord tones much brighter than scale notes
   - Set to Low → Verify chord tones and scale notes have similar brightness
   - Set to Medium → Verify balanced brightness

3. **Passing Tones Toggle**:
   - Enable → Hover over fret, verify stepwise notes brighter than leaps
   - Disable → Verify brightness ignores interval distance

4. **Brightness Preview**:
   - Change chord tone density → Verify preview updates
   - Toggle passing tones → Verify preview updates
   - Verify 5 example cells show correct brightness levels

5. **Educational Tooltips**:
   - Hover over ⓘ icons next to each term
   - Verify tooltip appears with explanatory text
   - Verify tooltip is readable (not cut off by screen edges)
   - Move mouse away → Tooltip disappears

6. **Keyboard Shortcut**:
   - Press 'H' key → Harmonic guidance toggles OFF
   - Press 'H' again → Harmonic guidance toggles ON
   - Verify shortcut works from anywhere in the module

7. **localStorage Persistence**:
   - Change settings (toggle guidance OFF, set density to High)
   - Refresh page (F5)
   - Verify settings persist (guidance still OFF, density still High)
   - Clear localStorage → Verify defaults restore

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-15 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*To be filled by QA agent*
