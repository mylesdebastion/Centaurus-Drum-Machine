# Story 8.1: Local Preset Save/Load

**Epic:** WLED Preset Management (Paid Feature)
**Status:** ğŸ“ Planning
**Priority:** High
**Complexity:** Medium
**Prerequisite:** Story 6.1 Phase 0 (Unified WLED Device Manager) âœ…

## Brief Description

Enable users to save their current WLED device configurations as named presets and quickly load them later, using localStorage for initial implementation. This provides the foundation for cloud-synced presets (Story 8.3) while allowing rapid UX iteration without database complexity.

---

## Story

**As a** musician setting up WLED hardware for performances,
**I want** to save my current device configuration as a named preset,
**so that** I can quickly switch between different hardware setups (guitar rig, drum kit, full band) without manually reconfiguring IP addresses and settings each time.

---

## Background / Context

### Current State (Story 6.1 Phase 0)
- âœ… WLEDDeviceManager component manages multiple devices
- âœ… Devices auto-save to localStorage per experiment (`storageKey` prop)
- âœ… Each experiment (`/jam`, `/wled-test`, `/dj-visualizer`) maintains separate device list
- âŒ No named presets â€” users manually configure devices each time
- âŒ Can't quickly switch between different hardware configurations
- âŒ Can't share configurations with other users or devices

### User Pain Points
1. **Repetitive Setup:** Users configure same devices repeatedly across experiments
2. **Performance Anxiety:** Manual setup before live performances is error-prone
3. **Multi-Config Scenarios:** Users with multiple rigs (guitar + drums, studio vs live) can't switch quickly
4. **No Backup:** Clearing browser data loses all configurations

### Target Architecture (Story 8.1 â†’ Story 8.3)

```
Story 8.1 (This Story):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Browser (localStorage)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ wled-presets-v1               â”‚  â”‚
â”‚  â”‚ [                             â”‚  â”‚
â”‚  â”‚   { id, name, devices[] },    â”‚  â”‚
â”‚  â”‚   { id, name, devices[] }     â”‚  â”‚
â”‚  â”‚ ]                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                     â”‚
â”‚  WLEDDeviceManager component        â”‚
â”‚  â†’ Save preset                      â”‚
â”‚  â†’ Load preset                      â”‚
â”‚  â†’ Auto-migrate to cloud (Story 8.3)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Story 8.3 (Future - Cloud Migration):
localStorage â†’ One-time migration â†’ Supabase PostgreSQL
                                    â†“
                              Cloud sync across devices
```

### Why localStorage First?
- âœ… **Fast UX Iteration:** No auth/database complexity during development
- âœ… **Offline-First:** Works immediately without backend
- âœ… **Migration Path:** Becomes offline cache in Story 8.3
- âœ… **Internal Testing:** Team can test presets before monetization setup

---

## Acceptance Criteria

### AC 1: Save Current Configuration as Named Preset âœ…

**Given** I have configured 2+ WLED devices in WLEDDeviceManager
**When** I click "Save Preset" and enter a name
**Then** my current device list is saved to localStorage
**And** I see a success toast notification
**And** the new preset appears in the preset selector dropdown

**Details:**
- Preset name is required (1-50 characters)
- Description is optional (0-200 characters)
- Preset includes all current devices with full configuration:
  - IP address, name, LED count, device type
  - brightness, reverseDirection, enabled state
  - matrixConfig (if applicable)
  - All visualization settings
- Duplicate names are prevented (inline validation)
- Preset is immediately available (no page reload required)

**Edge Cases:**
- Empty device list: Show warning "No devices to save. Add devices first."
- Duplicate name: Show inline error "Preset name already exists"
- localStorage quota exceeded: Show error with guidance (see Error States)

---

### AC 2: Load Preset from Selector âœ…

**Given** I have 1+ saved presets
**When** I select a preset from the dropdown
**Then** my current devices are replaced with the preset's devices
**And** all device connections are re-established
**And** virtual previews update to show new devices

**Details:**
- Preset selector shows in WLEDDeviceManager header
- Dropdown lists all saved presets (sorted by last modified, newest first)
- Current preset is highlighted in dropdown
- Loading preset triggers WebSocket reconnection for all new devices
- Previous devices are disconnected cleanly (close WebSocket connections)

**Confirmation Flow:**
- If current devices have unsaved changes â†’ Show confirmation dialog
- Dialog: "You have unsaved changes. Load preset anyway?"
- Options: [Cancel] [Load Preset]
- If no unsaved changes â†’ Load immediately

---

### AC 3: Preset Persistence Across Sessions âœ…

**Given** I have saved presets in a previous browser session
**When** I return to the app and navigate to any experiment with WLEDDeviceManager
**Then** my presets are available in the dropdown
**And** I can load them without re-creating

**Details:**
- Presets stored in localStorage key: `wled-presets-v1`
- Persists across browser sessions (until user clears data)
- Available across all experiments (`/jam`, `/wled-test`, `/dj-visualizer`, `/isometric`)
- Independent of per-experiment auto-save (separate localStorage keys)

---

### AC 4: Unsaved Changes Detection âœ…

**Given** I have a preset loaded
**When** I modify any device setting (IP, name, LED count, etc.)
**Then** the preset selector shows "(modified)" indicator
**And** loading a different preset shows confirmation dialog

**Details:**
- Detect changes by comparing current devices to loaded preset
- Changes that trigger "modified" state:
  - Add/remove device
  - Change device IP, name, LED count
  - Change brightness, orientation, reverseDirection
  - Enable/disable device
- "Save Preset" button shows "Update [Preset Name]" when modified
- Unsaved changes are NOT auto-saved (explicit save required)

---

### AC 5: Empty State and First Preset UX âœ…

**Given** I have never created a preset
**When** I view the preset selector
**Then** I see an empty state with clear call-to-action

**Empty State UI:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Presets: [No presets yet â–¾]          â”‚
â”‚                                        â”‚
â”‚  ğŸ’¡ Tip: Save your device setup to     â”‚
â”‚  quickly load it across experiments    â”‚
â”‚                                        â”‚
â”‚  [+ Create Your First Preset]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**After First Preset:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Presets: [Guitar Setup â–¾]             â”‚
â”‚           â””â”€ Guitar Setup (current)    â”‚
â”‚           â””â”€ [+ Save New Preset]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### AC 6: Preset Metadata Display âœ…

**Given** I have saved presets
**When** I open the preset dropdown
**Then** I see useful metadata for each preset

**Dropdown Item Format:**
```
Guitar Setup
3 devices â€¢ Modified 2 hours ago
```

**Metadata Displayed:**
- Preset name (bold)
- Device count (e.g., "3 devices", "1 device")
- Last modified timestamp (relative: "2 hours ago", "3 days ago", "Jan 9")

---

### AC 7: Validation and Error Handling âœ…

**Scenario 1: Invalid Preset Name**
- Input: Empty string or whitespace-only
- Validation: Show inline error "Preset name is required"
- Behavior: Disable "Save" button until valid

**Scenario 2: Duplicate Preset Name**
- Input: Name that already exists
- Validation: Show inline error "Preset name already exists. Choose a different name."
- Behavior: Disable "Save" button, suggest adding number (e.g., "Guitar Setup 2")

**Scenario 3: localStorage Quota Exceeded**
- Trigger: Attempting to save when storage is full
- Error Message: "Storage limit reached. Please delete unused presets or export them for backup."
- Behavior: Show "Manage Presets" link, offer export option

**Scenario 4: Corrupted Preset Data**
- Trigger: localStorage data is invalid JSON or missing required fields
- Behavior: Log error to console, show toast "Some presets could not be loaded", continue with valid presets
- Recovery: Invalid presets are skipped, not deleted (user can export and fix manually)

---

### AC 8: Performance Requirements âœ…

- **Save Preset:** <50ms to localStorage
- **Load Preset:** <200ms to parse and apply (excluding WebSocket reconnection time)
- **Dropdown Render:** <100ms for up to 50 presets
- **No UI Blocking:** Save/load operations don't freeze UI
- **Memory:** Preset list cached in component state (no repeated localStorage reads)

---

## Technical Specifications

### Data Models

```typescript
/**
 * WLED Preset data structure
 * Compatible with future cloud migration (Story 8.3)
 */
export interface WLEDPreset {
  // Core fields (Story 8.1)
  id: string;                    // UUID v4 (client-generated)
  name: string;                  // User-provided name (1-50 chars)
  description?: string;          // Optional description (0-200 chars)
  devices: WLEDDevice[];         // Array of device configs (existing type)
  createdAt: number;             // Unix timestamp (milliseconds)
  updatedAt: number;             // Unix timestamp (milliseconds)
  version: number;               // Schema version (current: 1)

  // Future fields (Story 8.3 - ignored by Story 8.1)
  userId?: string;               // Supabase user ID (added during migration)
  cloudSynced?: boolean;         // Sync status (added in Story 8.3)
  isDefault?: boolean;           // Auto-load on experiment open (Story 8.2)
}

/**
 * Preset storage metadata
 */
interface PresetStorageMetadata {
  version: number;               // Storage schema version
  lastSync?: number;             // Last cloud sync timestamp (Story 8.3)
  migrated?: boolean;            // True if migrated to cloud (Story 8.3)
}

/**
 * localStorage schema
 */
interface PresetStorage {
  metadata: PresetStorageMetadata;
  presets: WLEDPreset[];
}
```

### localStorage Service

```typescript
// src/services/presetStorage.ts

const PRESETS_KEY = 'wled-presets-v1';
const STORAGE_VERSION = 1;

/**
 * Initialize preset storage (run on app load)
 */
export function initPresetStorage(): void {
  const existing = localStorage.getItem(PRESETS_KEY);
  if (!existing) {
    const initialStorage: PresetStorage = {
      metadata: { version: STORAGE_VERSION },
      presets: []
    };
    localStorage.setItem(PRESETS_KEY, JSON.stringify(initialStorage));
  }
}

/**
 * Load all presets from localStorage
 */
export function loadAllPresets(): WLEDPreset[] {
  try {
    const data = localStorage.getItem(PRESETS_KEY);
    if (!data) return [];

    const storage: PresetStorage = JSON.parse(data);
    return storage.presets || [];
  } catch (error) {
    console.error('Failed to load presets:', error);
    return [];
  }
}

/**
 * Save or update a preset
 */
export function savePreset(preset: Omit<WLEDPreset, 'id' | 'createdAt' | 'updatedAt'>): WLEDPreset {
  const presets = loadAllPresets();
  const now = Date.now();

  // Check for duplicate name
  const duplicate = presets.find(p => p.name === preset.name);
  if (duplicate) {
    throw new Error(`Preset name "${preset.name}" already exists`);
  }

  // Create new preset with metadata
  const newPreset: WLEDPreset = {
    ...preset,
    id: crypto.randomUUID(),
    createdAt: now,
    updatedAt: now,
    version: STORAGE_VERSION
  };

  presets.push(newPreset);
  savePresetsToStorage(presets);

  return newPreset;
}

/**
 * Update existing preset
 */
export function updatePreset(id: string, updates: Partial<WLEDPreset>): WLEDPreset {
  const presets = loadAllPresets();
  const index = presets.findIndex(p => p.id === id);

  if (index === -1) {
    throw new Error(`Preset not found: ${id}`);
  }

  // Check for duplicate name if name is being changed
  if (updates.name && updates.name !== presets[index].name) {
    const duplicate = presets.find(p => p.name === updates.name);
    if (duplicate) {
      throw new Error(`Preset name "${updates.name}" already exists`);
    }
  }

  presets[index] = {
    ...presets[index],
    ...updates,
    updatedAt: Date.now()
  };

  savePresetsToStorage(presets);
  return presets[index];
}

/**
 * Delete a preset
 */
export function deletePreset(id: string): void {
  const presets = loadAllPresets().filter(p => p.id !== id);
  savePresetsToStorage(presets);
}

/**
 * Get single preset by ID
 */
export function getPresetById(id: string): WLEDPreset | null {
  const presets = loadAllPresets();
  return presets.find(p => p.id === id) || null;
}

/**
 * Internal: Save presets array to localStorage
 */
function savePresetsToStorage(presets: WLEDPreset[]): void {
  try {
    const storage: PresetStorage = {
      metadata: { version: STORAGE_VERSION },
      presets: presets.sort((a, b) => b.updatedAt - a.updatedAt) // Sort by newest first
    };
    localStorage.setItem(PRESETS_KEY, JSON.stringify(storage));
  } catch (error) {
    // localStorage quota exceeded
    if (error instanceof DOMException && error.name === 'QuotaExceededError') {
      throw new Error('Storage limit reached. Please delete unused presets.');
    }
    throw error;
  }
}

/**
 * Get storage usage info
 */
export function getStorageInfo(): { used: number; available: number; percentage: number } {
  const presets = loadAllPresets();
  const dataSize = JSON.stringify(presets).length;
  const quotaEstimate = 5 * 1024 * 1024; // 5MB typical localStorage limit

  return {
    used: dataSize,
    available: quotaEstimate - dataSize,
    percentage: (dataSize / quotaEstimate) * 100
  };
}
```

---

## File Locations

### New Files
- `src/services/presetStorage.ts` (~200 lines) - localStorage CRUD
- `src/components/WLED/PresetSelector.tsx` (~150 lines) - Dropdown + buttons
- `src/components/WLED/SavePresetModal.tsx` (~120 lines) - Save modal UI
- `src/components/WLED/ConfirmDialog.tsx` (~60 lines) - Reusable confirmation

### Modified Files
- `src/components/WLED/WLEDDeviceManager.tsx` - Add preset state + handlers
- `src/components/WLED/types.ts` - Add WLEDPreset interface

### Total LOC Estimate
- New code: ~530 lines
- Modified code: ~100 lines
- **Total: ~630 lines**

---

## Migration Path to Story 8.3 (Cloud Storage)

### localStorage â†’ Supabase Migration

```typescript
// Story 8.3: One-time migration on first sign-in
async function migratePresetsToCloud(userId: string) {
  const localPresets = loadAllPresets();

  if (localPresets.length === 0) return;

  console.log(`Migrating ${localPresets.length} presets to cloud...`);

  // Upload to Supabase
  const { data, error } = await supabase
    .from('presets')
    .insert(localPresets.map(p => ({
      id: p.id,
      user_id: userId,
      name: p.name,
      description: p.description,
      devices: p.devices,
      created_at: new Date(p.createdAt).toISOString(),
      updated_at: new Date(p.updatedAt).toISOString(),
      version: p.version
    })));

  if (!error) {
    // Mark as migrated (keep localStorage as offline cache)
    const storage: PresetStorage = JSON.parse(localStorage.getItem(PRESETS_KEY)!);
    storage.metadata.migrated = true;
    storage.metadata.lastSync = Date.now();
    localStorage.setItem(PRESETS_KEY, JSON.stringify(storage));

    console.log('Migration complete!');
  }
}
```

**No Code Rewrite Required:**
- Story 8.1 code becomes the "offline mode" implementation
- Story 8.3 wraps it with cloud sync layer
- Users can continue using localStorage if they don't sign in (free export-only mode)

---

## Success Metrics

- [ ] User can save preset in <5 clicks (from "Add Device" to "Save Preset")
- [ ] Loading preset restores devices in <2 seconds (including WebSocket reconnection)
- [ ] 0 data loss incidents (presets persist correctly across sessions)
- [ ] <1% error rate on save/load operations
- [ ] Preset dropdown renders instantly (<100ms) for up to 50 presets
- [ ] localStorage migration to cloud (Story 8.3) succeeds for 100% of users

---

## Dependencies

**Hard Dependencies:**
- âœ… Story 6.1 Phase 0: WLEDDeviceManager component exists
- âœ… Story 6.1 Phase 0: WLEDDevice type definition exists
- âœ… Story 6.1 Phase 0: Device grid + card components exist

**Soft Dependencies:**
- Story 5.1: Responsive architecture patterns (for mobile UX)
- CLAUDE.md: UX design standards (Tailwind, component patterns)

**Blocked By:**
- None (can start immediately)

**Blocks:**
- Story 8.2: Preset management UI (rename, duplicate, delete)
- Story 8.3: Supabase migration + auth
- Story 8.4: Stripe payment + feature gating

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-09 | 1.0 | Initial story creation for local preset save/load | PM Agent (John) |

---

## Next Steps

1. **Review & Approve:** Confirm scope and UX design
2. **Implementation:** Build components per technical specs
3. **Testing:** Manual testing with real WLED hardware
4. **Iteration:** Refine UX based on tester feedback
5. **Handoff to Story 8.2:** Preset management UI (rename, duplicate, delete)

**Estimated Implementation Time:** 1-2 days for experienced React/TypeScript developer
