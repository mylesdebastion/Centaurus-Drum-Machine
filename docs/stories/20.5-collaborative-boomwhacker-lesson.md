# Story 20.5: Collaborative Boomwhacker Performance Lesson (Education Mode Lesson 4)

**Epic:** Epic 20 - Workshop-Ready Education Mode
**Priority:** üü° MEDIUM (Workshop Enhancement - Optional)
**Status:** üìù PLANNING
**Estimated Effort:** 4-6 hours

---

## User Story

**As a** music educator teaching K5-10 deaf and hearing students in a workshop setting,
**I want** a guided lesson that teaches students to play "Twinkle Twinkle Little Star" collaboratively using boomwhackers and WLED tube visualization,
**So that** students understand how the /isometric sequencer coordinates musical performance and can participate in a synchronized group activity.

---

## Story Context

### Existing System Integration

- **Integrates with:** EducationMode component (`src/components/Education/EducationMode.tsx`)
- **Technology:** React, Tone.js, SingleLaneVisualizer (LED strip control), workshop config system
- **Follows pattern:** Existing Lessons 1-3 structure (step-based progression, instruction + hint + validation)
- **Touch points:**
  - EducationMode lesson array (add Lesson 4 at lines 247-312)
  - IsometricSequencer's 'twinkle' melody mode (already implemented at line 188)
  - Workshop config JSON (student-to-WLED-tube assignments from Story 20.1)
  - Boomwhacker color mapping (defined in IsometricSequencer lines 202-216)

### Relationship to Other Epics

**NOTE:** Epic 19 originally planned a "Melody & Harmony" lesson as Lesson 4 (piano keyboard + DJ visualizer). This workshop-focused lesson takes priority due to the **critical workshop timeline (Wednesday)**. Epic 19's Lesson 4 can be renumbered as Lesson 5 when implemented post-workshop.

### Boomwhacker Color Mapping (Reference)

```javascript
C  = Red        (#ff4444)
C# = Orange-Red (#ff8844)
D  = Orange     (#ffaa44)
D# = Yellow-Orange (#ffcc44)
E  = Yellow     (#ffff44)
F  = Yellow-Green (#aaff44)
F# = Green-Yellow (#66ff44)
G  = Green      (#44ff44)
G# = Blue-Green (#44ffaa)
A  = Blue       (#44aaff)
A# = Blue-Purple (#4466ff)
B  = Purple     (#6644ff)
```

---

## Acceptance Criteria

### Functional Requirements

#### FR1: Lesson Structure and Discovery

1. Lesson 4 appears in Education Mode lesson selection grid
2. Lesson metadata:
   - **ID:** '4'
   - **Title:** "Play Together"
   - **Description:** "Learn to play Twinkle Twinkle Little Star with boomwhackers and LED lights"
   - **Difficulty:** 'intermediate'
   - **Steps:** 4-5 progressive steps

#### FR2: Step-by-Step Progression

**Step 1: Introduction to Colored Notes**
- **Instruction:** "Each student has a boomwhacker and an LED tube of the same color. Find your color: C=Red, D=Orange, E=Yellow, F=Green, G=Blue, A=Purple, B=Violet"
- **Hint:** "Hold your boomwhacker and watch your LED tube. When your tube lights up, hit your boomwhacker!"
- **Interaction:** Display color-to-note reference chart with boomwhacker colors (C-B)
- **Completion:** "Next Step" button (no validation required)

**Step 2: Practice Your Note**
- **Instruction:** "Let's practice! Watch the sequencer - when you see your color light up, hit your boomwhacker in rhythm"
- **Hint:** "Listen to the tempo (beat). Your LED tube will show you exactly when to play!"
- **Interaction:** Simple repeating pattern: C-D-E-F-G (each note plays twice, 10 steps total)
- **Playback:** Auto-loop at 90 BPM (slow tempo for beginners)
- **Completion:** After 2 full loops (20 seconds), "Next Step" button appears

**Step 3: Learn the Melody Pattern**
- **Instruction:** "Now let's learn Twinkle Twinkle! Watch how the notes move: C-C-G-G-A-A-G, F-F-E-E-D-D-C"
- **Hint:** "Notice the pattern: some notes repeat twice in a row. Watch your LED tube carefully!"
- **Interaction:** Display "Twinkle Twinkle Little Star" pattern in visual grid with note names and colors
- **Pattern:**
  ```
  Step:  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16
  Note:  C  C  G  G  A  A  G  -  F  F  E  E  D  D  C  -
  Color: R  R  G  G  B  B  G  -  G  G  Y  Y  O  O  R  -
  ```
- **Completion:** "Load Pattern" button

**Step 4: Play Together**
- **Instruction:** "Let's play Twinkle Twinkle together! Watch your LED tube and hit your boomwhacker when it lights up. Ready? 3-2-1-GO!"
- **Hint:** "Stay with the beat! If you miss a note, just wait for the next loop and try again."
- **Interaction:**
  - Auto-load "Twinkle Twinkle" melody pattern
  - Enable multi-lane WLED visualization (if workshop config exists)
  - Start playback automatically with 4-beat count-in ("4-3-2-1")
  - Display playhead indicator showing current step (yellow ring/highlight)
  - Loop continuously until stopped
- **Completion:** "Complete Lesson" button (always available after playback starts)

**Optional Step 5: Free Play (Stretch Goal)**
- **Instruction:** "Great job! Now try creating your own simple melody. Click on the grid to add notes."
- **Hint:** "Keep it simple - try making a pattern that repeats! Use only the colors your class has."
- **Interaction:** Simplified pattern editor (single-lane sequencer per student color)
- **Completion:** "Return to Lessons" button

#### FR3: WLED Multi-Lane Visualization

1. **Workshop Mode (with config):**
   - Check for `education/workshop-config.json` existence
   - Load student-to-WLED-tube assignments (6-12 students)
   - Create SingleLaneVisualizer instance for each assigned tube
   - Display multi-lane visualization (one LED strip per student/note)
   - Each student's tube only lights up for their assigned note

2. **Demo Mode (without config):**
   - Show single-lane visualization (instructor demonstration)
   - Visualize all notes on single WLED strip (multi-notes mode)
   - Display note reference chart prominently

#### FR4: Integration with Twinkle Pattern

1. **Pattern Definition:** Hardcode or reference "Twinkle Twinkle Little Star"
   ```javascript
   const twinklePattern = [
     [true, false, false, false, false, false, false, false, false, false, false, false], // C
     [true, false, false, false, false, false, false, false, false, false, false, false], // C
     [false, false, false, false, false, false, false, true, false, false, false, false], // G
     [false, false, false, false, false, false, false, true, false, false, false, false], // G
     [false, false, false, false, false, false, false, false, false, true, false, false], // A
     [false, false, false, false, false, false, false, true, false, true, false, false], // A
     [false, false, false, false, false, false, false, true, false, false, false, false], // G
     [false, false, false, false, false, false, false, false, false, false, false, false], // (rest)
     // ... continued for full melody
   ];
   ```

2. **Tempo:** 90 BPM (slower than default 120 BPM for beginner-friendly playback)

3. **Sound Engine:** Use existing Tone.js integration (reuse keys or pluck sound engine)

4. **Playback:** Use existing Tone.Transport loop logic from Lessons 1-3

### Integration Requirements

**IR1:** Existing EducationMode lessons (1-3) continue to work unchanged
**IR2:** New lesson follows existing lesson data structure (same TypeScript interface)
**IR3:** Integration with workshop config (Story 20.1) is **optional** with graceful degradation
**IR4:** WLED visualization reuses existing SingleLaneVisualizer utility (lines 38-232)
**IR5:** Audio playback uses existing Tone.js integration (lines 410-452)

### Quality Requirements

**QR1:** Lesson UI is responsive and accessible (touch targets ‚â•44px, mobile-first)
**QR2:** Instructions use age-appropriate language for K5-10 students (simple, clear, encouraging)
**QR3:** Visual color reference is accessible for deaf students (no audio-only cues, clear visual indicators)
**QR4:** Pattern playback is smooth with <50ms LED visualization latency
**QR5:** No regression in existing EducationMode functionality verified via manual testing

---

## Technical Notes

### File Modifications

**Primary File:** `src/components/Education/EducationMode.tsx`

**Changes Required:**

1. **Add Lesson 4 to `lessons` array** (after line 312):
   ```typescript
   {
     id: '4',
     title: 'Play Together',
     description: 'Learn to play Twinkle Twinkle Little Star with boomwhackers and LED lights',
     difficulty: 'intermediate',
     steps: [
       {
         id: '4-1',
         instruction: 'Each student has a boomwhacker and an LED tube of the same color...',
         hint: 'Hold your boomwhacker and watch your LED tube...',
         completed: false
       },
       // ... Steps 2-4 (or 2-5)
     ]
   }
   ```

2. **Add color reference chart component** (inline JSX):
   ```tsx
   {selectedLesson?.id === '4' && currentStepIndex === 0 && (
     <div className="grid grid-cols-3 sm:grid-cols-6 gap-2">
       {boomwhackerColors.map((color, i) => (
         <div key={i} className="text-center">
           <div style={{backgroundColor: color}} className="h-12 w-12 rounded-lg" />
           <span className="text-white text-sm">{noteNames[i]}</span>
         </div>
       ))}
     </div>
   )}
   ```

3. **Add Twinkle pattern state** (after line 119):
   ```typescript
   const [twinklePattern] = useState<boolean[][]>([
     // 12 lanes (C-B) √ó 16 steps
     // Pattern encoded for "Twinkle Twinkle Little Star"
   ]);
   ```

4. **Add multi-lane WLED support** (reuse Lesson 3 logic, lines 154-232):
   - Check for workshop config
   - Create visualizers for assigned lanes
   - Update LED strips on playback

### Existing Pattern References

**LED Visualization (Lesson 3 - Multi-Lane):**
- Lines 154-232: LED strip initialization for multi-track patterns
- Reuse this pattern for multi-student WLED tubes

**Playback Loop (Lesson 1/3):**
- Lines 410-452: Tone.js Transport scheduling for 16-step patterns
- Extend to support melodic notes (not just drums)

**Step Progression (All Lessons):**
- Lines 340-388: `nextStep()` function with state management
- Reuse for 4-5 step progression

### Key Constraints

**Dependency on Story 20.1:**
- Workshop config should be available for multi-student mode
- **Graceful degradation required:** If no config, fall back to demo mode

**Performance:**
- WLED update rate: 30Hz (existing from Lessons 1/3)
- Support 6-12 simultaneous LED strips without dropped frames

**Audio Engine:**
- Use Tone.js PolySynth or similar for melodic playback
- Avoid drum sounds - use pitched instruments (keys, pluck, or sine)

---

## Definition of Done

### Functional Checklist

- [ ] Lesson 4 appears in Education Mode lesson selection
- [ ] All 4-5 steps are functional with clear instructions and hints
- [ ] Color-to-note reference chart displays correctly on Step 1
- [ ] Practice pattern (C-D-E-F-G) plays correctly on Step 2
- [ ] "Twinkle Twinkle Little Star" pattern loads on Step 3
- [ ] Full melody plays with WLED visualization on Step 4
- [ ] Multi-lane WLED visualization works (if workshop config exists)
- [ ] Graceful degradation to demo mode (no workshop config)
- [ ] Playback includes 4-beat count-in ("4-3-2-1")
- [ ] Playhead indicator shows current step visually
- [ ] Tempo is appropriately slow (90 BPM) for beginners

### Code Quality Checklist

- [ ] Existing Lessons 1-3 continue to work without regression
- [ ] Code follows existing EducationMode patterns and TypeScript conventions
- [ ] No TypeScript errors or warnings introduced
- [ ] No console errors during lesson playback
- [ ] Component is responsive (mobile, tablet, desktop tested)

### Manual Testing Checklist

- [ ] **Solo mode** (no workshop config): Lesson works with demo visualization
- [ ] **Workshop mode** (with mock config): Multi-lane WLED visualization works
- [ ] **Mobile responsive:** All steps work on mobile viewport (375px width)
- [ ] **Touch targets:** All buttons ‚â•44px for accessibility
- [ ] **LED strip sync:** If hardware available, test with real WLED device(s)
- [ ] **Audio playback:** Twinkle melody plays correctly without glitches
- [ ] **Pattern loop:** Melody loops seamlessly without gaps or jumps

---

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** Workshop config integration may not be complete (Story 20.1 dependency)

**Mitigation:**
- Implement graceful degradation to demo mode
- Add feature detection: check for `education/workshop-config.json` existence
- Provide fallback UI with note reference chart only
- Single-lane visualization mode for instructor demonstration

**Secondary Risk:** Twinkle pattern may not match /isometric implementation

**Mitigation:**
- Hardcode pattern directly in EducationMode (don't depend on /isometric)
- Reference pattern is simple and well-known (public domain melody)
- Test playback thoroughly before workshop

**Rollback Plan:**
- Remove Lesson 4 from `lessons` array (single-line change)
- Revert EducationMode.tsx to previous commit
- No database or config file changes required
- **Rollback time:** <2 minutes

### Compatibility Verification

- [x] No breaking changes to existing APIs (extends lesson array only)
- [x] Database changes: None (uses localStorage and optional workshop config JSON)
- [x] UI changes follow existing design patterns (Lessons 1-3 structure, Tailwind classes)
- [x] Performance impact negligible (single lesson addition, reuses existing LED code)
- [x] No external dependencies added (uses Tone.js, React hooks already in use)

---

## Validation Checklist

### Scope Validation

- [x] Story can be completed in one development session (4-6 hours estimated)
- [x] Integration approach is straightforward (follows existing Lesson 1-3 patterns exactly)
- [x] Follows existing patterns exactly (step-based lesson structure, state management)
- [x] No design or architecture work required (extends existing EducationMode component)

### Clarity Check

- [x] Story requirements are unambiguous (4-5 specific steps defined with exact instructions)
- [x] Integration points clearly specified (EducationMode lines, workshop config, LED visualizers)
- [x] Success criteria are testable (manual verification checklist provided)
- [x] Rollback approach is simple and fast (remove lesson, revert file, <2 minutes)

---

## Estimated Effort

**Development Time:** 4-6 hours (single focused session)

**Breakdown:**
- Lesson 4 data structure and step definitions (1h)
- Color reference chart UI component (0.5h)
- Twinkle pattern hardcoding and validation (0.5h)
- Audio playback integration (Tone.js melodic synth) (1h)
- WLED multi-lane visualization integration (1.5h)
- Workshop config graceful degradation (0.5h)
- Testing and polish (mobile, LED sync, audio) (1h)

---

## Success Criteria

The story is successful when:

1. ‚úÖ Lesson 4 is fully functional and accessible from Education Mode
2. ‚úÖ Students (or testers) can follow 4-5 progressive steps to learn collaborative performance
3. ‚úÖ "Twinkle Twinkle Little Star" plays correctly with synchronized WLED visualization
4. ‚úÖ Workshop mode (multi-student WLED tubes) and demo mode (single-lane) both work
5. ‚úÖ Instructions are clear, age-appropriate, and accessible for deaf students (visual cues)
6. ‚úÖ No regression in existing EducationMode lessons (1-3)
7. ‚úÖ Code is production-ready, follows existing patterns, and passes manual testing

---

## Notes for Development

### Color Reference for Twinkle Pattern

**"Twinkle Twinkle Little Star" Note Sequence:**
```
Lyrics: Twin - kle  twin - kle  lit - tle  star
Notes:  C     C     G     G     A     A     G
Colors: Red   Red   Green Green Blue  Blue  Green

Lyrics: How   I     won - der  what  you   are
Notes:  F     F     E     E     D     D     C
Colors: Y-Grn Y-Grn Yello Yello Orng  Orng  Red
```

### Workshop Integration Notes

- If `education/workshop-config.json` exists, read `wledDevices` array
- Map each device to a specific note/color (e.g., Device 1 = C/Red)
- Create SingleLaneVisualizer for each assigned device
- Update only the student's assigned LED strip when their note plays

### Audio Engine Notes

- Use Tone.PolySynth with "keys" or "pluck" sound engine
- Map note names (C, D, E, etc.) to frequencies (261.63 Hz for C4, etc.)
- Keep velocity consistent (0.7-0.8) for classroom volume
- Use existing `noteFrequencies` array from IsometricSequencer if available

---

**Story Owner:** Sarah (PO)
**Developer:** Dev Agent
**Epic:** Epic 20 - Workshop-Ready Education Mode
**Target Date:** Optional post-workshop enhancement (not blocking for Wednesday)
**Related Stories:** 20.1 (Workshop Config), Epic 19 Stories (Education Mode enhancements)
