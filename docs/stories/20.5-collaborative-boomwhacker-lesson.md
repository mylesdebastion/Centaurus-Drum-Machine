# Story 20.5: Progressive Isometric Lane Reveal for Twinkle Twinkle (Education Mode Lesson 4)

**Epic:** Epic 20 - Workshop-Ready Education Mode
**Priority:** üî¥ HIGH (Workshop Critical - Wednesday Deadline)
**Status:** üìù PLANNING
**Estimated Effort:** 6-8 hours

---

## User Story

**As a** music educator teaching K5-10 deaf and hearing students in a workshop setting,
**I want** a progressive 4-step lesson using the **embedded isometric sequencer** that reveals one note lane at a time while teaching "Twinkle Twinkle Little Star",
**So that** students learn note order first, then timing, then tempo without being overwhelmed by seeing all 12 lanes at once.

---

## Story Context

### Critical Change from Original 20.5

**REVISED APPROACH:** This story now focuses on **embedding the existing `/isometric` sequencer** within Education Mode with **progressive lane reveal**. We are **NOT creating new visualizations** - we're adapting the existing IsometricSequencer component to support education mode.

### Key Differences

| Original 20.5 | Revised 20.5 (This Story) |
|--------------|---------------------------|
| Create new lesson UI from scratch | Embed existing IsometricSequencer |
| Full 12-lane view from start | Progressive reveal: 1 lane ‚Üí 2 lanes ‚Üí 6 lanes ‚Üí all lanes |
| Workshop config integration | Education mode integration only |
| New pattern editor | Reuse isometric 3D visualization |

### Integration Points

- **Primary Component:** `src/components/IsometricSequencer/IsometricSequencer.tsx`
  - Add optional `educationConfig` prop to enable progressive lane reveal
  - Filter visible lanes based on config
  - Preserve standalone `/isometric` route functionality

- **Secondary Component:** `src/components/Education/EducationMode.tsx`
  - Add Lesson 4 with embedded isometric sequencer
  - Define 4-step progression with lane reveal configs
  - Pass education configuration to IsometricSequencer

- **WLED Integration:** `src/utils/SingleLaneVisualizer.ts` (or new `WLEDCountIn` utility)
  - Implement 4-beat count-in with gentle flash
  - Synchronize with Tone.js Transport

### Boomwhacker Color Mapping (Reference)

```javascript
C  = Red        (#ff4444)
D  = Orange     (#ffaa44)
E  = Yellow     (#ffff44)
F  = Yellow-Green (#aaff44)
G  = Green      (#44ff44)
A  = Blue       (#44aaff)
```

---

## Acceptance Criteria

### AC1: Progressive 4-Step Lesson Structure

**Step 1: Single Note Introduction (C Lane Only)**
- [ ] Only the C lane (red) is visible in embedded isometric sequencer
- [ ] Single C note displayed at first beat of Twinkle Twinkle
- [ ] Student instruction: "This is the C note - your first note!"
- [ ] WLED count-in: 4 beats, gentle slow flash before playback
- [ ] Success criteria: Student hits C at correct time
- [ ] "Next Step" button appears after playback completes

**Step 2: Two-Note Sequence (C & G Lanes)**
- [ ] C and G lanes visible only
- [ ] Pattern shows: C-C-G-G (first 4 beats, single hits, 1 beat apart)
- [ ] Instruction: "C, then C, then G, then G - watch the order!"
- [ ] WLED count-in continues (4 beats)
- [ ] No double-hit complexity yet
- [ ] Success: Pattern plays correctly with both lanes visible

**Step 3: Four-Note Sequence (C, D, E, F, G, A Lanes for First Phrase)**
- [ ] Reveal 6 lanes: C, D, E, F, G, A
- [ ] Pattern: C-C-G-G-A-A-G (7 notes, single hits each)
- [ ] Each student responsible for one boomwhacker/note
- [ ] Instruction: "Listen for YOUR note in the sequence"
- [ ] Step sequencer timeline visible with beat markers
- [ ] WLED count-in (4 beats) establishes tempo
- [ ] Focus: Order and individual responsibility

**Step 4: Complete Twinkle Twinkle (All Required Lanes)**
- [ ] All lanes needed for complete song revealed
- [ ] Full pattern with double hits: C-C-G-G-A-A-G-F-F-E-E-D-D-C
- [ ] Complete 16-beat timeline visible
- [ ] Count-in instruction: "Listen to the 4 gentle flashes, then play together"
- [ ] Visual beat counter: "1, 2, 3, 4, START!"
- [ ] Focus: Tempo and staying together as group
- [ ] "Complete Lesson" button after successful performance

### AC2: Technical Implementation Requirements

**Embedded Isometric Mode**
- [ ] IsometricSequencer accepts optional `educationConfig` prop
- [ ] When `educationConfig` is present, enable progressive reveal mode
- [ ] When `educationConfig` is undefined/null, render full 12-lane sequencer (existing behavior)
- [ ] **CRITICAL**: Standalone `/isometric` route remains completely untouched and functional

**Lane Visibility Control**
- [ ] `visibleLanes` array in config controls which lanes render
- [ ] Camera auto-adjusts to center only visible lanes (no empty space)
- [ ] Smooth lane reveal animations (fade-in or slide-in)
- [ ] Hidden lanes are not clickable or interactive

**WLED Count-In Integration**
- [ ] 4-beat count-in before playback starts
- [ ] Gentle flash pattern: 0% ‚Üí 40% ‚Üí 0% brightness per beat
- [ ] White color (#FFFFFF) for maximum visibility
- [ ] Synchronized with Tone.js Transport
- [ ] All connected WLED strips flash in unison

**Pattern Data**
- [ ] Twinkle Twinkle pattern embedded in Lesson 4 config
- [ ] Tempo: 100 BPM (slower for learning)
- [ ] Auto-load pattern when step begins
- [ ] Pattern data structure:
  ```typescript
  pattern: {
    C: [true, false, false, false, true, false, ...],
    G: [false, false, false, false, false, false, true, ...],
    // ... etc
  }
  ```

### AC3: UI/UX Requirements

**Responsive Design**
- [ ] Works on mobile, tablet, desktop
- [ ] Touch targets ‚â•44px for accessibility
- [ ] Mobile-first approach matches existing Education Mode

**Visual Indicators**
- [ ] Beat counter overlay during count-in ("1", "2", "3", "4", "START!")
- [ ] Timeline markers showing beat divisions (Steps 3 & 4)
- [ ] Color-coded lane labels with note names (C, D, E, F, G, A)
- [ ] Playhead indicator showing current step

**Instructions**
- [ ] Age-appropriate language for K5-10 students
- [ ] Clear, simple, encouraging
- [ ] Visual cues for deaf students (no audio-only indicators)

### AC4: Integration Requirements

**No Breaking Changes**
- [ ] Existing EducationMode Lessons 1-3 work unchanged
- [ ] Standalone `/isometric` route works perfectly
- [ ] No regression in existing functionality

**React Context/Props Pattern**
- [ ] Use React props or context to pass lesson config from EducationMode to IsometricSequencer
- [ ] Clean separation: education logic in EducationMode, rendering logic in IsometricSequencer

**Performance**
- [ ] Maintain 60fps with education mode enabled
- [ ] <50ms LED visualization latency
- [ ] No memory leaks when switching steps

---

## Technical Implementation

### IsometricSequencer Changes

**Add Education Config Interface**

```typescript
interface EducationConfig {
  visibleLanes: string[];              // ['C', 'G', 'A']
  pattern: Record<string, boolean[]>;  // Note -> 16-step pattern
  tempo: number;                       // BPM
  enableCountIn: boolean;              // Show count-in
  showTimeline?: boolean;              // Show beat markers
  showBeatCounter?: boolean;           // Show "1, 2, 3, 4" counter
}

interface IsometricSequencerProps {
  onBack: () => void;
  educationConfig?: EducationConfig;  // Optional - undefined = standalone mode
}
```

**Lane Filtering Logic**

```typescript
// In render loop - only render lanes in visibleLanes array
const renderLanes = () => {
  const lanesToRender = educationConfig
    ? lanes.filter(lane => educationConfig.visibleLanes.includes(lane.note))
    : lanes; // All lanes in standalone mode

  lanesToRender.forEach(lane => {
    // ... existing render logic
  });
};
```

**Camera Positioning**

```typescript
// Adjust camera to center visible lanes
const updateCameraForVisibleLanes = () => {
  if (!educationConfig) return; // Standalone mode - no adjustment

  const visibleCount = educationConfig.visibleLanes.length;
  const centerOffset = (12 - visibleCount) / 2; // Center based on hidden lanes

  camera.position.x = centerOffset * laneSpacing;
};
```

### EducationMode Changes

**Add Lesson 4 Data Structure**

```typescript
{
  id: '4',
  title: '3D Boomwhacker Band',
  description: 'Play "Twinkle Twinkle" together with 3D note visualization',
  difficulty: 'intermediate',
  steps: [
    {
      id: '4-1',
      instruction: 'This is the C note - watch for it coming toward you! Hit your boomwhacker when it reaches the strike zone.',
      hint: 'üí° The red note is C. Get ready!',
      completed: false,
      educationConfig: {
        visibleLanes: ['C'],
        pattern: {
          C: [true, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false]
        },
        tempo: 100,
        enableCountIn: true
      }
    },
    {
      id: '4-2',
      instruction: 'Now we have C and G. Watch the order: C, then C again, then G, then G again.',
      hint: 'üí° C is red, G is green. Follow the pattern: Red, Red, Green, Green',
      completed: false,
      educationConfig: {
        visibleLanes: ['C', 'G'],
        pattern: {
          C: [true, false, false, false, true, false, false, false, false, false, false, false, false, false, false, false],
          G: [false, false, false, false, false, false, false, false, true, false, false, false, true, false, false, false]
        },
        tempo: 100,
        enableCountIn: true
      }
    },
    {
      id: '4-3',
      instruction: 'First phrase of Twinkle Twinkle! Each person has one note. Listen for YOUR color and hit it once.',
      hint: 'üí° The sequence is: C-C-G-G-A-A-G. Watch the timeline to see when each note comes!',
      completed: false,
      educationConfig: {
        visibleLanes: ['C', 'D', 'E', 'F', 'G', 'A'],
        pattern: {
          C: [true, false, false, false, true, false, false, false, false, false, false, false, false, false, false, false],
          G: [false, false, false, false, false, false, false, false, true, false, false, false, true, false, false, false],
          A: [false, false, false, false, false, false, false, false, false, false, false, false, false, false, true, false]
        },
        tempo: 100,
        enableCountIn: true,
        showTimeline: true
      }
    },
    {
      id: '4-4',
      instruction: 'Complete Twinkle Twinkle! Listen to the count-in (4 gentle flashes), then play together. Stay on tempo!',
      hint: 'üí° Count: 1, 2, 3, 4, START! Keep the steady beat - don\'t rush!',
      completed: false,
      educationConfig: {
        visibleLanes: ['C', 'D', 'E', 'F', 'G', 'A'],
        pattern: {
          C: [true, false, false, false, true, false, false, false, false, false, false, false, false, false, false, true],
          D: [false, false, false, false, false, false, false, false, false, false, false, false, true, false, false, false],
          E: [false, false, false, false, false, false, false, false, false, false, true, false, false, false, false, false],
          F: [false, false, false, false, false, false, false, false, true, false, false, false, false, false, false, false],
          G: [false, false, true, false, false, false, false, true, false, false, false, false, false, false, false, false],
          A: [false, false, false, false, false, true, false, false, false, false, false, false, false, false, false, false]
        },
        tempo: 100,
        enableCountIn: true,
        showTimeline: true,
        showBeatCounter: true
      }
    }
  ]
}
```

**Render Embedded Isometric**

```tsx
{selectedLesson?.id === '4' && currentStep.educationConfig && (
  <div className="mb-6">
    <IsometricSequencer
      onBack={() => {}} // Disabled in education mode
      educationConfig={currentStep.educationConfig}
    />
  </div>
)}
```

### WLED Count-In Implementation

```typescript
// In SingleLaneVisualizer or new WLEDCountIn utility
const startCountIn = async (tempo: number, onComplete: () => void) => {
  const beatDuration = (60 / tempo) * 1000; // ms per beat

  for (let beat = 0; beat < 4; beat++) {
    // Flash on (gentle ramp to 40% brightness)
    await sendWLEDCommand({ brightness: 100, color: [255, 255, 255] }); // 40% of 255
    await delay(beatDuration * 0.4);

    // Flash off
    await sendWLEDCommand({ brightness: 0 });
    await delay(beatDuration * 0.6);
  }

  onComplete(); // Start playback
};
```

---

## File Modifications

### Files to Modify

**1. `src/components/IsometricSequencer/IsometricSequencer.tsx`**
- Add optional `educationConfig` prop to interface
- Implement lane filtering based on `visibleLanes`
- Add camera positioning adjustment
- Integrate WLED count-in trigger
- Add education mode UI overlays (beat counter, timeline)

**2. `src/components/Education/EducationMode.tsx`**
- Add Lesson 4 data structure
- Add embedded isometric rendering for Lesson 4
- Update lesson selection logic

**3. `src/utils/SingleLaneVisualizer.ts` (or new `src/utils/WLEDCountIn.ts`)**
- Add count-in flash sequence method
- Integrate with Tone.js Transport timing

**4. `src/types/index.ts`**
- Extend `EducationLesson` interface to support `educationConfig` in steps

### Files NOT to Modify

- **Do NOT touch** standalone `/isometric` route logic
- **Do NOT modify** IsometricSequencer render logic except for lane filtering
- **Do NOT change** existing EducationMode Lessons 1-3

---

## Definition of Done

### Functional Checklist

- [ ] Lesson 4 appears in Education Mode lesson selection
- [ ] Step 1: Only C lane visible, single note playback
- [ ] Step 2: C & G lanes visible, C-C-G-G pattern
- [ ] Step 3: 6 lanes visible (C-A), first phrase pattern
- [ ] Step 4: Complete Twinkle with double hits
- [ ] WLED count-in flashes 4 times before each step's playback
- [ ] Beat counter displays "1, 2, 3, 4, START!" during count-in
- [ ] Timeline markers visible in Steps 3 & 4
- [ ] Camera centers on visible lanes (no empty space)
- [ ] Lane reveal animations are smooth
- [ ] "Next Step" progression works correctly
- [ ] Standalone `/isometric` route still works perfectly

### Code Quality Checklist

- [ ] No TypeScript errors or warnings
- [ ] Existing Lessons 1-3 work without regression
- [ ] Code follows existing patterns
- [ ] No console errors during playback
- [ ] Responsive design (mobile, tablet, desktop tested)
- [ ] Performance: 60fps maintained

### Testing Checklist

- [ ] **Embedded mode:** Lesson 4 works in Education Mode
- [ ] **Standalone mode:** `/isometric` route unchanged
- [ ] **Lane reveal:** Each step shows only configured lanes
- [ ] **WLED count-in:** 4-beat flash before playback (if hardware available)
- [ ] **Pattern playback:** Twinkle pattern plays correctly
- [ ] **Camera:** Auto-centers on visible lanes
- [ ] **Mobile:** Works on 375px width viewport
- [ ] **Touch targets:** All buttons ‚â•44px
- [ ] **Tempo:** 100 BPM feels appropriate for learning

---

## Risk Assessment

### Primary Risks

**Risk 1: Breaking Standalone /isometric Route**

**Mitigation:**
- Use strict null checking: `if (educationConfig) { ... }`
- Default all education features to disabled when config is undefined
- Comprehensive testing of standalone route before and after changes
- Quick rollback: remove `educationConfig` prop, revert IsometricSequencer changes

**Risk 2: WLED Count-In Timing Synchronization**

**Mitigation:**
- Use existing Tone.js Transport for precise timing
- Test with physical WLED hardware before workshop
- Provide visual count-in as backup (works without WLED)
- Fallback: disable WLED count-in, use visual counter only

**Risk 3: Camera Positioning with Variable Lane Counts**

**Mitigation:**
- Calculate center offset based on hidden lanes
- Test with 1, 2, 6, and 12 lane configurations
- Ensure FOV is wide enough to see all visible lanes
- Add debug mode to visualize camera bounds

### Rollback Plan

**If story fails:**
1. Remove Lesson 4 from `lessons` array (1 line change in EducationMode.tsx)
2. Revert IsometricSequencer.tsx changes (git revert)
3. Revert types.ts changes (git revert)
4. **Rollback time:** <5 minutes
5. **Impact:** Zero - Lessons 1-3 and standalone isometric unaffected

---

## Testing Strategy

### Unit Tests (Optional - Manual Testing Sufficient)

- Test `visibleLanes` filtering logic
- Test `educationConfig` prop handling (defined vs undefined)
- Test camera positioning calculations

### Integration Tests (Manual)

1. **Lesson Progression Test**
   - Start Lesson 4 ‚Üí Step 1
   - Verify only C lane visible
   - Click "Next Step" ‚Üí Step 2
   - Verify C & G lanes visible
   - Complete all 4 steps

2. **Standalone Route Test**
   - Navigate to `/isometric`
   - Verify all 12 lanes visible
   - Verify no education mode UI elements
   - Verify camera positioning unchanged

3. **WLED Count-In Test**
   - Connect physical WLED strip
   - Start Lesson 4, Step 1
   - Verify 4-beat flash before playback
   - Verify tempo matches 100 BPM

4. **Responsive Design Test**
   - Test on mobile (375px width)
   - Test on tablet (768px width)
   - Test on desktop (1920px width)
   - Verify touch targets ‚â•44px

---

## Success Criteria

The story is successful when:

1. ‚úÖ Lesson 4 is fully functional with 4-step progressive lane reveal
2. ‚úÖ Students can follow clear instructions to learn Twinkle Twinkle collaboratively
3. ‚úÖ Embedded isometric sequencer displays only configured lanes per step
4. ‚úÖ WLED count-in synchronizes with playback start (4 beats)
5. ‚úÖ Standalone `/isometric` route works without any changes
6. ‚úÖ No regression in existing EducationMode Lessons 1-3
7. ‚úÖ Code is production-ready and passes manual testing
8. ‚úÖ Workshop-ready for Wednesday deadline

---

## Estimated Effort

**Development Time:** 6-8 hours

**Breakdown:**
- IsometricSequencer `educationConfig` prop integration (2h)
- Lane filtering and camera positioning logic (1.5h)
- EducationMode Lesson 4 data structure (1h)
- WLED count-in implementation (1h)
- UI overlays (beat counter, timeline markers) (1h)
- Testing and refinement (1.5h)
- Documentation and final polish (0.5h)

---

## Notes for Development

### Twinkle Twinkle Note Sequence

```
Lyrics: Twin - kle  twin - kle  lit - tle  star    How   I     won - der  what  you   are
Notes:  C     C     G     G     A     A     G       F     F     E     E     D     D     C
Steps:  1     2     3     4     5     6     7   (8) 9     10    11    12    13    14    15  (16)
Colors: Red   Red   Green Green Blue  Blue  Green  Y-Grn Y-Grn Yello Yello Orng  Orng  Red
```

### Key Implementation Principles

1. **Standalone Protection:** Always check `if (educationConfig)` before applying education logic
2. **Graceful Degradation:** All education features default to disabled
3. **Performance:** Lane filtering should not impact frame rate
4. **Accessibility:** Visual indicators must work without audio cues
5. **Simplicity:** Reuse existing isometric code, don't reinvent

---

**Story Owner:** Product Owner
**Developer:** Dev Agent
**Epic:** Epic 20 - Workshop-Ready Education Mode
**Target Date:** Before Wednesday workshop
**Priority:** HIGH - Workshop Critical
**Dependencies:** IsometricSequencer must support education mode prop extension
