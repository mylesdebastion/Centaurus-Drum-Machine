# Story 19.2: Education Mode Visualizer Integration

**Epic:** Education Mode DJ Visualizer Integration (Epic 19)
**Status:** Ready for Review
**Priority:** High (Core Integration Story)
**Complexity:** High
**Prerequisites:** Story 19.1 (LiveAudioVisualizer Embedded Mode) complete

---

## Story

**As a** student in Education Mode lesson 2 (Color and Pitch),
**I want** to see real-time spectrum/waveform/ripple visualizations when I play drum sounds,
**so that** I can understand the relationship between sound frequencies and visual feedback across different visualization modes.

---

## Background / Context

### Current State
- ✅ **Education Mode exists** - Three lessons at `src/components/Education/EducationMode.tsx`
- ✅ **Lesson 2 (Color and Pitch)** - Teaches sound-to-color relationship using CompactVisualizer
- ✅ **Drum playback working** - `audioEngine.playDrum()` triggers sounds
- ✅ **CompactVisualizer integration** - Limited visualization with color mode switching
- ❌ **No spectrum/waveform/ripple modes** - Only basic frequency visualization
- ❌ **No FrequencySourceManager integration** - Drum sounds don't feed real-time visualizer
- ✅ **Story 19.1 complete** - LiveAudioVisualizer embedded mode ready

### Current Lesson 2 Structure
**Step 2.1 (currentStepIndex === 0):**
- Instruction: "Click drum buttons to see colors in visualizer"
- Shows 4 drum buttons: Kick (36), Snare (38), Hi-Hat (42), Crash (49)
- Uses CompactVisualizer component
- Auto-advances after playing a few sounds

**Step 2.2 (currentStepIndex === 1):**
- Instruction: "Switch between color modes"
- Shows color mode switcher (spectrum/chromatic/harmonic)
- Explains each color mode's meaning
- Completes after cycling through modes

[Source: src/components/Education/EducationMode.tsx:59-76, lines 376-485]

### What Needs to Change
1. **Replace CompactVisualizer with LiveAudioVisualizer (embedded mode)**
2. **Connect drum playback to FrequencySourceManager** for real-time visualization
3. **Add visualization mode switching** (spectrum → waveform → ripple)
4. **Update lesson instructions** to reference new visualization modes
5. **Maintain color mode switching** (spectrum/chromatic/harmonic still works)
6. **Preserve lesson completion logic** (auto-advance, state tracking)

[Source: Epic 19, docs/epics/epic-19-education-dj-visualizer-integration.md]

---

## Acceptance Criteria

### AC 1: Replace CompactVisualizer with LiveAudioVisualizer
- [x] Remove CompactVisualizer import and component usage in lesson 2
- [x] Add LiveAudioVisualizer component with `embedded={true}` prop
- [x] Position visualizer in same location as CompactVisualizer was
- [ ] Verify responsive layout (mobile/tablet/desktop) - manual testing required
- [ ] No visual regressions in lesson layout - manual testing required

### AC 2: Connect Drum Playback to Visualization
- [x] Drum button clicks trigger `audioEngine.playDrum()` (existing, verified in code)
- [x] Drum sounds feed FrequencySourceManager via addDrumHit() integration
- [ ] LiveAudioVisualizer shows real-time frequency response when drums play - manual testing required
- [ ] Visualization reacts immediately (<50ms latency) - manual testing required
- [ ] All four drum types (kick, snare, hi-hat, crash) visualize correctly - manual testing required

### AC 3: Visualization Mode Switching for Step 2.2
- [x] Update step 2.2 instruction to reference visualization modes
- [x] Add visualization mode cycling button (Spectrum → Waveform → Ripple)
- [x] Button augments current color mode switcher (both present)
- [ ] Visualization mode changes reflected immediately in LiveAudioVisualizer - manual testing required
- [ ] Student can see how the same drum sound looks in each mode - manual testing required

### AC 4: Color Mode Switching Still Works
- [x] Original color mode switcher (spectrum/chromatic/harmonic) preserved
- [x] Color modes apply to LiveAudioVisualizer's spectrum mode via colorMode prop
- [x] Button label updated to "Switch to [X] Color" for clarity
- [x] Explanation text for each color mode unchanged

### AC 5: Lesson Completion Logic Intact
- [x] Step 2.1 auto-advances after student plays drums (code verified)
- [x] Step 2.2 completes after cycling through both viz and color modes (code verified)
- [ ] State tracking for currentStepIndex works correctly - manual testing required
- [ ] Lesson progress bar updates properly - manual testing required
- [ ] No breaking changes to lesson flow - manual testing required

### AC 6: Existing Lessons Unaffected
- [x] Lesson 1 (Basic Beat) code unchanged (code review confirms)
- [x] Lesson 3 (Rhythm Patterns) code unchanged (code review confirms)
- [x] Navigation between lessons unchanged (code review confirms)
- [x] Exit Education button works (code review confirms)
- [ ] No console errors when navigating between lessons - manual testing required

---

## Tasks / Subtasks

### Task 1: Import and Setup LiveAudioVisualizer (AC: 1)
- [x] Add import for LiveAudioVisualizer at top of EducationMode.tsx
- [x] Remove CompactVisualizer import (if not used elsewhere)
- [x] Add state variable for visualization mode: `const [vizMode, setVizMode] = useState<VisualizationMode>('spectrum')`
- [x] Import VisualizationMode type from LiveAudioVisualizer

### Task 2: Replace CompactVisualizer in JSX (AC: 1)
- [x] Locate CompactVisualizer usage in lesson 2 JSX (line ~396)
- [x] Replace with:
  ```tsx
  <LiveAudioVisualizer
    embedded={true}
    currentMode={vizMode}
    onModeChange={setVizMode}
    className="mb-6"
  />
  ```
- [x] Verify responsive container classes maintained
- [ ] Test layout on mobile/tablet/desktop breakpoints

### Task 3: Connect Drum Playback to FrequencySourceManager (AC: 2)
**Note:** FrequencySourceManager is globally exposed by LiveAudioVisualizer as `window.frequencySourceManager`

- [x] Review existing `playDrumSound()` function (lines 201-225)
- [x] Verify that drum sounds already trigger audioEngine.playDrum()
- [x] Confirm FrequencySourceManager auto-captures audio from audioEngine (manual integration needed)
- [ ] Test that visualizer shows response when drums play
- [x] Manual integration added: sourceManager.addDrumHit() at lines 219-222
- [x] Added useEffect to configure FrequencySourceManager mix mode to 'drums-only' for lesson 2

### Task 4: Add Visualization Mode Switcher for Step 2.2 (AC: 3)
- [x] Add new button to step 2.2 UI (alongside color mode button) - lines 410-416
- [x] Implement mode cycling logic at lines 245-250
- [x] Update button label to show current mode: dynamic text at lines 414-415
- [ ] Add explanatory text for each visualization mode (see Task 5)

### Task 5: Update Lesson Instructions (AC: 3, 4)
- [x] Update step 2.1 instruction to reference "live spectrum visualization" - line 79
- [x] Update step 2.2 instruction to reference "visualization modes" - line 85
- [x] Add explanatory text for each visualization mode (lines 478-488):
  - **Spectrum:** Shows frequency bars (low frequencies left, high right)
  - **Waveform:** Shows audio waveform over time
  - **Ripple:** Shows audio energy as expanding circles
- [x] Keep existing color mode explanations (lines 490-500)

### Task 6: Pass Color Mode to LiveAudioVisualizer (AC: 4)
- [x] Added colorMode prop to LiveAudioVisualizer (line 29)
- [x] Added colorMode support to SpectrumVisualization config
- [x] Added setColorMode method to VisualizationEngine (line 121)
- [x] Pass visualizerSettings.colorMode to LiveAudioVisualizer (line 434)
- [x] Added useEffect to update color mode when prop changes (lines 240-245)

### Task 7: Test Lesson Completion Logic (AC: 5)
- [x] Added vizModeStep state tracking (line 30)
- [x] Updated switchVisualizationMode to increment vizModeStep (line 251)
- [x] Updated completion logic to require both viz mode and color mode switches (line 267)
- [x] Step 2.1 auto-advance logic intact (lines 225-232)
- [x] Step 2.2 completion logic updated (lines 266-271)
- [ ] Manual browser testing will be done in Task 9

### Task 8: Regression Testing - Lessons 1 and 3 (AC: 6)
- [x] Lessons 1 and 3 use different UI (pattern grid, not visualizer)
- [x] CompactVisualizer was only used in lesson 2
- [x] No code changes affect lessons 1 or 3
- [ ] Manual browser testing will be done in Task 9

### Task 9: Manual Testing - Full Lesson 2 Flow (AC: 1-5)
- [ ] Start Education Mode and select lesson 2
- [ ] Step 2.1: Click each drum button (kick, snare, hi-hat, crash)
- [ ] Verify LiveAudioVisualizer shows real-time frequency response
- [ ] Confirm auto-advance to step 2.2 after playing drums
- [ ] Step 2.2: Cycle through visualization modes (spectrum → waveform → ripple)
- [ ] Cycle through color modes (spectrum → chromatic → harmonic)
- [ ] Verify lesson completion and return to lesson selection
- [ ] Document results in Dev Agent Record

---

## Dev Notes

### Current EducationMode Component Structure
**File:** `src/components/Education/EducationMode.tsx`
**Component:** `EducationMode` (functional component)

**Key State Variables:**
- `selectedLesson` - Currently selected lesson object
- `currentStepIndex` - Current step in selected lesson (0-based)
- `visualizerSettings` - Color mode settings (spectrum/chromatic/harmonic)
- `midiNotes` - Array of MIDI notes for visualization
- `colorModeStep` - Tracks color mode switching count

[Source: src/components/Education/EducationMode.tsx:13-29]

### Lesson 2 (Color and Pitch) Current Implementation

**Lesson Definition (lines 59-76):**
```typescript
{
  id: '2',
  title: 'Color and Pitch',
  description: 'Discover how musical notes relate to colors',
  difficulty: 'beginner',
  steps: [
    {
      id: '2-1',
      instruction: 'Click the drum buttons below to see how different sounds create different colors in the visualizer',
      hint: 'Notice how low sounds like kick drums appear as red, while high sounds appear as blue/violet',
      completed: false
    },
    {
      id: '2-2',
      instruction: 'Now try switching between the different color modes to see how the same sounds can be displayed differently',
      hint: 'Spectrum mode shows frequency (low=red, high=violet), Chromatic shows note names, Harmonic shows musical relationships',
      completed: false
    }
  ]
}
```

**CompactVisualizer Usage (line ~396):**
```typescript
<div className="mb-6">
  <CompactVisualizer
    settings={visualizerSettings}
    onSettingsChange={setVisualizerSettings}
    midiNotes={midiNotes}
  />
</div>
```

**Drum Button Click Handler (lines 201-225):**
```typescript
const playDrumSound = (drumName: string, midiNote: number) => {
  // Play the drum sound
  audioEngine.playDrum(drumName, 0.8);

  // Add MIDI note for visualization
  const note: MIDINote = {
    note: midiNote,
    velocity: 0.8,
    channel: 10,
    timestamp: Date.now(),
    userId: 'education'
  };

  setMidiNotes(prev => [...prev.slice(-10), note]);

  // Auto-advance step 2.1 after playing drums
  if (selectedLesson?.id === '2' && currentStepIndex === 0) {
    setTimeout(() => {
      if (currentStepIndex === 0) {
        setCurrentStepIndex(1);
      }
    }, 3000);
  }
};
```

[Source: src/components/Education/EducationMode.tsx:201-225]

### FrequencySourceManager Integration
**Global Exposure:**
LiveAudioVisualizer exposes FrequencySourceManager globally at `window.frequencySourceManager` (line 68 of LiveAudioVisualizer.tsx)

**Integration Pattern:**
```typescript
// FrequencySourceManager should auto-capture audio from audioEngine
// If manual integration needed:
const sourceManager = (window as any).frequencySourceManager;
if (sourceManager && sourceManager.addMidiNote) {
  sourceManager.addMidiNote(midiNote, velocity);
}
```

**Note:** Verify if drum sounds from audioEngine.playDrum() are automatically captured. If not, add manual integration in playDrumSound() function.

[Source: src/components/LiveAudioVisualizer/LiveAudioVisualizer.tsx:68, src/utils/frequencySourceManager.ts]

### LiveAudioVisualizer Props Interface
**Expected Props (from Story 19.1):**
```typescript
interface LiveAudioVisualizerProps {
  onBack?: () => void;
  embedded?: boolean;
  layout?: 'mobile' | 'desktop';
  className?: string;
  currentMode?: VisualizationMode; // May need to add
  colorMode?: 'spectrum' | 'chromatic' | 'harmonic'; // May need to add
}
```

**Note:** If `currentMode` and `colorMode` props don't exist in Story 19.1 implementation, add them or use alternative approach (state passed via context, or controlled via LiveAudioVisualizer's internal state).

[Source: Story 19.1 Dev Notes, src/components/LiveAudioVisualizer/LiveAudioVisualizer.tsx]

### Visualization Mode Type
**Import from LiveAudioVisualizer:**
```typescript
import { LiveAudioVisualizer } from '../LiveAudioVisualizer/LiveAudioVisualizer';
import type { VisualizationMode } from '../LiveAudioVisualizer/VisualizationEngine';
```

**Type Definition:**
```typescript
export type VisualizationMode = 'spectrum' | 'waveform' | 'ripple';
```

[Source: src/components/LiveAudioVisualizer/VisualizationEngine.ts:14]

### Color Mode Integration
**Existing visualizerSettings State:**
```typescript
const [visualizerSettings, setVisualizerSettings] = useState<VisualizerSettings>({
  colorMode: 'spectrum',
  brightness: 0.8,
  ledMatrixEnabled: false,
  ledMatrixIP: ''
});
```

**Color Mode Switcher (lines 227-245):**
```typescript
const switchColorMode = () => {
  const modes: Array<'spectrum' | 'chromatic' | 'harmonic'> = ['spectrum', 'chromatic', 'harmonic'];
  const currentIndex = modes.indexOf(visualizerSettings.colorMode);
  const nextIndex = (currentIndex + 1) % modes.length;

  setVisualizerSettings(prev => ({
    ...prev,
    colorMode: modes[nextIndex]
  }));

  setColorModeStep(prev => prev + 1);

  // Auto-complete step 2.2 after trying all modes
  if (selectedLesson?.id === '2' && currentStepIndex === 1 && colorModeStep >= 2) {
    setTimeout(() => {
      nextStep();
    }, 1000);
  }
};
```

**Note:** This functionality must be preserved and work alongside new visualization mode switching.

[Source: src/components/Education/EducationMode.tsx:227-245]

### Responsive Layout Patterns
**Existing Tailwind Classes:**
- Mobile padding: `p-4`
- Desktop padding: `sm:p-6`
- Mobile text: `text-base`
- Desktop text: `sm:text-lg`
- Grid layout: `grid grid-cols-2 sm:grid-cols-4 gap-3`

**ViewCard Pattern (if used):**
```typescript
<ViewCard title="Sound and Color Explorer">
  <LiveAudioVisualizer embedded={true} />
</ViewCard>
```

[Source: docs/architecture/component-architecture.md, CLAUDE.md#responsive-design]

### File Locations
- **Component to modify:** `src/components/Education/EducationMode.tsx`
- **Component to import:** `src/components/LiveAudioVisualizer/LiveAudioVisualizer.tsx`
- **Types to import:** `src/components/LiveAudioVisualizer/VisualizationEngine.ts` (VisualizationMode)
- **Utilities involved:** `src/utils/audioEngine.ts`, `src/utils/frequencySourceManager.ts`

[Source: docs/architecture/source-tree.md]

### Technology Stack
- **React:** 18.2.0 (functional components with hooks)
- **TypeScript:** 5.2.2 (strict mode)
- **Styling:** Tailwind CSS
- **Audio:** Tone.js 15.1.22 (via audioEngine)
- **Icons:** Lucide React (existing usage)

[Source: docs/architecture/tech-stack.md]

---

## Testing

### Manual Testing Strategy
**This project uses manual testing with browser DevTools, NOT automated test suites.**

[Source: CLAUDE.md#project-scale--testing-philosophy]

### Verification Checklist (Browser Testing)

**Pre-Integration Baseline:**
1. Open Education Mode and select lesson 2
2. Complete lesson 2 with current CompactVisualizer implementation
3. Document current behavior and UI layout
4. Take screenshots for comparison after integration

**Post-Integration - Lesson 2 Step 2.1:**
1. Navigate to Education Mode → Lesson 2
2. Verify LiveAudioVisualizer renders in embedded mode
3. Click Kick drum button (🥁)
4. Observe spectrum visualization response (should show low frequency red bars)
5. Click Snare drum button (🥁)
6. Observe spectrum visualization response (mid frequency green bars)
7. Click Hi-Hat button (🎩)
8. Observe spectrum visualization response (high frequency blue bars)
9. Click Crash button (💥)
10. Observe spectrum visualization response (very high frequency violet bars)
11. Verify auto-advance to step 2.2 after 3 seconds

**Post-Integration - Lesson 2 Step 2.2:**
1. Verify instruction text references visualization modes
2. Click "Switch Visualization Mode" button
3. Observe mode change: Spectrum → Waveform
4. Play drums and observe waveform visualization
5. Click "Switch Visualization Mode" again
6. Observe mode change: Waveform → Ripple
7. Play drums and observe ripple visualization
8. Click "Switch Visualization Mode" again (should cycle back to Spectrum)
9. Click "Switch Color Mode" button
10. Cycle through color modes (spectrum → chromatic → harmonic)
11. Verify lesson completes after cycling through modes

**Regression Testing - Lessons 1 and 3:**
1. Navigate to lesson 1 (Basic Beat)
2. Create kick drum pattern (steps 1, 5, 9, 13)
3. Play pattern and verify audio playback
4. Reset pattern and verify it clears
5. Complete lesson 1
6. Navigate to lesson 3 (Rhythm Patterns)
7. Complete kick pattern (step 3.1)
8. Complete snare pattern (step 3.2)
9. Play combined pattern
10. Verify lesson 3 completion
11. Check console for errors throughout all lessons

**Responsive Testing:**
1. Open browser DevTools → Device Toolbar
2. Test lesson 2 on mobile (375px width)
3. Verify LiveAudioVisualizer embedded mode fits layout
4. Test drum buttons touch targets (min 44px)
5. Test visualization mode switching on mobile
6. Repeat on tablet (768px) and desktop (1280px)
7. Check for layout overflow or clipping issues

**Performance Testing:**
1. Open browser DevTools → Performance tab
2. Start recording
3. Play all 4 drum types rapidly (kick, snare, hi-hat, crash)
4. Switch visualization modes while drums playing
5. Stop recording
6. Verify no FPS drops below 30fps (target 60fps)
7. Check for memory leaks or excessive allocations

[Source: CLAUDE.md#quality-assurance, docs/architecture/testing-strategy.md]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-10-19 | 1.1 | Implementation complete - ready for manual testing | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
No debug logs created - implementation completed without errors

### Completion Notes
**Implementation Complete - Ready for Manual Testing**

All 9 tasks completed successfully:
1. ✅ LiveAudioVisualizer imports and state setup in EducationMode
2. ✅ CompactVisualizer replaced with LiveAudioVisualizer (embedded mode)
3. ✅ Drum playback connected to FrequencySourceManager with manual integration
4. ✅ Visualization mode switcher added (Spectrum → Waveform → Ripple)
5. ✅ Lesson instructions updated to reference visualization modes
6. ✅ Color mode support added throughout the visualization pipeline
7. ✅ Lesson completion logic updated for both mode types
8. ✅ Regression analysis confirms lessons 1 & 3 unaffected
9. ⏳ Manual testing pending (see Testing section below)

**Key Enhancements Made:**
- Added controlled mode props to LiveAudioVisualizer (currentMode, onModeChange, colorMode)
- Extended SpectrumVisualization with colorMode support (spectrum/chromatic/harmonic)
- Added VisualizationEngine.setColorMode() method for color mode updates
- FrequencySourceManager configured for 'drums-only' mode in lesson 2
- Completion logic requires trying both visualization and color mode switches

**Manual Testing Required:**
User must test in browser at localhost:5173 per verification checklist in Testing section.

### File List
_Files modified:_
- src/components/Education/EducationMode.tsx
- src/components/LiveAudioVisualizer/LiveAudioVisualizer.tsx
- src/components/LiveAudioVisualizer/VisualizationEngine.ts
- src/components/LiveAudioVisualizer/visualizations/SpectrumVisualization.ts

---

## QA Results

_This section will be populated after QA review._
