# Story 18.5: WLED Manager UI (Unified Component)

**Epic:** Epic 18 - Intelligent WLED Visualization Routing
**Status:** üìù PLANNING
**Priority:** üü° MEDIUM
**Complexity:** Medium
**Time Estimate:** 4-5 hours
**Prerequisites:** Stories 18.0-18.4 (Auth + Device Registry + Routing Matrix + Rules)

---

## User Story

As a **user configuring WLED hardware**,
I want **a unified interface to manage my LED devices and see real-time routing status**,
So that **I can easily add/edit/delete devices and understand which modules are using which LEDs**.

---

## Story Context

### Why This Story

**User-Facing Interface:** Story 18.5 creates the UI that makes Epic 18's intelligent routing system accessible and transparent to users.

**Current State:**
- ‚úÖ Device registry backend working (Story 18.1)
- ‚úÖ Routing matrix calculating assignments (Story 18.3)
- ‚úÖ Routing rules applied (Story 18.4)
- ‚ùå No UI for device CRUD operations
- ‚ùå No visualization of routing assignments
- ‚ùå No capability configuration interface
- ‚ùå Users must use Supabase dashboard to manage devices (poor UX)

**Desired State (Story 18.5):**
- ‚úÖ WLED Manager component with ViewTemplate layout
- ‚úÖ Device list with CRUD actions (add, edit, delete)
- ‚úÖ Real-time routing status display
- ‚úÖ Capability configuration UI (1D vs 2D, LED count, grid settings)
- ‚úÖ Connection testing (test button ‚Üí HTTP `/json/info`)
- ‚úÖ Mobile-responsive design

**Example UI Screens:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ WLED Manager                              [+ Add]   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Devices (3)                                         ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ ‚úÖ Fretboard Grid (192.168.1.100)                  ‚îÇ
‚îÇ    6x25 LEDs, 2D Grid, Serpentine                  ‚îÇ
‚îÇ    ‚Üí DrumMachine: step-sequencer-grid              ‚îÇ
‚îÇ    ‚Üí AudioReactive: midi-trigger-ripple (overlay)  ‚îÇ
‚îÇ    [Edit] [Test] [Delete]                          ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ ‚úÖ Piano Strip (192.168.1.101)                     ‚îÇ
‚îÇ    88 LEDs, 1D Strip                               ‚îÇ
‚îÇ    ‚Üí PianoRoll: piano-keys                         ‚îÇ
‚îÇ    [Edit] [Test] [Delete]                          ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ ‚ùå Stage Left (192.168.1.102) [OFFLINE]            ‚îÇ
‚îÇ    144 LEDs, 1D Strip                              ‚îÇ
‚îÇ    ‚Üí No assignment (device offline)                ‚îÇ
‚îÇ    [Edit] [Test] [Delete]                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Acceptance Criteria

### Functional Requirements

1. **WLEDManager Component**
   - Create `src/components/WLED/WLEDManager.tsx`
   - Use ViewTemplate for consistent layout
   - Mobile-responsive (ViewCard pattern)
   - Accessible to authenticated users only (RequireAuth wrapper)
   - Route: `/wled-manager`

2. **Device List Display**
   - Show all user devices from registry
   - Real-time updates (Supabase Realtime subscription)
   - Device status indicator (online/offline)
   - Device info: Name, IP, LED count, dimension, grid config
   - Current routing assignment display:
     - Primary module ‚Üí visualization type
     - Overlays (if any)
   - Empty state: "No devices configured. Add your first WLED device."

3. **Add Device Form**
   - Modal/slide-out form with fields:
     - Device name (required, 1-50 chars)
     - IP address (required, IPv4 validation)
     - Device type: 1D Strip or 2D Grid (radio buttons)
     - LED count (required, > 0)
     - Grid configuration (conditional, only if 2D selected):
       - Width (columns)
       - Height (rows)
       - Serpentine wiring (checkbox)
       - Orientation (horizontal/vertical radio)
     - Location (optional, text)
     - Priority (optional, slider 0-100)
     - Brightness (slider 0-255, default 204)
     - Reverse direction (checkbox)
   - "Test Connection" button (pre-fill LED count from WLED API)
   - "Save Device" button (creates device in registry)

4. **Edit Device Form**
   - Same form as Add Device, pre-populated with existing values
   - Update device in registry on save
   - Real-time sync to other clients

5. **Delete Device**
   - Confirmation modal: "Delete [Device Name]? This cannot be undone."
   - Removes device from registry
   - Real-time sync to other clients

6. **Test Connection Button**
   - Click "Test" ‚Üí HTTP request to `http://<ip>/json/info`
   - Show loading spinner during request
   - Success: ‚úÖ "Connected! 150 LEDs detected (firmware v0.14.0)"
   - Failure: ‚ùå "Connection failed. Check IP address and network."
   - Auto-populate LED count if detected

7. **Routing Status Display**
   - For each device, show:
     - Primary assignment: `DrumMachine ‚Üí step-sequencer-grid`
     - Overlays: `AudioReactive: midi-trigger-ripple (overlay)`
     - If no assignment: `No active modules`
   - Real-time updates when routing changes
   - Color-coded by module (e.g., DrumMachine = blue, Guitar = green)

8. **Capability Configuration UI**
   - Visual grid preview for 2D devices (show LED layout)
   - Supported visualizations checklist:
     - Auto-suggest based on device type (1D vs 2D)
     - User can manually add/remove visualization types
   - Preview example: "This device can show step sequencer, piano keys, audio spectrum"

### Integration Requirements

9. **Real-Time Sync**
   - Subscribe to `wled_devices` Realtime changes
   - Device added ‚Üí appears immediately in list
   - Device updated ‚Üí changes reflected in UI
   - Device deleted ‚Üí removed from list
   - Optimistic UI updates (show change before DB confirms)

10. **Routing Matrix Integration**
    - Subscribe to routing change events
    - Update routing status display when assignments change
    - Show active rules (e.g., "Guitar Grid Exclusive applied")

11. **Authentication Gating**
    - Wrap component in `RequireAuth` (Story 18.0)
    - Anonymous users see: "Create account to save WLED devices"
    - Authenticated users see full CRUD interface

### Quality Requirements

12. **Mobile Responsiveness**
    - ViewCard layout adapts to screen size
    - Forms use mobile-friendly inputs (number pads for LED count)
    - Touch-friendly buttons (44px minimum)
    - Swipe actions for edit/delete (mobile)

13. **Error Handling**
    - Network errors: "Unable to save device. Check connection."
    - Validation errors: Inline field errors (e.g., "Invalid IP address")
    - RLS violations: "Access denied" (shouldn't happen with auth)
    - Connection test timeout: "Request timed out after 5 seconds"

14. **Performance**
    - Device list renders <100ms (even with 20+ devices)
    - Realtime updates <200ms (Supabase Realtime)
    - No UI jank during form input
    - Optimistic updates feel instant

---

## Technical Approach

### Phase 1: WLEDManager Component Structure (1.5 hours)

**Create Main Component:**
```tsx
// src/components/WLED/WLEDManager.tsx
import React, { useState, useEffect } from 'react';
import { ViewTemplate, ViewCard } from '@/components/Layout/ViewTemplate';
import { RequireAuth } from '@/components/Auth/RequireAuth';
import { wledDeviceRegistry } from '@/services/WLEDDeviceRegistry';
import { routingMatrix } from '@/services/VisualizationRoutingMatrix';
import { WLEDDevice } from '@/types/wled';
import { DeviceAssignment } from '@/types/visualization';
import { Plus, Wifi, WifiOff } from 'lucide-react';

export const WLEDManager: React.FC<{ onBack?: () => void }> = ({ onBack }) => {
  const [devices, setDevices] = useState<WLEDDevice[]>([]);
  const [routingAssignments, setRoutingAssignments] = useState<DeviceAssignment[]>([]);
  const [showAddDevice, setShowAddDevice] = useState(false);

  // Subscribe to device changes
  useEffect(() => {
    // Initial load
    wledDeviceRegistry.getDevices().then(setDevices);

    // Realtime subscription
    const unsubscribe = wledDeviceRegistry.subscribeToDevices(setDevices);

    return unsubscribe;
  }, []);

  // Subscribe to routing changes
  useEffect(() => {
    const unsubscribe = routingMatrix.onRoutingChange((event) => {
      setRoutingAssignments(event.assignments);
    });

    // Initial routing
    routingMatrix.recalculateRouting();

    return unsubscribe;
  }, []);

  return (
    <RequireAuth
      feature="WLED Device Registry"
      featureDescription="Save your WLED devices and access them from any device"
    >
      <ViewTemplate
        title="WLED Manager"
        subtitle="Manage LED devices and view routing status"
        onBack={onBack}
        variant="centered"
        maxWidth="4xl"
        badge="Beta"
        badgeVariant="orange"
        headerActions={
          <button
            onClick={() => setShowAddDevice(true)}
            className="btn-primary flex items-center gap-2"
          >
            <Plus className="w-5 h-5" />
            Add Device
          </button>
        }
      >
        {/* Device List */}
        <ViewCard title={`Devices (${devices.length})`}>
          {devices.length === 0 ? (
            <EmptyState onAddDevice={() => setShowAddDevice(true)} />
          ) : (
            <DeviceList
              devices={devices}
              routingAssignments={routingAssignments}
              onEditDevice={(device) => {
                // TODO: Open edit modal
              }}
              onDeleteDevice={async (deviceId) => {
                // TODO: Confirmation + delete
              }}
            />
          )}
        </ViewCard>

        {/* Routing Status */}
        <ViewCard title="Routing Status">
          <RoutingStatusDisplay assignments={routingAssignments} />
        </ViewCard>

        {/* About */}
        <ViewCard title="About WLED Manager">
          <p className="text-gray-300 text-sm leading-relaxed">
            Configure your WLED devices once, and they'll work automatically with all
            modules. The routing system intelligently matches visualizations to
            appropriate devices based on capabilities and context.
          </p>
        </ViewCard>

        {/* Add Device Modal */}
        {showAddDevice && (
          <AddDeviceModal
            isOpen={showAddDevice}
            onClose={() => setShowAddDevice(false)}
            onSave={async (deviceInput) => {
              await wledDeviceRegistry.createDevice(deviceInput);
              setShowAddDevice(false);
            }}
          />
        )}
      </ViewTemplate>
    </RequireAuth>
  );
};
```

### Phase 2: Device List and CRUD UI (1.5 hours)

**Device List Component:**
```tsx
// src/components/WLED/DeviceList.tsx
interface DeviceListProps {
  devices: WLEDDevice[];
  routingAssignments: DeviceAssignment[];
  onEditDevice: (device: WLEDDevice) => void;
  onDeleteDevice: (deviceId: string) => void;
}

const DeviceList: React.FC<DeviceListProps> = ({
  devices,
  routingAssignments,
  onEditDevice,
  onDeleteDevice,
}) => {
  return (
    <div className="space-y-4">
      {devices.map((device) => {
        const assignment = routingAssignments.find(
          (a) => a.device.id === device.id
        );

        return (
          <DeviceCard
            key={device.id}
            device={device}
            assignment={assignment}
            onEdit={() => onEditDevice(device)}
            onDelete={() => onDeleteDevice(device.id)}
          />
        );
      })}
    </div>
  );
};

const DeviceCard: React.FC<{
  device: WLEDDevice;
  assignment?: DeviceAssignment;
  onEdit: () => void;
  onDelete: () => void;
}> = ({ device, assignment, onEdit, onDelete }) => {
  const [isOnline, setIsOnline] = useState<boolean | null>(null);
  const [isTesting, setIsTesting] = useState(false);

  const testConnection = async () => {
    setIsTesting(true);
    try {
      await wledDeviceRegistry.testConnection(device.ip);
      setIsOnline(true);
    } catch (error) {
      setIsOnline(false);
    }
    setIsTesting(false);
  };

  return (
    <div className="bg-gray-800 rounded-lg border border-gray-700 p-4">
      {/* Header */}
      <div className="flex items-start justify-between">
        <div className="flex items-center gap-3">
          {isOnline === null ? (
            <Wifi className="w-5 h-5 text-gray-500" />
          ) : isOnline ? (
            <Wifi className="w-5 h-5 text-green-500" />
          ) : (
            <WifiOff className="w-5 h-5 text-red-500" />
          )}
          <div>
            <h3 className="text-white font-semibold">{device.name}</h3>
            <p className="text-gray-400 text-sm">{device.ip}</p>
          </div>
        </div>

        <div className="flex gap-2">
          <button
            onClick={testConnection}
            disabled={isTesting}
            className="px-3 py-1 text-sm bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors"
          >
            {isTesting ? 'Testing...' : 'Test'}
          </button>
          <button
            onClick={onEdit}
            className="px-3 py-1 text-sm bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors"
          >
            Edit
          </button>
          <button
            onClick={onDelete}
            className="px-3 py-1 text-sm bg-red-900/30 hover:bg-red-900/50 text-red-400 rounded-lg transition-colors"
          >
            Delete
          </button>
        </div>
      </div>

      {/* Device Info */}
      <div className="mt-3 text-sm text-gray-400">
        {device.capabilities.dimensions === '1D' ? (
          <span>{device.capabilities.ledCount} LEDs, 1D Strip</span>
        ) : (
          <span>
            {device.capabilities.gridConfig?.width}x
            {device.capabilities.gridConfig?.height} LEDs, 2D Grid,{' '}
            {device.capabilities.gridConfig?.serpentine ? 'Serpentine' : 'Linear'}
          </span>
        )}
        {device.location && <span> ¬∑ {device.location}</span>}
      </div>

      {/* Routing Status */}
      {assignment && (
        <div className="mt-3 pt-3 border-t border-gray-700">
          <div className="text-sm">
            <div className="text-gray-300">
              ‚Üí <span className="text-blue-400">{assignment.primary.moduleId}</span>:{' '}
              {assignment.primary.visualizationType}
            </div>
            {assignment.overlays.length > 0 && (
              <div className="mt-1 text-gray-400">
                {assignment.overlays.map((overlay, i) => (
                  <div key={i}>
                    ‚Üí <span className="text-purple-400">{overlay.moduleId}</span>:{' '}
                    {overlay.visualizationType} (overlay)
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
};
```

**Add/Edit Device Modal:**
```tsx
// src/components/WLED/AddDeviceModal.tsx
import { useState } from 'react';
import { WLEDDeviceInput, DeviceCapabilities } from '@/types/wled';

interface AddDeviceModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSave: (device: WLEDDeviceInput) => Promise<void>;
  editDevice?: WLEDDevice; // If provided, edit mode
}

export const AddDeviceModal: React.FC<AddDeviceModalProps> = ({
  isOpen,
  onClose,
  onSave,
  editDevice,
}) => {
  const [name, setName] = useState(editDevice?.name || '');
  const [ip, setIp] = useState(editDevice?.ip || '');
  const [deviceType, setDeviceType] = useState<'1D' | '2D'>(
    editDevice?.capabilities.dimensions || '1D'
  );
  const [ledCount, setLedCount] = useState(
    editDevice?.capabilities.ledCount || 100
  );
  const [gridWidth, setGridWidth] = useState(
    editDevice?.capabilities.gridConfig?.width || 6
  );
  const [gridHeight, setGridHeight] = useState(
    editDevice?.capabilities.gridConfig?.height || 25
  );
  const [serpentine, setSerpentine] = useState(
    editDevice?.capabilities.gridConfig?.serpentine || true
  );
  const [orientation, setOrientation] = useState<'horizontal' | 'vertical'>(
    editDevice?.capabilities.gridConfig?.orientation || 'horizontal'
  );
  const [location, setLocation] = useState(editDevice?.location || '');
  const [brightness, setBrightness] = useState(editDevice?.brightness || 204);
  const [reverseDirection, setReverseDirection] = useState(
    editDevice?.reverse_direction || false
  );

  const [isTesting, setIsTesting] = useState(false);
  const [testResult, setTestResult] = useState<string | null>(null);
  const [isSaving, setIsSaving] = useState(false);

  const handleTestConnection = async () => {
    setIsTesting(true);
    setTestResult(null);

    try {
      const info = await wledDeviceRegistry.testConnection(ip);
      setTestResult(`‚úÖ Connected! ${info.leds.count} LEDs detected (firmware ${info.ver})`);
      // Auto-populate LED count
      if (deviceType === '1D') {
        setLedCount(info.leds.count);
      }
    } catch (error) {
      setTestResult(`‚ùå Connection failed: ${(error as Error).message}`);
    }

    setIsTesting(false);
  };

  const handleSave = async () => {
    setIsSaving(true);

    const capabilities: DeviceCapabilities = {
      dimensions: deviceType,
      ledCount: deviceType === '1D' ? ledCount : gridWidth * gridHeight,
      gridConfig:
        deviceType === '2D'
          ? {
              width: gridWidth,
              height: gridHeight,
              serpentine,
              orientation,
            }
          : undefined,
      supportedVisualizations: ['generic-color-array'], // Default
    };

    const deviceInput: WLEDDeviceInput = {
      name,
      ip,
      capabilities,
      location,
      brightness,
      reverse_direction: reverseDirection,
    };

    try {
      await onSave(deviceInput);
      onClose();
    } catch (error) {
      console.error('Failed to save device:', error);
      alert('Failed to save device. Check console for details.');
    }

    setIsSaving(false);
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div className="bg-gray-800 rounded-lg border border-gray-700 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div className="p-6">
          <h2 className="text-2xl font-bold text-white mb-6">
            {editDevice ? 'Edit Device' : 'Add WLED Device'}
          </h2>

          {/* Form Fields */}
          <div className="space-y-4">
            {/* Name */}
            <div>
              <label className="block text-sm font-medium text-gray-300 mb-2">
                Device Name
              </label>
              <input
                type="text"
                value={name}
                onChange={(e) => setName(e.target.value)}
                placeholder="Fretboard Grid"
                className="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white"
              />
            </div>

            {/* IP Address */}
            <div>
              <label className="block text-sm font-medium text-gray-300 mb-2">
                IP Address
              </label>
              <input
                type="text"
                value={ip}
                onChange={(e) => setIp(e.target.value)}
                placeholder="192.168.1.100"
                className="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white"
              />
            </div>

            {/* Test Connection */}
            <div>
              <button
                onClick={handleTestConnection}
                disabled={!ip || isTesting}
                className="btn-secondary"
              >
                {isTesting ? 'Testing...' : 'Test Connection'}
              </button>
              {testResult && (
                <p className="mt-2 text-sm text-gray-400">{testResult}</p>
              )}
            </div>

            {/* Device Type */}
            <div>
              <label className="block text-sm font-medium text-gray-300 mb-2">
                Device Type
              </label>
              <div className="flex gap-4">
                <label className="flex items-center gap-2">
                  <input
                    type="radio"
                    checked={deviceType === '1D'}
                    onChange={() => setDeviceType('1D')}
                  />
                  <span className="text-white">1D Strip</span>
                </label>
                <label className="flex items-center gap-2">
                  <input
                    type="radio"
                    checked={deviceType === '2D'}
                    onChange={() => setDeviceType('2D')}
                  />
                  <span className="text-white">2D Grid</span>
                </label>
              </div>
            </div>

            {/* LED Count (1D) or Grid Config (2D) */}
            {deviceType === '1D' ? (
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">
                  LED Count
                </label>
                <input
                  type="number"
                  value={ledCount}
                  onChange={(e) => setLedCount(parseInt(e.target.value))}
                  min={1}
                  className="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white"
                />
              </div>
            ) : (
              <>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-300 mb-2">
                      Width (columns)
                    </label>
                    <input
                      type="number"
                      value={gridWidth}
                      onChange={(e) => setGridWidth(parseInt(e.target.value))}
                      min={1}
                      className="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-300 mb-2">
                      Height (rows)
                    </label>
                    <input
                      type="number"
                      value={gridHeight}
                      onChange={(e) => setGridHeight(parseInt(e.target.value))}
                      min={1}
                      className="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white"
                    />
                  </div>
                </div>
                <div>
                  <label className="flex items-center gap-2">
                    <input
                      type="checkbox"
                      checked={serpentine}
                      onChange={(e) => setSerpentine(e.target.checked)}
                    />
                    <span className="text-white">Serpentine Wiring</span>
                  </label>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-2">
                    Orientation
                  </label>
                  <div className="flex gap-4">
                    <label className="flex items-center gap-2">
                      <input
                        type="radio"
                        checked={orientation === 'horizontal'}
                        onChange={() => setOrientation('horizontal')}
                      />
                      <span className="text-white">Horizontal</span>
                    </label>
                    <label className="flex items-center gap-2">
                      <input
                        type="radio"
                        checked={orientation === 'vertical'}
                        onChange={() => setOrientation('vertical')}
                      />
                      <span className="text-white">Vertical</span>
                    </label>
                  </div>
                </div>
              </>
            )}

            {/* Location (optional) */}
            <div>
              <label className="block text-sm font-medium text-gray-300 mb-2">
                Location (optional)
              </label>
              <input
                type="text"
                value={location}
                onChange={(e) => setLocation(e.target.value)}
                placeholder="Stage Left"
                className="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white"
              />
            </div>

            {/* Brightness */}
            <div>
              <label className="block text-sm font-medium text-gray-300 mb-2">
                Brightness ({brightness})
              </label>
              <input
                type="range"
                min={0}
                max={255}
                value={brightness}
                onChange={(e) => setBrightness(parseInt(e.target.value))}
                className="w-full"
              />
            </div>

            {/* Reverse Direction */}
            <div>
              <label className="flex items-center gap-2">
                <input
                  type="checkbox"
                  checked={reverseDirection}
                  onChange={(e) => setReverseDirection(e.target.checked)}
                />
                <span className="text-white">Reverse Direction</span>
              </label>
            </div>
          </div>

          {/* Actions */}
          <div className="flex gap-3 mt-6">
            <button
              onClick={handleSave}
              disabled={!name || !ip || isSaving}
              className="btn-primary flex-1"
            >
              {isSaving ? 'Saving...' : editDevice ? 'Save Changes' : 'Add Device'}
            </button>
            <button onClick={onClose} className="btn-secondary">
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};
```

### Phase 3: Routing Status Display (1 hour)

**Routing Status Component:**
```tsx
// src/components/WLED/RoutingStatusDisplay.tsx
interface RoutingStatusDisplayProps {
  assignments: DeviceAssignment[];
}

const RoutingStatusDisplay: React.FC<RoutingStatusDisplayProps> = ({
  assignments,
}) => {
  if (assignments.length === 0) {
    return (
      <p className="text-gray-400 text-sm">
        No active modules. Open a module (Drum Machine, Guitar, etc.) to see routing.
      </p>
    );
  }

  return (
    <div className="space-y-4">
      <div className="text-sm text-gray-400">
        Showing routing for {assignments.length} device(s)
      </div>

      {assignments.map((assignment, index) => (
        <div
          key={assignment.device.id}
          className="bg-gray-900 rounded-lg border border-gray-700 p-4"
        >
          <div className="flex items-center justify-between mb-2">
            <h4 className="text-white font-semibold">{assignment.device.name}</h4>
            <span className="text-xs text-gray-500">
              {assignment.device.capabilities.dimensions === '1D'
                ? `${assignment.device.capabilities.ledCount} LEDs`
                : `${assignment.device.capabilities.gridConfig?.width}x${assignment.device.capabilities.gridConfig?.height}`}
            </span>
          </div>

          {/* Primary */}
          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <div className="w-2 h-2 bg-blue-500 rounded-full" />
              <span className="text-blue-400 font-medium">
                {assignment.primary.moduleId}
              </span>
              <span className="text-gray-500">‚Üí</span>
              <span className="text-gray-300">
                {assignment.primary.visualizationType}
              </span>
              <span className="text-xs text-gray-500 ml-auto">
                Score: {assignment.primary.compatibilityScore}
              </span>
            </div>

            {/* Overlays */}
            {assignment.overlays.map((overlay, i) => (
              <div key={i} className="flex items-center gap-2 ml-4">
                <div className="w-2 h-2 bg-purple-500 rounded-full" />
                <span className="text-purple-400 font-medium">
                  {overlay.moduleId}
                </span>
                <span className="text-gray-500">‚Üí</span>
                <span className="text-gray-300">{overlay.visualizationType}</span>
                <span className="text-xs text-gray-500 ml-auto">(overlay)</span>
              </div>
            ))}
          </div>
        </div>
      ))}
    </div>
  );
};
```

---

## Dependencies

### Prerequisites
- ‚úÖ **Story 18.0 Complete:** User Authentication (RequireAuth wrapper)
- ‚úÖ **Story 18.1 Complete:** WLED Device Registry (CRUD operations)
- ‚úÖ **Story 18.3 Complete:** Routing Matrix (routing assignments)
- ‚úÖ **Story 18.4 Complete:** Routing Rules (final assignments with rules applied)

### Blocks These Stories
- ‚è≥ **Story 18.6:** LEDCompositor Integration (users can configure devices before integration)
- ‚è≥ **Story 18.7:** Testing & Documentation (UI needed for comprehensive testing)

---

## Integration Points

- `src/components/WLED/WLEDManager.tsx` - NEW: Main component
- `src/components/WLED/DeviceList.tsx` - NEW: Device list display
- `src/components/WLED/AddDeviceModal.tsx` - NEW: Add/edit form
- `src/components/WLED/RoutingStatusDisplay.tsx` - NEW: Routing status
- `src/services/WLEDDeviceRegistry.ts` - Query/mutate devices
- `src/services/VisualizationRoutingMatrix.ts` - Query routing assignments
- `src/components/Auth/RequireAuth.tsx` - Authentication gating
- `src/App.tsx` - ADD: Route for `/wled-manager`

---

## Testing Strategy

### Manual Verification Steps

**Test 1: Device CRUD Operations**
1. Navigate to `/wled-manager`
2. Click "Add Device"
3. Fill form: Name="Test Grid", IP="192.168.1.100", Type=2D, Width=6, Height=25
4. Click "Test Connection" (verify WLED API call)
5. Click "Add Device"
6. Verify device appears in list
7. Click "Edit" ‚Üí Change name ‚Üí Save
8. Verify name updated in real-time
9. Click "Delete" ‚Üí Confirm
10. Verify device removed

**Test 2: Real-Time Sync (Multi-Device)**
1. Open `/wled-manager` on Desktop
2. Open `/wled-manager` on iPad (same user account)
3. Desktop: Add new device
4. iPad: Verify device appears within 200ms
5. iPad: Edit device brightness
6. Desktop: Verify brightness change reflected

**Test 3: Routing Status Display**
1. Add 2 devices (1 grid, 1 strip)
2. Open DrumMachine module
3. Navigate to `/wled-manager`
4. Verify routing status shows:
   - Grid: DrumMachine ‚Üí step-sequencer-grid
   - Strip: DrumMachine ‚Üí step-sequencer-1d
5. Enable AudioReactive
6. Verify both devices show audio-reactive overlay

**Test 4: Connection Testing**
1. Add device with valid IP (real WLED device)
2. Click "Test" ‚Üí Verify "‚úÖ Connected! X LEDs detected"
3. Edit device, change IP to invalid (e.g., 192.168.1.999)
4. Click "Test" ‚Üí Verify "‚ùå Connection failed"

**Test 5: Authentication Gating**
1. Sign out (anonymous mode)
2. Navigate to `/wled-manager`
3. Verify "Create account to save WLED devices" prompt
4. Sign in
5. Verify full WLED Manager interface accessible

**Test 6: Mobile Responsiveness**
1. Open `/wled-manager` on mobile browser (or DevTools responsive mode)
2. Verify:
   - Device cards stack vertically
   - Buttons are touch-friendly (44px)
   - Forms use mobile-appropriate inputs (number pads)
   - No horizontal scrolling

**Test 7: Empty State**
1. Delete all devices
2. Verify empty state shows: "No devices configured. Add your first WLED device."
3. Click "Add Device" from empty state
4. Verify form opens

---

## Risks and Mitigation

### Risk 1: Realtime Subscription Memory Leak
**Impact:** MEDIUM (performance degradation)
**Mitigation:**
- Proper cleanup in useEffect return
- Test: Navigate to/from /wled-manager 100 times, check memory
- Monitor Supabase channel subscriptions

### Risk 2: Form Validation Edge Cases
**Impact:** LOW (data corruption, poor UX)
**Mitigation:**
- Validate IP address format (IPv4 regex)
- Validate LED count > 0
- Validate grid width/height > 0
- Show inline error messages for invalid inputs

### Risk 3: Routing Status Desync
**Impact:** MEDIUM (confusing UI)
**Mitigation:**
- Subscribe to routing changes in component
- Force recalculation when component mounts
- Debounce routing updates (avoid UI thrashing)

### Risk 4: Mobile Form UX Issues
**Impact:** LOW (poor mobile experience)
**Mitigation:**
- Test on real mobile devices (iOS + Android)
- Use mobile-friendly input types (inputMode="numeric")
- Touch target size audit (44px minimum)

---

## Definition of Done

- [ ] WLEDManager component created with ViewTemplate layout
- [ ] Device list displays all user devices
- [ ] Add device form working (all fields, validation)
- [ ] Edit device form working (pre-populated, updates)
- [ ] Delete device working (confirmation modal)
- [ ] Test connection button working (HTTP API call)
- [ ] Routing status display showing assignments
- [ ] Real-time sync working (Supabase Realtime)
- [ ] Authentication gating working (RequireAuth wrapper)
- [ ] Mobile-responsive design verified
- [ ] Empty state implemented
- [ ] Error handling tested (network errors, validation)
- [ ] Performance verified (list renders <100ms)
- [ ] Route added to App.tsx (`/wled-manager`)
- [ ] Documentation updated (user guide for WLED Manager)

---

## Deliverables

1. **React Components**
   - `src/components/WLED/WLEDManager.tsx` (~150 lines)
   - `src/components/WLED/DeviceList.tsx` (~120 lines)
   - `src/components/WLED/DeviceCard.tsx` (~100 lines)
   - `src/components/WLED/AddDeviceModal.tsx` (~300 lines)
   - `src/components/WLED/RoutingStatusDisplay.tsx` (~80 lines)
   - `src/components/WLED/EmptyState.tsx` (~40 lines)

2. **Routing**
   - Modified: `src/App.tsx` (+10 lines, add /wled-manager route)

3. **Styles**
   - Modified: `src/index.css` (+20 lines, WLED-specific component classes)

4. **Documentation**
   - New: `docs/guides/wled-manager-user-guide.md` (user-facing documentation)

---

## Next Steps After Story 18.5

Once this story is complete, proceed to:
- **Story 18.6:** LEDCompositor Integration & Module Migration - 5-6 hours
  - Now unblocked: Users can configure devices via UI
  - Integrate routing matrix with LEDCompositor.submitFrame()
  - Migrate DrumMachine to new system

---

## References

- **Epic 18:** `docs/epics/epic-18-intelligent-wled-routing.md`
- **Story 18.1:** WLED Device Registry (backend)
- **Story 18.3:** Visualization Routing Matrix
- **Story 18.4:** Routing Rules Engine
- **ViewTemplate Guide:** `CLAUDE.md` (View Template Guidelines)

---

**Story Created:** 2025-10-18
**Story Owner:** Dev Agent
**Estimated Completion:** 4-5 hours after start

---

## Notes

### Design Decisions

**Why ViewTemplate Layout?**
- Consistent with project UX standards (CLAUDE.md)
- Mobile-responsive by default
- Reusable ViewCard components
- Automatic back button positioning

**Why Modal for Add/Edit Device?**
- Keeps user in context (don't navigate away)
- Can be triggered from empty state or header button
- Reduces page transitions (faster UX)
- Mobile-friendly (fullscreen on small screens)

**Why Inline Routing Status Display?**
- Users see immediate effect of module changes
- Transparent (shows why device is assigned)
- Educational (helps users understand routing logic)
- Debuggable (shows compatibility scores)

**Why Test Connection Button?**
- Pre-validates device before saving
- Auto-populates LED count (less manual entry)
- Provides feedback (firmware version, LED count)
- Improves setup success rate

### Future Enhancements

- Visual grid preview (show LED layout before saving)
- Device templates (save/load common configurations)
- Bulk import (CSV upload for multiple devices)
- Device health monitoring (ping devices periodically)
- Advanced routing preferences (lock device to specific module)
- Visualization preview (see what device will show)

---

## Dev Agent Record

*To be completed during implementation*
