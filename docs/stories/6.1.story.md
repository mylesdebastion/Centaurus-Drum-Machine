# Story 6.1: Multi-Client Shared Sessions

**Epic:** Multi-User Collaboration
**Status:** üìù Planning
**Priority:** High
**Complexity:** High
**Prerequisite:** Story 5.1 (WLED Direct Test) ‚úÖ

## Brief Description
Enable multiple users to join a shared session where each user controls their own WLED devices while sharing audio/MIDI/visualization data through a session server. Each musician owns their instrument's LED controllers (guitar, drums, keys) and receives collaborative visualization data.

---

## Story

**As a** musician jamming with others,
**I want** to join a session where we share audio and visualization data,
**so that** my WLED devices respond to both my playing and the group's combined performance, while maintaining independent control of my own hardware.

---

## Background / Context

### Current State
- ‚úÖ Direct WLED connection working (Story 5.1 `/wled-test`)
- ‚úÖ Each browser can control WLED via `ws://[device-ip]/ws`
- ‚úÖ Audio visualization working locally per device
- ‚ùå No multi-user session capability
- ‚ùå No audio/MIDI data sharing between users

### Target Architecture

```
        Session Server (Socket.io/WebRTC)
              ‚Üì         ‚Üì         ‚Üì
         User 1     User 2     User 3
       (Browser)  (Browser)  (Browser)
            ‚Üì          ‚Üì          ‚Üì
      WLED Guitar  WLED Drums  WLED Keys
```

**Key Principle:** Each user owns their WLED device(s). No multi-client-to-one-WLED needed (avoids the WLED single-client limitation identified in analysis).

### User Ownership Model
- **Guitarist:** Owns WLED strips on guitar neck/body
- **Drummer:** Owns WLED strips on drums/cymbals
- **Keyboardist:** Owns WLED matrices behind keyboard

Each user's browser:
1. Captures audio from their instrument
2. Connects to session server (shares data)
3. Receives other users' audio/MIDI data
4. Generates combined visualization
5. Sends LED data to THEIR OWN WLED device(s)

---

## Architecture Details

### Session Server

**Technology Stack:**
- **WebSocket**: Socket.io for state/control messages
- **WebRTC**: Peer-to-peer audio streaming (optional Phase 2)
- **Hosting**: Railway, Render, or Vercel + WebSocket service

**Core Responsibilities:**
- Session creation & management (6-digit room codes)
- User presence tracking
- MIDI/control message routing
- Audio stream coordination (WebRTC signaling)
- Shared state synchronization (tempo, time signature)

**Not Responsible For:**
- WLED device control (client-side only)
- LED data generation (client-side only)
- Audio mixing (client-side only)

### Client Architecture

```typescript
// Each user's browser instance
Client {
  // Local hardware
  audioInput: MediaStream           // User's microphone/line-in
  wledConnection: WebSocket         // Direct to user's WLED device(s)

  // Session connection
  sessionSocket: Socket             // To session server
  audioStreams: Map<userId, MediaStream>  // From other users

  // Shared state
  sessionState: {
    users: User[]                   // All users in session
    tempo: number                   // Synchronized tempo
    sharedMidiNotes: MIDINoteEvent[] // From all users
  }

  // Local rendering
  visualizationEngine: {
    mode: 'individual' | 'combined' | 'per-user-lanes'
    renderToWLED: (data: RGB[]) => void
  }
}
```

### Data Flow

**1. Local Audio Capture:**
```
User's Mic ‚Üí AudioContext ‚Üí FFT Analysis ‚Üí Frequency Data
                                         ‚Üí MIDI Note Detection
```

**2. Session Sharing:**
```
Client ‚Üí WebSocket ‚Üí Session Server ‚Üí Broadcast to Other Clients
       (MIDI notes, beat events, user state)
```

**3. Visualization Rendering:**
```
Local Audio + Other Users' MIDI ‚Üí Visualization Engine ‚Üí LED Array ‚Üí WLED (ws://)
```

**4. Three Visualization Modes:**
- **Individual:** Show only my audio on my WLED
- **Combined:** Merge everyone's audio, show on my WLED
- **Per-User Lanes:** Each user's audio in separate color lane on my WLED

---

## Acceptance Criteria

### AC 1: Session Management ‚úÖ
- [ ] User can create a session and receive a 6-digit room code
- [ ] Other users can join using the room code
- [ ] All users see each other in the user list with presence indicators
- [ ] Host can kick users (optional)
- [ ] Session persists for 1 hour of inactivity

### AC 2: WLED Device Configuration per User ‚úÖ
- [ ] Each user can configure their WLED device IP address
- [ ] Connection status shown (connected/disconnected)
- [ ] Each user's WLED operates independently
- [ ] No conflicts between users' WLED connections

### AC 3: Audio/MIDI Data Sharing ‚úÖ
- [ ] User's audio analysis generates MIDI note events
- [ ] MIDI events sent to session server (<50ms latency)
- [ ] Other users receive MIDI events in real-time
- [ ] Beat detection events shared across session

### AC 4: Collaborative Visualization ‚úÖ
- [ ] Each user can choose visualization mode:
  - Individual (local audio only)
  - Combined (merged audio from all users)
  - Per-User Lanes (color-coded per user)
- [ ] Each user's WLED shows their selected mode
- [ ] User colors assigned automatically (persistent in session)
- [ ] Smooth transitions between modes

### AC 5: State Synchronization ‚úÖ
- [ ] Tempo synchronized across all users
- [ ] Transport state (play/stop) synchronized
- [ ] Track patterns shared (drum sequences, etc.)
- [ ] Changes propagate within 100ms

### AC 6: Connection Resilience ‚úÖ
- [ ] Session reconnects automatically if connection drops
- [ ] WLED reconnects automatically if connection drops
- [ ] Audio continues locally during network issues
- [ ] User rejoins session after app reload

### AC 7: Unified WLED Device Management Component üéØ
**Goal:** Reusable, responsive WLED device manager for all experiments

- [ ] **Quick Setup Flow**
  - [ ] Add device with IP address in <3 clicks
  - [ ] Auto-connect on device enable (no separate "Connect" button)
  - [ ] Visual connection status (connected/disconnected/error)
  - [ ] Virtual LED preview updates immediately when connected

- [ ] **Grid Layout Support**
  - [ ] Multi-device grid display (proven pattern from /dj-visualizer)
  - [ ] Responsive grid (1 col mobile, 2-3 col tablet, 3-4 col desktop per Story 5.1)
  - [ ] Compact device cards with expand/collapse for advanced settings

- [ ] **Progressive Disclosure UX**
  - [ ] Essential controls visible: Enable toggle, IP address, connection status
  - [ ] Advanced settings collapsed: LED count, orientation, test patterns, solo/mute
  - [ ] Quick actions: Test pattern, delete device

- [ ] **Consistent Data Flow**
  - [ ] Virtual LED preview shows when data is being sent (not just connected)
  - [ ] Data flow indicator (idle ‚Üí receiving data ‚Üí sending to WLED)
  - [ ] FPS monitoring for performance debugging
  - [ ] Unified initialization: Start sending LED data immediately after connection

- [ ] **Reusability Requirements**
  - [ ] Component works in /jam, /dj-visualizer, /isometric, /session views
  - [ ] Configurable device types: strip (1D), matrix (2D), custom
  - [ ] Pluggable data sources: audio visualizer, drum machine, 3D sequencer
  - [ ] Story 5.1 compliant: Single instance with layout props, no remounting

- [ ] **Device Persistence**
  - [ ] Saved to localStorage per experiment
  - [ ] Auto-reconnect on page reload
  - [ ] Import/export device configurations

---

## Implementation Phases

### Phase 0: Unified WLED Device Manager (Foundation) üéØ
**Goal:** Ship working WLED component fast, iterate based on tester feedback

**Tasks (Simplified for Speed):**
- [ ] Create `src/components/WLED/` directory
- [ ] Build `WLEDDeviceManager.tsx` (~200 lines)
  - Device state management (useState)
  - WebSocket connections (useRef + Map)
  - localStorage load/save
  - Responsive grid UI
  - Add/remove device UI
- [ ] Build `WLEDDeviceCard.tsx` (~100 lines)
  - Connection status indicator
  - Quick actions (test pattern, delete)
  - Collapsible settings panel
- [ ] Build `WLEDVirtualPreview.tsx` (~80 lines)
  - Strip visualization (1D array of colored divs)
  - Matrix visualization (2D grid)
- [ ] Create `types.ts` (TypeScript interfaces)
- [ ] Integrate into `/wled-test` route

**Testing (Manual with Real Hardware):**
- [ ] Add 2+ WLED devices, verify grid layout works
- [ ] Test responsive behavior (mobile ‚Üí desktop, no remounting)
- [ ] Verify auto-connect on enable toggle
- [ ] Test LED data flow (visual confirmation on physical LEDs)
- [ ] Test on iOS Safari + Chrome Android

**Deliverable:** Working prototype testers can use (1-2 days)

**Checkpoint A:** User Testing Gate
- Can testers add their WLED devices easily?
- Does the grid layout work on mobile?
- Do LEDs respond to audio/visualization?
- Any crashes or major bugs?
- **APPROVAL FROM TESTERS** before broader rollout

---

### Phase 1: Session Infrastructure (MVP)
**Goal:** Get 2 users in a room sharing basic data

- [ ] Set up Socket.io session server
- [ ] Deploy to Railway/Render
- [ ] Create session creation/joining UI
- [ ] Implement user presence (online/offline)
- [ ] Basic MIDI event routing

**Deliverable:** 2 users can join same session and see each other's MIDI notes in console

**Checkpoint B:** Manual testing of session infrastructure
- Create session, verify room code generation
- Join session from second browser
- Verify user presence indicators
- Test MIDI event routing (check browser console)
- **APPROVAL REQUIRED** before proceeding to Phase 2

---

### Phase 2: WLED Integration with Unified Manager
**Goal:** Each user controls their own WLED from shared data

- [ ] Integrate `WLEDDeviceManager` into SessionManager component
- [ ] Replace per-user WLED config UI with unified component
- [ ] Implement "Combined" visualization mode
- [ ] Test with 2 users + 2 WLED devices

**Deliverable:** 2 users' WLED devices respond to combined session audio

**Checkpoint C:** Manual testing of multi-user WLED
- 2 users join session with 1 WLED device each
- Verify independent device control
- Test "Combined" visualization mode
- Confirm data flow indicators work in session context
- **APPROVAL REQUIRED** before proceeding to Phase 3

### Phase 3: Visualization Modes
**Goal:** Multiple ways to visualize collaborative performance

- [ ] Implement "Individual" mode (local audio only)
- [ ] Implement "Per-User Lanes" mode (color-coded)
- [ ] Add mode selector UI
- [ ] User color assignment and coordination

**Deliverable:** Each user can switch between 3 visualization modes

### Phase 4: Audio Streaming (Optional)
**Goal:** Share actual audio streams, not just MIDI

- [ ] WebRTC peer connections setup
- [ ] Audio stream capture and routing
- [ ] Per-user volume controls
- [ ] Audio mixing in browser

**Deliverable:** Users hear each other's audio through browser

### Phase 5: Advanced Features
- [ ] Session recording (save pattern + MIDI events)
- [ ] Session playback
- [ ] Private sessions (password protection)
- [ ] Session persistence (database)

---

## Technical Risks & Mitigations

### High Priority Risks

**R1: Network Latency**
- **Risk:** >100ms latency breaks musical timing
- **Mitigation:** Use WebSocket for critical timing (MIDI), display latency indicator
- **Fallback:** Local-only mode if latency >150ms

**R2: WLED Stability on Mobile**
- **Risk:** Direct WebSocket connections drop on mobile networks
- **Mitigation:** Auto-reconnect logic with exponential backoff
- **Fallback:** Show "reconnecting" indicator, continue local visualization

**R3: Session Server Scalability**
- **Risk:** Many concurrent sessions overload single server
- **Mitigation:** Start with 4-user limit per session, 10 concurrent sessions max
- **Fallback:** "Server full" message, scale horizontally later

### Medium Priority Risks

**R4: Audio Mixing Complexity**
- **Risk:** Browser audio mixing APIs limited/buggy
- **Mitigation:** Keep Phase 4 optional, focus on MIDI sharing first
- **Fallback:** Don't implement audio streaming, MIDI-only sufficient

**R5: Data Synchronization Conflicts**
- **Risk:** Race conditions on shared state (tempo, patterns)
- **Mitigation:** Host has authority for global settings
- **Fallback:** Last-write-wins with conflict indicator

**R6: Browser Compatibility**
- **Risk:** WebSocket/WebRTC support varies
- **Mitigation:** Test on iOS Safari, Chrome Android specifically
- **Fallback:** Show "browser not supported" message

---

## Dependencies

**Hard Dependencies:**
- ‚è≥ Story 5.1: Universal Mobile-Responsive Architecture (for responsive patterns, stateful component continuity)
- ‚úÖ WLED Direct Test proof of concept (ws://[ip]/ws connection working)
- ‚è≥ Socket.io server infrastructure
- ‚è≥ WebSocket hosting service

**Soft Dependencies:**
- Story 2.3: Live Audio Visualizer (reference for audio analysis)
- Story 4.1: Synthetic Frequency System (MIDI ‚Üí frequency conversion)
- Existing WLED implementations (LEDMatrixManager, LEDStripManager) for pattern reference

---

## Data Models

### Session
```typescript
interface Session {
  id: string;                    // UUID
  code: string;                  // 6-digit room code (e.g., "AB12CD")
  hostId: string;                // User ID of host
  users: SessionUser[];          // All users in session
  state: SessionState;           // Shared playback state
  createdAt: number;             // Unix timestamp
  lastActivity: number;          // For timeout cleanup
}

interface SessionState {
  tempo: number;                 // BPM
  timeSignature: string;         // e.g., "4/4"
  playing: boolean;              // Transport state
  currentStep: number;           // For sequencer sync (0-15)
  patterns?: DrumPattern[];      // Optional: shared drum patterns
}
```

### User
```typescript
interface SessionUser {
  id: string;                    // UUID
  name: string;                  // Display name
  color: string;                 // Hex color for visualization
  isHost: boolean;               // Host privileges
  connected: boolean;            // Online status
  wledDevices: WLEDDevice[];    // User's WLED controllers
  visualizationMode: 'individual' | 'combined' | 'lanes';
}

interface WLEDDevice {
  id: string;                    // Client-generated UUID
  ip: string;                    // e.g., "192.168.1.50"
  name: string;                  // User-assigned name (e.g., "Guitar Neck")
  ledCount: number;              // Number of LEDs
  connected: boolean;            // Connection status
}
```

### Events
```typescript
// WebSocket event types
interface SessionEvents {
  // Connection
  'session:join': { sessionCode: string; userName: string; };
  'session:leave': { userId: string; };
  'session:user-joined': { user: SessionUser; };
  'session:user-left': { userId: string; };

  // State
  'session:state-update': { state: Partial<SessionState>; };
  'session:state-changed': { state: SessionState; };

  // MIDI/Audio
  'midi:note': { userId: string; note: MIDINoteEvent; };
  'audio:beat': { userId: string; beat: BeatEvent; };

  // WLED (client-side only, not sent to server)
  'wled:connected': { deviceId: string; };
  'wled:disconnected': { deviceId: string; };
}

interface MIDINoteEvent {
  note: number;         // MIDI note number (0-127)
  velocity: number;     // 0.0-1.0
  timestamp: number;    // Unix timestamp
  duration?: number;    // Optional duration in ms
}

interface BeatEvent {
  strength: number;     // 0.0-1.0
  timestamp: number;
  bpm?: number;         // Detected BPM
}
```

---

## WLED Device Management Architecture

### Unified Component Design

**Component Name:** `WLEDDeviceManager`

**Purpose:** Reusable WLED device management component for all experiments, providing consistent UX for adding, configuring, and monitoring WLED devices with responsive grid layouts.

### Component API (Simplified for MVP)

```typescript
interface WLEDDeviceManagerProps {
  // Data (props-down pattern)
  ledData?: string[];                    // Hex color array ['FF0000', '00FF00', ...] from parent

  // Layout (Story 5.1 pattern)
  layout?: 'mobile' | 'desktop';         // Controls responsive grid layout

  // Persistence (required)
  storageKey: string;                    // localStorage key (e.g., "wled-jam", "wled-dj-visualizer")

  // Optional configuration
  deviceType?: 'strip' | 'matrix' | 'auto';  // Default: 'auto'
  maxDevices?: number;                       // Limit number of devices (default: 10)
  showVirtualPreview?: boolean;              // Default: true
  compactMode?: boolean;                     // Minimal UI for embedded use
}

// Usage Example (Simple!)
const ledColors = visualizationEngine.render(audioData);

<WLEDDeviceManager
  ledData={ledColors}
  layout={isMobile ? 'mobile' : 'desktop'}
  storageKey="wled-jam"
  deviceType="strip"
/>

// Component internally:
// - Manages device list state
// - Maintains WebSocket connections to each enabled device
// - Sends ledData to all enabled devices when it changes
// - Persists device configs to localStorage
```

### Enhanced Data Models

```typescript
interface WLEDDevice {
  // Identification
  id: string;                              // Client-generated UUID
  name: string;                            // User-assigned (e.g., "Guitar Neck", "Drums Left")

  // Connection
  ip: string;                              // e.g., "192.168.1.50"
  port?: number;                           // Default: 80
  connectionStatus: 'idle' | 'connecting' | 'connected' | 'error' | 'disconnected';
  lastError?: string;                      // Error message if status === 'error'
  autoReconnect: boolean;                  // Default: true

  // Hardware configuration
  deviceType: 'strip' | 'matrix';
  ledCount: number;                        // Total LEDs
  matrixConfig?: {                         // If deviceType === 'matrix'
    width: number;
    height: number;
    serpentine: boolean;
    orientation: 'horizontal' | 'vertical';
  };

  // State
  enabled: boolean;                        // User toggle (controls auto-connect)
  dataFlowStatus: 'idle' | 'receiving' | 'sending';  // Visual indicator
  lastDataSent?: number;                   // Timestamp for stale connection detection
  fps: number;                             // Current FPS for monitoring

  // Visualization settings
  brightness: number;                      // 0-255
  reverseDirection: boolean;               // Flip LED order
  testPattern?: 'rainbow' | 'solid' | 'off';  // For testing connection

  // Optional features (experiment-specific)
  laneAssignment?: number[];               // For multi-lane visualizers
  solo: boolean;                           // Mute other devices
  mute: boolean;                           // Silence this device
}
```

### Architecture Patterns

**1. Single Instance Pattern (Story 5.1 Compliance)**

```typescript
// ‚úÖ GOOD - Single instance with layout prop
<WLEDDeviceManager
  layout={isMobile ? 'mobile' : 'desktop'}
  onDataUpdate={handleLEDDataUpdate}
  storageKey="jam-session-devices"
  deviceType="strip"
/>

// ‚ùå BAD - Conditional rendering causes remounting
{isMobile && <WLEDDeviceManager ... />}
{!isMobile && <WLEDDeviceManager ... />}
```

**2. Data Flow Integration (Simplified)**

```typescript
// Parent component (e.g., LiveAudioVisualizer, DrumMachine)
const ParentComponent = () => {
  // Visualization engine generates LED data from audio
  const ledColors = useMemo(() => {
    return visualizationEngine.render(audioData);
  }, [audioData]);

  // Simple props-down pattern - component handles the rest
  return (
    <WLEDDeviceManager
      ledData={ledColors}
      layout={isMobile ? 'mobile' : 'desktop'}
      storageKey="wled-parent"
    />
  );
};

// Internally, WLEDDeviceManager:
// 1. Maintains device list state + WebSocket connections (via useRef)
// 2. When ledData prop changes, sends to all enabled devices
// 3. Updates dataFlowStatus and FPS metrics
// 4. All logic in one component (~200 lines)
```

**3. Responsive Grid Layout**

```typescript
// Grid CSS (adapts to breakpoints)
<div className={cn(
  "grid gap-4",
  layout === 'mobile' ? "grid-cols-1" :
  "grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"
)}>
  {devices.map(device => (
    <WLEDDeviceCard key={device.id} device={device} />
  ))}
</div>
```

### Component Structure (Minimal MVP)

```
src/components/WLED/
‚îú‚îÄ‚îÄ WLEDDeviceManager.tsx          # Main component (~200 lines)
‚îÇ                                  # - Device state management
‚îÇ                                  # - WebSocket connections (useRef)
‚îÇ                                  # - localStorage persistence
‚îÇ                                  # - Responsive grid layout
‚îÇ                                  # - Device add/remove UI
‚îú‚îÄ‚îÄ WLEDDeviceCard.tsx             # Individual device card (~100 lines)
‚îÇ                                  # - Connection status display
‚îÇ                                  # - Quick actions (test, delete)
‚îÇ                                  # - Expandable settings panel
‚îú‚îÄ‚îÄ WLEDVirtualPreview.tsx         # LED visualization (~80 lines)
‚îÇ                                  # - Strip/matrix visual display
‚îÇ                                  # - Real-time color updates
‚îî‚îÄ‚îÄ types.ts                       # TypeScript interfaces

Total: ~400 lines across 4 files

Integration targets (Phase 0+):
‚îú‚îÄ‚îÄ src/components/JamSession/JamSession.tsx         # Add WLEDDeviceManager
‚îú‚îÄ‚îÄ src/components/LiveAudioVisualizer/              # Replace LEDMatrixManager
‚îú‚îÄ‚îÄ src/components/IsometricSequencer/               # Add WLED support
‚îî‚îÄ‚îÄ src/components/Session/SessionManager.tsx        # Multi-user WLED

Note: No separate service layer or context for MVP.
      Add only if complexity grows beyond ~200 lines.
```

### UX Flow

**Initial Setup (First-Time User):**
```
1. Component renders with "No devices added" empty state
2. User clicks [+ Add WLED Device] button
3. Modal appears:
   - Device Name: [______] (placeholder: "My LED Strip")
   - IP Address: [______] (placeholder: "192.168.1.50")
   - Device Type: [Auto-detect ‚ñæ] (dropdown: Strip / Matrix / Auto)
   - [Cancel] [Add Device]
4. User enters IP, clicks "Add Device"
5. Device card appears in grid with "Connecting..." status
6. Auto-connect attempts WebSocket connection
7. On success:
   - Status ‚Üí "Connected" (green indicator)
   - Virtual preview shows LEDs
   - Data flow starts immediately
```

**Quick Actions on Device Card:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Guitar Neck         üü¢ Connected‚îÇ  ‚Üê Name + Status
‚îÇ 192.168.1.50                    ‚îÇ  ‚Üê IP Address
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ [Virtual LED Preview Strip]     ‚îÇ  ‚Üê Visual feedback
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ [‚ñ∂ Test] [‚öô Settings] [üóë Del] ‚îÇ  ‚Üê Quick actions
‚îÇ Data: 60 FPS                    ‚îÇ  ‚Üê Performance metric
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Expanded Settings Panel:
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ LED Count: [60]                 ‚îÇ
‚îÇ Brightness: [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë] 80%    ‚îÇ
‚îÇ ‚òë Auto-reconnect                ‚îÇ
‚îÇ ‚òë Reverse direction             ‚îÇ
‚îÇ Test Pattern: [Rainbow ‚ñæ]       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Data Flow Indicators:**
- **Idle** (gray): Device connected, no data being sent
- **Receiving** (blue pulse): Component receiving data from parent
- **Sending** (green pulse): Data actively being sent to WLED
- **Error** (red): Connection lost or failed

### Integration with Story 5.1 Responsive Patterns

**Mobile Layout:**
- Single column grid
- Device cards stack vertically
- Virtual preview scaled down
- Advanced settings behind expand/collapse
- Floating [+ Add Device] button

**Desktop Layout:**
- 2-4 column responsive grid
- Larger virtual previews
- Settings inline (optional collapse)
- [+ Add Device] button in grid

**Stateful Continuity:**
- Component never remounts on breakpoint change
- WebSocket connections persist across resize/rotation
- Visual layout adapts via CSS grid and layout prop
- Data flow continues uninterrupted

---

## UI Mockups

### Session Creation Flow
```
Welcome Screen
    ‚Üì (Click "Create Jam Room")
Session Creation Modal
  - Enter your name: [______]
  - [Create Session]
    ‚Üì
Session View
  Room Code: AB12CD
  Users: You (Host)
  Status: Waiting for others...
```

### Session View Layout (Desktop)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Room: AB12CD    Users: 3    [Leave]    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ Users       ‚îÇ ‚îÇ Main View           ‚îÇ ‚îÇ
‚îÇ ‚îÇ             ‚îÇ ‚îÇ                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ You (Host)  ‚îÇ ‚îÇ [Drum Machine/      ‚îÇ ‚îÇ
‚îÇ ‚îÇ Alex        ‚îÇ ‚îÇ  Visualizer/        ‚îÇ ‚îÇ
‚îÇ ‚îÇ Sam         ‚îÇ ‚îÇ  3D Sequencer]      ‚îÇ ‚îÇ
‚îÇ ‚îÇ             ‚îÇ ‚îÇ                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ [+ Invite]  ‚îÇ ‚îÇ                     ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ Your WLED Devices                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ Guitar Neck: 192.168.1.50 ‚úÖ       ‚îÇ ‚îÇ
‚îÇ ‚îÇ Viz Mode: [Combined ‚ñæ]             ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Success Metrics

- [ ] 2+ users can join a session simultaneously
- [ ] Each user successfully controls their own WLED device
- [ ] MIDI data shared with <100ms latency
- [ ] Session remains stable for 30+ minutes
- [ ] Connection recovery works within 5 seconds
- [ ] Works on desktop and mobile browsers

---

## Open Questions

**Q1:** Should we implement audio streaming (Phase 4) or is MIDI sharing sufficient?
- **Answer:** Start with MIDI only (sufficient for visualization), defer audio

**Q2:** How many users per session should we support?
- **Answer:** 2-4 users initially, test performance before scaling

**Q3:** Should sessions persist after all users leave?
- **Answer:** No for MVP, add persistence in Phase 5 if needed

**Q4:** Do we need authentication/user accounts?
- **Answer:** No - anonymous with display names (like Gather.town)

**Q5:** What happens if host leaves?
- **Answer:** Transfer host to next user, or close session (TBD in implementation)

---

## Testing Strategy

### Unit Tests
- Session server: room creation, user join/leave
- Event routing logic
- State synchronization

### Integration Tests
- 2 users join same session
- MIDI events route correctly
- WLED connections independent
- State updates propagate

### Manual Tests
- 2 users, same Wi-Fi, 2 WLED devices
- 2 users, different networks (via deployed server)
- Session reconnection after browser refresh
- WLED reconnection after network interruption
- Mobile Safari + Desktop Chrome compatibility

---

## File Locations

### New Files (Phase 0: Unified WLED Component - Simplified)
- `src/components/WLED/WLEDDeviceManager.tsx` - Main component (~200 lines, all-in-one)
- `src/components/WLED/WLEDDeviceCard.tsx` - Device card UI (~100 lines)
- `src/components/WLED/WLEDVirtualPreview.tsx` - LED visualization (~80 lines)
- `src/components/WLED/types.ts` - TypeScript interfaces

Total: 4 files, ~400 lines

### New Files (Phase 1: Session Infrastructure)
- `src/services/SessionClient.ts` - Session WebSocket client
- `src/components/Session/SessionManager.tsx` - Main session UI
- `src/components/Session/SessionLobby.tsx` - Join/create UI
- `src/components/Session/UserList.tsx` - Connected users display
- `src/hooks/useSession.ts` - Session state hook
- `server/` - New directory for session server
- `server/src/index.ts` - Socket.io server entry
- `server/src/SessionManager.ts` - Server-side session logic

### Modified Files
- `src/App.tsx` - Add `/session/:code` route
- `src/components/Welcome/WelcomeScreen.tsx` - Add "Create/Join Session" buttons
- `src/components/WLEDExperiment/WLEDDirectTest.tsx` - Integrate WLEDDeviceManager (Phase 0 testing)
- `src/components/LiveAudioVisualizer/LiveAudioVisualizer.tsx` - Replace LEDMatrixManager with WLEDDeviceManager
- `src/components/JamSession/JamSession.tsx` - Add WLEDDeviceManager integration
- `src/components/IsometricSequencer/IsometricSequencer.tsx` - Add WLEDDeviceManager support
- `src/types/index.ts` - Add session types

### Deprecated/Replaced Files (Post Phase 0)
- `src/components/LiveAudioVisualizer/LEDMatrixManager.tsx` - Replace with WLEDDeviceManager
- `src/components/LEDStripManager/LEDStripManager.tsx` - Migrate to WLEDDeviceManager pattern

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-09 | 1.0 | Initial story creation for multi-client shared sessions | Claude Code |
| 2025-10-09 | 2.0 | Added AC 7 (Unified WLED Device Manager), Phase 0, comprehensive WLED architecture, Story 5.1 integration | PM Agent (John) |
| 2025-10-09 | 2.1 | Simplified architecture for fast prototyping: props-down data flow, all-in-one component (~400 lines), no service layer for MVP | Architect (Winston) |

---

## Migration Strategy (Existing WLED Implementations)

### Phase 0 Deliverable Benefits

After Phase 0 completion, the following existing components can be migrated to use `WLEDDeviceManager`:

**1. `/dj-visualizer` (LiveAudioVisualizer)**
- **Current:** Uses `LEDMatrixManager.tsx` (422 lines)
- **Migration:** Replace with `WLEDDeviceManager`
- **Benefit:** Consistent UX, grid layout, responsive behavior, data flow indicators
- **Effort:** Low (API designed for drop-in replacement)

**2. Education Mode (LEDStripManager)**
- **Current:** Uses custom `LEDStripManager.tsx` (928 lines) with multi-lane support
- **Migration:** Migrate to `WLEDDeviceManager` with `laneAssignment` feature
- **Benefit:** Reduced code duplication, consistent device management
- **Effort:** Medium (need to preserve lane assignment logic)

**3. `/wled-test` (WLEDDirectTest)**
- **Current:** Proof of concept with basic device testing
- **Migration:** First integration target for Phase 0 testing
- **Benefit:** Validation of unified component before broader rollout
- **Effort:** Low (already planned in Phase 0)

**4. `/jam` (JamSession) and `/isometric` (IsometricSequencer)**
- **Current:** No WLED integration
- **Migration:** Add `WLEDDeviceManager` component
- **Benefit:** Consistent WLED support across all experiments
- **Effort:** Low (greenfield integration)

### Technical Considerations for Migration

**Preserving Existing Features:**
- **Lane Assignment:** Maintained via `laneAssignment?: number[]` in `WLEDDevice` interface
- **Multi-Notes Mode:** Supported through `laneAssignment` array (multiple lanes per device)
- **Solo/Mute:** Preserved in `WLEDDevice` interface (`solo`, `mute` properties)
- **Test Patterns:** Supported via `testPattern` property (rainbow, solid, off)
- **Matrix Support:** Full 2D matrix support via `matrixConfig` (width, height, serpentine, orientation)

**Breaking Changes (Minimal):**
- Component API changes from props-based to callback-based (`onDataUpdate`)
- Device storage keys changed (localStorage migration helper needed)
- Connection status enum updated (more granular states)

**Migration Helper Utilities:**
```typescript
// Provided in Phase 0
export function migrateLEDMatrixConfig(oldConfig: OldLEDMatrixConfig): WLEDDevice;
export function migrateLEDStripConfig(oldConfig: OldLEDStripConfig): WLEDDevice;
export function migrateLocalStorage(oldKey: string, newKey: string): void;
```

---

## Summary of Changes

### v2.0 (PM Planning Phase)
**Key Additions:**
1. **AC 7: Unified WLED Device Management Component** - Comprehensive acceptance criteria for reusable WLED component with quick setup, grid layouts, progressive disclosure UX, and Story 5.1 compliance
2. **WLED Device Management Architecture Section** - Complete component specifications with enhanced data models
3. **Phase 0: Unified WLED Device Manager** - New foundation phase with testing checklist
4. **Migration Strategy Section** - Roadmap for migrating existing WLED implementations
5. **Updated Dependencies** - Added Story 5.1 as hard dependency for responsive patterns

**Impact:**
- Story 6.1 now addresses both multi-client sessions AND foundational WLED device management
- Phase 0 must complete before Phase 1 (session infrastructure)
- All future experiments will use unified WLED component
- Consistent UX across /jam, /dj-visualizer, /isometric, /wled-test, /session

---

### v2.1 (Architecture Simplification for Rapid Prototyping)
**Philosophy:** Ship fast, iterate based on tester feedback, add complexity only when needed.

**Architectural Changes:**
1. **Simplified Data Flow** - Props-down pattern instead of callback pattern
   ```typescript
   // Before (v2.0): Inverted callback
   onDataUpdate={(deviceId, data) => return ledData}

   // After (v2.1): Simple props
   ledData={ledColors}
   ```

2. **All-in-One Component** - Consolidated architecture for speed
   - Before: 6 separate files (service layer, hooks, utilities)
   - After: 4 files (~400 lines total)
   - WebSocket logic stays in component (useRef pattern)
   - No separate service layer for MVP

3. **Minimal File Structure**
   ```
   src/components/WLED/
   ‚îú‚îÄ‚îÄ WLEDDeviceManager.tsx    (~200 lines - state, WebSocket, UI)
   ‚îú‚îÄ‚îÄ WLEDDeviceCard.tsx       (~100 lines - device card)
   ‚îú‚îÄ‚îÄ WLEDVirtualPreview.tsx   (~80 lines - visualization)
   ‚îî‚îÄ‚îÄ types.ts                 (interfaces)
   ```

4. **Simplified Phase 0 Tasks**
   - Removed: Service layer creation, migration helpers, unit tests
   - Added: Focus on manual testing with real hardware
   - Goal: Working prototype in 1-2 days instead of 1-2 weeks

**When to Add Complexity (Future):**
- **Context API:** Only if 3+ components need device state
- **Service Layer:** Only if WebSocket logic exceeds 100 lines
- **Migration Helpers:** Only after Phase 0 validates design
- **Unit Tests:** After prototype validates with testers

**Rationale:** Not an enterprise app - prioritize shipping fast, onboarding testers, iterating based on real usage.

---

## Next Steps (v2.1 - Simplified)

### Immediate: Phase 0 MVP (1-2 days)
1. **Create files** - `WLEDDeviceManager.tsx`, `WLEDDeviceCard.tsx`, `WLEDVirtualPreview.tsx`, `types.ts`
2. **Implement core logic** - Device state, WebSocket connections, localStorage
3. **Build UI** - Responsive grid, add/remove devices, connection status
4. **Integrate** - Add to `/wled-test` route with props: `ledData={colors}`
5. **Test with real hardware** - 2+ WLED devices, mobile + desktop

**Deliverable:** Testers can add WLED devices and see their LEDs respond to audio

### Checkpoint A: User Validation
- ‚úÖ Can testers use it?
- ‚úÖ Does it work on mobile?
- ‚úÖ Any showstopper bugs?
- **IF YES ‚Üí Proceed to broader integration**
- **IF NO ‚Üí Iterate quickly based on feedback**

### Follow-up: Broader Integration (Phase 0.5)
- Integrate into `/dj-visualizer` (replace LEDMatrixManager)
- Integrate into `/jam` (add WLED support)
- Gather more tester feedback
- Refine based on real usage

### Later: Session Infrastructure (Phase 1)
- Only after Phase 0 is validated and stable
- Set up Socket.io session server
- Build session UI
- Multi-user WLED testing

**Philosophy:** Don't build Phase 1 until Phase 0 proves valuable to users.
