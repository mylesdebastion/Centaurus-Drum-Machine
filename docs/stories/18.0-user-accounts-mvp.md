# Story 18.0: Low-Friction User Authentication (Supabase Auth)

**Epic:** Epic 18 - Intelligent WLED Visualization Routing
**Status:** üìù PLANNING
**Priority:** üî¥ HIGH (BLOCKS Story 18.1)
**Complexity:** Medium
**Time Estimate:** 4-6 hours
**Prerequisites:** Story 7.1 (Supabase Setup)

---

## User Story

As a **user exploring advanced features**,
I want **optional user accounts with seamless anonymous-to-authenticated upgrade**,
So that **I can access persistent features (WLED registry, presets, hardware access) without friction for basic use**.

---

## Story Context

### Why This Story

**Blocker for Epic 18:** Story 18.1 (WLED Device Registry) requires persistent storage with Row Level Security (RLS), which depends on Supabase authentication:

```sql
-- Story 18.1 requires user authentication
CREATE TABLE wled_devices (
  user_id UUID REFERENCES auth.users NOT NULL,  -- Requires auth
  ...
);

CREATE POLICY "Users can view own devices"
  ON wled_devices FOR SELECT
  USING (auth.uid() = user_id);  -- Requires auth.uid()
```

**Current State:**
- ‚úÖ Users provide display name via `UsernameModal` (localStorage only)
- ‚úÖ Completely anonymous - no persistent identity
- ‚ùå No Supabase Auth configured
- ‚ùå No RLS policies (database wide open)

**Desired State (Low-Friction MVP):**
- ‚úÖ Basic features work **without accounts** (`/jam`, `/studio`, drum machine)
- ‚úÖ Advanced features prompt for **optional account creation** (WLED registry, presets, APC40)
- ‚úÖ Seamless upgrade path (anonymous ‚Üí authenticated)
- ‚úÖ Preserve localStorage username when creating account

### UX Philosophy: "Invisible Until Needed"

**Core Principle:** "No account needed. Just open the app and start playing." (WelcomeScreen.tsx:67)

**Design Approach:**
- **Zero Friction by Default:** Auth UI completely invisible on initial load
- **Value-First Gating:** Auth only appears when user tries to save persistent data
- **Blurred Preview:** Show what's behind the gate before asking for account
- **Magic Link Primary:** Passwordless auth (like Slack) as default flow
- **Pattern Consistency:** Match existing `UsernameModal.tsx` pattern exactly

---

## Acceptance Criteria

### Functional Requirements

1. **Supabase Auth Configuration**
   - Supabase Auth enabled in dashboard (Authentication ‚Üí Providers)
   - Email/Password provider enabled
   - Magic Link provider enabled (passwordless option)
   - Email templates configured (confirmation, password reset)

2. **Authentication UI Components**
   - `AuthModal` component created matching `UsernameModal.tsx` pattern:
     - Magic Link tab (primary, default)
     - Email/Password tab (secondary, optional)
     - Password reset flow
     - Same backdrop + card structure as existing modals
     - Uses existing `.btn-primary`, `.btn-secondary` classes
   - Minimal header integration:
     - Small conditional "Sign In" button (only when needed)
     - NO dropdown menus, NO avatar components
   - `RequireAuth` wrapper with blurred preview pattern
   - Feature gate prompts only when accessing persistent features

3. **User Profile System**
   - `user_profiles` table created in Supabase:
     ```sql
     CREATE TABLE user_profiles (
       id UUID REFERENCES auth.users PRIMARY KEY,
       username TEXT NOT NULL,
       created_at TIMESTAMPTZ DEFAULT NOW(),
       updated_at TIMESTAMPTZ DEFAULT NOW()
     );
     ```
   - RLS policies enforced (users can only view/edit own profile)
   - Automatic profile creation on sign up (database trigger)

4. **Hybrid Anonymous + Authenticated System**
   - `useAuth` hook created:
     ```typescript
     function useAuth() {
       const [user, setUser] = useState<User | null>(null);
       const [isAnonymous, setIsAnonymous] = useState(true);

       // Returns: { user, isAnonymous, signIn, signUp, signOut }
     }
     ```
   - Feature gating utility:
     ```typescript
     function requiresAuth(feature: 'wled-registry' | 'presets' | 'apc40'): boolean
     ```
   - Anonymous users can still use basic features

5. **Username Migration**
   - When anonymous user creates account:
     - Read username from `localStorage.getItem('jam-username')`
     - Populate `user_profiles.username` with localStorage value
     - Preserve user's existing identity

6. **Session Persistence**
   - Auth session persists across browser tabs
   - Auto-refresh token before expiry
   - "Remember me" functionality (session stored in localStorage)

7. **RLS Policy Foundation**
   - Enable RLS on `user_profiles` table
   - Create helper SQL function:
     ```sql
     CREATE FUNCTION is_authenticated() RETURNS BOOLEAN AS $$
       SELECT auth.uid() IS NOT NULL;
     $$ LANGUAGE SQL STABLE;
     ```
   - Prepare RLS policy templates for future tables

### Integration Requirements

8. **GlobalMusicContext Integration**
   - Add auth state to `GlobalMusicContext`:
     ```typescript
     interface GlobalMusicState {
       // ... existing fields
       user: User | null;
       isAuthenticated: boolean;
     }
     ```
   - Sync auth state across all components

9. **JamSession Compatibility**
   - Jam sessions work for **both** anonymous and authenticated users
   - Authenticated users: Username from `user_profiles.username`
   - Anonymous users: Username from `localStorage` (existing behavior)
   - No breaking changes to existing jam session functionality

10. **Feature Gate UI Patterns**
    - Show "Upgrade Required" modal when accessing gated features:
      - WLED Device Registry (Story 18.1)
      - Presets Library (future)
      - APC40 Hardware Access (Epic 3)
    - Modal includes:
      - Feature description ("Save your WLED devices across sessions")
      - "Create Free Account" button
      - "Already have an account? Sign In" link

### Quality Requirements

11. **Security**
    - Passwords never stored in plaintext (Supabase handles)
    - Email confirmation required for sign up
    - Password reset via secure token
    - RLS policies tested (users can't access other users' data)

12. **Error Handling**
    - User-friendly error messages:
      - Email already exists
      - Invalid credentials
      - Network errors
      - Session expired
    - Graceful fallback to anonymous mode if auth fails

13. **Performance**
    - Auth check adds <100ms to initial page load
    - No blocking UI while checking auth state
    - Show loading spinner during sign in/sign up

---

## Technical Approach

### Phase 1: Supabase Auth Configuration (1 hour)

**Enable Supabase Auth:**
1. Dashboard ‚Üí Authentication ‚Üí Providers
2. Enable Email/Password provider
3. Enable Magic Link provider
4. Configure email templates (confirmation, password reset)
5. Set redirect URLs:
   - Development: `http://localhost:5173/auth/callback`
   - Production: `https://jam.audiolux.app/auth/callback`

**Create User Profiles Table:**
```sql
-- Migration: create_user_profiles.sql
CREATE TABLE user_profiles (
  id UUID REFERENCES auth.users PRIMARY KEY,
  username TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS Policies
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own profile"
  ON user_profiles FOR SELECT
  USING (auth.uid() = id);

CREATE POLICY "Users can update own profile"
  ON user_profiles FOR UPDATE
  USING (auth.uid() = id);

-- Auto-create profile on sign up
CREATE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.user_profiles (id, username)
  VALUES (NEW.id, NEW.email); -- Default to email, user can change
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();
```

### Phase 2: Auth Hooks and Context (2 hours)

**Create useAuth Hook:**
```typescript
// src/hooks/useAuth.ts
import { useEffect, useState } from 'react';
import { User } from '@supabase/supabase-js';
import { supabase } from '@/lib/supabase';

export function useAuth() {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Check active session
    supabase.auth.getSession().then(({ data: { session } }) => {
      setUser(session?.user ?? null);
      setLoading(false);
    });

    // Listen for auth changes
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      (_event, session) => {
        setUser(session?.user ?? null);
      }
    );

    return () => subscription.unsubscribe();
  }, []);

  const signIn = async (email: string, password: string) => {
    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });
    return { data, error };
  };

  const signUp = async (email: string, password: string, username: string) => {
    // Create auth user
    const { data, error } = await supabase.auth.signUp({
      email,
      password,
    });

    if (error) return { data, error };

    // Update profile with username
    if (data.user) {
      await supabase
        .from('user_profiles')
        .update({ username })
        .eq('id', data.user.id);
    }

    return { data, error };
  };

  const signInWithMagicLink = async (email: string) => {
    const { data, error } = await supabase.auth.signInWithOtp({
      email,
      options: {
        emailRedirectTo: `${window.location.origin}/auth/callback`,
      },
    });
    return { data, error };
  };

  const signOut = async () => {
    const { error } = await supabase.auth.signOut();
    return { error };
  };

  return {
    user,
    isAuthenticated: !!user,
    isAnonymous: !user,
    loading,
    signIn,
    signUp,
    signInWithMagicLink,
    signOut,
  };
}
```

**Extend GlobalMusicContext:**
```typescript
// src/contexts/GlobalMusicContext.tsx
import { useAuth } from '@/hooks/useAuth';

export interface GlobalMusicState {
  // ... existing fields
  user: User | null;
  isAuthenticated: boolean;
}

export const GlobalMusicProvider: React.FC<GlobalMusicProviderProps> = ({ children }) => {
  const auth = useAuth();

  // ... existing code

  const contextValue = useMemo<GlobalMusicContextValue>(
    () => ({
      ...state,
      user: auth.user,
      isAuthenticated: auth.isAuthenticated,
      // ... existing fields
    }),
    [state, auth.user, auth.isAuthenticated]
  );

  // ...
};
```

### Phase 3: Auth UI Components (2 hours)

**IMPORTANT: Pattern Reference**

All auth UI components MUST match the existing modal pattern from `UsernameModal.tsx`. **Do not invent new patterns.**

**Existing Modal Pattern (Template to Follow):**

```typescript
// Reference: src/components/JamSession/UsernameModal.tsx
// This is the EXACT pattern to follow for AuthModal

// Backdrop (fixed, full-screen, blurred)
<div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-40" />

// Modal Container (fixed, centered)
<div className="fixed inset-0 flex items-center justify-center z-50 p-4">
  {/* Modal Card */}
  <div className="bg-gray-800 rounded-lg border border-gray-700 shadow-2xl max-w-md w-full p-6">

    {/* Icon + Header */}
    <div className="flex items-center gap-3 mb-4">
      <div className="w-10 h-10 rounded-full bg-primary-600/20 flex items-center justify-center">
        <User className="w-5 h-5 text-primary-400" />
      </div>
      <div>
        <h2 className="text-xl font-semibold text-white">What's your name?</h2>
        <p className="text-sm text-gray-400">Others will see this in the session</p>
      </div>
    </div>

    {/* Input */}
    <input
      className="w-full px-4 py-3 bg-gray-900 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
      placeholder="Enter your name"
    />

    {/* Buttons */}
    <div className="flex gap-3 mt-4">
      <button className="flex-1 btn-secondary">Cancel</button>
      <button className="flex-1 btn-primary">Continue</button>
    </div>
  </div>
</div>
```

**Existing Button Classes (from `src/index.css`):**

```css
.btn-primary {
  @apply bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200;
}

.btn-secondary {
  @apply bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200;
}
```

**Create AuthModal Component (Following Exact Pattern):**

```typescript
// src/components/Auth/AuthModal.tsx
import { useState } from 'react';
import { Mail, Lock, ArrowRight } from 'lucide-react';
import { useAuth } from '@/hooks/useAuth';

type AuthMode = 'magic-link' | 'email-password';

export const AuthModal: React.FC<{
  isOpen: boolean;
  onClose: () => void;
  feature?: string; // e.g., "Save WLED Devices"
}> = ({ isOpen, onClose, feature }) => {
  const [mode, setMode] = useState<AuthMode>('magic-link'); // Magic Link is PRIMARY
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [username, setUsername] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const [magicLinkSent, setMagicLinkSent] = useState(false);

  const { signIn, signUp, signInWithMagicLink } = useAuth();

  const handleMagicLink = async () => {
    setLoading(true);
    setError('');
    const { error } = await signInWithMagicLink(email);
    if (error) {
      setError(error.message);
    } else {
      setMagicLinkSent(true);
    }
    setLoading(false);
  };

  const handleSignUp = async () => {
    setLoading(true);
    setError('');

    // Migrate localStorage username if available
    const localUsername = localStorage.getItem('jam-username');
    const finalUsername = username || localUsername || email.split('@')[0];

    const { error } = await signUp(email, password, finalUsername);
    if (error) {
      setError(error.message);
    } else {
      onClose();
    }
    setLoading(false);
  };

  if (!isOpen) return null;

  return (
    <>
      {/* Backdrop - EXACT PATTERN FROM UsernameModal */}
      <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-40" />

      {/* Modal Container - EXACT PATTERN FROM UsernameModal */}
      <div className="fixed inset-0 flex items-center justify-center z-50 p-4">
        <div className="bg-gray-800 rounded-lg border border-gray-700 shadow-2xl max-w-md w-full p-6">

          {/* Header - MATCH UsernameModal PATTERN */}
          <div className="flex items-center gap-3 mb-4">
            <div className="w-10 h-10 rounded-full bg-primary-600/20 flex items-center justify-center">
              <Mail className="w-5 h-5 text-primary-400" />
            </div>
            <div>
              <h2 className="text-xl font-semibold text-white">
                {feature ? `Sign in to ${feature}` : 'Sign in to your account'}
              </h2>
              <p className="text-sm text-gray-400">
                {mode === 'magic-link'
                  ? 'We\'ll send you a magic link'
                  : 'Create an account or sign in'}
              </p>
            </div>
          </div>

          {/* Tab Switcher */}
          <div className="flex gap-2 mb-4 p-1 bg-gray-900 rounded-lg">
            <button
              onClick={() => setMode('magic-link')}
              className={`flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors ${
                mode === 'magic-link'
                  ? 'bg-primary-600 text-white'
                  : 'text-gray-400 hover:text-white'
              }`}
            >
              Magic Link
            </button>
            <button
              onClick={() => setMode('email-password')}
              className={`flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors ${
                mode === 'email-password'
                  ? 'bg-primary-600 text-white'
                  : 'text-gray-400 hover:text-white'
              }`}
            >
              Email/Password
            </button>
          </div>

          {/* Magic Link Mode */}
          {mode === 'magic-link' && (
            <>
              {magicLinkSent ? (
                <div className="text-center py-8">
                  <Mail className="w-12 h-12 text-primary-400 mx-auto mb-4" />
                  <p className="text-white font-medium mb-2">Check your email!</p>
                  <p className="text-sm text-gray-400">
                    We sent a magic link to <strong>{email}</strong>
                  </p>
                </div>
              ) : (
                <>
                  {/* Email Input - MATCH UsernameModal INPUT PATTERN */}
                  <input
                    type="email"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    placeholder="your@email.com"
                    className="w-full px-4 py-3 bg-gray-900 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all mb-4"
                  />

                  {error && (
                    <p className="text-sm text-red-400 mb-4">{error}</p>
                  )}

                  {/* Buttons - MATCH UsernameModal BUTTON PATTERN */}
                  <div className="flex gap-3">
                    <button onClick={onClose} className="flex-1 btn-secondary">
                      Cancel
                    </button>
                    <button
                      onClick={handleMagicLink}
                      disabled={loading || !email}
                      className="flex-1 btn-primary disabled:opacity-50"
                    >
                      {loading ? 'Sending...' : 'Send Magic Link'}
                    </button>
                  </div>
                </>
              )}
            </>
          )}

          {/* Email/Password Mode */}
          {mode === 'email-password' && (
            <>
              {/* Username Input (for signup) */}
              <input
                type="text"
                value={username}
                onChange={(e) => setUsername(e.target.value)}
                placeholder="Username (optional)"
                className="w-full px-4 py-3 bg-gray-900 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all mb-3"
              />

              {/* Email Input */}
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="your@email.com"
                className="w-full px-4 py-3 bg-gray-900 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all mb-3"
              />

              {/* Password Input */}
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                placeholder="Password"
                className="w-full px-4 py-3 bg-gray-900 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all mb-4"
              />

              {error && (
                <p className="text-sm text-red-400 mb-4">{error}</p>
              )}

              {/* Buttons */}
              <div className="flex gap-3">
                <button onClick={onClose} className="flex-1 btn-secondary">
                  Cancel
                </button>
                <button
                  onClick={handleSignUp}
                  disabled={loading || !email || !password}
                  className="flex-1 btn-primary disabled:opacity-50"
                >
                  {loading ? 'Creating...' : 'Create Account'}
                </button>
              </div>
            </>
          )}
        </div>
      </div>
    </>
  );
};
```

**Create RequireAuth Component (Blurred Preview Pattern):**

```typescript
// src/components/Auth/RequireAuth.tsx
import { useState } from 'react';
import { Lock } from 'lucide-react';
import { useAuth } from '@/hooks/useAuth';
import { AuthModal } from './AuthModal';

export const RequireAuth: React.FC<{
  children: React.ReactNode;
  feature: string; // e.g., "Save WLED Devices"
  featureDescription: string; // e.g., "Access your devices from any browser"
}> = ({ children, feature, featureDescription }) => {
  const { isAuthenticated } = useAuth();
  const [showAuthModal, setShowAuthModal] = useState(false);

  if (!isAuthenticated) {
    return (
      <div className="relative">
        {/* Blurred Preview - Show value BEFORE friction */}
        <div className="filter blur-md pointer-events-none opacity-30">
          {children}
        </div>

        {/* Overlay with Value Proposition */}
        <div className="absolute inset-0 flex items-center justify-center bg-gray-900/80 backdrop-blur-sm">
          <div className="bg-gray-800 rounded-lg border border-gray-700 shadow-2xl max-w-md w-full p-8 m-4">
            {/* Icon */}
            <div className="w-12 h-12 rounded-full bg-primary-600/20 flex items-center justify-center mx-auto mb-4">
              <Lock className="w-6 h-6 text-primary-400" />
            </div>

            {/* Heading */}
            <h3 className="text-2xl font-semibold text-white text-center mb-2">
              {feature}
            </h3>

            {/* Description */}
            <p className="text-gray-400 text-center mb-6">
              {featureDescription}
            </p>

            {/* CTA Buttons */}
            <div className="space-y-3">
              <button
                onClick={() => setShowAuthModal(true)}
                className="w-full btn-primary"
              >
                Create Free Account
              </button>
              <button
                onClick={() => setShowAuthModal(true)}
                className="w-full text-sm text-primary-400 hover:text-primary-300 transition-colors"
              >
                Already have an account? Sign In
              </button>
            </div>
          </div>
        </div>

        {/* Auth Modal */}
        <AuthModal
          isOpen={showAuthModal}
          onClose={() => setShowAuthModal(false)}
          feature={feature}
        />
      </div>
    );
  }

  return <>{children}</>;
};
```

**Header Integration (Minimal Changes):**

Only add auth UI to header when user needs it. **Do not add dropdown menus or avatar components.**

```typescript
// src/components/Layout/Header.tsx
import { useAuth } from '@/hooks/useAuth';

export const Header: React.FC<HeaderProps> = ({ /* existing props */ }) => {
  const { user, isAuthenticated } = useAuth();
  const [showAuthModal, setShowAuthModal] = useState(false);

  // Only show "Sign In" button when user has attempted to access gated feature
  const [showAuthPrompt, setShowAuthPrompt] = useState(false);

  return (
    <header className="sticky top-0 z-30 bg-gray-900/95 backdrop-blur-sm border-b border-gray-800">
      <div className="flex items-center justify-between px-4 py-3">

        {/* Left: Logo / Back Button (EXISTING) */}
        <div className="flex items-center gap-3">
          {/* ... existing logo code ... */}
        </div>

        {/* Center: Session Code / Status (EXISTING) */}
        <div className="flex items-center gap-2">
          {/* ... existing session code ... */}
        </div>

        {/* Right: Settings + Conditional Auth Button */}
        <div className="flex items-center gap-2">

          {/* NEW: Small conditional auth button */}
          {showAuthPrompt && !isAuthenticated && (
            <button
              onClick={() => setShowAuthModal(true)}
              className="text-xs sm:text-sm px-2 sm:px-3 py-1 sm:py-2 bg-primary-600/20 hover:bg-primary-600/30 text-primary-400 rounded-lg transition-colors"
            >
              Sign In
            </button>
          )}

          {/* EXISTING: Settings button */}
          <button
            onClick={onSettingsClick}
            className="p-2 hover:bg-gray-700 rounded-lg transition-colors"
          >
            <Settings className="w-5 h-5" />
          </button>
        </div>
      </div>

      {/* Auth Modal */}
      <AuthModal
        isOpen={showAuthModal}
        onClose={() => setShowAuthModal(false)}
      />
    </header>
  );
};
```

**When to Show Sign In Button:**
```typescript
// Trigger showAuthPrompt when user attempts to access gated feature
// Example: WLEDManager component
const handleOpenWLEDManager = () => {
  if (!isAuthenticated) {
    // Show auth prompt in header
    setShowAuthPrompt(true);

    // Also show RequireAuth overlay
    return;
  }

  // User is authenticated, proceed normally
  navigate('/wled-manager');
};
```

### Phase 4: Testing and Integration (1 hour)

**Manual Verification Steps:**

1. **Sign Up Flow:**
   - Open AuthModal
   - Enter email, password, username
   - Verify email confirmation sent
   - Click confirmation link
   - Verify user profile created in `user_profiles` table

2. **Sign In Flow:**
   - Sign out
   - Sign in with email/password
   - Verify session persists across page reload
   - Verify username displayed correctly

3. **Magic Link Flow:**
   - Sign out
   - Request magic link
   - Check email
   - Click magic link
   - Verify signed in

4. **Anonymous to Authenticated Migration:**
   - Sign out
   - Enter username in `UsernameModal` (jam session)
   - Verify saved to localStorage
   - Create account via AuthModal
   - Verify localStorage username migrated to user profile

5. **Feature Gating:**
   - While anonymous, attempt to access WLED Manager (future Story 18.5)
   - Verify "Upgrade Required" prompt shows
   - Create account
   - Verify WLED Manager now accessible

6. **RLS Testing:**
   - Create two user accounts (User A, User B)
   - User A: Create WLED device (Story 18.1 - future)
   - User B: Attempt to query `wled_devices` table
   - Verify User B cannot see User A's devices

---

## Existing Pattern Reference

### UI Components to Match

**DO NOT** invent new component patterns. **ALWAYS** follow existing codebase patterns.

| Pattern | Source File | Usage |
|---------|-------------|-------|
| Modal backdrop + card | `src/components/JamSession/UsernameModal.tsx` | AuthModal structure |
| Button classes | `src/index.css` (.btn-primary, .btn-secondary) | All buttons |
| Input styling | `UsernameModal.tsx` (lines 45-50) | Email/password inputs |
| Icon circles | `UsernameModal.tsx` (line 32-34) | Header icons |
| Header layout | `src/components/Layout/Header.tsx` | Minimal auth button placement |

### NO shadcn/ui Installation Needed

This project uses **plain Tailwind CSS** with custom utility classes. Do not install:
- ‚ùå shadcn/ui components (Dialog, Input, Button, etc.)
- ‚ùå Radix UI primitives
- ‚ùå UI component libraries

All UI is built with:
- ‚úÖ Tailwind utility classes
- ‚úÖ Custom classes from `src/index.css` (@layer components)
- ‚úÖ Lucide React icons (already installed)

### Key Philosophy

From `WelcomeScreen.tsx:67`:
> "No account needed. Just open the app and start playing."

**Design Principles:**
1. **Invisible Until Needed** - Zero auth UI on initial load
2. **Value-First Gating** - Show blurred preview before asking for account
3. **Magic Link Primary** - Passwordless (like Slack) as default
4. **Pattern Consistency** - Match existing modals exactly

---

## Dependencies

### Prerequisites
- ‚úÖ **Story 7.1 Complete:** Supabase project setup and client initialization

### Blocks These Stories
- ‚è≥ **Story 18.1:** WLED Device Registry (requires auth.uid() for RLS)
- ‚è≥ **Epic 3 Stories:** License Management, Pro tier gating (requires user accounts)
- ‚è≥ **Future Presets:** Save/load user presets (requires persistent user identity)

---

## Integration Points

- `src/lib/supabase.ts` - Existing Supabase client (no changes needed)
- `src/hooks/useAuth.ts` - NEW: Authentication hook
- `src/contexts/GlobalMusicContext.tsx` - ADD: user, isAuthenticated fields
- `src/components/Auth/AuthModal.tsx` - NEW: Authentication UI
- `src/components/Auth/RequireAuth.tsx` - NEW: Feature gating wrapper
- `src/components/JamSession/UsernameModal.tsx` - EXISTING: Preserve localStorage behavior
- Database: `user_profiles` table + RLS policies

---

## Testing Strategy

### Manual Verification Steps (Per CLAUDE.md Guidelines)

**Test 1: Supabase Auth Configuration**
```bash
# Verify auth providers enabled
# Dashboard ‚Üí Authentication ‚Üí Providers
# Confirm: Email/Password ‚úÖ, Magic Link ‚úÖ
```

**Test 2: Sign Up Flow**
1. Click "Create Account" in header
2. Enter email: `test@example.com`, password: `SecurePass123!`, username: `TestUser`
3. Check email inbox for confirmation link
4. Click confirmation link
5. Verify redirected to app and signed in
6. Open Supabase dashboard ‚Üí Authentication ‚Üí Users
7. Confirm user created

**Test 3: Sign In Flow**
1. Sign out (click profile menu ‚Üí Sign Out)
2. Click "Sign In" in header
3. Enter email and password
4. Verify signed in successfully
5. Reload page
6. Verify still signed in (session persisted)

**Test 4: Magic Link Flow**
1. Sign out
2. Click "Sign In" ‚Üí "Use Magic Link Instead"
3. Enter email
4. Check inbox for magic link
5. Click magic link
6. Verify signed in

**Test 5: Anonymous to Authenticated Migration**
1. Sign out (anonymous mode)
2. Go to `/jam`
3. Enter username "AnonymousUser123" in UsernameModal
4. Verify saved to localStorage
5. Click "Create Account"
6. Sign up with email/password
7. Check user profile in database:
   ```sql
   SELECT username FROM user_profiles WHERE id = '<user-id>';
   -- Expected: username = 'AnonymousUser123' (migrated from localStorage)
   ```

**Test 6: RLS Policy Enforcement**
```sql
-- Test as User A (authenticated)
SET request.jwt.claims = '{"sub": "<user-a-id>"}';
SELECT * FROM user_profiles;
-- Expected: Only User A's profile

-- Test as anonymous user
SET request.jwt.claims = NULL;
SELECT * FROM user_profiles;
-- Expected: 0 rows (RLS blocks anonymous access)
```

**Test 7: Feature Gating (Preparation for Story 18.1)**
1. Sign out (anonymous mode)
2. Attempt to navigate to `/wled-manager` (future route)
3. Verify "Create Account to Access WLED Registry" modal appears
4. Click "Create Account"
5. Sign up
6. Verify `/wled-manager` now accessible

### Performance Testing

**Test 8: Auth Check Latency**
```typescript
// Measure initial auth check time
console.time('auth-check');
const { data: { session } } = await supabase.auth.getSession();
console.timeEnd('auth-check');
// Expected: <100ms
```

---

## Risks and Mitigation

### Risk 1: Breaking Existing Jam Sessions
**Impact:** HIGH
**Mitigation:**
- Jam sessions MUST work for both anonymous and authenticated users
- `UsernameModal` localStorage behavior preserved
- Authenticated users: Fall back to email if username not set
- Integration tests verify both modes work

### Risk 2: Email Delivery Issues
**Impact:** MEDIUM
**Mitigation:**
- Use Supabase default email service (SendGrid)
- Test with multiple email providers (Gmail, Outlook, Yahoo)
- Add "Resend Confirmation" button
- Provide Magic Link as passwordless alternative

### Risk 3: User Confusion (Forced Accounts)
**Impact:** HIGH
**Mitigation:**
- Clear messaging: "Optional - only for advanced features"
- Basic features work without accounts (jam sessions, drum machine)
- "Skip for now" button on auth prompts
- UX copy emphasizes low friction

---

## Definition of Done

- [ ] Supabase Auth enabled (Email/Password + Magic Link)
- [ ] `user_profiles` table created with RLS policies
- [ ] Database trigger auto-creates profile on sign up
- [ ] `useAuth` hook implemented and tested
- [ ] `AuthModal` component created following UsernameModal.tsx pattern exactly
- [ ] Magic Link tab is PRIMARY (default, first tab)
- [ ] AuthModal uses existing .btn-primary and .btn-secondary classes
- [ ] GlobalMusicContext extended with auth state
- [ ] `RequireAuth` wrapper component created with blurred preview pattern
- [ ] Header integration minimal (small conditional "Sign In" button only)
- [ ] NO shadcn/ui components installed (plain Tailwind only)
- [ ] Username migration from localStorage working
- [ ] Session persistence tested (page reload, browser tabs)
- [ ] RLS policies verified (users can't access other users' data)
- [ ] Anonymous mode still works (jam sessions, basic features)
- [ ] Auth UI completely invisible on initial load (zero friction)
- [ ] Email confirmation flow tested
- [ ] Magic link flow tested (primary method)
- [ ] Password reset flow tested
- [ ] Auth check latency <100ms
- [ ] Documentation updated (setup guide for auth)
- [ ] No breaking changes to existing features
- [ ] Pattern consistency verified (matches existing modal patterns)

---

## Deliverables

1. **Database Migration**
   - `supabase/migrations/002_user_profiles.sql` (~50 lines)

2. **React Hooks**
   - `src/hooks/useAuth.ts` (~100 lines)

3. **Components**
   - `src/components/Auth/AuthModal.tsx` (~250 lines)
   - `src/components/Auth/RequireAuth.tsx` (~80 lines)

4. **Context Updates**
   - Modified: `src/contexts/GlobalMusicContext.tsx` (+30 lines)

5. **Types**
   - `src/types/auth.ts` (~20 lines)

6. **Documentation**
   - Updated: `docs/ENVIRONMENT_SETUP.md` (Supabase Auth setup)
   - Updated: `README.md` (Authentication section)

---

## Next Steps After Story 18.0

Once this story is complete, proceed to:
- **Story 18.1:** WLED Device Registry (Supabase Backend) - 4-5 hours
  - Now unblocked: Can use `auth.uid()` for RLS policies
  - Can create `wled_devices` table with `user_id` foreign key

---

## References

- **Epic 18:** `docs/epics/epic-18-intelligent-wled-routing.md`
- **Epic 7:** `docs/epics/epic-7-jam-session-backend.md` (Supabase Realtime)
- **Epic 3:** `docs/epics/epic-3-multi-controller-pro-monetization.md` (Feature gating context)
- **Supabase Auth Docs:** https://supabase.com/docs/guides/auth
- **Supabase RLS Docs:** https://supabase.com/docs/guides/auth/row-level-security

---

**Story Created:** 2025-10-18
**Story Owner:** Dev Agent / Sarah (PO)
**Estimated Completion:** 4-6 hours after start
**Blocks:** Story 18.1, Epic 3 License Management

---

## Notes

### Design Decisions

**Why Email/Password + Magic Link (Not OAuth)?**
- Simpler MVP (no external provider configuration)
- Magic Link provides passwordless option without OAuth complexity
- Magic Link as PRIMARY (default tab) - least friction, proven pattern (Slack, Notion)
- Can add OAuth (Google, GitHub) in Phase 2 if needed

**Why Hybrid Anonymous + Authenticated?**
- App philosophy: "No account needed. Just open the app and start playing." (WelcomeScreen.tsx)
- User's explicit requirement: "non-disruptive to creative flow"
- Aligns with Epic 3 monetization strategy (free tier vs Pro tier)
- Proven pattern: Discord, Figma, Linear (all allow anonymous usage)

**Why Migrate localStorage Username?**
- Preserve user identity when upgrading to account
- Avoids "who is this new person?" confusion in jam sessions
- Better UX: User keeps their chosen name

**Why Match UsernameModal Pattern?**
- Consistency: Users already familiar with existing modal pattern
- No new patterns to learn
- Reuses existing Tailwind classes (.btn-primary, .btn-secondary)
- No external dependencies (no shadcn/ui needed)

**Why "Invisible Until Needed" Approach?**
- Zero friction for basic features (jam sessions, drum machine, visualizers)
- Auth only appears when user tries to save persistent data (WLED devices, presets)
- Blurred preview shows value BEFORE asking for account
- Progressive disclosure: complexity introduced only when needed

### Future Enhancements (Post-MVP)

- OAuth providers (Google, GitHub, Discord)
- Social profiles (avatar upload, bio)
- Email notifications (session invites, feature updates)
- Two-factor authentication (2FA)
- Account deletion / data export (GDPR compliance)

---

## Dev Agent Record

### Implementation Summary

*To be completed during implementation*

### Tasks Completed

- [ ] Supabase Auth configuration
- [ ] `user_profiles` table migration
- [ ] `useAuth` hook implementation
- [ ] `AuthModal` component
- [ ] GlobalMusicContext integration
- [ ] Username migration logic
- [ ] RLS policy setup
- [ ] Manual testing (7 test scenarios)

### File List

*To be populated during implementation*

### Manual Verification Performed

*To be documented during testing*

### Integration Notes

*To be added during implementation*

### Completion Notes

*To be filled after story completion*
