# Story 18.0: Low-Friction User Authentication (Supabase Auth)

**Epic:** Epic 18 - Intelligent WLED Visualization Routing
**Status:** üìù PLANNING
**Priority:** üî¥ HIGH (BLOCKS Story 18.1)
**Complexity:** Medium
**Time Estimate:** 4-6 hours
**Prerequisites:** Story 7.1 (Supabase Setup)

---

## User Story

As a **user exploring advanced features**,
I want **optional user accounts with seamless anonymous-to-authenticated upgrade**,
So that **I can access persistent features (WLED registry, presets, hardware access) without friction for basic use**.

---

## Story Context

### Why This Story

**Blocker for Epic 18:** Story 18.1 (WLED Device Registry) requires persistent storage with Row Level Security (RLS), which depends on Supabase authentication:

```sql
-- Story 18.1 requires user authentication
CREATE TABLE wled_devices (
  user_id UUID REFERENCES auth.users NOT NULL,  -- Requires auth
  ...
);

CREATE POLICY "Users can view own devices"
  ON wled_devices FOR SELECT
  USING (auth.uid() = user_id);  -- Requires auth.uid()
```

**Current State:**
- ‚úÖ Users provide display name via `UsernameModal` (localStorage only)
- ‚úÖ Completely anonymous - no persistent identity
- ‚ùå No Supabase Auth configured
- ‚ùå No RLS policies (database wide open)

**Desired State (Low-Friction MVP):**
- ‚úÖ Basic features work **without accounts** (`/jam`, `/studio`, drum machine)
- ‚úÖ Advanced features prompt for **optional account creation** (WLED registry, presets, APC40)
- ‚úÖ Seamless upgrade path (anonymous ‚Üí authenticated)
- ‚úÖ Preserve localStorage username when creating account

---

## Acceptance Criteria

### Functional Requirements

1. **Supabase Auth Configuration**
   - Supabase Auth enabled in dashboard (Authentication ‚Üí Providers)
   - Email/Password provider enabled
   - Magic Link provider enabled (passwordless option)
   - Email templates configured (confirmation, password reset)

2. **Authentication UI Components**
   - `AuthModal` component created with:
     - Sign Up tab (email, password, username)
     - Sign In tab (email, password OR magic link)
     - Password reset flow
     - Responsive design (ViewTemplate pattern)
   - "Create Account" / "Sign In" buttons in global header
   - "Upgrade to Pro" prompts when accessing gated features

3. **User Profile System**
   - `user_profiles` table created in Supabase:
     ```sql
     CREATE TABLE user_profiles (
       id UUID REFERENCES auth.users PRIMARY KEY,
       username TEXT NOT NULL,
       created_at TIMESTAMPTZ DEFAULT NOW(),
       updated_at TIMESTAMPTZ DEFAULT NOW()
     );
     ```
   - RLS policies enforced (users can only view/edit own profile)
   - Automatic profile creation on sign up (database trigger)

4. **Hybrid Anonymous + Authenticated System**
   - `useAuth` hook created:
     ```typescript
     function useAuth() {
       const [user, setUser] = useState<User | null>(null);
       const [isAnonymous, setIsAnonymous] = useState(true);

       // Returns: { user, isAnonymous, signIn, signUp, signOut }
     }
     ```
   - Feature gating utility:
     ```typescript
     function requiresAuth(feature: 'wled-registry' | 'presets' | 'apc40'): boolean
     ```
   - Anonymous users can still use basic features

5. **Username Migration**
   - When anonymous user creates account:
     - Read username from `localStorage.getItem('jam-username')`
     - Populate `user_profiles.username` with localStorage value
     - Preserve user's existing identity

6. **Session Persistence**
   - Auth session persists across browser tabs
   - Auto-refresh token before expiry
   - "Remember me" functionality (session stored in localStorage)

7. **RLS Policy Foundation**
   - Enable RLS on `user_profiles` table
   - Create helper SQL function:
     ```sql
     CREATE FUNCTION is_authenticated() RETURNS BOOLEAN AS $$
       SELECT auth.uid() IS NOT NULL;
     $$ LANGUAGE SQL STABLE;
     ```
   - Prepare RLS policy templates for future tables

### Integration Requirements

8. **GlobalMusicContext Integration**
   - Add auth state to `GlobalMusicContext`:
     ```typescript
     interface GlobalMusicState {
       // ... existing fields
       user: User | null;
       isAuthenticated: boolean;
     }
     ```
   - Sync auth state across all components

9. **JamSession Compatibility**
   - Jam sessions work for **both** anonymous and authenticated users
   - Authenticated users: Username from `user_profiles.username`
   - Anonymous users: Username from `localStorage` (existing behavior)
   - No breaking changes to existing jam session functionality

10. **Feature Gate UI Patterns**
    - Show "Upgrade Required" modal when accessing gated features:
      - WLED Device Registry (Story 18.1)
      - Presets Library (future)
      - APC40 Hardware Access (Epic 3)
    - Modal includes:
      - Feature description ("Save your WLED devices across sessions")
      - "Create Free Account" button
      - "Already have an account? Sign In" link

### Quality Requirements

11. **Security**
    - Passwords never stored in plaintext (Supabase handles)
    - Email confirmation required for sign up
    - Password reset via secure token
    - RLS policies tested (users can't access other users' data)

12. **Error Handling**
    - User-friendly error messages:
      - Email already exists
      - Invalid credentials
      - Network errors
      - Session expired
    - Graceful fallback to anonymous mode if auth fails

13. **Performance**
    - Auth check adds <100ms to initial page load
    - No blocking UI while checking auth state
    - Show loading spinner during sign in/sign up

---

## Technical Approach

### Phase 1: Supabase Auth Configuration (1 hour)

**Enable Supabase Auth:**
1. Dashboard ‚Üí Authentication ‚Üí Providers
2. Enable Email/Password provider
3. Enable Magic Link provider
4. Configure email templates (confirmation, password reset)
5. Set redirect URLs:
   - Development: `http://localhost:5173/auth/callback`
   - Production: `https://jam.audiolux.app/auth/callback`

**Create User Profiles Table:**
```sql
-- Migration: create_user_profiles.sql
CREATE TABLE user_profiles (
  id UUID REFERENCES auth.users PRIMARY KEY,
  username TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS Policies
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own profile"
  ON user_profiles FOR SELECT
  USING (auth.uid() = id);

CREATE POLICY "Users can update own profile"
  ON user_profiles FOR UPDATE
  USING (auth.uid() = id);

-- Auto-create profile on sign up
CREATE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.user_profiles (id, username)
  VALUES (NEW.id, NEW.email); -- Default to email, user can change
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();
```

### Phase 2: Auth Hooks and Context (2 hours)

**Create useAuth Hook:**
```typescript
// src/hooks/useAuth.ts
import { useEffect, useState } from 'react';
import { User } from '@supabase/supabase-js';
import { supabase } from '@/lib/supabase';

export function useAuth() {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Check active session
    supabase.auth.getSession().then(({ data: { session } }) => {
      setUser(session?.user ?? null);
      setLoading(false);
    });

    // Listen for auth changes
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      (_event, session) => {
        setUser(session?.user ?? null);
      }
    );

    return () => subscription.unsubscribe();
  }, []);

  const signIn = async (email: string, password: string) => {
    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });
    return { data, error };
  };

  const signUp = async (email: string, password: string, username: string) => {
    // Create auth user
    const { data, error } = await supabase.auth.signUp({
      email,
      password,
    });

    if (error) return { data, error };

    // Update profile with username
    if (data.user) {
      await supabase
        .from('user_profiles')
        .update({ username })
        .eq('id', data.user.id);
    }

    return { data, error };
  };

  const signInWithMagicLink = async (email: string) => {
    const { data, error } = await supabase.auth.signInWithOtp({
      email,
      options: {
        emailRedirectTo: `${window.location.origin}/auth/callback`,
      },
    });
    return { data, error };
  };

  const signOut = async () => {
    const { error } = await supabase.auth.signOut();
    return { error };
  };

  return {
    user,
    isAuthenticated: !!user,
    isAnonymous: !user,
    loading,
    signIn,
    signUp,
    signInWithMagicLink,
    signOut,
  };
}
```

**Extend GlobalMusicContext:**
```typescript
// src/contexts/GlobalMusicContext.tsx
import { useAuth } from '@/hooks/useAuth';

export interface GlobalMusicState {
  // ... existing fields
  user: User | null;
  isAuthenticated: boolean;
}

export const GlobalMusicProvider: React.FC<GlobalMusicProviderProps> = ({ children }) => {
  const auth = useAuth();

  // ... existing code

  const contextValue = useMemo<GlobalMusicContextValue>(
    () => ({
      ...state,
      user: auth.user,
      isAuthenticated: auth.isAuthenticated,
      // ... existing fields
    }),
    [state, auth.user, auth.isAuthenticated]
  );

  // ...
};
```

### Phase 3: Auth UI Components (2 hours)

**Create AuthModal Component:**
```typescript
// src/components/Auth/AuthModal.tsx
import { useState } from 'react';
import { useAuth } from '@/hooks/useAuth';
import { ViewTemplate, ViewCard } from '@/components/Layout/ViewTemplate';

type AuthMode = 'signin' | 'signup' | 'reset';

export const AuthModal: React.FC<{
  isOpen: boolean;
  onClose: () => void;
  defaultMode?: AuthMode;
}> = ({ isOpen, onClose, defaultMode = 'signin' }) => {
  const [mode, setMode] = useState<AuthMode>(defaultMode);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [username, setUsername] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const { signIn, signUp, signInWithMagicLink } = useAuth();

  const handleSignIn = async () => {
    setLoading(true);
    setError('');
    const { error } = await signIn(email, password);
    if (error) {
      setError(error.message);
    } else {
      onClose();
    }
    setLoading(false);
  };

  const handleSignUp = async () => {
    setLoading(true);
    setError('');

    // Migrate localStorage username if available
    const localUsername = localStorage.getItem('jam-username');
    const finalUsername = username || localUsername || email.split('@')[0];

    const { error } = await signUp(email, password, finalUsername);
    if (error) {
      setError(error.message);
    } else {
      onClose();
    }
    setLoading(false);
  };

  // ... render modal with tabs for sign in/sign up
};
```

**Create RequireAuth Component:**
```typescript
// src/components/Auth/RequireAuth.tsx
import { useAuth } from '@/hooks/useAuth';
import { AuthModal } from './AuthModal';

export const RequireAuth: React.FC<{
  children: React.ReactNode;
  feature: string;
  featureDescription: string;
}> = ({ children, feature, featureDescription }) => {
  const { isAuthenticated } = useAuth();
  const [showAuthModal, setShowAuthModal] = useState(false);

  if (!isAuthenticated) {
    return (
      <>
        <div onClick={() => setShowAuthModal(true)}>
          {/* Overlay with "Create Account to Access" message */}
        </div>
        <AuthModal
          isOpen={showAuthModal}
          onClose={() => setShowAuthModal(false)}
          defaultMode="signup"
        />
      </>
    );
  }

  return <>{children}</>;
};
```

### Phase 4: Testing and Integration (1 hour)

**Manual Verification Steps:**

1. **Sign Up Flow:**
   - Open AuthModal
   - Enter email, password, username
   - Verify email confirmation sent
   - Click confirmation link
   - Verify user profile created in `user_profiles` table

2. **Sign In Flow:**
   - Sign out
   - Sign in with email/password
   - Verify session persists across page reload
   - Verify username displayed correctly

3. **Magic Link Flow:**
   - Sign out
   - Request magic link
   - Check email
   - Click magic link
   - Verify signed in

4. **Anonymous to Authenticated Migration:**
   - Sign out
   - Enter username in `UsernameModal` (jam session)
   - Verify saved to localStorage
   - Create account via AuthModal
   - Verify localStorage username migrated to user profile

5. **Feature Gating:**
   - While anonymous, attempt to access WLED Manager (future Story 18.5)
   - Verify "Upgrade Required" prompt shows
   - Create account
   - Verify WLED Manager now accessible

6. **RLS Testing:**
   - Create two user accounts (User A, User B)
   - User A: Create WLED device (Story 18.1 - future)
   - User B: Attempt to query `wled_devices` table
   - Verify User B cannot see User A's devices

---

## Dependencies

### Prerequisites
- ‚úÖ **Story 7.1 Complete:** Supabase project setup and client initialization

### Blocks These Stories
- ‚è≥ **Story 18.1:** WLED Device Registry (requires auth.uid() for RLS)
- ‚è≥ **Epic 3 Stories:** License Management, Pro tier gating (requires user accounts)
- ‚è≥ **Future Presets:** Save/load user presets (requires persistent user identity)

---

## Integration Points

- `src/lib/supabase.ts` - Existing Supabase client (no changes needed)
- `src/hooks/useAuth.ts` - NEW: Authentication hook
- `src/contexts/GlobalMusicContext.tsx` - ADD: user, isAuthenticated fields
- `src/components/Auth/AuthModal.tsx` - NEW: Authentication UI
- `src/components/Auth/RequireAuth.tsx` - NEW: Feature gating wrapper
- `src/components/JamSession/UsernameModal.tsx` - EXISTING: Preserve localStorage behavior
- Database: `user_profiles` table + RLS policies

---

## Testing Strategy

### Manual Verification Steps (Per CLAUDE.md Guidelines)

**Test 1: Supabase Auth Configuration**
```bash
# Verify auth providers enabled
# Dashboard ‚Üí Authentication ‚Üí Providers
# Confirm: Email/Password ‚úÖ, Magic Link ‚úÖ
```

**Test 2: Sign Up Flow**
1. Click "Create Account" in header
2. Enter email: `test@example.com`, password: `SecurePass123!`, username: `TestUser`
3. Check email inbox for confirmation link
4. Click confirmation link
5. Verify redirected to app and signed in
6. Open Supabase dashboard ‚Üí Authentication ‚Üí Users
7. Confirm user created

**Test 3: Sign In Flow**
1. Sign out (click profile menu ‚Üí Sign Out)
2. Click "Sign In" in header
3. Enter email and password
4. Verify signed in successfully
5. Reload page
6. Verify still signed in (session persisted)

**Test 4: Magic Link Flow**
1. Sign out
2. Click "Sign In" ‚Üí "Use Magic Link Instead"
3. Enter email
4. Check inbox for magic link
5. Click magic link
6. Verify signed in

**Test 5: Anonymous to Authenticated Migration**
1. Sign out (anonymous mode)
2. Go to `/jam`
3. Enter username "AnonymousUser123" in UsernameModal
4. Verify saved to localStorage
5. Click "Create Account"
6. Sign up with email/password
7. Check user profile in database:
   ```sql
   SELECT username FROM user_profiles WHERE id = '<user-id>';
   -- Expected: username = 'AnonymousUser123' (migrated from localStorage)
   ```

**Test 6: RLS Policy Enforcement**
```sql
-- Test as User A (authenticated)
SET request.jwt.claims = '{"sub": "<user-a-id>"}';
SELECT * FROM user_profiles;
-- Expected: Only User A's profile

-- Test as anonymous user
SET request.jwt.claims = NULL;
SELECT * FROM user_profiles;
-- Expected: 0 rows (RLS blocks anonymous access)
```

**Test 7: Feature Gating (Preparation for Story 18.1)**
1. Sign out (anonymous mode)
2. Attempt to navigate to `/wled-manager` (future route)
3. Verify "Create Account to Access WLED Registry" modal appears
4. Click "Create Account"
5. Sign up
6. Verify `/wled-manager` now accessible

### Performance Testing

**Test 8: Auth Check Latency**
```typescript
// Measure initial auth check time
console.time('auth-check');
const { data: { session } } = await supabase.auth.getSession();
console.timeEnd('auth-check');
// Expected: <100ms
```

---

## Risks and Mitigation

### Risk 1: Breaking Existing Jam Sessions
**Impact:** HIGH
**Mitigation:**
- Jam sessions MUST work for both anonymous and authenticated users
- `UsernameModal` localStorage behavior preserved
- Authenticated users: Fall back to email if username not set
- Integration tests verify both modes work

### Risk 2: Email Delivery Issues
**Impact:** MEDIUM
**Mitigation:**
- Use Supabase default email service (SendGrid)
- Test with multiple email providers (Gmail, Outlook, Yahoo)
- Add "Resend Confirmation" button
- Provide Magic Link as passwordless alternative

### Risk 3: User Confusion (Forced Accounts)
**Impact:** HIGH
**Mitigation:**
- Clear messaging: "Optional - only for advanced features"
- Basic features work without accounts (jam sessions, drum machine)
- "Skip for now" button on auth prompts
- UX copy emphasizes low friction

---

## Definition of Done

- [ ] Supabase Auth enabled (Email/Password + Magic Link)
- [ ] `user_profiles` table created with RLS policies
- [ ] Database trigger auto-creates profile on sign up
- [ ] `useAuth` hook implemented and tested
- [ ] `AuthModal` component created (sign in/sign up/reset)
- [ ] GlobalMusicContext extended with auth state
- [ ] `RequireAuth` wrapper component created
- [ ] Username migration from localStorage working
- [ ] Session persistence tested (page reload, browser tabs)
- [ ] RLS policies verified (users can't access other users' data)
- [ ] Anonymous mode still works (jam sessions, basic features)
- [ ] Email confirmation flow tested
- [ ] Magic link flow tested
- [ ] Password reset flow tested
- [ ] Auth check latency <100ms
- [ ] Documentation updated (setup guide for auth)
- [ ] No breaking changes to existing features

---

## Deliverables

1. **Database Migration**
   - `supabase/migrations/002_user_profiles.sql` (~50 lines)

2. **React Hooks**
   - `src/hooks/useAuth.ts` (~100 lines)

3. **Components**
   - `src/components/Auth/AuthModal.tsx` (~250 lines)
   - `src/components/Auth/RequireAuth.tsx` (~80 lines)

4. **Context Updates**
   - Modified: `src/contexts/GlobalMusicContext.tsx` (+30 lines)

5. **Types**
   - `src/types/auth.ts` (~20 lines)

6. **Documentation**
   - Updated: `docs/ENVIRONMENT_SETUP.md` (Supabase Auth setup)
   - Updated: `README.md` (Authentication section)

---

## Next Steps After Story 18.0

Once this story is complete, proceed to:
- **Story 18.1:** WLED Device Registry (Supabase Backend) - 4-5 hours
  - Now unblocked: Can use `auth.uid()` for RLS policies
  - Can create `wled_devices` table with `user_id` foreign key

---

## References

- **Epic 18:** `docs/epics/epic-18-intelligent-wled-routing.md`
- **Epic 7:** `docs/epics/epic-7-jam-session-backend.md` (Supabase Realtime)
- **Epic 3:** `docs/epics/epic-3-multi-controller-pro-monetization.md` (Feature gating context)
- **Supabase Auth Docs:** https://supabase.com/docs/guides/auth
- **Supabase RLS Docs:** https://supabase.com/docs/guides/auth/row-level-security

---

**Story Created:** 2025-10-18
**Story Owner:** Dev Agent / Sarah (PO)
**Estimated Completion:** 4-6 hours after start
**Blocks:** Story 18.1, Epic 3 License Management

---

## Notes

### Design Decisions

**Why Email/Password + Magic Link (Not OAuth)?**
- Simpler MVP (no external provider configuration)
- Magic Link provides passwordless option without OAuth complexity
- Can add OAuth (Google, GitHub) in Phase 2 if needed

**Why Hybrid Anonymous + Authenticated?**
- User's explicit requirement: "low friction, no account needed for most part"
- Aligns with Epic 3 monetization strategy (free tier vs Pro tier)
- Proven pattern: Discord, Figma, Linear (all allow anonymous usage)

**Why Migrate localStorage Username?**
- Preserve user identity when upgrading to account
- Avoids "who is this new person?" confusion in jam sessions
- Better UX: User keeps their chosen name

### Future Enhancements (Post-MVP)

- OAuth providers (Google, GitHub, Discord)
- Social profiles (avatar upload, bio)
- Email notifications (session invites, feature updates)
- Two-factor authentication (2FA)
- Account deletion / data export (GDPR compliance)

---

## Dev Agent Record

### Implementation Summary

*To be completed during implementation*

### Tasks Completed

- [ ] Supabase Auth configuration
- [ ] `user_profiles` table migration
- [ ] `useAuth` hook implementation
- [ ] `AuthModal` component
- [ ] GlobalMusicContext integration
- [ ] Username migration logic
- [ ] RLS policy setup
- [ ] Manual testing (7 test scenarios)

### File List

*To be populated during implementation*

### Manual Verification Performed

*To be documented during testing*

### Integration Notes

*To be added during implementation*

### Completion Notes

*To be filled after story completion*
