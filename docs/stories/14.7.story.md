# Story 14.7: LED Compositor Implementation

## Status
READY TO START

## Story
**As a** user with limited LED hardware (1-2 strips),
**I want** multiple visualizations to blend visually on the same hardware,
**so that** I can see Piano notes AND audio ripples simultaneously instead of choosing which one "wins".

## Acceptance Criteria
1. LEDCompositor service created with frame buffer and blending logic
2. LEDFrame, VisualizationMode, BlendMode types created
3. 4 blending modes functional (multiply, screen, additive, max)
4. Compatibility detection working (COMPATIBILITY_MATRIX enforced)
5. UI controls for blend mode selection
6. Warning UI when incompatible visualizations detected
7. Manual verification: Piano + Audio ripple blending works
8. Manual verification: Piano + Guitar incompatibility warning shown

## Manual Verification Checklist (11 minutes)
- **MV1**: Piano + Audio Ripple blending (5 min)
  - [ ] Setup `/studio` with PianoRoll + LiveAudioVisualizer, 1 WLED strip
  - [ ] Play piano notes + audio → Both visible simultaneously
- **MV2**: Incompatibility warning (3 min)
  - [ ] Setup `/studio` with PianoRoll + GuitarFretboard, 1 WLED strip
  - [ ] Play both → Warning shown, toggle mode active
- **MV3**: Blend mode switching (3 min)
  - [ ] Switch blend modes (multiply → screen → additive)
  - [ ] Verify visual output changes correctly

## Tasks / Subtasks

- [ ] **Task 1: Create BlendMode Types** (AC: 2, 3)
  - [ ] Create `src/types/blendMode.ts`
  - [ ] Define `BlendMode` type
  - [ ] Implement `blendPixels()` function (multiply, screen, additive, max)
  - [ ] Export in `src/types/index.ts`

- [ ] **Task 2: Create LEDFrame Type** (AC: 2)
  - [ ] Create `src/types/ledFrame.ts`
  - [ ] Define `LEDFrame` interface
  - [ ] Export in `src/types/index.ts`

- [ ] **Task 3: Create VisualizationMode Types** (AC: 2, 4)
  - [ ] Create `src/types/visualizationMode.ts`
  - [ ] Define `VisualizationMode` type
  - [ ] Define `COMPATIBILITY_MATRIX` constant
  - [ ] Implement `checkNotePerLedCompatibility()` function
  - [ ] Export in `src/types/index.ts`

- [ ] **Task 4: Create LEDCompositor Service** (AC: 1, 3, 4)
  - [ ] Create `src/services/` directory (if doesn't exist)
  - [ ] Create `src/services/LEDCompositor.ts`
  - [ ] Implement frame buffer (Map<deviceId, Map<moduleId, LEDFrame>>)
  - [ ] Implement `submitFrame()` method
  - [ ] Implement `clearModuleFrame()` method
  - [ ] Implement `checkCompatibility()` method (uses COMPATIBILITY_MATRIX)
  - [ ] Implement `compositeFrames()` method (pixel-by-pixel blending)
  - [ ] Implement `setBlendMode()` method
  - [ ] Implement rate limiting (30 FPS = 33.3ms minimum between sends)
  - [ ] Add console logging for debugging

- [ ] **Task 5: Create Blend Mode UI Controls** (AC: 5)
  - [ ] Add blend mode state to GlobalMusicContext (or local component state)
  - [ ] Create blend mode dropdown/buttons in appropriate location
  - [ ] Connect to `ledCompositor.setBlendMode()`
  - [ ] Label modes clearly (Multiply [darkens], Screen [lightens], etc.)

- [ ] **Task 6: Create Compatibility Warning UI** (AC: 6)
  - [ ] Create toast/banner component for incompatibility warnings
  - [ ] Connect to compositor incompatibility events
  - [ ] Display clear message: "Cannot blend X + Y (incompatible addressing)"
  - [ ] Suggest solution: "Use separate LED devices"

- [ ] **Task 7: Manual Verification** (AC: 7, 8)
  - [ ] Run dev server
  - [ ] Execute MV1-MV3 checklist
  - [ ] Verify all acceptance criteria met

## Dev Notes

### Architecture Reference
**Primary Document:** `docs/architecture/led-compositor-design.md` (Version 1.0, 472 lines)
- Section A.3: Data Models (LEDFrame, VisualizationMode, BlendMode)
- Section A.4: LEDCompositor Service Implementation
- Section A.7: Integration with Epic 14 Stories

### Key Design Decisions

**Visual Blending vs. Priority Routing:**
- Original approach: Priority-based (latest frame "wins")
- NEW approach: Visual compositing (multiply/screen blending)
- Rationale: Stakeholder (Myles) feedback - users want to see multiple visualizations simultaneously

**Compatibility Detection:**
- Prevents confusing output (Piano 88 LEDs + Guitar 150 LEDs = incompatible)
- COMPATIBILITY_MATRIX defines which modes can blend
- Toggle mode fallback when incompatible

**Blending Modes (MVP - 4 modes):**
- **Multiply**: (base * overlay) / 255 [darkens overlaps] - stakeholder: "most helpful"
- **Screen**: 255 - ((255-base) * (255-overlay)) / 255 [lightens overlaps] - stakeholder: "most helpful"
- **Additive**: min(255, base + overlay) [adds RGB values]
- **Max**: max(base, overlay) per channel [brightest wins]

**Rate Limiting:**
- 30 FPS (33.3ms minimum between sends)
- Prevents UDP packet flooding to WLED devices

### File Locations

**New Files:**
- `src/types/blendMode.ts` (~50 lines)
- `src/types/ledFrame.ts` (~30 lines)
- `src/types/visualizationMode.ts` (~60 lines)
- `src/services/LEDCompositor.ts` (~250 lines)
- Blend mode UI (~30 lines - location TBD)
- Warning UI component (~40 lines - location TBD)

**Total Code:** ~460 lines

### Dependencies

**Builds On:**
- ✅ Story 14.2 (Module Adapter - useModuleContext hook, transport state)

**Blocks:**
- ⏸️ Story 14.3 (PianoRoll - needs compositor.submitFrame() API)
- ⏸️ Story 14.4 (GuitarFretboard - needs compositor.submitFrame() API)
- ⏸️ Story 14.5 (IsometricSequencer - needs compositor.submitFrame() API)

### Testing Strategy

**Manual Testing Only:**
- Browser-based verification (11 minutes)
- Hardware testing recommended (WLED strip required for full validation)
- DevTools console for debugging compositor logic

### Out of Scope (Epic 15+)

**Deferred Features:**
- Audio Input Mode toggle (review existing `/dj-visualizer` work first)
- Per-device blend mode overrides (advanced feature)
- GPU acceleration (WebGL shaders - optimization if needed)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-13 | 1.0 | Initial story creation - LED Compositor Implementation | BMad Orchestrator (PM persona) |

---

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929 (Sonnet 4.5)

### Session Context
- Story created via BMad Orchestrator in Party Mode + YOLO Mode
- LED Compositor design document complete (472 lines)
- Story 14.2 complete (module adapter infrastructure ready)
- Estimated effort: 8-10 hours

**Next Steps After Completion:**
1. Mark Story 14.7 COMPLETE
2. Update Epic 14 file
3. Stories 14.3-14.5 unblocked (can proceed with module refactors)

### Completion Notes
_To be populated when story complete_

---

## QA Results
_To be populated by manual verification workflow_
