# Story 15.6: Module Registry Integration

**Epic:** Epic 15 - Chord Progression & Melody Arranger Module
**Status:** ðŸ“ READY FOR DEVELOPMENT
**Priority:** ðŸŸ¢ LOW
**Complexity:** Low
**Time Estimate:** 2-3 hours
**Prerequisites:** Story 15.5 (GlobalMusicContext Integration)

---

## User Story

As a **music producer**,
I want **ChordMelodyArranger available in the Studio module picker**,
So that **I can easily load it alongside other modules and have my settings persist across sessions**.

---

## Story Context

**Existing System Integration:**
- Integrates with: Studio component (Epic 14), moduleRegistry.ts, localStorage (settings persistence)
- Technology: TypeScript, React, localStorage API
- Follows pattern: Existing module registration (DrumMachine, PianoRoll, etc.)
- Touch points:
  - `src/components/Studio/moduleRegistry.ts` (register ChordMelodyArranger)
  - `src/components/Studio/Studio.tsx` (module lifecycle - already implemented in Story 15.4)
  - `src/components/Studio/modules/ChordMelodyArranger/ChordMelodyArranger.tsx` (settings props)
  - `src/components/Studio/ModulePicker.tsx` (if exists - UI for adding modules)

**Why This Story:**
Stories 15.1-15.5 built the ChordMelodyArranger module. This final story makes it discoverable and usable in the Studio by:
- Registering in moduleRegistry.ts (makes it appear in module picker)
- Defining module capabilities (for routing system - Story 15.4)
- Implementing settings persistence (save/load selected progression, output targets, etc.)

**Key Architectural Decision:**
Follow **existing module registration pattern** from moduleRegistry.ts. ChordMelodyArranger should integrate seamlessly with existing Studio infrastructure (no special cases).

---

## Acceptance Criteria

### Functional Requirements

1. **Register ChordMelodyArranger in moduleRegistry.ts**
   - Add ModuleDefinition entry
   - Define capabilities (canEmitNotes, canEmitChords from Story 15.4)
   - Provide module metadata (name, description, icon, color, category)
   - Example:
     ```typescript
     // src/components/Studio/moduleRegistry.ts
     import { ChordMelodyArranger } from './modules/ChordMelodyArranger/ChordMelodyArranger';
     import { Music } from 'lucide-react';

     export const moduleRegistry: ModuleDefinition[] = [
       // ... existing modules
       {
         id: 'chord-melody-arranger',
         name: 'Chord & Melody Arranger',
         description: 'Compose chord progressions and melodies with scale-aware sequencing',
         component: ChordMelodyArranger,
         icon: Music,
         color: 'primary',
         category: 'sequencer',
         capabilities: {
           canReceiveNotes: false,
           canReceiveChords: false,
           canEmitNotes: true,
           canEmitChords: true,
         },
       },
     ];
     ```

2. **Module Settings Interface**
   - Define settings schema for ChordMelodyArranger
   - Settings to persist:
     ```typescript
     export interface ChordMelodyArrangerSettings {
       selectedProgressionId?: string;        // Roman numeral progression ID
       selectedGenre?: string;                // "Jazz", "Pop", "Rock", etc.
       melodyNotes?: MelodyNote[];            // Sequencer grid state
       outputTargets?: string[];              // Routing targets (Story 15.4)
       showChordBuilder?: boolean;            // UI panel visibility
       showMelodySequencer?: boolean;         // UI panel visibility
     }
     ```

3. **Settings Persistence**
   - Implement settings save/load via localStorage
   - Save settings when user changes progression, adds melody notes, or selects output targets
   - Load settings on module initialization
   - Example:
     ```typescript
     // ChordMelodyArranger.tsx
     useEffect(() => {
       if (settings && onSettingsChange) {
         const currentSettings: ChordMelodyArrangerSettings = {
           selectedProgressionId: selectedProgression?.name,
           selectedGenre,
           melodyNotes: notes,
           outputTargets,
           showChordBuilder,
           showMelodySequencer,
         };

         onSettingsChange(currentSettings);
       }
     }, [
       selectedProgression,
       selectedGenre,
       notes,
       outputTargets,
       showChordBuilder,
       showMelodySequencer,
       settings,
       onSettingsChange
     ]);

     // Load settings on mount
     useEffect(() => {
       if (settings.selectedProgressionId) {
         const service = ChordProgressionService.getInstance();
         const progressions = service.getProgressionsByGenre(settings.selectedGenre || '');
         const progression = progressions.find(p => p.name === settings.selectedProgressionId);
         if (progression) {
           setSelectedProgression(progression);
         }
       }

       if (settings.melodyNotes) {
         setNotes(settings.melodyNotes);
       }

       if (settings.outputTargets) {
         setOutputTargets(settings.outputTargets);
       }
     }, []); // Run once on mount
     ```

4. **Studio Module Picker Integration**
   - ChordMelodyArranger appears in module picker UI
   - Icon: Music (Lucide React)
   - Color: primary-500 (matches theme)
   - Category: Sequencer (grouped with similar modules)
   - Example UI (if ModulePicker component exists):
     ```typescript
     // ModulePicker.tsx (if exists)
     const sequencers = moduleRegistry.filter(m => m.category === 'sequencer');

     <div className="mb-4">
       <h3 className="text-sm font-semibold text-gray-400 mb-2">Sequencers</h3>
       <div className="grid grid-cols-2 gap-2">
         {sequencers.map(module => (
           <button
             key={module.id}
             onClick={() => onModuleSelect(module.id)}
             className="p-4 bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors"
           >
             <module.icon className="w-8 h-8 mb-2" />
             <div className="text-sm font-medium">{module.name}</div>
           </button>
         ))}
       </div>
     </div>
     ```

5. **Module Instance ID Handling**
   - Use ModuleComponentProps.settings.instanceId (passed from Studio.tsx)
   - Ensure unique ID for each loaded instance (e.g., "chord-melody-arranger-1", "chord-melody-arranger-2")
   - Use instanceId for ModuleRoutingService registration (Story 15.4)

### Integration Requirements

6. **Studio Lifecycle Integration**
   - Module loads correctly via Studio.tsx (already implemented in Story 15.4)
   - Module unloads correctly (cleanup: unregister from routing service, save settings)
   - Multiple instances supported (load 2+ ChordMelodyArranger modules simultaneously)

7. **Settings Schema Validation**
   - Validate loaded settings (check for missing/invalid fields)
   - Provide default settings if localStorage corrupted
   - Example:
     ```typescript
     const defaultSettings: ChordMelodyArrangerSettings = {
       selectedProgressionId: undefined,
       selectedGenre: 'Jazz',
       melodyNotes: [],
       outputTargets: [],
       showChordBuilder: true,
       showMelodySequencer: true,
     };

     const loadedSettings = {
       ...defaultSettings,
       ...(settings || {}),
     };
     ```

8. **Error Handling**
   - Invalid selectedProgressionId â†’ Log warning, default to first progression
   - Corrupted melodyNotes â†’ Log error, clear notes
   - Invalid outputTargets (module unloaded) â†’ Filter out invalid IDs
   - localStorage quota exceeded â†’ Log error, skip persistence

### Quality Requirements

9. **Code Quality**
   - TypeScript strict mode compliance
   - JSDoc comments for settings interface
   - Consistent with existing module patterns (DrumMachine, PianoRoll)

10. **User Experience**
    - Settings persist across browser sessions (localStorage)
    - Module state restored when reloading page
    - Clear error messages if settings fail to load
    - No data loss when switching between modules

11. **Developer Experience**
    - Clear settings interface documentation
    - Easy to add new settings fields (extensible schema)
    - Settings debugging via DevTools Console (log loaded settings)

---

## Technical Notes

### Integration Approach

**Module Registry Entry:**
```typescript
// src/components/Studio/moduleRegistry.ts
import { ComponentType } from 'react';
import { ChordMelodyArranger } from './modules/ChordMelodyArranger/ChordMelodyArranger';
import { Music } from 'lucide-react';
import { ModuleCapabilities } from '@/services/moduleRoutingService';

export interface ModuleDefinition {
  id: string;
  name: string;
  description: string;
  component: ComponentType<any>;
  icon: ComponentType<{ className?: string }>;
  color: string;
  category: 'instrument' | 'sequencer' | 'visualizer';
  capabilities: ModuleCapabilities;
}

export const moduleRegistry: ModuleDefinition[] = [
  // ... existing modules (DrumMachine, PianoRoll, etc.)

  {
    id: 'chord-melody-arranger',
    name: 'Chord & Melody Arranger',
    description: 'Compose chord progressions and melodies with scale-aware sequencing. Route output to other modules or MIDI hardware.',
    component: ChordMelodyArranger,
    icon: Music,
    color: 'primary', // Uses theme primary color
    category: 'sequencer',
    capabilities: {
      canReceiveNotes: false,  // Does not receive notes from other modules
      canReceiveChords: false, // Does not receive chords from other modules
      canEmitNotes: true,      // Emits melody notes to routing system
      canEmitChords: true,     // Emits chord events to routing system
    },
  },
];
```

**Settings Interface:**
```typescript
// src/components/Studio/modules/ChordMelodyArranger/types.ts (or inline in ChordMelodyArranger.tsx)
import { MelodyNote } from './MelodySequencer';

/**
 * Settings schema for ChordMelodyArranger module
 * Persisted to localStorage via Studio component
 */
export interface ChordMelodyArrangerSettings {
  /** ID of selected Roman numeral progression (e.g., "Jazz ii-V-I") */
  selectedProgressionId?: string;

  /** Genre filter for progression list (e.g., "Jazz", "Pop", "Rock") */
  selectedGenre?: string;

  /** Melody notes state (16-step sequencer grid) */
  melodyNotes?: MelodyNote[];

  /** Output routing targets (module instance IDs) */
  outputTargets?: string[];

  /** Show/hide chord builder panel */
  showChordBuilder?: boolean;

  /** Show/hide melody sequencer panel */
  showMelodySequencer?: boolean;
}
```

**Settings Persistence Implementation:**
```typescript
// src/components/Studio/modules/ChordMelodyArranger/ChordMelodyArranger.tsx
export const ChordMelodyArranger: React.FC<ModuleComponentProps> = ({
  layout = 'desktop',
  settings = {},
  onSettingsChange,
  onBack,
  embedded = false
}) => {
  const { key, scale, tempo, isPlaying, updateTransportState } = useGlobalMusic();
  const service = ChordProgressionService.getInstance();

  // Default settings
  const defaultSettings: ChordMelodyArrangerSettings = {
    selectedProgressionId: undefined,
    selectedGenre: 'Jazz',
    melodyNotes: [],
    outputTargets: [],
    showChordBuilder: true,
    showMelodySequencer: true,
  };

  // Merge with loaded settings
  const loadedSettings = {
    ...defaultSettings,
    ...(settings || {}),
  };

  // Local state
  const [selectedProgression, setSelectedProgression] = useState<RomanNumeralProgression | null>(null);
  const [selectedGenre, setSelectedGenre] = useState(loadedSettings.selectedGenre);
  const [notes, setNotes] = useState<MelodyNote[]>(loadedSettings.melodyNotes || []);
  const [outputTargets, setOutputTargets] = useState<string[]>(loadedSettings.outputTargets || []);
  const [showChordBuilder, setShowChordBuilder] = useState(loadedSettings.showChordBuilder);
  const [showMelodySequencer, setShowMelodySequencer] = useState(loadedSettings.showMelodySequencer);

  // Load progression from settings on mount
  useEffect(() => {
    if (loadedSettings.selectedProgressionId && loadedSettings.selectedGenre) {
      const progressions = service.getProgressionsByGenre(loadedSettings.selectedGenre);
      const progression = progressions.find(p => p.name === loadedSettings.selectedProgressionId);

      if (progression) {
        setSelectedProgression(progression);
      } else {
        console.warn(`Progression "${loadedSettings.selectedProgressionId}" not found in genre "${loadedSettings.selectedGenre}"`);
      }
    }
  }, []); // Run once on mount

  // Save settings when state changes
  useEffect(() => {
    if (onSettingsChange) {
      const currentSettings: ChordMelodyArrangerSettings = {
        selectedProgressionId: selectedProgression?.name,
        selectedGenre,
        melodyNotes: notes,
        outputTargets,
        showChordBuilder,
        showMelodySequencer,
      };

      onSettingsChange(currentSettings);
    }
  }, [
    selectedProgression,
    selectedGenre,
    notes,
    outputTargets,
    showChordBuilder,
    showMelodySequencer,
    onSettingsChange
  ]);

  // ... rest of component
};
```

**Studio.tsx Settings Persistence (if not already implemented):**
```typescript
// src/components/Studio/Studio.tsx
const STORAGE_KEY = 'centaurus-studio-modules';

interface LoadedModuleInstance {
  instanceId: string;
  moduleId: string;
  settings: Record<string, any>;
}

export const Studio: React.FC = () => {
  const [loadedModules, setLoadedModules] = useState<LoadedModuleInstance[]>([]);
  const routingService = ModuleRoutingService.getInstance();

  // Load modules from localStorage on mount
  useEffect(() => {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      try {
        const parsed: LoadedModuleInstance[] = JSON.parse(saved);
        setLoadedModules(parsed);

        // Register with routing service
        parsed.forEach(instance => {
          const moduleDef = moduleRegistry.find(m => m.id === instance.moduleId);
          if (moduleDef) {
            routingService.registerModule({
              instanceId: instance.instanceId,
              moduleId: instance.moduleId,
              name: moduleDef.name,
              capabilities: moduleDef.capabilities,
            });
          }
        });
      } catch (error) {
        console.error('Failed to load modules from localStorage:', error);
      }
    }
  }, []);

  // Save modules to localStorage when state changes
  useEffect(() => {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(loadedModules));
    } catch (error) {
      console.error('Failed to save modules to localStorage:', error);
    }
  }, [loadedModules]);

  const handleSettingsChange = (instanceId: string, newSettings: Record<string, any>) => {
    setLoadedModules(prev =>
      prev.map(instance =>
        instance.instanceId === instanceId
          ? { ...instance, settings: newSettings }
          : instance
      )
    );
  };

  // ... rest of component
};
```

### Existing Pattern Reference

**Similar Module Registrations:**
- Look at existing modules in `moduleRegistry.ts` (DrumMachine, PianoRoll, etc.)
- Follow same structure: id, name, description, component, icon, color, category, capabilities

**Follow Same Patterns:**
- Settings persistence via localStorage (Studio.tsx)
- ModuleComponentProps interface compliance
- Module capabilities metadata (Story 15.4)

### Key Constraints

**Must Preserve:**
- Existing moduleRegistry structure
- ModuleComponentProps interface (backward compatibility)
- Studio.tsx module loading logic (Story 15.4)

**Must Not:**
- Break existing modules when adding ChordMelodyArranger
- Modify moduleRegistry schema (additive changes only)
- Add external dependencies

**Performance Requirements:**
- localStorage read/write: <10ms
- Settings validation: <5ms
- No UI lag when loading module

---

## Definition of Done

- [ ] ChordMelodyArranger registered in `moduleRegistry.ts`
- [ ] Module capabilities defined (canEmitNotes: true, canEmitChords: true)
- [ ] ChordMelodyArrangerSettings interface created
- [ ] Settings persistence implemented (save/load)
- [ ] Settings validation and default values
- [ ] ChordMelodyArranger appears in Studio module picker UI
- [ ] Module loads correctly from Studio
- [ ] Settings persist across browser sessions (localStorage)
- [ ] Multiple instances supported (load 2+ ChordMelodyArranger modules)
- [ ] Manual browser testing (localhost:5173/studio)
- [ ] Verify module appears in module picker
- [ ] Verify settings persist after page reload
- [ ] No console errors in browser DevTools
- [ ] TypeScript compilation passes (no new errors)

---

## Testing Strategy

### Manual Testing (Per CLAUDE.md Guidelines)

**Test 1: Module Registration**
```bash
# Start dev server
npm run dev

# Navigate to Studio
http://localhost:5173/studio

# Open module picker (e.g., "Add Module" button)

# Verify:
# - ChordMelodyArranger appears in "Sequencers" category
# - Module icon: Music (Lucide React)
# - Module name: "Chord & Melody Arranger"
# - Module description visible on hover/click
```

**Test 2: Module Loading**
```typescript
// In Studio, click "Chord & Melody Arranger" in module picker

// Verify:
# - Module loads successfully
# - UI renders correctly (ChordBuilder, ChordTimeline, MelodySequencer visible)
# - Module header shows "Chord & Melody Arranger"
# - Default settings applied (Jazz genre, no progression selected)
# - No console errors
```

**Test 3: Settings Persistence (Single Session)**
```typescript
// Load ChordMelodyArranger module
// 1. Select chord progression: "Jazz ii-V-I"
// 2. Add melody notes to sequencer grid (e.g., C4, D4, E4 on steps 0, 4, 8)
// 3. Select output target: "Piano Roll 1" (if loaded)
// 4. Change genre filter: Jazz â†’ Pop

// Unload module (click X or "Remove Module")
// Reload module (click "Chord & Melody Arranger" in module picker)

// Verify:
# - Selected progression restored: "Jazz ii-V-I" (NOT Pop!)
# - Melody notes restored: C4, D4, E4 at correct steps
# - Output target restored: "Piano Roll 1" selected
# - Genre filter restored: Pop
# - Playback position reset to 0 (not persisted)
```

**Test 4: Settings Persistence (Across Page Reload)**
```typescript
// Load ChordMelodyArranger module
// Configure settings (progression, melody, output targets)

// Refresh browser page (F5 or Ctrl+R)

// Verify:
# - Studio reloads with ChordMelodyArranger module
# - All settings restored from localStorage
# - Module functional (play/pause/stop work)
# - No console errors
```

**Test 5: Multiple Module Instances**
```typescript
// Load ChordMelodyArranger module (instance 1)
// - Select "Jazz ii-V-I" progression
// - Add melody notes: C4, E4, G4

// Load ChordMelodyArranger module again (instance 2)
// - Select "Pop I-V-vi-IV" progression
// - Add melody notes: D4, F#4, A4

// Verify:
# - Two separate ChordMelodyArranger modules loaded
# - Instance IDs unique ("chord-melody-arranger-1", "chord-melody-arranger-2")
# - Settings independent (changing instance 1 doesn't affect instance 2)
# - Both modules functional (play both simultaneously)

// Reload page (F5)
# - Both instances restored with correct settings
```

**Test 6: Settings Validation**
```typescript
// Manually corrupt localStorage settings in DevTools Console:

localStorage.setItem('centaurus-studio-modules', JSON.stringify([
  {
    instanceId: 'chord-melody-arranger-1',
    moduleId: 'chord-melody-arranger',
    settings: {
      selectedProgressionId: 'INVALID_PROGRESSION',
      melodyNotes: 'INVALID_NOTES', // Should be array
      outputTargets: null, // Should be array
    }
  }
]));

// Reload page

// Verify:
# - Module loads with default settings (graceful degradation)
# - Console warnings logged for invalid settings
# - No crash or white screen
# - User can interact with module normally
```

### Verification Checklist

- âœ… ChordMelodyArranger registered in moduleRegistry.ts
- âœ… Module appears in Studio module picker
- âœ… Module loads correctly
- âœ… Settings persist within session (unload/reload)
- âœ… Settings persist across page reload (localStorage)
- âœ… Multiple instances supported
- âœ… Settings validation and default values work
- âœ… Corrupted settings handled gracefully
- âœ… No console errors
- âœ… TypeScript compilation clean

---

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** localStorage quota exceeded (browser limit 5-10MB)
**Mitigation:**
- Settings schema minimal (~1KB per module instance)
- Test with 10+ modules loaded (simulate quota pressure)
- Catch localStorage.setItem() errors (try/catch)
- Log warning if quota exceeded, continue without persistence
**Rollback:** Disable settings persistence, revert to session-only state

**Secondary Risk:** Settings schema evolution (breaking changes in future)
**Mitigation:**
- Version settings schema (e.g., `settingsVersion: 1`)
- Implement migration logic for future versions
- Validate loaded settings structure (check field types)
- Provide default values for missing fields
**Rollback:** Clear localStorage, start fresh with default settings

**Tertiary Risk:** Multiple instances share same settings (instanceId conflict)
**Mitigation:**
- Ensure Studio.tsx generates unique instanceId (timestamp-based)
- Verify instanceId uniqueness in ModuleRoutingService registration
- Test multiple instances in same session
- Test multiple instances after page reload
**Rollback:** Limit to single instance (remove "Add Module" for already loaded modules)

### Compatibility Verification

- [x] **No breaking changes** - Existing modules unaffected
- [x] **No database changes** - localStorage only (client-side)
- [x] **UI changes additive** - Adds ChordMelodyArranger to module picker
- [x] **Performance impact** - Minimal (<10ms localStorage operations)

---

## Scope Validation

- [x] Story can be completed in **2-3 hours** (one development session)
- [x] Integration approach follows existing patterns (moduleRegistry, localStorage)
- [x] Clear prerequisites (Stories 15.1-15.5 complete)
- [x] No external dependencies required

---

## Deliverables

1. **Module Registry Entry**
   - `src/components/Studio/moduleRegistry.ts` (~20 lines added)
   - ChordMelodyArranger registration with capabilities

2. **Settings Interface**
   - `src/components/Studio/modules/ChordMelodyArranger/types.ts` (~30 lines)
   - ChordMelodyArrangerSettings interface with JSDoc

3. **Settings Persistence**
   - `src/components/Studio/modules/ChordMelodyArranger/ChordMelodyArranger.tsx` (~60 lines changed)
   - Load settings on mount, save settings on state change

4. **Studio Integration (if not already complete)**
   - `src/components/Studio/Studio.tsx` (~40 lines)
   - localStorage read/write for module state

---

## Next Steps After Story 15.6

Once this story is complete, **Epic 15 is COMPLETE**. Next steps:
- **Manual End-to-End Testing:** Full workflow test (load module, compose progression, add melody, route to other modules, reload page)
- **Documentation:** Update Epic 15 status to "âœ… COMPLETE"
- **Future Enhancements (Optional):**
  - Story 15.7: Melody note velocity/duration editing UI
  - Story 15.8: Chord voicing editor (inversions, extensions)
  - Story 15.9: Export progression as MIDI file
  - Story 15.10: Community chord progression sharing

---

## References

- **Epic 15:** `docs/epics/epic-15-chord-melody-arranger.md`
- **Story 15.5:** `docs/stories/15.5-globalmusic-integration.md`
- **Module Registry:** `src/components/Studio/moduleRegistry.ts`
- **Studio Component:** `src/components/Studio/Studio.tsx`
- **localStorage API:** https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage

---

**Story Created:** 2025-01-13
**Story Owner:** PO Agent (Sarah)
**Estimated Completion:** 2-3 hours after start
