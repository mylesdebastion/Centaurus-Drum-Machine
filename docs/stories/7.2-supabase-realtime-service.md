# Story 7.2: Supabase Realtime Service Layer

**Epic:** Epic 7 - Jam Session Backend Infrastructure (Hybrid: Supabase + WebRTC P2P)
**Status:** üìù READY FOR DEVELOPMENT
**Priority:** üî¥ HIGH
**Complexity:** Medium
**Time Estimate:** 4-6 hours
**Prerequisites:** Story 7.1

---

## User Story

As a **developer**,
I want **a client-side service layer for Supabase Realtime with Presence and Broadcast**,
So that **I can enable session creation, participant tracking, and state synchronization for collaborative jam sessions**.

---

## Story Context

**Existing System Integration:**
- Integrates with: `src/lib/supabase.ts` (Story 7.1 Supabase client)
- Technology: Supabase Realtime API (Channels, Presence, Broadcast), TypeScript
- Follows pattern: Service layer pattern (similar to Epic 6 WLED services)
- Touch points: GlobalMusicContext, JamSession UI components

**Why This Story:**
This story creates the foundational service layer that enables real-time collaboration. All subsequent UI integration (Stories 7.3-7.4) and WebRTC audio (Story 7.5) depend on this service. Without this layer, sessions cannot be created, joined, or synchronized.

---

## Acceptance Criteria

### Functional Requirements

1. **SupabaseSessionService Class Created**
   - File: `src/services/supabaseSession.ts`
   - Core methods implemented:
     ```typescript
     class SupabaseSessionService {
       private channel: RealtimeChannel | null;
       private supabase: SupabaseClient;

       async createSession(userName: string): Promise<string>
       async joinSession(roomCode: string, userName: string): Promise<void>
       async leaveSession(): Promise<void>

       // Presence (participant list)
       onPresenceSync(callback: (participants: Participant[]) => void): void

       // Broadcast (state sync)
       onTempoChange(callback: (tempo: number) => void): void
       onPlaybackChange(callback: (isPlaying: boolean) => void): void
       broadcastTempo(tempo: number): Promise<void>
       broadcastPlayback(isPlaying: boolean): Promise<void>
     }
     ```

2. **Room Code Generator Implemented**
   - File: `src/utils/roomCodeGenerator.ts`
   - Generates 6-character alphanumeric codes
   - Avoids confusing characters (0/O, 1/I, etc.)
   - Client-side generation (no database required for MVP)
   - Example output: `ABC123`, `XYZ789`, `QWE456`

3. **Presence API Integration**
   - Track user presence in channel:
     ```typescript
     await channel.track({
       name: userName,
       isHost: true,
       joinedAt: new Date().toISOString()
     });
     ```
   - Listen for presence changes (join/leave)
   - Parse presence state into `Participant[]` array
   - Handle presence sync events

4. **Broadcast API Integration**
   - Send state changes via broadcast:
     ```typescript
     await channel.send({
       type: 'broadcast',
       event: 'tempo-change',
       payload: { tempo: 120 }
     });
     ```
   - Listen for broadcast events (tempo, playback)
   - Invoke callbacks when events received

5. **Channel Subscription Lifecycle**
   - Handle subscription states: `SUBSCRIBED`, `CLOSED`, `CHANNEL_ERROR`
   - Expose connection status to UI
   - Clean up subscriptions on leave
   - Automatic reconnection (built into Supabase client)

6. **TypeScript Type Definitions**
   - File: `src/types/session.ts`
   - Interfaces:
     ```typescript
     interface Participant {
       id: string;        // Presence user key
       name: string;
       isHost: boolean;
       joinedAt: string;  // ISO timestamp
     }

     interface SessionState {
       tempo: number;
       isPlaying: boolean;
     }
     ```

### Integration Requirements

7. **Supabase Client Integration**
   - Import and use client from `src/lib/supabase.ts`
   - No additional Supabase initialization needed
   - Service is singleton (one instance per app)

8. **Error Handling**
   - Throw clear errors for:
     - Channel subscription failures
     - Invalid room codes
     - Network errors
   - Include error messages for debugging

9. **Connection Status Tracking**
   - Expose `connectionStatus` property: `'connected' | 'connecting' | 'disconnected'`
   - Update status based on channel state
   - Allow UI to subscribe to status changes

### Quality Requirements

10. **Code Organization**
    - Service encapsulates all Supabase Realtime logic
    - No direct Supabase calls in UI components (use service methods)
    - Clear separation of concerns (Presence, Broadcast, Channels)

11. **Documentation**
    - JSDoc comments for all public methods
    - Inline comments for complex logic (Presence state parsing)
    - Usage examples in service file header

12. **Type Safety**
    - All methods have proper TypeScript types
    - No `any` types used
    - Interfaces exported for use in components

---

## Technical Notes

**Integration Approach:**
- Service is instantiated once and shared across components (singleton pattern)
- Channel name format: `jam-session:${roomCode}` (e.g., `jam-session:ABC123`)
- Presence user key: Auto-generated UUID (Supabase handles this)

**Existing Pattern Reference:**
- Follow singleton service pattern similar to `src/utils/audioEngine.ts`
- TypeScript interfaces similar to `src/types/index.ts`

**Key Constraints:**
- Must work with Supabase free tier (200 concurrent connections)
- No database persistence required for MVP (channels only)
- Room codes are ephemeral (no session history yet)

**Supabase Realtime API Details:**
- **Presence**: Tracks who is online in a channel
- **Broadcast**: Sends ephemeral messages (no database storage)
- **Channels**: Logical grouping for Presence + Broadcast

---

## Definition of Done

- [x] `src/services/supabaseSession.ts` created with `SupabaseSessionService` class
- [x] `src/utils/roomCodeGenerator.ts` created with `generateRoomCode()` function
- [x] `src/types/session.ts` created with `Participant` and `SessionState` interfaces
- [x] `createSession()` method generates room code and subscribes to channel
- [x] `joinSession()` method joins existing channel by room code
- [x] `leaveSession()` method unsubscribes and cleans up
- [x] Presence tracking implemented (`onPresenceSync` callback)
- [x] Broadcast implemented (`onTempoChange`, `onPlaybackChange`, `broadcastTempo`, `broadcastPlayback`)
- [x] Connection status tracking exposed
- [x] Error handling for subscription failures
- [x] TypeScript types defined and exported
- [x] JSDoc comments added to public methods

---

## Testing Strategy

### Manual Testing (Per CLAUDE.md Guidelines)

**Test 1: Room Code Generation**
```typescript
// Run in browser DevTools Console
import { generateRoomCode } from '@/utils/roomCodeGenerator';

console.log(generateRoomCode()); // Should output: ABC123 (example)
console.log(generateRoomCode()); // Should output: XYZ789 (different)
```

**Test 2: Session Creation**
```typescript
// Temporary test in React component
import { supabaseSessionService } from '@/services/supabaseSession';

const testCreateSession = async () => {
  const roomCode = await supabaseSessionService.createSession('Alice');
  console.log('Session created:', roomCode); // Should output: ABC123 (example)
};

testCreateSession();
```

**Test 3: Presence Tracking**
```typescript
// Two browser tabs test
// Tab 1: Create session
const roomCode = await supabaseSessionService.createSession('Alice');

// Tab 2: Join session
await supabaseSessionService.joinSession(roomCode, 'Bob');

// Tab 1: Check presence
supabaseSessionService.onPresenceSync((participants) => {
  console.log('Participants:', participants);
  // Should output: [{ name: 'Alice', isHost: true }, { name: 'Bob', isHost: false }]
});
```

**Test 4: Broadcast State Sync**
```typescript
// Two browser tabs test
// Tab 1: Broadcast tempo change
await supabaseSessionService.broadcastTempo(140);

// Tab 2: Listen for tempo change
supabaseSessionService.onTempoChange((tempo) => {
  console.log('New tempo:', tempo); // Should output: 140
});
```

**Test 5: Connection Status**
```typescript
// Monitor connection status
console.log(supabaseSessionService.connectionStatus); // Should output: 'connected'

// Test reconnection (go offline, then online)
// Status should transition: 'connected' ‚Üí 'disconnected' ‚Üí 'connecting' ‚Üí 'connected'
```

### Verification Checklist

- ‚úÖ Room code generation produces 6-character alphanumeric codes
- ‚úÖ `createSession()` successfully subscribes to new channel
- ‚úÖ `joinSession()` successfully subscribes to existing channel
- ‚úÖ Presence state updates when users join/leave
- ‚úÖ Broadcast messages received by all channel subscribers
- ‚úÖ `leaveSession()` unsubscribes and cleans up presence
- ‚úÖ Connection status reflects actual channel state
- ‚úÖ No errors in browser console during normal operation

---

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** Channel subscription failures due to network issues or invalid room codes
**Mitigation:**
- Clear error messages for subscription failures
- Expose connection status to UI for user feedback
- Built-in Supabase reconnection logic handles transient failures

**Rollback:** Remove service files and TypeScript types, revert Story 7.1 to previous state (no UI changes yet)

**Secondary Risk:** Room code collisions (two sessions generate same code)
**Mitigation:**
- 6-character alphanumeric codes = 2.1 billion combinations (collision probability ~0.0001% with 1000 active sessions)
- If collision occurs, user simply creates new session (unlikely in MVP)
- Future: Add database uniqueness check if needed

**Rollback:** N/A - room codes are ephemeral (no persistence)

### Compatibility Verification

- [x] **No breaking changes** - New service, no existing code modified
- [x] **Database changes** - None (channels only, no database tables)
- [x] **UI changes** - None in this story (Story 7.3 will integrate UI)
- [x] **Performance impact** - Negligible (single WebSocket connection per user)

---

## Scope Validation

- [x] Story can be completed in **4-6 hours** (one focused development session)
- [x] Integration approach is straightforward (Supabase client already configured)
- [x] Follows existing patterns (service layer, TypeScript interfaces)
- [x] No design or architecture work required (API structure defined in Epic 7)

---

## Deliverables

1. **SupabaseSessionService**
   - `src/services/supabaseSession.ts` (~200 lines)
   - Singleton service for session management

2. **Room Code Generator**
   - `src/utils/roomCodeGenerator.ts` (~20 lines)
   - Pure function for generating room codes

3. **TypeScript Types**
   - `src/types/session.ts` (~30 lines)
   - `Participant`, `SessionState` interfaces

4. **Documentation**
   - JSDoc comments in service file
   - Usage examples in file header

---

## Next Steps After Story 7.2

Once this story is complete, proceed to:
- **Story 7.3:** JamSession UI Integration (4-6 hours)
  - Connect existing JamSession UI to SupabaseSessionService
  - Enable real session creation/joining via UI
  - Display real-time participant list

---

## References

- **Epic 7:** `docs/epics/epic-7-jam-session-backend.md`
- **Story 7.1:** `docs/stories/7.1-supabase-setup.md`
- **Supabase Realtime Docs:**
  - Channels: https://supabase.com/docs/guides/realtime/channels
  - Presence: https://supabase.com/docs/guides/realtime/presence
  - Broadcast: https://supabase.com/docs/guides/realtime/broadcast

---

**Story Created:** 2025-10-13
**Story Owner:** Product Manager (John)
**Estimated Completion:** 4-6 hours after start
