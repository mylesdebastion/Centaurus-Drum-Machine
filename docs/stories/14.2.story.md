# Story 14.2: Module Adapter Pattern Implementation

## Status
READY TO START

## Story
**As a** developer,
**I want** core module adapter infrastructure (hooks, interfaces, context detection, transport state),
**so that** modules can intelligently adapt to their execution context (standalone vs. Studio/Jam) and consume global musical parameters with graceful degradation.

## Acceptance Criteria
1. `useModuleContext()` hook created and tested (detects standalone/studio/jam context)
2. TypeScript interfaces for module adapter pattern (`moduleAdapter.ts`)
3. GlobalMusicContext extended with transport state (`isPlaying`, `updateTransportState()`)
4. GlobalMusicHeader extended with Play/Pause transport controls (TransportControls component)
5. AudioEngine extended with transport control methods (`startTransport()`, `stopTransport()`, `isTransportPlaying()`)
6. Manual verification workflow passes (context detection, transport state synchronization)
7. Zero breaking changes to existing routes (standalone views function identically)

## Manual Verification Checklist
- **MV1**: Context detection works correctly
  - [ ] Navigate to `/piano` → `useModuleContext()` returns 'standalone'
  - [ ] Navigate to `/studio` with Piano loaded → `useModuleContext()` returns 'studio'
  - [ ] Navigate to `/jam` with Piano loaded → `useModuleContext()` returns 'jam'
- **MV2**: Transport state synchronization works
  - [ ] Click Play in GlobalMusicHeader → `isPlaying` updates to true
  - [ ] Click Pause → `isPlaying` updates to false
  - [ ] Verify Tone.js Transport state syncs (check DevTools console logs)
- **MV3**: Transport state NOT persisted to localStorage
  - [ ] Start transport (Play) → Refresh page → Transport state resets to paused
  - [ ] Verify localStorage does NOT contain `isPlaying` field
- **MV4**: No breaking changes
  - [ ] All standalone routes load without errors (`/piano`, `/guitar-fretboard`, `/isometric`, `/drum-machine`, `/dj-visualizer`)
  - [ ] Studio/Jam views load without errors
- **MV5**: UI/UX quality
  - [ ] Transport controls visible in GlobalMusicHeader (desktop and mobile)
  - [ ] Play/Pause button has visual feedback (color changes)
  - [ ] Minimum 44px touch target maintained

**Estimated Verification Time:** ~25 minutes

## Tasks / Subtasks

- [ ] **Task 1: Create useModuleContext Hook** (AC: 1)
  - [ ] Create `src/hooks/useModuleContext.ts`
  - [ ] Implement context detection via React Router `useLocation()`
  - [ ] Return 'standalone' | 'studio' | 'jam' based on pathname
  - [ ] Add JSDoc documentation with usage examples
  - [ ] Export ModuleContext type for use in components

- [ ] **Task 2: Create Module Adapter Type Definitions** (AC: 2)
  - [ ] Create `src/types/moduleAdapter.ts`
  - [ ] Define `ModuleContext` type ('standalone' | 'studio' | 'jam')
  - [ ] Define `ModuleAdapterProps` interface (if needed for future module wrappers)
  - [ ] Export all types for use across codebase

- [ ] **Task 3: Extend GlobalMusicContext with Transport State** (AC: 3)
  - [ ] Open `src/contexts/GlobalMusicContext.tsx`
  - [ ] Add `isPlaying: boolean` to `GlobalMusicState` interface
  - [ ] Add `updateTransportState: (playing: boolean) => void` to `GlobalMusicContextValue` interface
  - [ ] Update `DEFAULT_STATE` to include `isPlaying: false`
  - [ ] Implement `updateTransportState()` callback with Tone.js Transport sync
  - [ ] Update `useMemo` dependency array to include `updateTransportState`
  - [ ] Modify `saveStateToLocalStorage()` to EXCLUDE `isPlaying` field (in-memory only)
  - [ ] Add console logging for transport state changes

- [ ] **Task 4: Extend AudioEngine with Transport Control Methods** (AC: 5)
  - [ ] Open `src/utils/audioEngine.ts`
  - [ ] Add `startTransport()` method (idempotent, checks Tone.Transport.state)
  - [ ] Add `stopTransport()` method (uses `pause()` not `stop()` to maintain position)
  - [ ] Add `isTransportPlaying()` method (returns boolean)
  - [ ] Add console logging for debugging
  - [ ] Verify existing `syncTransportBPM()` method (no changes needed)

- [ ] **Task 5: Create TransportControls Component** (AC: 4)
  - [ ] Open `src/components/GlobalMusicHeader/GlobalMusicHeader.tsx`
  - [ ] Create `TransportControls` sub-component (Play/Pause button with icon toggle)
  - [ ] Import Lucide icons: `Play`, `Pause`
  - [ ] Implement visual feedback (primary color when paused, accent color when playing)
  - [ ] Add accessibility attributes (aria-label, title)
  - [ ] Ensure 44px minimum touch target

- [ ] **Task 6: Integrate TransportControls into GlobalMusicHeader** (AC: 4)
  - [ ] Add `handleTogglePlay` callback using `updateTransportState()`
  - [ ] Position TransportControls in desktop layout (left side, before TempoControl)
  - [ ] Position TransportControls in mobile layout (after menu button, before tempo display)
  - [ ] Test responsive behavior across breakpoints

- [ ] **Task 7: Manual Verification Workflow** (AC: 6, 7)
  - [ ] Run dev server (`npm run dev`)
  - [ ] Execute Manual Verification Checklist (MV1-MV5)
  - [ ] Test all standalone routes for breaking changes
  - [ ] Test Studio/Jam views with transport controls
  - [ ] Verify localStorage exclusion (transport state not persisted)
  - [ ] Check DevTools console for proper logging

- [ ] **Task 8: Documentation Updates** (AC: 7)
  - [ ] Update architecture document reference (if needed)
  - [ ] Add inline code comments for transport state logic
  - [ ] Document any edge cases discovered during testing

## Dev Notes

### Architecture Reference
**Primary Document:** `docs/architecture/brownfield-module-refactoring.md`
- Section 5.1: useModuleContext Hook Design (lines 765-830)
- Section 5.2: GlobalMusicContext Extension (lines 832-976)
- Section 5.3: AudioEngine Extension (lines 978-1037)
- Section 5.4: Module Refactoring Pattern (lines 1039-1161)
- Section 5.5: GlobalMusicHeader Extension (lines 1163-1319)
- Section 5.6: Component Interaction Diagram (lines 1321-1450)

### Key Design Decisions

**Context Detection Pattern:**
- Uses React Router `useLocation()` for pathname-based detection
- No prop drilling required
- Simple, testable, zero new dependencies

**Transport State Storage:**
- In-memory only (NOT persisted to localStorage)
- Prevents confusing "auto-play on reload" behavior
- Users expect DAWs to start paused

**Transport Control Methods:**
- `startTransport()` uses Tone.Transport.start() (idempotent)
- `stopTransport()` uses Tone.Transport.pause() (NOT stop() - maintains playback position)
- Console logging aids manual debugging

**Graceful Degradation:**
- Modules detect context and fallback to local state when standalone
- No breaking changes to existing routes
- Conditional rendering hides redundant controls when embedded

### File Locations

**New Files:**
- `src/hooks/useModuleContext.ts` (~80 lines)
- `src/types/moduleAdapter.ts` (~50 lines)

**Modified Files:**
- `src/contexts/GlobalMusicContext.tsx` (~30 lines added)
- `src/components/GlobalMusicHeader/GlobalMusicHeader.tsx` (~80 lines added)
- `src/utils/audioEngine.ts` (~50 lines added)

**Total Code:** ~290 lines added

### Dependencies

**Builds On:**
- ✅ Story 14.1 (Architecture design COMPLETE)
- ✅ Epic 4 Stories 4.1-4.7 (GlobalMusicContext foundation COMPLETE)

**Blocks:**
- ⏸️ Story 14.7 (LED Compositor needs useModuleContext hook)
- ⏸️ Story 14.3 (PianoRoll refactor needs module adapter infrastructure)
- ⏸️ Story 14.4 (GuitarFretboard refactor needs module adapter infrastructure)
- ⏸️ Story 14.5 (IsometricSequencer refactor needs module adapter infrastructure)

### Testing Strategy

**Manual Testing Focus:**
- Context detection verification (10 min)
- Transport state synchronization (10 min)
- Responsive design verification (5 min)

**No Automated Tests Required:**
- Small-scale project uses manual verification per CLAUDE.md guidelines
- Browser DevTools for debugging
- Visual/audio inspection sufficient

### Edge Cases

**Transport State:**
- Visualizers (LiveAudioVisualizer) ignore transport state (always-on for live audio)
- Modules can have local play/pause for performance flexibility (DJ use case)
- Transport state NOT saved to localStorage (always starts paused on reload)

**Context Detection:**
- Future routes (e.g., `/rehearsal`, `/collab`) default to 'standalone' until explicitly handled
- Jam session with query params (`/jam?session=abc123`) correctly detected as 'jam'

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-13 | 1.0 | Initial story creation - Module Adapter Pattern Implementation | BMad Orchestrator (Winston/PM personas) |

---

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929 (Sonnet 4.5)

### Debug Log References
None - Infrastructure implementation (no existing bugs to fix)

### Session Context

**Story Creation:**
- Created via BMad Orchestrator in Party Mode + YOLO Mode
- Architecture document (Story 14.1) COMPLETE and reviewed
- Story 14.2 unblocked and ready for implementation

**Implementation Approach:**
1. Create hooks and types (Tasks 1-2) - Foundation (~1-2 hours)
2. Extend existing services (Tasks 3-4) - GlobalMusicContext + AudioEngine (~2-3 hours)
3. Create UI components (Tasks 5-6) - TransportControls + integration (~2-3 hours)
4. Manual verification (Task 7) - Browser testing (~25 minutes)
5. Documentation updates (Task 8) - Inline comments (~30 minutes)

**Estimated Total Effort:** 8-10 hours (medium complexity)

**Next Steps After Completion:**
1. Mark Story 14.2 COMPLETE
2. Update Epic 14 file (Story 14.2 status)
3. Create Story 14.7 detailed implementation file (LED Compositor)
4. Begin Story 14.7 implementation

### Resumability Instructions

**If session interrupted:**
1. Read this story file (`docs/stories/14.2.story.md`)
2. Read architecture document Section 5 (`docs/architecture/brownfield-module-refactoring.md` lines 751-1450)
3. Check task checklist above for completed items
4. Continue from first unchecked task

**Manual Verification:**
- Dev server should be running at `http://localhost:5173` (per CLAUDE.md default workflow)
- Use browser DevTools for console log verification
- Test all routes listed in MV4 checklist

### Completion Notes
_To be populated when story complete_

---

## QA Results
_To be populated by manual verification workflow_

**QA Checklist (when ready):**
- [ ] All Manual Verification items (MV1-MV5) passed
- [ ] Context detection accurate across all routes
- [ ] Transport state synchronization working (Tone.js + React state)
- [ ] Transport state NOT persisted (localStorage check)
- [ ] No breaking changes (all existing routes functional)
- [ ] UI/UX quality standards met (44px touch targets, visual feedback, responsive)
- [ ] Console logs verify transport state changes
- [ ] Story marked COMPLETE in task checklist

