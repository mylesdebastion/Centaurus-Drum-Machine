# Story 15.5: GlobalMusicContext Integration

**Epic:** Epic 15 - Chord Progression & Melody Arranger Module
**Status:** üìù READY FOR DEVELOPMENT
**Priority:** üü° MEDIUM
**Complexity:** Medium
**Time Estimate:** 3-4 hours
**Prerequisites:** Story 15.4 (Module Routing System)

---

## User Story

As a **music producer**,
I want **ChordMelodyArranger to automatically sync with global key/scale/tempo changes**,
So that **all modules stay in harmony when I adjust musical parameters via GlobalMusicHeader**.

---

## Story Context

**Existing System Integration:**
- Integrates with: GlobalMusicContext (Epic 4), ChordMelodyArranger (Stories 15.2-15.4), ChordProgressionService (Story 15.1)
- Technology: React Context API, useEffect hooks, TypeScript
- Follows pattern: Existing GlobalMusicContext consumers (PianoRoll, GuitarFretboard, etc.)
- Touch points:
  - `src/components/Studio/modules/ChordMelodyArranger/ChordMelodyArranger.tsx` (integrate context)
  - `src/components/Studio/modules/ChordMelodyArranger/MelodySequencer.tsx` (scale-aware filtering)
  - `src/components/Studio/modules/ChordMelodyArranger/ChordBuilder.tsx` (chord transposition)
  - `src/contexts/GlobalMusicContext.tsx` (read-only access)
  - `src/services/chordProgressionService.ts` (transpose methods - already implemented)

**Why This Story:**
Stories 15.2-15.4 built ChordMelodyArranger with hardcoded or local state for key/scale/tempo. This story connects the module to GlobalMusicContext, enabling:
- Automatic chord transposition when key changes (C major ‚Üí D major)
- Melody notes filtered to new scale automatically
- Tempo sync with GlobalMusicHeader tempo slider
- Transport state sync (play/pause/stop buttons)

**Key Architectural Decision:**
Use **read-only** access to GlobalMusicContext (via `useGlobalMusic()` hook). ChordMelodyArranger subscribes to context changes but does NOT mutate global state (follows existing pattern from PianoRoll, GuitarFretboard).

---

## Acceptance Criteria

### Functional Requirements

1. **ChordMelodyArranger GlobalMusicContext Integration**
   - Import `useGlobalMusic()` hook
   - Subscribe to key, scale, tempo, isPlaying, transport state
   - Remove local state for these values (use context values)
   - Example:
     ```typescript
     // ChordMelodyArranger.tsx
     import { useGlobalMusic } from '@/contexts/GlobalMusicContext';

     export const ChordMelodyArranger: React.FC<ModuleComponentProps> = (props) => {
       const { key, scale, tempo, isPlaying, updateTransportState } = useGlobalMusic();
       const service = ChordProgressionService.getInstance();

       // Remove local state:
       // const [tempo, setTempo] = useState(120); // DELETE
       // const [isPlaying, setIsPlaying] = useState(false); // DELETE

       // Use context values directly
       // tempo, isPlaying come from GlobalMusicContext
     };
     ```

2. **Automatic Chord Transposition**
   - When GlobalMusicContext key changes, transpose current chord progression
   - Use ChordProgressionService.resolveRomanNumerals() method
   - Example:
     ```typescript
     const [selectedProgression, setSelectedProgression] = useState<RomanNumeralProgression | null>(null);
     const [currentChords, setCurrentChords] = useState<Chord[]>([]);

     useEffect(() => {
       if (selectedProgression) {
         const resolved = service.resolveRomanNumerals(selectedProgression, key);
         setCurrentChords(resolved.chords);
       }
     }, [selectedProgression, key, service]);
     ```

3. **Scale-Aware Melody Filtering**
   - MelodySequencer receives key/scale from parent component
   - Recalculate visible notes when key/scale changes
   - Clear out-of-scale notes with user confirmation:
     ```typescript
     // MelodySequencer.tsx
     useEffect(() => {
       const newScaleNotes = calculateScaleNotes(key, scale, 2);
       setVisibleNotes(newScaleNotes);

       // Check if existing notes are out of new scale
       const outOfScaleNotes = notes.filter(
         note => !newScaleNotes.includes(note.pitch)
       );

       if (outOfScaleNotes.length > 0) {
         // Confirm before clearing
         const confirmed = window.confirm(
           `${outOfScaleNotes.length} notes are outside the new scale. Remove them?`
         );

         if (confirmed) {
           setNotes(prevNotes =>
             prevNotes.filter(note => newScaleNotes.includes(note.pitch))
           );
         }
       }
     }, [key, scale, notes]);
     ```

4. **Tempo Synchronization**
   - Read tempo from GlobalMusicContext (not local state)
   - Pass tempo to ChordTimeline and MelodySequencer components
   - Update playback timing when tempo changes:
     ```typescript
     // ChordMelodyArranger.tsx
     const { tempo } = useGlobalMusic();

     // Pass to child components
     <ChordTimeline tempo={tempo} ... />
     <MelodySequencer tempo={tempo} ... />
     ```

5. **Transport State Integration**
   - Read isPlaying from GlobalMusicContext
   - Map transport controls to GlobalMusicContext methods:
     - Play button ‚Üí `updateTransportState(true)`
     - Pause button ‚Üí `updateTransportState(false)`
     - Stop button ‚Üí `updateTransportState(false)` + reset playback position
   - Example:
     ```typescript
     const { isPlaying, updateTransportState } = useGlobalMusic();
     const [playbackPosition, setPlaybackPosition] = useState(0);

     const handlePlay = () => {
       updateTransportState(true);
     };

     const handlePause = () => {
       updateTransportState(false);
     };

     const handleStop = () => {
       updateTransportState(false);
       setPlaybackPosition(0);
     };
     ```

### Integration Requirements

6. **ChordBuilder GlobalMusicContext Integration**
   - Pass key prop from parent ChordMelodyArranger
   - Update "Current Key" display to show GlobalMusicContext key
   - Example:
     ```typescript
     // ChordBuilder.tsx
     export const ChordBuilder: React.FC<ChordBuilderProps> = ({
       selectedProgression,
       onProgressionSelect,
       currentKey // NEW: from GlobalMusicContext
     }) => {
       return (
         <div>
           <div className="text-sm text-gray-400 mb-2">
             Current Key: {currentKey}
           </div>
           {/* ... rest of component */}
         </div>
       );
     };
     ```

7. **MelodySequencer GlobalMusicContext Integration**
   - Receive key, scale, tempo props from parent
   - Use key/scale to calculate visible notes (scale-aware filtering)
   - Use tempo for playback timing calculations

8. **Backward Compatibility**
   - ChordMelodyArranger should work if GlobalMusicContext is not available (graceful degradation)
   - Default to C major, 120 BPM, stopped state if context unavailable
   - Example:
     ```typescript
     const { key = 'C', scale = 'major', tempo = 120, isPlaying = false, updateTransportState = () => {} } = useGlobalMusic() || {};
     ```

### Quality Requirements

9. **Performance**
   - Context subscription overhead: <1ms per render
   - Chord transposition on key change: <10ms (use ChordProgressionService)
   - Scale filtering recalculation: <5ms
   - No unnecessary re-renders (use React.memo, useMemo, useCallback)

10. **User Experience**
    - Smooth transitions when key/scale/tempo changes
    - No audio glitches during live parameter changes
    - Visual feedback when transport state changes (play/pause button states)
    - Confirmation dialog before clearing out-of-scale notes

11. **Developer Experience**
    - Clear JSDoc comments for context integration
    - TypeScript strict mode compliance
    - No console warnings about missing context

---

## Technical Notes

### Integration Approach

**ChordMelodyArranger Context Integration:**
```typescript
// src/components/Studio/modules/ChordMelodyArranger/ChordMelodyArranger.tsx
import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { useGlobalMusic } from '@/contexts/GlobalMusicContext';
import { ChordProgressionService } from '@/services/chordProgressionService';

export const ChordMelodyArranger: React.FC<ModuleComponentProps> = ({
  layout = 'desktop',
  settings = {},
  onSettingsChange,
  onBack,
  embedded = false
}) => {
  // GlobalMusicContext integration
  const {
    key,
    scale,
    tempo,
    isPlaying,
    updateTransportState
  } = useGlobalMusic();

  const service = ChordProgressionService.getInstance();

  // Local state
  const [selectedProgression, setSelectedProgression] = useState<RomanNumeralProgression | null>(null);
  const [currentChords, setCurrentChords] = useState<Chord[]>([]);
  const [playbackPosition, setPlaybackPosition] = useState(0);
  const [outputTargets, setOutputTargets] = useState<string[]>([]);

  // Automatically transpose chords when key changes
  useEffect(() => {
    if (selectedProgression) {
      const resolved = service.resolveRomanNumerals(selectedProgression, key);
      setCurrentChords(resolved.chords);
    }
  }, [selectedProgression, key, service]);

  // Playback loop (requestAnimationFrame)
  useEffect(() => {
    if (!isPlaying) return;

    let animationFrame: number;
    const startTime = performance.now();

    const updatePlayback = () => {
      const elapsed = (performance.now() - startTime) / 1000; // seconds
      const beatsPerSecond = tempo / 60;
      const totalBeats = 16; // 16 steps
      const position = (elapsed * beatsPerSecond) % totalBeats;

      setPlaybackPosition(position / totalBeats); // 0-1

      animationFrame = requestAnimationFrame(updatePlayback);
    };

    updatePlayback();

    return () => cancelAnimationFrame(animationFrame);
  }, [isPlaying, tempo]);

  // Transport controls
  const handlePlay = useCallback(() => {
    updateTransportState(true);
  }, [updateTransportState]);

  const handlePause = useCallback(() => {
    updateTransportState(false);
  }, [updateTransportState]);

  const handleStop = useCallback(() => {
    updateTransportState(false);
    setPlaybackPosition(0);
  }, [updateTransportState]);

  return (
    <div className="flex flex-col h-full bg-gray-900 text-white">
      {/* Module Header */}
      <div className="flex items-center justify-between p-4 border-b border-gray-700">
        <h2 className="text-xl font-semibold">Chord & Melody Arranger</h2>
        <div className="flex items-center gap-2">
          <span className="text-sm text-gray-400">Key: {key} {scale}</span>
          <OutputSelector
            sourceInstanceId={settings.instanceId || 'chord-melody-arranger'}
            selectedTargets={outputTargets}
            onTargetsChange={setOutputTargets}
          />
        </div>
      </div>

      {/* Transport Controls */}
      <div className="flex items-center gap-2 p-4 border-b border-gray-700">
        <button
          onClick={handlePlay}
          disabled={isPlaying}
          className="p-2 bg-primary-600 hover:bg-primary-500 disabled:bg-gray-600 rounded-lg transition-colors"
        >
          <Play className="w-5 h-5" />
        </button>
        <button
          onClick={handlePause}
          disabled={!isPlaying}
          className="p-2 bg-gray-700 hover:bg-gray-600 disabled:bg-gray-800 rounded-lg transition-colors"
        >
          <Pause className="w-5 h-5" />
        </button>
        <button
          onClick={handleStop}
          className="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors"
        >
          <Square className="w-5 h-5" />
        </button>
        <span className="text-sm text-gray-400 ml-4">{tempo} BPM</span>
      </div>

      {/* Chord Builder */}
      <ChordBuilder
        selectedProgression={selectedProgression}
        onProgressionSelect={setSelectedProgression}
        currentKey={key}
      />

      {/* Chord Timeline */}
      <ChordTimeline
        chords={currentChords}
        playbackPosition={playbackPosition}
        tempo={tempo}
        isPlaying={isPlaying}
      />

      {/* Melody Sequencer */}
      <MelodySequencer
        playbackPosition={playbackPosition}
        isPlaying={isPlaying}
        tempo={tempo}
        currentKey={key}
        currentScale={scale}
        onNoteEvent={handleMelodyNote}
      />
    </div>
  );
};
```

**MelodySequencer Context Integration:**
```typescript
// src/components/Studio/modules/ChordMelodyArranger/MelodySequencer.tsx
export interface MelodySequencerProps {
  playbackPosition: number;
  isPlaying: boolean;
  tempo: number;
  currentKey: string;    // NEW: from GlobalMusicContext
  currentScale: string;  // NEW: from GlobalMusicContext
  onNoteEvent?: (note: MelodyNote) => void;
}

export const MelodySequencer: React.FC<MelodySequencerProps> = ({
  playbackPosition,
  isPlaying,
  tempo,
  currentKey,
  currentScale,
  onNoteEvent
}) => {
  const [notes, setNotes] = useState<MelodyNote[]>([]);
  const [visibleNotes, setVisibleNotes] = useState<number[]>([]);

  // Recalculate visible notes when key/scale changes
  useEffect(() => {
    const newScaleNotes = calculateScaleNotes(currentKey, currentScale, 2);
    setVisibleNotes(newScaleNotes);

    // Check for out-of-scale notes
    const outOfScaleNotes = notes.filter(
      note => !newScaleNotes.includes(note.pitch)
    );

    if (outOfScaleNotes.length > 0) {
      const confirmed = window.confirm(
        `${outOfScaleNotes.length} notes are outside the new scale (${currentKey} ${currentScale}). Remove them?`
      );

      if (confirmed) {
        setNotes(prevNotes =>
          prevNotes.filter(note => newScaleNotes.includes(note.pitch))
        );
      }
    }
  }, [currentKey, currentScale]); // Only re-run when key/scale changes

  // ... rest of component
};
```

### Existing Pattern Reference

**Similar GlobalMusicContext Consumers:**
- `src/components/PianoRoll/PianoRoll.tsx` (if exists) - key/scale integration
- `src/components/GuitarFretboard/GuitarFretboard.tsx` - chord transposition
- `src/components/DrumMachine/DrumMachine.tsx` (if exists) - tempo integration

**Follow Same Patterns:**
- Read-only context access (no mutations from modules)
- useEffect with key/scale/tempo dependencies
- useMemo/useCallback for performance optimization
- Graceful degradation if context unavailable

### Key Constraints

**Must Preserve:**
- GlobalMusicContext API (read-only access, no modifications)
- ChordProgressionService transposition logic (Story 15.1)
- Module independence (no direct GlobalMusicContext imports in service layers)

**Must Not:**
- Modify GlobalMusicContext state directly (use updateXXX methods only)
- Break existing GlobalMusicContext consumers (backward compatible)
- Add external dependencies

**Performance Requirements:**
- Context subscription overhead: <1ms per render
- Chord transposition: <10ms (ChordProgressionService)
- Scale filtering: <5ms
- No unnecessary re-renders

---

## Definition of Done

- [ ] ChordMelodyArranger imports and uses `useGlobalMusic()` hook
- [ ] Local state removed (tempo, isPlaying) - replaced with context values
- [ ] Automatic chord transposition on key change (useEffect)
- [ ] MelodySequencer scale-aware filtering on key/scale change
- [ ] Tempo synchronization (read from context, pass to components)
- [ ] Transport controls integrated (Play/Pause/Stop ‚Üí updateTransportState)
- [ ] ChordBuilder displays current key from context
- [ ] Out-of-scale note confirmation dialog implemented
- [ ] Backward compatibility (graceful degradation if context unavailable)
- [ ] Performance optimized (useMemo, useCallback, React.memo)
- [ ] Manual browser testing (localhost:5173/studio)
- [ ] Verify key change transposes chords correctly (C ‚Üí D major)
- [ ] Verify tempo slider updates playback speed
- [ ] Verify transport controls sync with GlobalMusicHeader
- [ ] No console errors in browser DevTools
- [ ] TypeScript compilation passes (no new errors)

---

## Testing Strategy

### Manual Testing (Per CLAUDE.md Guidelines)

**Test 1: Key/Scale Change Chord Transposition**
```bash
# Start dev server
npm run dev

# Navigate to Studio
http://localhost:5173/studio

# Load ChordMelodyArranger module
# Select chord progression (e.g., "Jazz ii-V-I")

# Open GlobalMusicHeader
# Change key: C major ‚Üí D major

# Verify:
# - ChordBuilder displays "Current Key: D"
# - Current chords transpose (Cmaj7 ‚Üí Dmaj7, Am7 ‚Üí Bm7, etc.)
# - No console errors
# - Transposition completes in <10ms (check Performance tab)
```

**Test 2: Scale Change Melody Filtering**
```typescript
// In MelodySequencer, add notes: C4, D4, E4, F4, G4, A4, B4 (C major scale)

// Change key/scale via GlobalMusicHeader:
// C major ‚Üí C minor

// Verify:
# - Confirmation dialog appears: "3 notes are outside the new scale (C minor). Remove them?"
# - If confirmed ‚Üí E4, A4, B4 removed (not in C minor: C D Eb F G Ab Bb)
# - If canceled ‚Üí Notes remain but grayed out (optional visual)
# - New notes filtered to C minor scale only
```

**Test 3: Tempo Synchronization**
```typescript
// Load ChordMelodyArranger, add melody notes
// Click Play

// Open GlobalMusicHeader
// Adjust tempo slider: 120 BPM ‚Üí 80 BPM ‚Üí 160 BPM

// Verify:
# - Playback speed changes immediately
# - Playback cursor animation speed adjusts
# - Note timing accurate at all tempos (¬±5ms)
# - No audio glitches during tempo change
```

**Test 4: Transport State Integration**
```typescript
// Scenario 1: Start playback from ChordMelodyArranger
// Click Play in ChordMelodyArranger
// Verify: GlobalMusicHeader transport state shows "Playing"

// Scenario 2: Start playback from GlobalMusicHeader
// Click Play in GlobalMusicHeader
// Verify: ChordMelodyArranger starts playing (playback cursor animates)

// Scenario 3: Stop playback
// Click Stop in either location
// Verify: Both UIs show stopped state, playback position resets to 0
```

**Test 5: Multiple Modules Key Sync**
```typescript
// Load 2 modules: ChordMelodyArranger, GuitarFretboard

// Change key via GlobalMusicHeader: C major ‚Üí G major

// Verify:
# - ChordMelodyArranger transposes chords to G major
# - GuitarFretboard updates fretboard to G major
# - Both modules display "G" as current key
# - Changes happen simultaneously (no lag)
```

**Test 6: Performance Optimization**
```javascript
// Browser DevTools ‚Üí React Developer Tools ‚Üí Profiler

// Record the following sequence:
// 1. Change key 5 times (C ‚Üí D ‚Üí E ‚Üí F ‚Üí G ‚Üí C)
// 2. Change tempo 5 times (120 ‚Üí 90 ‚Üí 150 ‚Üí 100 ‚Üí 120)
// 3. Toggle play/pause 10 times

// Verify:
# - ChordMelodyArranger re-renders only on context changes (not on unrelated updates)
# - useMemo/useCallback prevent unnecessary child re-renders
# - Total render time: <50ms per key/tempo change
# - No memory leaks (stable heap size)
```

### Verification Checklist

- ‚úÖ ChordMelodyArranger uses `useGlobalMusic()` hook
- ‚úÖ Automatic chord transposition on key change
- ‚úÖ Melody notes filtered to current scale
- ‚úÖ Out-of-scale notes cleared with confirmation
- ‚úÖ Tempo synchronization works
- ‚úÖ Transport controls sync with GlobalMusicHeader
- ‚úÖ Key display updated in ChordBuilder
- ‚úÖ Backward compatibility (graceful degradation)
- ‚úÖ Performance optimized (no unnecessary re-renders)
- ‚úÖ No console errors
- ‚úÖ TypeScript compilation clean

---

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** React re-render storm (excessive re-renders on context changes)
**Mitigation:**
- Use useMemo for expensive calculations (scale notes, chord transposition)
- Use useCallback for event handlers (prevent child re-renders)
- Use React.memo for child components (ChordBuilder, MelodySequencer, ChordTimeline)
- Profile with React DevTools Profiler
**Rollback:** Remove useMemo/useCallback (accept slower performance)

**Secondary Risk:** Out-of-scale note clearing loses user work
**Mitigation:**
- Always show confirmation dialog before clearing notes
- Store notes in localStorage for undo (future enhancement)
- Consider "snap to scale" instead of clearing (future enhancement)
- Log warning if user cancels clearing (notes remain but may sound dissonant)
**Rollback:** Disable automatic clearing, show warning only

**Tertiary Risk:** GlobalMusicContext unavailable (context not provided)
**Mitigation:**
- Provide default values in destructuring: `const { key = 'C', ... } = useGlobalMusic() || {}`
- Test in isolation without GlobalMusicProvider
- Log warning if context unavailable
**Rollback:** Revert to local state (pre-Story 15.5 behavior)

### Compatibility Verification

- [x] **No breaking changes** - ChordMelodyArranger API unchanged
- [x] **No database changes** - Client-side state only
- [x] **UI changes additive** - Adds key/scale/tempo display
- [x] **Performance impact** - Minimal (<1ms context subscription overhead)

---

## Scope Validation

- [x] Story can be completed in **3-4 hours** (one development session)
- [x] Integration approach follows existing patterns (useGlobalMusic hook)
- [x] Clear prerequisites (Stories 15.2-15.4 complete)
- [x] No external dependencies required

---

## Deliverables

1. **ChordMelodyArranger Context Integration**
   - `src/components/Studio/modules/ChordMelodyArranger/ChordMelodyArranger.tsx` (~50 lines changed)
   - Import useGlobalMusic, remove local state, add useEffect for transposition

2. **MelodySequencer Context Integration**
   - `src/components/Studio/modules/ChordMelodyArranger/MelodySequencer.tsx` (~40 lines changed)
   - Add currentKey/currentScale props, scale-aware filtering logic

3. **ChordBuilder Context Integration**
   - `src/components/Studio/modules/ChordMelodyArranger/ChordBuilder.tsx` (~10 lines changed)
   - Add currentKey prop, display current key

4. **Performance Optimizations**
   - Add useMemo, useCallback, React.memo where appropriate (~20 lines)

---

## Next Steps After Story 15.5

Once this story is complete, proceed to:
- **Story 15.6:** Module Registry Integration (2-3 hours)
  - Register ChordMelodyArranger in moduleRegistry.ts
  - Add to Studio module picker UI
  - Settings persistence (save/load module state)

---

## References

- **Epic 15:** `docs/epics/epic-15-chord-melody-arranger.md`
- **Story 15.4:** `docs/stories/15.4-module-routing-system.md`
- **GlobalMusicContext:** `src/contexts/GlobalMusicContext.tsx`
- **ChordProgressionService:** `src/services/chordProgressionService.ts`
- **React Context Docs:** https://react.dev/learn/passing-data-deeply-with-context

---

**Story Created:** 2025-01-13
**Story Owner:** PO Agent (Sarah)
**Estimated Completion:** 3-4 hours after start
