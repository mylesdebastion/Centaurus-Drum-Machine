# Story 18.10: WLED Implementation Consolidation

**Epic:** Epic 18 - Intelligent WLED Visualization Routing
**Status:** 📝 PLANNING
**Priority:** 🟡 MEDIUM
**Complexity:** High
**Time Estimate:** 8-10 hours
**Prerequisites:** Story 18.5 (WLED Manager UI - with virtual preview fixed)
**Created:** 2025-10-19

---

## User Story

As a **developer maintaining WLED features**,
I want **one canonical WLED implementation pattern used across the entire application**,
So that **all modules have consistent 1:1 data flow (audio/visual input → virtual preview → physical device) and there's no duplicate/conflicting WLED logic**.

---

## Story Context

### Why This Story

During Story 18.5 implementation, we discovered that multiple WLED implementations exist across the codebase with varying quality:

1. **LEDMatrixManager.tsx** - ✅ CANONICAL (perfect 1:1 data flow, battle-tested)
2. **WLEDDeviceManager.tsx** - ⚠️ LEGACY (functional but pre-Epic 18 pattern)
3. **WLEDManager.tsx + WLEDVirtualPreview.tsx** - ❌ BROKEN (virtual preview doesn't match real-world output)

This creates:
- **Inconsistent UX** - some views have perfect previews, others don't
- **Technical debt** - maintaining multiple approaches
- **Developer confusion** - which pattern to use?
- **Wasted effort** - reimplementing WLED instead of reusing working code

**Strategic Goal:** Consolidate to ONE canonical implementation (LEDMatrixManager) and deprecate/migrate all others.

### Current State
- ✅ LEDMatrixManager works perfectly (used in /dj-visualizer, /education)
- ⚠️ WLEDDeviceManager is legacy (used in GuitarFretboard)
- ❌ WLEDManager needs virtual preview fix (Story 18.5)
- 🔀 Multiple patterns coexisting

### Desired State (After Story 18.10)
- ✅ All modules use canonical LEDMatrixManager pattern
- ✅ Virtual preview matches physical device output (1:1) everywhere
- ✅ Legacy code deprecated with migration guide
- ✅ No duplicate WLED logic
- ✅ Clear documentation for future developers

---

## Architecture Document

**See:** [wled-implementation-consolidation.md](../architecture/wled-implementation-consolidation.md)

This story implements **Phases 2-4** of the consolidation strategy:
- **Phase 1:** Fix Story 18.5 virtual preview (prerequisite)
- **Phase 2:** Deprecate legacy implementations
- **Phase 3:** Migrate GuitarFretboard
- **Phase 4:** Unified WLED API, cleanup

---

## Acceptance Criteria

### Phase 2: Deprecation (2-3 hours)

1. **Mark Legacy Components as @deprecated**
   - Add deprecation notice to `WLEDDeviceManager.tsx`
   - Add deprecation notice to `WLEDDeviceCard.tsx`
   - Include reference to migration guide in comments
   - Add console warnings (non-blocking) when legacy components used

2. **Create Migration Guide**
   - Document: `docs/guides/wled-migration-guide.md`
   - Explain why LEDMatrixManager is canonical
   - Show side-by-side comparison (legacy vs modern)
   - Provide code examples for migration
   - Include data format conversion guide

3. **Backward Compatibility Tests**
   - Verify GuitarFretboard continues working with legacy component
   - Test existing WLED device configurations
   - Document known limitations of legacy approach

### Phase 3: Migrate GuitarFretboard (3-4 hours)

4. **Analyze GuitarFretboard WLED Usage**
   - Understand current data flow: `generateLEDData().hex`
   - Determine if 2D matrix or 1D strip needed
   - Map color generation to LEDMatrixManager format

5. **Implement Migration**
   - Replace WLEDDeviceManager import with LEDMatrixManager
   - Convert hex color array to `RGB[][]` format
   - Update component props and configuration
   - Preserve all existing fretboard visualization features

6. **Verify Functionality**
   - Visual regression test: WLED output unchanged
   - Virtual preview improved (matches LEDMatrixManager quality)
   - No breaking changes for users
   - MIDI input → fretboard → WLED pipeline intact

### Phase 4: Unified API & Cleanup (3-4 hours)

7. **Extract Reusable Utility**
   - Create `src/utils/WLEDMatrixController.ts`
   - Extract core WLED operations from LEDMatrixManager
   - Make React component a thin wrapper around utility
   - Ensure WLEDManager can use same utility

8. **Integrate with Epic 18 Routing**
   - WLEDManager uses LEDMatrixManager pattern for virtual preview
   - Routing matrix uses WLEDMatrixController for device communication
   - Single source of truth for WLED operations

9. **Remove Legacy Code**
   - Delete `src/components/WLED/WLEDDeviceManager.tsx`
   - Delete `src/components/WLED/WLEDDeviceCard.tsx`
   - Remove deprecated imports from codebase
   - Update all documentation references

10. **Documentation Updates**
    - Update architecture docs (Epic 18, Story 18.5)
    - Mark Story 18.10 as complete in Epic 18
    - Add developer guide: "Adding WLED to a New Module"
    - Update component README files

---

## Technical Approach

### Phase 2: Deprecation Strategy

**File:** `src/components/WLED/WLEDDeviceManager.tsx`

```typescript
/**
 * WLED Device Manager Component (LEGACY)
 *
 * @deprecated This component is deprecated as of 2025-10-19
 * Use LEDMatrixManager from LiveAudioVisualizer instead for:
 * - Perfect 1:1 data flow (audio → virtual → physical)
 * - Virtual preview that matches real-world WLED output
 * - Integration with Epic 18 routing matrix
 *
 * Migration Guide: docs/guides/wled-migration-guide.md
 * Canonical Implementation: src/components/LiveAudioVisualizer/LEDMatrixManager.tsx
 * Architecture Doc: docs/architecture/wled-implementation-consolidation.md
 *
 * This component is maintained for backward compatibility only.
 * Active use: GuitarFretboard (will be migrated in Story 18.10)
 */

// Add console warning on mount (dev mode only)
useEffect(() => {
  if (process.env.NODE_ENV === 'development') {
    console.warn(
      '[DEPRECATED] WLEDDeviceManager is deprecated. ' +
      'Use LEDMatrixManager instead. See docs/guides/wled-migration-guide.md'
    );
  }
}, []);
```

### Phase 3: GuitarFretboard Migration

**Current Implementation:**
```typescript
// GuitarFretboard.tsx (BEFORE)
import WLEDDeviceManager from '../WLED/WLEDDeviceManager';

<WLEDDeviceManager
  ledData={generateLEDData().hex}
  layout="desktop"
  storageKey="wled-devices-guitar"
  deviceType="2d-grid"
/>
```

**Data Format Conversion:**
```typescript
// Convert hex array to RGB[][] grid
const generateLEDMatrixData = (): RGB[][] => {
  const hexArray = generateLEDData().hex; // Current format: string[]
  const gridConfig = { width: 6, height: 25 }; // Fretboard grid dimensions

  const grid: RGB[][] = [];
  for (let y = 0; y < gridConfig.height; y++) {
    grid[y] = [];
    for (let x = 0; x < gridConfig.width; x++) {
      const index = y * gridConfig.width + x;
      const hex = hexArray[index] || '#000000';
      grid[y][x] = hexToRgb(hex);
    }
  }
  return grid;
};

const hexToRgb = (hex: string): RGB => {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return { r, g, b };
};
```

**New Implementation:**
```typescript
// GuitarFretboard.tsx (AFTER)
import { LEDMatrixManager } from '../LiveAudioVisualizer/LEDMatrixManager';

<LEDMatrixManager
  onConfigChange={(config) => {
    // Store config for persistence
    localStorage.setItem('wled-guitar-config', JSON.stringify(config));
  }}
  className="mt-4"
/>

// In visualization loop: send to WLED
useEffect(() => {
  if (isPlaying) {
    const matrixData = generateLEDMatrixData();
    const ledManager = (window as any).ledMatrixManager;
    if (ledManager) {
      ledManager.sendToWLED(matrixData);
    }
  }
}, [isPlaying, currentNotes]);
```

### Phase 4: Unified Utility

**Extract to:** `src/utils/WLEDMatrixController.ts`

```typescript
export interface WLEDMatrixConfig {
  width: number;
  height: number;
  ipAddress: string;
  orientation: 'horizontal' | 'vertical';
  serpentine: boolean;
  reverse: boolean;
}

export class WLEDMatrixController {
  private config: WLEDMatrixConfig;
  private ws: WebSocket | null = null;

  constructor(config: WLEDMatrixConfig) {
    this.config = config;
  }

  /**
   * Convert 2D grid to 1D array for WLED (handles serpentine wiring)
   */
  gridToLinear(grid: RGB[][]): RGB[] {
    // Implementation from LEDMatrixManager lines 186-226
  }

  /**
   * Send matrix data to WLED via WebSocket bridge
   */
  sendToWLED(grid: RGB[][]): void {
    // Implementation from LEDMatrixManager lines 231-252
  }

  // ... other utility methods
}
```

**React Component Wrapper:**
```typescript
// LEDMatrixManager.tsx becomes thin wrapper
export const LEDMatrixManager: React.FC<LEDMatrixManagerProps> = (props) => {
  const [controller, setController] = useState<WLEDMatrixController | null>(null);

  useEffect(() => {
    const ctrl = new WLEDMatrixController(config);
    setController(ctrl);
  }, [config]);

  // UI for configuration, preview rendering, etc.
};
```

---

## Dependencies

### Prerequisites
- ✅ **Story 18.5 Fixed:** WLEDManager virtual preview must work correctly first
- ✅ **LEDMatrixManager Working:** Already proven in /dj-visualizer and /education
- ✅ **Issue Documented:** `docs/issues/issue-wled-manager-virtual-preview-problems.md`

### Blocks These Stories
- **Future WLED features** will use canonical pattern
- **Module WLED integration** will reference migration guide

---

## Integration Points

### Files to Deprecate
- `src/components/WLED/WLEDDeviceManager.tsx` - Mark as @deprecated
- `src/components/WLED/WLEDDeviceCard.tsx` - Mark as @deprecated

### Files to Migrate
- `src/components/GuitarFretboard/GuitarFretboard.tsx` - Replace WLEDDeviceManager with LEDMatrixManager

### Files to Create
- `src/utils/WLEDMatrixController.ts` - Extracted utility class
- `docs/guides/wled-migration-guide.md` - Developer migration guide

### Files to Update
- `src/components/LiveAudioVisualizer/LEDMatrixManager.tsx` - Use extracted utility
- `src/components/WLEDManager/WLEDManager.tsx` - Use LEDMatrixManager pattern
- `docs/architecture/wled-implementation-consolidation.md` - Update status
- `docs/epics/epic-18-intelligent-wled-routing.md` - Mark Story 18.10 complete

---

## Testing Strategy

### Manual Verification Steps

**Phase 2: Deprecation Verification**
1. Run dev server (`npm run dev`)
2. Navigate to GuitarFretboard
3. Verify console warning appears (dev mode)
4. Verify GuitarFretboard WLED output still works
5. Check migration guide is accessible

**Phase 3: GuitarFretboard Migration**
1. Open GuitarFretboard before migration
2. Play notes, verify WLED visualization
3. Screenshot/video current behavior (baseline)
4. Apply migration changes
5. Test same notes, verify WLED visualization matches baseline
6. Verify virtual preview now matches physical device
7. Test MIDI input → fretboard → WLED pipeline
8. Test responsive layout (mobile/tablet/desktop)

**Phase 4: Cleanup Verification**
1. Search codebase for `WLEDDeviceManager` imports (should be zero)
2. Search codebase for `WLEDDeviceCard` imports (should be zero)
3. Run build: `npm run build` (should succeed with no errors)
4. Test /dj-visualizer still works (uses LEDMatrixManager)
5. Test /education Lesson 2 still works (uses LEDMatrixManager)
6. Test /wled-manager still works (uses fixed virtual preview)
7. Test GuitarFretboard still works (migrated to LEDMatrixManager)

### Automated Testing (Future)
- Unit tests for `WLEDMatrixController`
- Integration tests for data format conversion
- Visual regression tests for WLED output

---

## Risks and Mitigation

### Risk 1: Breaking GuitarFretboard Functionality
**Impact:** HIGH (critical module)
**Mitigation:**
- Baseline testing before migration (screenshots/video)
- Side-by-side comparison (old vs new implementation)
- Rollback plan: Keep WLEDDeviceManager until migration verified
- Thorough manual testing with MIDI input

### Risk 2: Data Format Conversion Errors
**Impact:** MEDIUM (visual artifacts on WLED)
**Mitigation:**
- Test data format conversion with unit tests
- Visual inspection: hex array → RGB[][] → linear → WLED
- Test serpentine wiring conversion specifically
- Use known good data from LEDMatrixManager as reference

### Risk 3: Performance Regression
**Impact:** LOW (WLED visualization frame rate)
**Mitigation:**
- Profile before/after migration (FPS counter)
- Maintain 60 FPS target (<16ms frame time)
- Test with complex fretboard patterns (many active notes)

### Risk 4: Missing Edge Cases
**Impact:** MEDIUM (unexpected bugs in production)
**Mitigation:**
- Comprehensive manual testing checklist
- Test edge cases: empty grid, single LED, max LEDs
- Test error handling: device offline, WebSocket disconnected
- Monitor console for errors during testing

---

## Definition of Done

- [ ] WLEDDeviceManager marked as @deprecated with comments
- [ ] WLEDDeviceCard marked as @deprecated with comments
- [ ] Console warning added (dev mode only)
- [ ] Migration guide created: `docs/guides/wled-migration-guide.md`
- [ ] Backward compatibility tests passing
- [ ] GuitarFretboard migrated to LEDMatrixManager
- [ ] GuitarFretboard WLED output verified (matches baseline)
- [ ] GuitarFretboard virtual preview improved
- [ ] WLEDMatrixController utility created
- [ ] LEDMatrixManager refactored to use utility
- [ ] WLEDManager integrated with LEDMatrixManager pattern
- [ ] Legacy code removed (WLEDDeviceManager, WLEDDeviceCard)
- [ ] Build succeeds with no errors
- [ ] All WLED views tested (dj-visualizer, education, wled-manager, guitar)
- [ ] Documentation updated (architecture, Epic 18, guides)
- [ ] Story 18.10 marked complete in Epic 18

---

## Deliverables

### Phase 2: Deprecation
1. **Modified Files**
   - `src/components/WLED/WLEDDeviceManager.tsx` (+20 lines, deprecation notice)
   - `src/components/WLED/WLEDDeviceCard.tsx` (+10 lines, deprecation notice)

2. **New Files**
   - `docs/guides/wled-migration-guide.md` (~200 lines)

3. **Tests**
   - Backward compatibility test checklist

### Phase 3: Migration
1. **Modified Files**
   - `src/components/GuitarFretboard/GuitarFretboard.tsx` (~50 lines changed)

2. **Verification**
   - Visual regression baseline (screenshots/video)
   - Migration verification checklist

### Phase 4: Cleanup
1. **New Files**
   - `src/utils/WLEDMatrixController.ts` (~300 lines, extracted utility)

2. **Modified Files**
   - `src/components/LiveAudioVisualizer/LEDMatrixManager.tsx` (~100 lines refactored)
   - `src/components/WLEDManager/WLEDManager.tsx` (~50 lines updated)

3. **Deleted Files**
   - `src/components/WLED/WLEDDeviceManager.tsx` (removed)
   - `src/components/WLED/WLEDDeviceCard.tsx` (removed)

4. **Documentation**
   - `docs/architecture/wled-implementation-consolidation.md` (status updated)
   - `docs/epics/epic-18-intelligent-wled-routing.md` (Story 18.10 marked complete)
   - Developer guide: "Adding WLED to a New Module"

---

## Next Steps After Story 18.10

Once this story is complete:
- **All modules using canonical WLED pattern** - consistent UX
- **No duplicate WLED implementations** - clean codebase
- **Clear developer guidance** - migration guide, architecture docs
- **Ready for future features** - build on solid foundation

Future WLED work can reference:
- **Canonical Implementation:** `src/components/LiveAudioVisualizer/LEDMatrixManager.tsx`
- **Reusable Utility:** `src/utils/WLEDMatrixController.ts`
- **Migration Guide:** `docs/guides/wled-migration-guide.md`
- **Architecture Doc:** `docs/architecture/wled-implementation-consolidation.md`

---

## References

- **Epic 18:** `docs/epics/epic-18-intelligent-wled-routing.md`
- **Architecture:** `docs/architecture/wled-implementation-consolidation.md`
- **Issue:** `docs/issues/issue-wled-manager-virtual-preview-problems.md`
- **Story 18.5:** `docs/stories/18.5-wled-manager-ui.md`
- **Canonical Implementation:** `src/components/LiveAudioVisualizer/LEDMatrixManager.tsx`

---

**Story Created:** 2025-10-19
**Story Owner:** Dev Agent
**Estimated Completion:** 8-10 hours after Story 18.5 fix complete

---

## Notes

### Key Architectural Principle

> **"1:1 Data Flow is Non-Negotiable"**
>
> Audio/Visual Input → Virtual LED Preview → Real-world WLED Output
>
> If the virtual preview doesn't match real-world output, it's not production-ready.

### Why LEDMatrixManager is Canonical

1. **Perfect 1:1 data flow** - virtual preview matches physical device
2. **Battle-tested** - used in DJ Visualizer and Education Mode
3. **Feature-complete** - 2D matrix, serpentine, orientation, reverse
4. **Clean architecture** - clear separation of concerns
5. **Well-documented** - easy to understand and maintain

### Migration Philosophy

- **Preserve backward compatibility** - don't break existing features
- **Deprecate gradually** - give developers time to migrate
- **Document thoroughly** - clear migration path
- **Test rigorously** - verify no regressions
- **Clean up aggressively** - remove legacy code once migration complete

---

## Dev Agent Record

*To be completed during implementation*
