# Story 19.6: Spectrum Mode WLED Visualization (2D LED Matrices)

**Epic:** Education Mode DJ Visualizer Integration (Epic 19)
**Status:** Draft
**Priority:** Medium
**Complexity:** Medium
**Prerequisites:** Story 19.5 complete (1D LED strip support)

---

## Story

**As a** DJ or educator using a 2D WLED LED matrix,
**I want** spectrum visualization rendered as vertical bar charts on the 2D matrix with configurable orientation and flip options,
**so that** I can display frequency visualization optimally for my matrix layout (horizontal vs. vertical, top-to-bottom vs. bottom-to-top).

---

## Background / Context

### Current State (After Story 19.5)
- ✅ **1D LED strip support** - Story 19.5 implements horizontal frequency layout for 1×N configurations
- ✅ **Amplitude → Brightness mapping** - LED brightness represents bar chart height
- ✅ **Color mapping** - LED colors mirror virtual spectrum canvas
- ✅ **Fade-out smoothing** - LEDs fade gradually, no flicker
- ❌ **No 2D matrix support** - Current implementation only handles 1D LED strips (height = 1)
- ❌ **No orientation options** - Bar charts need configurable axis mapping (X or Y as frequency)
- ❌ **No flip/mirror options** - Bar charts need configurable direction (top-to-bottom vs. bottom-to-top)

### Existing Implementation Locations
- **Spectrum rendering:** `src/components/LiveAudioVisualizer/visualizations/SpectrumVisualization.ts`
- **WLED manager:** `src/components/LiveAudioVisualizer/LEDMatrixManager.tsx`
- **Color mapping:** `src/utils/colorMapping.ts`
- **Visualization engine:** `src/components/LiveAudioVisualizer/VisualizationEngine.ts`

### Why 2D Matrix Support is Needed

Story 19.5 handles 1D LED strips (1×90 default) where each LED represents a single frequency bin with brightness representing amplitude. However, **2D LED matrices** (e.g., 16×16, 8×32) require a different rendering approach:

**2D Matrix Visualization Requirements:**
1. **Bar chart rendering** - Each frequency bin should render as a vertical (or horizontal) bar of LEDs
2. **Orientation control** - Define which axis represents frequency (X or Y)
   - **X-axis = frequency:** Vertical bars (like virtual canvas)
   - **Y-axis = frequency:** Horizontal bars (rotated 90°)
3. **Flip/mirror control** - Define bar chart direction
   - **Normal:** Bottom-to-top or left-to-right (amplitude increases "up")
   - **Flipped:** Top-to-bottom or right-to-left (amplitude increases "down")
4. **Compression/scaling** - Adapt virtual canvas bar count to matrix dimensions
   - If matrix width < number of frequency bins, compress/sample bars
   - If matrix width > number of frequency bins, interpolate/stretch bars

[Source: User requirements - "For 2D WLED matrix we can more closely follow the virtual canvas, however we should define the x or y being the height of the bar graph vs the frequency. It should compress to work in either orientation and be able to flip it."]

---

## Acceptance Criteria

### AC 1: 2D Matrix Detection and Rendering
- [ ] Detect 2D LED matrix configuration (height > 1) in LEDMatrixManager
- [ ] When 2D matrix detected, render spectrum as bar charts (not single-row layout)
- [ ] Each frequency bin renders as vertical/horizontal bar of LEDs
- [ ] Bar height/width corresponds to amplitude (matches virtual canvas behavior)
- [ ] Number of bars adapts to matrix dimensions (compression/interpolation)

### AC 2: Orientation Control (X or Y as Frequency Axis)
- [ ] Add `spectrumOrientation` setting: `'vertical'` or `'horizontal'`
- [ ] **Vertical orientation (default):**
  - X-axis = frequency (bass on left, treble on right)
  - Y-axis = amplitude (bars grow bottom-to-top)
  - Matches virtual canvas spectrum visualization
- [ ] **Horizontal orientation:**
  - Y-axis = frequency (bass on bottom, treble on top)
  - X-axis = amplitude (bars grow left-to-right)
  - Rotated 90° from virtual canvas

### AC 3: Flip/Mirror Control
- [ ] Add `spectrumFlip` setting: `boolean` (default: `false`)
- [ ] **Vertical orientation + flip:**
  - Bars grow top-to-bottom (inverted)
- [ ] **Horizontal orientation + flip:**
  - Bars grow right-to-left (inverted)
- [ ] Flip control independent of `LEDMatrixConfig.reverse` (which handles LED wiring)

### AC 4: Color Mapping from Virtual Canvas
- [ ] LED colors match virtual spectrum canvas colors exactly
- [ ] Low frequencies (bass) → red/magenta hues
- [ ] Mid frequencies → green/yellow hues
- [ ] High frequencies (treble) → cyan/blue hues
- [ ] Color transitions smooth across frequency bands
- [ ] Bar height determines LED brightness (same perceptual scaling as Story 19.5)

### AC 5: Compression and Scaling
- [ ] If matrix dimension < number of frequency bins:
  - Sample frequency bins evenly (e.g., 128 bins → 16 matrix columns)
  - Use averaging/peak-picking to preserve important frequency peaks
- [ ] If matrix dimension > number of frequency bins:
  - Interpolate/stretch bars to fill matrix
  - Maintain smooth color transitions
- [ ] Scaling algorithm preserves musical frequency distribution (bass/mid/treble balance)

### AC 6: Education Mode and DJ Visualizer Compatibility
- [ ] 2D matrix rendering works in Education Mode lesson 2 (embedded mode)
- [ ] 2D matrix rendering works in standalone /dj-visualizer route
- [ ] Settings panel includes orientation and flip controls
- [ ] No regression in 1D LED strip support (Story 19.5)
- [ ] Performance maintains 30+ fps WLED output

### AC 7: Testing with Various Matrix Sizes
- [ ] Tested with 16×16 matrix (vertical orientation)
- [ ] Tested with 8×32 matrix (horizontal orientation)
- [ ] Tested with custom sizes (e.g., 12×24, 20×10)
- [ ] Orientation and flip controls work correctly for all sizes
- [ ] Virtual preview accurately represents 2D matrix output

---

## Tasks / Subtasks

### Task 1: Add 2D Matrix Detection Logic (AC: 1)
- [ ] In `VisualizationEngine.ts`, detect 2D matrix configuration from LEDMatrixConfig
- [ ] If `height === 1`: Use 1D LED strip rendering (Story 19.5 implementation)
- [ ] If `height > 1`: Use 2D matrix bar chart rendering (new implementation)
- [ ] Log matrix configuration to console for debugging

### Task 2: Implement 2D Matrix Bar Chart Renderer (AC: 1, 2, 3, 4)
- [ ] Create new method `renderSpectrumTo2DMatrix()` in `SpectrumVisualization.ts`
- [ ] Parameters:
  - `frequencyData: Uint8Array` - FFT spectrum data
  - `matrixWidth: number` - LED matrix width
  - `matrixHeight: number` - LED matrix height
  - `orientation: 'vertical' | 'horizontal'` - Frequency axis
  - `flip: boolean` - Invert bar direction
- [ ] Returns: 2D array `RGB[][]` (grid[y][x] = color)
- [ ] Algorithm:
  - [ ] Determine number of bars (compress/scale based on matrix dimension)
  - [ ] For each bar:
    - [ ] Get frequency bin amplitude
    - [ ] Calculate bar height/width in LEDs
    - [ ] Get color from virtual spectrum color mapping
    - [ ] Fill corresponding LED pixels in grid
  - [ ] Apply orientation (swap X/Y if horizontal)
  - [ ] Apply flip (reverse bar direction if enabled)

### Task 3: Implement Frequency Bin Compression/Scaling (AC: 5)
- [ ] If matrix dimension < number of frequency bins:
  - [ ] Sample bins evenly using stride calculation
  - [ ] Use peak-picking or averaging for each bar
- [ ] If matrix dimension > number of frequency bins:
  - [ ] Interpolate bars using linear or cubic interpolation
  - [ ] Maintain smooth color transitions
- [ ] Test with various matrix sizes (8, 16, 32, 64 wide)
- [ ] Verify bass/mid/treble balance preserved

### Task 4: Add Orientation and Flip Settings (AC: 2, 3)
- [ ] Add to `SpectrumConfig` interface:
  - `spectrumOrientation?: 'vertical' | 'horizontal'` (default: `'vertical'`)
  - `spectrumFlip?: boolean` (default: `false`)
- [ ] Add UI controls to WLED settings panel in `LiveAudioVisualizer.tsx`
- [ ] Pass settings to `renderSpectrumTo2DMatrix()`
- [ ] Save settings to localStorage for persistence

### Task 5: Integrate with LEDMatrixManager (AC: 1)
- [ ] Update `VisualizationEngine.ts` to call `renderSpectrumTo2DMatrix()` for 2D matrices
- [ ] Pass 2D grid to `LEDMatrixManager.sendToWLED()`
- [ ] Ensure grid-to-linear conversion handles 2D spectrum data correctly
- [ ] Verify serpentine wiring pattern works with 2D spectrum bars
- [ ] Test with reverse output option

### Task 6: Test with 16×16 Matrix (Vertical Orientation) (AC: 6, 7)
- [ ] Configure WLED matrix as 16×16
- [ ] Set orientation to `'vertical'` (default)
- [ ] Play drum sounds (kick, snare, hi-hat, tom)
- [ ] Verify vertical bars grow bottom-to-top
- [ ] Verify frequency layout: bass on left, treble on right
- [ ] Verify colors match virtual canvas
- [ ] Test flip option (bars should grow top-to-bottom)

### Task 7: Test with 8×32 Matrix (Horizontal Orientation) (AC: 6, 7)
- [ ] Configure WLED matrix as 8×32
- [ ] Set orientation to `'horizontal'`
- [ ] Play drum sounds (kick, snare, hi-hat, tom)
- [ ] Verify horizontal bars grow left-to-right
- [ ] Verify frequency layout: bass on bottom, treble on top
- [ ] Verify colors match virtual canvas
- [ ] Test flip option (bars should grow right-to-left)

### Task 8: Test in Education Mode Lesson 2 (AC: 6)
- [ ] Navigate to Education Mode lesson 2 (Color & Pitch)
- [ ] Enable WLED output with 2D matrix configuration
- [ ] Test with 16×16 matrix (vertical orientation)
- [ ] Play drums and verify bar chart visualization
- [ ] Test orientation switching (vertical ↔ horizontal)
- [ ] Test flip option
- [ ] Confirm no performance degradation (60fps canvas, 30+ fps WLED)

### Task 9: Regression Testing - 1D LED Strips (AC: 6)
- [ ] Configure WLED as 1×90 LED strip (height = 1)
- [ ] Verify Story 19.5 implementation still works (horizontal frequency layout)
- [ ] Test amplitude → brightness mapping
- [ ] Test fade-out smoothing
- [ ] Confirm no regression from 2D matrix implementation

### Task 10: Regression Testing - DJ Visualizer (AC: 6)
- [ ] Navigate to `/dj-visualizer` route
- [ ] Test 2D matrix rendering with live audio input
- [ ] Test waveform mode (verify no regression)
- [ ] Test ripple mode (verify no regression)
- [ ] Verify settings panel orientation/flip controls work
- [ ] Confirm virtual preview matches WLED output

### Task 11: Performance Profiling (AC: 6)
- [ ] Open DevTools → Performance tab
- [ ] Profile 2D matrix rendering (16×16, 8×32)
- [ ] Verify WLED output maintains 30+ fps
- [ ] Measure WebSocket latency (audio → LED delay)
- [ ] Optimize any bottlenecks (2D grid rendering may be slower than 1D)
- [ ] Document performance metrics in Dev Agent Record

### Task 12: Manual Testing Checklist (AC: 1-7)
- [ ] **2D matrix detection:** height > 1 triggers bar chart rendering
- [ ] **Vertical orientation:** Bars grow bottom-to-top, frequency left-to-right
- [ ] **Horizontal orientation:** Bars grow left-to-right, frequency bottom-to-top
- [ ] **Flip option:** Bars invert direction correctly
- [ ] **Color mapping:** LEDs match virtual canvas colors
- [ ] **Compression:** Large bin count → small matrix adapts correctly
- [ ] **Scaling:** Small bin count → large matrix interpolates smoothly
- [ ] **Education Mode:** Lesson 2 works with 2D matrix
- [ ] **1D regression:** Story 19.5 implementation still works (height = 1)
- [ ] **Performance:** 30+ fps WLED output for 2D matrices

---

## Dev Notes

### Component Architecture

**2D Matrix Spectrum Rendering Pipeline:**
```
Audio Input → FrequencySourceManager → SpectrumVisualization
  ↓
  ├─→ render() → Canvas (2D visualization for UI)
  └─→ IF height === 1: renderSpectrumToLED() → 1D Array (Story 19.5)
      IF height > 1: renderSpectrumTo2DMatrix() → 2D Array (Story 19.6)
       ↓
LEDMatrixManager.sendToWLED()
       ↓
WebSocket Bridge → WLED Device (1×N or M×N configuration)
```

**File Modifications:**
- **SpectrumVisualization.ts** ← ADD `renderSpectrumTo2DMatrix()`
- **VisualizationEngine.ts** ← ADD matrix detection logic
- **LEDMatrixManager.tsx** ← Verify 2D grid handling
- **LiveAudioVisualizer.tsx** ← ADD orientation/flip UI controls

[Source: User requirements, Story 19.5 architecture]

### Orientation and Flip Logic

**Vertical Orientation (X = frequency):**
```typescript
for (let barIndex = 0; barIndex < numBars; barIndex++) {
  const amplitude = getAmplitude(barIndex);
  const barHeight = Math.floor(amplitude * matrixHeight);
  const color = getColorForFrequency(barIndex);

  for (let y = 0; y < barHeight; y++) {
    const ledY = flip ? y : (matrixHeight - 1 - y); // Flip inverts Y
    grid[ledY][barIndex] = applyBrightness(color, amplitude);
  }
}
```

**Horizontal Orientation (Y = frequency):**
```typescript
for (let barIndex = 0; barIndex < numBars; barIndex++) {
  const amplitude = getAmplitude(barIndex);
  const barWidth = Math.floor(amplitude * matrixWidth);
  const color = getColorForFrequency(barIndex);

  for (let x = 0; x < barWidth; x++) {
    const ledX = flip ? (matrixWidth - 1 - x) : x; // Flip inverts X
    grid[barIndex][ledX] = applyBrightness(color, amplitude);
  }
}
```

[Source: Implementation patterns, canvas bar chart rendering]

### Compression and Scaling Algorithms

**Compression (bins > matrix dimension):**
```typescript
const stride = numBins / matrixDimension;
for (let i = 0; i < matrixDimension; i++) {
  const startBin = Math.floor(i * stride);
  const endBin = Math.floor((i + 1) * stride);

  // Peak-picking: use maximum amplitude in range
  let maxAmplitude = 0;
  for (let bin = startBin; bin < endBin; bin++) {
    maxAmplitude = Math.max(maxAmplitude, frequencyData[bin]);
  }

  bars[i] = maxAmplitude;
}
```

**Scaling (bins < matrix dimension):**
```typescript
// Linear interpolation between frequency bins
for (let i = 0; i < matrixDimension; i++) {
  const binPosition = (i / matrixDimension) * numBins;
  const binIndex = Math.floor(binPosition);
  const binFraction = binPosition - binIndex;

  const amplitude1 = frequencyData[binIndex];
  const amplitude2 = frequencyData[Math.min(binIndex + 1, numBins - 1)];

  bars[i] = amplitude1 + (amplitude2 - amplitude1) * binFraction;
}
```

[Source: Signal processing patterns, FFT visualization best practices]

### Configuration Interface

**Add to `LEDMatrixConfig` (LEDMatrixManager.tsx):**
```typescript
export interface LEDMatrixConfig {
  width: number;
  height: number;
  ipAddress: string;
  orientation: 'horizontal' | 'vertical';
  serpentine: boolean;
  reverse: boolean;
  enabled: boolean;

  // ADD THESE for Story 19.6:
  spectrumOrientation?: 'vertical' | 'horizontal'; // Which axis is frequency
  spectrumFlip?: boolean; // Invert bar direction
}
```

**UI Controls (LiveAudioVisualizer.tsx settings panel):**
```tsx
{config.height > 1 && (
  <>
    <div>
      <label>Spectrum Orientation</label>
      <select value={config.spectrumOrientation || 'vertical'}>
        <option value="vertical">Vertical Bars (X = Frequency)</option>
        <option value="horizontal">Horizontal Bars (Y = Frequency)</option>
      </select>
    </div>
    <div>
      <input type="checkbox" checked={config.spectrumFlip || false} />
      <label>Flip Bar Direction</label>
    </div>
  </>
)}
```

[Source: Component patterns, settings panel patterns]

### Technology Stack
- **React:** 18.2.0 (functional components with hooks)
- **TypeScript:** 5.2.2 (strict mode)
- **Canvas API:** 2D rendering context
- **WebSocket:** WLED bridge communication
- **Math:** Linear interpolation, peak-picking algorithms

[Source: docs/architecture/tech-stack.md]

---

## Testing

### Manual Testing Strategy
**This project uses manual testing with browser DevTools, NOT automated test suites.**

[Source: CLAUDE.md#project-scale--testing-philosophy]

### Verification Checklist (Browser Testing)

**2D Matrix Rendering Verification:**
1. Configure WLED as 16×16 matrix
2. Navigate to `/dj-visualizer`
3. Enable WLED output
4. Start live audio input
5. Verify vertical bars appear (default orientation)
6. Play bass-heavy music → verify left columns activate (red/magenta)
7. Play high-frequency sounds → verify right columns activate (cyan/blue)
8. Verify bars grow bottom-to-top (default flip = false)

**Orientation Testing:**
1. Switch to horizontal orientation
2. Verify bars rotate 90° (now growing left-to-right)
3. Verify frequency layout changes (bass on bottom, treble on top)
4. Verify colors remain correct

**Flip Testing:**
1. Enable flip option (vertical orientation)
2. Verify bars now grow top-to-bottom (inverted)
3. Switch to horizontal orientation + flip
4. Verify bars now grow right-to-left (inverted)

**Compression/Scaling Testing:**
1. Test with 8×8 matrix (compression from 128 bins)
2. Verify all frequency ranges visible (bass/mid/treble)
3. Test with 64×64 matrix (scaling from 128 bins)
4. Verify smooth bar distribution (no gaps or duplicates)

**Education Mode Testing:**
1. Navigate to Education Mode → Lesson 2
2. Configure WLED as 16×16 matrix
3. Play kick drum → verify low-frequency vertical bars (left side, red)
4. Play snare drum → verify mid-frequency vertical bars (middle, yellow/green)
5. Play hi-hat → verify high-frequency vertical bars (right side, cyan)
6. Test orientation and flip controls
7. Verify no performance degradation

**Regression Testing:**
1. Configure WLED as 1×90 (1D strip)
2. Verify Story 19.5 implementation still works
3. Verify horizontal frequency layout (not bar charts)
4. Test with 2×90 matrix → verify bar chart rendering activates
5. Test with 1×16 matrix → verify 1D layout (not bar charts)

[Source: CLAUDE.md#quality-assurance, docs/architecture/testing-strategy.md]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Initial story creation | Sarah (Product Owner) |

---

## Dev Agent Record

_This section will be populated during implementation._

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes
_To be filled by dev agent_

### File List
_Files created/modified:_
-

---

## QA Results

_This section will be populated after QA review._
