# Story 10.6: Controller Unlock Flow & User Onboarding

## Status
Draft

## Story
**As a** first-time Pro user,
**I want** seamless discovery of available controllers and clear upgrade prompts,
**so that** I understand the value of Pro tier and can easily unlock premium hardware support.

## Acceptance Criteria
1. Design hardware discovery screen showing all available controllers with license status
2. Create inline upgrade prompts when Pro-gated controller is physically connected
3. Build onboarding flow for Pro subscribers showing supported hardware and setup guides
4. Implement "Try before you buy" demo mode (5-minute sessions with Pro controllers)
5. Create controller showcase page with video demos and feature comparisons
6. Add in-app notifications for newly added controller support in library updates

## Integration Verification
- **IV1**: Controller discovery and upgrade prompts don't interrupt active music production sessions
- **IV2**: Demo mode timer is accurate and cannot be circumvented through browser resets
- **IV3**: Onboarding flow adapts based on which controllers user physically owns

## Tasks / Subtasks

- [ ] **Task 1: Design Hardware Discovery Screen** (AC: 1)
  - [ ] Create `HardwareDiscoveryScreen.tsx` component
  - [ ] Design UI layout showing:
    - [ ] Detected controllers (connected hardware)
    - [ ] Available controllers (all registered profiles)
    - [ ] License status per controller (Free, Pro, Locked)
  - [ ] Implement filter/search for controller list
  - [ ] Add controller cards with:
    - [ ] Controller image/icon
    - [ ] Compatibility info
    - [ ] Feature highlights
    - [ ] Setup guide link
    - [ ] Lock icon + "Upgrade to Pro" CTA for gated controllers
  - [ ] Test with 0, 1, and multiple controllers connected

- [ ] **Task 2: Create Inline Upgrade Prompts** (AC: 2)
  - [ ] Create `ControllerUpgradePrompt.tsx` component
  - [ ] Detect when Pro-gated controller is connected
  - [ ] Show non-blocking toast notification:
    - [ ] "Launchpad Mini MK3 detected! Upgrade to Pro to unlock."
    - [ ] [Try Demo] [Upgrade to Pro] [Dismiss]
  - [ ] Implement smart throttling (don't spam if reconnecting rapidly)
  - [ ] Add "Don't show again for this controller" option
  - [ ] Track prompt interactions in analytics
  - [ ] Test prompt behavior during active playback (should not interrupt)

- [ ] **Task 3: Build Pro Subscriber Onboarding Flow** (AC: 3)
  - [ ] Create `ProOnboarding.tsx` component (modal or dedicated page)
  - [ ] Design welcome screen: "Welcome to Centaurus Pro!"
  - [ ] Show list of unlocked controllers with setup status:
    - [ ] ✅ APC40 (detected, ready to use)
    - [ ] 🔓 Launchpad Mini MK3 (unlocked, not detected)
    - [ ] 🔓 MPK Mini MK3 (unlocked, connect to get started)
  - [ ] Provide quick setup guides (embedded or linked)
  - [ ] Add "Skip for now" button (don't force onboarding)
  - [ ] Track onboarding completion in user profile
  - [ ] Show onboarding only once per user (or on demand via settings)

- [ ] **Task 4: Implement Demo Mode** (AC: 4)
  - [ ] Create `DemoModeManager.ts` service
  - [ ] Implement 5-minute countdown timer (300 seconds)
  - [ ] Show persistent timer UI in corner during demo:
    - [ ] "Demo Mode: 4:23 remaining"
    - [ ] [Upgrade to Pro]
  - [ ] Lock controller when timer expires (graceful disable)
  - [ ] Prevent timer circumvention:
    - [ ] Store demo start timestamp server-side (if backend available)
    - [ ] Fallback: Use encrypted localStorage with device fingerprint
    - [ ] Detect browser DevTools manipulation attempts
  - [ ] Allow demo restart once per day (prevent infinite demos via account resets)
  - [ ] Test timer accuracy and tamper resistance

- [ ] **Task 5: Create Controller Showcase Page** (AC: 5)
  - [ ] Create route: `/controllers` with showcase page
  - [ ] Design hero section: "Control Centaurus with Professional Hardware"
  - [ ] Build controller grid showing:
    - [ ] Controller image/video
    - [ ] Feature list
    - [ ] Compatibility badge (Official/Community)
    - [ ] License tier (Free/Pro)
    - [ ] Setup guide link
  - [ ] Add video demos (embedded YouTube/Vimeo or self-hosted)
  - [ ] Create feature comparison table:
    ```
    | Feature            | APC40 | Launchpad | MPK Mini | BeatStep |
    |--------------------|-------|-----------|----------|----------|
    | LED Feedback       | ✅    | ✅        | ⚠️       | ✅       |
    | Velocity Pads      | ✅    | ✅        | ✅       | ✅       |
    | Knobs/Faders       | ✅    | ❌        | ✅       | ✅       |
    | License Tier       | Free  | Pro       | Pro      | Pro      |
    ```
  - [ ] Test page responsive design (mobile/tablet/desktop)

- [ ] **Task 6: Implement Library Update Notifications** (AC: 6)
  - [ ] Create `LibraryUpdateNotifier.ts` service
  - [ ] Poll npm registry for `@centaurus/controller-lib` updates (daily)
  - [ ] Parse changelog for new controller additions
  - [ ] Show in-app notification banner:
    - [ ] "New controller support added: Korg nanoKONTROL2!"
    - [ ] [Learn More] [Dismiss]
  - [ ] Link to controller showcase page for new controllers
  - [ ] Allow users to opt-out of update notifications (settings)
  - [ ] Test notification logic with mocked npm responses

- [ ] **Task 7: Implement Non-Disruptive UX** (IV: 1)
  - [ ] Ensure upgrade prompts are toast-style (not modal dialogs)
  - [ ] Prompts auto-dismiss after 10 seconds
  - [ ] Never show prompts during active audio playback or recording
  - [ ] Use event queue to batch prompts (prevent prompt storm)
  - [ ] Test during real production workflow (sequencer running, user editing patterns)
  - [ ] Verify audio latency unaffected by prompt rendering

- [ ] **Task 8: Demo Mode Tamper Prevention** (IV: 2)
  - [ ] Implement timer on both client and server (if backend available)
  - [ ] Use device fingerprinting (canvas fingerprint, WebGL, user-agent)
  - [ ] Encrypt demo session data (AES-GCM) with device-specific key
  - [ ] Detect localStorage/sessionStorage manipulation
  - [ ] Rate-limit demo starts (1 per device per day)
  - [ ] Test circumvention attempts:
    - [ ] Clear localStorage and restart
    - [ ] Browser incognito mode
    - [ ] VM snapshots
    - [ ] Browser DevTools manipulation

- [ ] **Task 9: Adaptive Onboarding Flow** (IV: 3)
  - [ ] Detect which controllers are physically connected on Pro tier activation
  - [ ] Prioritize onboarding steps based on detected hardware:
    - [ ] If APC40 detected: "Your APC40 is ready to use!"
    - [ ] If Launchpad detected: "Set up your Launchpad Mini MK3"
    - [ ] If no hardware detected: "Connect your controller to get started"
  - [ ] Show setup guides only for detected controllers (reduce cognitive load)
  - [ ] Add "I don't have my hardware yet" option (skip hardware setup)
  - [ ] Test with various hardware combinations (0, 1, 2+ controllers)

## Dev Notes

### Relevant Architecture Context

**UX Philosophy - Non-Blocking Monetization**:
- Never interrupt users with blocking modals during production work
- Use toast-style notifications (auto-dismiss, non-modal)
- Upgrade prompts are informative, not naggy
- Demo mode is generous (5 minutes is enough to evaluate)
- Onboarding is optional (power users can skip)

**Demo Mode Strategy**:
- **Client-side timer**: Immediate feedback, works offline
- **Server-side validation**: Prevents circumvention (if backend available)
- **Device fingerprinting**: Associates demo with device, not just browser/account
- **Daily limit**: Balances evaluation with conversion (can try again tomorrow)

**Onboarding Flow Design**:
- **Progressive disclosure**: Show only relevant information based on context
- **Hardware-aware**: Adapt to user's actual hardware
- **Skippable**: Never force users through onboarding
- **Accessible**: Can re-trigger onboarding from settings

**License State Management** (from Story 10.2):
- LicenseManager tracks Pro tier status
- FeatureGate checks if controller requires Pro
- Demo mode is temporary Pro tier override (time-limited)

### Source Tree Context

```
src/
├── components/
│   ├── onboarding/
│   │   ├── ProOnboarding.tsx               # NEW - This story
│   │   ├── HardwareDiscoveryScreen.tsx     # NEW - This story
│   │   └── OnboardingStep.tsx              # NEW - Reusable step component
│   ├── hardware/
│   │   ├── ControllerUpgradePrompt.tsx     # NEW - This story
│   │   ├── ControllerShowcase.tsx          # NEW - This story
│   │   └── DemoModeTimer.tsx               # NEW - This story
│   └── notifications/
│       └── LibraryUpdateNotification.tsx   # NEW - This story
├── services/
│   ├── DemoModeManager.ts                  # NEW - This story
│   ├── LibraryUpdateNotifier.ts            # NEW - This story
│   └── DeviceFingerprint.ts                # NEW - This story
├── pages/
│   └── Controllers.tsx                     # NEW - Showcase page
└── hooks/
    ├── useDemoMode.ts                      # NEW - This story
    └── useOnboarding.ts                    # NEW - This story

docs/
└── controllers/
    ├── setup-guides/                       # NEW - Per-controller guides
    │   ├── apc40.md
    │   ├── launchpad-mini-mk3.md
    │   ├── mpk-mini-mk3.md
    │   └── beatstep.md
    └── video-demos/                        # NEW - Video assets
        └── README.md
```

### Key Design Decisions

**Toast vs Modal**: Use toast notifications for upgrade prompts. Modals block workflow, toasts inform without interrupting.

**Demo Mode Duration**: 5 minutes balances evaluation time with conversion pressure. Long enough to try features, short enough to encourage purchase.

**Onboarding Trigger**: Show onboarding once per user after Pro tier activation. Available on-demand via settings thereafter.

**Controller Showcase**: Standalone page allows SEO optimization and marketing use (link from landing page, social media).

**Library Update Polling**: Daily check for new controllers keeps app fresh. Notifications drive engagement with new features.

**Device Fingerprinting**: Required for demo mode tamper prevention. Use well-established libraries (FingerprintJS or similar) for reliability.

### UX Wireframes

**Hardware Discovery Screen**:
```
┌──────────────────────────────────────────────────────────┐
│ Hardware Controllers                          [Settings] │
├──────────────────────────────────────────────────────────┤
│                                                          │
│ 🟢 Connected (1):                                        │
│                                                          │
│ ┌─────────────────────────────────────────────┐        │
│ │ [Image] APC40 Mk2                           │  FREE  │
│ │         Compatible with Akai APC40          │        │
│ │         ✅ Ready to use                      │        │
│ │         [Setup Guide] [Settings]            │        │
│ └─────────────────────────────────────────────┘        │
│                                                          │
│ 🔓 Available (3):                                        │
│                                                          │
│ ┌─────────────────────────────────────────────┐        │
│ │ [Image] Launchpad Mini MK3                  │  PRO   │
│ │         8x8 RGB Grid Controller             │  🔒    │
│ │         [Try Demo] [Upgrade to Pro]         │        │
│ └─────────────────────────────────────────────┘        │
│                                                          │
│ ┌─────────────────────────────────────────────┐        │
│ │ [Image] MPK Mini MK3                        │  PRO   │
│ │         25 Keys, 8 Pads, 8 Knobs            │  🔒    │
│ │         [Try Demo] [Upgrade to Pro]         │        │
│ └─────────────────────────────────────────────┘        │
│                                                          │
│ [+ Import Custom Profile]                               │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

**Demo Mode Timer**:
```
┌─────────────────────────────────┐
│ 🎮 Demo Mode: 4:23 remaining    │
│                                 │
│ Enjoying the Launchpad?         │
│ [Upgrade to Pro] [Maybe Later]  │
└─────────────────────────────────┘
```

**Upgrade Prompt Toast**:
```
┌──────────────────────────────────────────────────┐
│ 🎹 Launchpad Mini MK3 detected!                  │
│    Upgrade to Pro to unlock full support.        │
│    [Try Demo (5 min)] [Upgrade] [Dismiss]        │
└──────────────────────────────────────────────────┘
```

### Testing

**Unit Tests** (`tests/onboarding/*.test.ts`):
- Demo mode timer accuracy
- Device fingerprinting logic
- Upgrade prompt triggering conditions
- Onboarding step progression

**Integration Tests** (`tests/integration/unlock-flow.test.ts`):
- End-to-end onboarding flow
- Demo mode activation and expiry
- Upgrade prompt → checkout flow
- Library update notification delivery

**E2E Tests** (`tests/e2e/user-journey.test.ts`):
- Free user connects Pro controller (sees upgrade prompt)
- User tries demo mode (5 minutes, then locks)
- User upgrades to Pro (onboarding flow, controller unlocks)
- Pro user connects new controller (setup guide, ready to use)

**Tamper Resistance Tests**:
- Attempt to extend demo timer via localStorage manipulation
- Test incognito mode demo circumvention
- Verify device fingerprint uniqueness
- Test server-side validation (if backend available)

**Testing Standards**:
- Use Playwright for E2E user journeys
- Mock payment flows (Stripe test mode)
- Test across browsers (Chrome, Firefox, Safari)
- Mobile responsive testing (iOS/Android)

### Analytics Events to Track

**Discovery & Awareness**:
- `controller_detected` (controller model, license tier)
- `upgrade_prompt_shown` (controller model, user license tier)
- `demo_mode_started` (controller model)

**Conversion**:
- `upgrade_button_clicked` (source: prompt/discovery/showcase)
- `checkout_initiated` (plan: monthly/annual)
- `checkout_completed` (plan, amount, controller interest)

**Engagement**:
- `onboarding_started` (detected controllers)
- `onboarding_completed` (setup guides viewed)
- `onboarding_skipped` (reason: has_hardware / no_hardware / later)
- `setup_guide_viewed` (controller model)
- `demo_mode_expired` (controller model, converted: yes/no)

**Churn Risk**:
- `upgrade_prompt_dismissed` (count per user, sentiment indicator)
- `demo_mode_abandoned` (duration used before quit)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-10 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
