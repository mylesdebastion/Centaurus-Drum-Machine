# Story 19.1: LiveAudioVisualizer Embedded Mode

**Epic:** Education Mode DJ Visualizer Integration (Epic 19)
**Status:** Draft
**Priority:** High (Foundation Story for Epic 19)
**Complexity:** Medium
**Prerequisites:** None (foundation for 19.2 and 19.3)

---

## Story

**As a** student using Education Mode,
**I want** the LiveAudioVisualizer to work in a simplified embedded mode,
**so that** I can see real-time audio visualization without complex device selection UI cluttering the learning experience.

---

## Background / Context

### Current State
- âœ… **LiveAudioVisualizer exists** - Full-featured DJ visualizer at `/dj-visualizer` route
- âœ… **Three visualization modes** - Spectrum, waveform, ripple all working
- âœ… **FrequencySourceManager** - Mixes audio sources for visualization
- âœ… **Audio auto-initialization** - AudioInputManager can auto-start with default mic
- âŒ **No embedded mode** - Component always shows full control panel
- âŒ **Not education-friendly** - Complex settings (device picker, gain, frequency scale) overwhelming for students

### Existing Implementation Location
- **Component:** `src/components/LiveAudioVisualizer/LiveAudioVisualizer.tsx`
- **Current props:** `onBack?: () => void`
- **Current state:** Full control panel with device selection, settings panel, FPS counter, stats

### Why Embedded Mode is Needed
Education Mode lessons 2 (Color & Pitch) and 4 (Melody & Harmony) need a simplified visualizer that:
1. **Auto-initializes** - No manual "Start" button or device selection
2. **Hides complexity** - No device picker, gain controls, frequency scaling options
3. **Minimal UI** - Just the canvas and visualization mode switching
4. **Graceful fallback** - Shows visual-only mode if mic unavailable

**IMPORTANT:** Lessons 1 (Basic Beat) and 3 (Rhythm Patterns) will **NOT** use the visualizer - they teach rhythm using step sequencer pattern grids, which is pedagogically correct for timing/rhythm concepts.

**Pedagogical Strategy:**
- **Lessons 1 & 3 (Rhythm):** Step sequencer grid UI - teaches visual timing and pattern layering
- **Lessons 2 & 4 (Pitch/Audio):** DJ visualizer embedded mode - teaches frequency and audio concepts

[Source: Epic 19, docs/epics/epic-19-education-dj-visualizer-integration.md#enhancement-details]

---

## Acceptance Criteria

### AC 1: Embedded Prop Implementation
- [ ] Add `embedded?: boolean` prop to LiveAudioVisualizer component
- [ ] Default value is `false` to maintain backward compatibility
- [ ] Prop controls conditional rendering of UI elements
- [ ] Existing standalone `/dj-visualizer` route unaffected

### AC 2: Auto-Initialization in Embedded Mode
- [ ] When `embedded={true}`, automatically call `handleStart()` on component mount
- [ ] No manual "Start" button required in embedded mode
- [ ] Use default microphone (no device ID parameter)
- [ ] Handle initialization errors gracefully with fallback state

### AC 3: Simplified Control Panel
- [ ] Hide device selection dropdown when `embedded={true}`
- [ ] Hide gain/sensitivity slider when `embedded={true}`
- [ ] Hide frequency scale toggle when `embedded={true}`
- [ ] Hide FPS counter when `embedded={true}`
- [ ] Hide RMS and peak frequency stats when `embedded={true}`
- [ ] Keep visualization mode buttons (spectrum/waveform/ripple) visible

### AC 4: Canvas Rendering in Smaller Layout
- [ ] Canvas renders correctly in embedded mode with smaller dimensions
- [ ] Maintain aspect ratio and responsiveness
- [ ] Visualization quality remains high at smaller sizes
- [ ] No layout breaks or canvas sizing issues

### AC 5: Error Handling and Fallback
- [ ] If microphone permission denied, show clear message: "Microphone access needed for visualization"
- [ ] Provide graceful fallback state (show static canvas or helpful message)
- [ ] Don't crash or show cryptic errors
- [ ] Allow Education Mode to continue even if visualizer fails

### AC 6: Backward Compatibility
- [ ] Standalone `/dj-visualizer` route works exactly as before
- [ ] No breaking changes to existing component behavior
- [ ] All existing props and functionality preserved
- [ ] Manual testing confirms no regression in standalone mode

---

## Tasks / Subtasks

### Task 1: Add Embedded Prop to Component Interface (AC: 1)
- [ ] Add `embedded?: boolean` to `LiveAudioVisualizerProps` interface
- [ ] Set default value to `false`
- [ ] Document prop with JSDoc comment explaining embedded mode behavior

### Task 2: Implement Auto-Initialization Logic (AC: 2)
- [ ] Add `useEffect` hook that runs when `embedded && !isInitialized`
- [ ] Call `handleStart()` with no device ID parameter (use default mic)
- [ ] Add error handling for initialization failure
- [ ] Set appropriate state flags for auto-init vs manual init

### Task 3: Conditional Rendering for Embedded Mode (AC: 3, 4)
- [ ] Wrap device selection dropdown in `{!embedded && <DeviceSelector />}`
- [ ] Wrap gain slider in `{!embedded && <GainControl />}`
- [ ] Wrap frequency scale toggle in `{!embedded && <FrequencyScaleToggle />}`
- [ ] Wrap FPS counter in `{!embedded && <FPSDisplay />}`
- [ ] Wrap stats display (RMS/peak frequency) in `{!embedded && <Stats />}`
- [ ] Keep visualization mode buttons visible in both modes
- [ ] Adjust canvas container classes for embedded layout (smaller padding/margins)

### Task 4: Test Canvas Rendering at Different Sizes (AC: 4)
- [ ] Verify canvas renders correctly in embedded mode
- [ ] Test responsive behavior (mobile/tablet/desktop breakpoints)
- [ ] Ensure visualization modes all work in smaller canvas
- [ ] Check for any layout overflow or clipping issues

### Task 5: Enhance Error Handling for Embedded Mode (AC: 5)
- [ ] Add user-friendly error message for microphone permission denial
- [ ] Show fallback UI when audio initialization fails
- [ ] Ensure error state doesn't propagate to parent component
- [ ] Log errors to console for debugging but don't alert()

### Task 6: Manual Testing - Standalone Mode (AC: 6)
- [ ] Navigate to `/dj-visualizer` route
- [ ] Verify all controls (device picker, gain, frequency scale) still visible
- [ ] Test manual start/stop functionality
- [ ] Confirm FPS counter and stats display working
- [ ] Test all three visualization modes (spectrum, waveform, ripple)
- [ ] Document results in Dev Agent Record

### Task 7: Manual Testing - Embedded Mode (AC: 1-5)
- [ ] Create test harness component with `<LiveAudioVisualizer embedded={true} />`
- [ ] Verify auto-initialization on mount
- [ ] Confirm simplified UI (no device picker, gain, etc.)
- [ ] Test microphone permission denial scenario
- [ ] Test responsive canvas sizing
- [ ] Document results in Dev Agent Record

---

## Dev Notes

### Component Location and Current Structure
**File:** `src/components/LiveAudioVisualizer/LiveAudioVisualizer.tsx`
**Current Props Interface:**
```typescript
interface LiveAudioVisualizerProps {
  onBack?: () => void;
  embedded?: boolean; // ADD THIS
  layout?: 'mobile' | 'desktop';
  className?: string;
}
```

**Current State Variables (lines 42-56):**
- `isInitialized` - Tracks if audio input has started
- `error` - Error message string
- `devices` - List of available MIDI devices
- `selectedDeviceId` - Currently selected device
- `currentMode` - Visualization mode (spectrum/waveform/ripple)
- `gain` - Audio gain/sensitivity (0-1)
- `showSettings` - Settings panel visibility
- `fps` - Current FPS counter

[Source: src/components/LiveAudioVisualizer/LiveAudioVisualizer.tsx:22-56]

### Auto-Initialization Pattern
**Current Initialization:**
```typescript
const handleStart = async (deviceId?: string) => {
  try {
    const manager = new AudioInputManager(DEFAULT_AUDIO_CONFIG);
    await manager.initialize(deviceId && deviceId.length > 0 ? deviceId : undefined);
    audioManagerRef.current = manager;
    // ... rest of initialization
    setIsInitialized(true);
    startVisualization();
  } catch (err) {
    setError(err instanceof Error ? err.message : 'Failed to initialize audio');
  }
};
```

**Auto-Init Pattern (ADD THIS):**
```typescript
useEffect(() => {
  if (embedded && !isInitialized) {
    handleStart(); // No device ID = use default mic
  }
}, [embedded, isInitialized]);
```

[Source: src/components/LiveAudioVisualizer/LiveAudioVisualizer.tsx:89-112]

### Conditional Rendering Pattern
Use existing `embedded` prop to conditionally render UI elements:

```typescript
{!embedded && (
  <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 sm:p-6 mb-6">
    {/* Device selection dropdown */}
  </div>
)}

{!embedded && (
  <div className="flex items-center gap-4">
    {/* Gain slider, frequency scale toggle, etc. */}
  </div>
)}
```

Keep visualization mode buttons visible for educational purposes:
```typescript
<div className="flex items-center gap-2">
  <button onClick={() => setCurrentMode('spectrum')}>Spectrum</button>
  <button onClick={() => setCurrentMode('waveform')}>Waveform</button>
  <button onClick={() => setCurrentMode('ripple')}>Ripple</button>
</div>
```

[Source: Epic 19 requirements, docs/epics/epic-19-education-dj-visualizer-integration.md#enhancement-details]

### Canvas Sizing for Embedded Mode
**Current Canvas Container:**
```typescript
<canvas
  ref={canvasRef}
  width={800}
  height={400}
  className="w-full h-full"
/>
```

**Embedded Mode Adjustment (OPTIONAL):**
Consider smaller default dimensions if needed, but `w-full h-full` should adapt to parent container size automatically. Test responsiveness in Education Mode context.

[Source: Component architecture patterns]

### Error Handling Best Practices
**From Coding Standards:**
- Use React error boundaries to prevent component crashes
- Show user-friendly error messages, not cryptic API errors
- Log detailed errors to console for debugging
- Provide fallback UI state when features unavailable

**Microphone Permission Denial Message:**
```typescript
{error && embedded && (
  <div className="bg-yellow-500/20 border border-yellow-500/30 rounded-lg p-4">
    <p className="text-yellow-200">
      ðŸ“· Microphone access needed for live visualization.
      {error.includes('Permission') && ' Please allow microphone access in your browser.'}
    </p>
  </div>
)}
```

[Source: docs/architecture/coding-standards.md#error-handling]

### Technology Stack
- **React:** 18.2.0 (functional components with hooks)
- **TypeScript:** 5.2.2 (strict mode)
- **Styling:** Tailwind CSS (existing utility classes)
- **Icons:** Lucide React (if needed for error states)
- **Audio:** AudioInputManager, FrequencySourceManager (existing utilities)

[Source: docs/architecture/tech-stack.md]

### File Locations
- **Component to modify:** `src/components/LiveAudioVisualizer/LiveAudioVisualizer.tsx`
- **Related utilities:** `src/components/LiveAudioVisualizer/AudioInputManager.ts`
- **Related utilities:** `src/utils/frequencySourceManager.ts`

[Source: docs/architecture/source-tree.md#existing-project-structure]

---

## Testing

### Manual Testing Strategy
**This project uses manual testing with browser DevTools, NOT automated test suites.**

[Source: CLAUDE.md#project-scale--testing-philosophy]

### Verification Checklist (Browser Testing)

**Embedded Mode Verification:**
1. Create test component with `<LiveAudioVisualizer embedded={true} />`
2. Open browser DevTools â†’ Console
3. Verify auto-initialization logs appear
4. Confirm microphone permission prompt appears
5. Check that simplified UI renders (no device picker, gain slider, etc.)
6. Inspect canvas element and verify rendering
7. Test visualization mode switching (spectrum â†’ waveform â†’ ripple)

**Standalone Mode Regression:**
1. Navigate to `http://localhost:5173/dj-visualizer`
2. Verify all controls still visible (device picker, gain, frequency scale)
3. Test manual start/stop button
4. Confirm FPS counter visible
5. Test all three visualization modes
6. No console errors or warnings

**Responsive Testing:**
1. Open browser DevTools â†’ Device Toolbar
2. Test mobile viewport (375px width)
3. Test tablet viewport (768px width)
4. Test desktop viewport (1280px width)
5. Verify canvas scales correctly at each breakpoint
6. Check for layout overflow or clipping

**Error Scenario Testing:**
1. Deny microphone permission in browser settings
2. Reload page with embedded visualizer
3. Verify graceful fallback message appears
4. Check console for error logs (should be informative, not cryptic)
5. Confirm Education Mode can continue despite visualizer failure

[Source: CLAUDE.md#quality-assurance, docs/architecture/testing-strategy.md]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Initial story creation | Bob (Scrum Master) |

---

## Dev Agent Record

_This section will be populated during implementation._

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes
_To be filled by dev agent_

### File List
_Files created/modified:_
-

---

## QA Results

_This section will be populated after QA review._
