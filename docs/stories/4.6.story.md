# Story 4.6: View Integration & Refactoring

## Status
Draft

## Story
**As a** developer,
**I want** all existing views to consume global music state,
**so that** settings are consistent and DRY principle is followed.

## Acceptance Criteria
1. Refactor `PianoRoll` to use `useGlobalMusic()` for key/scale/tempo
2. Refactor `GuitarFretboard` to use `useGlobalMusic()` for key/scale
3. Refactor `IsometricSequencer` to use `useGlobalMusic()` for key/scale/tempo
4. Refactor `JamSession` to use `useGlobalMusic()` for tempo (if applicable)
5. Remove local key/scale/tempo state from refactored views
6. Update view components to listen for global state changes
7. Test all views with synchronized settings changes

## Integration Verification
- **IV1**: Changing key in header updates all visualizers immediately
- **IV2**: No regressions in existing view functionality
- **IV3**: Remove duplicate ScaleSelector components from individual views

## Tasks / Subtasks

- [ ] **Task 1: Audit Existing View Components** (Pre-refactoring)
  - [ ] Review PianoRoll for local key/scale/tempo state
  - [ ] Review GuitarFretboard for local key/scale state
  - [ ] Review IsometricSequencer for local key/scale/tempo state
  - [ ] Review JamSession for tempo management
  - [ ] Document current state management patterns
  - [ ] Identify duplicate code and components
  - [ ] Create refactoring checklist per view

- [ ] **Task 2: Refactor PianoRoll** (AC: 1, 5, 6)
  - [ ] Update `src/components/PianoRoll/PianoRoll.tsx`
  - [ ] Import `useGlobalMusic` hook
  - [ ] Replace local key/scale state with global state
    - [ ] Remove `useState` for selectedRoot
    - [ ] Remove `useState` for selectedScale
    - [ ] Use `const { selectedRoot, selectedScale } = useGlobalMusic()`
  - [ ] Replace local tempo state with global tempo
    - [ ] Remove local tempo management
    - [ ] Use `const { tempo } = useGlobalMusic()`
  - [ ] Remove local ScaleSelector component
    - [ ] Delete inline ScaleSelector
    - [ ] Rely on global header for key/scale selection
  - [ ] Update useEffect to react to global state changes
  - [ ] Test piano roll with global key/scale changes
  - [ ] Verify no functionality lost

- [ ] **Task 3: Refactor GuitarFretboard** (AC: 2, 5, 6)
  - [ ] Update `src/components/GuitarFretboard/GuitarFretboard.tsx`
  - [ ] Import `useGlobalMusic` hook
  - [ ] Replace local key/scale state with global state
    - [ ] Remove existing useMusicalScale hook (already using it, but make it consume global)
    - [ ] Use `const { selectedRoot, selectedScale, getCurrentScale } = useGlobalMusic()`
  - [ ] Remove local ScaleSelector if present
    - [ ] Check for inline scale selector
    - [ ] Remove if found
  - [ ] Update chord progression logic to use global key/scale
  - [ ] Test fretboard with global key/scale changes
  - [ ] Verify chord progressions still work correctly

- [ ] **Task 4: Refactor IsometricSequencer** (AC: 3, 5, 6)
  - [ ] Update `src/components/IsometricSequencer/IsometricSequencer.tsx`
  - [ ] Import `useGlobalMusic` hook
  - [ ] Replace local key/scale state with global state
  - [ ] Replace local tempo state with global tempo
  - [ ] Remove local ScaleSelector component
  - [ ] Update 3D note rendering to use global state
  - [ ] Update sequencer timing to use global tempo
  - [ ] Test isometric view with global settings changes
  - [ ] Verify 3D visualization updates correctly

- [ ] **Task 5: Refactor JamSession (if applicable)** (AC: 4, 5)
  - [ ] Review `src/components/JamSession/JamSession.tsx`
  - [ ] Check if JamSession manages its own tempo
  - [ ] If yes:
    - [ ] Replace local tempo with global tempo
    - [ ] Update drum sequencer to use global tempo
    - [ ] Remove local tempo controls
  - [ ] If no: Skip this task
  - [ ] Test JamSession functionality
  - [ ] Verify no regressions

- [ ] **Task 6: Remove Duplicate Components** (AC: 5, IV: 3)
  - [ ] Search for duplicate ScaleSelector instances
  - [ ] Remove ScaleSelector from views (keep only in global header)
  - [ ] Search for duplicate tempo controls
  - [ ] Remove tempo controls from views (keep only in global header)
  - [ ] Update component imports across codebase
  - [ ] Delete unused component files (if any)
  - [ ] Update documentation

- [ ] **Task 7: Add Global State Change Listeners** (AC: 6)
  - [ ] For each refactored view, add useEffect listeners
  - [ ] Listen for key changes → update visualizations
  - [ ] Listen for scale changes → update visualizations
  - [ ] Listen for tempo changes → update sequencer timing
  - [ ] Listen for color mode changes → update note colors
  - [ ] Debounce rapid state changes if needed
  - [ ] Test smooth updates without flickering

- [ ] **Task 8: Update View Props Interfaces**
  - [ ] Remove key/scale/tempo from view component props
  - [ ] Update parent components calling these views
  - [ ] Update TypeScript interfaces
  - [ ] Fix type errors across codebase
  - [ ] Ensure backward compatibility where needed

- [ ] **Task 9: Comprehensive Testing** (AC: 7, IV: 1, 2, 3)
  - [ ] **PianoRoll Tests**:
    - [ ] Change key in header → verify piano updates
    - [ ] Change scale in header → verify piano updates
    - [ ] Change tempo → verify playback speed changes
    - [ ] Play notes → verify audio still works
  - [ ] **GuitarFretboard Tests**:
    - [ ] Change key in header → verify fretboard updates
    - [ ] Change scale in header → verify fret markers update
    - [ ] Play chord progression → verify correct chords
    - [ ] Change color mode → verify colors update
  - [ ] **IsometricSequencer Tests**:
    - [ ] Change key in header → verify 3D notes update
    - [ ] Change scale in header → verify 3D visualization updates
    - [ ] Change tempo → verify 3D sequencer speed changes
    - [ ] Play pattern → verify audio still works
  - [ ] **JamSession Tests** (if modified):
    - [ ] Change tempo in header → verify drum machine updates
    - [ ] Play pattern → verify timing correct
  - [ ] **Cross-View Tests**:
    - [ ] Change key → verify all views update simultaneously
    - [ ] Change scale → verify all views update
    - [ ] Change tempo → verify all views update
    - [ ] Navigate between views → verify settings persist
  - [ ] **Regression Tests**:
    - [ ] All existing functionality still works
    - [ ] No broken features
    - [ ] No console errors
    - [ ] Performance unchanged

- [ ] **Task 10: Update Documentation**
  - [ ] Update component README files
  - [ ] Document new global state patterns
  - [ ] Update architecture diagrams
  - [ ] Create migration guide for future views
  - [ ] Add comments explaining global state usage
  - [ ] Update developer onboarding docs

## Dev Notes

### Relevant Architecture Context

**Views to Refactor**:
- `src/components/PianoRoll/PianoRoll.tsx` - Piano roll visualizer
- `src/components/GuitarFretboard/GuitarFretboard.tsx` - Guitar fretboard visualizer
- `src/components/IsometricSequencer/IsometricSequencer.tsx` - 3D isometric sequencer
- `src/components/JamSession/JamSession.tsx` - Collaborative jam session (check tempo)

**GlobalMusicContext Interface**:
```typescript
const {
  tempo,
  selectedRoot,
  selectedScale,
  colorMode,
  masterVolume,
  updateTempo,
  setSelectedRoot,
  setSelectedScale,
  updateColorMode,
  updateVolume,
  getCurrentScale,
  isNoteInScale,
  getKeySignature
} = useGlobalMusic();
```

### Refactoring Pattern

**Before** (PianoRoll example):
```typescript
const PianoRoll = ({ onBack }) => {
  const [selectedRoot, setSelectedRoot] = useState<RootNote>('C');
  const [selectedScale, setSelectedScale] = useState<ScaleName>('major');
  const [tempo, setTempo] = useState(120);

  return (
    <div>
      <ScaleSelector
        selectedRoot={selectedRoot}
        selectedScale={selectedScale}
        onRootChange={setSelectedRoot}
        onScaleChange={setSelectedScale}
      />
      <TempoControl tempo={tempo} onTempoChange={setTempo} />
      {/* Piano roll canvas */}
    </div>
  );
};
```

**After**:
```typescript
const PianoRoll = ({ onBack }) => {
  const { selectedRoot, selectedScale, tempo, getCurrentScale } = useGlobalMusic();

  // Optional: useEffect to react to global state changes
  useEffect(() => {
    // Update visualizations when key/scale changes
    console.log('Key/scale changed:', selectedRoot, selectedScale);
  }, [selectedRoot, selectedScale]);

  return (
    <div>
      {/* No more local ScaleSelector or TempoControl */}
      {/* Global header provides these controls */}
      {/* Piano roll canvas */}
    </div>
  );
};
```

### State Change Handling

**Reactive Updates**:
```typescript
// Listen for global state changes
useEffect(() => {
  // Recalculate scale notes
  const scaleNotes = getCurrentScale();

  // Update canvas/3D scene with new colors
  updateVisualization(scaleNotes, colorMode);
}, [selectedRoot, selectedScale, colorMode]);

// Debounce rapid changes (optional)
const debouncedUpdate = useMemo(
  () => debounce(updateVisualization, 100),
  []
);

useEffect(() => {
  debouncedUpdate(getCurrentScale(), colorMode);
}, [selectedRoot, selectedScale, colorMode]);
```

### Backward Compatibility Strategy

**Phase 1 - Additive (Non-breaking)**:
- Add `useGlobalMusic` alongside existing state
- Keep local state as fallback
- Test both paths work

**Phase 2 - Migration**:
- Remove local state
- Use global state exclusively
- Remove duplicate components

**Phase 3 - Cleanup**:
- Delete unused code
- Update documentation
- Final testing

### Testing Strategy

**Unit Tests** (per view):
- Component renders with global state
- Component updates when global state changes
- No regressions in functionality
- Props interfaces updated correctly

**Integration Tests**:
- Multiple views consuming same global state
- State changes propagate to all views
- Navigation preserves state
- Settings persist across sessions

**E2E Tests** (Playwright):
- Full user flow: Change key → See all visualizers update
- Cross-view navigation with persistent settings
- Hardware settings reflected across views

**Regression Tests**:
- All existing tests still pass
- Performance benchmarks unchanged
- No new console errors/warnings

### Performance Considerations

- **Re-render Optimization**: Memoize expensive computations
- **Debouncing**: Debounce rapid state changes (e.g., tempo slider dragging)
- **Selective Updates**: Only update what changed (don't redraw entire canvas)
- **Context Memoization**: Ensure GlobalMusicContext value is memoized

### Migration Checklist Per View

For each view being refactored:

- [ ] Backup original component (or commit to git)
- [ ] Identify local state to remove
- [ ] Import `useGlobalMusic` hook
- [ ] Replace local state with global state
- [ ] Remove duplicate UI components (ScaleSelector, TempoControl)
- [ ] Add useEffect listeners for state changes
- [ ] Test functionality thoroughly
- [ ] Update TypeScript types
- [ ] Update documentation
- [ ] Commit changes with clear message

### Rollback Plan

If refactoring introduces regressions:

1. **Immediate**: Git revert to previous commit
2. **Short-term**: Keep old local state as fallback
3. **Long-term**: Fix bugs and re-apply refactoring

### Success Criteria

**Refactoring is successful when:**
- ✅ All views consume global state
- ✅ No duplicate ScaleSelector/TempoControl components
- ✅ Settings changes in header update all views instantly
- ✅ No regressions in functionality
- ✅ Code is cleaner and more maintainable
- ✅ Performance is equal or better

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-11 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
