# Story 7.3: JamSession UI Integration

**Epic:** Epic 7 - Jam Session Backend Infrastructure (Hybrid: Supabase + WebRTC P2P)
**Status:** üìù READY FOR DEVELOPMENT
**Priority:** üî¥ HIGH
**Complexity:** Medium
**Time Estimate:** 4-6 hours
**Prerequisites:** Story 7.2

---

## User Story

As a **user**,
I want **to create and join real jam sessions with other musicians**,
So that **I can collaborate in real-time with participants shown in the session**.

---

## Story Context

**Existing System Integration:**
- Integrates with: `SupabaseSessionService` (Story 7.2), existing `JamSession.tsx` UI
- Technology: React hooks, Supabase Realtime, TypeScript
- Follows pattern: Existing JamSession UI structure, React useState/useEffect patterns
- Touch points: WelcomeScreen, JamSession component, UserList tab

**Why This Story:**
This story connects the backend service layer (Story 7.2) to the existing front-end UI. Users will be able to create/join real sessions for the first time, moving from hardcoded mock data to functional collaboration. This enables the core user flow: create session ‚Üí share code ‚Üí collaborate.

---

## Acceptance Criteria

### Functional Requirements

1. **Session Creation Flow**
   - When user clicks "Create a Jam Room" on WelcomeScreen:
     - Show username prompt modal (if not set)
     - Call `sessionService.createSession(userName)`
     - Navigate to `/jam` with generated room code
     - Display room code in session header

2. **Session Joining Flow**
   - When user enters room code and clicks "Join a Room":
     - Show username prompt modal (if not set)
     - Call `sessionService.joinSession(roomCode, userName)`
     - Navigate to `/jam` (room code in state)
     - Show "Connecting..." indicator during join

3. **Username Prompt Modal**
   - File: `src/components/JamSession/UsernameModal.tsx`
   - Simple text input: "Enter your name"
   - Store username in localStorage (`jam-username`)
   - Default to "User" + random 4-digit number if empty
   - Show on first session creation/join only
   - Can be changed in settings (future story)

4. **Real-Time Participant List**
   - Update `src/components/JamSession/UserList.tsx`:
     - Subscribe to presence via `sessionService.onPresenceSync()`
     - Map presence state to participant list
     - Show host badge (crown icon for `isHost=true`)
     - Show join timestamps (relative time: "2m ago")
     - Real-time add/remove updates (no refresh needed)
     - Display participant count in header

5. **Leave Session Functionality**
   - "Leave Session" button calls `sessionService.leaveSession()`
   - Unsubscribe from presence
   - Navigate back to `/` (WelcomeScreen)
   - Show confirmation modal: "Are you sure you want to leave?"

6. **Connection Status Indicator**
   - Show status in session header or top-right corner
   - States:
     - üü¢ **Connected** (green dot + "Connected")
     - üü° **Reconnecting...** (yellow dot + "Reconnecting...")
     - üî¥ **Disconnected** (red dot + "Disconnected")
   - Subscribe to `sessionService.connectionStatus`

### Integration Requirements

7. **JamSession Component Integration**
   - Import `SupabaseSessionService` from `@/services/supabaseSession`
   - Initialize service in `useEffect` (on mount)
   - Clean up subscriptions on unmount
   - Store session code and participants in component state

8. **WelcomeScreen Integration**
   - Pass `onStartJam` and `onJoinJam` callbacks from App.tsx
   - Show username modal before creating/joining session
   - Store username in localStorage for future sessions

9. **Error Handling**
   - Show error messages for:
     - Failed to create session (network error)
     - Failed to join session (invalid code, network error)
     - Connection lost (show reconnecting indicator)
   - Use toast notifications or inline error messages

### Quality Requirements

10. **User Experience**
    - Username modal is non-intrusive (only on first use)
    - Participant list updates feel instant (<200ms)
    - Connection status changes are noticeable but not distracting
    - Leave confirmation prevents accidental exits

11. **Responsive Design**
    - Username modal works on mobile and desktop
    - Participant list scrolls if >10 participants
    - Connection indicator visible on all screen sizes

12. **Code Quality**
    - No direct Supabase calls in components (use service)
    - Clean useEffect cleanup (unsubscribe on unmount)
    - TypeScript types for all component props and state

---

## Technical Notes

**Integration Approach:**
- JamSession component manages service lifecycle (create/join/leave)
- Service callbacks update component state (participants, connection status)
- LocalStorage stores username for future sessions (`jam-username`)

**Existing Pattern Reference:**
- Modal pattern similar to existing settings modals
- Participant list UI similar to existing UserList component
- Navigation pattern follows existing App.tsx routing

**Key Constraints:**
- Must work with existing JamSession UI layout
- No breaking changes to existing tab navigation (Session, Users, Settings)
- Maintain existing responsive design patterns

---

## Definition of Done

- [ ] Username prompt modal created and functional
- [ ] Session creation flow connects to SupabaseSessionService
- [ ] Session joining flow connects to SupabaseSessionService
- [ ] Real-time participant list displays and updates
- [ ] Host badge displays correctly
- [ ] Leave session button works and shows confirmation
- [ ] Connection status indicator shows current state
- [ ] Username stored in localStorage
- [ ] Error handling for failed connections
- [ ] No errors in browser console during normal operation
- [ ] Manual testing completed (see Testing Strategy)

---

## Testing Strategy

### Manual Testing (Per CLAUDE.md Guidelines)

**Test 1: Create Session Flow**
1. Open `http://localhost:5173`
2. Click "Create a Jam Room (New)"
3. Enter username in modal (e.g., "Alice")
4. Verify:
   - ‚úÖ Navigates to `/jam`
   - ‚úÖ Session code displayed in header (e.g., "ABC123")
   - ‚úÖ Username stored in localStorage
   - ‚úÖ Participant list shows "Alice" with host badge

**Test 2: Join Session Flow**
1. Open `http://localhost:5173` in new tab
2. Click "Join a Room"
3. Enter session code from Test 1 (e.g., "ABC123")
4. Enter username (e.g., "Bob")
5. Verify:
   - ‚úÖ Navigates to `/jam`
   - ‚úÖ Session code matches Test 1
   - ‚úÖ Participant list shows "Alice" (host) and "Bob"
   - ‚úÖ Both tabs show same participant list

**Test 3: Real-Time Participant Updates**
1. Use tabs from Tests 1 and 2
2. In Tab 3, join same session (username "Charlie")
3. Verify:
   - ‚úÖ All tabs show 3 participants
   - ‚úÖ Updates appear within 200ms
   - ‚úÖ Join timestamps displayed

**Test 4: Leave Session**
1. In Tab 2 (Bob), click "Leave Session"
2. Confirm in modal
3. Verify:
   - ‚úÖ Tab 2 navigates to WelcomeScreen
   - ‚úÖ Tabs 1 and 3 show only "Alice" and "Charlie"
   - ‚úÖ Participant count updated

**Test 5: Connection Status**
1. Monitor connection indicator in session header
2. Open DevTools ‚Üí Network ‚Üí Throttle to "Offline"
3. Wait 2 seconds, then set to "Online"
4. Verify:
   - ‚úÖ Status changes: Connected ‚Üí Disconnected ‚Üí Reconnecting ‚Üí Connected
   - ‚úÖ Participant list re-syncs after reconnection

**Test 6: Invalid Room Code**
1. Click "Join a Room"
2. Enter invalid code (e.g., "XXXXXX")
3. Verify:
   - ‚úÖ Error message displayed: "Session not found"
   - ‚úÖ Stays on WelcomeScreen (doesn't navigate)

### Verification Checklist

- ‚úÖ Creating session generates unique room code
- ‚úÖ Joining session with room code works across devices
- ‚úÖ Participant list updates when users join/leave
- ‚úÖ Host badge displays correctly
- ‚úÖ Leave session removes user from all participants' lists
- ‚úÖ Connection status indicator reflects actual state
- ‚úÖ Username modal only appears once (stored in localStorage)
- ‚úÖ Error handling works for invalid codes and network failures

---

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** Network failures during session join causing user frustration
**Mitigation:**
- Clear error messages ("Connection failed, please try again")
- Automatic reconnection built into Supabase
- Connection status indicator shows current state
- Rollback: User can leave session and try again

**Secondary Risk:** Username collisions (multiple users named "Alice")
**Mitigation:**
- Unique participant IDs (Supabase presence keys)
- Display names don't need to be unique for MVP
- Future: Add user IDs or suffixes if needed

### Compatibility Verification

- [x] **No breaking changes** - Existing JamSession UI structure maintained
- [x] **Database changes** - None (uses Supabase channels only)
- [x] **UI changes** - Additive (username modal, connection indicator)
- [x] **Performance impact** - Negligible (single WebSocket connection)

---

## Scope Validation

- [x] Story can be completed in **4-6 hours** (one focused development session)
- [x] Integration approach is straightforward (service API already defined)
- [x] Follows existing patterns (React hooks, localStorage, navigation)
- [x] No design work required (reuse existing UI components)

---

## Deliverables

1. **UsernameModal Component**
   - `src/components/JamSession/UsernameModal.tsx` (~80 lines)
   - Simple text input with save button

2. **Updated JamSession Component**
   - `src/components/JamSession/JamSession.tsx` (modified, ~100 lines added)
   - Session lifecycle integration (create/join/leave)

3. **Updated UserList Component**
   - `src/components/JamSession/UserList.tsx` (modified, ~50 lines changed)
   - Real-time participant display

4. **Connection Status Indicator**
   - `src/components/JamSession/ConnectionStatus.tsx` (~50 lines)
   - Visual status indicator component

5. **Updated WelcomeScreen**
   - `src/components/Welcome/WelcomeScreen.tsx` (modified, ~30 lines added)
   - Username modal integration

---

## Next Steps After Story 7.3

Once this story is complete, proceed to:
- **Story 7.4:** Shareable Session URLs (2-3 hours)
  - Enable copying session URLs for easy sharing
  - Parse room codes from URL parameters

---

## References

- **Epic 7:** `docs/epics/epic-7-jam-session-backend.md`
- **Story 7.2:** `docs/stories/7.2-supabase-realtime-service.md`
- **Supabase Realtime Docs:**
  - Presence: https://supabase.com/docs/guides/realtime/presence

---

**Story Created:** 2025-10-13
**Story Owner:** Product Manager (John)
**Estimated Completion:** 4-6 hours after start
