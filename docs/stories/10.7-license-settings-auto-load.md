# Story 10.7: License Settings Auto-Load on Startup

**Epic:** Epic 3 - Multi-Controller Pro Monetization
**Status:** üìù PLANNING
**Priority:** üü° MEDIUM
**Complexity:** Medium
**Time Estimate:** 3-4 hours
**Prerequisites:** Story 10.5 (License Management), Story 7.10 (User Settings Persistence)

---

## User Story

As a **Pro tier subscriber**,
I want **my licensed features and hardware controllers automatically unlocked on app startup**,
So that **I can start working immediately without manual feature activation**.

---

## Story Context

### Why This Story

**Pro User Pain Point (Before):**
- User signs in
- Opens app
- Sees "Upgrade to Pro" prompts despite having active subscription
- Must manually refresh or click "Restore License" button
- Frustrating experience for paying customers

**Pro User Experience (After):**
- User signs in
- App automatically loads license from backend
- Pro features immediately unlocked:
  - Hardware controllers (Launchpad, MPK Mini, BeatStep)
  - WLED advanced features
  - Presets library
  - Multi-device setups
- Notification: "Pro features enabled"
- **Zero friction** - seamless professional experience

**Free User Experience (After):**
- User signs in (or anonymous)
- License status: "Free tier"
- Clear upgrade prompts when accessing Pro features
- Demo mode available (5-minute trial)

### Current State

- ‚úÖ License Manager service exists (Story 10.5 - planned)
- ‚úÖ User Settings infrastructure (Story 7.10 - planned)
- ‚ùå No automatic license load on startup
- ‚ùå No license status persistence

### Desired State

- ‚úÖ License auto-loaded from Supabase on startup (<300ms)
- ‚úÖ License cached in settings table (`license` category)
- ‚úÖ Hardware controllers auto-unlock based on license
- ‚úÖ Feature gates respect license status
- ‚úÖ License expiry warning (7 days before expiration)

---

## Acceptance Criteria

### Functional Requirements

1. **License Settings Category**
   - Add `license` category to user settings:
     ```typescript
     interface LicenseSettings {
       tier: 'free' | 'pro';
       expiresAt: string | null; // ISO timestamp
       features: string[]; // Enabled feature flags
       hardwareUnlocked: string[]; // Controller names
       lastChecked: string; // Last validation timestamp
     }
     ```
   - License settings are **read-only** for users (written by license service only)

2. **License Validation on Startup**
   - On app initialization:
     1. Check auth status (useAuth)
     2. Load user settings including license (Story 7.10)
     3. If no license settings OR last checked >24 hours ago:
        - Fetch license from Stripe/backend
        - Validate subscription status
        - Update license settings in Supabase
     4. Apply license to GlobalMusicContext
   - **Latency Target:** <300ms (parallel with settings load)

3. **License Service Integration**
   ```typescript
   // src/services/LicenseService.ts

   class LicenseService {
     // Fetch license from backend (Stripe API)
     static async fetchLicense(userId: string): Promise<LicenseSettings>

     // Validate license (check expiry, subscription status)
     static async validateLicense(license: LicenseSettings): Promise<boolean>

     // Save license to user_settings table
     static async saveLicense(userId: string, license: LicenseSettings): Promise<void>

     // Check if feature is licensed
     static isFeatureLicensed(feature: string): boolean

     // Check if hardware is licensed
     static isHardwareLicensed(controller: string): boolean

     // Get days until expiry (for warning)
     static getDaysUntilExpiry(license: LicenseSettings): number | null
   }
   ```

4. **Auto-Unlock Hardware Controllers**
   - When hardware controller connected (e.g., APC40 USB plugged in):
     1. Check license status: `LicenseService.isHardwareLicensed('apc40')`
     2. If licensed ‚Üí auto-enable controller
     3. If not licensed ‚Üí show "Upgrade to Pro" prompt with demo option
   - Hardware unlock status cached (no repeated license checks)

5. **Feature Gate Integration**
   - Update `RequireAuth` component from Story 18.0:
     ```typescript
     <RequireLicense
       feature="Launchpad Mini MK3"
       tier="pro"
       fallback={<UpgradePrompt controller="launchpad" />}
     >
       <LaunchpadController />
     </RequireLicense>
     ```
   - Feature gates check both auth AND license status

6. **License Expiry Warning**
   - If license expires in <7 days:
     - Show warning banner in app header
     - Warning text: "Your Pro subscription expires in X days - Renew now"
     - Click banner ‚Üí navigate to billing page
   - If license expired:
     - Downgrade to free tier automatically
     - Show notification: "Pro features disabled - subscription expired"
     - Preserve user data (don't delete WLED devices, settings)

7. **GlobalMusicContext License State**
   ```typescript
   interface GlobalMusicState {
     // ... existing fields
     license: {
       tier: 'free' | 'pro';
       features: string[];
       hardwareUnlocked: string[];
       expiresAt: string | null;
       daysUntilExpiry: number | null;
       isValid: boolean;
     };
     licenseLoading: boolean;
     checkLicense: () => Promise<void>; // Manual refresh
   }
   ```

8. **Startup Notification**
   - Pro users see notification on startup:
     - Icon: CheckCircle (green)
     - Text: "Pro features enabled"
     - Duration: 3 seconds
     - Position: Top-right corner
   - Free users see no notification (silent)

### Integration Requirements

9. **Stripe Integration** (or equivalent payment provider)
   - Connect to Stripe API for subscription status
   - Environment variables:
     ```
     VITE_STRIPE_PUBLIC_KEY=pk_live_...
     STRIPE_SECRET_KEY=sk_live_... (server-side only)
     ```
   - Fetch customer subscription:
     ```typescript
     const subscription = await stripe.subscriptions.retrieve(subscriptionId);
     const isActive = subscription.status === 'active';
     ```

10. **Supabase Edge Function** (optional, for secure license validation)
    - Create Edge Function: `validate-license`
    - Input: `userId`
    - Output: `LicenseSettings`
    - Logic:
      1. Fetch user's Stripe customer ID from `user_profiles` table
      2. Call Stripe API to get subscription status
      3. Return license settings
    - Benefits: Keeps Stripe secret key server-side only

### Quality Requirements

11. **Performance**
    - License load completes <300ms (parallel with settings load)
    - License validation cached for 24 hours (avoid repeated Stripe API calls)
    - No UI blocking during license check

12. **Security**
    - **Never expose Stripe secret key to client**
    - RLS policy: Users can read own license settings, but cannot write
    - License validation happens server-side (Edge Function or backend)
    - Client receives validated license data only

13. **Error Handling**
    - Stripe API error ‚Üí assume free tier, show warning
    - Network error ‚Üí use cached license (last known state)
    - Invalid license data ‚Üí downgrade to free tier
    - User-friendly error messages (no technical jargon)

---

## Technical Approach

### Phase 1: License Service (1.5 hours)

**Create LicenseService:**
```typescript
// src/services/LicenseService.ts

import { supabase } from '@/lib/supabase';
import { LicenseSettings } from '@/types/settings';

export class LicenseService {
  private static cachedLicense: LicenseSettings | null = null;

  // Fetch license from Supabase Edge Function
  static async fetchLicense(userId: string): Promise<LicenseSettings> {
    try {
      const { data, error } = await supabase.functions.invoke('validate-license', {
        body: { userId }
      });

      if (error) throw error;

      return data as LicenseSettings;
    } catch (error) {
      console.error('Failed to fetch license:', error);
      return this.getFreeTierLicense();
    }
  }

  // Validate license (check expiry)
  static validateLicense(license: LicenseSettings): boolean {
    if (!license || license.tier === 'free') return true;

    // Check if expired
    if (license.expiresAt) {
      const expiryDate = new Date(license.expiresAt);
      const now = new Date();
      if (now > expiryDate) return false;
    }

    return true;
  }

  // Save license to user_settings (via service, not direct client access)
  static async saveLicense(userId: string, license: LicenseSettings): Promise<void> {
    // Call Edge Function to save (server-side only)
    await supabase.functions.invoke('save-license', {
      body: { userId, license }
    });
  }

  // Check if feature is licensed
  static isFeatureLicensed(feature: string): boolean {
    if (!this.cachedLicense) return false;
    return this.cachedLicense.features.includes(feature);
  }

  // Check if hardware is licensed
  static isHardwareLicensed(controller: string): boolean {
    if (!this.cachedLicense) return false;
    return this.cachedLicense.hardwareUnlocked.includes(controller);
  }

  // Get days until expiry
  static getDaysUntilExpiry(license: LicenseSettings): number | null {
    if (!license.expiresAt) return null;

    const expiryDate = new Date(license.expiresAt);
    const now = new Date();
    const diff = expiryDate.getTime() - now.getTime();
    const days = Math.ceil(diff / (1000 * 60 * 60 * 24));

    return days > 0 ? days : 0;
  }

  // Get free tier license (default)
  static getFreeTierLicense(): LicenseSettings {
    return {
      tier: 'free',
      expiresAt: null,
      features: [],
      hardwareUnlocked: ['apc40'], // Free tier gets APC40 (legacy support)
      lastChecked: new Date().toISOString(),
    };
  }

  // Cache license (avoid repeated fetches)
  static setCachedLicense(license: LicenseSettings): void {
    this.cachedLicense = license;
  }

  static getCachedLicense(): LicenseSettings | null {
    return this.cachedLicense;
  }
}
```

### Phase 2: Supabase Edge Function (1 hour)

**Create Edge Function:**
```typescript
// supabase/functions/validate-license/index.ts

import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
import Stripe from 'https://esm.sh/stripe@11.16.0';

const stripe = new Stripe(Deno.env.get('STRIPE_SECRET_KEY')!, {
  apiVersion: '2022-11-15',
});

const supabaseUrl = Deno.env.get('SUPABASE_URL')!;
const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;
const supabase = createClient(supabaseUrl, supabaseServiceKey);

serve(async (req) => {
  try {
    const { userId } = await req.json();

    // Fetch user's Stripe customer ID from user_profiles
    const { data: profile, error } = await supabase
      .from('user_profiles')
      .select('stripe_customer_id')
      .eq('id', userId)
      .single();

    if (error || !profile?.stripe_customer_id) {
      // No Stripe customer ‚Üí free tier
      return new Response(JSON.stringify({
        tier: 'free',
        expiresAt: null,
        features: [],
        hardwareUnlocked: ['apc40'],
        lastChecked: new Date().toISOString(),
      }), {
        headers: { 'Content-Type': 'application/json' }
      });
    }

    // Fetch subscriptions from Stripe
    const subscriptions = await stripe.subscriptions.list({
      customer: profile.stripe_customer_id,
      status: 'active',
      limit: 1,
    });

    if (subscriptions.data.length === 0) {
      // No active subscription ‚Üí free tier
      return new Response(JSON.stringify({
        tier: 'free',
        expiresAt: null,
        features: [],
        hardwareUnlocked: ['apc40'],
        lastChecked: new Date().toISOString(),
      }), {
        headers: { 'Content-Type': 'application/json' }
      });
    }

    // Active Pro subscription found
    const subscription = subscriptions.data[0];
    const expiresAt = new Date(subscription.current_period_end * 1000).toISOString();

    return new Response(JSON.stringify({
      tier: 'pro',
      expiresAt,
      features: ['multi-controller', 'wled-advanced', 'presets-library'],
      hardwareUnlocked: ['apc40', 'launchpad', 'mpk-mini', 'beatstep'],
      lastChecked: new Date().toISOString(),
    }), {
      headers: { 'Content-Type': 'application/json' }
    });

  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' }
    });
  }
});
```

**Deploy Edge Function:**
```bash
supabase functions deploy validate-license
```

### Phase 3: GlobalMusicContext Integration (1 hour)

**Extend Context:**
```typescript
// src/contexts/GlobalMusicContext.tsx

import { LicenseService } from '@/services/LicenseService';

export interface GlobalMusicState {
  // ... existing fields
  license: {
    tier: 'free' | 'pro';
    features: string[];
    hardwareUnlocked: string[];
    expiresAt: string | null;
    daysUntilExpiry: number | null;
    isValid: boolean;
  };
  licenseLoading: boolean;
  checkLicense: () => Promise<void>;
}

export const GlobalMusicProvider: React.FC = ({ children }) => {
  const { user, isAuthenticated } = useAuth();
  const { settings, loading: settingsLoading } = useSettings();
  const [licenseLoading, setLicenseLoading] = useState(true);
  const [license, setLicense] = useState(LicenseService.getFreeTierLicense());

  // Load license on startup
  useEffect(() => {
    async function loadLicense() {
      if (!isAuthenticated || !user) {
        setLicense(LicenseService.getFreeTierLicense());
        setLicenseLoading(false);
        return;
      }

      setLicenseLoading(true);

      // Check if cached license is recent (<24 hours old)
      if (settings.license) {
        const lastChecked = new Date(settings.license.lastChecked);
        const now = new Date();
        const hoursSinceCheck = (now.getTime() - lastChecked.getTime()) / (1000 * 60 * 60);

        if (hoursSinceCheck < 24) {
          // Use cached license
          setLicense(settings.license);
          LicenseService.setCachedLicense(settings.license);
          setLicenseLoading(false);
          return;
        }
      }

      // Fetch fresh license from backend
      const freshLicense = await LicenseService.fetchLicense(user.id);
      const isValid = LicenseService.validateLicense(freshLicense);

      setLicense({
        ...freshLicense,
        daysUntilExpiry: LicenseService.getDaysUntilExpiry(freshLicense),
        isValid,
      });

      LicenseService.setCachedLicense(freshLicense);

      // Save to user_settings (cache for next startup)
      await LicenseService.saveLicense(user.id, freshLicense);

      setLicenseLoading(false);

      // Show notification for Pro users
      if (freshLicense.tier === 'pro' && isValid) {
        showNotification({
          type: 'success',
          message: 'Pro features enabled',
          duration: 3000,
        });
      }
    }

    loadLicense();
  }, [user, isAuthenticated, settings]);

  // Manual license refresh
  const checkLicense = useCallback(async () => {
    if (!user) return;

    setLicenseLoading(true);
    const freshLicense = await LicenseService.fetchLicense(user.id);
    const isValid = LicenseService.validateLicense(freshLicense);

    setLicense({
      ...freshLicense,
      daysUntilExpiry: LicenseService.getDaysUntilExpiry(freshLicense),
      isValid,
    });

    await LicenseService.saveLicense(user.id, freshLicense);
    setLicenseLoading(false);
  }, [user]);

  const contextValue = useMemo(() => ({
    // ... existing values
    license,
    licenseLoading,
    checkLicense,
  }), [license, licenseLoading, checkLicense]);

  return (
    <GlobalMusicContext.Provider value={contextValue}>
      {children}
    </GlobalMusicContext.Provider>
  );
};
```

### Phase 4: License Expiry Warning (30 min)

**Create Warning Banner:**
```typescript
// src/components/License/ExpiryWarningBanner.tsx

import { AlertTriangle } from 'lucide-react';
import { useGlobalMusic } from '@/hooks/useGlobalMusic';

export const ExpiryWarningBanner: React.FC = () => {
  const { license } = useGlobalMusic();

  if (license.tier !== 'pro' || !license.daysUntilExpiry) return null;
  if (license.daysUntilExpiry > 7) return null;

  return (
    <div className="bg-yellow-600/20 border-b border-yellow-600/50 px-4 py-2">
      <div className="flex items-center justify-between max-w-7xl mx-auto">
        <div className="flex items-center gap-2">
          <AlertTriangle className="w-5 h-5 text-yellow-400" />
          <p className="text-sm text-yellow-100">
            Your Pro subscription expires in <strong>{license.daysUntilExpiry} days</strong>
          </p>
        </div>
        <a
          href="/billing"
          className="text-sm font-medium text-yellow-100 hover:text-white underline"
        >
          Renew Now
        </a>
      </div>
    </div>
  );
};
```

**Add to App.tsx:**
```typescript
// src/App.tsx

export const App: React.FC = () => {
  return (
    <GlobalMusicProvider>
      <ExpiryWarningBanner />
      <AppRoutes />
    </GlobalMusicProvider>
  );
};
```

---

## Integration Verification

### Manual Testing Steps

**Test 1: Free Tier User**
1. Sign in with free tier account (no Stripe subscription)
2. Wait for license load
3. Check console: `console.log(license)`
4. **Expected:** tier = "free", hardwareUnlocked = ["apc40"]
5. Attempt to use Launchpad controller
6. **Expected:** "Upgrade to Pro" prompt appears

**Test 2: Pro Tier User**
1. Sign in with Pro account (active Stripe subscription)
2. Wait for license load
3. Verify notification: "Pro features enabled"
4. Check console: tier = "pro", hardwareUnlocked = ["apc40", "launchpad", ...]
5. Connect Launchpad controller
6. **Expected:** Controller auto-unlocks, no upgrade prompt

**Test 3: License Caching**
1. Sign in as Pro user
2. Wait for license load (fresh fetch from Stripe)
3. Reload page
4. **Expected:** License loaded from cache (<10ms, no Stripe API call)
5. Wait 24 hours
6. Reload page
7. **Expected:** License refreshed from Stripe (>24 hours since last check)

**Test 4: License Expiry Warning**
1. Create test subscription with expiry in 5 days
2. Sign in
3. **Expected:** Yellow warning banner appears: "Expires in 5 days"
4. Click "Renew Now"
5. **Expected:** Navigate to billing page

**Test 5: Expired License**
1. Create test subscription with expiry in past
2. Sign in
3. Wait for license load
4. **Expected:**
   - tier = "free" (downgraded automatically)
   - Notification: "Pro features disabled - subscription expired"
   - Hardware controllers locked (except APC40)

**Test 6: Supabase Edge Function**
```bash
# Test validate-license function
curl -X POST https://<project-id>.supabase.co/functions/v1/validate-license \
  -H "Authorization: Bearer <anon-key>" \
  -H "Content-Type: application/json" \
  -d '{"userId": "<user-id>"}'

# Expected response (Pro user):
{
  "tier": "pro",
  "expiresAt": "2025-12-31T23:59:59Z",
  "features": ["multi-controller", "wled-advanced", "presets-library"],
  "hardwareUnlocked": ["apc40", "launchpad", "mpk-mini", "beatstep"],
  "lastChecked": "2025-10-20T12:00:00Z"
}
```

---

## Dependencies

### Prerequisites
- ‚úÖ **Story 10.5 Complete:** License Management (LicenseManager service)
- ‚úÖ **Story 7.10 Complete:** User Settings Persistence (settings infrastructure)
- ‚úÖ **Story 18.0 Complete:** User Authentication (auth system)

### External Dependencies
- Stripe account + API keys (for subscription validation)
- Supabase Edge Functions enabled (for secure license validation)

---

## Deliverables

1. **License Service**
   - `src/services/LicenseService.ts` (~200 lines)
   - Updated `src/types/settings.ts` (+LicenseSettings interface)

2. **Supabase Edge Function**
   - `supabase/functions/validate-license/index.ts` (~120 lines)
   - Environment variables configured (Stripe secret key)

3. **Context Updates**
   - Modified `src/contexts/GlobalMusicContext.tsx` (+100 lines)

4. **UI Components**
   - `src/components/License/ExpiryWarningBanner.tsx` (~60 lines)
   - Updated `src/App.tsx` (+5 lines)

5. **Database Migration** (if needed)
   - Add `stripe_customer_id` column to `user_profiles` table

6. **Documentation**
   - Updated `docs/architecture/admin-settings-startup.md`
   - Stripe integration guide

---

## Definition of Done

- [ ] LicenseService implemented (fetch, validate, cache)
- [ ] Supabase Edge Function deployed (`validate-license`)
- [ ] GlobalMusicContext extended with license state
- [ ] License auto-loads on app startup (<300ms)
- [ ] License cached for 24 hours (avoid excessive Stripe API calls)
- [ ] Pro users see "Pro features enabled" notification
- [ ] Expiry warning banner implemented (7-day threshold)
- [ ] Expired licenses auto-downgrade to free tier
- [ ] Hardware controllers auto-unlock based on license
- [ ] Feature gates respect license status
- [ ] All manual tests passing (Tests 1-6)
- [ ] Stripe integration tested (sandbox mode)
- [ ] RLS policies verified (users can read own license, not write)
- [ ] No TypeScript errors (strict mode)
- [ ] Documentation updated

---

## Security Considerations

### Stripe Secret Key Protection

**CRITICAL:** Never expose Stripe secret key to client

**Approach:**
1. Store secret key in Supabase Edge Function environment variables
2. Edge Function validates license server-side
3. Client receives validated license data only
4. RLS policy prevents users from writing license settings

**Environment Variables:**
```bash
# Set via Supabase CLI
supabase secrets set STRIPE_SECRET_KEY=sk_live_...
```

### RLS Policy for License Settings

```sql
-- Users can READ own license settings
CREATE POLICY "Users can read own license"
  ON user_settings
  FOR SELECT
  USING (
    auth.uid() = user_id AND
    settings_category = 'license'
  );

-- Users CANNOT WRITE license settings (server-side only)
-- No INSERT/UPDATE/DELETE policies for license category
```

---

## Next Steps After Story 10.7

Once this story is complete:
- **Story 10.8:** Billing page integration (Stripe Customer Portal)
- **Story 10.9:** License upgrade prompts UI (in-app upgrade flow)

---

## References

- **Epic 3:** Multi-Controller Pro Monetization (`docs/epics/epic-3-multi-controller-pro-monetization.md`)
- **Story 10.5:** License Management (`docs/stories/10.5.license-management.story.md`)
- **Story 7.10:** User Settings Persistence (`docs/stories/7.10-user-settings-persistence.md`)
- **Architecture Doc:** Admin Settings Startup (`docs/architecture/admin-settings-startup.md`)
- **Stripe Docs:** https://stripe.com/docs/api/subscriptions
- **Supabase Edge Functions:** https://supabase.com/docs/guides/functions

---

**Story Created:** 2025-10-20
**Story Owner:** Dev Agent
**Estimated Completion:** 3-4 hours after start
**Blocks:** Story 10.8, Story 10.9
