# Story 16.2: Interactive Temporal Proximity Highlighting

## Status
Complete

## Story
**As a** guitar player using the fretboard module,
**I want** to see harmonically related frets light up when I hover or click on a fret,
**so that** I can discover melodic pathways across strings and fret positions.

## Acceptance Criteria
1. Hover over fret → See bright related frets across strings (temporal proximity highlighting)
2. Pitch distance correctly maps to string jumps (0-2 semitones = same/adjacent strings, 3-5 = 1-2 string jumps, 6+ = large jumps)
3. Near pitches (1-2 semitones) highlight adjacent frets on same or nearby strings
4. Far pitches (6+ semitones) highlight 2-3 frets ahead with string jumps
5. Bidirectional support (ascending and descending melodic motion)
6. Touch devices use tap-and-hold for hover effect (300ms delay before showing guidance)

## Tasks / Subtasks

- [x] Add interaction state management (AC: 1)
  - [x] Add `lastInteractedFret: { string: number; fret: number } | null` state
  - [x] Add `hoveredFret: { string: number; fret: number } | null` state
  - [x] Add `handleFretHover(string, fret)` function
  - [x] Update state on hover enter/leave events

- [x] Implement string-to-string diagonal stagger logic (AC: 2, 3, 4)
  - [x] Calculate pitch distance: `Math.abs(currentPitch - lastInteractedPitch)`
  - [x] Map pitch distance to expected fret offset:
    - 0-2 semitones → 0 frets (same column, different strings)
    - 3-5 semitones → 1-2 frets ahead
    - 6+ semitones → 2-3 frets ahead
  - [x] Calculate expected string position based on pitch direction
  - [x] Create `isTemporallyClose(string, fret, lastInteractedFret)` function

- [x] Apply proximity multiplier for far pitches (AC: 4)
  - [x] If pitch distance >= 6 semitones: multiply brightness × 0.75
  - [x] If pitch distance >= 3 semitones: multiply brightness × 0.85
  - [x] Close pitches (0-2 semitones): no multiplier (1.0)

- [x] Implement bidirectional pattern support (AC: 5)
  - [x] Forward diagonal (ascending): pitch > lastInteractedPitch → positive fret offset
  - [x] Backward diagonal (descending): pitch < lastInteractedPitch → negative fret offset
  - [x] Check if current fret is within ±1 fret of expected position (tolerance)

- [x] Add hover handlers to FretboardCanvas (AC: 1, 6)
  - [x] Add `onMouseEnter` handler to fret cells
  - [x] Add `onMouseLeave` handler to clear hover state
  - [x] Add `onTouchStart` + timeout (300ms) for touch devices
  - [x] Add `onTouchEnd` to clear tap-and-hold state
  - [x] Pass hover state to cell rendering function

- [x] Update cell rendering with temporal proximity brightness (AC: 1)
  - [x] Check if cell is temporally close to `lastInteractedFret`
  - [x] If yes: apply full harmonic brightness × proximity multiplier
  - [x] If no: fall back to base brightness or ghost brightness
  - [x] Ensure placed notes always show full brightness (1.0)

## Dev Notes

### Relevant Source Tree
- **GuitarFretboard**: `src/components/GuitarFretboard/GuitarFretboard.tsx`
- **FretboardCanvas**: `src/components/GuitarFretboard/FretboardCanvas.tsx`
- **Constants**: `src/components/GuitarFretboard/constants.ts` (getMIDINoteFromFret)
- **MelodySequencer Reference**: `src/components/Studio/modules/ChordMelodyArranger/MelodySequencer.tsx` (lines 900-930 for temporal proximity logic)

### Diagonal Stagger Pattern for Guitar

**Piano Roll (Reference)**:
- Temporal offset based purely on pitch distance
- Time progresses horizontally (step axis)
- Pitch progresses vertically (note axis)

**Guitar Fretboard (Adaptation)**:
- Temporal offset maps to **fret position** (horizontal axis)
- Pitch distance maps to **string jumps** (vertical axis)
- Same pitch on multiple strings → prefer string closer to last interacted string

**String Jump Mapping**:
```
Pitch Distance (semitones) → Expected String/Fret Pattern
0-2:  Same string or adjacent string, same fret column
3-5:  1-2 string jumps, 1-2 frets ahead
6-9:  2-3 string jumps, 2-3 frets ahead
10+:  3+ string jumps, 3 frets ahead (octave leap)
```

**Example Scenario**:
```
User clicks: String 3 (G string), Fret 5 (C note, MIDI 60)

Highlight pattern (ascending):
- String 3, Fret 5: Full brightness (clicked note)
- String 3, Fret 7 (D, +2 semitones): Bright (same string, 2 frets ahead)
- String 2, Fret 5 (E, +4 semitones): Bright × 0.85 (adjacent string, same fret)
- String 2, Fret 8 (G, +7 semitones): Bright × 0.75 (string jump, 3 frets ahead)

Highlight pattern (descending):
- String 3, Fret 3 (Bb, -2 semitones): Bright (same string, 2 frets back)
- String 4, Fret 5 (G, -5 semitones): Bright × 0.85 (string jump, same fret)
- String 4, Fret 2 (E, -7 semitones): Bright × 0.75 (string jump, 3 frets back)
```

### Implementation Algorithm

```typescript
// In FretboardCanvas cell rendering loop
function calculateTemporalProximityBrightness(
  string: number,
  fret: number,
  lastInteractedFret: { string: number; fret: number } | null
): number | null {
  if (!lastInteractedFret) return null;

  // Get MIDI pitches
  const currentPitch = getMIDINoteFromFret(string, fret, currentTuningMIDI);
  const lastPitch = getMIDINoteFromFret(
    lastInteractedFret.string,
    lastInteractedFret.fret,
    currentTuningMIDI
  );

  const pitchDistance = Math.abs(currentPitch - lastPitch);

  // Calculate expected fret offset
  let expectedFretOffset = 0;
  let proximityMultiplier = 1.0;

  if (pitchDistance >= 6) {
    expectedFretOffset = 2; // Large interval
    proximityMultiplier = 0.75;
  } else if (pitchDistance >= 3) {
    expectedFretOffset = 1; // Medium interval
    proximityMultiplier = 0.85;
  }
  // else: stepwise motion, no offset (0)

  // Bidirectional support
  const isAscending = currentPitch > lastPitch;
  const fretOffset = isAscending ? expectedFretOffset : -expectedFretOffset;
  const expectedFret = lastInteractedFret.fret + fretOffset;

  // Check if current fret is within tolerance (±1 fret)
  const isTemporallyClose = Math.abs(fret - expectedFret) <= 1;

  if (!isTemporallyClose) return null;

  // Calculate harmonic brightness
  const harmonicBrightness = melodyService.calculateNoteBrightness(
    currentPitch,
    0, // Use step 0 (strong beat) for maximum chord tone emphasis
    currentChord,
    scaleNotes,
    settings,
    lastPitch, // Pass last pitch for interval-based adjustments
    false // Not a placed note
  );

  return harmonicBrightness * proximityMultiplier;
}
```

### Touch Interaction Pattern

**Desktop (Mouse)**:
- Hover → Immediately show temporal proximity highlighting
- Leave → Clear highlighting

**Mobile (Touch)**:
- Tap → Place note (existing behavior)
- Tap-and-hold (300ms) → Show temporal proximity highlighting
- Release → Clear highlighting (or place note if <300ms)

```typescript
let touchTimer: NodeJS.Timeout | null = null;

const handleTouchStart = (string: number, fret: number) => {
  touchTimer = setTimeout(() => {
    // Show hover-style highlighting
    setHoveredFret({ string, fret });
  }, 300);
};

const handleTouchEnd = (string: number, fret: number, touchDuration: number) => {
  if (touchTimer) clearTimeout(touchTimer);

  if (touchDuration < 300) {
    // Short tap → Place note (existing behavior)
    handleFretClick(string, fret);
  }

  // Clear hover state
  setHoveredFret(null);
};
```

### Visual Priority Hierarchy

When rendering cell brightness, use this priority:
1. **Placed note** (brightness = 1.0, full color background + white border)
2. **Temporal proximity highlighting** (brightness = 0.2-1.0 × proximityMultiplier, colored border)
3. **Ghost imprints** (brightness = 0.14-0.7, faint colored border) [Story 16.3]
4. **Base brightness** (brightness = 0.4, very dim colored border)

```typescript
let brightness = 0.4; // Default base brightness

// Check for placed note (highest priority)
if (isPlacedNote) {
  brightness = 1.0;
}
// Check for temporal proximity (interactive highlighting)
else if (showHarmonicGuidance && hoveredFret) {
  const temporalBrightness = calculateTemporalProximityBrightness(string, fret, hoveredFret);
  if (temporalBrightness !== null) {
    brightness = temporalBrightness;
  }
}
// Else: fall back to ghost brightness or base brightness
```

### Testing
**Manual Verification Steps**:

1. **Hover Highlighting (Desktop)**:
   - Hover over fret on String 3, Fret 5
   - Verify related frets light up across strings
   - Verify pitch distance maps correctly to string jumps
   - Move mouse away → Highlighting clears

2. **Bidirectional Pattern**:
   - Hover over middle fret (e.g., String 3, Fret 5)
   - Verify ascending frets (higher pitches) light up to the right
   - Verify descending frets (lower pitches) light up to the left

3. **Proximity Multiplier**:
   - Hover over fret
   - Verify far pitches (6+ semitones) are dimmer than close pitches
   - Verify medium pitches (3-5 semitones) have intermediate brightness

4. **Touch Interaction (Mobile)**:
   - On mobile device or DevTools mobile emulation
   - Tap-and-hold fret for 300ms
   - Verify hover highlighting appears
   - Release → Highlighting clears
   - Short tap (<300ms) → Note placed (existing behavior)

5. **Performance**:
   - Hover rapidly across multiple frets
   - Verify smooth transitions (no lag)
   - Check frame rate stays at 60 FPS

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-15 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
N/A - Completed prior to formal tracking

### Completion Notes
- Temporal proximity highlighting fully implemented in FretboardCanvas.tsx
- Hover handlers (onMouseMove, onMouseLeave) integrated
- calculateTemporalProximity callback system in place
- Visual priority system: placed notes > temporal proximity > base brightness
- All acceptance criteria verified in implementation

### File List
- src/components/GuitarFretboard/FretboardCanvas.tsx

## QA Results
*To be filled by QA agent*
