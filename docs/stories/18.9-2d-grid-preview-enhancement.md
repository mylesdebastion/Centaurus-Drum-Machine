# Story 18.9: 2D Grid/Matrix LED Preview Enhancement

**Epic:** Epic 18 - Intelligent WLED Visualization Routing
**Status:** üìã BACKLOG (Future Enhancement)
**Priority:** üîµ LOW
**Estimate:** 3-4 hours
**Dependencies:** 18.8 (Virtual LED Preview Integration - 1D strips)

## Architectural Context

**Foundation:** Story 18.8 implemented 1D strip LED preview (400x8px canvas). Story 18.9 extends this to support 2D grid/matrix visualization.

**Reference Pattern:** `src/components/LEDStripManager/VirtualLEDStrip.tsx` (has placeholder for 2D matrix rendering)
**Target Component:** `src/components/WLED/WLEDVirtualPreview.tsx` (currently shows "Matrix visualization coming soon")

**Key Difference:** 2D grids require matrix layout with serpentine wiring support, orientation handling, and grid-to-canvas mapping.

---

## Story

**As a** user configuring 2D grid WLED devices (e.g., 6x25 LED matrices),
**I want** to see a real-time 2D matrix preview of LED output in the WLED Manager,
**so that** I can verify grid routing, serpentine wiring, and orientation are correct without physical hardware.

---

## Acceptance Criteria

**PRIMARY FOCUS: 2D Grid Visualization**

1. **2D Matrix Canvas Rendering** (NEW FUNCTIONALITY)
   - WLEDVirtualPreview detects device type: `device.capabilities.dimensions === '2D'`
   - Renders 2D matrix preview instead of 1D strip
   - Canvas dimensions scale to grid aspect ratio (max 400px width, proportional height)
   - Each LED rendered as square pixel (gridConfig.width √ó gridConfig.height)
   - Grid visualization respects serpentine wiring (`gridConfig.serpentine`)
   - Grid visualization respects orientation (`gridConfig.orientation`: 'horizontal' | 'vertical')

2. **Serpentine Wiring Support** (NEW FUNCTIONALITY)
   - When `gridConfig.serpentine === true`, alternate rows are reversed
   - Visual representation matches physical LED wiring (zigzag pattern)
   - Even rows: left ‚Üí right
   - Odd rows: right ‚Üí left (reversed)

3. **Grid Orientation Support** (NEW FUNCTIONALITY)
   - Horizontal orientation: data flows left-to-right, top-to-bottom
   - Vertical orientation: data flows top-to-bottom, left-to-right
   - Canvas rotation/transformation applied based on orientation setting

4. **Visual Fidelity** (EXTEND FROM 18.8)
   - Same color accuracy as 1D strip preview
   - Same brightness multiplier (2.5x) for screen visibility
   - Off LEDs render as dark gray (#1a1a1a) background
   - Container styling consistent with 1D strip preview

5. **Performance & Optimization** (EXTEND FROM 18.8)
   - Preview limited to 300 LEDs maximum (same as 1D)
   - Over-limit grids show warning indicator (‚ö†Ô∏è 300)
   - Canvas rendering optimized with requestAnimationFrame
   - No frame drops with multiple 2D grid devices active

6. **Backward Compatibility** (VERIFY NO REGRESSION)
   - 1D strip preview continues to work (Story 18.8 functionality)
   - Device type detection switches between 1D and 2D rendering modes
   - Test patterns (rainbow, solid) work for both 1D and 2D devices

---

## Tasks / Subtasks

### Phase 1: 2D Grid Detection & Canvas Setup

- [ ] **Task 1: Add 2D Grid Detection Logic** (AC: 1)
  - [ ] Subtask 1.1: Check `device.capabilities.dimensions === '2D'`
  - [ ] Subtask 1.2: Extract `gridConfig` (width, height, serpentine, orientation)
  - [ ] Subtask 1.3: Calculate canvas dimensions (max 400px width, proportional height)
  - [ ] Subtask 1.4: Calculate LED pixel size (canvas width / grid width)
  - [ ] Subtask 1.5: Handle missing gridConfig gracefully (show error placeholder)

### Phase 2: Matrix Rendering Algorithm

- [ ] **Task 2: Implement 2D Grid Canvas Rendering** (AC: 1, 4)
  - [ ] Subtask 2.1: Create 2D rendering function (separate from 1D strip logic)
  - [ ] Subtask 2.2: Map hex color array to 2D grid coordinates
  - [ ] Subtask 2.3: Render each LED as filled rectangle (x, y, ledSize, ledSize)
  - [ ] Subtask 2.4: Apply brightness multiplier (2.5x) to grid LEDs
  - [ ] Subtask 2.5: Render off LEDs as dark gray background

### Phase 3: Serpentine Wiring Implementation

- [ ] **Task 3: Add Serpentine Wiring Support** (AC: 2)
  - [ ] Subtask 3.1: Detect `gridConfig.serpentine === true`
  - [ ] Subtask 3.2: Reverse alternate rows during rendering
  - [ ] Subtask 3.3: Calculate LED index accounting for serpentine pattern
  - [ ] Subtask 3.4: Test with 6x25 grid (150 LEDs, serpentine enabled)
  - [ ] Subtask 3.5: Visual verification (LEDs flow in zigzag pattern)

### Phase 4: Orientation Handling

- [ ] **Task 4: Add Grid Orientation Support** (AC: 3)
  - [ ] Subtask 4.1: Detect `gridConfig.orientation` ('horizontal' | 'vertical')
  - [ ] Subtask 4.2: Apply coordinate transformation for vertical orientation
  - [ ] Subtask 4.3: Adjust canvas dimensions for orientation (swap width/height)
  - [ ] Subtask 4.4: Test with both orientations (horizontal and vertical grids)

### Phase 5: Testing & Validation

- [ ] **Task 5: 2D Grid Integration Tests** (AC: ALL)
  - [ ] Subtask 5.1: Test with 6x25 grid (serpentine, horizontal orientation)
  - [ ] Subtask 5.2: Test with 10x10 grid (non-serpentine, vertical orientation)
  - [ ] Subtask 5.3: Test DrumMachine step sequencer on 2D grid
  - [ ] Subtask 5.4: Test overlay blending on 2D grid (audio reactive)
  - [ ] Subtask 5.5: Test with 300+ LED grid (performance limit warning)

- [ ] **Task 6: Backward Compatibility Tests** (AC: 6)
  - [ ] Subtask 6.1: Verify 1D strip preview still works (Story 18.8 regression)
  - [ ] Subtask 6.2: Test device type switching (1D ‚Üî 2D)
  - [ ] Subtask 6.3: Test mixed device types (grid + strip simultaneously)
  - [ ] Subtask 6.4: Verify test patterns work on both 1D and 2D devices

---

## Dev Notes

### Reference Implementation

**VirtualLEDStrip Placeholder (Line 186-192):**
```typescript
// Render matrix (2D) - Future enhancement
if (device.deviceType === 'matrix' && device.matrixConfig) {
  return (
    <div className="w-full bg-gray-800 rounded-lg p-2">
      <p className="text-xs text-gray-500 text-center">Matrix visualization coming soon</p>
    </div>
  );
}
```

**Implementation Location:** Replace this placeholder in WLEDVirtualPreview.tsx

### Grid Configuration Structure

```typescript
interface GridConfig {
  width: number;          // Number of LEDs per row (e.g., 6)
  height: number;         // Number of rows (e.g., 25)
  serpentine: boolean;    // Zigzag wiring pattern
  orientation: 'horizontal' | 'vertical'; // Data flow direction
}
```

### Canvas Dimensions Calculation

```typescript
// Example: 6x25 grid
const gridWidth = 6;
const gridHeight = 25;
const maxCanvasWidth = 400;

// Calculate LED pixel size
const ledSize = Math.floor(maxCanvasWidth / gridWidth); // 400 / 6 = 66px per LED
const canvasWidth = ledSize * gridWidth;  // 66 * 6 = 396px
const canvasHeight = ledSize * gridHeight; // 66 * 25 = 1650px

// For tall grids, may need to scale down further to fit screen
const maxCanvasHeight = 600; // Reasonable screen height
if (canvasHeight > maxCanvasHeight) {
  const scale = maxCanvasHeight / canvasHeight;
  canvasWidth *= scale;
  canvasHeight = maxCanvasHeight;
}
```

### Serpentine Wiring Algorithm

```typescript
// Convert linear LED index ‚Üí 2D grid coordinates (with serpentine)
function ledIndexToGridCoords(index: number, width: number, serpentine: boolean): [number, number] {
  const row = Math.floor(index / width);
  let col = index % width;

  // Reverse column for odd rows if serpentine
  if (serpentine && row % 2 === 1) {
    col = width - 1 - col;
  }

  return [col, row];
}

// Usage in rendering loop
for (let i = 0; i < ledCount; i++) {
  const [col, row] = ledIndexToGridCoords(i, gridConfig.width, gridConfig.serpentine);
  const x = col * ledSize;
  const y = row * ledSize;

  ctx.fillStyle = hexToRgb(ledColors[i]);
  ctx.fillRect(x, y, ledSize, ledSize);
}
```

### Orientation Transformation

```typescript
// For vertical orientation, swap x/y coordinates
if (gridConfig.orientation === 'vertical') {
  // Rotate grid 90 degrees
  const temp = canvasWidth;
  canvasWidth = canvasHeight;
  canvasHeight = temp;

  // Apply CSS transform
  canvas.style.transform = 'rotate(90deg)';
  canvas.style.transformOrigin = 'center';
}
```

### Modified Files

- `src/components/WLED/WLEDVirtualPreview.tsx` - **Add 2D grid rendering logic**
- No changes to WLEDDeviceManager (preview component already embedded in 18.8)
- No changes to types (GridConfig already defined in WLEDDevice interface)

### Reference Files (DO NOT MODIFY)

- `src/components/LEDStripManager/VirtualLEDStrip.tsx` - Matrix placeholder reference
- `src/services/LEDCompositor.ts` - Frame conversion logic (Story 18.6)
- `src/types/wled.ts` - GridConfig interface definition

### Testing Strategy

**Manual Browser Testing:**

1. **6x25 Grid Test (Serpentine, Horizontal):**
   - Configure device with 6 columns, 25 rows, serpentine enabled
   - Start DrumMachine module (step sequencer grid)
   - Verify LEDs flow in zigzag pattern (row 0: left‚Üíright, row 1: right‚Üíleft, etc.)

2. **10x10 Grid Test (Non-Serpentine, Vertical):**
   - Configure device with 10x10 grid, serpentine disabled, vertical orientation
   - Start DrumMachine module
   - Verify LEDs flow top-to-bottom, left-to-right

3. **Mixed Device Test:**
   - Configure 1x 6x25 grid + 1x 90 LED strip
   - Start DrumMachine module
   - Verify both previews update independently (grid shows matrix, strip shows 1D)

4. **Performance Test:**
   - Configure 20x20 grid (400 LEDs, over 300 limit)
   - Verify warning indicator (‚ö†Ô∏è 300) appears
   - Verify preview renders first 300 LEDs only

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Story created as future enhancement for 2D grid visualization | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
(Populated by dev agent during implementation)

### Debug Log References
(Populated by dev agent during implementation)

### Completion Notes List
(Populated by dev agent during implementation)

### File List
(Populated by dev agent during implementation)

---

## QA Results
(Populated by QA agent after story completion)
