# Story 18.8: Virtual LED Preview Integration

**Epic:** Epic 18 - Intelligent WLED Visualization Routing
**Status:** ✅ READY FOR DEVELOPMENT
**Priority:** 🟡 MEDIUM
**Estimate:** 2-3 hours (reduced from 4-6h - visual pattern already implemented)
**Dependencies:** 18.1 (WLED Device Registry), 18.5 (WLED Manager UI), 18.6 (LEDCompositor Integration)

## Architectural Context

**Key Insight:** WLEDVirtualPreview already implements the VirtualLEDStrip visual pattern (400x8px canvas, 300 LED limit, 2.5x brightness multiplier, direction indicators, test patterns). This story focuses on **adding compositor event integration**, not rewriting visual components.

**Reference Pattern:** `src/components/LEDStripManager/VirtualLEDStrip.tsx` (Isometric WLED Manager)
**Target Component:** `src/components/WLED/WLEDVirtualPreview.tsx` (already 95% visually identical)

---

## Story

**As a** user configuring WLED devices,
**I want** to see a real-time visual preview of LED output for each device,
**so that** I can verify routing is working correctly without needing physical hardware.

---

## Acceptance Criteria

**PRIMARY FOCUS: Compositor Event Integration**

1. **LEDCompositor Event Subscription** (NEW FUNCTIONALITY)
   - WLEDVirtualPreview subscribes to `composited-frame` events from LEDCompositor
   - Events filtered by device ID (`event.deviceId === device.id`)
   - Frame data converted from `Uint8ClampedArray` (RGB bytes) → `string[]` (hex colors)
   - Event subscription cleanup on component unmount
   - `showLivePreview` prop enables/disables compositor mode

2. **Real-Time Preview Updates** (NEW FUNCTIONALITY)
   - Preview displays blended output (primary visualization + overlays)
   - Updates automatically when modules submit frames via LEDCompositor
   - Frame updates respect routing matrix assignments
   - Multiple device previews update independently

3. **Visual Fidelity** (ALREADY IMPLEMENTED - VERIFY NO REGRESSION)
   - ✅ LED colors match composited output from LEDCompositor
   - ✅ Brightness multiplier (2.5x) applied for screen visibility
   - ✅ Off LEDs render as dark gray (#1a1a1a) background
   - ✅ Direction indicator shows reverse_direction setting (← or →)
   - ✅ Canvas dimensions: 400x8px (thin line style)
   - ✅ Container styling: `bg-gray-900 border border-gray-700 rounded p-1 relative`
   - ✅ Pixel-perfect rendering: `imageRendering: 'pixelated'`

4. **Performance & Optimization** (ALREADY IMPLEMENTED - VERIFY NO REGRESSION)
   - ✅ Preview limited to 300 LEDs maximum (performance threshold)
   - ✅ Over-limit devices show warning indicator (⚠️ 300)
   - ✅ Canvas rendering optimized with requestAnimationFrame
   - ✅ No frame drops when multiple devices active (60 FPS maintained)

5. **User Experience** (ALREADY IMPLEMENTED - VERIFY NO REGRESSION)
   - ✅ Preview shows test patterns when device in test mode
   - ✅ "Waiting for visualization..." placeholder when no data
   - ✅ Skeleton loader during device connection
   - ✅ Test pattern priority: overrides compositor events when active

---

## Tasks / Subtasks

**SIMPLIFIED TASK STRUCTURE: Focus on Compositor Integration Only**

### Phase 1: Compositor Event Integration (NEW FUNCTIONALITY)

- [ ] **Task 1: Add Compositor Event Subscription to WLEDVirtualPreview** (AC: 1, 2)
  - [ ] Subtask 1.1: Add `showLivePreview?: boolean` prop to WLEDVirtualPreviewProps interface
  - [ ] Subtask 1.2: Import `ledCompositor` singleton from `@/services/LEDCompositor`
  - [ ] Subtask 1.3: Create `useEffect` hook for compositor event subscription
  - [ ] Subtask 1.4: Subscribe to `composited-frame` events via `ledCompositor.addEventListener`
  - [ ] Subtask 1.5: Filter events by `event.deviceId === device.id`
  - [ ] Subtask 1.6: Convert `Uint8ClampedArray` → `string[]` hex colors (RGB bytes → "#RRGGBB")
  - [ ] Subtask 1.7: Update component state with converted colors (triggers canvas re-render)
  - [ ] Subtask 1.8: Clean up event listener on component unmount
  - [ ] Subtask 1.9: Test pattern priority: `testPattern` prop overrides compositor events

### Phase 2: WLEDDeviceManager Integration

- [ ] **Task 2: Embed Preview in Device Cards** (AC: 2)
  - [ ] Subtask 2.1: Import `WLEDVirtualPreview` in WLEDDeviceManager
  - [ ] Subtask 2.2: Add preview component to device card layout (after device info, before controls)
  - [ ] Subtask 2.3: Pass `device` object and `showLivePreview={true}` prop
  - [ ] Subtask 2.4: Verify responsive design (mobile/tablet/desktop breakpoints)
  - [ ] Subtask 2.5: Test with multiple devices (independent preview updates)

### Phase 3: Regression Testing (VERIFY EXISTING FUNCTIONALITY)

- [ ] **Task 3: Visual Fidelity Regression Tests** (AC: 3)
  - [ ] Subtask 3.1: Compare canvas appearance with VirtualLEDStrip (Isometric reference)
  - [ ] Subtask 3.2: Verify direction indicator position (top-right corner)
  - [ ] Subtask 3.3: Verify LED limit warning (⚠️ 300 when >300 LEDs)
  - [ ] Subtask 3.4: Verify off LED color (#1a1a1a dark gray background)
  - [ ] Subtask 3.5: Verify container styling (gray border, padding, rounded corners)

- [ ] **Task 4: Performance Regression Tests** (AC: 4)
  - [ ] Subtask 4.1: Verify 300 LED limit enforcement
  - [ ] Subtask 4.2: Profile canvas rendering (Chrome DevTools Performance tab)
  - [ ] Subtask 4.3: Test with 5+ active devices (no frame drops, 60 FPS maintained)
  - [ ] Subtask 4.4: Verify requestAnimationFrame optimization still active

- [ ] **Task 5: User Experience Regression Tests** (AC: 5)
  - [ ] Subtask 5.1: Verify test pattern display (rainbow/solid modes)
  - [ ] Subtask 5.2: Verify skeleton loader during connection
  - [ ] Subtask 5.3: Verify "Waiting for visualization..." placeholder
  - [ ] Subtask 5.4: Verify test pattern overrides compositor events

### Phase 4: End-to-End Integration Testing

- [ ] **Task 6: Multi-Module Integration Tests** (AC: 1, 2)
  - [ ] Subtask 6.1: Test DrumMachine module → compositor → preview (step sequencer visualization)
  - [ ] Subtask 6.2: Test AudioReactive overlay blending in preview
  - [ ] Subtask 6.3: Test routing matrix changes (device reassignment updates preview)
  - [ ] Subtask 6.4: Test device hot-swap (disconnect/reconnect recovery)
  - [ ] Subtask 6.5: Test multi-device routing (grid + strip simultaneously)

---

## Dev Notes

### Integration Points

**WLEDVirtualPreview Component (ALREADY 95% COMPLETE):**
- Location: `src/components/WLED/WLEDVirtualPreview.tsx`
- Current Props: `{ device: WLEDDevice, ledColors?: string[] }`
- **NEW Prop:** `showLivePreview?: boolean` (enables compositor event mode)
- Existing Features (✅ ALREADY IMPLEMENTED):
  - ✅ Canvas-based rendering (400x8px for 1D strips)
  - ✅ Brightness multiplier (2.5x) for screen visibility
  - ✅ Test pattern support (rainbow, solid)
  - ✅ Direction indicator (← or →)
  - ✅ LED limit warning (⚠️ 300 max)
  - ✅ Skeleton loader for connection state
  - ✅ Placeholder text ("Waiting for visualization...")
  - ✅ Off LED rendering (#1a1a1a dark gray)
  - ✅ Pixel-perfect rendering (imageRendering: 'pixelated')

**Visual Pattern Reference:**
- `src/components/LEDStripManager/VirtualLEDStrip.tsx` (Isometric WLED Manager)
- **Architectural Note:** WLEDVirtualPreview already matches VirtualLEDStrip visual pattern
- **Task Scope:** Add compositor event subscription only (no visual changes needed)

**LEDCompositor Events:**
- Event Type: `CompositorEvent` (union type)
- Relevant Event: `{ type: 'composited-frame'; deviceId: string; pixelData: Uint8ClampedArray }`
- Subscription: `ledCompositor.addEventListener(callback)`
- Unsubscription: `ledCompositor.removeEventListener(callback)`
- Event Fired: After frame blending (primary + overlays)

**WLED Device Registry:**
- Device Structure: `WLEDDevice` interface
- Key Fields:
  - `id: string` - Device UUID (matches compositor event deviceId)
  - `capabilities.ledCount: number` - Total LED count
  - `capabilities.dimensions: '1D' | '2D'` - Device type
  - `reverse_direction: boolean` - LED order reversal
  - `brightness: number` - 0-255 global brightness

**WLEDDeviceManager Layout:**
- Location: `src/components/WLED/WLEDDeviceManager.tsx`
- Current Structure:
  - Device cards in grid layout
  - Each card shows: Name, IP, Status, Controls
  - Settings expandable panel
  - Test pattern buttons

### Data Flow (Compositor Event Integration)

```
[Module] → submitFrameWithRouting()
    ↓
[LEDCompositor] → routeFrame() → blendOverlays()
    ↓
[emit composited-frame event] ← NEW: WLEDVirtualPreview subscribes here
    ↓
[WLEDVirtualPreview]
    ↓ Filter: event.deviceId === device.id
    ↓ Convert: Uint8ClampedArray → string[] (hex colors)
    ↓ Update: setState(hexColors)
    ↓
[Canvas re-render with new colors]
```

**Key Integration Points:**
1. **Event Source:** `LEDCompositor.sendToDevice()` (line 1018-1024 in LEDCompositor.ts)
2. **Event Type:** `composited-frame` with `{ deviceId, pixelData }`
3. **Subscription:** `ledCompositor.addEventListener(callback)`
4. **Cleanup:** `ledCompositor.removeEventListener(callback)` on unmount

### Frame Conversion Logic (NEW IMPLEMENTATION)

**Compositor Event → Canvas Rendering:**

```typescript
// Step 1: Subscribe to compositor events
useEffect(() => {
  if (!showLivePreview) return;

  const handleCompositedFrame = (event: CompositorEvent) => {
    if (event.type !== 'composited-frame') return;
    if (event.deviceId !== device.id) return; // Filter by device

    // Step 2: Convert Uint8ClampedArray [R, G, B, ...] → string[] ["#RRGGBB", ...]
    const hexColors: string[] = [];
    for (let i = 0; i < event.pixelData.length; i += 3) {
      const r = event.pixelData[i].toString(16).padStart(2, '0');
      const g = event.pixelData[i + 1].toString(16).padStart(2, '0');
      const b = event.pixelData[i + 2].toString(16).padStart(2, '0');
      hexColors.push(`#${r}${g}${b}`);
    }

    // Step 3: Update state (triggers canvas re-render)
    setLedColors(hexColors);
  };

  ledCompositor.addEventListener(handleCompositedFrame);
  return () => ledCompositor.removeEventListener(handleCompositedFrame);
}, [device.id, showLivePreview]);
```

**Brightness Handling (ALREADY IMPLEMENTED):**
```typescript
// Screen brightness multiplier (already in existing canvas rendering code)
const brightnessMultiplier = 2.5; // Makes LEDs visible on screen
const brightR = Math.min(255, Math.round(r * brightnessMultiplier));
const brightG = Math.min(255, Math.round(g * brightnessMultiplier));
const brightB = Math.min(255, Math.round(b * brightnessMultiplier));
```

**Important:** Compositor already applies device brightness settings. The 2.5x multiplier is for **screen visibility only**, not hardware brightness.

### Source Tree References

**Modified Files:**
- `src/components/WLED/WLEDVirtualPreview.tsx` - **Add compositor event subscription (MAIN TASK)**
- `src/components/WLED/WLEDDeviceManager.tsx` - **Embed preview in device cards**
- `src/components/WLED/types.ts` - **Add `showLivePreview?: boolean` to WLEDVirtualPreviewProps**

**Reference Files (DO NOT MODIFY):**
- `src/services/LEDCompositor.ts` - Event emission logic (line 1018-1024: sendToDevice)
- `src/components/LEDStripManager/VirtualLEDStrip.tsx` - **Visual pattern reference**
- `src/components/LEDStripManager/LEDStripManager.tsx` - **Integration pattern reference (line 889-898)**
- `src/types/visualization.ts` - Type definitions (CompositorEvent)

### Performance Considerations

**LED Limit:**
- Maximum 300 LEDs per device for preview
- Rationale: Canvas rendering performance threshold
- Over-limit devices show warning, render first 300 LEDs only

**Frame Rate:**
- Target: 60 FPS (16.67ms per frame)
- Use requestAnimationFrame for smooth updates
- Debounce rapid frame submissions from compositor

**Memory:**
- Cache hex color conversions to avoid re-computation
- Use stable component keys to prevent unmount/remount
- Clean up event listeners on unmount

### Edge Cases

1. **No Routing Assignments:** Preview shows "Waiting for visualization..." placeholder
2. **Multiple Devices on Same Module:** Each preview shows identical content (expected)
3. **Device Disconnected:** Preview freezes on last frame (or shows placeholder after timeout)
4. **Test Pattern Active:** Override compositor events, show test pattern
5. **Over 300 LEDs:** Render first 300, show warning indicator

### Testing Strategy

**Manual Browser Testing (per CLAUDE.md philosophy):**

1. **Single Device Test:**
   - Configure 1x WLED device (90 LED strip)
   - Open Drum Machine module, start playback
   - Verify preview shows step sequencer visualization

2. **Multi-Device Test:**
   - Configure 2x WLED devices (grid + strip)
   - Verify both previews show correct visualizations
   - Check routing matrix assignments match previews

3. **Overlay Test:**
   - Enable Audio Reactive module
   - Verify preview shows blended output (drum pattern + ripple)

4. **Performance Test:**
   - Configure 5x WLED devices
   - Start playback, monitor Chrome Performance tab
   - Verify no frame drops, <16ms render time

5. **Edge Case Tests:**
   - Test with 300+ LED device (warning indicator)
   - Test reverse_direction toggle (arrow flip)
   - Test device hot-swap (preview recovery)

**Debug Commands:**
```javascript
// Verify compositor events
ledCompositor.addEventListener((e) => console.log('Event:', e));

// Check routing assignments
routingMatrix.debugPrintRouting();

// Monitor frame rate
// Chrome DevTools → Performance → Record → Analyze FPS
```

### Architectural Constraints

**From coding-standards.md:**
- Use TypeScript strict mode (noUnusedLocals: true)
- Prefer underscore prefix for reserved variables
- Follow existing component patterns (React.FC, props destructuring)

**From tech-stack.md:**
- React 18+ with hooks
- Tailwind CSS for styling
- Lucide React for icons

**From source-tree.md:**
- Component location: `src/components/WLED/`
- Service location: `src/services/`
- Type definitions: `src/types/`

### Testing

**Manual Verification Steps (per CLAUDE.md):**

1. **Visual Inspection:**
   - Open WLED Manager (`/wled-manager`)
   - Add test device (90 LEDs, 1D strip)
   - Start Drum Machine module
   - Verify preview shows colored bars (step sequencer pattern)

2. **Real-Time Updates:**
   - Toggle step on/off in Drum Machine
   - Verify preview updates immediately

3. **Multi-Device Validation:**
   - Add second device (6x25 grid)
   - Verify both previews show correct content
   - Check no visual glitches or lag

4. **Performance Check:**
   - Open Chrome DevTools Performance tab
   - Record 10 seconds of playback
   - Verify canvas render time <2ms per frame
   - Check FPS stays at 60

5. **Edge Cases:**
   - Test with device.enabled = false (preview should gray out)
   - Test with no modules active (placeholder text)
   - Test with 400 LED device (warning indicator)

**No Automated Tests Required** (per CLAUDE.md testing philosophy)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Story created | Sarah (PO) |
| 2025-10-19 | 1.1 | **MAJOR REVISION:** Simplified scope based on Winston's architectural analysis. Key changes: (1) Reduced estimate 4-6h → 2-3h, (2) Clarified visual pattern already implemented, (3) Focused tasks on compositor event integration only, (4) Added regression testing phase, (5) Updated acceptance criteria to distinguish NEW vs EXISTING functionality | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
(Populated by dev agent during implementation)

### Debug Log References
(Populated by dev agent during implementation)

### Completion Notes List
(Populated by dev agent during implementation)

### File List
(Populated by dev agent during implementation)

---

## QA Results
(Populated by QA agent after story completion)
