# Story 4.2: Global Music Header Bar Component

## Status
Draft

## Story
**As a** user,
**I want** a persistent header bar with tempo, key, scale, and settings controls,
**so that** I can adjust musical parameters from any view without navigation.

## Acceptance Criteria
1. Create `src/components/GlobalMusicHeader/GlobalMusicHeader.tsx`
2. Implement responsive layout:
   - **Desktop** (>1024px): Full horizontal control bar
   - **Tablet** (768-1024px): Compact control bar
   - **Mobile** (<768px): Collapsible menu with essential controls
3. Add tempo control:
   - BPM input field (40-300 range)
   - Tap tempo button (calculates BPM from taps)
   - Visual tempo indicator (pulsing icon)
4. Add key/scale selector using existing `ScaleSelector` component
5. Add visualization color mode toggle:
   - Button with icon (chromatic: rainbow, harmonic: degrees)
   - Tooltip explaining modes
6. Add master volume slider (0-100%)
7. Add hardware I/O status indicator (reuse `HardwareStatusIndicator`)
8. Follow Tailwind design system and ViewTemplate patterns

## Integration Verification
- **IV1**: Header renders on all routes without layout conflicts
- **IV2**: Mobile header collapses properly on small screens
- **IV3**: All controls remain responsive during audio playback

## Tasks / Subtasks

- [ ] **Task 1: Create Header Component Structure** (AC: 1, 2)
  - [ ] Create `src/components/GlobalMusicHeader/` directory
  - [ ] Create `GlobalMusicHeader.tsx` main component
  - [ ] Create `index.ts` barrel export
  - [ ] Implement responsive breakpoint detection using useResponsive hook
  - [ ] Create desktop layout (full horizontal bar)
  - [ ] Create tablet layout (compact bar)
  - [ ] Create mobile layout (collapsible menu)

- [ ] **Task 2: Implement Tempo Control** (AC: 3)
  - [ ] Create `TempoControl.tsx` subcomponent
  - [ ] Add BPM number input with validation (40-300)
  - [ ] Implement tap tempo button functionality
    - [ ] Track last 4 tap timestamps
    - [ ] Calculate average interval and convert to BPM
    - [ ] Reset taps after 3-second gap
  - [ ] Add visual tempo indicator (pulsing music note icon)
    - [ ] Sync pulse animation with current BPM
    - [ ] Use requestAnimationFrame for smooth animation
  - [ ] Connect to GlobalMusicContext updateTempo()
  - [ ] Add keyboard shortcuts (Up/Down arrows for +/-5 BPM)

- [ ] **Task 3: Integrate Key/Scale Selector** (AC: 4)
  - [ ] Import existing `ScaleSelector` component from src/components/Music/
  - [ ] Connect to GlobalMusicContext key/scale state
  - [ ] Style to match header design system
  - [ ] Ensure dropdowns don't overflow viewport
  - [ ] Add keyboard navigation support

- [ ] **Task 4: Create Color Mode Toggle** (AC: 5)
  - [ ] Create toggle button component
  - [ ] Add chromatic mode icon (rainbow/spectrum icon from Lucide)
  - [ ] Add harmonic mode icon (musical degree/circle icon)
  - [ ] Implement tooltip explaining modes:
    - "Chromatic: Colors by pitch (C=Red, D=Orange, etc.)"
    - "Harmonic: Colors by scale degree (Tonic=Blue, Dominant=Purple)"
  - [ ] Connect to GlobalMusicContext colorMode state
  - [ ] Add smooth transition animation on mode change

- [ ] **Task 5: Add Master Volume Slider** (AC: 6)
  - [ ] Create volume slider component (0-100 range)
  - [ ] Add speaker icon with visual level indicator
  - [ ] Implement smooth drag interaction
  - [ ] Connect to GlobalMusicContext masterVolume state
  - [ ] Update AudioEngine volume in real-time
  - [ ] Add mute/unmute quick toggle button
  - [ ] Show volume percentage on hover

- [ ] **Task 6: Integrate Hardware Status** (AC: 7)
  - [ ] Import existing `HardwareStatusIndicator` component
  - [ ] Position in header (right side)
  - [ ] Show MIDI connection status
  - [ ] Show WLED connection status
  - [ ] Add click handler to open hardware settings modal (Story 4.4)
  - [ ] Responsive: Hide on mobile, show icon only on tablet

- [ ] **Task 7: Apply Design System** (AC: 8)
  - [ ] Use Tailwind utility classes throughout
  - [ ] Follow ViewTemplate color palette (primary-600, gray-700, etc.)
  - [ ] Use Lucide React icons exclusively
  - [ ] Implement consistent border-radius (rounded-lg)
  - [ ] Add hover states with transition-colors
  - [ ] Ensure 44px minimum touch targets for mobile
  - [ ] Add dark mode support (bg-gray-800 header)

- [ ] **Task 8: Implement Responsive Behavior**
  - [ ] Desktop: Full horizontal layout with all controls visible
  - [ ] Tablet: Compact layout, some labels hidden
  - [ ] Mobile: Hamburger menu with collapsible controls
  - [ ] Add smooth collapse/expand animations
  - [ ] Persist menu state in localStorage
  - [ ] Test all breakpoints in DevTools

- [ ] **Task 9: Integration with App.tsx**
  - [ ] Update `src/App.tsx`
  - [ ] Import GlobalMusicHeader
  - [ ] Render header above Router (persistent across routes)
  - [ ] Ensure header doesn't overlap with route content
  - [ ] Add sticky positioning (stays at top on scroll)
  - [ ] Test on all existing routes

- [ ] **Task 10: Testing** (IV: 1, 2, 3)
  - [ ] Visual regression tests across breakpoints
  - [ ] Test header renders on all routes
  - [ ] Test mobile menu collapse/expand
  - [ ] Test tempo control (input, tap tempo, indicator)
  - [ ] Test key/scale selector integration
  - [ ] Test color mode toggle
  - [ ] Test volume slider
  - [ ] Test controls remain responsive during playback
  - [ ] Accessibility testing (keyboard navigation, screen readers)

## Dev Notes

### Relevant Architecture Context

**Existing Components to Reuse**:
- `src/components/Music/ScaleSelector.tsx` - Key/scale dropdowns
- `src/components/Layout/Header.tsx` - Reference for header patterns
- `src/hardware/ui/HardwareStatusIndicator.tsx` - Hardware connection status
- `src/hooks/useResponsive.ts` - Responsive breakpoint detection

**Design System References**:
- `src/index.css` - Tailwind @layer components classes
- `tailwind.config.js` - Custom color scales (primary, accent)
- `src/components/Layout/ViewTemplate.tsx` - Design patterns

**Responsive Breakpoints**:
```typescript
// From tailwind.config.js
screens: {
  sm: '640px',
  md: '768px',
  lg: '1024px',
  xl: '1280px'
}
```

### Component Structure

```typescript
<GlobalMusicHeader>
  {/* Desktop/Tablet Layout */}
  <div className="hidden md:flex items-center gap-4">
    <TempoControl tempo={tempo} onTempoChange={updateTempo} />
    <ScaleSelector {...scaleProps} />
    <ColorModeToggle mode={colorMode} onModeChange={updateColorMode} />
    <VolumeSlider volume={masterVolume} onVolumeChange={updateVolume} />
    <HardwareStatusIndicator />
  </div>

  {/* Mobile Layout */}
  <div className="md:hidden">
    <MobileMenuButton onClick={toggleMenu} />
    <MobileMenu isOpen={menuOpen}>
      {/* Same controls as desktop, vertical layout */}
    </MobileMenu>
  </div>
</GlobalMusicHeader>
```

### Tap Tempo Algorithm

```typescript
const tapTimes: number[] = [];

function handleTapTempo() {
  const now = performance.now();

  // Reset if gap > 3 seconds
  if (tapTimes.length > 0 && now - tapTimes[tapTimes.length - 1] > 3000) {
    tapTimes.length = 0;
  }

  tapTimes.push(now);

  // Need at least 2 taps to calculate BPM
  if (tapTimes.length >= 2) {
    // Keep only last 4 taps
    if (tapTimes.length > 4) tapTimes.shift();

    // Calculate average interval
    const intervals = [];
    for (let i = 1; i < tapTimes.length; i++) {
      intervals.push(tapTimes[i] - tapTimes[i - 1]);
    }
    const avgInterval = intervals.reduce((a, b) => a + b) / intervals.length;

    // Convert to BPM
    const bpm = Math.round(60000 / avgInterval);
    updateTempo(Math.max(40, Math.min(300, bpm))); // Clamp to valid range
  }
}
```

### Visual Tempo Indicator

Use Tone.js Transport for accurate timing:

```typescript
useEffect(() => {
  const interval = setInterval(() => {
    const beat = Tone.Transport.position.split(':')[1]; // Get current beat
    if (beat === '0') {
      // Trigger pulse animation on beat 1
      setPulsing(true);
      setTimeout(() => setPulsing(false), 100);
    }
  }, 50); // Check every 50ms

  return () => clearInterval(interval);
}, []);
```

### Accessibility Considerations

- All controls must have proper ARIA labels
- Keyboard navigation: Tab through controls, Enter/Space to activate
- Screen reader announcements for tempo changes, mode switches
- High contrast mode support
- Focus indicators visible and clear

### Testing

**Unit Tests** (`GlobalMusicHeader.test.tsx`):
- Component renders without errors
- Tempo control input validation
- Tap tempo calculation accuracy
- Color mode toggle state changes
- Volume slider updates AudioEngine

**Integration Tests**:
- Header appears on all routes
- Controls update global state
- State changes reflected in other views
- Mobile menu collapse/expand
- Hardware status indicator integration

**Visual Tests**:
- Screenshot comparisons across breakpoints
- Storybook stories for each state variant
- Dark mode rendering

**Performance Tests**:
- Header render time <50ms
- Tempo indicator animation 60fps
- No layout shift on mount

**Testing Standards**:
- Use Vitest for unit tests
- Use Playwright for E2E tests
- Use Storybook for visual component testing
- Minimum 80% code coverage

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-11 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
