# Story 22.4: Viral Loop Triggers

**Epic**: 22 - AI-Native Product-Led Growth Flywheel
**Status**: üìã Draft
**Priority**: üî¥ Critical (Week 1)
**Estimated Effort**: 1 hour
**Owner**: Solo Dev

---

## Story

As a **user who just completed the tutorial**,
I want **an easy way to share this experience with someone I know**,
So that **they can try Audiolux and we can collaborate**.

---

## Context

**Problem**: Users complete the tutorial, feel accomplished, but don't know what to do next. They close the tab and forget about Audiolux.

**Solution**: Immediately after tutorial completion (or other "aha moments"), prompt users to share with a friend. Make sharing:
1. **Contextual**: Persona-specific messaging (educators ‚Üí "Invite students", creators ‚Üí "Share with followers")
2. **Frictionless**: One-click WhatsApp/email share buttons with pre-filled messages
3. **Rewarding**: Gamification ("You've introduced 3 people this week üåü")

**Psychology**: Users just succeeded at making music. They're in a positive emotional state. They WANT to share this accomplishment. Capture that moment.

**Reference**: Epic 22, viral coefficient k=1.3 requires 40%+ share rate

---

## Acceptance Criteria

### Must-Have

- [ ] **ShareSessionModal component** triggered after:
  - Tutorial completion (primary trigger)
  - First project save (secondary trigger)
  - User creates jam session (tertiary trigger)

- [ ] **Persona-specific share copy**:
  - **Deaf Musician** (`d`): "Jam with a friend who makes music"
  - **Educator** (`e`): "Invite your students to try this"
  - **Visual Learner** (`v`): "Share with a friend who learns visually"
  - **Producer** (`p`): "Invite a collaborator to jam"
  - **Creator** (`c`): "Share with your followers"

- [ ] **Quick share buttons** (4 methods minimum):
  - WhatsApp (pre-filled message)
  - Email (pre-filled subject/body)
  - Discord (copy link with Discord formatting)
  - Copy link (clipboard)

- [ ] **Pre-filled share messages**:
  - Generic: "Check out this visual music tool I just tried: [URL]"
  - Personalized: References what they just created ("I made my first beat in 30 seconds")

- [ ] **Gamification elements**:
  - Show referral count: "You've introduced 3 people this week!"
  - Badge for 5+ shares: "Community Builder üåü"
  - Progress bar: "Invite 2 more people to unlock Pro trial"

### Nice-to-Have

- [ ] Social proof in modal: "Sarah invited 12 students this week"
- [ ] Option to skip ("Maybe later") without dismissing forever
- [ ] Share to Twitter/X with pre-filled tweet
- [ ] Share to LinkedIn (for educators)

---

## Share Triggers & Timing

### Trigger 1: Tutorial Completion (Primary - 40%+ conversion)

**When**: User completes final step of guided tutorial
**Where**: Immediately after celebration confetti
**Message**: Persona-specific (see below)

**Example Flow**:
1. User completes tutorial
2. Confetti + "You just made music üéâ"
3. **ShareSessionModal appears** (full-screen overlay)
4. User clicks "Invite a friend" ‚Üí WhatsApp pre-filled
5. Modal tracks `share_prompted` and `share_completed` events

---

### Trigger 2: First Project Save (Secondary - 20%+ conversion)

**When**: User saves their first project
**Where**: Toast notification ‚Üí "Want to collaborate on this?"
**Message**: "You saved your first project! Invite someone to jam with you."

---

### Trigger 3: Session Created (Tertiary - 60%+ conversion)

**When**: User creates a jam session
**Where**: Immediately after session creation
**Message**: "Your jam session is ready! Share this link to invite others."

---

## Persona-Specific Messaging

### Deaf Musician (`?v=d`)

**Modal Title**: "Share your beat with a friend üéµ"

**Body**:
"You just made music in 30 seconds. Know someone else who'd love this?

Audiolux works for Deaf and hearing musicians - no audio needed to create."

**CTA Button**: "Invite a friend to jam"

**Pre-filled WhatsApp message**:
```
Hey! I just tried Audiolux - it's a visual music tool that works without needing to hear anything. Made my first beat in 30 seconds.

Try it here: jam.audiolux.app?v=d&r=<your-code>
```

---

### Educator (`?v=e`)

**Modal Title**: "Ready to try this with your students? üë®‚Äçüè´"

**Body**:
"You just saw how visual music theory works. Your students can learn the same way.

No software to install, works on Chromebooks, free for students."

**CTA Button**: "Invite your students"

**Pre-filled email**:
```
Subject: Try this visual music tool for class

Hi [Student],

I found a tool called Audiolux that teaches music visually - perfect for our class. You can:

‚Ä¢ See music theory in color
‚Ä¢ Create beats in your browser
‚Ä¢ Collaborate in real-time

Try it here: jam.audiolux.app?v=e&r=<your-code>

No account needed, works on any device.

- [Your Name]
```

---

### Visual Learner (`?v=v`)

**Modal Title**: "Share this with other visual learners üëÅÔ∏è"

**Body**:
"If you learn better by seeing patterns, chances are your friends do too."

**CTA Button**: "Share with a friend"

**Pre-filled message**:
```
Found a music tool for visual learners. No sheet music, just patterns and colors.

Try it: jam.audiolux.app?v=v&r=<your-code>
```

---

### Producer (`?v=p`)

**Modal Title**: "Invite a collaborator to jam üéπ"

**Body**:
"Modular DAW in your browser. Send a link, instant collaboration.

No stems, no waiting - jam in real-time."

**CTA Button**: "Invite a collaborator"

**Pre-filled Discord message**:
```
**Trying out Audiolux** - browser-based modular DAW with real-time collab.

Check it out: jam.audiolux.app?v=p&r=<your-code>
```

---

### Creator (`?v=c`)

**Modal Title**: "Share with your followers üì±"

**Body**:
"Your audience would love this. Visual music creation = great content.

Get free Pro + custom URL (yourusername.audiolux.app) if you share."

**CTA Button**: "Share with followers"

**Pre-filled tweet**:
```
Just tried @AudioluxApp - visual music creation tool for content creators üéµ

Made a beat in 30 seconds, all in the browser. Check it out:
jam.audiolux.app?v=c&r=<your-code>
```

---

## Technical Implementation

### File Structure

```
src/components/
  Share/
    ShareSessionModal.tsx      # Main modal component
    QuickShareButtons.tsx      # WhatsApp, Email, Discord, Copy buttons
    ShareMessage.tsx           # Pre-filled message generator
    ReferralGamification.tsx   # "You've referred 3 people" badge
```

---

### Implementation: ShareSessionModal.tsx

```tsx
// src/components/Share/ShareSessionModal.tsx

import React, { useState } from 'react';
import { X, Share2 } from 'lucide-react';
import { QuickShareButtons } from './QuickShareButtons';
import { ReferralGamification } from './ReferralGamification';
import { generateShareUrl } from '@/utils/personaCodes';
import { trackShare } from '@/utils/referralTracking';

interface ShareSessionModalProps {
  persona: 'deaf-musician' | 'educator' | 'visual-learner' | 'producer' | 'creator';
  userName?: string;  // For personalized messages
  onClose: () => void;
  trigger: 'tutorial' | 'save' | 'session';  // What triggered this modal
}

export const ShareSessionModal: React.FC<ShareSessionModalProps> = ({
  persona,
  userName,
  onClose,
  trigger
}) => {
  const [shareCount, setShareCount] = useState(getReferralCount());

  const config = getPersonaConfig(persona);
  const shareUrl = generateShareUrl(persona, userName || 'anonymous');

  const handleShare = (method: string) => {
    trackShare(method);
    setShareCount(shareCount + 1);

    // Don't auto-close - let user share multiple ways
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-4">
      <div className="bg-gray-800 rounded-lg border-2 border-primary-500 max-w-lg w-full p-6 relative">
        {/* Close button */}
        <button
          onClick={onClose}
          className="absolute top-4 right-4 text-gray-400 hover:text-white"
        >
          <X className="w-6 h-6" />
        </button>

        {/* Icon */}
        <div className="flex justify-center mb-4">
          <div className="w-16 h-16 bg-primary-500/20 rounded-full flex items-center justify-center">
            <Share2 className="w-8 h-8 text-primary-400" />
          </div>
        </div>

        {/* Title */}
        <h2 className="text-2xl font-bold text-white text-center mb-2">
          {config.title}
        </h2>

        {/* Body */}
        <p className="text-gray-300 text-center mb-6 whitespace-pre-line">
          {config.body}
        </p>

        {/* Gamification (if user has shared before) */}
        {shareCount > 0 && (
          <ReferralGamification count={shareCount} />
        )}

        {/* Share URL (read-only, click to copy) */}
        <div className="mb-6">
          <label className="text-sm text-gray-400 mb-2 block">
            Share this link:
          </label>
          <div className="flex items-center gap-2 bg-gray-900 border border-gray-700 rounded-lg p-3">
            <input
              type="text"
              value={shareUrl}
              readOnly
              className="flex-1 bg-transparent text-white outline-none text-sm font-mono"
            />
            <button
              onClick={() => {
                navigator.clipboard.writeText(shareUrl);
                alert('Link copied!');
              }}
              className="px-3 py-1 bg-primary-500 hover:bg-primary-600 text-white rounded text-sm transition-colors"
            >
              Copy
            </button>
          </div>
        </div>

        {/* Quick share buttons */}
        <QuickShareButtons
          shareUrl={shareUrl}
          message={config.message}
          persona={persona}
          onShare={handleShare}
        />

        {/* Maybe later button */}
        <button
          onClick={onClose}
          className="w-full mt-4 text-gray-400 hover:text-white transition-colors text-sm"
        >
          Maybe later
        </button>
      </div>
    </div>
  );
};

// Persona-specific configuration
function getPersonaConfig(persona: string) {
  const configs = {
    'deaf-musician': {
      title: "Share your beat with a friend üéµ",
      body: "You just made music in 30 seconds. Know someone else who'd love this?\n\nAudiolux works for Deaf and hearing musicians - no audio needed to create.",
      message: "Hey! I just tried Audiolux - it's a visual music tool that works without needing to hear anything. Made my first beat in 30 seconds.\n\nTry it here: {url}"
    },
    'educator': {
      title: "Ready to try this with your students? üë®‚Äçüè´",
      body: "You just saw how visual music theory works. Your students can learn the same way.\n\nNo software to install, works on Chromebooks, free for students.",
      message: "Hi! I found a tool called Audiolux that teaches music visually - perfect for class. You can see music theory in color and create beats in your browser.\n\nTry it here: {url}"
    },
    'visual-learner': {
      title: "Share this with other visual learners üëÅÔ∏è",
      body: "If you learn better by seeing patterns, chances are your friends do too.",
      message: "Found a music tool for visual learners. No sheet music, just patterns and colors.\n\nTry it: {url}"
    },
    'producer': {
      title: "Invite a collaborator to jam üéπ",
      body: "Modular DAW in your browser. Send a link, instant collaboration.\n\nNo stems, no waiting - jam in real-time.",
      message: "Trying out Audiolux - browser-based modular DAW with real-time collab.\n\nCheck it out: {url}"
    },
    'creator': {
      title: "Share with your followers üì±",
      body: "Your audience would love this. Visual music creation = great content.\n\nGet free Pro + custom URL if you share.",
      message: "Just tried Audiolux - visual music creation tool for content creators üéµ\n\nMade a beat in 30 seconds, all in the browser:\n{url}"
    }
  };

  return configs[persona] || configs['visual-learner'];
}

function getReferralCount(): number {
  // Fetch from backend or localStorage
  const stored = localStorage.getItem('audiolux_referral_count');
  return stored ? parseInt(stored, 10) : 0;
}
```

---

### Implementation: QuickShareButtons.tsx

```tsx
// src/components/Share/QuickShareButtons.tsx

import React from 'react';
import { MessageCircle, Mail, Send, Copy } from 'lucide-react';

interface QuickShareButtonsProps {
  shareUrl: string;
  message: string;
  persona: string;
  onShare: (method: string) => void;
}

export const QuickShareButtons: React.FC<QuickShareButtonsProps> = ({
  shareUrl,
  message,
  persona,
  onShare
}) => {
  const fullMessage = message.replace('{url}', shareUrl);

  const handleWhatsAppShare = () => {
    const encoded = encodeURIComponent(fullMessage);
    window.open(`https://wa.me/?text=${encoded}`, '_blank');
    onShare('whatsapp');
  };

  const handleEmailShare = () => {
    const subject = encodeURIComponent('Try Audiolux - Visual Music Creation');
    const body = encodeURIComponent(fullMessage);
    window.location.href = `mailto:?subject=${subject}&body=${body}`;
    onShare('email');
  };

  const handleDiscordShare = () => {
    // Discord doesn't have a direct share URL, so copy formatted message
    const discordMessage = `**Audiolux - Visual Music Tool**\n\n${fullMessage}`;
    navigator.clipboard.writeText(discordMessage);
    alert('Discord message copied to clipboard!');
    onShare('discord');
  };

  const handleCopyLink = () => {
    navigator.clipboard.writeText(shareUrl);
    alert('Link copied to clipboard!');
    onShare('copy');
  };

  return (
    <div className="grid grid-cols-2 gap-3">
      <button
        onClick={handleWhatsAppShare}
        className="flex items-center justify-center gap-2 px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors"
      >
        <MessageCircle className="w-5 h-5" />
        <span>WhatsApp</span>
      </button>

      <button
        onClick={handleEmailShare}
        className="flex items-center justify-center gap-2 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
      >
        <Mail className="w-5 h-5" />
        <span>Email</span>
      </button>

      <button
        onClick={handleDiscordShare}
        className="flex items-center justify-center gap-2 px-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors"
      >
        <Send className="w-5 h-5" />
        <span>Discord</span>
      </button>

      <button
        onClick={handleCopyLink}
        className="flex items-center justify-center gap-2 px-4 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors"
      >
        <Copy className="w-5 h-5" />
        <span>Copy Link</span>
      </button>
    </div>
  );
};
```

---

### Implementation: ReferralGamification.tsx

```tsx
// src/components/Share/ReferralGamification.tsx

import React from 'react';
import { Award } from 'lucide-react';

interface ReferralGamificationProps {
  count: number;
}

export const ReferralGamification: React.FC<ReferralGamificationProps> = ({ count }) => {
  const getBadge = (count: number) => {
    if (count >= 10) return { name: 'Super Advocate üèÜ', color: 'bg-yellow-500' };
    if (count >= 5) return { name: 'Community Builder üåü', color: 'bg-primary-500' };
    if (count >= 3) return { name: 'Helpful Friend üëã', color: 'bg-blue-500' };
    return null;
  };

  const badge = getBadge(count);
  const nextMilestone = count < 3 ? 3 : count < 5 ? 5 : count < 10 ? 10 : null;

  return (
    <div className="mb-6 p-4 bg-gray-900 rounded-lg border border-gray-700">
      <div className="flex items-center gap-3 mb-2">
        <Award className="w-6 h-6 text-primary-400" />
        <div>
          <p className="text-white font-semibold">
            You've introduced {count} {count === 1 ? 'person' : 'people'} to Audiolux!
          </p>
          {badge && (
            <span className={`inline-block mt-1 px-2 py-1 ${badge.color} text-white text-xs rounded`}>
              {badge.name}
            </span>
          )}
        </div>
      </div>

      {nextMilestone && (
        <div className="mt-3">
          <div className="flex justify-between text-xs text-gray-400 mb-1">
            <span>Next: {nextMilestone} shares</span>
            <span>{count}/{nextMilestone}</span>
          </div>
          <div className="w-full bg-gray-700 rounded-full h-2">
            <div
              className="bg-primary-500 h-2 rounded-full transition-all"
              style={{ width: `${(count / nextMilestone) * 100}%` }}
            />
          </div>
        </div>
      )}
    </div>
  );
};
```

---

## Integration Points

### Trigger After Tutorial Completion

```tsx
// src/components/Onboarding/GuidedTutorial.tsx

import { ShareSessionModal } from '@/components/Share/ShareSessionModal';

function GuidedTutorial({ persona }) {
  const [showShareModal, setShowShareModal] = useState(false);

  const handleTutorialComplete = () => {
    trackTutorialCompletion(persona);

    // Show celebration first
    showCelebration();

    // Then show share modal after 2 seconds
    setTimeout(() => {
      setShowShareModal(true);
    }, 2000);
  };

  return (
    <>
      <Tutorial onComplete={handleTutorialComplete} />

      {showShareModal && (
        <ShareSessionModal
          persona={persona}
          trigger="tutorial"
          onClose={() => setShowShareModal(false)}
        />
      )}
    </>
  );
}
```

---

## Validation & Testing

### Manual Testing Checklist

**Modal Appearance**:
- [ ] Complete tutorial ‚Üí ShareSessionModal appears after celebration
- [ ] Modal shows persona-specific title/body
- [ ] Modal shows correct share URL with `?v=` and `&r=` codes

**Share Buttons**:
- [ ] Click WhatsApp ‚Üí opens WhatsApp with pre-filled message
- [ ] Click Email ‚Üí opens mailto with pre-filled subject/body
- [ ] Click Discord ‚Üí copies formatted message to clipboard
- [ ] Click Copy ‚Üí copies URL to clipboard

**Gamification**:
- [ ] Share 3 times ‚Üí "Helpful Friend üëã" badge appears
- [ ] Share 5 times ‚Üí "Community Builder üåü" badge appears
- [ ] Progress bar shows correct percentage

**Analytics Tracking**:
- [ ] `share_prompted` event fires when modal opens
- [ ] `share_completed` event fires when user clicks share button
- [ ] Events include persona + trigger dimensions

---

## Success Metrics

**Primary KPIs** (Week 2):
- ‚úÖ 40%+ share rate (users click at least one share button)
- ‚úÖ WhatsApp is #1 share method (educators use it)
- ‚úÖ Educator persona has highest share rate (teachers invite students)

**Secondary KPIs** (Week 4):
- ‚úÖ 50%+ share rate (improved from Week 2)
- ‚úÖ 10%+ of sharers reach "Community Builder" badge (5+ shares)
- ‚úÖ 60%+ of session creations result in share

---

## Dependencies

**Blockers**: None

**Required**:
- Stories 22.1, 22.2, 22.3 completed (persona codes, outreach, analytics)
- React state management (for modal visibility)

**Optional**:
- Social share icons (using Lucide React, already installed)

---

## Risks & Mitigation

### Risk 1: Share Rate Too Low (<40%)
**Impact**: Viral coefficient k < 1.3, growth stalls
**Mitigation**:
- A/B test modal copy (3 variations)
- Add incentive: "Share to unlock Pro trial"
- Show social proof: "Sarah shared with 12 students"

### Risk 2: Users Close Modal Too Quickly
**Impact**: Don't see share buttons
**Mitigation**:
- Make modal visually appealing (confetti background)
- Add delay before showing "Maybe later" button (3 seconds)

### Risk 3: Pre-filled Messages Too Long
**Impact**: Users edit them down or don't send
**Mitigation**:
- Keep messages <150 characters
- Test on mobile (WhatsApp, SMS)

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] ShareSessionModal component created
- [ ] 5 persona-specific message variations
- [ ] 4 quick share buttons working (WhatsApp, Email, Discord, Copy)
- [ ] Gamification displays referral count + badges
- [ ] Modal triggered after tutorial, save, session creation
- [ ] Analytics tracking `share_prompted` and `share_completed`
- [ ] Manual testing checklist completed
- [ ] Mobile responsive (tested on iPhone, Android)
- [ ] No console errors
- [ ] Story marked as "Review" status

---

## Dev Agent Record

### Agent Model Used
[To be filled by dev agent]

### Completion Notes
[To be filled by dev agent]

### File List
```
src/components/Share/
  ShareSessionModal.tsx
  QuickShareButtons.tsx
  ShareMessage.tsx
  ReferralGamification.tsx
```

### Change Log
[To be filled by dev agent]

### Debug Log References
[To be filled by dev agent]

---

## Related Stories

- **Story 22.1**: Multi-Path Onboarding (triggers share modal after tutorial)
- **Story 22.2**: AI Outreach Generator (creates referral URLs used in shares)
- **Story 22.3**: Referral Attribution (tracks share events and referral counts)

---

## Document Version

**Version**: 1.0
**Created**: 2025-10-25
**Last Updated**: 2025-10-25
**Status**: üìã **Draft - Ready for Development**
