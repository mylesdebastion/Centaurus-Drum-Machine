# Story 7.4: Shareable Session URLs

**Epic:** Epic 7 - Jam Session Backend Infrastructure (Hybrid: Supabase + WebRTC P2P)
**Status:** üìù READY FOR DEVELOPMENT
**Priority:** üü° MEDIUM
**Complexity:** Low
**Time Estimate:** 2-3 hours
**Prerequisites:** Story 7.3

---

## User Story

As a **session host**,
I want **to share a direct link to my jam session**,
So that **other musicians can join easily without typing a room code**.

---

## Story Context

**Existing System Integration:**
- Integrates with: React Router (existing App.tsx routing), JamSession component
- Technology: React Router v6 `useParams`, Clipboard API, TypeScript
- Follows pattern: Existing URL-based navigation, React Router patterns
- Touch points: App.tsx routing, JamSession header, WelcomeScreen

**Why This Story:**
Shareable URLs dramatically improve the user experience for inviting others to sessions. Instead of manually typing a 6-character code, users can simply click a link. This is especially important for mobile users where typing is more cumbersome.

---

## Acceptance Criteria

### Functional Requirements

1. **Dynamic Routing**
   - Update `App.tsx` routing:
     ```typescript
     <Route path="/jam/:roomCode?" element={<JamSession />} />
     ```
   - Optional `roomCode` parameter in URL
   - `/jam` creates new session (host mode)
   - `/jam/ABC123` joins existing session

2. **URL Parameter Parsing**
   - In `JamSession.tsx`:
     ```typescript
     const { roomCode } = useParams();
     ```
   - If `roomCode` exists ‚Üí join session
   - If no `roomCode` ‚Üí create new session
   - Update browser URL after session creation

3. **Share Button**
   - File: `src/components/JamSession/ShareButton.tsx`
   - Location: Session header (next to session code display)
   - Button text: "Share" with link icon (Lucide `Link` or `Share2`)
   - On click ‚Üí copy full URL to clipboard:
     - Dev: `http://localhost:5173/jam/ABC123`
     - Prod: `https://jam-dev.audiolux.app/jam/ABC123`

4. **Clipboard Copy Functionality**
   - Use Clipboard API:
     ```typescript
     await navigator.clipboard.writeText(shareUrl);
     ```
   - Fallback for older browsers (manual copy):
     ```typescript
     // Create hidden input, select, copy, remove
     const input = document.createElement('input');
     input.value = shareUrl;
     document.body.appendChild(input);
     input.select();
     document.execCommand('copy');
     document.body.removeChild(input);
     ```

5. **Copy Success Toast**
   - Show toast notification on successful copy:
     - Message: "Link copied to clipboard!"
     - Duration: 3 seconds
     - Position: Top-right or bottom-center
   - Use existing toast library or create simple toast component

6. **Shareable URL Display**
   - Show read-only input field with full URL
   - Location: Session header or settings panel
   - Click to select entire URL (for manual copy)
   - Copy button inline with input field

7. **Invalid Room Code Handling**
   - If user navigates to `/jam/INVALID123`:
     - Attempt to join session
     - If subscription fails ‚Üí show error message
     - Redirect to `/jam` (create new session) after 3 seconds
     - Error message: "Session not found. Creating new session..."

8. **URL State Persistence**
   - Browser back/forward buttons work correctly
   - Session code preserved in URL during entire session
   - Refreshing page rejoins same session (if still active)

### Integration Requirements

9. **React Router Integration**
   - Use `useParams()` hook for room code
   - Use `useNavigate()` for programmatic navigation
   - Update URL via `navigate('/jam/${roomCode}', { replace: true })`

10. **Clipboard API Compatibility**
    - Test on Chrome, Firefox, Safari
    - Fallback for browsers without Clipboard API
    - Handle HTTPS requirement (Clipboard API requires secure context)

11. **Error Handling**
    - Clipboard copy failure ‚Üí show error toast
    - Invalid room code ‚Üí show error and redirect
    - Network error during join ‚Üí show error, allow retry

### Quality Requirements

12. **User Experience**
    - Share button is prominent and easy to find
    - Copy feedback is immediate (toast appears <100ms)
    - Invalid code redirect is smooth (3-second delay with countdown)
    - URL input is readable on mobile devices

13. **Responsive Design**
    - Share button works on mobile and desktop
    - Toast notifications visible on all screen sizes
    - URL input field scrolls horizontally if needed

14. **Code Quality**
    - URL construction uses `window.location.origin` (no hardcoding)
    - Clipboard copy has proper error handling
    - TypeScript types for all props and functions

---

## Technical Notes

**Integration Approach:**
- React Router v6 already configured in App.tsx
- Room code extracted via `useParams()` hook
- URL updated programmatically after session creation
- Clipboard API used for copy functionality

**Existing Pattern Reference:**
- Routing pattern follows existing App.tsx structure
- Toast notifications similar to other user feedback patterns
- Button styling follows existing `.btn-primary` patterns

**Key Constraints:**
- Clipboard API requires HTTPS (works on localhost for dev)
- Must handle browser back/forward correctly (no broken states)
- URL must be stable across page refreshes

---

## Definition of Done

- [ ] Dynamic routing implemented (`/jam/:roomCode?`)
- [ ] URL parameter parsing in JamSession component
- [ ] Share button component created and functional
- [ ] Clipboard copy works (with fallback)
- [ ] Copy success toast displays
- [ ] Shareable URL display field added
- [ ] Invalid room code handling implemented
- [ ] Browser back/forward navigation tested
- [ ] Page refresh rejoins session correctly
- [ ] Manual testing completed (see Testing Strategy)

---

## Testing Strategy

### Manual Testing (Per CLAUDE.md Guidelines)

**Test 1: Share URL Copy**
1. Create session (as in Story 7.3)
2. Click "Share" button in session header
3. Verify:
   - ‚úÖ Toast appears: "Link copied to clipboard!"
   - ‚úÖ Clipboard contains full URL: `http://localhost:5173/jam/ABC123`
   - ‚úÖ Can paste URL in address bar or messaging app

**Test 2: Join via URL**
1. Copy share URL from Test 1
2. Open new browser tab
3. Paste URL and press Enter
4. Verify:
   - ‚úÖ Username modal appears (if first time)
   - ‚úÖ Joins session automatically (no manual code entry)
   - ‚úÖ Participant list shows both users

**Test 3: Invalid Room Code**
1. Navigate to `http://localhost:5173/jam/INVALID123`
2. Verify:
   - ‚úÖ Error message: "Session not found. Creating new session..."
   - ‚úÖ Redirects to `/jam` after 3 seconds
   - ‚úÖ New session created (new room code)

**Test 4: Browser Navigation**
1. Create session ‚Üí URL is `/jam/ABC123`
2. Click browser back button
3. Verify:
   - ‚úÖ Returns to WelcomeScreen (`/`)
   - ‚úÖ Session left (participant removed from list)
4. Click browser forward button
5. Verify:
   - ‚úÖ Returns to `/jam` (creates new session)
   - ‚úÖ No errors in console

**Test 5: Page Refresh**
1. Create or join session
2. Refresh page (F5 or Cmd+R)
3. Verify:
   - ‚úÖ Rejoins same session (same room code in URL)
   - ‚úÖ Participant list re-syncs
   - ‚úÖ No errors in console

**Test 6: Mobile Share**
1. Open session on mobile device
2. Click "Share" button
3. Verify:
   - ‚úÖ Clipboard copy works on iOS Safari
   - ‚úÖ Toast notification visible on small screen
   - ‚úÖ Can share via native share sheet (if available)

### Verification Checklist

- ‚úÖ Sharing URL allows new user to join session
- ‚úÖ Invalid room code shows error and redirects
- ‚úÖ Copy button works on all major browsers
- ‚úÖ Browser back button doesn't break session state
- ‚úÖ Page refresh rejoins session correctly
- ‚úÖ URL construction uses `window.location.origin`

---

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** Clipboard API not available (older browsers, HTTP context)
**Mitigation:**
- Fallback to `document.execCommand('copy')` for older browsers
- Show manual copy instructions if both methods fail
- Development works on `localhost` (secure context)
- Production requires HTTPS (already configured on Vercel)

**Secondary Risk:** Users bookmark invalid/expired session URLs
**Mitigation:**
- Invalid URLs show error and redirect gracefully
- Future: Add session persistence (Story 7.9) to handle expired sessions
- Clear error messaging prevents user confusion

### Compatibility Verification

- [x] **No breaking changes** - Additive feature (new routing, new button)
- [x] **Database changes** - None
- [x] **UI changes** - Additive (share button, toast notifications)
- [x] **Performance impact** - Negligible

---

## Scope Validation

- [x] Story can be completed in **2-3 hours** (one focused session)
- [x] Integration approach is straightforward (React Router already configured)
- [x] Follows existing patterns (routing, button styling, toast notifications)
- [x] No design work required (reuse existing UI patterns)

---

## Deliverables

1. **Updated App.tsx Routing**
   - `src/App.tsx` (modified, ~5 lines changed)
   - Dynamic `/jam/:roomCode?` route

2. **Updated JamSession Component**
   - `src/components/JamSession/JamSession.tsx` (modified, ~30 lines added)
   - URL parameter parsing and session join logic

3. **ShareButton Component**
   - `src/components/JamSession/ShareButton.tsx` (~80 lines)
   - Clipboard copy functionality with fallback

4. **Toast Notification**
   - Reuse existing toast library or create simple toast component
   - Show copy success/failure messages

---

## Next Steps After Story 7.4

Once this story is complete, proceed to:
- **Story 7.5:** WebRTC P2P Audio Streaming (8-12 hours)
  - Enable real-time audio between participants
  - Critical for <50ms latency musical jamming

---

## References

- **Epic 7:** `docs/epics/epic-7-jam-session-backend.md`
- **Story 7.3:** `docs/stories/7.3-jam-session-ui-integration.md`
- **React Router Docs:** https://reactrouter.com/en/main/hooks/use-params
- **Clipboard API:** https://developer.mozilla.org/en-US/docs/Web/API/Clipboard_API

---

**Story Created:** 2025-10-13
**Story Owner:** Product Manager (John)
**Estimated Completion:** 2-3 hours after start
