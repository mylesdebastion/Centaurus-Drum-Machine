# Epic 11.1: ROLI Piano M / LUMI Keys Integration

**Status:** 🚧 In Progress - Phase 2.1 (SysEx Scale Sync) Complete
**Priority:** P2 - High Value
**Complexity:** Medium-High
**Epic Type:** Hardware Integration
**Target Release:** v2.0

## Vision

Enable seamless integration with ROLI Piano M (formerly LUMI Keys) to provide visual feedback for music education, showing scales, intervals, chord tones, and next notes through intelligent per-key LED control.

## Business Value

- **Market Differentiation**: First drum machine with smart LUMI integration
- **Educational Value**: Visual learning aid for music theory and harmony
- **User Experience**: Haptic + visual feedback creates immersive learning
- **Hardware Ecosystem**: Opens door for other illuminated keyboard integrations

## User Stories

### As a musician learning scales...
**I want** the LUMI to light up scale degrees in different colors
**So that** I can visualize harmonic relationships while practicing

**Acceptance Criteria:**
- [ ] Chromatic color mode: Each semitone gets a distinct color
- [ ] Harmonic color mode: Colors based on interval from root (root=white, 3rd=green, 5th=blue, etc.)
- [ ] Scale highlighting: Only notes in current scale light up
- [ ] Brightness variation: Emphasize target notes vs. available notes

### As a user playing the drum machine...
**I want** the LUMI to light up the next chord tones before I play them
**So that** I can follow along with chord progressions

**Acceptance Criteria:**
- [ ] Pre-light upcoming chord tones 1 measure ahead
- [ ] Dim brightness for "coming soon" notes
- [ ] Full brightness when chord is active
- [ ] Clear keys when chord changes

### As a beginner...
**I want** clear setup instructions for LUMI integration
**So that** I can get started without technical knowledge

**Acceptance Criteria:**
- [ ] One-click "Setup LUMI" button in settings
- [ ] Step-by-step wizard with screenshots
- [ ] Auto-detect LUMI device when connected
- [ ] Clear error messages if LUMI not found

---

## Technical Architecture

### Two-Tier Approach

#### Tier 1: SysEx Control (Immediate - v2.0)
**What it does:**
- Sets global scale (Major, Minor, Chromatic, etc.)
- Sets root key (C, D, E, etc.)
- Sets base colors (Primary color for scale notes, Root color for root note)
- Changes color modes (4 modes available)

**Limitations:**
- Only 2 color slots: Primary (all scale notes) + Root (root note only)
- Cannot set individual key colors via SysEx
- Physical key presses override MIDI colors (show white by default)

**Use Cases:**
- Quick scale visualization
- Root note emphasis
- Basic harmonic highlighting

#### Tier 2: LittleFoot Script (Advanced - v2.1+)
**What it does:**
- Full per-key color control
- All keys start black, light up on press
- MIDI input lights up keys in velocity-based colors
- Custom color schemes (chromatic, harmonic, chord-based)

**Advantages:**
- Complete visual control
- Matches web app color schemes perfectly
- Physical key presses match color scheme

**Use Cases:**
- Progressive note reveal
- Interval training
- Chord tone highlighting
- Custom color mappings

---

## Implementation Phases

### Phase 1: Research & Foundation ✅ COMPLETE

**Completed:**
- [x] Research ROLI BLOCKS SDK and LUMI control methods
- [x] Reverse-engineer SysEx protocol (via benob/LUMI-lights)
- [x] Document MIDI Note On/Off color control
- [x] Create LumiTest component for protocol testing
- [x] Discover two-tier approach (SysEx + LittleFoot)

**Artifacts:**
- `/docs/research/roli-lumi-light-control.md` - Complete research documentation
- `/src/components/LumiTest/LumiTest.tsx` - Testing component
- `/littlefoot/centaurus-lumi-colors.littlefoot` - Custom color script

---

### Phase 2: Core Integration (Tier 1 - SysEx Control)

**Duration:** 2-3 sprints
**Priority:** P1 - Must Have for v2.0

#### 2.1: LUMI Device Manager
```typescript
// /src/services/midi/LumiDeviceManager.ts
class LumiDeviceManager {
  private output: MIDIOutput | null = null;

  async detectAndConnect(): Promise<boolean>
  setScale(scale: ScaleType): Promise<void>
  setRootKey(note: NoteName): Promise<void>
  setColorMode(mode: 0 | 1 | 2 | 3): Promise<void>
  setPrimaryColor(r: number, g: number, b: number): Promise<void>
  setRootColor(r: number, g: number, b: number): Promise<void>
  disconnect(): void
}
```

**Tasks:**
- [ ] Create `LumiDeviceManager` service
- [ ] Implement SysEx command builders (from xivilay protocol)
- [ ] Add auto-detection on MIDI device connect
- [ ] Implement scale/key/color commands
- [ ] Add connection state management

**Acceptance Criteria:**
- Detects LUMI within 1 second of connection
- All SysEx commands send successfully
- Graceful handling if LUMI not connected
- Unit tests for SysEx command generation

---

#### 2.2: Settings Integration
```typescript
// /src/components/Settings/LumiSettings.tsx
interface LumiSettings {
  enabled: boolean;
  autoDetect: boolean;
  colorScheme: 'chromatic' | 'harmonic';
  primaryColor: { r: number; g: number; b: number };
  rootColor: { r: number; g: number; b: number };
  syncWithApp: boolean;
}
```

**Tasks:**
- [ ] Create LUMI settings panel in Settings view
- [ ] Add "Setup LUMI" wizard
- [ ] Device connection status indicator
- [ ] Color scheme selector
- [ ] Brightness controls
- [ ] Test connection button

**UI Mockup:**
```
┌─────────────────────────────────────┐
│ 🎹 ROLI Piano M / LUMI Keys         │
├─────────────────────────────────────┤
│ Status: 🟢 Connected                │
│ Device: LUMI Keys (Piano M)         │
│                                     │
│ ☐ Enable LUMI integration           │
│ ☑ Auto-detect device                │
│ ☑ Sync scale with app               │
│                                     │
│ Color Scheme:                       │
│ ⚫ Chromatic (12 colors)            │
│ ⚪ Harmonic (interval-based)        │
│                                     │
│ [Setup Wizard] [Test Connection]    │
└─────────────────────────────────────┘
```

**Acceptance Criteria:**
- Settings persist to localStorage
- Visual feedback on connection status
- Clear error messages
- "Test Connection" lights up all keys

---

#### 2.3: Piano Roll Integration
**Sync LUMI with Piano Roll state**

**Tasks:**
- [ ] Hook into Piano Roll scale changes
- [ ] Update LUMI when key changes
- [ ] Update LUMI when color scheme changes
- [ ] Add "Highlight Next Notes" feature
- [ ] Brightness based on note timing (dim future, bright current)

**Integration Points:**
```typescript
// When scale changes in Piano Roll
const handleScaleChange = (scale: ScaleType) => {
  updatePianoRoll(scale);
  if (lumiManager.isConnected()) {
    lumiManager.setScale(scale);
  }
};

// When playing notes
const handleNotePlay = (notes: MIDINotes[]) => {
  playNotes(notes);
  if (lumiManager.isConnected()) {
    highlightNotesOnLumi(notes);
  }
};
```

**Acceptance Criteria:**
- LUMI updates within 50ms of scale change
- No lag when switching scales
- Works whether LUMI connected before/after app load
- Graceful degradation if LUMI disconnects

---

### Phase 3: Advanced Features (Tier 2 - LittleFoot Script)

**Duration:** 1-2 sprints
**Priority:** P2 - Nice to Have for v2.1

#### 3.1: LittleFoot Script Distribution

**Tasks:**
- [ ] Create downloadable LittleFoot script
- [ ] Add "Download LUMI Script" button in settings
- [ ] Write installation guide
- [ ] Create video tutorial (optional)
- [ ] Add script version detection (via MIDI SysEx query)

**User Flow:**
```
1. User clicks "Enable Advanced Features"
2. App shows modal: "Download centaurus-lumi-colors.littlefoot"
3. User downloads file
4. App shows step-by-step guide:
   - Open ROLI Dashboard
   - Drag file onto LUMI keyboard image
   - Wait for upload to complete
   - Click "Test" in our app
5. App sends test MIDI notes to verify installation
6. Success! Advanced features unlocked
```

**Acceptance Criteria:**
- One-click download of .littlefoot file
- Clear installation instructions with screenshots
- Verification test confirms script is loaded
- Option to restore default LUMI behavior

---

#### 3.2: Velocity-Based Color Control

**Tasks:**
- [ ] Create `LumiColorMapper` class
- [ ] Implement chromatic color mapping
- [ ] Implement harmonic color mapping
- [ ] Map velocity values to specific colors
- [ ] Add color customization in settings

```typescript
class LumiColorMapper {
  // Velocity values that produce specific colors (from LUMI colourLookup)
  private readonly VELOCITIES = {
    black: 0, red: 20, yellow: 42, green: 65,
    cyan: 85, blue: 105, purple: 115, white: 127
  };

  getVelocityForNote(
    note: number,
    scheme: 'chromatic' | 'harmonic',
    rootNote: number
  ): number {
    if (scheme === 'chromatic') {
      return this.chromaticColor(note);
    } else {
      return this.harmonicColor(note, rootNote);
    }
  }

  private chromaticColor(note: number): number {
    const colors = [
      this.VELOCITIES.red,    // C
      this.VELOCITIES.yellow, // C#
      this.VELOCITIES.green,  // D
      // ... etc
    ];
    return colors[note % 12];
  }

  private harmonicColor(note: number, root: number): number {
    const interval = (note - root) % 12;
    const intervalColors = {
      0: this.VELOCITIES.white,  // Root
      4: this.VELOCITIES.green,  // Major 3rd
      7: this.VELOCITIES.blue,   // Perfect 5th
      // ... etc
    };
    return intervalColors[interval] || this.VELOCITIES.black;
  }
}
```

**Acceptance Criteria:**
- Chromatic: 12 distinct colors for each semitone
- Harmonic: Interval-based colors (root=white, 3rd=green, 5th=blue)
- Smooth transitions when changing schemes
- Works in real-time during playback

---

#### 3.3: Progressive Note Reveal

**Feature:** Light up notes one at a time to guide user

**Tasks:**
- [ ] Implement sequential note highlighting
- [ ] Add delay/speed control
- [ ] Brightness pulsing for "next note"
- [ ] Clear previous notes option
- [ ] "Show me the scale" button

**Example Use Case:**
```typescript
// Show C Major scale one note at a time
function revealScale(rootNote: number, scale: ScaleType) {
  const notes = getNotesInScale(rootNote, scale);

  notes.forEach((note, index) => {
    setTimeout(() => {
      lumiController.lightUpNote(note, rootNote);

      // Dim previous note
      if (index > 0) {
        lumiController.dimNote(notes[index - 1]);
      }
    }, index * 500); // 500ms between each note
  });
}
```

**Acceptance Criteria:**
- Smooth sequential animation
- Adjustable speed (100ms - 2000ms per note)
- Pulse effect on active note
- Clear all notes button

---

### Phase 4: Polish & Documentation

**Duration:** 1 sprint
**Priority:** P1 - Required for release

#### 4.1: User Documentation

**Deliverables:**
- [ ] `/docs/user-guides/lumi-setup.md` - Complete setup guide
- [ ] `/docs/user-guides/lumi-features.md` - Feature overview
- [ ] In-app help tooltips
- [ ] Video tutorial (optional)
- [ ] FAQ section

**Setup Guide Structure:**
```markdown
# LUMI Keys Setup Guide

## Quick Start (5 minutes)
1. Connect LUMI to computer
2. Open Centaurus Drum Machine
3. Go to Settings → Hardware → LUMI
4. Click "Auto-detect LUMI"
5. Done! LUMI will now sync with your scales

## Advanced Setup (Custom Colors)
1. Download centaurus-lumi-colors.littlefoot
2. Open ROLI Dashboard
3. [Step-by-step with screenshots]

## Troubleshooting
- LUMI not detected
- Colors don't match
- Keys stay lit
```

---

#### 4.2: Error Handling & Edge Cases

**Tasks:**
- [ ] Handle LUMI disconnect during session
- [ ] Reconnection logic (auto-retry)
- [ ] Multiple LUMI blocks support
- [ ] Firmware version compatibility check
- [ ] Graceful degradation if script not loaded

**Error Messages:**
```
❌ "LUMI not detected. Please connect your ROLI Piano M."
⚠️ "LUMI disconnected. Attempting to reconnect..."
ℹ️ "For advanced features, install the Centaurus LittleFoot script."
✅ "LUMI connected and ready!"
```

**Acceptance Criteria:**
- No crashes if LUMI disconnects
- Auto-reconnect within 5 seconds
- Clear status indicators
- Helpful error messages

---

#### 4.3: Performance Optimization

**Tasks:**
- [ ] Throttle MIDI messages (max 60/sec)
- [ ] Batch SysEx updates
- [ ] Debounce scale changes
- [ ] Memory leak prevention
- [ ] Efficient color calculations

**Performance Targets:**
- < 50ms latency for note highlighting
- < 100ms for scale changes
- No dropped frames during animation
- < 1MB memory overhead

---

## Technical Decisions

### ✅ Decisions Made

1. **Two-tier approach**: Start with SysEx (simple), offer LittleFoot (advanced)
2. **Web MIDI API**: Use native browser MIDI (no external libraries)
3. **Optional feature**: LUMI integration is opt-in, not required
4. **Protocol source**: Use xivilay/benob reverse-engineered protocol
5. **Color mapping**: App calculates colors, sends matching velocities

### 🤔 Open Questions

1. **Default color scheme**: Chromatic or harmonic by default?
   - **Recommendation**: Harmonic (more educational value)

2. **Multiple LUMI blocks**: Support daisy-chained blocks?
   - **Recommendation**: Phase 2.1 - single block, Phase 3+ multi-block

3. **Color customization**: Allow users to create custom color schemes?
   - **Recommendation**: Phase 3+ feature

4. **Firmware requirements**: Minimum firmware version?
   - **Recommendation**: Document requirement, add version check

---

## Dependencies

### External
- **ROLI Dashboard**: Users need this to upload LittleFoot scripts
- **WebMIDI API**: Browser support (Chrome, Edge - no Firefox/Safari)
- **LUMI Firmware**: >= 1.3.0 for custom key handlers

### Internal
- Piano Roll component (scale/key state)
- MIDI service (device detection)
- Settings system (persistence)

---

## Testing Strategy

### Unit Tests
- [ ] SysEx command generation
- [ ] Color mapping algorithms
- [ ] Velocity calculations
- [ ] Device detection logic

### Integration Tests
- [ ] Scale change propagation
- [ ] MIDI message flow
- [ ] Settings persistence
- [ ] Error handling

### Manual Tests
- [ ] Physical LUMI hardware testing
- [ ] Multiple browser testing
- [ ] Connection/disconnection scenarios
- [ ] Multiple LUMI blocks (if available)

### User Acceptance Testing
- [ ] Setup wizard usability
- [ ] Color scheme effectiveness
- [ ] Performance during playback
- [ ] Documentation clarity

---

## Success Metrics

### Launch Criteria (v2.0)
- [ ] 95% success rate on LUMI auto-detection
- [ ] < 100ms latency for scale changes
- [ ] Zero crashes from LUMI disconnect
- [ ] 5-star setup wizard UX rating

### Adoption Metrics
- Track % of users with LUMI who enable integration
- Track most-used color scheme
- Collect user feedback on educational value
- Monitor error rates and connection issues

---

## Risks & Mitigation

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| ROLI changes protocol | High | Low | Document version compatibility |
| Browser drops WebMIDI | High | Very Low | Feature detection, graceful fallback |
| User confusion on setup | Medium | Medium | Clear wizard, video tutorial |
| Performance issues | Medium | Low | Throttling, optimization |
| Firmware incompatibility | Medium | Medium | Version check, clear requirements |

---

## Future Enhancements (v2.2+)

### Chord Progression Preview
- Light up upcoming chord tones before they play
- Fade in/out as chords approach
- Different colors for chord types (maj=blue, min=green, dim=red)

### Interactive Learning Mode
- "Simon Says" style note games
- Ear training exercises
- Interval recognition drills

### Multi-Device Support
- Support 2-3 chained LUMI blocks (up to 72 keys)
- Span multiple octaves
- Coordinate colors across blocks

### Advanced Color Schemes
- Custom user-defined color maps
- Import/export color schemes
- Community color scheme library

---

## Resources

### Research & Documentation
- `/docs/research/roli-lumi-light-control.md` - Complete protocol research
- `/littlefoot/centaurus-lumi-colors.littlefoot` - Custom LittleFoot script
- `/src/components/LumiTest/LumiTest.tsx` - Testing/prototyping component

### External Resources
- [BLOCKS SDK Documentation](https://weareroli.github.io/BLOCKS-SDK/)
- [benob/LUMI-lights](https://github.com/benob/LUMI-lights) - Reverse-engineered protocol
- [xivilay/lumi-web-control](https://github.com/xivilay/lumi-web-control) - Working implementation
- [ROLI Support](https://support.roli.com/) - Official documentation

### Team Knowledge
- Extensive research completed on ROLI protocols
- Working test component demonstrates all concepts
- LittleFoot script ready for distribution

---

## Notes

- This epic represents significant educational value for music learners
- LUMI integration differentiates Centaurus from all other drum machines
- Two-tier approach allows gradual rollout (basic → advanced)
- Strong foundation from research phase accelerates development
- Clear path from prototype to production

---

## Recent Progress (2025-10-11)

### ✅ Phase 2.1 - SysEx Scale Syncing Complete

**What was implemented:**
1. **Enhanced `lumiController.ts` with scale sync methods:**
   - `setScale(scale: string)` - Maps Piano Roll scales to LUMI SysEx scale bytes
   - `setRootKey(rootKey: string)` - Sets LUMI root key via SysEx
   - `setColorMode(mode: number)` - Configures LUMI color mode (0-3)
   - Added `BitArray` class for proper SysEx encoding

2. **Piano Roll integration:**
   - Added 3 useEffect hooks to sync scale/key changes with LUMI
   - Auto-initialization when LUMI is enabled (sets scale, root key, Mode 1)
   - Real-time sync when user changes scale or root key dropdowns

3. **Scale mapping coverage:**
   - Primary scales: Major, Minor, Chromatic
   - Modes: Dorian, Phrygian, Lydian, Mixolydian, Locrian (fallback to major/minor)
   - Harmonic/Melodic Minor (fallback to minor)
   - Pentatonic Major/Minor
   - Blues scale

**How it works:**
- User changes scale/key in Piano Roll → LUMI automatically updates to match
- LUMI displays root note in one color, other scale notes in another color
- Works with existing per-note MIDI control for active note highlighting

**Testing:**
- Ready for testing with physical LUMI hardware
- Enable LUMI in Piano Roll settings → change scales/keys → LUMI should sync

**Next Steps:**
- Test with physical LUMI device to verify scale sync behavior
- Verify Mode 1 compatibility with MIDI Note On/Off color control
- Consider adding color customization for primary/root slots

---

**Last Updated:** 2025-10-11
**Epic Owner:** Development Team
**Stakeholders:** Users with ROLI Piano M / LUMI Keys hardware
