# Story 16.4: Visual Rendering and Amplification

## Status
Draft

## Story
**As a** guitar player using the fretboard module,
**I want** fret borders to show brightness-adjusted colors with dramatic visual hierarchy,
**so that** I can instantly distinguish harmonically optimal notes from less musical choices.

## Acceptance Criteria
1. Fret borders show brightness-adjusted colors (RGB × brightness formula)
2. Bright cells (0.8-1.0) are highly visible and stand out clearly
3. Dim cells (0.3-0.5) are visually suppressed (very faint)
4. Visual amplification creates dramatic contrast between good and bad choices
5. Placed notes have full brightness background + white border (existing behavior preserved)
6. Smooth transitions between brightness states (75ms CSS transition)
7. Works with all color modes (chromatic/harmonic/spectrum)

## Tasks / Subtasks

- [ ] Implement brightness-adjusted border color calculation (AC: 1, 7)
  - [ ] Get base RGB color from `getNoteColor(noteClass, colorMode)`
  - [ ] Apply brightness multiplication: `r * brightness`, `g * brightness`, `b * brightness`
  - [ ] Return CSS color string: `rgb(${r}, ${g}, ${b})`
  - [ ] Handle spectrum mode (uses full MIDI note range vs note class)

- [ ] Implement visual amplification formula (AC: 2, 3, 4)
  - [ ] For empty cells (no note placed), apply amplification
  - [ ] Map brightness 0.3-1.0 → 0.1-1.0 (make dim notes much fainter)
  - [ ] Formula: `brightness = 0.1 + (brightness - 0.3) * (0.9 / 0.7)`
  - [ ] Clamp to range [0.1, 1.0]
  - [ ] Skip amplification for placed notes (always 1.0)

- [ ] Update FretboardCanvas cell rendering (AC: 1, 5, 6)
  - [ ] Apply brightness-adjusted border color to empty cells
  - [ ] Keep transparent background for empty cells
  - [ ] Preserve full brightness background + white border for placed notes
  - [ ] Add CSS transition: `transition-all duration-75` for smooth changes
  - [ ] Handle hover state (optional white border overlay)

- [ ] Verify color mode integration (AC: 7)
  - [ ] Test chromatic mode (C=red, C#=orange, D=yellow, etc.)
  - [ ] Test harmonic mode (tonic=blue, dominant=green, etc.)
  - [ ] Test spectrum mode (low notes=red, high notes=purple)
  - [ ] Verify brightness adjustment works with all modes

- [ ] Add visual contrast validation (AC: 2, 3, 4)
  - [ ] Measure perceived brightness difference between 0.8 and 0.3
  - [ ] Verify dim cells (0.3-0.5) are visually suppressed
  - [ ] Verify bright cells (0.8-1.0) are highly visible
  - [ ] Ensure gap between good and bad choices is dramatic

## Dev Notes

### Relevant Source Tree
- **FretboardCanvas**: `src/components/GuitarFretboard/FretboardCanvas.tsx` (cell rendering loop)
- **colorMapping**: `src/utils/colorMapping.ts` (getNoteColor function)
- **MelodySequencer Reference**: `src/components/Studio/modules/ChordMelodyArranger/MelodySequencer.tsx` (visual amplification logic, lines 302-308)

### Visual Amplification Math

**Purpose**: Create dramatic visual hierarchy by widening the gap between bright and dim notes.

**Formula**:
```typescript
// For empty cells only (placed notes always have brightness = 1.0)
function amplifyBrightness(brightness: number, hasNote: boolean): number {
  if (hasNote) return 1.0; // Placed notes always full brightness

  // Map brightness 0.3-1.0 → 0.1-1.0 (make dim notes much fainter)
  let amplified = 0.1 + (brightness - 0.3) * (0.9 / 0.7);

  // Clamp to valid range
  return Math.max(0.1, Math.min(1.0, amplified));
}
```

**Effect on Brightness Levels**:
| Original | Amplified | Visual Effect |
|----------|-----------|--------------|
| 1.0 (placed) | 1.0 | Full brightness (no change) |
| 0.90 (chord tone, strong) | 0.96 | Very bright |
| 0.85 (chord tone, medium) | 0.81 | Bright |
| 0.75 (recommended) | 0.68 | Medium-bright |
| 0.65 (acceptable) | 0.55 | Medium |
| 0.55 (passing tone) | 0.42 | Dim |
| 0.45 (subtle) | 0.29 | Very dim |
| 0.20 (out-of-scale) | 0.10 | Extremely faint |

**Why This Works**:
- **Bright cells (0.8-1.0)** stay relatively unchanged → Highly visible melodic paths
- **Dim cells (0.3-0.5)** become much fainter → Visually suppressed less musical options
- The gap between good and bad choices becomes **visually dramatic** (not just numerical)

### Cell Rendering Implementation

```typescript
// In FretboardCanvas cell rendering loop
function renderFretCell(
  string: number,
  fret: number,
  brightness: number,
  colorMode: ColorMode,
  hasNote: boolean
) {
  const midiNote = getMIDINoteFromFret(string, fret, currentTuningMIDI);
  const noteClass = midiNote % 12;

  // Get base color (spectrum mode uses full MIDI range, others use note class)
  const noteForColor = colorMode === 'spectrum' ? midiNote : noteClass;
  const baseColor = getNoteColor(noteForColor, colorMode);

  // Apply visual amplification (only for empty cells)
  const amplifiedBrightness = amplifyBrightness(brightness, hasNote);

  // Apply brightness to RGB channels
  const r = Math.round(baseColor.r * amplifiedBrightness);
  const g = Math.round(baseColor.g * amplifiedBrightness);
  const b = Math.round(baseColor.b * amplifiedBrightness);

  // Build CSS color string
  const borderColor = `rgb(${r}, ${g}, ${b})`;

  // Cell style
  const cellStyle = hasNote
    ? {
        backgroundColor: `rgb(${baseColor.r}, ${baseColor.g}, ${baseColor.b})`, // Full brightness
        borderColor: 'white', // White border for placed notes
      }
    : {
        backgroundColor: 'transparent', // Empty cells have no background
        borderColor: borderColor, // Brightness-adjusted border
      };

  return (
    <div
      className="fret-cell transition-all duration-75"
      style={cellStyle}
      onClick={() => handleFretClick(string, fret)}
      onMouseEnter={() => handleFretHover(string, fret)}
      onMouseLeave={() => handleFretHover(null, null)}
    >
      {/* Cell content (fret markers, note labels, etc.) */}
    </div>
  );
}
```

### CSS Transition for Smooth Brightness Changes

Add to `FretboardCanvas` styles or inline:
```css
.fret-cell {
  transition: all 75ms ease-out;
}
```

This creates smooth brightness transitions when:
- Hovering over different frets (temporal proximity changes)
- Chord progression advances (chord tones change)
- Placing/removing notes (ghost imprints change)

**75ms timing**:
- Fast enough to feel responsive
- Slow enough to avoid jarring flicker
- Matches MelodySequencer transition timing for consistency

### Color Mode Integration

**Chromatic Mode** (`colorMode === 'chromatic'`):
- C (0) = Red (255, 0, 0)
- C# (1) = Orange (255, 127, 0)
- D (2) = Yellow (255, 255, 0)
- ... (12 colors in chromatic circle)
- Brightness × RGB creates pastels for dim notes, saturated for bright notes

**Harmonic Mode** (`colorMode === 'harmonic'`):
- Tonic (I) = Blue
- Dominant (V) = Green
- Subdominant (IV) = Purple
- ... (based on scale degree)
- Chord tones get saturated colors, scale tones get desaturated

**Spectrum Mode** (`colorMode === 'spectrum'`):
- Low notes (MIDI 40-50) = Red
- Mid notes (MIDI 60) = Green
- High notes (MIDI 80+) = Purple
- Brightness × RGB creates rainbow gradient across pitch range

### Visual Contrast Validation

**Manual Testing Approach**:
1. Take screenshot of fretboard with harmonic guidance enabled
2. Open in image editor (Photoshop, GIMP, etc.)
3. Use eyedropper to sample RGB values of:
   - Bright cells (0.8-1.0)
   - Dim cells (0.3-0.5)
4. Calculate perceived brightness: `0.299*R + 0.587*G + 0.114*B`
5. Verify ratio: Bright cells should be 3-5× perceived brightness of dim cells

**Expected Results**:
- Bright chord tone (0.90): Perceived brightness ~200-240
- Dim passing tone (0.45): Perceived brightness ~50-80
- Ratio: 200/50 = 4× (dramatic contrast achieved)

### Testing
**Manual Verification Steps**:

1. **Border Color Adjustment (Chromatic Mode)**:
   - Enable chromatic color mode
   - Enable harmonic guidance
   - Verify fret borders show colored outlines
   - Verify bright frets have saturated colors
   - Verify dim frets have very faint colors

2. **Visual Amplification**:
   - Click fret to place note (full brightness background)
   - Hover nearby frets (bright colored borders)
   - Observe non-hovered frets (very faint borders)
   - Verify dramatic contrast between bright and dim frets

3. **Smooth Transitions**:
   - Hover over different frets rapidly
   - Verify smooth 75ms transition between brightness states
   - No jarring flicker or pop-in

4. **Color Mode Integration**:
   - Test chromatic mode (C=red, D=yellow, E=green, etc.)
   - Test harmonic mode (tonic=blue, dominant=green)
   - Test spectrum mode (low=red, high=purple)
   - Verify brightness adjustment works in all modes

5. **Placed Notes**:
   - Click fret to place note
   - Verify full brightness background (no dimming)
   - Verify white border (not colored)
   - Verify existing behavior preserved

6. **Visual Hierarchy**:
   - With harmonic guidance enabled:
     - Chord tones (0.85-0.90) should be highly visible
     - Scale tones (0.55-0.65) should be medium visibility
     - Out-of-scale (0.20) should be extremely faint
   - Gap between categories should be dramatic

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-15 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*To be filled by QA agent*
