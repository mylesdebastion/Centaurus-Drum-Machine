# Story 20.6: Timekeeping and Rhythm Practice (Education Mode Lesson 3)

**Epic:** Epic 20 - Workshop-Ready Education Mode
**Priority:** üî¥ HIGH (Workshop Critical - Wednesday Deadline)
**Status:** üìù PLANNING
**Estimated Effort:** 4-6 hours
**Prerequisite for:** Story 20.5 (Twinkle Twinkle Lesson)

---

## User Story

**As a** music educator teaching K5-10 deaf and hearing students in a workshop setting,
**I want** a timekeeping and rhythm practice lesson using the **embedded isometric sequencer** that teaches students to keep steady beat and count before attempting melodies,
**So that** students develop rhythm fundamentals and are prepared to play "Twinkle Twinkle Little Star" together in time.

---

## Story Context

### Purpose and Positioning

**This lesson comes BEFORE Story 20.5 (Twinkle Twinkle).** It serves as foundational rhythm training to ensure students can:
- Keep a steady beat
- Count musical time (1, 2, 3, 4)
- Hit their boomwhackers in time with visual cues
- Understand rests (when NOT to play)
- Work as a synchronized group
- Learn turn-taking and waiting for others

**Learning Progression:**
```
Lesson 3 (This Story - 20.6) ‚Üí Lesson 4 (Story 20.5)
Timekeeping & Rhythm         ‚Üí Twinkle Twinkle Melody
```

### Workshop Constraints

**Important:** This lesson is designed for **5-6 unique students**, each with their own colored boomwhacker. There are NO duplicate colors available.

**Student Color Assignments (6 students):**
- **Team Sunrise (Warm Colors):** C-Red, D-Orange, E-Yellow
- **Team Ocean (Cool Colors):** F-Yellow-Green, G-Green, A-Blue

**Warm vs Cool Color Grouping:** Used in Step 2 to teach turn-taking and team coordination without requiring duplicate instruments.

### Integration Points

- **Primary Component:** `src/components/IsometricSequencer/IsometricSequencer.tsx`
  - Add optional `educationConfig` prop (same as Story 20.5)
  - Progressive lane reveal for rhythm exercises
  - Preserve standalone `/isometric` route functionality

- **Secondary Component:** `src/components/Education/EducationMode.tsx`
  - Add Lesson 3 with embedded isometric sequencer
  - Define 4-step rhythm progression
  - Pass education configuration to IsometricSequencer

- **WLED Integration:** `src/utils/SingleLaneVisualizer.ts` (or new `WLEDCountIn` utility)
  - 4-beat count-in with gentle flash **from the beginning**
  - Synchronize with Tone.js Transport

### Boomwhacker Color Mapping (Reference)

```javascript
C  = Red        (#ff4444)
D  = Orange     (#ffaa44)
E  = Yellow     (#ffff44)
F  = Yellow-Green (#aaff44)
G  = Green      (#44ff44)
A  = Blue       (#44aaff)
```

---

## Acceptance Criteria

### AC1: Progressive 4-Step Rhythm Lesson Structure

**Step 1: Steady Beat Practice (C Lane Only)**
- [ ] Only the C lane (red) is visible in embedded isometric sequencer
- [ ] Quarter note pattern: C on beats 1, 2, 3, 4 (steady beat)
- [ ] Student instruction: "Keep the steady beat! Hit your boomwhacker on every beat."
- [ ] WLED count-in: 4 beats **from the beginning** before playback starts
- [ ] Visual beat counter shows "1, 2, 3, 4, START!" during count-in
- [ ] Tempo: 90 BPM (slower for beginner rhythm practice)
- [ ] Pattern loops continuously for practice
- [ ] "Next Step" button available after 2 loops

**Step 2: Turn-Taking - Warm vs Cool Colors**
- [ ] **Progressive reveal:** Warm colors appear first (C-Red, D-Orange, E-Yellow)
- [ ] Camera centers on 3 warm-colored lanes
- [ ] Pattern Part 1 (4 beats): C-D-E-rest (Team Sunrise plays together)
- [ ] **Then lanes transition:** Warm lanes fade slightly, cool lanes appear
- [ ] Cool colors revealed (F-Yellow-Green, G-Green, A-Blue)
- [ ] Camera shifts to center on 3 cool-colored lanes
- [ ] Pattern Part 2 (4 beats): F-G-A-rest (Team Ocean plays together)
- [ ] Instruction: "Team Sunrise plays warm colors, then Team Ocean plays cool colors! Take turns!"
- [ ] WLED count-in: 4 beats **from the beginning** before playback starts
- [ ] Visual beat counter shows "1, 2, 3, 4, START!" during count-in
- [ ] Tempo: 90 BPM
- [ ] Focus: Turn-taking, team synchronization, call-and-response

**Step 3: Individual Notes with Rests (All 6 Lanes Visible)**
- [ ] **All 6 lanes now revealed:** C, D, E, F, G, A
- [ ] Progressive reveal animation shows all lanes sliding into place
- [ ] Camera zooms out to show complete view
- [ ] Pattern with rests: C-rest-D-rest-E-rest-G-rest (8 beats)
- [ ] Each student plays ONCE at their own specific beat
- [ ] F and A students rest this pattern (but keep counting!)
- [ ] Instruction: "Each of you plays YOUR note at YOUR time. Stay quiet on empty beats!"
- [ ] WLED count-in: 4 beats **from the beginning** before playback starts
- [ ] Visual beat counter shows "1, 2, 3, 4, START!" during count-in
- [ ] Tempo: 90 BPM
- [ ] Focus: Individual responsibility, counting through rests, patience
- [ ] Timeline visible with filled/empty beat markers clearly shown

**Step 4: Complex Rhythm Pattern (All 6 Lanes Remain Visible)**
- [ ] All 6 lanes remain visible from Step 3
- [ ] Complex rhythm pattern: C-C-rest-G-A-A-rest-G (8 beats)
- [ ] Some students play twice (C student, A student get double hits!)
- [ ] Some students play once at different positions (G student plays twice but at different times)
- [ ] D, E, F students rest this pattern (but keep counting - they're important!)
- [ ] This mirrors Twinkle's rhythmic structure (double hits + rests)
- [ ] Instruction: "Advanced rhythm! Some of you hit TWICE, some rest completely. Watch carefully!"
- [ ] WLED count-in: 4 beats **from the beginning** before playback starts
- [ ] Visual beat counter shows "1, 2, 3, 4, START!" during count-in
- [ ] Tempo: 90 BPM
- [ ] Timeline markers visible with double hits and rests clearly marked
- [ ] Students recognize: "This IS Twinkle Twinkle's rhythm!"
- [ ] Success message: "Great rhythm! You're ready for Twinkle Twinkle!"

### AC2: Technical Implementation Requirements

**Embedded Isometric Mode**
- [ ] IsometricSequencer accepts optional `educationConfig` prop (same as Story 20.5)
- [ ] When `educationConfig` is present, enable progressive reveal mode
- [ ] When `educationConfig` is undefined/null, render full 12-lane sequencer (existing behavior)
- [ ] **CRITICAL**: Standalone `/isometric` route remains completely untouched and functional

**Lane Visibility Control**
- [ ] `visibleLanes` array in config controls which lanes render
- [ ] Camera auto-adjusts to center only visible lanes (no empty space)
- [ ] Smooth lane reveal animations (fade-in or slide-in)
- [ ] Hidden lanes are not clickable or interactive

**WLED Count-In Integration**
- [ ] 4-beat count-in happens **from the beginning** (Step 1 onwards) before every playback
- [ ] Gentle flash pattern: 0% ‚Üí 40% ‚Üí 0% brightness per beat
- [ ] White color (#FFFFFF) for maximum visibility
- [ ] Synchronized with Tone.js Transport
- [ ] All connected WLED strips flash in unison
- [ ] Visual beat counter overlay shows "1, 2, 3, 4, START!" during count-in

**Pattern Data**
- [ ] Rhythm patterns embedded in Lesson 3 config
- [ ] Tempo: 90 BPM (slower for rhythm training)
- [ ] Auto-load pattern when step begins
- [ ] Pattern data structure:
  ```typescript
  pattern: {
    C: [true, true, true, true, true, true, true, true], // Step 1: every beat
    // ... etc
  }
  ```

### AC3: UI/UX Requirements

**Responsive Design**
- [ ] Works on mobile, tablet, desktop
- [ ] Touch targets ‚â•44px for accessibility
- [ ] Mobile-first approach matches existing Education Mode

**Visual Indicators**
- [ ] Beat counter overlay during count-in ("1", "2", "3", "4", "START!")
- [ ] Timeline markers showing beat divisions (Steps 3 & 4)
- [ ] Color-coded lane labels with note names
- [ ] Playhead indicator showing current beat
- [ ] Empty beat markers for rests (Step 3 & 4)

**Instructions**
- [ ] Age-appropriate language for K5-10 students
- [ ] Clear, simple, encouraging
- [ ] Visual cues for deaf students (no audio-only indicators)
- [ ] Emphasis on "steady beat" and "in time"

### AC4: Integration Requirements

**No Breaking Changes**
- [ ] Existing EducationMode Lessons 1-2 work unchanged
- [ ] Standalone `/isometric` route works perfectly
- [ ] No regression in existing functionality

**React Context/Props Pattern**
- [ ] Use React props or context to pass lesson config from EducationMode to IsometricSequencer
- [ ] Clean separation: education logic in EducationMode, rendering logic in IsometricSequencer

**Performance**
- [ ] Maintain 60fps with education mode enabled
- [ ] <50ms LED visualization latency
- [ ] No memory leaks when switching steps

---

## Technical Implementation

### IsometricSequencer Changes

**Uses Same Education Config Interface from Story 20.5**

```typescript
interface EducationConfig {
  visibleLanes: string[];              // ['C', 'G']
  pattern: Record<string, boolean[]>;  // Note -> 8 or 16-step pattern
  tempo: number;                       // BPM (90 for rhythm practice)
  enableCountIn: boolean;              // Show count-in
  showTimeline?: boolean;              // Show beat markers
  showBeatCounter?: boolean;           // Show "1, 2, 3, 4" counter
  loopCount?: number;                  // Number of times to loop before enabling "Next"
}

interface IsometricSequencerProps {
  onBack: () => void;
  educationConfig?: EducationConfig;  // Optional - undefined = standalone mode
}
```

### EducationMode Changes

**Add Lesson 3 Data Structure**

```typescript
{
  id: '3',
  title: 'Rhythm & Timekeeping',
  description: 'Learn to keep steady beat and count in time',
  difficulty: 'beginner',
  steps: [
    {
      id: '3-1',
      instruction: 'Keep the steady beat! Hit your boomwhacker on every beat.',
      hint: 'üí° Listen to the count: 1, 2, 3, 4. Keep the same speed all the way through!',
      completed: false,
      educationConfig: {
        visibleLanes: ['C'],
        pattern: {
          C: [true, true, true, true, true, true, true, true] // Every beat
        },
        tempo: 90,
        enableCountIn: true,
        showBeatCounter: true,
        loopCount: 2
      }
    },
    {
      id: '3-2',
      instruction: 'Team Sunrise plays warm colors, then Team Ocean plays cool colors! Take turns!',
      hint: 'üí° Warm colors (red, orange, yellow), then Cool colors (green, blue)! Call and response!',
      completed: false,
      educationConfig: {
        visibleLanes: ['C', 'D', 'E', 'F', 'G', 'A'], // All 6, but grouped visually
        pattern: {
          // Team Sunrise (warm colors) - beats 1-3
          C: [true, false, false, false, false, false, false, false],
          D: [false, true, false, false, false, false, false, false],
          E: [false, false, true, false, false, false, false, false],
          // Beat 4: rest
          // Team Ocean (cool colors) - beats 5-7
          F: [false, false, false, false, true, false, false, false],
          G: [false, false, false, false, false, true, false, false],
          A: [false, false, false, false, false, false, true, false]
          // Beat 8: rest
        },
        tempo: 90,
        enableCountIn: true,
        showBeatCounter: true,
        loopCount: 2
      }
    },
    {
      id: '3-3',
      instruction: 'Each of you plays YOUR note at YOUR time. Stay quiet on empty beats!',
      hint: 'üí° Empty beats are just as important as the notes! Count them silently.',
      completed: false,
      educationConfig: {
        visibleLanes: ['C', 'D', 'E', 'F', 'G', 'A'], // All 6 lanes visible
        pattern: {
          C: [true, false, false, false, false, false, false, false],  // Beat 1
          // Beat 2: rest
          D: [false, false, true, false, false, false, false, false],  // Beat 3
          // Beat 4: rest
          E: [false, false, false, false, true, false, false, false],  // Beat 5
          // Beat 6: rest
          G: [false, false, false, false, false, false, true, false],  // Beat 7
          // Beat 8: rest
          // F and A don't play this pattern (but they count!)
        },
        tempo: 90,
        enableCountIn: true,
        showBeatCounter: true,
        showTimeline: true
      }
    },
    {
      id: '3-4',
      instruction: 'Advanced rhythm! Watch carefully - some notes play twice, some beats are silent.',
      hint: 'üí° This rhythm is like Twinkle Twinkle! Double notes + rests = musical magic!',
      completed: false,
      educationConfig: {
        visibleLanes: ['C', 'D', 'E', 'F', 'G', 'A'],
        pattern: {
          C: [true, true, false, false, false, false, false, false],
          G: [false, false, false, true, false, false, false, true],
          A: [false, false, false, false, true, true, false, false]
        },
        tempo: 90,
        enableCountIn: true,
        showBeatCounter: true,
        showTimeline: true
      }
    }
  ]
}
```

**Render Embedded Isometric (Same as Story 20.5)**

```tsx
{selectedLesson?.id === '3' && currentStep.educationConfig && (
  <div className="mb-6">
    <IsometricSequencer
      onBack={() => {}} // Disabled in education mode
      educationConfig={currentStep.educationConfig}
    />
  </div>
)}
```

---

## File Modifications

### Files to Modify

**1. `src/components/Education/EducationMode.tsx`**
- Add Lesson 3 data structure (this story)
- Note: Existing Lesson 3 in codebase may need to be renumbered to Lesson 5
- Add embedded isometric rendering for Lesson 3
- Update lesson selection logic

**2. `src/components/IsometricSequencer/IsometricSequencer.tsx`**
- Same changes as Story 20.5 (education config support)
- No additional changes needed if Story 20.5 is implemented first

**3. `src/types/index.ts`**
- Extend `EducationLesson` interface to support `educationConfig` in steps (same as 20.5)
- Add optional `loopCount` property to `EducationConfig`

### Files NOT to Modify

- **Do NOT touch** standalone `/isometric` route logic
- **Do NOT modify** IsometricSequencer render logic except for lane filtering
- **Do NOT change** existing EducationMode Lessons 1-2

---

## Definition of Done

### Functional Checklist

- [ ] Lesson 3 appears in Education Mode lesson selection
- [ ] Step 1: Only C lane visible, steady quarter note beat (8 beats)
- [ ] Step 2: Progressive reveal - warm colors (C, D, E) first, then cool colors (F, G, A)
- [ ] Step 2: Team Sunrise plays first (beats 1-3), then Team Ocean responds (beats 5-7)
- [ ] Step 2: Call-and-response pattern creates turn-taking experience
- [ ] Step 3: All 6 lanes visible, individual notes with rests (C-rest-D-rest-E-rest-G-rest)
- [ ] Step 3: F and A students rest but keep counting (inclusive design)
- [ ] Step 4: All 6 lanes remain visible, complex rhythm pattern (C-C-rest-G-A-A-rest-G)
- [ ] Step 4: D, E, F students rest but keep counting
- [ ] WLED count-in flashes 4 times **from the beginning** before each step's playback
- [ ] Beat counter displays "1, 2, 3, 4, START!" during count-in **in all steps**
- [ ] Timeline markers visible in Steps 3 & 4
- [ ] Empty beat markers show rests clearly
- [ ] Camera centers on active lanes with progressive reveal animations
- [ ] Lane reveal animations are smooth (especially Step 2 warm‚Üícool transition)
- [ ] "Next Step" progression works correctly
- [ ] Standalone `/isometric` route still works perfectly

### Code Quality Checklist

- [ ] No TypeScript errors or warnings
- [ ] Existing Lessons 1-2 work without regression
- [ ] Code follows existing patterns
- [ ] No console errors during playback
- [ ] Responsive design (mobile, tablet, desktop tested)
- [ ] Performance: 60fps maintained

### Testing Checklist

- [ ] **Embedded mode:** Lesson 3 works in Education Mode
- [ ] **Standalone mode:** `/isometric` route unchanged
- [ ] **Lane reveal:** Each step shows only configured lanes
- [ ] **WLED count-in:** 4-beat flash before playback (if hardware available)
- [ ] **Pattern playback:** All rhythm patterns play correctly
- [ ] **Rests:** Empty beats are clearly visible and silent
- [ ] **Camera:** Auto-centers on visible lanes
- [ ] **Mobile:** Works on 375px width viewport
- [ ] **Touch targets:** All buttons ‚â•44px
- [ ] **Tempo:** 90 BPM feels appropriate for rhythm training

---

## Risk Assessment

### Primary Risks

**Risk 1: Conflict with Existing Lesson 3**

**Current State:** EducationMode may already have a Lesson 3 (Rhythm Patterns)

**Mitigation:**
- Review existing lessons before implementation
- Renumber existing Lesson 3 to Lesson 5 if needed
- Ensure lesson IDs remain unique
- Update any hardcoded references to lesson IDs

**Risk 2: Pattern Timing Confusion**

**Issue:** Students may not understand rests vs. notes

**Mitigation:**
- Clear visual markers for empty beats
- Instruction emphasizes "stay quiet on empty beats"
- Timeline shows all beats (filled and empty)
- Visual beat counter continues through rests

**Risk 3: Tempo Too Fast for Beginners**

**Issue:** 90 BPM may be too fast for some students

**Mitigation:**
- Configurable tempo in education config
- Could be adjusted to 80 BPM if needed during workshop
- Count-in establishes tempo clearly
- Looping allows multiple practice attempts

### Rollback Plan

**If story fails:**
1. Remove Lesson 3 from `lessons` array (single change in EducationMode.tsx)
2. Revert lesson numbering if needed
3. **Rollback time:** <3 minutes
4. **Impact:** Zero - Lessons 1-2 and Lesson 4 (Twinkle) unaffected

---

## Testing Strategy

### Integration Tests (Manual)

1. **Lesson Progression Test**
   - Start Lesson 3 ‚Üí Step 1
   - Verify only C lane visible, steady beat pattern
   - Click "Next Step" ‚Üí Step 2
   - Verify C & G lanes visible, alternating pattern
   - Complete all 4 steps

2. **Rhythm Pattern Verification**
   - Step 1: Every beat has a note (8 consecutive hits)
   - Step 2: Alternating C-G (no two same notes in a row)
   - Step 3: Rests are silent (empty beats clearly visible)
   - Step 4: Double hits work correctly (C-C, A-A)

3. **Visual Indicators Test**
   - Beat counter shows in all steps
   - Empty beat markers visible in Steps 3 & 4
   - Timeline markers help track position
   - Playhead indicator moves smoothly

4. **WLED Count-In Test**
   - Connect physical WLED strip
   - Start Lesson 3, Step 1
   - Verify 4-beat flash before playback
   - Verify tempo matches 90 BPM

---

## Success Criteria

The story is successful when:

1. ‚úÖ Lesson 3 is fully functional with 4-step rhythm progression
2. ‚úÖ Students can practice steady beat, alternating notes, rests, and complex rhythms
3. ‚úÖ Embedded isometric sequencer displays only configured lanes per step
4. ‚úÖ WLED count-in synchronizes with playback start (4 beats from beginning)
5. ‚úÖ Visual indicators (beat counter, timeline, empty beats) are clear and helpful
6. ‚úÖ Standalone `/isometric` route works without any changes
7. ‚úÖ No regression in existing EducationMode Lessons 1-2
8. ‚úÖ Students completing Lesson 3 are prepared for Twinkle Twinkle (Lesson 4)
9. ‚úÖ Code is production-ready and passes manual testing
10. ‚úÖ Workshop-ready for Wednesday deadline

---

## Estimated Effort

**Development Time:** 4-6 hours

**Breakdown:**
- EducationMode Lesson 3 data structure (1h)
- Rhythm pattern design and testing (0.5h)
- Empty beat marker UI implementation (1h)
- Integration with existing education config (1h)
- Testing rhythm patterns and timing (1h)
- Documentation and polish (0.5h)

**Note:** If Story 20.5 is implemented first, this story will be faster (2-3 hours) since the education config infrastructure will already exist.

---

## Notes for Development

### Rhythm Pattern Design Philosophy

**Step 1: Steady Beat**
- Simplest possible pattern
- Builds confidence and tempo awareness
- Every beat is the same (no variation)

**Step 2: Alternating Notes**
- Adds variety while maintaining steady beat
- Students must switch between notes without losing tempo
- Prepares for multi-student coordination

**Step 3: Rests**
- Introduces silence as a musical element
- Students learn when NOT to play
- Builds rhythmic independence

**Step 4: Complex Rhythm**
- Mirrors Twinkle Twinkle structure
- Double hits + rests
- Direct preparation for melody in Lesson 4

### Connection to Twinkle Twinkle

**Twinkle Pattern:** C-C-G-G-A-A-G
**Step 4 Pattern:** C-C-rest-G-A-A-rest-G

The similarity is intentional - students will recognize the rhythm when they start Lesson 4!

### Empty Beat Visualization

**UI Suggestion:**
```tsx
// In IsometricSequencer - render empty beat markers
{showTimeline && (
  <div className="timeline">
    {beats.map((beat, i) => (
      <div
        key={i}
        className={beat.hasNote ? 'beat-filled' : 'beat-empty'}
      >
        {i + 1}
      </div>
    ))}
  </div>
)}
```

---

**Story Owner:** Product Owner
**Developer:** Dev Agent
**Epic:** Epic 20 - Workshop-Ready Education Mode
**Target Date:** Before Wednesday workshop
**Priority:** HIGH - Workshop Critical
**Dependencies:** Should be implemented before or alongside Story 20.5
**Related Stories:**
- Story 20.5 (Twinkle Twinkle - this lesson prepares students for it)
- Uses same education config architecture
