# Story 22.3: Referral Attribution & Analytics

**Epic**: 22 - AI-Native Product-Led Growth Flywheel
**Status**: 📋 Draft
**Priority**: 🔴 Critical (Week 1)
**Estimated Effort**: 1-2 hours
**Owner**: Solo Dev

---

## Story

As a **product owner tracking viral growth**,
I want **to see which personas convert best and who my top referrers are**,
So that **I can double down on successful paths and reward advocates**.

---

## Context

**Problem**: We're sending personalized URLs (`?v=c&r=sc4t`) but not tracking:
- Which personas complete tutorials most often?
- Which referrers bring the most users?
- Is Scarlet Watters driving traffic? Is the Educator path converting?

**Solution**: Build referral attribution system that:
1. Captures `?v=` (persona) and `?r=` (referrer) codes on page load
2. Tracks key events (landing, tutorial completion, sign-up, share)
3. Provides analytics dashboard showing conversion funnels by persona/referrer
4. Notifies referrers when someone uses their link ("Sarah joined your session!")

**Use Case**: After Week 2 of outreach, check dashboard to see:
- Educator path (`?v=e`): 45 visits, 60% tutorial completion, 12 sign-ups
- Scarlet's referrals (`&r=sc4t`): 23 visits, 40% completion, 5 sign-ups
- **Decision**: Scarlet's traffic is engaged → send her thank you + ask for testimonial

**Reference**: Epic 22, Stories 22.1 & 22.2

---

## Acceptance Criteria

### Must-Have

- [ ] **URL parameter capture on page load**:
  - Extract `?v=` (persona code: d/e/v/p/c)
  - Extract `&r=` (referral code: sc4t, se8a, etc.)
  - Store in localStorage (persist across sessions)
  - Send to analytics (GA4 custom event or internal DB)

- [ ] **Event tracking with attribution**:
  - `referral_landing` - User lands via `?v=&r=` URL
  - `tutorial_started` - User begins onboarding (with persona/referrer)
  - `tutorial_completed` - User finishes tutorial (with persona/referrer)
  - `first_share` - User creates session and shares (with persona/referrer)
  - All events include persona + referrer dimensions

- [ ] **Analytics dashboard** (simple web UI or Google Sheets):
  - **By Persona**: Table showing visits, completion %, sign-ups per persona
  - **By Referrer**: Table showing visits, completion %, sign-ups per referrer
  - **Conversion Funnel**: Landing → Tutorial Start → Tutorial Complete → Share
  - CSV export for deeper analysis

- [ ] **Referrer notifications** (optional but high-value):
  - When someone uses Sean's link (`&r=se8a`) and completes tutorial
  - Send notification: "🎉 Sarah joined via your link! You've referred 3 people this week."
  - In-app notification or email (if referrer has account)

### Nice-to-Have

- [ ] Real-time dashboard (updates live as users land)
- [ ] Top referrer leaderboard ("Community Builders" badge)
- [ ] A/B test persona messaging (test 2 versions of Educator path)
- [ ] Cohort analysis (Week 1 users vs. Week 2 users retention)

---

## Technical Implementation

### Architecture Overview

```
┌─────────────────┐
│ User lands      │ jam.audiolux.app?v=c&r=sc4t
│ jam.audiolux.app│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ URL Parser      │ Extract v=c, r=sc4t
│ personaCodes.ts │ Store in localStorage
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Analytics Tracker│ Send event: referral_landing
│ (GA4 or custom) │ Dimensions: persona=creator, ref=sc4t
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Supabase DB     │ Store: visit, persona, referrer, timestamp
│ (or CSV export) │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Dashboard UI    │ Show: conversion by persona/referrer
│ (React or GSheet│
└─────────────────┘
```

---

### File Structure

```
src/
  utils/
    referralTracking.ts     # Core tracking logic
    analytics.ts            # GA4/custom event tracking
  components/
    Analytics/
      Dashboard.tsx         # Analytics dashboard UI
      PersonaFunnel.tsx     # Persona conversion funnel
      ReferrerTable.tsx     # Top referrers table

backend/ (optional - if using custom DB)
  supabase/
    migrations/
      001_referral_tracking.sql  # DB schema
```

---

### Implementation: referralTracking.ts

```typescript
// src/utils/referralTracking.ts

import { decodePersonaUrl } from './personaCodes';
import { trackEvent } from './analytics';

export interface ReferralData {
  persona: string | null;
  referralCode: string | null;
  landingUrl: string;
  landingTime: string;
  sessionId: string;
}

const STORAGE_KEY = 'audiolux_referral';

/**
 * Capture referral data from URL on page load
 * Stores in localStorage to persist across sessions
 */
export function captureReferralData(): ReferralData | null {
  // Check if already captured in this session
  const existing = getReferralData();
  if (existing) return existing;

  const { persona, referralCode } = decodePersonaUrl();

  // Only capture if URL has persona or referral code
  if (!persona && !referralCode) return null;

  const data: ReferralData = {
    persona,
    referralCode,
    landingUrl: window.location.href,
    landingTime: new Date().toISOString(),
    sessionId: generateSessionId()
  };

  // Store in localStorage (persists across page reloads)
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));

  // Track landing event
  trackEvent('acquisition', 'referral_landing', `${persona}|${referralCode}`);

  // Send to backend (optional)
  sendToBackend('referral_landing', data);

  return data;
}

/**
 * Get stored referral data
 */
export function getReferralData(): ReferralData | null {
  const stored = localStorage.getItem(STORAGE_KEY);
  return stored ? JSON.parse(stored) : null;
}

/**
 * Track event with referral attribution
 *
 * @param eventName - Event name (tutorial_started, tutorial_completed, etc.)
 * @param additionalData - Extra event data
 */
export function trackWithAttribution(
  eventName: string,
  additionalData?: Record<string, any>
) {
  const referral = getReferralData();

  const eventData = {
    ...additionalData,
    persona: referral?.persona || 'organic',
    referralCode: referral?.referralCode || 'none',
    sessionId: referral?.sessionId || generateSessionId()
  };

  // Send to GA4 or custom analytics
  trackEvent('activation', eventName, JSON.stringify(eventData));

  // Send to backend
  sendToBackend(eventName, eventData);

  return eventData;
}

/**
 * Track tutorial completion with attribution
 */
export function trackTutorialCompletion(personaPath: string) {
  const referral = getReferralData();

  trackWithAttribution('tutorial_completed', {
    personaPath,
    completedAt: new Date().toISOString()
  });

  // Notify referrer if applicable
  if (referral?.referralCode) {
    notifyReferrer(referral.referralCode, 'tutorial_completed');
  }
}

/**
 * Track share action with attribution
 */
export function trackShare(shareMethod: string) {
  const referral = getReferralData();

  trackWithAttribution('first_share', {
    shareMethod,
    sharedAt: new Date().toISOString()
  });

  // Notify referrer (user became advocate!)
  if (referral?.referralCode) {
    notifyReferrer(referral.referralCode, 'user_shared');
  }
}

/**
 * Send event to backend for dashboard
 */
async function sendToBackend(eventName: string, data: any) {
  try {
    // Option 1: Supabase
    // await supabase.from('referral_events').insert({ event: eventName, ...data });

    // Option 2: Simple API endpoint
    await fetch('/api/track-referral', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ event: eventName, ...data })
    });
  } catch (error) {
    console.error('Failed to send referral data:', error);
    // Fail silently (analytics shouldn't break app)
  }
}

/**
 * Notify referrer when someone uses their link
 */
async function notifyReferrer(referralCode: string, eventType: string) {
  try {
    await fetch('/api/notify-referrer', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ referralCode, eventType })
    });
  } catch (error) {
    console.error('Failed to notify referrer:', error);
  }
}

/**
 * Generate unique session ID
 */
function generateSessionId(): string {
  return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
}

/**
 * Clear referral data (for testing or reset)
 */
export function clearReferralData() {
  localStorage.removeItem(STORAGE_KEY);
}
```

---

### Integration with App

**In App Entry Point** (`src/main.tsx` or `App.tsx`):

```tsx
import { captureReferralData } from '@/utils/referralTracking';

function App() {
  useEffect(() => {
    // Capture referral data on app load
    captureReferralData();
  }, []);

  return <Router>...</Router>;
}
```

**In Tutorial Components**:

```tsx
import { trackWithAttribution, trackTutorialCompletion } from '@/utils/referralTracking';

function GuidedTutorial() {
  const handleTutorialStart = () => {
    trackWithAttribution('tutorial_started', { persona: 'educator' });
  };

  const handleTutorialComplete = () => {
    trackTutorialCompletion('educator');
    showCelebration();
  };

  return <Tutorial onStart={handleTutorialStart} onComplete={handleTutorialComplete} />;
}
```

**In Share Modal**:

```tsx
import { trackShare } from '@/utils/referralTracking';

function ShareSessionModal() {
  const handleShare = (method: 'whatsapp' | 'email' | 'copy') => {
    trackShare(method);
    // ... share logic
  };

  return (
    <div>
      <button onClick={() => handleShare('whatsapp')}>Share via WhatsApp</button>
      <button onClick={() => handleShare('email')}>Share via Email</button>
      <button onClick={() => handleShare('copy')}>Copy Link</button>
    </div>
  );
}
```

---

### Analytics Dashboard (Simple React UI)

```tsx
// src/components/Analytics/Dashboard.tsx

import React, { useEffect, useState } from 'react';

interface PersonaMetrics {
  persona: string;
  visits: number;
  tutorialStarts: number;
  tutorialCompletions: number;
  shares: number;
  conversionRate: number;
}

interface ReferrerMetrics {
  referrerCode: string;
  referrerName: string;
  visits: number;
  completions: number;
  shares: number;
}

export const AnalyticsDashboard: React.FC = () => {
  const [personaData, setPersonaData] = useState<PersonaMetrics[]>([]);
  const [referrerData, setReferrerData] = useState<ReferrerMetrics[]>([]);

  useEffect(() => {
    fetchAnalytics();
  }, []);

  async function fetchAnalytics() {
    // Fetch from backend
    const response = await fetch('/api/analytics/summary');
    const data = await response.json();
    setPersonaData(data.byPersona);
    setReferrerData(data.byReferrer);
  }

  return (
    <div className="p-8 bg-gray-900 min-h-screen">
      <h1 className="text-3xl font-bold text-white mb-8">
        Referral Analytics Dashboard
      </h1>

      {/* Persona Funnel */}
      <section className="mb-12">
        <h2 className="text-2xl font-semibold text-white mb-4">
          Conversion by Persona
        </h2>
        <div className="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
          <table className="w-full text-left">
            <thead className="bg-gray-700">
              <tr>
                <th className="p-4 text-gray-300">Persona</th>
                <th className="p-4 text-gray-300">Visits</th>
                <th className="p-4 text-gray-300">Started</th>
                <th className="p-4 text-gray-300">Completed</th>
                <th className="p-4 text-gray-300">Shared</th>
                <th className="p-4 text-gray-300">Conversion</th>
              </tr>
            </thead>
            <tbody>
              {personaData.map((persona) => (
                <tr key={persona.persona} className="border-t border-gray-700">
                  <td className="p-4 text-white font-medium">
                    {formatPersona(persona.persona)}
                  </td>
                  <td className="p-4 text-gray-300">{persona.visits}</td>
                  <td className="p-4 text-gray-300">{persona.tutorialStarts}</td>
                  <td className="p-4 text-gray-300">{persona.tutorialCompletions}</td>
                  <td className="p-4 text-gray-300">{persona.shares}</td>
                  <td className="p-4 text-primary-400 font-semibold">
                    {persona.conversionRate.toFixed(1)}%
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </section>

      {/* Top Referrers */}
      <section>
        <h2 className="text-2xl font-semibold text-white mb-4">
          Top Referrers
        </h2>
        <div className="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
          <table className="w-full text-left">
            <thead className="bg-gray-700">
              <tr>
                <th className="p-4 text-gray-300">Referrer</th>
                <th className="p-4 text-gray-300">Code</th>
                <th className="p-4 text-gray-300">Visits</th>
                <th className="p-4 text-gray-300">Completions</th>
                <th className="p-4 text-gray-300">Shares</th>
                <th className="p-4 text-gray-300">Badge</th>
              </tr>
            </thead>
            <tbody>
              {referrerData.map((referrer) => (
                <tr key={referrer.referrerCode} className="border-t border-gray-700">
                  <td className="p-4 text-white font-medium">
                    {referrer.referrerName}
                  </td>
                  <td className="p-4 text-gray-400 font-mono text-sm">
                    {referrer.referrerCode}
                  </td>
                  <td className="p-4 text-gray-300">{referrer.visits}</td>
                  <td className="p-4 text-gray-300">{referrer.completions}</td>
                  <td className="p-4 text-gray-300">{referrer.shares}</td>
                  <td className="p-4">
                    {referrer.shares >= 5 && (
                      <span className="px-2 py-1 bg-primary-500 text-white text-xs rounded">
                        Community Builder 🌟
                      </span>
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
};

function formatPersona(persona: string): string {
  const map: Record<string, string> = {
    'd': 'Deaf Musician',
    'e': 'Educator',
    'v': 'Visual Learner',
    'p': 'Producer',
    'c': 'Creator'
  };
  return map[persona] || persona;
}
```

---

### Backend API (Simple Express Example)

```javascript
// backend/api/track-referral.js

const express = require('express');
const router = express.Router();

// In-memory storage (use Supabase/PostgreSQL for production)
const events = [];

router.post('/api/track-referral', (req, res) => {
  const { event, persona, referralCode, sessionId } = req.body;

  events.push({
    event,
    persona,
    referralCode,
    sessionId,
    timestamp: new Date().toISOString()
  });

  console.log(`[Referral Event] ${event} | Persona: ${persona} | Ref: ${referralCode}`);

  res.json({ success: true });
});

router.get('/api/analytics/summary', (req, res) => {
  // Aggregate events by persona
  const byPersona = {};
  const byReferrer = {};

  events.forEach((e) => {
    // By persona
    if (!byPersona[e.persona]) {
      byPersona[e.persona] = {
        persona: e.persona,
        visits: 0,
        tutorialStarts: 0,
        tutorialCompletions: 0,
        shares: 0
      };
    }

    if (e.event === 'referral_landing') byPersona[e.persona].visits++;
    if (e.event === 'tutorial_started') byPersona[e.persona].tutorialStarts++;
    if (e.event === 'tutorial_completed') byPersona[e.persona].tutorialCompletions++;
    if (e.event === 'first_share') byPersona[e.persona].shares++;

    // By referrer
    if (e.referralCode && e.referralCode !== 'none') {
      if (!byReferrer[e.referralCode]) {
        byReferrer[e.referralCode] = {
          referrerCode: e.referralCode,
          referrerName: lookupReferrerName(e.referralCode),
          visits: 0,
          completions: 0,
          shares: 0
        };
      }

      if (e.event === 'referral_landing') byReferrer[e.referralCode].visits++;
      if (e.event === 'tutorial_completed') byReferrer[e.referralCode].completions++;
      if (e.event === 'first_share') byReferrer[e.referralCode].shares++;
    }
  });

  // Calculate conversion rates
  Object.values(byPersona).forEach((p) => {
    p.conversionRate = p.visits > 0 ? (p.tutorialCompletions / p.visits) * 100 : 0;
  });

  res.json({
    byPersona: Object.values(byPersona),
    byReferrer: Object.values(byReferrer)
  });
});

function lookupReferrerName(code) {
  const referrerMap = {
    'sc4t': 'Scarlet Watters',
    'se8a': 'Sean Forbes',
    'dr3m': 'Drake Music',
    // ... add more
  };
  return referrerMap[code] || `Referrer ${code}`;
}

module.exports = router;
```

---

## Validation & Testing

### Manual Testing Checklist

**URL Capture**:
- [ ] Visit `jam.audiolux.app?v=e&r=se8a`
- [ ] Open DevTools → Application → Local Storage
- [ ] Verify `audiolux_referral` key exists with persona='e', referralCode='se8a'

**Event Tracking**:
- [ ] Complete tutorial
- [ ] Check analytics dashboard → Educator row shows +1 completion
- [ ] Check Sean Forbes row shows +1 completion

**Referrer Notifications** (if implemented):
- [ ] User completes tutorial via Sean's link
- [ ] Sean receives notification (email or in-app)

**Dashboard UI**:
- [ ] Navigate to `/analytics` (or wherever dashboard is hosted)
- [ ] Verify persona table shows all 5 personas
- [ ] Verify referrer table shows top referrers
- [ ] CSV export works

---

## Success Metrics

**Primary KPIs** (Week 2):
- ✅ 100% of visits tracked (no data loss)
- ✅ Dashboard shows conversion funnel by persona
- ✅ Top 3 referrers identified

**Secondary KPIs** (Week 4):
- ✅ Educator path has highest completion rate (predicted)
- ✅ 1+ referrer with 10+ visits (Sean Forbes or Scarlet Watters)
- ✅ Data used to optimize outreach strategy

---

## Dependencies

**Blockers**: None

**Required**:
- Stories 22.1 & 22.2 completed (persona codes and outreach URLs)
- LocalStorage support (all modern browsers)

**Optional**:
- Supabase account (for persistent DB storage)
- Email service (for referrer notifications)

---

## Risks & Mitigation

### Risk 1: LocalStorage Cleared by User
**Impact**: Lose referral attribution for that user
**Mitigation**: Also send to backend immediately on landing (don't rely solely on localStorage)

### Risk 2: Privacy/GDPR Concerns
**Impact**: Tracking users without consent may violate GDPR
**Mitigation**:
- Only track anonymous IDs (no PII)
- Add cookie consent banner (Story 21.2)
- Allow opt-out

### Risk 3: Backend Overload with Many Events
**Impact**: API slow or crashes
**Mitigation**:
- Use batch sending (every 5 events or 30 seconds)
- Implement rate limiting
- Use Supabase (scales automatically)

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] URL parameters captured on page load
- [ ] Referral data stored in localStorage
- [ ] Events tracked with attribution (persona + referrer)
- [ ] Dashboard UI shows persona/referrer tables
- [ ] CSV export works
- [ ] Referrer notifications working (optional)
- [ ] Manual testing checklist completed
- [ ] No privacy violations (anonymous IDs only)
- [ ] Story marked as "Review" status

---

## Dev Agent Record

### Agent Model Used
[To be filled by dev agent]

### Completion Notes
[To be filled by dev agent]

### File List
```
src/utils/
  referralTracking.ts

src/components/Analytics/
  Dashboard.tsx
  PersonaFunnel.tsx
  ReferrerTable.tsx

backend/api/
  track-referral.js
  analytics-summary.js
```

### Change Log
[To be filled by dev agent]

### Debug Log References
[To be filled by dev agent]

---

## Related Stories

- **Story 22.1**: Multi-Path Onboarding (provides persona codes to track)
- **Story 22.2**: AI Outreach Generator (creates referral URLs with codes)
- **Story 22.4**: Viral Loop Triggers (tracks share events)

---

## Document Version

**Version**: 1.0
**Created**: 2025-10-25
**Last Updated**: 2025-10-25
**Status**: 📋 **Draft - Ready for Development**
