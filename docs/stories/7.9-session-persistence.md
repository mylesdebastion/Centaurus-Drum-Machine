# Story 7.9: Session Persistence (Optional)

**Epic:** Epic 7 - Jam Session Backend Infrastructure (Hybrid: Supabase + WebRTC P2P)
**Status:** üìù READY FOR DEVELOPMENT
**Priority:** üü¢ LOW
**Complexity:** Medium
**Time Estimate:** 4-6 hours
**Prerequisites:** Story 7.1 (database schema), Story 7.3 (JamSession UI)

**Note:** Optional for MVP - Supabase Realtime Channels work without database persistence.

---

## User Story

As a **session host**,
I want **my jam sessions saved to a database with full studio configuration**,
So that **I can resume sessions with the same tempo, key, modules, and settings**.

---

## Story Context

**Existing System Integration:**
- Integrates with: Supabase Postgres (Story 7.1 `sessions` table), SupabaseSessionService, GlobalMusicContext, Studio/useModuleManager
- Technology: Supabase database client, SQL queries, JSONB, TypeScript
- Follows pattern: Database persistence layer, CRUD operations, state serialization
- Touch points: Session creation, periodic state updates, session resume

**Why This Story is Optional:**
Supabase Realtime Channels work perfectly without database persistence - session state exists in memory only. This story adds optional persistence for:
- **Session History**: View/resume previous sessions
- **Studio Configuration**: Save loaded modules, active module, module settings
- **Music Settings**: Persist tempo, key, scale, color mode, master volume
- **Hardware Setup**: Remember MIDI/WLED device preferences
- **Analytics**: Track session duration, participant count, state changes

Not required for core functionality but greatly improves UX.

---

## Acceptance Criteria

### Functional Requirements

1. **Comprehensive Session State Interface**
   - Define full session state structure:
     ```typescript
     interface SessionState {
       // Music settings (from GlobalMusicContext)
       music: {
         tempo: number;                     // 40-300 BPM
         key: string;                       // e.g., 'C', 'D#', 'F'
         scale: string;                     // e.g., 'major', 'minor', 'dorian'
         colorMode: 'chromatic' | 'harmonic';
         masterVolume: number;              // 0-1
         isPlaying: boolean;                // Transport state
       };

       // Studio layout configuration
       studio: {
         loadedModules: LoadedModuleState[]; // All loaded modules
         activeModuleId: string | null;      // Currently visible module
       };

       // Hardware configuration
       hardware: {
         midi: {
           inputDevice: string | null;
           outputDevice: string | null;
           connected: boolean;
         };
         wled: {
           devices: WLEDDevice[];
           activeDeviceId: string | null;
         };
       };

       // Session metadata
       metadata: {
         sessionName?: string;              // Optional user-provided name
         hostUserId?: string;               // For future user accounts
         participantCount: number;
         totalStateChanges: number;
         durationMinutes: number;
       };
     }

     interface LoadedModuleState {
       instanceId: string;                  // e.g., 'piano-1'
       moduleId: string;                    // e.g., 'piano-roll'
       label: string;                       // e.g., 'Piano Roll'
       color: string;                       // Tailwind class
       settings?: Record<string, any>;      // Module-specific settings
     }
     ```

2. **Save Session on Creation**
   - When session created, insert into `sessions` table:
     ```typescript
     const initialState: SessionState = {
       music: {
         tempo: globalMusic.tempo,
         key: globalMusic.key,
         scale: globalMusic.scale,
         colorMode: globalMusic.colorMode,
         masterVolume: globalMusic.masterVolume,
         isPlaying: globalMusic.isPlaying,
       },
       studio: {
         loadedModules: modules.map(m => ({
           instanceId: m.instanceId,
           moduleId: m.moduleId,
           label: m.label,
           color: m.color,
           settings: m.settings,
         })),
         activeModuleId: activeModuleId,
       },
       hardware: globalMusic.hardware,
       metadata: {
         participantCount: 1,
         totalStateChanges: 0,
         durationMinutes: 0,
       },
     };

     await supabase.from('sessions').insert({
       id: roomCode,
       state: initialState
     });
     ```
   - Store full session state as JSONB

3. **Periodic State Updates**
   - Every 30 seconds, save current state to database:
     ```typescript
     setInterval(async () => {
       const currentState: SessionState = {
         music: {
           tempo: globalMusic.tempo,
           key: globalMusic.key,
           scale: globalMusic.scale,
           colorMode: globalMusic.colorMode,
           masterVolume: globalMusic.masterVolume,
           isPlaying: globalMusic.isPlaying,
         },
         studio: {
           loadedModules: modules.map(m => ({
             instanceId: m.instanceId,
             moduleId: m.moduleId,
             label: m.label,
             color: m.color,
             settings: m.settings,
           })),
           activeModuleId: activeModuleId,
         },
         hardware: globalMusic.hardware,
         metadata: {
           ...existingMetadata,
           totalStateChanges: existingMetadata.totalStateChanges + 1,
           durationMinutes: Math.floor((Date.now() - sessionStartTime) / 60000),
         },
       };

       await supabase.from('sessions').update({
         state: currentState
       }).eq('id', roomCode);
     }, 30000);
     ```
   - Debounce rapid updates (don't spam database)
   - Increment `totalStateChanges` counter
   - Update `durationMinutes` based on elapsed time

4. **Query Active Sessions (Optional Feature)**
   - Add method to fetch recent sessions:
     ```typescript
     async getRecentSessions(limit = 10): Promise<SessionRecord[]> {
       const { data } = await supabase
         .from('sessions')
         .select('*')
         .order('created_at', { ascending: false })
         .limit(limit);

       return data || [];
     }

     interface SessionRecord {
       id: string;                // Room code
       created_at: string;        // ISO timestamp
       state: SessionState;       // Full state JSONB
     }
     ```
   - Show "Recent Sessions" list on WelcomeScreen (optional UI)

5. **Resume Session with Full State Restoration**
   - Show "Resume Session" button for host's recent sessions
   - Clicking button:
     - **If session still active** (within 24 hours):
       - Rejoin same room code
       - Restore full studio layout (modules, active module)
       - Apply music settings (tempo, key, scale, etc.)
       - Reconnect hardware (MIDI/WLED devices if available)
     - **If session expired**:
       - Create new session with fresh room code
       - Apply saved state from old session
       - Mark as "Resumed from [old room code]"

   - Implementation:
     ```typescript
     async resumeSession(sessionId: string): Promise<void> {
       // Fetch session state
       const { data } = await supabase
         .from('sessions')
         .select('*')
         .eq('id', sessionId)
         .single();

       if (!data) {
         throw new Error('Session not found');
       }

       const state: SessionState = data.state;

       // Restore GlobalMusicContext
       globalMusic.updateTempo(state.music.tempo);
       globalMusic.updateKey(state.music.key);
       globalMusic.updateScale(state.music.scale);
       globalMusic.updateColorMode(state.music.colorMode);
       globalMusic.updateMasterVolume(state.music.masterVolume);
       globalMusic.updateTransportState(state.music.isPlaying);

       // Restore Studio layout
       const moduleManager = useModuleManager();
       state.studio.loadedModules.forEach(module => {
         moduleManager.addModule(module.moduleId, {
           instanceId: module.instanceId,
           label: module.label,
           color: module.color,
           settings: module.settings,
         });
       });
       if (state.studio.activeModuleId) {
         moduleManager.setActiveModule(state.studio.activeModuleId);
       }

       // Restore hardware configuration
       globalMusic.updateMidiInput(state.hardware.midi.inputDevice);
       globalMusic.updateMidiOutput(state.hardware.midi.outputDevice);
       globalMusic.updateWLEDDevices(state.hardware.wled.devices);
       globalMusic.updateActiveWLEDDevice(state.hardware.wled.activeDeviceId);

       console.log(`Session ${sessionId} restored successfully`);
     }
     ```

6. **Auto-Cleanup Old Sessions**
   - Supabase Edge Function or cron job:
     ```sql
     DELETE FROM sessions
     WHERE created_at < NOW() - INTERVAL '24 hours';
     ```
   - Run daily to prevent database bloat
   - Keep database size within free tier limits

7. **Session Analytics Tracking**
   - Already included in SessionState.metadata:
     - `participantCount`: Updated when users join/leave (via Presence)
     - `durationMinutes`: Updated every 30 seconds based on elapsed time
     - `totalStateChanges`: Incremented on each state update
     - `sessionName`: Optional user-provided name
     - `hostUserId`: For future user accounts
   - Use for future features:
     - Dashboard showing session statistics
     - Monetization insights (usage patterns)
     - Performance optimization (identify slow sessions)

### Integration Requirements

8. **SupabaseSessionService Database Methods**
   - Add methods:
     - `saveSession(roomCode: string, state: SessionState): Promise<void>`
     - `updateSessionState(roomCode: string, state: SessionState): Promise<void>`
     - `getRecentSessions(limit?: number): Promise<SessionRecord[]>`
     - `getSessionById(sessionId: string): Promise<SessionRecord | null>`
     - `resumeSession(sessionId: string): Promise<void>`
     - `deleteSession(roomCode: string): Promise<void>`

9. **GlobalMusicContext Integration**
   - Add method to export current state:
     ```typescript
     function exportMusicState(): MusicState {
       return {
         tempo,
         key,
         scale,
         colorMode,
         masterVolume,
         isPlaying,
       };
     }
     ```
   - Add method to import/apply state:
     ```typescript
     function importMusicState(state: MusicState): void {
       updateTempo(state.tempo);
       updateKey(state.key);
       updateScale(state.scale);
       updateColorMode(state.colorMode);
       updateMasterVolume(state.masterVolume);
       updateTransportState(state.isPlaying);
     }
     ```

10. **Studio/useModuleManager Integration**
    - Add method to export module layout:
      ```typescript
      function exportModuleLayout(): StudioState {
        return {
          loadedModules: modules.map(m => ({
            instanceId: m.instanceId,
            moduleId: m.moduleId,
            label: m.label,
            color: m.color,
            settings: m.settings,
          })),
          activeModuleId: activeModuleId,
        };
      }
      ```
    - Add method to import/apply layout:
      ```typescript
      function importModuleLayout(state: StudioState): void {
        // Clear existing modules
        clearAllModules();

        // Load saved modules
        state.loadedModules.forEach(module => {
          addModule(module.moduleId, {
            instanceId: module.instanceId,
            label: module.label,
            color: module.color,
            settings: module.settings,
          });
        });

        // Set active module
        if (state.activeModuleId) {
          setActiveModule(state.activeModuleId);
        }
      }
      ```

11. **Error Handling**
    - Database errors don't block session functionality
    - Log errors, but allow session to continue
    - Session works even if database write fails
    - State restoration errors show user-friendly messages:
      - "Failed to restore session. Starting with default configuration."
      - "Some modules could not be loaded. Check console for details."

12. **Performance Considerations**
    - Debounce state updates (30-second intervals)
    - Use upsert for idempotency:
      ```typescript
      await supabase.from('sessions').upsert({
        id: roomCode,
        state: currentState
      });
      ```
    - Serialize only necessary data (exclude ephemeral state)
    - JSONB compression reduces storage footprint

### Quality Requirements

13. **No Impact on Real-Time Features**
    - Database writes are async (don't block UI)
    - Session functionality works without persistence
    - Database errors handled gracefully
    - State restoration happens in background

14. **Data Privacy**
    - No personal information stored (usernames ephemeral)
    - Session data auto-deleted after 24 hours
    - Hardware device IPs/names stored but not shared publicly
    - Future: GDPR compliance for user accounts

15. **Database Efficiency**
    - JSONB used for flexible state storage
    - Indexes on `created_at` for cleanup queries
    - Minimal storage footprint (~5KB per session)
    - Estimated sessions: 500MB free tier / 5KB = ~100,000 sessions
    - With 24-hour retention: ~4,000 concurrent sessions supported

---

## Technical Notes

**Integration Approach:**
- Database writes are optional (service layer handles failures)
- JSONB column stores arbitrary session state
- Auto-cleanup keeps database size manageable

**Existing Pattern Reference:**
- Database operations similar to existing Postgres patterns
- Service layer pattern consistent with other services

**Key Constraints:**
- Must stay within Supabase free tier (500MB database)
- No database migrations required (table created in Story 7.1)
- Sessions are ephemeral (24-hour retention)

**Database Schema (from Story 7.1):**
```sql
CREATE TABLE sessions (
  id TEXT PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  state JSONB DEFAULT '{}'::jsonb
);
```

---

## Definition of Done

- [ ] SessionState interface defined (music, studio, hardware, metadata)
- [ ] Save full session state to database on creation
- [ ] Update session state periodically (30s intervals)
- [ ] GlobalMusicContext export/import methods implemented
- [ ] useModuleManager export/import methods implemented
- [ ] Query recent sessions implemented
- [ ] Resume session with full state restoration implemented
- [ ] Auto-cleanup old sessions (Edge Function or cron)
- [ ] Error handling for database failures
- [ ] Error handling for state restoration failures
- [ ] Database writes don't block real-time features
- [ ] Manual testing completed (see Testing Strategy)

---

## Testing Strategy

### Manual Testing (Per CLAUDE.md Guidelines)

**Test 1: Comprehensive Session Persistence**
1. Create session with:
   - Tempo: 140 BPM
   - Key: D minor
   - Color mode: harmonic
   - Master volume: 0.8
   - Loaded modules: Piano Roll, Guitar Fretboard
   - Active module: Guitar Fretboard
   - MIDI input: "MIDI Keyboard"
   - WLED device: "Studio Lights" (192.168.1.100)
2. Query database:
   ```sql
   SELECT * FROM sessions WHERE id = 'ABC123';
   ```
3. Verify:
   - ‚úÖ Session exists in database
   - ‚úÖ Music state saved: `{ tempo: 140, key: 'D', scale: 'minor', colorMode: 'harmonic', masterVolume: 0.8 }`
   - ‚úÖ Studio state saved: `{ loadedModules: [...], activeModuleId: 'guitar-1' }`
   - ‚úÖ Hardware state saved: `{ midi: { inputDevice: 'MIDI Keyboard' }, wled: {...} }`
   - ‚úÖ Metadata saved: `{ participantCount: 1, totalStateChanges: 0, durationMinutes: 0 }`

**Test 2: Periodic State Updates**
1. In session, perform actions:
   - Change tempo to 160
   - Add Isometric Sequencer module
   - Switch active module to Piano Roll
   - Adjust master volume to 0.9
2. Wait 30 seconds
3. Query database:
   ```sql
   SELECT state FROM sessions WHERE id = 'ABC123';
   ```
4. Verify:
   - ‚úÖ Music state updated: `{ tempo: 160, masterVolume: 0.9 }`
   - ‚úÖ Studio state updated: `{ loadedModules: [Piano, Guitar, Isometric], activeModuleId: 'piano-1' }`
   - ‚úÖ Metadata updated: `{ totalStateChanges: 1, durationMinutes: 1 }`

**Test 3: Session Resume with Full State Restoration**
1. Create session "ABC123" with custom configuration (as in Test 1)
2. Leave session
3. Navigate to WelcomeScreen ‚Üí "Recent Sessions"
4. Click "Resume" on session "ABC123"
5. Verify:
   - ‚úÖ Tempo restored to 140 BPM
   - ‚úÖ Key/scale restored to D minor
   - ‚úÖ Color mode restored to harmonic
   - ‚úÖ Master volume restored to 0.8
   - ‚úÖ Piano Roll and Guitar Fretboard modules loaded
   - ‚úÖ Guitar Fretboard is active module
   - ‚úÖ MIDI input shows "MIDI Keyboard" (if device available)
   - ‚úÖ WLED device "Studio Lights" reconnected (if available)

**Test 4: Recent Sessions Query**
1. Create 3 sessions over 5 minutes with different configurations
2. Call `getRecentSessions()`
3. Verify:
   - ‚úÖ Returns 3 sessions
   - ‚úÖ Ordered by `created_at` (newest first)
   - ‚úÖ Each session includes full state JSONB

**Test 5: Auto-Cleanup**
1. Insert old session:
   ```sql
   INSERT INTO sessions (id, created_at, state)
   VALUES ('OLD123', NOW() - INTERVAL '25 hours', '{}');
   ```
2. Run cleanup function
3. Verify:
   - ‚úÖ Old session deleted
   - ‚úÖ Recent sessions remain

**Test 6: Database Error Handling**
1. Disconnect from database (simulate network error)
2. Create session
3. Verify:
   - ‚úÖ Session creates successfully (Channels work)
   - ‚úÖ Database error logged (doesn't block)
   - ‚úÖ Real-time features unaffected
   - ‚úÖ No user-visible errors

**Test 7: State Restoration Error Handling**
1. Manually corrupt session state in database:
   ```sql
   UPDATE sessions SET state = '{"invalid": true}' WHERE id = 'ABC123';
   ```
2. Attempt to resume session "ABC123"
3. Verify:
   - ‚úÖ User-friendly error: "Failed to restore session. Starting with default configuration."
   - ‚úÖ Session creates with default state
   - ‚úÖ No crashes or console errors

**Test 8: Module Settings Persistence**
1. Create session with Piano Roll module
2. Configure Piano Roll settings:
   - Grid size: 64 steps
   - Note range: C2-C7
   - Velocity: 0.9
3. Wait 30 seconds (state update)
4. Leave and rejoin session
5. Verify:
   - ‚úÖ Piano Roll settings restored correctly
   - ‚úÖ Grid size, note range, velocity match saved values

### Verification Checklist

- ‚úÖ Sessions saved to database on creation with full state
- ‚úÖ Music settings (tempo, key, scale, etc.) persist correctly
- ‚úÖ Studio layout (modules, active module) persists correctly
- ‚úÖ Hardware configuration (MIDI/WLED) persists correctly
- ‚úÖ Module-specific settings persist correctly
- ‚úÖ Session state updates persist every 30 seconds
- ‚úÖ Resume session restores full configuration
- ‚úÖ Recent sessions query works correctly
- ‚úÖ Old sessions auto-deleted after 24 hours
- ‚úÖ No performance impact on real-time features
- ‚úÖ Database errors handled gracefully
- ‚úÖ State restoration errors handled gracefully

---

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** Database writes slow down session creation
**Mitigation:**
- Async database writes (don't block UI)
- Session works via Channels even if database fails
- Debounce updates to reduce write frequency

**Secondary Risk:** Database bloat (hitting 500MB free tier limit)
**Mitigation:**
- Auto-cleanup deletes old sessions (24-hour retention)
- Monitor database size via Supabase dashboard
- JSONB is efficient (minimal storage per session)

### Compatibility Verification

- [x] **No breaking changes** - Additive feature (optional persistence)
- [x] **Database changes** - Uses existing `sessions` table (Story 7.1)
- [x] **UI changes** - None (optional "Recent Sessions" UI in future)
- [x] **Performance impact** - Negligible (async writes)

---

## Scope Validation

- [x] Story can be completed in **4-6 hours** (one focused session)
- [x] Integration approach is clear (JSONB state serialization)
- [x] Follows existing patterns (database CRUD, state export/import)
- [x] Adds significant UX value (session resume, configuration persistence)
- [x] Optional for MVP (can be skipped if time constrained)

---

## Deliverables

1. **SessionState Interface**
   - `src/types/sessionState.ts` (~80 lines)
   - Comprehensive session state structure

2. **Updated SupabaseSessionService**
   - `src/services/supabaseSession.ts` (modified, ~150 lines added)
   - Database persistence methods
   - Session save/update/query/resume methods

3. **Updated GlobalMusicContext**
   - `src/contexts/GlobalMusicContext.tsx` (modified, ~40 lines added)
   - `exportMusicState()` method
   - `importMusicState(state)` method

4. **Updated useModuleManager**
   - `src/components/Studio/useModuleManager.ts` (modified, ~80 lines added)
   - `exportModuleLayout()` method
   - `importModuleLayout(state)` method
   - `clearAllModules()` method

5. **Recent Sessions UI (Optional)**
   - `src/components/Welcome/RecentSessions.tsx` (~120 lines)
   - List of recent sessions with resume buttons
   - Session metadata display (tempo, modules, duration)

6. **Cleanup Script or Edge Function**
   - `supabase/functions/cleanup-sessions/index.ts` (~40 lines)
   - Delete sessions older than 24 hours
   - Can be triggered via cron job or manual invocation

---

## Next Steps After Story 7.9

Once this story is complete:
- **Epic 7 is COMPLETE! üéâ**
- Proceed to user testing and feedback
- Plan future enhancements (Epic 7 Phase 2)

---

## References

- **Epic 7:** `docs/epics/epic-7-jam-session-backend.md`
- **Story 7.1:** `docs/stories/7.1-supabase-setup.md`
- **Supabase Database Docs:** https://supabase.com/docs/guides/database

---

**Story Created:** 2025-10-13
**Story Updated:** 2025-10-13 (expanded to include comprehensive state persistence)
**Story Owner:** Product Manager (John)
**Estimated Completion:** 4-6 hours after start
