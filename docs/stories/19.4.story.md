# Story 19.4: Melody & Harmony Education Lesson

**Epic:** Education Mode DJ Visualizer Integration (Epic 19)
**Status:** Draft
**Priority:** Medium (Extension Story)
**Complexity:** High
**Prerequisites:** Stories 19.1, 19.2, 19.3 complete

---

## Story

**As a** student who has completed rhythm lessons (1-3),
**I want** to learn about melody and harmony using an interactive piano keyboard with real-time visualization,
**so that** I can understand how musical notes create frequencies and how melodies progress over time.

---

## Background / Context

### Current State
- ✅ **Stories 19.1-19.3 complete** - LiveAudioVisualizer embedded mode working in lesson 2
- ✅ **PianoRoll component exists** - Full-featured piano visualizer with 88 keys
- ✅ **audioEngine.playPianoNote()** - Piano note playback available
- ✅ **FrequencySourceManager** - Captures audio for real-time visualization
- ✅ **Three visualization modes** - Spectrum, waveform, ripple all functional
- ❌ **No melody/harmony lesson** - Education Mode only covers rhythm (lessons 1-3)
- ❌ **No piano integration in Education Mode** - PianoRoll is standalone only

### Why Lesson 4 is Needed
**Completes the Learning Arc:**
1. **Lesson 1-3:** Rhythm (drums, patterns, timing)
2. **Lesson 4:** Melody & Harmony (notes, scales, chords) ← NEW

**Pedagogical Value:**
- Students transition from percussion to pitched instruments
- Learn frequency relationships (low notes vs high notes)
- Understand melodic contour (how melodies move up and down)
- See harmonic relationships (multiple notes sounding together)
- Apply visualization knowledge from lesson 2 in new context

**Target Audience:**
- Students who completed lessons 1-3
- Ages 8+ (understanding of pitch concepts)
- No prior piano experience required

[Source: Epic 19 extension discussion, educational progression principles]

---

## Student Experience (What They Will See and Do)

### Step 4.1: Notes Make Frequencies
**Student Journey:**
1. Enters lesson 4 "Melody & Harmony"
2. Sees simplified piano keyboard (1 octave, C-C, white keys only)
3. Sees **Spectrum visualization** in embedded mode (from Story 19.1)
4. Instruction: "Click on piano keys to hear notes and see their frequencies"
5. Clicks **C (low)** → Left side of spectrum **glows RED** (low frequency ~262 Hz)
6. Clicks **E (middle)** → Middle of spectrum **glows YELLOW** (mid frequency ~330 Hz)
7. Clicks **G (higher)** → Right side of spectrum **glows GREEN** (higher frequency ~392 Hz)
8. Clicks **C (high octave)** → Spectrum shows frequency **twice as high** as low C
9. **Discovery:** "Higher notes = higher frequencies = further right in spectrum!"
10. Challenge: "Play the lowest note (C) and the highest note (C) to see the octave relationship"
11. Auto-advances after playing both Cs

**Pedagogical Goal:** Understand notes as specific frequencies
**Visualization:** **SPECTRUM mode** - Shows each note as a distinct frequency peak

### Step 4.2: Scales Move Up and Down
**Student Journey:**
1. Instruction: "Play the C major scale (C-D-E-F-G-A-B-C) and watch it climb!"
2. Visualization switches to **WAVEFORM mode** automatically
3. Student plays C → D → E → F → G → A → B → C (ascending scale)
4. **Waveform shows:** Each note has faster oscillations than the last (pitch rising)
5. Instruction: "Now play it backwards (C-B-A-G-F-E-D-C) and watch it descend!"
6. Student plays descending scale
7. **Waveform shows:** Progressively slower oscillations (pitch falling)
8. **Discovery:** "Melodies are frequencies changing over time!"
9. Challenge: "Play any pattern of notes and create your own melody"
10. Auto-advances after playing 8+ notes in sequence

**Pedagogical Goal:** Melody as frequency progression over time
**Visualization:** **WAVEFORM mode** - Shows pitch changes as waveform frequency changes

### Step 4.3: Chords Make Harmonies
**Student Journey:**
1. Instruction: "Now click THREE keys at the same time to make a chord!"
2. Visualization back to **SPECTRUM mode**
3. Student clicks C + E + G together (C major chord)
4. **Spectrum shows:** THREE distinct peaks (fundamental frequencies of each note)
5. Instruction: "Try different combinations and see how many peaks appear!"
6. Student experiments:
   - C alone → 1 peak
   - C + E → 2 peaks
   - C + E + G → 3 peaks
   - C + D (dissonant interval) → 2 peaks close together (clashing colors)
7. **Discovery:** "Chords are multiple frequencies sounding together!"
8. Optional: "Play C-E-G (sounds nice!) vs C-D (sounds weird!)" - Introduce consonance vs dissonance
9. Lesson completes after playing a 3-note chord

**Pedagogical Goal:** Harmonic relationships (multiple simultaneous frequencies)
**Visualization:** **SPECTRUM mode** - Shows multiple peaks for each note in chord

---

## Acceptance Criteria

### AC 1: Lesson 4 Added to Lesson Selection Screen
- [ ] New lesson card appears in Education Mode lesson selection grid
- [ ] Title: "Melody & Harmony"
- [ ] Description: "Learn about musical notes, scales, and chords"
- [ ] Difficulty badge: "Intermediate" (yellow badge)
- [ ] Displays "3 steps" count
- [ ] Positioned after lesson 3 (Rhythm Patterns)

### AC 2: Simplified Piano Keyboard UI
- [ ] Render 1 octave piano keyboard (C4 to C5, 8 white keys)
- [ ] White keys only (no black keys for simplicity)
- [ ] Each key displays note name (C, D, E, F, G, A, B, C)
- [ ] Keys are touch-friendly (min 44px height on mobile)
- [ ] Keyboard uses Tailwind CSS styling consistent with Education Mode
- [ ] Responsive layout (stacks on mobile, side-by-side on desktop)

### AC 3: Piano Note Playback Integration
- [ ] Clicking a piano key triggers `audioEngine.playPianoNote(midiNote, 0.8, '4n')`
- [ ] MIDI note numbers mapped correctly (C4=60, D4=62, E4=64, F4=65, G4=67, A4=69, B4=71, C5=72)
- [ ] Sound plays immediately (<50ms latency)
- [ ] Multiple keys can be clicked simultaneously for chords
- [ ] Visual feedback on key press (key changes color/brightness briefly)

### AC 4: FrequencySourceManager Integration
- [ ] Piano notes feed into `window.frequencySourceManager` for visualization
- [ ] LiveAudioVisualizer reacts to piano notes in real-time
- [ ] Spectrum mode shows distinct frequency peaks for each note
- [ ] Waveform mode shows pitch changes during scale playing
- [ ] No lag between note play and visualization update

### AC 5: Step 4.1 - Notes Make Frequencies
- [ ] Instruction text: "Click on piano keys to hear notes and see their frequencies"
- [ ] Hint text: "Notice how higher notes move further to the right in the spectrum"
- [ ] LiveAudioVisualizer set to SPECTRUM mode
- [ ] Auto-advance after student plays low C (60) and high C (72)
- [ ] Progress tracked via state (notes played array)

### AC 6: Step 4.2 - Scales Move Up and Down
- [ ] Instruction text: "Play the C major scale (C-D-E-F-G-A-B-C) and watch it climb!"
- [ ] Hint text: "Each note is a higher frequency than the last - see the waveform speed up!"
- [ ] LiveAudioVisualizer switches to WAVEFORM mode automatically
- [ ] Auto-advance after student plays 8+ notes in sequence
- [ ] No specific scale pattern required (any 8 notes counts)

### AC 7: Step 4.3 - Chords Make Harmonies
- [ ] Instruction text: "Click THREE keys at the same time to make a chord!"
- [ ] Hint text: "Try C+E+G for a happy sound, or C+D for a clashing sound!"
- [ ] LiveAudioVisualizer set to SPECTRUM mode
- [ ] Auto-advance after student plays 3 simultaneous notes
- [ ] Detect simultaneous clicks (within 200ms window = "chord")

### AC 8: Lesson Completion Logic
- [ ] Step progression (4.1 → 4.2 → 4.3) works correctly
- [ ] Progress bar updates for each step (33%, 66%, 100%)
- [ ] Completing step 4.3 returns to lesson selection screen
- [ ] Lesson 4 marked as completed (visual indicator)
- [ ] State tracking uses same patterns as lessons 1-3

### AC 9: Existing Lessons Unaffected
- [ ] Lessons 1, 2, 3 work exactly as before
- [ ] Navigation between all 4 lessons works
- [ ] Exit Education button works from lesson 4
- [ ] No console errors when navigating between lessons
- [ ] No regression in lesson 2 LiveAudioVisualizer integration

---

## Tasks / Subtasks

### Task 1: Define Lesson 4 Structure (AC: 1, 8)
- [ ] Add lesson 4 to `lessons` array in EducationMode.tsx
  ```typescript
  {
    id: '4',
    title: 'Melody & Harmony',
    description: 'Learn about musical notes, scales, and chords',
    difficulty: 'intermediate',
    steps: [
      {
        id: '4-1',
        instruction: 'Click on piano keys to hear notes and see their frequencies',
        hint: 'Notice how higher notes move further to the right in the spectrum',
        completed: false
      },
      {
        id: '4-2',
        instruction: 'Play the C major scale (C-D-E-F-G-A-B-C) and watch it climb!',
        hint: 'Each note is a higher frequency than the last - see the waveform speed up!',
        completed: false
      },
      {
        id: '4-3',
        instruction: 'Click THREE keys at the same time to make a chord!',
        hint: 'Try C+E+G for a happy sound, or C+D for a clashing sound!',
        completed: false
      }
    ]
  }
  ```
- [ ] Add state variable for notes played tracking: `const [notesPlayed, setNotesPlayed] = useState<number[]>([])`
- [ ] Add state variable for chord detection: `const [recentNotes, setRecentNotes] = useState<{note: number, timestamp: number}[]>([])`

### Task 2: Create Simplified Piano Keyboard Component (AC: 2, 3)
- [ ] Create inline component or extract to `<SimplePianoKeyboard />`
- [ ] Define piano key layout:
  ```typescript
  const pianoKeys = [
    { note: 60, name: 'C', color: 'white' },
    { note: 62, name: 'D', color: 'white' },
    { note: 64, name: 'E', color: 'white' },
    { note: 65, name: 'F', color: 'white' },
    { note: 67, name: 'G', color: 'white' },
    { note: 69, name: 'A', color: 'white' },
    { note: 71, name: 'B', color: 'white' },
    { note: 72, name: 'C', color: 'white' } // High octave C
  ];
  ```
- [ ] Render keys with click handlers:
  ```tsx
  <div className="flex gap-1 justify-center">
    {pianoKeys.map(key => (
      <button
        key={key.note}
        onClick={() => playPianoKey(key.note, key.name)}
        className="flex-1 bg-white border-2 border-gray-800 rounded-lg p-4 sm:p-6
                   hover:bg-gray-100 active:bg-gray-300 transition-colors touch-target
                   flex flex-col items-center justify-end"
      >
        <span className="text-gray-900 font-bold text-sm sm:text-base">{key.name}</span>
      </button>
    ))}
  </div>
  ```
- [ ] Ensure responsive design (vertical stack on mobile if needed)

### Task 3: Implement Piano Note Playback (AC: 3, 4)
- [ ] Create `playPianoKey` function:
  ```typescript
  const playPianoKey = (midiNote: number, noteName: string) => {
    // Play the sound via audioEngine
    audioEngine.playPianoNote(midiNote, 0.8, '4n');

    // Track note for progression logic
    setNotesPlayed(prev => [...prev, midiNote]);

    // Track recent notes for chord detection (with timestamp)
    setRecentNotes(prev => [...prev, { note: midiNote, timestamp: Date.now() }]);

    // Send to FrequencySourceManager for visualization
    const sourceManager = (window as any).frequencySourceManager;
    if (sourceManager && sourceManager.addMidiNote) {
      sourceManager.addMidiNote(midiNote, 0.8);
    }

    console.log(`[Lesson 4] Played ${noteName} (MIDI ${midiNote})`);
  };
  ```
- [ ] Verify audioEngine.playPianoNote() is available (may need to initialize piano synth)
- [ ] Test note playback with different MIDI numbers

### Task 4: Implement Step 4.1 Logic (AC: 5)
- [ ] Check if lesson 4, step 0 (4.1) is active
- [ ] Display spectrum visualization (vizMode = 'spectrum')
- [ ] Show piano keyboard
- [ ] Auto-advance logic:
  ```typescript
  useEffect(() => {
    if (selectedLesson?.id === '4' && currentStepIndex === 0) {
      const hasLowC = notesPlayed.includes(60);
      const hasHighC = notesPlayed.includes(72);

      if (hasLowC && hasHighC) {
        setTimeout(() => {
          setCurrentStepIndex(1);
          setNotesPlayed([]); // Reset for next step
        }, 1500);
      }
    }
  }, [notesPlayed, selectedLesson, currentStepIndex]);
  ```

### Task 5: Implement Step 4.2 Logic (AC: 6)
- [ ] Check if lesson 4, step 1 (4.2) is active
- [ ] Switch visualization to waveform mode: `setVizMode('waveform')`
- [ ] Show piano keyboard
- [ ] Auto-advance logic:
  ```typescript
  useEffect(() => {
    if (selectedLesson?.id === '4' && currentStepIndex === 1) {
      if (notesPlayed.length >= 8) {
        setTimeout(() => {
          setCurrentStepIndex(2);
          setNotesPlayed([]);
          setRecentNotes([]);
        }, 1500);
      }
    }
  }, [notesPlayed, selectedLesson, currentStepIndex]);
  ```

### Task 6: Implement Step 4.3 Logic (AC: 7)
- [ ] Check if lesson 4, step 2 (4.3) is active
- [ ] Switch visualization back to spectrum mode: `setVizMode('spectrum')`
- [ ] Show piano keyboard
- [ ] Implement chord detection:
  ```typescript
  const detectChord = () => {
    const now = Date.now();
    const recentWindow = 200; // ms
    const withinWindow = recentNotes.filter(n => now - n.timestamp < recentWindow);
    return withinWindow.length >= 3;
  };
  ```
- [ ] Auto-advance logic:
  ```typescript
  useEffect(() => {
    if (selectedLesson?.id === '4' && currentStepIndex === 2) {
      if (detectChord()) {
        setTimeout(() => {
          // Complete lesson
          setSelectedLesson(null);
          setCurrentStepIndex(0);
          setNotesPlayed([]);
          setRecentNotes([]);
        }, 1500);
      }
    }
  }, [recentNotes, selectedLesson, currentStepIndex]);
  ```
- [ ] Clean up old notes from recentNotes array periodically

### Task 7: Integrate LiveAudioVisualizer into Lesson 4 (AC: 4)
- [ ] Render LiveAudioVisualizer in lesson 4 JSX (same as lesson 2):
  ```tsx
  {selectedLesson?.id === '4' && (
    <div className="mb-6">
      <LiveAudioVisualizer
        embedded={true}
        currentMode={vizMode}
        className="h-64 sm:h-80"
      />
    </div>
  )}
  ```
- [ ] Control `vizMode` state based on current step (4.1=spectrum, 4.2=waveform, 4.3=spectrum)
- [ ] Verify visualizer responds to piano notes

### Task 8: Add Lesson 4 UI Layout (AC: 2, 8)
- [ ] Create lesson 4 container following existing lesson patterns
- [ ] Add instruction card with step text and hint
- [ ] Add piano keyboard component
- [ ] Add progress bar (same as lessons 1-3)
- [ ] Add "Back to Lessons" button
- [ ] Ensure responsive layout (mobile/tablet/desktop)

### Task 9: Test Lesson Progression (AC: 8, 9)
- [ ] Complete lesson 4 step 4.1 (play low C and high C)
- [ ] Verify auto-advance to step 4.2
- [ ] Complete lesson 4 step 4.2 (play 8+ notes)
- [ ] Verify auto-advance to step 4.3
- [ ] Complete lesson 4 step 4.3 (play 3-note chord)
- [ ] Verify return to lesson selection screen
- [ ] Test navigation back to lessons 1, 2, 3 from lesson 4
- [ ] Verify no console errors during navigation

### Task 10: Manual Testing - Full Lesson 4 Flow (AC: 1-9)
- [ ] Start Education Mode
- [ ] Verify lesson 4 card appears in lesson selection
- [ ] Click lesson 4 to start
- [ ] **Step 4.1:** Play individual piano keys, observe spectrum
- [ ] Verify spectrum shows frequency peaks
- [ ] Play low C (60) and high C (72) to trigger auto-advance
- [ ] **Step 4.2:** Play ascending scale (C-D-E-F-G-A-B-C)
- [ ] Verify waveform visualization shows pitch progression
- [ ] Verify auto-advance after 8 notes
- [ ] **Step 4.3:** Click C+E+G simultaneously for chord
- [ ] Verify spectrum shows 3 distinct peaks
- [ ] Verify lesson completes and returns to selection
- [ ] Document results in Dev Agent Record

### Task 11: Regression Testing - Lessons 1-3 (AC: 9)
- [ ] Navigate to lesson 1 and complete it
- [ ] Navigate to lesson 2 and verify LiveAudioVisualizer works
- [ ] Navigate to lesson 3 and complete it
- [ ] Verify no breaking changes from lesson 4 addition
- [ ] Check console for errors
- [ ] Document regression results

---

## Dev Notes

### Current EducationMode Component Structure
**File:** `src/components/Education/EducationMode.tsx`

**State Variables to Add:**
```typescript
const [notesPlayed, setNotesPlayed] = useState<number[]>([]); // Track notes for progression
const [recentNotes, setRecentNotes] = useState<{note: number, timestamp: number}[]>([]); // For chord detection
const [vizMode, setVizMode] = useState<VisualizationMode>('spectrum'); // Control visualization mode
```

**Lessons Array Location:** Lines 43-101
**Add lesson 4 after lesson 3**

[Source: src/components/Education/EducationMode.tsx:13-29, 43-101]

### Piano Note Playback (audioEngine)
**File:** `src/utils/audioEngine.ts`

**Available Methods:**
```typescript
// Play a note with duration (for scales, melodies)
audioEngine.playPianoNote(midiNote: number, velocity: number, duration: string): void

// Trigger note on (for sustained notes, chords)
audioEngine.triggerPianoNoteOn(midiNote: number, velocity: number): void

// Trigger note off (release sustained notes)
audioEngine.triggerPianoNoteOff(midiNote: number): void
```

**Usage Pattern:**
```typescript
// Single note
audioEngine.playPianoNote(60, 0.8, '4n'); // C4, medium velocity, quarter note

// Chord (simultaneous notes)
audioEngine.triggerPianoNoteOn(60, 0.8); // C
audioEngine.triggerPianoNoteOn(64, 0.8); // E
audioEngine.triggerPianoNoteOn(67, 0.8); // G
// ... later release
audioEngine.triggerPianoNoteOff(60);
audioEngine.triggerPianoNoteOff(64);
audioEngine.triggerPianoNoteOff(67);
```

**Note:** Use `playPianoNote()` for simplicity in Education Mode (auto-releases after duration)

[Source: src/utils/audioEngine.ts:254-271, 276-307]

### MIDI Note Numbers
**C Major Scale (One Octave):**
- C4 (middle C) = 60
- D4 = 62
- E4 = 64
- F4 = 65
- G4 = 67
- A4 = 69
- B4 = 71
- C5 = 72

**Note Frequency Relationships:**
- Octave = 2x frequency (C4=~262Hz, C5=~524Hz)
- Each semitone = ~1.059x frequency increase

[Source: Music theory, MIDI standard]

### FrequencySourceManager Integration
**Global Exposure:**
`window.frequencySourceManager` - Exposed by LiveAudioVisualizer

**Integration Pattern:**
```typescript
const playPianoKey = (midiNote: number) => {
  // Play sound
  audioEngine.playPianoNote(midiNote, 0.8, '4n');

  // Send to visualizer
  const sourceManager = (window as any).frequencySourceManager;
  if (sourceManager && sourceManager.addMidiNote) {
    sourceManager.addMidiNote(midiNote, 0.8);
  }
};
```

**Note:** FrequencySourceManager may already auto-capture audio from audioEngine. Test to confirm if manual integration needed.

[Source: src/components/LiveAudioVisualizer/LiveAudioVisualizer.tsx:68, Story 19.2 Dev Notes]

### LiveAudioVisualizer Props (from Story 19.1)
**Expected Props:**
```typescript
<LiveAudioVisualizer
  embedded={true}
  currentMode={vizMode} // 'spectrum' | 'waveform' | 'ripple'
  className="h-64 sm:h-80"
/>
```

**Controlling Visualization Mode:**
```typescript
const [vizMode, setVizMode] = useState<VisualizationMode>('spectrum');

// In useEffect for step changes
useEffect(() => {
  if (selectedLesson?.id === '4') {
    if (currentStepIndex === 0) setVizMode('spectrum'); // Step 4.1
    if (currentStepIndex === 1) setVizMode('waveform'); // Step 4.2
    if (currentStepIndex === 2) setVizMode('spectrum'); // Step 4.3
  }
}, [selectedLesson, currentStepIndex]);
```

[Source: Story 19.1 Dev Notes, Story 19.2 integration patterns]

### Chord Detection Logic
**Simultaneous Note Detection:**
```typescript
// Track notes with timestamps
const [recentNotes, setRecentNotes] = useState<{note: number, timestamp: number}[]>([]);

const playPianoKey = (midiNote: number) => {
  // ... play sound ...

  // Add to recent notes
  setRecentNotes(prev => [...prev, { note: midiNote, timestamp: Date.now() }]);
};

// Detect chord (3+ notes within 200ms)
const detectChord = () => {
  const now = Date.now();
  const window = 200; // ms
  const recentWindow = recentNotes.filter(n => now - n.timestamp < window);
  return recentWindow.length >= 3;
};

// Clean up old notes (prevent memory bloat)
useEffect(() => {
  const interval = setInterval(() => {
    const now = Date.now();
    setRecentNotes(prev => prev.filter(n => now - n.timestamp < 1000));
  }, 500);
  return () => clearInterval(interval);
}, []);
```

[Source: Common chord detection patterns, performance best practices]

### Responsive Piano Keyboard Layout
**Tailwind Responsive Patterns:**
```tsx
{/* Mobile: Vertical stack, Desktop: Horizontal row */}
<div className="flex flex-col sm:flex-row gap-1 sm:gap-2">
  {pianoKeys.map(key => (
    <button
      className="flex-1 bg-white border-2 border-gray-800 rounded-lg
                 p-4 sm:p-6 hover:bg-gray-100 active:bg-gray-300
                 transition-colors touch-target min-h-[44px]"
    >
      <span className="text-gray-900 font-bold text-sm sm:text-base">
        {key.name}
      </span>
    </button>
  ))}
</div>
```

**Touch Target Minimum:** 44px (iOS guideline)

[Source: CLAUDE.md#responsive-design, Tailwind CSS responsive patterns]

### File Locations
- **Component to modify:** `src/components/Education/EducationMode.tsx`
- **Component to reference:** `src/components/LiveAudioVisualizer/LiveAudioVisualizer.tsx`
- **Audio engine:** `src/utils/audioEngine.ts`
- **Frequency manager:** `src/utils/frequencySourceManager.ts`
- **Types:** `src/components/LiveAudioVisualizer/VisualizationEngine.ts` (VisualizationMode)

[Source: docs/architecture/source-tree.md]

### Technology Stack
- **React:** 18.2.0 (functional components with hooks)
- **TypeScript:** 5.2.2 (strict mode)
- **Audio:** Tone.js 15.1.22 (via audioEngine)
- **Styling:** Tailwind CSS
- **Icons:** Lucide React (if needed)

[Source: docs/architecture/tech-stack.md]

---

## Testing

### Manual Testing Strategy
**This project uses manual testing with browser DevTools, NOT automated test suites.**

[Source: CLAUDE.md#project-scale--testing-philosophy]

### Verification Checklist (Browser Testing)

**Pre-Implementation Baseline:**
1. Open Education Mode and verify lessons 1-3 work
2. Take screenshots of lesson selection screen (current 3 lessons)
3. Document current navigation flow

**Post-Implementation - Lesson 4 Step 4.1:**
1. Navigate to Education Mode → Lesson 4
2. Verify lesson card shows "Melody & Harmony" with "Intermediate" badge
3. Click lesson 4 to start
4. **Observe:** Simplified piano keyboard (8 white keys: C-D-E-F-G-A-B-C)
5. **Observe:** LiveAudioVisualizer in spectrum mode
6. Click **C (leftmost key)**
7. **Verify:** Sound plays, spectrum shows low frequency peak (left side, red)
8. Click **C (rightmost key, high octave)**
9. **Verify:** Sound plays, spectrum shows high frequency peak (right side, violet)
10. **Verify:** Auto-advance to step 4.2 after 1-2 seconds

**Post-Implementation - Lesson 4 Step 4.2:**
1. **Observe:** Visualization switches to waveform mode
2. **Observe:** Instruction: "Play the C major scale..."
3. Click piano keys in sequence: C → D → E → F → G → A → B → C
4. **Verify:** Waveform shows progressively faster oscillations (rising pitch)
5. Click random 8+ notes
6. **Verify:** Auto-advance to step 4.3

**Post-Implementation - Lesson 4 Step 4.3:**
1. **Observe:** Visualization back to spectrum mode
2. **Observe:** Instruction: "Click THREE keys at the same time..."
3. Click C, E, G simultaneously (or within 200ms)
4. **Verify:** Spectrum shows 3 distinct frequency peaks
5. **Verify:** Sound of chord plays (harmonious C major sound)
6. **Verify:** Lesson completes and returns to lesson selection
7. **Verify:** Lesson 4 has completion indicator (checkmark or similar)

**Regression Testing - Lessons 1-3:**
1. From lesson selection, click lesson 1
2. Complete lesson 1 flow (pattern creation, playback)
3. Return to lesson selection
4. Click lesson 2
5. Verify LiveAudioVisualizer still works with drums
6. Verify visualization mode switching still works
7. Return to lesson selection
8. Click lesson 3
9. Complete lesson 3 flow (kick + snare patterns)
10. **Verify:** No console errors throughout all lessons
11. **Verify:** Navigation between all 4 lessons works

**Responsive Testing:**
1. Open DevTools → Device Toolbar
2. Test mobile (375px width):
   - Piano keyboard fits screen
   - Keys are touch-friendly (44px+ height)
   - Text readable
   - No horizontal scrolling
3. Test tablet (768px width):
   - Piano keyboard uses optimal spacing
   - Visualizer has good aspect ratio
4. Test desktop (1280px width):
   - Piano keyboard horizontal layout
   - Spacious, professional appearance

**Audio Integration Testing:**
1. Open Console tab
2. Play piano key C
3. **Verify console log:** `[AudioEngine] Piano note: C4 (MIDI 60), velocity: 0.8`
4. **Verify console log:** `[Lesson 4] Played C (MIDI 60)`
5. Check Network tab for any errors
6. Verify smooth audio playback (no crackling, stuttering)

**Chord Detection Testing:**
1. Open Console tab (enable verbose logging)
2. In step 4.3, click C key
3. Wait 500ms
4. Click E key
5. **Verify:** No chord detected (notes too far apart)
6. Click C, E, G within 200ms (rapid succession or actual simultaneous click)
7. **Verify:** Chord detected (3 notes in window)
8. **Verify:** Lesson completes

**Performance Testing:**
1. Open DevTools → Performance tab
2. Start profiling
3. Complete full lesson 4 flow (all 3 steps)
4. Stop profiling
5. **Verify:** No significant FPS drops
6. **Verify:** No memory leaks (check memory tab)
7. **Verify:** Piano note playback <50ms latency (feel responsive)

[Source: CLAUDE.md#quality-assurance, docs/architecture/testing-strategy.md]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Initial story creation | Bob (Scrum Master) |

---

## Dev Agent Record

_This section will be populated during implementation._

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes
_To be filled by dev agent_

### File List
_Files created/modified:_
-

---

## QA Results

_This section will be populated after QA review._
