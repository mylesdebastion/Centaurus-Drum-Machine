# Story 1.4: Real-time LED Feedback and Visual Synchronization

## Status
Draft

## Story
**As a** music producer using APC40,  
**I want** LED feedback that shows my pattern state and playback position,  
**so that** I can see my rhythm patterns and current playback position on the hardware

## Acceptance Criteria
1. Implement LED color mapping for step states (off/velocity-based/current position)
2. Synchronize LED updates with existing Tone.js playback timing  
3. Create LED animation system for playback position indication
4. Optimize LED update performance to maintain <50ms latency
5. Handle LED state synchronization when sequencer state changes from any source

**Integration Verification**:
- **IV1**: Existing audio playback timing and performance remain unchanged
- **IV2**: LED updates do not cause audio dropouts or timing drift  
- **IV3**: Visual feedback stays synchronized between hardware LEDs and web interface

## Tasks / Subtasks
- [ ] **Task 1: LED Color Mapping System** (AC: 1)
  - [ ] Create `src/hardware/apc40/ledPatterns.ts` with LED color definitions
  - [ ] Implement step state to LED color mapping (off=black, active=green, playing=red)
  - [ ] Add velocity-based LED intensity mapping for step dynamics
  - [ ] Create special LED patterns for playback position indication

- [ ] **Task 2: Tone.js Integration and Timing Sync** (AC: 2)
  - [ ] Integrate LED updates with existing Tone.js scheduler system
  - [ ] Subscribe to Tone.js Transport events for playback synchronization
  - [ ] Implement high-precision timing using Performance.now() API
  - [ ] Ensure LED updates don't interfere with audio engine timing

- [ ] **Task 3: Playback Position Animation** (AC: 3)
  - [ ] Create playhead LED animation system showing current step
  - [ ] Implement lookahead scheduling for smooth LED transitions
  - [ ] Add step-by-step LED progression during sequencer playback
  - [ ] Handle playback start/stop/pause LED state changes

- [ ] **Task 4: LED Update Performance Optimization** (AC: 4)
  - [ ] Implement LED state caching to minimize redundant MIDI messages
  - [ ] Batch LED updates for efficient MIDI communication
  - [ ] Add performance monitoring for LED update latency (<50ms target)
  - [ ] Optimize SysEx message frequency and timing

- [ ] **Task 5: Multi-Source State Synchronization** (AC: 5)
  - [ ] Handle LED updates from web UI step changes
  - [ ] Handle LED updates from hardware button presses  
  - [ ] Handle LED updates from programmatic sequencer changes
  - [ ] Ensure consistent LED state regardless of change source

- [ ] **Task 6: LED Performance Monitoring** (Performance requirements)
  - [ ] Add LED update timing metrics in development mode
  - [ ] Implement LED update queue monitoring
  - [ ] Create LED synchronization accuracy measurements
  - [ ] Add debugging tools for LED timing analysis

- [ ] **Task 7: Integration Testing** (AC: All)
  - [ ] Test LED synchronization accuracy with audio playback
  - [ ] Test LED performance under various BPM settings
  - [ ] Verify LED state consistency across different change sources
  - [ ] Test LED update performance and latency requirements
  - [ ] Achieve 80% test coverage target

## Dev Notes

### Previous Story Insights
**Story 1.1 Foundation**: Hardware abstraction layer with HardwareManager context and event-driven communication system.

**Story 1.2 Web MIDI**: Web MIDI API wrapper with connection management and performance optimization.

**Story 1.3 APC40**: APC40Controller implementation with SysEx mode, MIDI mapping, and bidirectional communication. LED state caching (`ledStates: Map<number, number>`) already established.

### Data Models [Source: architecture/data-models-and-schema-changes.md & previous stories]
- **LED State Management**:
  - `ledStates: Map<number, number>` - Current LED state cache (from Story 1.3)
  - `ledColorMap: Record<string, number>` - Step state to LED color mapping
  - `playbackPosition: number` - Current playhead step position
  - `lastUpdateTime: number` - Performance timing for LED update optimization

- **Timing Integration Data**:
  - `syncWithAudio: boolean` - Whether LED updates are synchronized with Tone.js
  - `lookaheadTime: number` - LED update lookahead timing (25ms default)
  - `updateLatency: number` - Measured LED update performance

### Component Specifications [Source: architecture/component-architecture.md]
- **APC40Controller LED Extensions** (building on Story 1.3):
  - `updateLEDs(sequencerState)` - Translate sequencer state to LED patterns (interface from 1.3)
  - LED color mapping integration with existing SysEx LED control
  - Performance optimization with state caching from Story 1.3

- **LED Pattern System** (`src/hardware/apc40/ledPatterns.ts`):
  - Color mapping utilities for different step states
  - Animation patterns for playback position indication
  - Velocity-to-intensity mapping for dynamic visual feedback

### File Locations [Source: architecture/source-tree.md]
- **LED Implementation**: `src/hardware/apc40/ledPatterns.ts`
- **APC40Controller**: Extend existing `src/hardware/apc40/APC40Controller.ts` with LED methods
- **Integration**: Use existing Tone.js scheduler from `src/utils/audioEngine.ts`

### Technical Constraints [Source: architecture/tech-stack.md]
- **Timing Synchronization**: Tone.js 15.1.22 scheduler integration, extends existing timing system
- **Performance**: Performance.now() API for high-precision timing (browser-native)
- **LED Latency**: <50ms LED update latency requirement
- **Audio Protection**: LED updates must not interfere with existing audio engine performance

### APC40 LED Technical Specifications
- **LED Colors**: APC40 supports off (0), green (1), green blink (2), red (3), red blink (4), amber (5), amber blink (6)
- **SysEx LED Control**: Uses SysEx mode from Story 1.3 for individual LED control
- **Grid Layout**: 8x5 button grid with individual RGB LED control per button
- **Update Rate**: Optimal LED update rate ~20Hz (50ms intervals) for smooth visual feedback

### Tone.js Integration Pattern
- **Transport Events**: Subscribe to Tone.Transport.scheduleRepeat for step timing
- **Scheduler Integration**: Use existing audio scheduler without modification
- **Event Timing**: LED updates triggered by Tone.js events, not independent timers
- **Performance Isolation**: LED rendering happens after audio scheduling to prevent timing interference

### LED Timing Algorithm (from research)
- **Lookahead Scheduling**: 25ms lookahead for smooth LED transitions
- **Performance.now()**: High-precision timing for LED synchronization accuracy
- **State Caching**: LED state cache prevents redundant MIDI messages  
- **Batch Updates**: Group LED changes into efficient SysEx message batches

### Integration Guidelines
- **Audio Engine Protection**: LED updates must not modify or interfere with existing Tone.js timing
- **State Management**: LED state integrates with sequencer state through HardwareManager events
- **Error Isolation**: LED update failures handled by error boundaries, don't affect audio
- **Multi-Source Sync**: LED updates from web UI, hardware, or programmatic changes all handled consistently

### Testing
**Test Framework**: Jest/Vitest with React Testing Library [Source: architecture/testing-strategy.md]  
**Test Location**: `src/hardware/__tests__/apc40/ledPatterns.test.ts`  
**Coverage Target**: 80% line coverage for LED systems  
**Testing Requirements**:
- Mock Tone.js Transport events for LED synchronization testing
- Test LED color mapping accuracy and consistency
- Test LED update performance and latency measurements  
- Test multi-source state synchronization scenarios
- Verify LED updates don't interfere with audio engine timing

### Project Structure Notes
LED feedback system builds on all previous story foundations. Uses established APC40Controller from Story 1.3, Web MIDI from Story 1.2, and HardwareManager events from Story 1.1. Complete integration without modifying existing audio or sequencer components.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-25 | 1.0 | Initial story creation from epic | Story Manager (Bob) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be completed by dev agent*

### Debug Log References  
*To be completed by dev agent*

### Completion Notes List
*To be completed by dev agent*

### File List
*To be completed by dev agent*

## QA Results
*Results from QA Agent review will be populated here after implementation*