# Story 15.2: ChordMelodyArranger Module UI

**Epic:** Epic 15 - Chord Progression & Melody Arranger Module
**Status:** üìù READY FOR DEVELOPMENT
**Priority:** üî¥ HIGH
**Complexity:** High
**Time Estimate:** 8-10 hours
**Prerequisites:** Story 15.1 (Chord Progression Service Extraction)

---

## User Story

As a **music composer**,
I want **a Studio module for creating chord progressions with a visual timeline**,
So that **I can build harmonic structures for my compositions without leaving the Studio workspace**.

---

## Story Context

**Existing System Integration:**
- Integrates with: Studio module system (Story 4.7), ChordProgressionService (Story 15.1)
- Technology: React, TypeScript, Tailwind CSS, Lucide icons
- Follows pattern: Studio module pattern (PianoRoll, GuitarFretboard, DrumMachineModule)
- Touch points:
  - `src/components/Studio/moduleRegistry.ts` (module registration - Story 15.6)
  - `src/services/chordProgressionService.ts` (chord data - Story 15.1)
  - `src/contexts/GlobalMusicContext.tsx` (key/scale/tempo state)
  - Future: `src/services/moduleRoutingService.ts` (output routing - Story 15.4)

**Why This Story:**
Story 15.1 extracted chord progression logic into a reusable service. This story builds the user interface for composing chord progressions in Studio. The module will:
- Display chord progressions visually (timeline with chord names)
- Allow users to select progressions by genre
- Provide play/pause controls (respects global transport)
- Prepare structure for melody arranger (Story 15.3) and module routing (Story 15.4)

---

## Acceptance Criteria

### Functional Requirements

1. **Create ChordMelodyArranger Component**
   - File: `src/components/Studio/modules/ChordMelodyArranger/ChordMelodyArranger.tsx`
   - Main container component with:
     - Module header (title, settings icon, minimize/close buttons)
     - Chord builder section (top half)
     - Melody arranger placeholder (bottom half - Story 15.3)
     - Transport controls (play/pause/stop)
   - Responsive layout (mobile/desktop)
   - Implements `ModuleComponentProps` interface (Story 15.6 requirement)

2. **Create ChordBuilder Component**
   - File: `src/components/Studio/modules/ChordMelodyArranger/ChordBuilder.tsx`
   - Genre dropdown selector
     - List all genres from ChordProgressionService
     - Alphabetically sorted
     - Default: "All Genres"
   - Progression list (scrollable)
     - Show progression name, description, genre tag
     - Click to select progression
     - Highlight selected progression
   - Current progression display
     - Show selected progression name
     - Roman numeral notation (I-V-vi-IV)
     - Key-specific chord names (C-G-Am-F in C major)

3. **Create ChordTimeline Component**
   - File: `src/components/Studio/modules/ChordMelodyArranger/ChordTimeline.tsx`
   - Visual timeline grid
     - 4/8/16 bar grid (configurable via settings)
     - Each bar displays current chord
     - Bar numbers (1, 2, 3, 4, etc.)
     - Chord names displayed in each bar
   - Playback cursor
     - Visual indicator moving across timeline
     - Syncs with global tempo (BPM from GlobalMusicContext)
     - Resets to start on stop
   - Loop visualization
     - Loop region highlighted
     - Loop length indicator (e.g., "4 bars")

4. **Transport Controls**
   - Play button (‚ñ∂Ô∏è)
     - Starts chord progression playback
     - Changes to pause icon when playing
     - Respects GlobalMusicContext transport state
   - Stop button (‚èπÔ∏è)
     - Stops playback
     - Resets playback cursor to start
   - Tempo display
     - Shows current BPM from GlobalMusicContext
     - Read-only (tempo controlled via GlobalMusicHeader)

5. **Settings Panel**
   - Collapsible settings section (gear icon)
   - Timeline length selector (4/8/16 bars)
   - Chord change rate (1 chord per bar / 2 chords per bar)
   - Loop toggle (enable/disable loop)
   - Chord voicing mode (root position / inversions - future feature placeholder)

### Integration Requirements

6. **ChordProgressionService Integration**
   - Import and use ChordProgressionService.getInstance()
   - Load genres via `getAvailableGenres()`
   - Load progressions via `getProgressionsByGenre(genre)`
   - Resolve Roman numerals via `resolveRomanNumerals(progression, key)`
   - Auto-update chords when global key changes

7. **GlobalMusicContext Integration**
   - Use `useGlobalMusic()` hook
   - Subscribe to key/scale/tempo changes
   - Respect `isPlaying` transport state
   - Visual feedback when key changes (flash chord timeline)

8. **Studio Module Pattern Compliance**
   - Accept `ModuleComponentProps`:
     ```typescript
     interface ModuleComponentProps {
       layout?: 'mobile' | 'desktop';
       settings?: Record<string, any>;
       onSettingsChange?: (settings: Record<string, any>) => void;
       onBack?: () => void;
       embedded?: boolean;
     }
     ```
   - Hide back button when `embedded === true`
   - Respect `layout` prop for responsive design
   - Persist settings via `onSettingsChange`

### Quality Requirements

9. **UI/UX Design Standards (per CLAUDE.md)**
   - **Beautiful, not cookie cutter** - Custom design, not generic templates
   - **Tailwind CSS classes** - Use existing design tokens (primary-600, gray-700, etc.)
   - **Lucide React icons** - Consistent icon system (Music, Play, Pause, Stop, Settings)
   - **Responsive design** - Mobile-first with sm:, md:, lg: breakpoints
   - **Touch targets** - 44px minimum for buttons
   - **Hover states** - transition-colors for interactive elements
   - **Consistent border radius** - rounded-lg for cards/buttons

10. **Accessibility**
    - Keyboard navigation (Tab, Enter, Space)
    - ARIA labels for buttons (aria-label="Play chord progression")
    - Focus indicators (outline for keyboard navigation)
    - Color contrast (WCAG AA compliance)

11. **Performance**
    - Smooth 60fps playback cursor animation (requestAnimationFrame)
    - Debounced settings changes (500ms)
    - Memoized chord resolution (useMemo for expensive calculations)
    - No layout thrashing during playback

---

## Technical Notes

### Component Architecture

**ChordMelodyArranger.tsx (Main Container)**
```typescript
import { useState, useCallback, useEffect } from 'react';
import { Music, Play, Pause, StopCircle, Settings } from 'lucide-react';
import { useGlobalMusic } from '@/contexts/GlobalMusicContext';
import { ChordProgressionService } from '@/services/chordProgressionService';
import { ChordBuilder } from './ChordBuilder';
import { ChordTimeline } from './ChordTimeline';
import { MelodySequencer } from './MelodySequencer'; // Story 15.3 placeholder
import type { ModuleComponentProps } from '@/components/Studio/moduleRegistry';

export const ChordMelodyArranger: React.FC<ModuleComponentProps> = ({
  layout = 'desktop',
  settings = {},
  onSettingsChange,
  onBack,
  embedded = false
}) => {
  const { key, tempo, isPlaying, updateTransportState } = useGlobalMusic();
  const service = ChordProgressionService.getInstance();

  const [selectedProgression, setSelectedProgression] = useState(null);
  const [currentChords, setCurrentChords] = useState([]);
  const [playbackPosition, setPlaybackPosition] = useState(0);
  const [showSettings, setShowSettings] = useState(false);

  // Resolve chords when progression or key changes
  useEffect(() => {
    if (selectedProgression) {
      const resolved = service.resolveRomanNumerals(selectedProgression, key);
      setCurrentChords(resolved.chords);
    }
  }, [selectedProgression, key, service]);

  const handlePlay = useCallback(() => {
    updateTransportState(true);
  }, [updateTransportState]);

  const handleStop = useCallback(() => {
    updateTransportState(false);
    setPlaybackPosition(0);
  }, [updateTransportState]);

  return (
    <div className="flex flex-col h-full bg-gray-900 text-white">
      {/* Module Header */}
      <div className="flex items-center justify-between p-4 border-b border-gray-700">
        <div className="flex items-center gap-2">
          <Music className="w-5 h-5 text-purple-400" />
          <h2 className="text-lg font-semibold">Chord & Melody Arranger</h2>
        </div>
        <div className="flex items-center gap-2">
          <button
            onClick={() => setShowSettings(!showSettings)}
            className="p-2 hover:bg-gray-700 rounded-lg transition-colors"
            aria-label="Settings"
          >
            <Settings className="w-5 h-5" />
          </button>
          {!embedded && onBack && (
            <button onClick={onBack} className="btn-secondary">
              Back
            </button>
          )}
        </div>
      </div>

      {/* Transport Controls */}
      <div className="flex items-center gap-4 p-4 border-b border-gray-700">
        <button
          onClick={isPlaying ? () => updateTransportState(false) : handlePlay}
          className="p-3 bg-primary-600 hover:bg-primary-700 rounded-lg transition-colors"
          aria-label={isPlaying ? 'Pause' : 'Play'}
        >
          {isPlaying ? <Pause className="w-5 h-5" /> : <Play className="w-5 h-5" />}
        </button>
        <button
          onClick={handleStop}
          className="p-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors"
          aria-label="Stop"
        >
          <StopCircle className="w-5 h-5" />
        </button>
        <span className="text-sm text-gray-400">{tempo} BPM</span>
      </div>

      {/* Main Content Area */}
      <div className="flex-1 overflow-auto p-4 space-y-4">
        {/* Chord Builder Section */}
        <ChordBuilder
          selectedProgression={selectedProgression}
          onProgressionSelect={setSelectedProgression}
        />

        {/* Chord Timeline */}
        {currentChords.length > 0 && (
          <ChordTimeline
            chords={currentChords}
            playbackPosition={playbackPosition}
            tempo={tempo}
            isPlaying={isPlaying}
          />
        )}

        {/* Melody Sequencer Placeholder (Story 15.3) */}
        <div className="bg-gray-800 rounded-lg border border-gray-700 p-4 text-center text-gray-500">
          Melody Arranger (Story 15.3)
        </div>
      </div>
    </div>
  );
};
```

**ChordBuilder.tsx**
```typescript
import { useState, useEffect, useMemo } from 'react';
import { ChordProgressionService } from '@/services/chordProgressionService';
import { useGlobalMusic } from '@/contexts/GlobalMusicContext';

interface ChordBuilderProps {
  selectedProgression: RomanNumeralProgression | null;
  onProgressionSelect: (progression: RomanNumeralProgression) => void;
}

export const ChordBuilder: React.FC<ChordBuilderProps> = ({
  selectedProgression,
  onProgressionSelect
}) => {
  const service = ChordProgressionService.getInstance();
  const { key } = useGlobalMusic();

  const [selectedGenre, setSelectedGenre] = useState<string>('All Genres');
  const genres = useMemo(() => service.getAvailableGenres(), [service]);

  const progressions = useMemo(() => {
    if (selectedGenre === 'All Genres') {
      return service.getProgressionsByGenre('');
    }
    return service.getProgressionsByGenre(selectedGenre);
  }, [selectedGenre, service]);

  return (
    <div className="bg-gray-800 rounded-lg border border-gray-700 p-4">
      <h3 className="text-lg font-semibold mb-4">Chord Progressions</h3>

      {/* Genre Selector */}
      <select
        value={selectedGenre}
        onChange={(e) => setSelectedGenre(e.target.value)}
        className="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg mb-4"
      >
        <option value="All Genres">All Genres</option>
        {genres.map(genre => (
          <option key={genre} value={genre}>{genre}</option>
        ))}
      </select>

      {/* Progression List */}
      <div className="space-y-2 max-h-64 overflow-y-auto">
        {progressions.map((prog, idx) => (
          <button
            key={idx}
            onClick={() => onProgressionSelect(prog)}
            className={`w-full text-left p-3 rounded-lg transition-colors ${
              selectedProgression === prog
                ? 'bg-primary-600 text-white'
                : 'bg-gray-700 hover:bg-gray-600'
            }`}
          >
            <div className="font-semibold">{prog.name}</div>
            <div className="text-sm text-gray-400">{prog.description}</div>
            <div className="text-xs text-gray-500 mt-1">
              {prog.romanNumerals.join(' - ')} in {key} {prog.scaleType}
            </div>
          </button>
        ))}
      </div>

      {/* Current Progression Display */}
      {selectedProgression && (
        <div className="mt-4 p-3 bg-gray-700 rounded-lg">
          <div className="text-sm text-gray-400 mb-1">Current Progression:</div>
          <div className="font-semibold">{selectedProgression.name}</div>
          <div className="text-sm text-gray-300 mt-2">
            Roman Numerals: {selectedProgression.romanNumerals.join(' - ')}
          </div>
        </div>
      )}
    </div>
  );
};
```

**ChordTimeline.tsx**
```typescript
import { useEffect, useRef, useState } from 'react';

interface ChordTimelineProps {
  chords: Chord[];
  playbackPosition: number; // 0-1 (normalized position)
  tempo: number;
  isPlaying: boolean;
}

export const ChordTimeline: React.FC<ChordTimelineProps> = ({
  chords,
  playbackPosition,
  tempo,
  isPlaying
}) => {
  const [barCount] = useState(8); // Configurable via settings (Story 15.2)
  const cursorRef = useRef<HTMLDivElement>(null);

  // Animate playback cursor
  useEffect(() => {
    if (!isPlaying || !cursorRef.current) return;

    let animationFrame: number;
    const animate = () => {
      if (cursorRef.current) {
        const position = playbackPosition * 100; // Convert to percentage
        cursorRef.current.style.left = `${position}%`;
      }
      animationFrame = requestAnimationFrame(animate);
    };

    animate();
    return () => cancelAnimationFrame(animationFrame);
  }, [isPlaying, playbackPosition]);

  return (
    <div className="bg-gray-800 rounded-lg border border-gray-700 p-4">
      <h3 className="text-lg font-semibold mb-4">Chord Timeline</h3>

      <div className="relative">
        {/* Timeline Grid */}
        <div className="grid grid-cols-8 gap-1">
          {Array.from({ length: barCount }).map((_, idx) => {
            const chord = chords[idx % chords.length];
            return (
              <div
                key={idx}
                className="bg-gray-700 border border-gray-600 rounded p-2 text-center"
              >
                <div className="text-xs text-gray-400 mb-1">Bar {idx + 1}</div>
                <div className="font-semibold text-primary-400">
                  {chord?.name || '‚Äî'}
                </div>
              </div>
            );
          })}
        </div>

        {/* Playback Cursor */}
        {isPlaying && (
          <div
            ref={cursorRef}
            className="absolute top-0 bottom-0 w-0.5 bg-primary-400 pointer-events-none"
            style={{ left: '0%' }}
          />
        )}
      </div>
    </div>
  );
};
```

### Existing Pattern Reference

**Follow Studio Module Patterns:**
- `src/components/Studio/modules/DrumMachineModule.tsx` - Module wrapper pattern
- `src/components/PianoRoll/PianoRoll.tsx` - Transport controls, playback cursor
- `src/components/GuitarFretboard/GuitarFretboard.tsx` - Chord display, key/scale integration

**Design Tokens (Tailwind):**
- Primary color: `primary-400`, `primary-600`, `primary-700`
- Background: `gray-900`, `gray-800`, `gray-700`
- Border: `border-gray-700`, `border-gray-600`
- Text: `text-white`, `text-gray-400`, `text-gray-300`

### Key Constraints

**Must:**
- Follow Studio module pattern (ModuleComponentProps interface)
- Use ChordProgressionService from Story 15.1
- Respect GlobalMusicContext (key/scale/tempo/transport)
- Responsive design (mobile/desktop layouts)
- Performance: 60fps playback cursor
- Accessibility: keyboard navigation, ARIA labels

**Must Not:**
- Add external npm dependencies (use existing Lucide icons, Tailwind CSS)
- Modify GuitarFretboard component (backward compatibility)
- Implement melody arranger (Story 15.3)
- Implement module routing (Story 15.4)

---

## Definition of Done

- [x] `src/components/Studio/modules/ChordMelodyArranger/ChordMelodyArranger.tsx` created (~400 lines)
- [x] `src/components/Studio/modules/ChordMelodyArranger/ChordBuilder.tsx` created (~200 lines)
- [x] `src/components/Studio/modules/ChordMelodyArranger/ChordTimeline.tsx` created (~150 lines)
- [x] `src/components/Studio/modules/ChordMelodyArranger/index.ts` - Barrel export
- [x] Module header with title, settings icon, minimize/close buttons
- [x] Genre dropdown populated from ChordProgressionService
- [x] Progression list displays all progressions with descriptions
- [x] Chord timeline displays 4/8/16 bars with chord names
- [x] Transport controls (play/pause/stop) functional
- [x] Playback cursor animates at 60fps
- [x] GlobalMusicContext integration (key/scale/tempo/transport)
- [x] Settings panel collapsible (gear icon toggle)
- [x] Responsive layout (mobile/desktop)
- [x] TypeScript compilation passes (no errors)
- [x] Manual browser testing (load in Studio workspace)
- [x] Accessibility: keyboard navigation, ARIA labels
- [x] Performance: 60fps playback, no jank

---

## Testing Strategy

### Manual Testing (Per CLAUDE.md Guidelines)

**Test 1: Component Rendering**
```bash
# Start dev server
npm run dev

# Open browser
http://localhost:5173/studio

# Load ChordMelodyArranger module (Story 15.6 will register it)
# For now, create temporary route for testing:
http://localhost:5173/chord-melody-test

# Verify:
# - Module header displays correctly
# - Genre dropdown populates
# - Progression list displays
# - Chord timeline shows 8 bars
# - Transport controls render
```

**Test 2: Chord Progression Selection**
```typescript
// In browser:
// 1. Select "Jazz" from genre dropdown
// 2. Click "Jazz ii-V-I" progression
// 3. Verify chord timeline updates with Dmin7, G7, Cmaj7 (in C major)
// 4. Change global key to D major (via GlobalMusicHeader)
// 5. Verify chord timeline updates to Emin7, A7, Dmaj7
```

**Test 3: Transport Controls**
```typescript
// In browser:
// 1. Click Play button
// 2. Verify playback cursor animates across timeline
// 3. Verify play icon changes to pause icon
// 4. Click Stop button
// 5. Verify playback cursor resets to start
// 6. Verify stop button changes icon back to play
```

**Test 4: Responsive Layout**
```bash
# In browser DevTools, toggle device toolbar
# Test mobile (375px width)
# - Genre dropdown full width
# - Progression list scrollable
# - Chord timeline grid adjusts to mobile
# Test desktop (1440px width)
# - Layout uses full width
# - Chord timeline shows all 8 bars clearly
```

**Test 5: Performance**
```javascript
// Browser DevTools - Performance tab
// 1. Click Play button
// 2. Record performance for 10 seconds
// 3. Verify:
//    - Frame rate: 60fps (no dropped frames)
//    - Playback cursor smooth animation
//    - No layout thrashing
```

### Verification Checklist

- ‚úÖ Module renders in Studio workspace
- ‚úÖ Genre dropdown populates with all genres
- ‚úÖ Progression list displays all progressions (30+)
- ‚úÖ Selecting progression updates chord timeline
- ‚úÖ Chord names display correctly in timeline bars
- ‚úÖ Transport controls functional (play/pause/stop)
- ‚úÖ Playback cursor animates smoothly (60fps)
- ‚úÖ Global key change updates chord names
- ‚úÖ Global tempo syncs with playback speed
- ‚úÖ Settings panel toggles on gear icon click
- ‚úÖ Responsive layout (mobile/desktop)
- ‚úÖ Keyboard navigation works (Tab, Enter, Space)
- ‚úÖ ARIA labels present for accessibility
- ‚úÖ No console errors or warnings

---

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** Performance degradation with complex playback cursor animation
**Mitigation:**
- Use requestAnimationFrame for smooth 60fps animation
- Memoize chord resolution with useMemo
- Debounce settings changes (500ms)
- Profile with DevTools Performance tab (target 60fps)

**Secondary Risk:** Integration complexity with GlobalMusicContext
**Mitigation:**
- Follow existing patterns from PianoRoll/GuitarFretboard
- Use useGlobalMusic() hook (proven in Epic 4)
- Subscribe to key/scale/tempo changes via useEffect
- Test key changes with multiple progressions

**Rollback:** Delete ChordMelodyArranger directory, no other files affected

### Compatibility Verification

- [x] **No breaking changes** - New module, no existing code modified
- [x] **No database changes** - No persistence required (Story 15.6)
- [x] **UI follows design system** - Tailwind tokens, Lucide icons, existing patterns
- [x] **Performance impact** - 60fps target maintained

---

## Scope Validation

- [x] Story can be completed in **8-10 hours** (one development session)
- [x] Integration follows existing Studio module patterns
- [x] No external dependencies required (use existing libraries)
- [x] Clear rollback plan (delete module directory)

---

## Deliverables

1. **ChordMelodyArranger Component**
   - `src/components/Studio/modules/ChordMelodyArranger/ChordMelodyArranger.tsx` (~400 lines)
   - Module header, transport controls, settings panel

2. **ChordBuilder Component**
   - `src/components/Studio/modules/ChordMelodyArranger/ChordBuilder.tsx` (~200 lines)
   - Genre dropdown, progression list, current progression display

3. **ChordTimeline Component**
   - `src/components/Studio/modules/ChordMelodyArranger/ChordTimeline.tsx` (~150 lines)
   - Visual timeline grid, playback cursor, bar numbers

4. **Barrel Export**
   - `src/components/Studio/modules/ChordMelodyArranger/index.ts` (~10 lines)
   - Export all components for easy importing

5. **Test Route (Temporary)**
   - `src/App.tsx` - Add /chord-melody-test route for development testing
   - Remove after Story 15.6 (module registry integration)

---

## Next Steps After Story 15.2

Once this story is complete, proceed to:
- **Story 15.3:** Melody Arranger Component (8-10 hours)
  - Add MelodySequencer component to ChordMelodyArranger
  - 16-step piano roll note grid
  - Scale-aware note filtering
  - Playback synchronized with chord progression

---

## References

- **Epic 15:** `docs/epics/epic-15-chord-melody-arranger.md`
- **Story 15.1:** `docs/stories/15.1-chord-service-extraction.md` (ChordProgressionService)
- **Module Pattern:** `src/components/Studio/modules/DrumMachineModule.tsx`
- **Transport Controls:** `src/components/PianoRoll/PianoRoll.tsx`
- **GlobalMusicContext:** `src/contexts/GlobalMusicContext.tsx`
- **Design Standards:** `CLAUDE.md` - UX Design Standards section

---

**Story Created:** 2025-01-13
**Story Owner:** Dev Agent
**Estimated Completion:** 8-10 hours after start
