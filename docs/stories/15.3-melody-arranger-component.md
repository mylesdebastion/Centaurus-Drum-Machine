# Story 15.3: Melody Arranger Component

**Epic:** Epic 15 - Chord Progression & Melody Arranger Module
**Status:** ðŸ“ READY FOR DEVELOPMENT
**Priority:** ðŸ”´ HIGH
**Complexity:** High
**Time Estimate:** 8-10 hours
**Prerequisites:** Story 15.2 (ChordMelodyArranger Module UI)

---

## User Story

As a **music producer**,
I want **a melody sequencer integrated into the ChordMelodyArranger module**,
So that **I can compose melodies that play in sync with chord progressions and automatically conform to the selected key/scale**.

---

## Story Context

**Existing System Integration:**
- Integrates with: ChordMelodyArranger component (Story 15.2), GlobalMusicContext (Epic 4), ChordProgressionService (Story 15.1)
- Technology: React, TypeScript, Web Audio API (Tone.js), requestAnimationFrame for 60fps UI
- Follows pattern: 16-step sequencer grid (similar to drum machine pattern), scale-aware note filtering
- Touch points:
  - `src/components/Studio/modules/ChordMelodyArranger/ChordMelodyArranger.tsx` (parent container)
  - `src/components/Studio/modules/ChordMelodyArranger/MelodySequencer.tsx` (new component)
  - `src/components/Studio/modules/ChordMelodyArranger/ChordTimeline.tsx` (playback coordination)
  - `src/contexts/GlobalMusicContext.tsx` (key/scale state)
  - `src/utils/audioEngine.ts` (Tone.js audio playback)

**Why This Story:**
Story 15.2 created the chord progression UI and timeline visualization. This story adds the melody composition layer, enabling users to create melodic lines that play alongside chord progressions. The melody sequencer must:
- Sync playback with chord timeline (same tempo/transport state)
- Filter notes to match GlobalMusicContext key/scale
- Provide intuitive piano roll UI (16-step grid)
- Output MIDI note events that can be routed to loaded modules (Story 15.4)

---

## Acceptance Criteria

### Functional Requirements

1. **MelodySequencer Component Created**
   - File: `src/components/Studio/modules/ChordMelodyArranger/MelodySequencer.tsx`
   - Props interface:
     ```typescript
     export interface MelodySequencerProps {
       playbackPosition: number; // 0-1 (0% to 100% through sequence)
       isPlaying: boolean;
       tempo: number;
       onNoteEvent?: (note: MelodyNote) => void; // For module routing (Story 15.4)
     }

     export interface MelodyNote {
       step: number;        // 0-15 (16 steps)
       pitch: number;       // MIDI note number (21-108)
       velocity: number;    // 0-127
       duration: number;    // In beats (0.25 = 1/16th note)
     }
     ```

2. **Piano Roll Grid UI**
   - 16-step horizontal grid (x-axis = time, y-axis = pitch)
   - Pitch range: 2 octaves based on GlobalMusicContext key (e.g., C4-C6 for key of C)
   - Scale-aware note filtering:
     - Only display notes in selected scale (e.g., C major â†’ C D E F G A B)
     - Gray out non-scale notes (chromatic mode shows all notes)
   - Visual design:
     - Active notes: Filled circles/squares (primary-500)
     - Empty steps: Outlined circles/squares (gray-600)
     - Hover state: Brightness increase (hover:bg-primary-400)
     - Current step indicator: Vertical line (primary-300, 60fps animation)

3. **Note Input Interaction**
   - Click/tap to toggle note on/off
   - Click duration: Default 1/16th note (can extend in future story)
   - Note velocity: Default 100 (can edit in future story)
   - Keyboard shortcuts:
     - `Space` - Play/pause
     - `Delete` - Clear all notes
     - Arrow keys - Navigate grid (accessibility)

4. **Playback Synchronization**
   - Melody plays in sync with ChordTimeline playback
   - Same `playbackPosition` prop used by both components
   - Step triggering: When `playbackPosition` crosses step boundary (0/16, 1/16, 2/16, etc.)
   - Note scheduling: Use Tone.js `Transport.scheduleOnce()` for precise timing

5. **Scale-Aware Note Filtering**
   - Read key/scale from GlobalMusicContext
   - Map scale to MIDI note numbers:
     ```typescript
     // Example: C major scale, 2 octaves starting at C4 (MIDI 60)
     const cMajorScale = [60, 62, 64, 65, 67, 69, 71, 72, 74, 76, 77, 79, 81, 83, 84];

     // Example: A minor scale, 2 octaves starting at A3 (MIDI 57)
     const aMinorScale = [57, 59, 60, 62, 64, 65, 67, 69, 71, 72, 74, 76, 77, 79, 81];
     ```
   - Auto-clear non-scale notes when key/scale changes (with confirmation)

### Integration Requirements

6. **GlobalMusicContext Integration**
   - Subscribe to key/scale changes via `useGlobalMusic()` hook
   - Recalculate visible notes when key/scale changes
   - Respect colorMode setting (chromatic vs harmonic)
   - Example:
     ```typescript
     const { key, scale, colorMode } = useGlobalMusic();

     useEffect(() => {
       const scaleNotes = calculateScaleNotes(key, scale, 2); // 2 octaves
       setVisibleNotes(scaleNotes);
     }, [key, scale]);
     ```

7. **Audio Engine Integration**
   - Use existing `audioEngine.ts` singleton for playback
   - Play notes via Tone.js synth (default to PolySynth)
   - Note scheduling logic:
     ```typescript
     // Schedule note when step is triggered
     const scheduleNote = (note: MelodyNote, time: number) => {
       const synth = audioEngine.getSynth('melody'); // Reserved synth for melody
       synth.triggerAttackRelease(
         Tone.Frequency(note.pitch, 'midi').toNote(),
         note.duration,
         time,
         note.velocity / 127
       );
     };
     ```

8. **ChordMelodyArranger Integration**
   - Add `<MelodySequencer>` component to ChordMelodyArranger layout
   - Position below ChordTimeline
   - Share playback state (`playbackPosition`, `isPlaying`, `tempo`)
   - Example layout:
     ```typescript
     // ChordMelodyArranger.tsx
     <div className="flex flex-col h-full space-y-4">
       {/* Transport Controls */}
       <TransportControls />

       {/* Chord Timeline */}
       <ChordTimeline
         chords={currentChords}
         playbackPosition={playbackPosition}
         tempo={tempo}
         isPlaying={isPlaying}
       />

       {/* Melody Sequencer */}
       <MelodySequencer
         playbackPosition={playbackPosition}
         isPlaying={isPlaying}
         tempo={tempo}
         onNoteEvent={handleMelodyNote} // Story 15.4 - route to modules
       />
     </div>
     ```

### Quality Requirements

9. **Performance**
   - 60fps grid animation (playback cursor)
   - Step triggering accuracy: Â±5ms (use Tone.js Transport scheduling)
   - Note input latency: <50ms (immediate visual feedback)
   - Grid render optimization: Use React.memo for note cells

10. **Responsive Design**
    - Desktop: Full 16-step grid visible
    - Mobile: Horizontal scroll for 16 steps, touch-friendly note cells (44px minimum)
    - Tablet: Optimized grid size (scale note cells to fit viewport)

11. **Accessibility**
    - Keyboard navigation: Arrow keys to navigate grid
    - Screen reader support: ARIA labels for notes ("C4, step 1")
    - Focus indicators: Visible focus ring on active cell
    - Color contrast: WCAG AA compliance (4.5:1 text, 3:1 UI components)

---

## Technical Notes

### Integration Approach

**MelodySequencer Component Architecture:**
```typescript
// src/components/Studio/modules/ChordMelodyArranger/MelodySequencer.tsx
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { useGlobalMusic } from '@/contexts/GlobalMusicContext';
import { audioEngine } from '@/utils/audioEngine';
import * as Tone from 'tone';

export interface MelodyNote {
  step: number;        // 0-15
  pitch: number;       // MIDI note number
  velocity: number;    // 0-127
  duration: number;    // In beats
}

export interface MelodySequencerProps {
  playbackPosition: number; // 0-1
  isPlaying: boolean;
  tempo: number;
  onNoteEvent?: (note: MelodyNote) => void;
}

export const MelodySequencer: React.FC<MelodySequencerProps> = ({
  playbackPosition,
  isPlaying,
  tempo,
  onNoteEvent
}) => {
  const { key, scale, colorMode } = useGlobalMusic();
  const [notes, setNotes] = useState<MelodyNote[]>([]);
  const [visibleNotes, setVisibleNotes] = useState<number[]>([]);
  const lastStepRef = useRef<number>(-1);

  // Calculate scale notes (2 octaves)
  useEffect(() => {
    const scaleNotes = calculateScaleNotes(key, scale, 2);
    setVisibleNotes(scaleNotes);
  }, [key, scale]);

  // Step triggering logic
  useEffect(() => {
    if (!isPlaying) {
      lastStepRef.current = -1;
      return;
    }

    const currentStep = Math.floor(playbackPosition * 16);
    if (currentStep !== lastStepRef.current) {
      lastStepRef.current = currentStep;

      // Find notes at current step
      const stepNotes = notes.filter(n => n.step === currentStep);
      stepNotes.forEach(note => {
        scheduleNote(note);
        onNoteEvent?.(note); // Emit for module routing (Story 15.4)
      });
    }
  }, [playbackPosition, isPlaying, notes, onNoteEvent]);

  const scheduleNote = (note: MelodyNote) => {
    const synth = audioEngine.getSynth('melody');
    if (synth) {
      synth.triggerAttackRelease(
        Tone.Frequency(note.pitch, 'midi').toNote(),
        note.duration,
        Tone.now(),
        note.velocity / 127
      );
    }
  };

  const toggleNote = (step: number, pitch: number) => {
    setNotes(prevNotes => {
      const existingIndex = prevNotes.findIndex(
        n => n.step === step && n.pitch === pitch
      );

      if (existingIndex >= 0) {
        // Remove note
        return prevNotes.filter((_, i) => i !== existingIndex);
      } else {
        // Add note
        return [...prevNotes, { step, pitch, velocity: 100, duration: 0.25 }];
      }
    });
  };

  return (
    <div className="bg-gray-800 rounded-lg border border-gray-700 p-4">
      <h3 className="text-lg font-semibold text-white mb-4">Melody Sequencer</h3>

      {/* Piano Roll Grid */}
      <div className="relative overflow-x-auto">
        <div className="grid grid-cols-16 gap-1">
          {visibleNotes.map(pitch => (
            <div key={pitch} className="flex gap-1">
              {Array.from({ length: 16 }).map((_, step) => {
                const hasNote = notes.some(n => n.step === step && n.pitch === pitch);
                const isCurrentStep = Math.floor(playbackPosition * 16) === step && isPlaying;

                return (
                  <button
                    key={step}
                    onClick={() => toggleNote(step, pitch)}
                    className={`
                      w-8 h-8 rounded-md transition-colors
                      ${hasNote ? 'bg-primary-500 hover:bg-primary-400' : 'bg-gray-700 hover:bg-gray-600'}
                      ${isCurrentStep ? 'ring-2 ring-primary-300' : ''}
                    `}
                    aria-label={`${Tone.Frequency(pitch, 'midi').toNote()}, step ${step + 1}`}
                  />
                );
              })}
            </div>
          ))}
        </div>

        {/* Playback Cursor */}
        {isPlaying && (
          <div
            className="absolute top-0 bottom-0 w-0.5 bg-primary-300 pointer-events-none"
            style={{ left: `${playbackPosition * 100}%` }}
          />
        )}
      </div>
    </div>
  );
};

// Helper function to calculate scale notes
function calculateScaleNotes(key: string, scale: string, octaves: number): number[] {
  // Scale intervals (semitones from root)
  const scaleIntervals: Record<string, number[]> = {
    'major': [0, 2, 4, 5, 7, 9, 11],
    'minor': [0, 2, 3, 5, 7, 8, 10],
    'dorian': [0, 2, 3, 5, 7, 9, 10],
    'phrygian': [0, 1, 3, 5, 7, 8, 10],
    'lydian': [0, 2, 4, 6, 7, 9, 11],
    'mixolydian': [0, 2, 4, 5, 7, 9, 10],
    'locrian': [0, 1, 3, 5, 6, 8, 10],
  };

  // Root note MIDI numbers
  const rootNotes: Record<string, number> = {
    'C': 60, 'C#': 61, 'Db': 61, 'D': 62, 'D#': 63, 'Eb': 63,
    'E': 64, 'F': 65, 'F#': 66, 'Gb': 66, 'G': 67, 'G#': 68,
    'Ab': 68, 'A': 69, 'A#': 70, 'Bb': 70, 'B': 71
  };

  const rootMidi = rootNotes[key] || 60; // Default to C4
  const intervals = scaleIntervals[scale.toLowerCase()] || scaleIntervals['major'];

  const notes: number[] = [];
  for (let octave = 0; octave < octaves; octave++) {
    intervals.forEach(interval => {
      notes.push(rootMidi + (octave * 12) + interval);
    });
  }

  return notes.sort((a, b) => b - a); // Descending order for UI (high notes at top)
}
```

**Audio Engine Integration:**
```typescript
// src/utils/audioEngine.ts (add melody synth)
class AudioEngine {
  private melodySynth: Tone.PolySynth | null = null;

  async initialize() {
    // ... existing initialization

    // Create dedicated melody synth
    this.melodySynth = new Tone.PolySynth(Tone.Synth, {
      oscillator: { type: 'triangle' },
      envelope: {
        attack: 0.005,
        decay: 0.1,
        sustain: 0.3,
        release: 0.5,
      },
    }).toDestination();

    this.melodySynth.volume.value = -10; // dB
  }

  getSynth(name: string): Tone.PolySynth | null {
    if (name === 'melody') return this.melodySynth;
    return null;
  }
}
```

### Existing Pattern Reference

**Similar 16-Step Sequencer Patterns:**
- Drum machine grid (if exists in codebase) - same step-based architecture
- Piano Roll component (if exists) - same pitch grid layout
- ChordTimeline (Story 15.2) - same playback cursor animation

**Follow Same Patterns:**
- requestAnimationFrame for 60fps cursor animation
- Tone.js Transport for precise note scheduling
- React.memo for grid cell optimization
- GlobalMusicContext subscription via useGlobalMusic() hook

### Key Constraints

**Must Preserve:**
- ChordMelodyArranger layout (Story 15.2) - add melody sequencer below chord timeline
- GlobalMusicContext key/scale state (Epic 4) - read-only access
- Audio Engine singleton pattern - use existing audioEngine instance

**Must Not:**
- Modify ChordTimeline component (separate concern)
- Change GlobalMusicContext API (read-only usage)
- Add external dependencies (use existing Tone.js, React, Tailwind)

**Performance Requirements:**
- 60fps playback cursor animation (< 16.67ms frame time)
- Step triggering accuracy: Â±5ms (Tone.js scheduling)
- Note input latency: <50ms (immediate setState)

---

## Definition of Done

- [ ] `src/components/Studio/modules/ChordMelodyArranger/MelodySequencer.tsx` created (~300 lines)
- [ ] MelodySequencer component implements piano roll grid (16 steps, 2 octaves)
- [ ] Scale-aware note filtering (only show notes in selected scale)
- [ ] Click/tap to toggle notes on/off
- [ ] Playback synchronized with ChordTimeline (same playbackPosition)
- [ ] 60fps playback cursor animation
- [ ] Audio playback via Tone.js (melody synth)
- [ ] GlobalMusicContext integration (key/scale subscription)
- [ ] Keyboard shortcuts implemented (Space, Delete, Arrow keys)
- [ ] Responsive design (mobile/desktop)
- [ ] Accessibility (ARIA labels, keyboard navigation)
- [ ] MelodySequencer integrated into ChordMelodyArranger component
- [ ] Manual browser testing (localhost:5173/studio + load ChordMelodyArranger)
- [ ] No console errors in browser DevTools
- [ ] TypeScript compilation passes (no new errors)
- [ ] Performance verified (60fps animation, <5ms step triggering)

---

## Testing Strategy

### Manual Testing (Per CLAUDE.md Guidelines)

**Test 1: Piano Roll Grid Interaction**
```bash
# Start dev server
npm run dev

# Navigate to Studio
http://localhost:5173/studio

# Load ChordMelodyArranger module
# Click "Add Module" â†’ Select "Chord & Melody Arranger"

# Verify:
# - Piano roll grid displays (16 steps, 2 octaves)
# - Notes filtered to current key/scale (default C major)
# - Click/tap toggles notes on/off
# - Note cells have hover states
# - Grid is responsive (mobile/desktop)
```

**Test 2: Scale-Aware Note Filtering**
```typescript
// Change key/scale via GlobalMusicHeader
// Test cases:
// - C major â†’ D major (all notes transpose)
// - C major â†’ A minor (different note set displayed)
// - C major â†’ C dorian (mode changes note set)

// Verify:
// - Grid updates to show only scale notes
// - Existing notes outside new scale are cleared (with confirmation)
// - Note labels update (C4 â†’ D4 when key changes)
```

**Test 3: Playback Synchronization**
```typescript
// Add notes to grid (e.g., C4 on steps 0, 4, 8, 12)
// Click Play button in ChordMelodyArranger transport

// Verify:
// - Playback cursor animates smoothly (60fps)
// - Notes play at correct steps (0, 4, 8, 12)
// - Timing accurate (Â±5ms tolerance)
// - Melody syncs with chord progression playback
// - Cursor loops back to start after step 15
```

**Test 4: Audio Playback**
```typescript
// Add multiple notes at same step (chord)
// Add notes across full 2-octave range

// Verify:
// - All notes play audibly via Tone.js
// - Polyphony works (multiple notes at same step)
// - Octave range correct (2 octaves based on key)
// - Note duration correct (1/16th note default)
// - Volume level appropriate (not clipping)
```

**Test 5: Keyboard Shortcuts**
```typescript
// Focus on MelodySequencer component

// Test:
// - Space bar â†’ toggles play/pause
// - Delete key â†’ clears all notes
// - Arrow keys â†’ navigate grid cells
// - Enter key â†’ toggle focused note on/off

// Verify:
// - All shortcuts work without page scroll side effects
// - Focus indicators visible during keyboard navigation
```

**Test 6: Performance Verification**
```javascript
// Browser DevTools â†’ Performance tab
// Record playback for 10 seconds

// Verify:
// - Frame rate: 60fps (no dropped frames)
// - CPU usage: <30% (optimize grid rendering if needed)
// - Memory: Stable (no memory leaks)
// - Audio timing: No drift or jitter
```

### Verification Checklist

- âœ… Piano roll grid displays correctly (16 steps, 2 octaves)
- âœ… Scale-aware note filtering works (only show scale notes)
- âœ… Note toggling works (click/tap)
- âœ… Playback cursor animates at 60fps
- âœ… Step triggering accurate (Â±5ms)
- âœ… Audio playback via Tone.js works
- âœ… GlobalMusicContext key/scale changes update grid
- âœ… Keyboard shortcuts functional (Space, Delete, Arrow keys)
- âœ… Responsive design (mobile/desktop)
- âœ… Accessibility (ARIA labels, keyboard nav, focus indicators)
- âœ… No console errors
- âœ… TypeScript compilation clean

---

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** Step triggering timing accuracy (Â±5ms requirement)
**Mitigation:**
- Use Tone.js Transport.scheduleOnce() for precise scheduling
- Pre-calculate step boundaries (0/16, 1/16, etc.) outside render loop
- Test with metronome to verify timing accuracy
- Profile with Performance tab to detect frame drops
**Rollback:** Remove MelodySequencer component, restore ChordMelodyArranger to Story 15.2 state

**Secondary Risk:** Piano roll grid performance on mobile (60fps requirement)
**Mitigation:**
- Use React.memo for note cells (only re-render on state change)
- Optimize playback cursor animation (CSS transform instead of left property)
- Test on low-end devices (throttle CPU in DevTools)
- Consider virtualization if grid exceeds 16 steps (future)
**Rollback:** Reduce grid resolution (8 steps) or simplify UI (flat colors, no shadows)

**Tertiary Risk:** Scale filtering edge cases (enharmonic equivalents, custom scales)
**Mitigation:**
- Test all 12 keys with major/minor scales
- Handle enharmonic equivalents (C# = Db)
- Default to chromatic if scale not found
- Log warnings for unsupported scales
**Rollback:** Disable scale filtering (show all chromatic notes)

### Compatibility Verification

- [x] **No breaking changes** - ChordMelodyArranger API unchanged (adds new child component)
- [x] **No database changes** - Client-side state only
- [x] **UI changes additive** - Adds melody sequencer below chord timeline
- [x] **Performance impact** - 60fps requirement, may need optimization on low-end devices

---

## Scope Validation

- [x] Story can be completed in **8-10 hours** (one development session)
- [x] Integration approach follows existing patterns (16-step sequencer, Tone.js audio)
- [x] Clear prerequisites (Story 15.2 complete)
- [x] No design or architecture work required (Epic 15 defines architecture)

---

## Deliverables

1. **MelodySequencer Component**
   - `src/components/Studio/modules/ChordMelodyArranger/MelodySequencer.tsx` (~300 lines)
   - Piano roll grid UI (16 steps, 2 octaves)
   - Note input/output logic

2. **Audio Engine Enhancement**
   - `src/utils/audioEngine.ts` - Add melody synth (~20 lines)
   - PolySynth configuration for melody playback

3. **ChordMelodyArranger Integration**
   - Updated `src/components/Studio/modules/ChordMelodyArranger/ChordMelodyArranger.tsx` (~30 lines changed)
   - Add MelodySequencer to layout below ChordTimeline

4. **TypeScript Types**
   - `src/types/chordProgression.ts` or inline - Add MelodyNote interface (~10 lines)

---

## Next Steps After Story 15.3

Once this story is complete, proceed to:
- **Story 15.4:** Module Routing System (6-8 hours) ðŸ”´ CRITICAL
  - ModuleRoutingService implementation
  - Output destination selector UI
  - Route melody/chord events to loaded modules

---

## References

- **Epic 15:** `docs/epics/epic-15-chord-melody-arranger.md`
- **Story 15.2:** `docs/stories/15.2-chord-melody-arranger-ui.md`
- **ChordMelodyArranger Component:** `src/components/Studio/modules/ChordMelodyArranger/ChordMelodyArranger.tsx`
- **Audio Engine:** `src/utils/audioEngine.ts`
- **GlobalMusicContext:** `src/contexts/GlobalMusicContext.tsx`
- **Tone.js Docs:** https://tonejs.github.io/docs/

---

**Story Created:** 2025-01-13
**Story Owner:** PO Agent (Sarah)
**Estimated Completion:** 8-10 hours after start
